<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2d5a27">
  <title>Live Delivery Tracking | Tiny Seed Farm</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkAfsMpi7Arqb43gBAitN0WEUs4V13N8Y" async defer></script>
  <script src="web_app/auth-guard.js" data-required-role="Employee"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #2d5a27;
      --primary-light: #4a7c43;
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --bg-elevated: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      padding: 16px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-logo { font-size: 1.5rem; }

    .header-text h1 {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .header-text small {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .header-stats {
      display: flex;
      gap: 24px;
    }

    .header-stat {
      text-align: center;
    }

    .header-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .header-stat-label {
      font-size: 0.7rem;
      opacity: 0.9;
      text-transform: uppercase;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar - Driver List */
    .sidebar {
      width: 360px;
      background: var(--bg-card);
      border-right: 1px solid var(--bg-elevated);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--bg-elevated);
    }

    .sidebar-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .filter-tabs {
      display: flex;
      gap: 8px;
    }

    .filter-tab {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-tab.active {
      background: var(--primary);
      color: white;
    }

    .driver-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .driver-card {
      background: var(--bg-elevated);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .driver-card:hover {
      background: rgba(45, 90, 39, 0.2);
    }

    .driver-card.selected {
      border-color: var(--primary);
      background: rgba(45, 90, 39, 0.15);
    }

    .driver-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .driver-avatar {
      width: 44px;
      height: 44px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .driver-avatar.offline {
      background: var(--bg-dark);
    }

    .driver-details { flex: 1; }

    .driver-name {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 2px;
    }

    .driver-vehicle {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .driver-status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-active {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .status-paused {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .status-offline {
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-secondary);
    }

    .driver-progress {
      margin-bottom: 10px;
    }

    .progress-bar {
      height: 6px;
      background: var(--bg-dark);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 6px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      transition: width 0.3s;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .driver-stats {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
    }

    .driver-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
    }

    .driver-stat i { font-size: 0.75rem; }

    .driver-stat strong { color: var(--text-primary); }

    /* Map Area */
    .map-area {
      flex: 1;
      position: relative;
    }

    #tracking-map {
      width: 100%;
      height: 100%;
    }

    .map-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-btn {
      width: 44px;
      height: 44px;
      background: var(--bg-card);
      border: none;
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .map-btn:hover {
      background: var(--primary);
    }

    .map-btn.active {
      background: var(--primary);
    }

    /* Driver Info Panel */
    .driver-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .driver-panel.visible { display: block; }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .panel-avatar {
      width: 56px;
      height: 56px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .panel-info { flex: 1; }

    .panel-name {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .panel-status {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .panel-live {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--success);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .panel-live .dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .panel-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .panel-stat {
      text-align: center;
      padding: 12px;
      background: var(--bg-elevated);
      border-radius: 10px;
    }

    .panel-stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary-light);
    }

    .panel-stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .panel-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
    }

    /* Refresh indicator */
    .refresh-indicator {
      position: absolute;
      top: 20px;
      left: 20px;
      background: var(--bg-card);
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .refresh-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }

    /* Loading state */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: var(--bg-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--bg-elevated);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* No active deliveries */
    .no-deliveries {
      padding: 60px 20px;
      text-align: center;
    }

    .no-deliveries-icon {
      font-size: 4rem;
      color: var(--bg-elevated);
      margin-bottom: 16px;
    }

    .no-deliveries h2 {
      font-size: 1.3rem;
      margin-bottom: 8px;
    }

    .no-deliveries p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .main-content {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        max-height: 40vh;
      }

      .header-stats {
        display: none;
      }

      .panel-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="header-logo">ðŸŒ±</div>
      <div class="header-text">
        <h1>Live Delivery Tracking</h1>
        <small>Real-time driver locations</small>
      </div>
    </div>
    <div class="header-stats">
      <div class="header-stat">
        <div class="header-stat-value" id="totalDeliveries">--</div>
        <div class="header-stat-label">Deliveries Today</div>
      </div>
      <div class="header-stat">
        <div class="header-stat-value" id="completedDeliveries">--</div>
        <div class="header-stat-label">Completed</div>
      </div>
      <div class="header-stat">
        <div class="header-stat-value" id="activeDrivers">--</div>
        <div class="header-stat-label">Active Drivers</div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Sidebar - Driver List -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Delivery Drivers</div>
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="filterDrivers('all')">All</button>
          <button class="filter-tab" onclick="filterDrivers('active')">Active</button>
          <button class="filter-tab" onclick="filterDrivers('completed')">Done</button>
        </div>
      </div>
      <div class="driver-list" id="driverList">
        <!-- Populated dynamically -->
      </div>
    </aside>

    <!-- Map Area -->
    <div class="map-area">
      <div id="tracking-map"></div>

      <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading live tracking data...</div>
      </div>

      <div class="refresh-indicator">
        <span class="refresh-dot"></span>
        <span>Live updates every 10s</span>
      </div>

      <div class="map-controls">
        <button class="map-btn" onclick="centerOnAllDrivers()" title="Show all drivers">
          <i class="fas fa-expand"></i>
        </button>
        <button class="map-btn" onclick="toggleTraffic()" title="Toggle traffic">
          <i class="fas fa-traffic-light"></i>
        </button>
        <button class="map-btn" onclick="refreshData()" title="Refresh now">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>

      <!-- Driver Detail Panel -->
      <div class="driver-panel" id="driverPanel">
        <button class="panel-close" onclick="closeDriverPanel()">
          <i class="fas fa-times"></i>
        </button>
        <div class="panel-header">
          <div class="panel-avatar" id="panelAvatar">JD</div>
          <div class="panel-info">
            <div class="panel-name" id="panelName">Driver Name</div>
            <div class="panel-status" id="panelStatus">On delivery route</div>
          </div>
          <div class="panel-live">
            <span class="dot"></span>
            LIVE
          </div>
        </div>
        <div class="panel-stats">
          <div class="panel-stat">
            <div class="panel-stat-value" id="panelCompleted">0</div>
            <div class="panel-stat-label">Completed</div>
          </div>
          <div class="panel-stat">
            <div class="panel-stat-value" id="panelRemaining">0</div>
            <div class="panel-stat-label">Remaining</div>
          </div>
          <div class="panel-stat">
            <div class="panel-stat-value" id="panelETA">--</div>
            <div class="panel-stat-label">Route ETA</div>
          </div>
          <div class="panel-stat">
            <div class="panel-stat-value" id="panelSpeed">--</div>
            <div class="panel-stat-label">Speed</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LIVE DRIVER TRACKING DASHBOARD - Desktop View
    // Auto-loads and shows all active delivery drivers in real-time
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbxy5DlsDXGwulhRNIHiD7q7sHQbN9kResVkR5YPXF2Z2IzgahVE9i38v063s4scAWMp/exec',
      REFRESH_INTERVAL: 10000, // 10 seconds for live tracking
      FARM_CENTER: { lat: 40.7456217, lng: -80.1610431 }
    };

    let trackingMap = null;
    let driverMarkers = {};
    let trafficLayer = null;
    let refreshInterval = null;
    let driversData = [];
    let selectedDriverId = null;
    let currentFilter = 'all';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      loadAllDrivers();
      startAutoRefresh();
    });

    function initMap() {
      if (!window.google || !google.maps) {
        setTimeout(initMap, 500);
        return;
      }

      trackingMap = new google.maps.Map(document.getElementById('tracking-map'), {
        center: CONFIG.FARM_CENTER,
        zoom: 12,
        mapTypeId: 'roadmap',
        disableDefaultUI: true,
        zoomControl: true,
        styles: [
          { featureType: 'poi', stylers: [{ visibility: 'off' }] },
          { featureType: 'transit', stylers: [{ visibility: 'off' }] }
        ]
      });

      // Add farm marker
      new google.maps.Marker({
        position: CONFIG.FARM_CENTER,
        map: trackingMap,
        title: 'Tiny Seed Farm',
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
              <circle cx="20" cy="20" r="18" fill="#2d5a27" stroke="white" stroke-width="3"/>
              <text x="20" y="26" font-size="18" text-anchor="middle" fill="white">ðŸŒ±</text>
            </svg>
          `),
          scaledSize: new google.maps.Size(40, 40)
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA LOADING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadAllDrivers() {
      try {
        const response = await fetch(`${CONFIG.API_URL}?action=getAllActiveDeliveries`);
        const result = await response.json();

        if (result.success && result.drivers) {
          driversData = result.drivers;
          updateDashboard(result);
          renderDriverList();
          updateDriverMarkers();
          hideLoading();
        } else {
          // Demo data if API not available
          loadDemoData();
        }
      } catch (error) {
        console.error('Error loading drivers:', error);
        loadDemoData();
      }
    }

    function loadDemoData() {
      // Realistic demo data for testing
      driversData = [
        {
          id: 'DRV001',
          name: 'Marcus Johnson',
          initials: 'MJ',
          vehicle: 'White Ford Transit',
          status: 'active',
          currentLat: 40.7520,
          currentLng: -80.1550,
          heading: 45,
          speed: 28,
          completedStops: 8,
          totalStops: 15,
          currentStop: 'Margaret Chen - 456 Oak Ave',
          eta: '2:45 PM',
          lastUpdated: new Date().toISOString()
        },
        {
          id: 'DRV002',
          name: 'Sarah Williams',
          initials: 'SW',
          vehicle: 'Blue Chevy Express',
          status: 'active',
          currentLat: 40.7380,
          currentLng: -80.1720,
          heading: 180,
          speed: 15,
          completedStops: 12,
          totalStops: 18,
          currentStop: 'David Kim - 789 Pine St',
          eta: '3:15 PM',
          lastUpdated: new Date().toISOString()
        },
        {
          id: 'DRV003',
          name: 'Jake Thompson',
          initials: 'JT',
          vehicle: 'Green Sprinter Van',
          status: 'paused',
          currentLat: 40.7450,
          currentLng: -80.1480,
          heading: 0,
          speed: 0,
          completedStops: 5,
          totalStops: 12,
          currentStop: 'Lunch break at depot',
          eta: '4:00 PM',
          lastUpdated: new Date(Date.now() - 300000).toISOString()
        },
        {
          id: 'DRV004',
          name: 'Emma Rodriguez',
          initials: 'ER',
          vehicle: 'Silver Honda Ridgeline',
          status: 'completed',
          currentLat: 40.7456,
          currentLng: -80.1610,
          heading: 0,
          speed: 0,
          completedStops: 10,
          totalStops: 10,
          currentStop: 'Route completed',
          eta: '--',
          lastUpdated: new Date(Date.now() - 1800000).toISOString()
        }
      ];

      const stats = {
        totalDeliveries: driversData.reduce((sum, d) => sum + d.totalStops, 0),
        completedDeliveries: driversData.reduce((sum, d) => sum + d.completedStops, 0),
        activeDrivers: driversData.filter(d => d.status === 'active').length
      };

      updateDashboard({ stats });
      renderDriverList();
      updateDriverMarkers();
      hideLoading();
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function startAutoRefresh() {
      refreshInterval = setInterval(refreshData, CONFIG.REFRESH_INTERVAL);
    }

    async function refreshData() {
      try {
        const response = await fetch(`${CONFIG.API_URL}?action=getAllActiveDeliveries`);
        const result = await response.json();

        if (result.success && result.drivers) {
          driversData = result.drivers;
          updateDashboard(result);
          renderDriverList();
          updateDriverMarkers();
        }
      } catch (error) {
        // Simulate position updates for demo
        driversData.forEach(driver => {
          if (driver.status === 'active') {
            driver.currentLat += (Math.random() - 0.5) * 0.002;
            driver.currentLng += (Math.random() - 0.5) * 0.002;
            driver.lastUpdated = new Date().toISOString();
          }
        });
        renderDriverList();
        updateDriverMarkers();
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI UPDATES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function updateDashboard(data) {
      const stats = data.stats || {};

      const totalDeliveries = stats.totalDeliveries || driversData.reduce((sum, d) => sum + d.totalStops, 0);
      const completedDeliveries = stats.completedDeliveries || driversData.reduce((sum, d) => sum + d.completedStops, 0);
      const activeDrivers = stats.activeDrivers || driversData.filter(d => d.status === 'active').length;

      document.getElementById('totalDeliveries').textContent = totalDeliveries;
      document.getElementById('completedDeliveries').textContent = completedDeliveries;
      document.getElementById('activeDrivers').textContent = activeDrivers;
    }

    function renderDriverList() {
      const list = document.getElementById('driverList');
      let filteredDrivers = driversData;

      if (currentFilter === 'active') {
        filteredDrivers = driversData.filter(d => d.status === 'active');
      } else if (currentFilter === 'completed') {
        filteredDrivers = driversData.filter(d => d.status === 'completed');
      }

      if (filteredDrivers.length === 0) {
        list.innerHTML = `
          <div class="no-deliveries">
            <div class="no-deliveries-icon"><i class="fas fa-truck"></i></div>
            <h2>No ${currentFilter === 'all' ? '' : currentFilter} drivers</h2>
            <p>${currentFilter === 'active' ? 'All drivers have completed their routes' : 'No deliveries scheduled'}</p>
          </div>
        `;
        return;
      }

      list.innerHTML = filteredDrivers.map(driver => {
        const progress = Math.round((driver.completedStops / driver.totalStops) * 100);
        const statusClass = driver.status === 'active' ? 'status-active' :
                           driver.status === 'paused' ? 'status-paused' : 'status-offline';
        const statusText = driver.status === 'active' ? 'Active' :
                          driver.status === 'paused' ? 'Paused' : 'Done';

        const lastUpdated = new Date(driver.lastUpdated);
        const minutesAgo = Math.floor((Date.now() - lastUpdated) / 60000);
        const updateText = minutesAgo < 1 ? 'Just now' : `${minutesAgo}m ago`;

        return `
          <div class="driver-card ${selectedDriverId === driver.id ? 'selected' : ''}"
               onclick="selectDriver('${driver.id}')">
            <div class="driver-card-header">
              <div class="driver-avatar ${driver.status === 'completed' ? 'offline' : ''}">${driver.initials}</div>
              <div class="driver-details">
                <div class="driver-name">${driver.name}</div>
                <div class="driver-vehicle">${driver.vehicle}</div>
              </div>
              <span class="driver-status-badge ${statusClass}">${statusText}</span>
            </div>
            <div class="driver-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <div class="progress-text">
                <span>${driver.completedStops} of ${driver.totalStops} stops</span>
                <span>${progress}%</span>
              </div>
            </div>
            <div class="driver-stats">
              <div class="driver-stat">
                <i class="fas fa-clock"></i>
                <span>ETA: <strong>${driver.eta}</strong></span>
              </div>
              <div class="driver-stat">
                <i class="fas fa-signal"></i>
                <span>${updateText}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateDriverMarkers() {
      if (!trackingMap) return;

      driversData.forEach(driver => {
        if (!driver.currentLat || !driver.currentLng) return;

        const position = {
          lat: Number(driver.currentLat),
          lng: Number(driver.currentLng)
        };

        if (driverMarkers[driver.id]) {
          // Update existing marker
          driverMarkers[driver.id].setPosition(position);
          if (driver.heading) {
            const icon = driverMarkers[driver.id].getIcon();
            icon.rotation = driver.heading;
            driverMarkers[driver.id].setIcon(icon);
          }
        } else {
          // Create new marker
          const color = driver.status === 'active' ? '#22c55e' :
                       driver.status === 'paused' ? '#f59e0b' : '#94a3b8';

          driverMarkers[driver.id] = new google.maps.Marker({
            position: position,
            map: trackingMap,
            title: driver.name,
            icon: {
              path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
              scale: 8,
              fillColor: color,
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 2,
              rotation: driver.heading || 0
            }
          });

          // Click to select
          driverMarkers[driver.id].addListener('click', () => {
            selectDriver(driver.id);
          });
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INTERACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function selectDriver(driverId) {
      selectedDriverId = driverId;
      const driver = driversData.find(d => d.id === driverId);
      if (!driver) return;

      // Update selection in list
      document.querySelectorAll('.driver-card').forEach(card => card.classList.remove('selected'));
      event?.target?.closest('.driver-card')?.classList.add('selected');

      // Center map on driver
      if (driver.currentLat && driver.currentLng) {
        trackingMap.panTo({
          lat: Number(driver.currentLat),
          lng: Number(driver.currentLng)
        });
        trackingMap.setZoom(15);
      }

      // Show driver panel
      showDriverPanel(driver);
    }

    function showDriverPanel(driver) {
      const panel = document.getElementById('driverPanel');

      document.getElementById('panelAvatar').textContent = driver.initials;
      document.getElementById('panelName').textContent = driver.name;
      document.getElementById('panelStatus').textContent = driver.currentStop || 'On delivery route';
      document.getElementById('panelCompleted').textContent = driver.completedStops;
      document.getElementById('panelRemaining').textContent = driver.totalStops - driver.completedStops;
      document.getElementById('panelETA').textContent = driver.eta || '--';
      document.getElementById('panelSpeed').textContent = driver.speed ? `${driver.speed} mph` : '--';

      panel.classList.add('visible');
    }

    function closeDriverPanel() {
      document.getElementById('driverPanel').classList.remove('visible');
      selectedDriverId = null;
      document.querySelectorAll('.driver-card').forEach(card => card.classList.remove('selected'));
    }

    function filterDrivers(filter) {
      currentFilter = filter;

      // Update tab styles
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      renderDriverList();
    }

    function centerOnAllDrivers() {
      if (!trackingMap || driversData.length === 0) return;

      const bounds = new google.maps.LatLngBounds();
      bounds.extend(CONFIG.FARM_CENTER);

      driversData.forEach(driver => {
        if (driver.currentLat && driver.currentLng) {
          bounds.extend({
            lat: Number(driver.currentLat),
            lng: Number(driver.currentLng)
          });
        }
      });

      trackingMap.fitBounds(bounds);
      closeDriverPanel();
    }

    function toggleTraffic() {
      if (!trackingMap) return;

      const btn = event.target.closest('.map-btn');

      if (trafficLayer) {
        trafficLayer.setMap(null);
        trafficLayer = null;
        btn.classList.remove('active');
      } else {
        trafficLayer = new google.maps.TrafficLayer();
        trafficLayer.setMap(trackingMap);
        btn.classList.add('active');
      }
    }
  </script>
</body>
</html>
