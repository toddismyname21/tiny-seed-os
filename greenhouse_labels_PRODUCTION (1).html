<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenhouse Seeding Labels - Tiny Seed OS</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .controls {
            background: white;
            padding: 20px 30px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #10b981;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-primary:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: #667eea;
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .preview-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-header {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .label-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
        
        /* 4" x 2" Label (384px x 192px at 96 DPI) */
        .label {
            width: 384px;
            height: 192px;
            border: 2px solid #2d3748;
            border-radius: 4px;
            padding: 12px;
            background: white;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            page-break-inside: avoid;
            position: relative;
        }
        
        .label-left {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .label-crop {
            font-weight: 700;
            font-size: 18px;
            color: #1a202c;
            line-height: 1.2;
        }
        
        .label-variety {
            font-size: 13px;
            color: #4a5568;
            margin-top: 2px;
        }
        
        .label-dates {
            margin-top: 8px;
        }
        
        .label-date-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 4px;
            color: #2d3748;
        }
        
        .label-date-label {
            font-weight: 600;
        }
        
        .label-bottom {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 10px;
            color: #718096;
        }
        
        .label-batch {
            font-weight: 600;
            color: #2d3748;
        }
        
        .label-tray-count {
            font-weight: 600;
            background: #10b981;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .label-right {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        
        .label-qr {
            width: 80px;
            height: 80px;
        }
        
        .label-tray-id {
            font-size: 11px;
            font-weight: 700;
            color: #2d3748;
            text-align: center;
        }
        
        .label-cell-count {
            font-size: 10px;
            color: #718096;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }
        
        @media print {
            body { background: white; }
            .header, .controls { display: none; }
            .container { margin: 0; padding: 0; max-width: 100%; }
            .preview-section { box-shadow: none; padding: 0; }
            .section-header, .stats-grid { display: none; }
            .label-grid { 
                display: block;
                columns: 2;
                column-gap: 0.25in;
            }
            .label {
                margin-bottom: 0.25in;
                break-inside: avoid;
            }
        }
        
        .connection-status {
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå± Greenhouse Seeding Labels</h1>
        <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
            Print-ready waterproof labels for seed trays
        </div>
    </div>
    
    <div class="controls">
        <div id="connectionStatus" class="connection-status status-disconnected">
            ‚ö†Ô∏è Not connected to Google Sheets - Using demo data
        </div>
        
        <div class="control-grid">
            <div class="form-group">
                <label>Date Range Start</label>
                <input type="date" id="startDate" onchange="filterSeedings()">
            </div>
            <div class="form-group">
                <label>Date Range End</label>
                <input type="date" id="endDate" onchange="filterSeedings()">
            </div>
            <div class="form-group">
                <label>Filter by Crop</label>
                <select id="cropFilter" onchange="filterSeedings()">
                    <option value="">All Crops</option>
                </select>
            </div>
            <div class="form-group">
                <label>Label Copies</label>
                <input type="number" id="labelCopies" value="1" min="1" max="10">
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="connectGoogleSheets()">üìä Connect Google Sheets</button>
            <button class="btn btn-secondary" onclick="generateLabels()">üîÑ Regenerate Labels</button>
            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Labels</button>
        </div>
    </div>
    
    <div class="container">
        <div class="preview-section">
            <div class="section-header">
                <span>Label Preview</span>
                <span id="labelCount" style="font-size: 14px; font-weight: 600; color: #10b981;"></span>
            </div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="label-grid" id="labelGrid">
                <div class="loading">Loading labels...</div>
            </div>
        </div>
    </div>
    
    <script>
        // Google Sheets Configuration
        const SHEET_ID = '128O56X_FN9_U-s0ENHBBRyLpae_yvWHPYbBheVlR3Vc';
        const PLANNING_RANGE = 'PLANNING_2026!A:AZ';
        const CROP_PROFILES_RANGE = 'REF_CropProfiles!A:AZ';
        
        const API_URL = 'https://script.google.com/macros/s/AKfycbz23N_RluRDlJheaK0vTZmvfIkd5yyMblNizASjuuo6vsNibuoWIPt04KuZOCKEwaoj/exec';
        
        let seedingsData = [];
        let cropProfiles = {};
        let isConnected = false;
        
        // Demo data for offline mode
        const DEMO_SEEDINGS = [
            {
                crop: 'Lettuce',
                variety: 'Salanova Formula Mix',
                seedDate: '2026-02-15',
                transplantDate: '2026-03-22',
                traysNeeded: 3,
                cellsPerTray: 72,
                batchNumber: 'L001',
                nurseryDays: 35
            },
            {
                crop: 'Kale',
                variety: 'Winterbor',
                seedDate: '2026-02-20',
                transplantDate: '2026-03-27',
                traysNeeded: 2,
                cellsPerTray: 72,
                batchNumber: 'K001',
                nurseryDays: 35
            },
            {
                crop: 'Tomato',
                variety: 'Cherokee Purple',
                seedDate: '2026-02-25',
                transplantDate: '2026-04-10',
                traysNeeded: 4,
                cellsPerTray: 50,
                batchNumber: 'T001',
                nurseryDays: 42
            },
            {
                crop: 'Pepper',
                variety: 'Jimmy Nardello',
                seedDate: '2026-03-01',
                transplantDate: '2026-04-15',
                traysNeeded: 2,
                cellsPerTray: 50,
                batchNumber: 'P001',
                nurseryDays: 45
            }
        ];
        
        function init() {
            // Set default date range (next 30 days)
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(today.getDate() + 30);
            
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Try to connect to Google Sheets
            loadData();
        }
        
        async function connectGoogleSheets() {
            const btn = event.target;
            btn.textContent = 'Connecting...';
            btn.disabled = true;
            
            try {
                await loadData();
                alert('‚úÖ Connected!\n\nData loaded from Google Sheets.');
            } catch (error) {
                alert('‚ùå Connection Failed\n\n' + error.message);
            } finally {
                btn.textContent = 'Refresh Data';
                btn.disabled = false;
            }
        }
        
        async function loadData() {
            try {
                const response = await fetch(`${API_URL}?action=getGreenhouseSeedings`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    seedingsData = result.data;
                    isConnected = true;
                } else {
                    console.warn('Using demo data:', result.error);
                    seedingsData = DEMO_SEEDINGS;
                    isConnected = false;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                seedingsData = DEMO_SEEDINGS;
                isConnected = false;
            }
            
            // Populate crop filter
            const crops = [...new Set(seedingsData.map(s => s.crop))].sort();
            const cropFilter = document.getElementById('cropFilter');
            crops.forEach(crop => {
                const option = document.createElement('option');
                option.value = crop;
                option.textContent = crop;
                cropFilter.appendChild(option);
            });
            
            generateLabels();
        }
        
        function filterSeedings() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const cropFilter = document.getElementById('cropFilter').value;
            
            let filtered = seedingsData.filter(s => {
                const seedDate = new Date(s.seedDate);
                const dateMatch = seedDate >= startDate && seedDate <= endDate;
                const cropMatch = !cropFilter || s.crop === cropFilter;
                return dateMatch && cropMatch;
            });
            
            generateLabels(filtered);
        }
        
        function generateLabels(seedings = null) {
            if (!seedings) {
                filterSeedings();
                return;
            }
            
            const copies = parseInt(document.getElementById('labelCopies').value) || 1;
            const labelGrid = document.getElementById('labelGrid');
            
            // Generate stats
            const totalTrays = seedings.reduce((sum, s) => sum + s.traysNeeded, 0);
            const totalSeedings = seedings.length;
            const crops = [...new Set(seedings.map(s => s.crop))];
            
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${totalSeedings}</div>
                    <div class="stat-label">Seeding Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalTrays}</div>
                    <div class="stat-label">Total Trays</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${crops.length}</div>
                    <div class="stat-label">Crop Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalTrays * copies}</div>
                    <div class="stat-label">Labels to Print</div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = statsHtml;
            document.getElementById('labelCount').textContent = `${totalTrays * copies} labels ready`;
            
            // Generate labels
            let labelsHtml = '';
            
            seedings.forEach(seeding => {
                for (let tray = 1; tray <= seeding.traysNeeded; tray++) {
                    for (let copy = 1; copy <= copies; copy++) {
                        const trayId = `${seeding.batchNumber}-T${tray}`;
                        const qrData = JSON.stringify({
                            crop: seeding.crop,
                            variety: seeding.variety,
                            seedDate: seeding.seedDate,
                            trayId: trayId,
                            batch: seeding.batchNumber
                        });
                        
                        labelsHtml += `
                            <div class="label">
                                <div class="label-left">
                                    <div>
                                        <div class="label-crop">${seeding.crop}</div>
                                        <div class="label-variety">${seeding.variety}</div>
                                        <div class="label-dates">
                                            <div class="label-date-row">
                                                <span class="label-date-label">üå± Seed:</span>
                                                <span>${formatDate(seeding.seedDate)}</span>
                                            </div>
                                            <div class="label-date-row">
                                                <span class="label-date-label">üìÖ Transplant:</span>
                                                <span>${formatDate(seeding.transplantDate)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="label-bottom">
                                        <span class="label-batch">Batch: ${seeding.batchNumber}</span>
                                        <span class="label-tray-count">Tray ${tray} of ${seeding.traysNeeded}</span>
                                    </div>
                                </div>
                                <div class="label-right">
                                    <canvas class="label-qr" id="qr-${seeding.batchNumber}-${tray}-${copy}"></canvas>
                                    <div>
                                        <div class="label-tray-id">${trayId}</div>
                                        <div class="label-cell-count">${seeding.cellsPerTray} cells</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            labelGrid.innerHTML = labelsHtml;
            
            // Generate QR codes
            seedings.forEach(seeding => {
                for (let tray = 1; tray <= seeding.traysNeeded; tray++) {
                    for (let copy = 1; copy <= copies; copy++) {
                        const trayId = `${seeding.batchNumber}-T${tray}`;
                        const qrData = JSON.stringify({
                            crop: seeding.crop,
                            variety: seeding.variety,
                            seedDate: seeding.seedDate,
                            transplantDate: seeding.transplantDate,
                            trayId: trayId,
                            batch: seeding.batchNumber,
                            cells: seeding.cellsPerTray
                        });
                        
                        const canvas = document.getElementById(`qr-${seeding.batchNumber}-${tray}-${copy}`);
                        if (canvas) {
                            QRCode.toCanvas(canvas, qrData, {
                                width: 80,
                                margin: 1,
                                color: {
                                    dark: '#1a202c',
                                    light: '#ffffff'
                                }
                            });
                        }
                    }
                }
            });
        }
        
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
        }
        
        init();
    </script>
</body>
</html>
