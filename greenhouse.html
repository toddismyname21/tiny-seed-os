<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenhouse View - Tiny Seed OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2d5a27;
            --primary-light: #4a7c43;
            --primary-dark: #1e3d1a;
            --secondary: #f4a261;
            --accent: #e76f51;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #e63946;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-light: #0f3460;
            --text-primary: #edf2f4;
            --text-secondary: #8d99ae;
            --border: rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f1a 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 15px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i { color: var(--success); }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(45, 90, 39, 0.4);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .main-container {
            padding: 100px 2rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .stat-card.success .icon { color: var(--success); }
        .stat-card.warning .icon { color: var(--warning); }
        .stat-card.primary .icon { color: var(--primary-light); }
        .stat-card.accent .icon { color: var(--secondary); }

        /* Sections */
        .section {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-header i {
            color: var(--secondary);
            font-size: 1.25rem;
        }

        .section-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .section-header .badge {
            background: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        /* Tray Inventory Grid */
        .tray-inventory {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .tray-type {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid var(--border);
        }

        .tray-type .size {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tray-type .count {
            font-size: 2rem;
            font-weight: 800;
            color: var(--success);
            margin: 0.5rem 0;
        }

        .tray-type .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .tray-type.paperpot {
            border-color: var(--secondary);
        }

        .tray-type.paperpot .size {
            color: var(--secondary);
        }

        /* Tray Stock Management */
        .tray-stock-section {
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, rgba(45, 90, 39, 0.1) 100%);
            border: 1px solid rgba(42, 157, 143, 0.3);
        }

        .tray-stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .tray-stock-item {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--border);
            position: relative;
        }

        .tray-stock-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .tray-stock-size {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tray-stock-edit {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .tray-stock-edit:hover {
            background: var(--primary);
            color: white;
        }

        .tray-stock-counts {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .tray-count-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .tray-count-label {
            color: var(--text-secondary);
        }

        .tray-count-value {
            font-weight: 600;
        }

        .tray-count-value.available {
            color: var(--success);
        }

        .tray-count-value.in-use {
            color: var(--secondary);
        }

        .tray-count-value.total {
            color: var(--text-primary);
        }

        .tray-count-value.low {
            color: var(--danger);
        }

        .tray-stock-bar {
            height: 6px;
            background: var(--bg-dark);
            border-radius: 3px;
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .tray-stock-bar-fill {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .tray-stock-bar-fill.high { background: var(--success); }
        .tray-stock-bar-fill.medium { background: var(--warning); }
        .tray-stock-bar-fill.low { background: var(--danger); }

        /* Stock Edit Modal */
        .stock-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .stock-modal.active {
            display: flex;
        }

        .stock-modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .stock-modal h3 {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stock-modal h3 i {
            color: var(--success);
        }

        .stock-input-group {
            margin-bottom: 1rem;
        }

        .stock-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .stock-input-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .stock-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .stock-modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stock-modal-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stock-modal-actions .btn-cancel {
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .stock-modal-actions .btn-save {
            background: var(--primary);
            border: none;
            color: white;
        }

        .stock-modal-actions .btn-save:hover {
            background: var(--primary-light);
        }

        /* Tray Edit Modal */
        .tray-edit-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .tray-edit-modal.active {
            display: flex;
        }

        .tray-edit-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 450px;
            border: 1px solid var(--border);
        }

        .tray-edit-content h3 {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tray-edit-content h3 i {
            color: var(--secondary);
        }

        .tray-edit-info {
            background: var(--bg-light);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .tray-edit-info .crop-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tray-edit-info .batch-id {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .paperpot-spacing-group {
            display: none;
        }

        .paperpot-spacing-group.visible {
            display: block;
        }

        .spacing-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 8px;
        }

        .spacing-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-light);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spacing-btn:hover {
            border-color: var(--primary);
        }

        .spacing-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Edit button in table */
        .edit-tray-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .edit-tray-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .data-table .crop-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table .crop-icon {
            font-size: 1.25rem;
        }

        .data-table .crop-info {
            display: flex;
            flex-direction: column;
        }

        .data-table .crop-name {
            font-weight: 600;
        }

        .data-table .crop-variety {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.seedling { background: rgba(42, 157, 143, 0.2); color: var(--success); }
        .status-badge.ready { background: rgba(233, 196, 106, 0.2); color: var(--warning); }
        .status-badge.upcoming { background: rgba(45, 90, 39, 0.2); color: var(--primary-light); }
        .status-badge.overdue { background: rgba(230, 57, 70, 0.2); color: var(--danger); }

        .days-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .days-display .days {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .days-display .label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .days-display.soon .days { color: var(--warning); }
        .days-display.ready .days { color: var(--success); }
        .days-display.overdue .days { color: var(--danger); }

        /* Upcoming Section */
        .upcoming-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .upcoming-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--border);
        }

        .upcoming-card .date-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .upcoming-card .date {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .upcoming-card .count {
            background: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .upcoming-card .task-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .upcoming-card .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upcoming-card .task-crop {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upcoming-card .task-trays {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .upcoming-card .task-item {
            flex-wrap: wrap;
            gap: 8px;
        }

        .upcoming-card .task-actions {
            display: flex;
            gap: 6px;
            width: 100%;
            margin-top: 6px;
        }

        .mark-complete-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: var(--primary);
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .mark-complete-btn:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        .mark-complete-btn:active {
            transform: translateY(0);
        }

        .mark-complete-btn.completing {
            opacity: 0.7;
            pointer-events: none;
        }

        .mark-complete-btn.completed {
            background: var(--success);
        }

        .mark-transplant-btn {
            background: var(--secondary);
        }

        .mark-transplant-btn:hover {
            background: #e5974d;
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .page-title {
                font-size: 1.2rem;
            }

            .main-container {
                padding: 90px 1rem 1rem;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Dashboard</span>
            </a>
            <h1 class="page-title">
                <i class="fas fa-seedling"></i>
                Greenhouse View
            </h1>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <a href="succession.html" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                New Planting
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card success">
                <div class="icon"><i class="fas fa-seedling"></i></div>
                <div class="value" id="totalTrays">--</div>
                <div class="label">Total Trays in GH</div>
            </div>
            <div class="stat-card warning">
                <div class="icon"><i class="fas fa-truck-loading"></i></div>
                <div class="value" id="readyToTransplant">--</div>
                <div class="label">Ready to Transplant</div>
            </div>
            <div class="stat-card primary">
                <div class="icon"><i class="fas fa-calendar-plus"></i></div>
                <div class="value" id="upcomingSowings">--</div>
                <div class="label">Sowings This Week</div>
            </div>
            <div class="stat-card accent">
                <div class="icon"><i class="fas fa-leaf"></i></div>
                <div class="value" id="uniqueCrops">--</div>
                <div class="label">Crop Varieties</div>
            </div>
        </div>

        <!-- Tray Stock Management -->
        <section class="section tray-stock-section" id="trays">
            <div class="section-header">
                <div class="section-header-left">
                    <i class="fas fa-boxes-stacked"></i>
                    <h2>Tray Stock (Empty + In Use)</h2>
                </div>
                <button class="btn btn-secondary" onclick="openAddTrayModal()" style="padding: 8px 16px; font-size: 0.85rem;">
                    <i class="fas fa-plus"></i> Add Stock
                </button>
            </div>
            <div class="tray-stock-grid" id="trayStockGrid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <span>Loading tray stock...</span>
                </div>
            </div>
        </section>

        <!-- Tray Inventory by Size (In Use) -->
        <section class="section">
            <div class="section-header">
                <div class="section-header-left">
                    <i class="fas fa-th"></i>
                    <h2>Trays Currently In Use</h2>
                </div>
            </div>
            <div class="tray-inventory" id="trayInventory">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <span>Loading tray data...</span>
                </div>
            </div>
        </section>

        <!-- Current Trays in Greenhouse -->
        <section class="section">
            <div class="section-header">
                <div class="section-header-left">
                    <i class="fas fa-seedling"></i>
                    <h2>Current Trays in Greenhouse</h2>
                </div>
                <span class="badge" id="currentCount">0 batches</span>
            </div>
            <div id="currentTraysContainer">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <span>Loading greenhouse data...</span>
                </div>
            </div>
        </section>

        <!-- Upcoming Transplants -->
        <section class="section">
            <div class="section-header">
                <div class="section-header-left">
                    <i class="fas fa-calendar-check"></i>
                    <h2>Upcoming Transplants (Next 14 Days)</h2>
                </div>
            </div>
            <div id="upcomingTransplantsContainer">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <span>Loading transplant schedule...</span>
                </div>
            </div>
        </section>

        <!-- Upcoming Sowings -->
        <section class="section">
            <div class="section-header">
                <div class="section-header-left">
                    <i class="fas fa-hand-holding-seedling"></i>
                    <h2>Upcoming Sowings (Next 7 Days)</h2>
                </div>
            </div>
            <div id="upcomingSowingsContainer">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <span>Loading sowing schedule...</span>
                </div>
            </div>
        </section>
    </main>

    <!-- Tray Stock Modal -->
    <div class="stock-modal" id="stockModal">
        <div class="stock-modal-content">
            <h3><i class="fas fa-boxes-stacked"></i> <span id="stockModalTitle">Update Tray Stock</span></h3>
            <input type="hidden" id="stockModalSize">
            <div class="stock-input-group">
                <label>Tray Size (cells)</label>
                <select id="stockSizeSelect" style="width: 100%; padding: 12px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                    <option value="50">50-cell</option>
                    <option value="72">72-cell</option>
                    <option value="98">98-cell</option>
                    <option value="128">128-cell</option>
                    <option value="200">200-cell</option>
                    <option value="264">264-cell (Paperpot)</option>
                </select>
            </div>
            <div class="stock-input-group">
                <label>Total Stock (empty trays you own)</label>
                <input type="number" id="stockTotalInput" min="0" placeholder="Enter total trays owned">
            </div>
            <div class="stock-input-group">
                <label>Reorder Point (alert when available drops below)</label>
                <input type="number" id="stockReorderInput" min="0" placeholder="e.g., 10">
            </div>
            <div class="stock-modal-actions">
                <button class="btn-cancel" onclick="closeStockModal()">Cancel</button>
                <button class="btn-save" onclick="saveStock()">Save</button>
            </div>
        </div>
    </div>

    <!-- Tray Edit Modal (for individual plantings) -->
    <div class="tray-edit-modal" id="trayEditModal">
        <div class="tray-edit-content">
            <h3><i class="fas fa-edit"></i> Edit Tray Details</h3>
            <input type="hidden" id="trayEditBatchId">

            <div class="tray-edit-info">
                <div class="crop-name" id="trayEditCropName">Lettuce - Salanova</div>
                <div class="batch-id" id="trayEditBatchDisplay">26-LET-001</div>
            </div>

            <div class="stock-input-group">
                <label>Number of Trays</label>
                <input type="number" id="trayEditCount" min="1" placeholder="e.g., 4">
            </div>

            <div class="stock-input-group">
                <label>Tray Size</label>
                <select id="trayEditSize" onchange="onTrayEditSizeChange()">
                    <option value="50">50-cell</option>
                    <option value="72">72-cell</option>
                    <option value="98">98-cell</option>
                    <option value="128">128-cell</option>
                    <option value="200">200-cell</option>
                    <option value="264">264-cell (Paperpot)</option>
                </select>
            </div>

            <div class="stock-input-group paperpot-spacing-group" id="paperpotSpacingGroup">
                <label>Paperpot Spacing</label>
                <div class="spacing-buttons">
                    <button type="button" class="spacing-btn" data-spacing="2" onclick="selectSpacing(2)">2"</button>
                    <button type="button" class="spacing-btn" data-spacing="4" onclick="selectSpacing(4)">4"</button>
                    <button type="button" class="spacing-btn" data-spacing="6" onclick="selectSpacing(6)">6"</button>
                </div>
                <input type="hidden" id="trayEditSpacing" value="">
            </div>

            <div class="stock-modal-actions">
                <button class="btn-cancel" onclick="closeTrayEditModal()">Cancel</button>
                <button class="btn-save" onclick="saveTrayEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxmiizjT_T2KI6ZZqAgDt49-8AvTPmq3penl4gSO2qPETMHVFtm0i90C47zGkwJ92vb/exec';

        // Crop icons for display
        const cropIcons = {
            'lettuce': 'ðŸ¥¬', 'tomato': 'ðŸ…', 'pepper': 'ðŸ«‘', 'carrot': 'ðŸ¥•',
            'kale': 'ðŸ¥—', 'spinach': 'ðŸ¥¬', 'basil': 'ðŸŒ¿', 'cilantro': 'ðŸŒ¿',
            'cucumber': 'ðŸ¥’', 'squash': 'ðŸŽƒ', 'zucchini': 'ðŸ¥’', 'bean': 'ðŸ«˜',
            'pea': 'ðŸ«›', 'onion': 'ðŸ§…', 'garlic': 'ðŸ§„', 'beet': 'ðŸ ',
            'radish': 'ðŸ”´', 'turnip': 'ðŸ”µ', 'cabbage': 'ðŸ¥¬', 'broccoli': 'ðŸ¥¦',
            'cauliflower': 'ðŸ¥¦', 'eggplant': 'ðŸ†', 'corn': 'ðŸŒ½', 'potato': 'ðŸ¥”',
            'zinnia': 'ðŸŒ¸', 'sunflower': 'ðŸŒ»', 'dahlia': 'ðŸŒº', 'cosmos': 'ðŸŒ¼',
            'marigold': 'ðŸŒ¼', 'snapdragon': 'ðŸŒ·', 'celosia': 'ðŸŒº', 'aster': 'ðŸŒ¸'
        };

        // Tray stock data
        let trayStock = {};
        let traysInUse = {};

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadTrayStock();
            loadGreenhouseData();
        });

        async function refreshData() {
            await loadTrayStock();
            await loadGreenhouseData();
        }

        // ========================================
        // TRAY STOCK MANAGEMENT
        // ========================================
        async function loadTrayStock() {
            try {
                const response = await fetch(`${API_URL}?action=getTrayInventory`);
                const data = await response.json();

                if (data.success && data.data) {
                    trayStock = {};
                    data.data.forEach(item => {
                        trayStock[item.size] = {
                            total: item.total || 0,
                            reorderPoint: item.reorderPoint || 10
                        };
                    });
                } else {
                    // Use default stock if no data
                    trayStock = getDefaultTrayStock();
                }
            } catch (error) {
                console.error('Error loading tray stock:', error);
                trayStock = getDefaultTrayStock();
            }
        }

        function getDefaultTrayStock() {
            // Default tray stock (user can update)
            return {
                '50': { total: 20, reorderPoint: 5 },
                '72': { total: 50, reorderPoint: 10 },
                '98': { total: 30, reorderPoint: 10 },
                '128': { total: 40, reorderPoint: 10 },
                '200': { total: 20, reorderPoint: 5 },
                '264': { total: 15, reorderPoint: 5 }
            };
        }

        function renderTrayStockGrid() {
            const container = document.getElementById('trayStockGrid');
            const sizes = ['50', '72', '98', '128', '200', '264'];

            let html = '';
            sizes.forEach(size => {
                const stock = trayStock[size] || { total: 0, reorderPoint: 10 };
                const inUse = traysInUse[size] || 0;
                const available = Math.max(0, stock.total - inUse);
                const percentAvailable = stock.total > 0 ? (available / stock.total) * 100 : 0;

                let barClass = 'high';
                if (available <= stock.reorderPoint) barClass = 'low';
                else if (percentAvailable < 50) barClass = 'medium';

                const isPaperpot = size === '264';

                html += `
                    <div class="tray-stock-item">
                        <div class="tray-stock-header">
                            <span class="tray-stock-size">${size}-cell${isPaperpot ? ' (PP)' : ''}</span>
                            <button class="tray-stock-edit" onclick="openEditStockModal('${size}')">
                                <i class="fas fa-pencil"></i>
                            </button>
                        </div>
                        <div class="tray-stock-counts">
                            <div class="tray-count-row">
                                <span class="tray-count-label">Total Owned</span>
                                <span class="tray-count-value total">${stock.total}</span>
                            </div>
                            <div class="tray-count-row">
                                <span class="tray-count-label">In Use</span>
                                <span class="tray-count-value in-use">${inUse}</span>
                            </div>
                            <div class="tray-count-row">
                                <span class="tray-count-label">Available</span>
                                <span class="tray-count-value ${available <= stock.reorderPoint ? 'low' : 'available'}">${available}${available <= stock.reorderPoint ? ' âš ï¸' : ''}</span>
                            </div>
                        </div>
                        <div class="tray-stock-bar">
                            <div class="tray-stock-bar-fill ${barClass}" style="width: ${percentAvailable}%"></div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function openAddTrayModal() {
            document.getElementById('stockModalTitle').textContent = 'Add Tray Stock';
            document.getElementById('stockModalSize').value = '';
            document.getElementById('stockSizeSelect').value = '72';
            document.getElementById('stockSizeSelect').disabled = false;
            document.getElementById('stockTotalInput').value = '';
            document.getElementById('stockReorderInput').value = '10';
            document.getElementById('stockModal').classList.add('active');
        }

        function openEditStockModal(size) {
            const stock = trayStock[size] || { total: 0, reorderPoint: 10 };
            document.getElementById('stockModalTitle').textContent = `Update ${size}-cell Stock`;
            document.getElementById('stockModalSize').value = size;
            document.getElementById('stockSizeSelect').value = size;
            document.getElementById('stockSizeSelect').disabled = true;
            document.getElementById('stockTotalInput').value = stock.total;
            document.getElementById('stockReorderInput').value = stock.reorderPoint;
            document.getElementById('stockModal').classList.add('active');
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
        }

        async function saveStock() {
            const size = document.getElementById('stockModalSize').value || document.getElementById('stockSizeSelect').value;
            const total = parseInt(document.getElementById('stockTotalInput').value) || 0;
            const reorderPoint = parseInt(document.getElementById('stockReorderInput').value) || 10;

            // Update local state
            trayStock[size] = { total, reorderPoint };

            // Save to backend
            try {
                const params = new URLSearchParams({
                    action: 'saveTrayInventory',
                    size: size,
                    total: total,
                    reorderPoint: reorderPoint
                });
                await fetch(`${API_URL}?${params.toString()}`);
            } catch (error) {
                console.error('Error saving tray stock:', error);
            }

            // Update UI
            renderTrayStockGrid();
            closeStockModal();
        }

        // ========================================
        // TRAY EDIT MODAL (Individual Plantings)
        // ========================================
        let currentEditPlanting = null;
        let allPlantings = []; // Store all plantings for reference

        function openTrayEditModal(batchId) {
            const planting = allPlantings.find(p => p.Batch_ID === batchId);
            if (!planting) return;

            currentEditPlanting = planting;

            // Populate modal
            document.getElementById('trayEditBatchId').value = batchId;
            document.getElementById('trayEditCropName').textContent =
                `${planting.Crop || 'Unknown'}${planting.Variety ? ' - ' + planting.Variety : ''}`;
            document.getElementById('trayEditBatchDisplay').textContent = batchId;
            document.getElementById('trayEditCount').value = planting.trays || planting.Trays_Needed || 1;

            // Parse tray size and spacing
            const traySize = parseInt(planting.Tray_Cell_Count) || 128;
            const spacing = parseInt(planting.Paperpot_Spacing) || 0;

            document.getElementById('trayEditSize').value = traySize;
            document.getElementById('trayEditSpacing').value = spacing;

            // Show/hide paperpot spacing
            onTrayEditSizeChange();

            // Set active spacing button
            if (spacing) {
                selectSpacing(spacing);
            }

            document.getElementById('trayEditModal').classList.add('active');
        }

        function closeTrayEditModal() {
            document.getElementById('trayEditModal').classList.remove('active');
            currentEditPlanting = null;
        }

        function onTrayEditSizeChange() {
            const size = document.getElementById('trayEditSize').value;
            const spacingGroup = document.getElementById('paperpotSpacingGroup');

            if (size === '264') {
                spacingGroup.classList.add('visible');
                // Default to 4" if no spacing selected
                if (!document.getElementById('trayEditSpacing').value) {
                    selectSpacing(4);
                }
            } else {
                spacingGroup.classList.remove('visible');
                document.getElementById('trayEditSpacing').value = '';
                // Clear active state on buttons
                document.querySelectorAll('.spacing-btn').forEach(btn => btn.classList.remove('active'));
            }
        }

        function selectSpacing(spacing) {
            document.getElementById('trayEditSpacing').value = spacing;
            document.querySelectorAll('.spacing-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.spacing) === spacing);
            });
        }

        async function saveTrayEdit() {
            const batchId = document.getElementById('trayEditBatchId').value;
            const trays = parseInt(document.getElementById('trayEditCount').value) || 1;
            const traySize = parseInt(document.getElementById('trayEditSize').value) || 128;
            const spacing = parseInt(document.getElementById('trayEditSpacing').value) || 0;

            try {
                const params = new URLSearchParams({
                    action: 'updatePlanting',
                    batchId: batchId,
                    Trays_Needed: trays,
                    Tray_Cell_Count: traySize,
                    Paperpot_Spacing: spacing
                });

                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    closeTrayEditModal();
                    refreshData(); // Reload to show updated data
                } else {
                    alert('Error saving: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving tray edit:', error);
                alert('Error saving changes. Please try again.');
            }
        }

        // Format tray size display (handles paperpot spacing)
        function formatTraySize(traySize, spacing, isPaperpot) {
            if (isPaperpot || traySize === 264) {
                if (spacing) {
                    return `264-${spacing}`;
                }
                return '264-cell';
            }
            return `${traySize}-cell`;
        }

        // ========================================
        // DATA LOADING
        // ========================================
        async function loadGreenhouseData() {
            try {
                const response = await fetch(`${API_URL}?action=getPlanningData`);
                const data = await response.json();

                if (data.success && data.data) {
                    processGreenhouseData(data.data);
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading greenhouse data:', error);
                showEmptyState();
            }
        }

        function processGreenhouseData(plantings) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Store all plantings for reference (used by edit modal)
            allPlantings = plantings;

            // Filter for greenhouse-relevant plantings (transplant or paperpot method)
            const ghPlantings = plantings.filter(p => {
                const method = (p.Planting_Method || p.Method || '').toLowerCase();
                return method.includes('transplant') || method.includes('paperpot');
            });

            // Categorize plantings
            const currentInGH = []; // Sown but not transplanted
            const upcomingTransplants = []; // Transplant date in next 14 days
            const upcomingSowings = []; // GH Sow date in next 7 days
            const traysBySize = {};

            ghPlantings.forEach(p => {
                const ghSowDate = parseDate(p.Plan_GH_Sow || p.GH_Sow_Date);
                const actGhSowDate = parseDate(p.Act_GH_Sow);
                const transplantDate = parseDate(p.Plan_Transplant || p.Transplant_Date);
                const actTransplantDate = parseDate(p.Act_Transplant);
                const trays = parseInt(p.Trays_Needed || p.Trays) || 0;
                const traySize = parseInt(p.Tray_Cell_Count) || 128;

                // Currently in greenhouse: has been sown (Act_GH_Sow) but not transplanted (no Act_Transplant)
                if (actGhSowDate && !actTransplantDate) {
                    const daysInGH = Math.floor((today - actGhSowDate) / (1000 * 60 * 60 * 24));
                    const nurseryDays = parseInt(p.Nursery_Days) || 28;
                    const daysUntilTransplant = transplantDate ? Math.floor((transplantDate - today) / (1000 * 60 * 60 * 24)) : (nurseryDays - daysInGH);
                    const method = (p.Planting_Method || p.Method || '').toLowerCase();
                    const isPaperpot = method.includes('paperpot') || traySize === 264;
                    const spacing = parseInt(p.Paperpot_Spacing) || 0;

                    currentInGH.push({
                        ...p,
                        daysInGH: daysInGH,
                        daysUntilTransplant: daysUntilTransplant,
                        transplantDate: transplantDate,
                        trays: trays,
                        traySize: traySize,
                        isPaperpot: isPaperpot,
                        paperpotSpacing: spacing
                    });

                    // Count trays by size
                    const sizeKey = traySize.toString();
                    traysBySize[sizeKey] = (traysBySize[sizeKey] || 0) + trays;
                }

                // Upcoming transplants: planned transplant in next 14 days (and in GH or sow date has passed)
                if (transplantDate && !actTransplantDate) {
                    const daysUntil = Math.floor((transplantDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil >= -3 && daysUntil <= 14) {
                        // Only show if already sown or should have been sown
                        if (actGhSowDate || (ghSowDate && ghSowDate <= today)) {
                            upcomingTransplants.push({
                                ...p,
                                daysUntilTransplant: daysUntil,
                                transplantDate: transplantDate,
                                trays: trays
                            });
                        }
                    }
                }

                // Upcoming sowings: GH sow date in next 7 days (and not yet sown)
                if (ghSowDate && !actGhSowDate) {
                    const daysUntil = Math.floor((ghSowDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil >= 0 && daysUntil <= 7) {
                        const method = (p.Planting_Method || p.Method || '').toLowerCase();
                        const isPaperpot = method.includes('paperpot') || traySize === 264;
                        const spacing = parseInt(p.Paperpot_Spacing) || 0;

                        upcomingSowings.push({
                            ...p,
                            daysUntilSow: daysUntil,
                            sowDate: ghSowDate,
                            trays: trays,
                            traySize: traySize,
                            isPaperpot: isPaperpot,
                            paperpotSpacing: spacing
                        });
                    }
                }
            });

            // Update stats
            const totalTrays = Object.values(traysBySize).reduce((a, b) => a + b, 0);
            const readyCount = currentInGH.filter(p => p.daysUntilTransplant <= 3).length;
            const uniqueCrops = new Set(currentInGH.map(p => `${p.Crop}-${p.Variety}`)).size;

            document.getElementById('totalTrays').textContent = totalTrays;
            document.getElementById('readyToTransplant').textContent = readyCount;
            document.getElementById('upcomingSowings').textContent = upcomingSowings.length;
            document.getElementById('uniqueCrops').textContent = uniqueCrops;

            // Store trays in use for stock calculation
            traysInUse = traysBySize;

            // Render sections
            renderTrayStockGrid();
            renderTrayInventory(traysBySize);
            renderCurrentTrays(currentInGH);
            renderUpcomingTransplants(upcomingTransplants);
            renderUpcomingSowings(upcomingSowings);
        }

        // ========================================
        // RENDERING
        // ========================================
        function renderTrayInventory(traysBySize) {
            const container = document.getElementById('trayInventory');

            // Standard tray sizes to show (even if 0)
            const standardSizes = ['50', '72', '98', '128', '200', '264'];

            if (Object.keys(traysBySize).length === 0) {
                // Show all sizes with 0 count
                standardSizes.forEach(size => traysBySize[size] = 0);
            }

            // Add any non-standard sizes that exist
            Object.keys(traysBySize).forEach(size => {
                if (!standardSizes.includes(size)) {
                    standardSizes.push(size);
                }
            });

            container.innerHTML = standardSizes.map(size => {
                const count = traysBySize[size] || 0;
                const isPaperpot = size === '264';
                return `
                    <div class="tray-type ${isPaperpot ? 'paperpot' : ''}">
                        <div class="size">${size}-cell</div>
                        <div class="count">${count}</div>
                        <div class="label">${isPaperpot ? 'Paperpot Trays' : 'Trays'}</div>
                    </div>
                `;
            }).join('');
        }

        function renderCurrentTrays(trays) {
            const container = document.getElementById('currentTraysContainer');
            document.getElementById('currentCount').textContent = `${trays.length} batches`;

            if (trays.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-seedling"></i>
                        <p>No trays currently in greenhouse</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Trays appear here after marking them as sown</p>
                    </div>
                `;
                return;
            }

            // Sort by days until transplant (most urgent first)
            trays.sort((a, b) => a.daysUntilTransplant - b.daysUntilTransplant);

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Crop</th>
                            <th>Batch ID</th>
                            <th>Trays</th>
                            <th>Days in GH</th>
                            <th>Transplant</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trays.map(t => {
                            const cropKey = (t.Crop || '').toLowerCase();
                            const icon = cropIcons[cropKey] || 'ðŸŒ±';
                            const statusClass = t.daysUntilTransplant <= 0 ? 'ready' :
                                               t.daysUntilTransplant <= 3 ? 'soon' : '';
                            const statusBadge = t.daysUntilTransplant <= 0 ? 'ready' :
                                               t.daysUntilTransplant <= 3 ? 'upcoming' : 'seedling';
                            const statusText = t.daysUntilTransplant <= 0 ? 'Ready!' :
                                              t.daysUntilTransplant <= 3 ? 'Soon' : 'Growing';
                            const traySizeDisplay = formatTraySize(t.traySize, t.paperpotSpacing, t.isPaperpot);

                            return `
                                <tr>
                                    <td>
                                        <div class="crop-cell">
                                            <span class="crop-icon">${icon}</span>
                                            <div class="crop-info">
                                                <span class="crop-name">${t.Crop || 'Unknown'}</span>
                                                <span class="crop-variety">${t.Variety || ''}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${t.Batch_ID || '--'}</td>
                                    <td>${t.trays} Ã— ${traySizeDisplay}</td>
                                    <td>
                                        <div class="days-display">
                                            <span class="days">${t.daysInGH}</span>
                                            <span class="label">days</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="days-display ${statusClass}">
                                            <span class="days">${t.daysUntilTransplant <= 0 ? 'Now' : t.daysUntilTransplant}</span>
                                            <span class="label">${t.daysUntilTransplant <= 0 ? '' : 'days'}</span>
                                        </div>
                                    </td>
                                    <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
                                    <td>
                                        <button class="edit-tray-btn" onclick="openTrayEditModal('${t.Batch_ID}')" title="Edit tray details">
                                            <i class="fas fa-pencil"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderUpcomingTransplants(transplants) {
            const container = document.getElementById('upcomingTransplantsContainer');

            if (transplants.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-check"></i>
                        <p>No transplants scheduled in the next 14 days</p>
                    </div>
                `;
                return;
            }

            // Group by transplant date
            const byDate = {};
            transplants.forEach(t => {
                const dateKey = formatDate(t.transplantDate);
                if (!byDate[dateKey]) {
                    byDate[dateKey] = [];
                }
                byDate[dateKey].push(t);
            });

            // Sort dates
            const sortedDates = Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b));

            container.innerHTML = `
                <div class="upcoming-grid">
                    ${sortedDates.map(date => {
                        const items = byDate[date];
                        const totalTrays = items.reduce((sum, i) => sum + i.trays, 0);
                        const daysUntil = items[0].daysUntilTransplant;
                        const isOverdue = daysUntil < 0;
                        const isToday = daysUntil === 0;

                        return `
                            <div class="upcoming-card">
                                <div class="date-header">
                                    <span class="date">
                                        ${isToday ? 'TODAY' : isOverdue ? `${Math.abs(daysUntil)} days overdue` : formatDateDisplay(date)}
                                    </span>
                                    <span class="count">${totalTrays} trays</span>
                                </div>
                                <div class="task-list">
                                    ${items.map(item => {
                                        const cropKey = (item.Crop || '').toLowerCase();
                                        const icon = cropIcons[cropKey] || 'ðŸŒ±';
                                        return `
                                            <div class="task-item" data-batch-id="${item.Batch_ID}">
                                                <div class="task-crop">
                                                    <span>${icon}</span>
                                                    <span>${item.Crop}${item.Variety ? ' - ' + item.Variety : ''}</span>
                                                </div>
                                                <span class="task-trays">${item.trays} trays</span>
                                                <div class="task-actions">
                                                    <button class="mark-complete-btn mark-transplant-btn" onclick="markTransplanted('${item.Batch_ID}', this)">
                                                        <i class="fas fa-seedling"></i> Mark Transplanted
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderUpcomingSowings(sowings) {
            const container = document.getElementById('upcomingSowingsContainer');

            if (sowings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-hand-holding-seedling"></i>
                        <p>No sowings scheduled in the next 7 days</p>
                    </div>
                `;
                return;
            }

            // Group by sow date
            const byDate = {};
            sowings.forEach(s => {
                const dateKey = formatDate(s.sowDate);
                if (!byDate[dateKey]) {
                    byDate[dateKey] = [];
                }
                byDate[dateKey].push(s);
            });

            // Sort dates
            const sortedDates = Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b));

            container.innerHTML = `
                <div class="upcoming-grid">
                    ${sortedDates.map(date => {
                        const items = byDate[date];
                        const totalTrays = items.reduce((sum, i) => sum + i.trays, 0);
                        const isToday = items[0].daysUntilSow === 0;

                        return `
                            <div class="upcoming-card">
                                <div class="date-header">
                                    <span class="date">${isToday ? 'TODAY' : formatDateDisplay(date)}</span>
                                    <span class="count">${totalTrays} trays</span>
                                </div>
                                <div class="task-list">
                                    ${items.map(item => {
                                        const cropKey = (item.Crop || '').toLowerCase();
                                        const icon = cropIcons[cropKey] || 'ðŸŒ±';
                                        const traySizeDisplay = formatTraySize(item.traySize, item.paperpotSpacing, item.isPaperpot);
                                        return `
                                            <div class="task-item" data-batch-id="${item.Batch_ID}">
                                                <div class="task-crop">
                                                    <span>${icon}</span>
                                                    <span>${item.Crop}${item.Variety ? ' - ' + item.Variety : ''}</span>
                                                </div>
                                                <span class="task-trays">${item.trays} Ã— ${traySizeDisplay}</span>
                                                <div class="task-actions">
                                                    <button class="mark-complete-btn" onclick="markSown('${item.Batch_ID}', this)">
                                                        <i class="fas fa-check"></i> Mark Sown
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ========================================
        // TASK COMPLETION
        // ========================================
        async function markSown(batchId, buttonEl) {
            if (!batchId) return;

            // Update button state
            buttonEl.classList.add('completing');
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const today = new Date().toISOString().split('T')[0];
                const params = new URLSearchParams({
                    action: 'updatePlanting',
                    id: batchId,
                    Act_GH_Sow: today,
                    STATUS: 'Sown'
                });

                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    buttonEl.classList.remove('completing');
                    buttonEl.classList.add('completed');
                    buttonEl.innerHTML = '<i class="fas fa-check-circle"></i> Sown!';

                    showToast(`Marked as sown on ${formatDateDisplay(today)}`);

                    // Remove the task item after a short delay
                    setTimeout(() => {
                        const taskItem = buttonEl.closest('.task-item');
                        if (taskItem) {
                            taskItem.style.opacity = '0';
                            taskItem.style.transform = 'translateX(20px)';
                            taskItem.style.transition = 'all 0.3s ease';
                            setTimeout(() => {
                                taskItem.remove();
                                // Refresh to update counts
                                loadGreenhouseData();
                            }, 300);
                        }
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to update');
                }
            } catch (error) {
                console.error('Error marking sown:', error);
                buttonEl.classList.remove('completing');
                buttonEl.innerHTML = '<i class="fas fa-check"></i> Mark Sown';
                showToast('Error: Could not mark as sown', 'error');
            }
        }

        async function markTransplanted(batchId, buttonEl) {
            if (!batchId) return;

            // Update button state
            buttonEl.classList.add('completing');
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const today = new Date().toISOString().split('T')[0];
                const params = new URLSearchParams({
                    action: 'updatePlanting',
                    id: batchId,
                    Act_Transplant: today,
                    STATUS: 'PLANTED'
                });

                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    buttonEl.classList.remove('completing');
                    buttonEl.classList.add('completed');
                    buttonEl.innerHTML = '<i class="fas fa-check-circle"></i> Transplanted!';

                    showToast(`Marked as transplanted on ${formatDateDisplay(today)}`);

                    // Remove the task item after a short delay
                    setTimeout(() => {
                        const taskItem = buttonEl.closest('.task-item');
                        if (taskItem) {
                            taskItem.style.opacity = '0';
                            taskItem.style.transform = 'translateX(20px)';
                            taskItem.style.transition = 'all 0.3s ease';
                            setTimeout(() => {
                                taskItem.remove();
                                // Refresh to update counts
                                loadGreenhouseData();
                            }, 300);
                        }
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to update');
                }
            } catch (error) {
                console.error('Error marking transplanted:', error);
                buttonEl.classList.remove('completing');
                buttonEl.innerHTML = '<i class="fas fa-seedling"></i> Mark Transplanted';
                showToast('Error: Could not mark as transplanted', 'error');
            }
        }

        // ========================================
        // UTILITIES
        // ========================================
        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function formatDate(date) {
            if (!date) return '';
            const d = date instanceof Date ? date : new Date(date);
            return d.toISOString().split('T')[0];
        }

        function formatDateDisplay(dateStr) {
            const d = new Date(dateStr);
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            return d.toLocaleDateString('en-US', options);
        }

        function showEmptyState() {
            document.getElementById('totalTrays').textContent = '0';
            document.getElementById('readyToTransplant').textContent = '0';
            document.getElementById('upcomingSowings').textContent = '0';
            document.getElementById('uniqueCrops').textContent = '0';

            document.getElementById('trayInventory').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-database"></i>
                    <p>Could not load greenhouse data</p>
                </div>
            `;

            document.getElementById('currentTraysContainer').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-seedling"></i>
                    <p>No data available</p>
                </div>
            `;

            document.getElementById('upcomingTransplantsContainer').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-calendar-check"></i>
                    <p>No data available</p>
                </div>
            `;

            document.getElementById('upcomingSowingsContainer').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-hand-holding-seedling"></i>
                    <p>No data available</p>
                </div>
            `;
        }

        // ========================================
        // TOAST NOTIFICATIONS
        // ========================================
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto-remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>

    <style>
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--success);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-notification.success {
            border-color: var(--success);
        }

        .toast-notification.success i {
            color: var(--success);
        }

        .toast-notification.error {
            border-color: var(--danger);
        }

        .toast-notification.error i {
            color: var(--danger);
        }
    </style>
</body>
</html>
