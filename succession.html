<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Plant Wizard - Tiny Seed OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2d5a27;
            --primary-light: #4a7c43;
            --primary-dark: #1e3d1a;
            --secondary: #f4a261;
            --accent: #e76f51;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #e63946;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-light: #0f3460;
            --text-primary: #edf2f4;
            --text-secondary: #8d99ae;
            --border: rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f1a 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 15px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i { color: var(--secondary); }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(45, 90, 39, 0.4);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #3ab795 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-container {
            padding: 100px 2rem 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        /* Sections */
        .section {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .section-header i {
            color: var(--secondary);
            font-size: 1.25rem;
        }

        .section-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .section-header .auto-badge {
            margin-left: auto;
            font-size: 0.75rem;
            background: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            color: var(--text-primary);
        }

        /* Category Toggle */
        .category-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .category-btn {
            flex: 1;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg-light);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .category-btn:hover {
            border-color: var(--primary-light);
            color: var(--text-primary);
        }

        .category-btn.active {
            border-color: var(--primary);
            background: rgba(45, 90, 39, 0.2);
            color: var(--text-primary);
        }

        .category-btn i { font-size: 1.25rem; }

        /* Form Row */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row.three-col {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-row.four-col {
            grid-template-columns: repeat(4, 1fr);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-light);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 90, 39, 0.2);
        }

        .form-group select {
            cursor: pointer;
        }

        .form-group .input-suffix {
            position: relative;
        }

        .form-group .input-suffix input {
            padding-right: 50px;
        }

        .form-group .input-suffix span {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Settings Changed Warning */
        .settings-warning {
            display: none;
            background: rgba(233, 196, 106, 0.15);
            border: 1px solid var(--warning);
            border-radius: 10px;
            padding: 12px 16px;
            margin-top: 1rem;
            align-items: center;
            gap: 12px;
        }

        .settings-warning.visible {
            display: flex;
        }

        .settings-warning i {
            color: var(--warning);
        }

        .settings-warning span {
            flex: 1;
            font-size: 0.9rem;
        }

        .settings-warning button {
            background: var(--warning);
            color: var(--bg-dark);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .reset-btn {
            margin-top: 1rem;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .reset-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        /* Date Calculations */
        .calculated-dates {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .calculated-dates h4 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .date-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .date-item:last-child {
            border-bottom: none;
        }

        .date-item i {
            width: 20px;
            text-align: center;
        }

        .date-item .label {
            flex: 1;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .date-item .value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .date-item .note {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Succession Toggle */
        .succession-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 12px;
            margin-top: 1rem;
            cursor: pointer;
        }

        .succession-toggle input {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .succession-toggle label {
            font-weight: 500;
            cursor: pointer;
        }

        .succession-options {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(45, 90, 39, 0.1);
            border: 1px solid var(--primary);
            border-radius: 12px;
        }

        .succession-options.visible {
            display: block;
        }

        .succession-preview {
            margin-top: 1rem;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .succession-preview strong {
            color: var(--text-primary);
        }

        /* Quantity Calculations */
        .quantity-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .quantity-box {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .quantity-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .quantity-box .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Summary Preview */
        .summary-box {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1rem;
        }

        .summary-header .crop-icon {
            font-size: 2rem;
        }

        .summary-header .crop-info h3 {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .summary-header .crop-info span {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .summary-details {
            display: grid;
            gap: 8px;
        }

        .summary-details .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }

        .summary-details .detail-row .label {
            opacity: 0.8;
        }

        /* Footer Actions */
        .footer-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
            border: 1px solid var(--border);
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }

        /* Profile Update Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
        }

        .modal h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal h3 i {
            color: var(--warning);
        }

        .modal p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .modal .changes-list {
            background: var(--bg-light);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal .changes-list li {
            padding: 6px 0;
            color: var(--text-secondary);
            list-style: none;
            display: flex;
            gap: 10px;
        }

        .modal .changes-list li::before {
            content: 'â†’';
            color: var(--warning);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .loading-overlay.visible {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .form-row.three-col { grid-template-columns: 1fr; }
            .form-row.four-col { grid-template-columns: repeat(2, 1fr); }
            .quantity-display { grid-template-columns: 1fr; }
            .header { padding: 1rem; }
            .main-container { padding: 80px 1rem 1rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </a>
            <h1 class="page-title">
                <i class="fas fa-magic"></i>
                Quick Plant Wizard
            </h1>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="resetForm()">
                <i class="fas fa-redo"></i> Reset
            </button>
            <button class="btn btn-primary" id="addAnotherBtn" onclick="addAnother()" style="display: none;">
                <i class="fas fa-plus"></i> Add Another
            </button>
            <button class="btn btn-success" id="saveBtn" onclick="savePlanting()">
                <i class="fas fa-save"></i> Save Planting
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Crop Selection -->
        <section class="section">
            <div class="section-header">
                <i class="fas fa-seedling"></i>
                <h2>Crop Selection</h2>
            </div>

            <div class="category-toggle">
                <button class="category-btn active" data-category="veg" onclick="selectCategory('veg')">
                    <i class="fas fa-carrot"></i>
                    Vegetables & Herbs
                </button>
                <button class="category-btn" data-category="floral" onclick="selectCategory('floral')">
                    <i class="fas fa-spa"></i>
                    Florals
                </button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Crop</label>
                    <select id="cropSelect" onchange="onCropChange()">
                        <option value="">Select a crop...</option>
                    </select>
                    <input type="text" id="newCropInput" placeholder="Enter new crop name..." style="display: none; margin-top: 8px;" onchange="onNewCropInput()">
                </div>
                <div class="form-group">
                    <label>Variety</label>
                    <select id="varietySelect" onchange="onVarietyChange()">
                        <option value="">Select a variety...</option>
                    </select>
                    <input type="text" id="newVarietyInput" placeholder="Enter new variety name..." style="display: none; margin-top: 8px;" onchange="onNewVarietyInput()">
                </div>
            </div>
        </section>

        <!-- Grow Settings -->
        <section class="section">
            <div class="section-header">
                <i class="fas fa-sliders-h"></i>
                <h2>Grow Settings</h2>
                <span class="auto-badge" id="autoLoadBadge" style="display: none;">
                    <i class="fas fa-magic"></i> Auto-loaded
                </span>
            </div>

            <div class="form-row four-col">
                <div class="form-group">
                    <label>Method</label>
                    <select id="methodSelect" onchange="onMethodChange()">
                        <option value="Transplant">Transplant</option>
                        <option value="Direct Seed">Direct Seed</option>
                        <option value="Paperpot">Paperpot</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tray Size</label>
                    <select id="traySizeSelect" onchange="onTraySizeChange()">
                        <option value="50">50-cell</option>
                        <option value="72">72-cell</option>
                        <option value="98">98-cell</option>
                        <option value="128" selected>128-cell</option>
                        <option value="200">200-cell</option>
                        <option value="264">264-cell (Paperpot)</option>
                    </select>
                </div>
                <div class="form-group" id="paperpotSpacingGroup" style="display: none;">
                    <label>Paperpot Spacing</label>
                    <select id="paperpotSpacingSelect" onchange="onSettingsChange()">
                        <option value="2">2" spacing</option>
                        <option value="4" selected>4" spacing</option>
                        <option value="6">6" spacing</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rows/Bed</label>
                    <input type="number" id="rowsInput" value="4" min="1" max="12" onchange="onSettingsChange()">
                </div>
                <div class="form-group">
                    <label>Spacing</label>
                    <div class="input-suffix">
                        <input type="number" id="spacingInput" value="8" min="1" max="48" onchange="onSettingsChange()">
                        <span>in</span>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Nursery Days (GH to Field)</label>
                    <input type="number" id="nurseryDaysInput" value="28" min="0" max="120" onchange="onSettingsChange()">
                </div>
                <div class="form-group">
                    <label>Days to Maturity (DTM)</label>
                    <input type="number" id="dtmInput" value="45" min="1" max="365" onchange="onSettingsChange()">
                </div>
            </div>

            <div class="settings-warning" id="settingsWarning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Settings differ from crop defaults.</span>
                <button onclick="showUpdateProfileModal()">Update Profile?</button>
            </div>

            <button class="reset-btn" onclick="resetToDefaults()">
                <i class="fas fa-undo"></i> Reset to Crop Defaults
            </button>
        </section>

        <!-- Schedule -->
        <section class="section">
            <div class="section-header">
                <i class="fas fa-calendar-alt"></i>
                <h2>Schedule</h2>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Target Date Type</label>
                    <select id="dateTypeSelect" onchange="onDateChange()">
                        <option value="transplant">Sow/Transplant Date</option>
                        <option value="harvest">Target Harvest Date</option>
                        <option value="ghsow">Greenhouse Start Date</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="dateLabel">Sow/Transplant Date</label>
                    <input type="date" id="targetDate" onchange="onDateChange()">
                </div>
            </div>

            <div class="calculated-dates" id="calculatedDates">
                <h4>Calculated Schedule</h4>
                <div class="date-item" id="ghSowRow">
                    <i class="fas fa-home" style="color: var(--primary);"></i>
                    <span class="label">GH Sow</span>
                    <span class="value" id="ghSowDate">--</span>
                </div>
                <div class="date-item">
                    <i class="fas fa-exchange-alt" style="color: var(--secondary);"></i>
                    <span class="label">Transplant/Field Sow</span>
                    <span class="value" id="transplantDate">--</span>
                </div>
                <div class="date-item">
                    <i class="fas fa-cut" style="color: var(--success);"></i>
                    <span class="label">First Harvest</span>
                    <span class="value" id="harvestDate">--</span>
                    <span class="note" id="harvestNote"></span>
                </div>
            </div>

            <div class="succession-toggle" onclick="document.getElementById('successionCheckbox').click()">
                <input type="checkbox" id="successionCheckbox" onclick="event.stopPropagation(); toggleSuccession()">
                <label>Enable Succession Planning</label>
            </div>

            <div class="succession-options" id="successionOptions">
                <div class="form-row three-col">
                    <div class="form-group">
                        <label>Interval</label>
                        <input type="number" id="intervalInput" value="7" min="1" max="60" onchange="updateSuccessionPreview()">
                    </div>
                    <div class="form-group">
                        <label>Unit</label>
                        <select id="intervalUnit" onchange="updateSuccessionPreview()">
                            <option value="days">Days</option>
                            <option value="weeks">Weeks</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Successions</label>
                        <input type="number" id="successionsInput" value="4" min="1" max="52" onchange="updateSuccessionPreview()">
                    </div>
                </div>
                <div class="succession-preview" id="successionPreview">
                    <strong>4 plantings</strong> from Mar 15 - Apr 5, 2026
                </div>
            </div>
        </section>

        <!-- Location & Quantity -->
        <section class="section">
            <div class="section-header">
                <i class="fas fa-map-marker-alt"></i>
                <h2>Location & Quantity</h2>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Bed Assignment</label>
                    <select id="bedSelect" onchange="onBedChange()">
                        <option value="Unassigned">Unassigned (Plan Later)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Total Bed Feet <span style="font-size: 0.75rem; color: var(--text-secondary);">(override)</span></label>
                    <div class="input-suffix">
                        <input type="number" id="bedFeetInput" value="100" min="1" max="10000" onchange="calculateQuantities(); updateSummary();">
                        <span>ft</span>
                    </div>
                </div>
            </div>

            <div class="quantity-display">
                <div class="quantity-box">
                    <div class="value" id="plantsNeeded">600</div>
                    <div class="label">Plants Needed</div>
                </div>
                <div class="quantity-box">
                    <div class="value" id="traysNeeded">5</div>
                    <div class="label">Trays</div>
                </div>
                <div class="quantity-box">
                    <div class="value" id="seedsNeeded">630</div>
                    <div class="label">Seeds (w/ 5% buffer)</div>
                </div>
            </div>
        </section>

        <!-- Summary Preview -->
        <section class="section" id="summarySection" style="display: none;">
            <div class="section-header">
                <i class="fas fa-clipboard-check"></i>
                <h2>Summary</h2>
            </div>

            <div class="summary-box">
                <div class="summary-header">
                    <span class="crop-icon" id="summaryCropIcon">ðŸ¥¬</span>
                    <div class="crop-info">
                        <h3 id="summaryCropName">Lettuce - Salanova Mix</h3>
                        <span id="summaryMethod">Transplant</span>
                    </div>
                </div>
                <div class="summary-details">
                    <div class="detail-row">
                        <span class="label">Plantings</span>
                        <span id="summaryPlantings">1 planting Ã— 100 ft</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Schedule</span>
                        <span id="summarySchedule">GH: Mar 15 â†’ Transplant: Apr 12 â†’ Harvest: May 27</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Location</span>
                        <span id="summaryLocation">Unassigned</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Plants/Trays</span>
                        <span id="summaryQuantity">600 plants / 5 trays</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer Actions -->
        <div class="footer-actions">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                <i class="fas fa-times"></i> Cancel
            </button>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" id="footerAddAnother" onclick="addAnother()" style="display: none;">
                    <i class="fas fa-plus"></i> Add Another Variety
                </button>
                <button class="btn btn-success" onclick="savePlanting()">
                    <i class="fas fa-save"></i> Save Planting
                </button>
            </div>
        </div>
    </main>

    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <h3><i class="fas fa-database"></i> Update Crop Profile?</h3>
            <p>You've changed the default settings for this crop. Would you like to save these as the new defaults?</p>
            <ul class="changes-list" id="changesList">
                <!-- Filled dynamically -->
            </ul>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeProfileModal()">No, Just This Planting</button>
                <button class="btn btn-primary" onclick="updateProfile()">
                    <i class="fas fa-save"></i> Update Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbyaBzyy3-Ycd3tynhv_Pgsq4naGT1YtuEY-j0qFz2ZUcuyqlwmGThuUM5zcI-0lgXot/exec';

        // ========================================
        // STATE
        // ========================================
        let cropProfiles = [];
        let bedData = new Map(); // Store bed ID -> length mapping
        let currentCategory = 'veg';
        let selectedCrop = null;
        let selectedVariety = null;
        let originalSettings = null;
        let savedPlantingsThisSession = 0;
        let isNewCrop = false;
        let isNewVariety = false;

        // Crop icons
        const cropIcons = {
            'Lettuce': 'ðŸ¥¬', 'Tomatoes': 'ðŸ…', 'Tomato': 'ðŸ…', 'Peppers': 'ðŸ«‘', 'Pepper': 'ðŸ«‘',
            'Basil': 'ðŸŒ¿', 'Carrots': 'ðŸ¥•', 'Carrot': 'ðŸ¥•', 'Kale': 'ðŸ¥—', 'Spinach': 'ðŸƒ',
            'Cucumbers': 'ðŸ¥’', 'Cucumber': 'ðŸ¥’', 'Beans': 'ðŸ«˜', 'Bean': 'ðŸ«˜',
            'Squash': 'ðŸŽƒ', 'Zucchini': 'ðŸ¥’', 'Onions': 'ðŸ§…', 'Onion': 'ðŸ§…',
            'Garlic': 'ðŸ§„', 'Beets': 'ðŸ¥•', 'Beet': 'ðŸ¥•', 'Radish': 'ðŸ”´',
            'Peas': 'ðŸ«›', 'Corn': 'ðŸŒ½', 'Eggplant': 'ðŸ†', 'Celery': 'ðŸ¥¬',
            'Chard': 'ðŸ¥¬', 'Swiss Chard': 'ðŸ¥¬', 'Arugula': 'ðŸ¥¬', 'Cilantro': 'ðŸŒ¿',
            'Dill': 'ðŸŒ¿', 'Parsley': 'ðŸŒ¿', 'Mint': 'ðŸŒ¿', 'Oregano': 'ðŸŒ¿',
            'Thyme': 'ðŸŒ¿', 'Rosemary': 'ðŸŒ¿', 'Sage': 'ðŸŒ¿', 'Chives': 'ðŸŒ¿',
            'Fennel': 'ðŸŒ¿', 'Leeks': 'ðŸ§…', 'Leek': 'ðŸ§…', 'Scallions': 'ðŸ§…', 'Scallion': 'ðŸ§…',
            'Broccoli': 'ðŸ¥¦', 'Cauliflower': 'ðŸ¥¦', 'Cabbage': 'ðŸ¥¬', 'Brussels Sprouts': 'ðŸ¥¬',
            'Kohlrabi': 'ðŸ¥¬', 'Bok Choy': 'ðŸ¥¬', 'Pak Choi': 'ðŸ¥¬', 'Turnip': 'ðŸ¥•',
            'Zinnia': 'ðŸŒ¸', 'Sunflower': 'ðŸŒ»', 'Dahlia': 'ðŸŒ¸', 'Cosmos': 'ðŸŒ¸',
            'Marigold': 'ðŸŒ¼', 'Snapdragon': 'ðŸŒ¸', 'Celosia': 'ðŸŒ¸', 'Lisianthus': 'ðŸŒ¸',
            'Ranunculus': 'ðŸŒ¸', 'Anemone': 'ðŸŒ¸', 'Sweet Pea': 'ðŸŒ¸', 'Larkspur': 'ðŸŒ¸',
            'Stock': 'ðŸŒ¸', 'Delphinium': 'ðŸŒ¸', 'Rudbeckia': 'ðŸŒ»', 'Echinacea': 'ðŸŒ¸'
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('targetDate').value = today;

            // Load crop profiles
            await loadCropProfiles();

            // Load beds
            await loadBeds();

            // Initial calculations
            calculateQuantities();
            onDateChange();
        });

        // ========================================
        // API CALLS
        // ========================================
        async function loadCropProfiles() {
            try {
                const response = await fetch(`${API_URL}?action=getCropProfiles`);
                const data = await response.json();


                if (data.success && data.data && data.data.length > 0) {
                    // Normalize column names from API data
                    cropProfiles = data.data.map(profile => normalizeProfile(profile));
                    populateCropDropdown();
                } else {
                    console.warn('No crop profiles from API, using defaults');
                    loadDefaultProfiles();
                }
            } catch (error) {
                console.error('Error loading crop profiles:', error);
                loadDefaultProfiles();
            }
        }

        // Normalize profile data to handle different column naming conventions
        function normalizeProfile(profile) {
            return {
                Crop: profile.Crop || profile.Crop_Name || profile.crop || '',
                Variety: profile.Variety || profile.Variety_Default || profile.variety || '',
                Primary_Category: profile.Primary_Category || profile.Category || profile.category || profile.Type || 'Veg',
                DTM: parseInt(profile.DTM || profile.dtm || profile.Days_To_Maturity || 0) || 0,
                Spacing: parseInt(profile.Spacing || profile.spacing || profile.In_Row_Spacing_In || profile.In_Row_Spacing || 0) || 0,
                Rows_Per_Bed: parseInt(profile.Rows_Per_Bed || profile.rows_per_bed || profile.Rows || 0) || 4,
                Tray_Cell_Count: parseInt(profile.Tray_Cell_Count || profile.tray_cell_count || profile.Cell_Count || 0) || 128,
                Nursery_Days: parseInt(profile.Nursery_Days || profile.nursery_days || profile.GH_Days || 0) || 0,
                Planting_Method: profile.Planting_Method || profile.planting_method || profile.Method || 'Transplant',
                // Keep original profile for reference
                _original: profile
            };
        }

        function loadDefaultProfiles() {
            cropProfiles = [
                { Crop: 'Lettuce', Primary_Category: 'Veg', DTM: 45, Spacing: 8, Rows_Per_Bed: 4, Tray_Cell_Count: 128, Nursery_Days: 28, Planting_Method: 'Transplant' },
                { Crop: 'Tomato', Primary_Category: 'Veg', DTM: 75, Spacing: 24, Rows_Per_Bed: 2, Tray_Cell_Count: 72, Nursery_Days: 42, Planting_Method: 'Transplant' },
                { Crop: 'Pepper', Primary_Category: 'Veg', DTM: 70, Spacing: 18, Rows_Per_Bed: 2, Tray_Cell_Count: 72, Nursery_Days: 49, Planting_Method: 'Transplant' },
                { Crop: 'Basil', Primary_Category: 'Herb', DTM: 28, Spacing: 6, Rows_Per_Bed: 4, Tray_Cell_Count: 128, Nursery_Days: 21, Planting_Method: 'Transplant' },
                { Crop: 'Carrot', Primary_Category: 'Veg', DTM: 70, Spacing: 2, Rows_Per_Bed: 6, Tray_Cell_Count: 0, Nursery_Days: 0, Planting_Method: 'Direct Seed' },
                { Crop: 'Kale', Primary_Category: 'Veg', DTM: 55, Spacing: 12, Rows_Per_Bed: 3, Tray_Cell_Count: 128, Nursery_Days: 28, Planting_Method: 'Transplant' },
                { Crop: 'Spinach', Primary_Category: 'Veg', DTM: 40, Spacing: 4, Rows_Per_Bed: 6, Tray_Cell_Count: 0, Nursery_Days: 0, Planting_Method: 'Direct Seed' },
                { Crop: 'Zinnia', Primary_Category: 'Floral', DTM: 60, Spacing: 9, Rows_Per_Bed: 4, Tray_Cell_Count: 72, Nursery_Days: 28, Planting_Method: 'Transplant' },
                { Crop: 'Sunflower', Primary_Category: 'Floral', DTM: 70, Spacing: 12, Rows_Per_Bed: 3, Tray_Cell_Count: 50, Nursery_Days: 14, Planting_Method: 'Direct Seed' },
            ];
            populateCropDropdown();
        }

        async function loadBeds() {
            try {
                const response = await fetch(`${API_URL}?action=getBeds`);
                const data = await response.json();

                const bedSelect = document.getElementById('bedSelect');
                bedSelect.innerHTML = '<option value="Unassigned">Unassigned (Plan Later)</option>';
                bedData.clear();

                if (data.success && data.data) {
                    // Group beds by field for better organization
                    const bedsByField = {};
                    data.data.forEach(bed => {
                        const bedId = bed['Bed ID'] || bed.Target_Bed_ID || bed.Bed_ID || bed.id;
                        const length = parseInt(bed.Length) || parseInt(bed.length) || 100;
                        const parentField = bed['Parent Field'] || bed.Parent_Field || bedId.split('-')[0];

                        // Store bed length in map
                        bedData.set(bedId, length);

                        if (!bedsByField[parentField]) {
                            bedsByField[parentField] = [];
                        }
                        bedsByField[parentField].push({ id: bedId, length: length });
                    });

                    // Add beds grouped by field
                    Object.keys(bedsByField).sort().forEach(field => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `Field ${field}`;

                        bedsByField[field].forEach(bed => {
                            const option = document.createElement('option');
                            option.value = bed.id;
                            option.textContent = `${bed.id} (${bed.length} ft)`;
                            option.dataset.length = bed.length;
                            optgroup.appendChild(option);
                        });

                        bedSelect.appendChild(optgroup);
                    });
                } else {
                    loadDefaultBeds();
                }
            } catch (error) {
                loadDefaultBeds();
            }
        }

        async function loadDefaultBeds() {
            const bedSelect = document.getElementById('bedSelect');

            // Try to load from getFields API first
            try {
                const response = await fetch(`${API_URL}?action=getFields`);
                const data = await response.json();

                if (data.success && data.fields && data.fields.length > 0) {
                    data.fields.forEach(field => {
                        if (!field.fieldCode || field.numberOfBeds === 0) return;

                        const optgroup = document.createElement('optgroup');
                        optgroup.label = field.fieldName || `Field ${field.fieldCode}`;

                        for (let i = 1; i <= field.numberOfBeds; i++) {
                            const bedId = `${field.fieldCode}-${String(i).padStart(2, '0')}`;
                            const length = field.length || 100;
                            bedData.set(bedId, length);

                            const option = document.createElement('option');
                            option.value = bedId;
                            option.textContent = `${bedId} (${length} ft)`;
                            option.dataset.length = length;
                            optgroup.appendChild(option);
                        }

                        bedSelect.appendChild(optgroup);
                    });
                    return;
                }
            } catch (error) {
                console.warn('Could not load fields from API, using fallback:', error);
            }

            // Fallback to hardcoded values if API fails
            const fieldConfig = {
                'F3L': { beds: 12, length: 400 },
                'F7M': { beds: 10, length: 250 },
                'F11M': { beds: 10, length: 240 },
                'HOL': { beds: 12, length: 540 },
                'IL': { beds: 11, length: 300 },
                'IOL': { beds: 8, length: 400 },
                'JL': { beds: 10, length: 460 },
                'JS1': { beds: 15, length: 320 },
                'JS4': { beds: 10, length: 300 },
                'JS6': { beds: 10, length: 360 },
                'JS10': { beds: 14, length: 350 },
                'M': { beds: 14, length: 300 },
                'SO': { beds: 12, length: 400 },
                'Z3': { beds: 15, length: 520 },
                'Z5': { beds: 6, length: 300 }
            };

            Object.keys(fieldConfig).sort().forEach(field => {
                const config = fieldConfig[field];
                const optgroup = document.createElement('optgroup');
                optgroup.label = `Field ${field}`;

                for (let i = 1; i <= config.beds; i++) {
                    const bedId = `${field}-${String(i).padStart(2, '0')}`;
                    bedData.set(bedId, config.length);

                    const option = document.createElement('option');
                    option.value = bedId;
                    option.textContent = `${bedId} (${config.length} ft)`;
                    option.dataset.length = config.length;
                    optgroup.appendChild(option);
                }

                bedSelect.appendChild(optgroup);
            });
        }

        function onBedChange() {
            const bedSelect = document.getElementById('bedSelect');
            const bedFeetInput = document.getElementById('bedFeetInput');
            const selectedBed = bedSelect.value;

            if (selectedBed === 'Unassigned') {
                // Keep current value or set default for unassigned
                if (!bedFeetInput.value || bedFeetInput.value === '0') {
                    bedFeetInput.value = 100;
                }
            } else {
                // Auto-populate with bed length
                const length = bedData.get(selectedBed) || 100;
                bedFeetInput.value = length;
            }

            calculateQuantities();
            updateSummary();
        }

        // ========================================
        // CROP SELECTION
        // ========================================
        function selectCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
            populateCropDropdown();
        }

        function populateCropDropdown() {
            const cropSelect = document.getElementById('cropSelect');
            cropSelect.innerHTML = '<option value="">Select a crop...</option>';

            // More flexible category matching
            const filteredCrops = cropProfiles.filter(profile => {
                const cat = (profile.Primary_Category || '').toLowerCase().trim();

                if (currentCategory === 'veg') {
                    // Include veg, vegetable, herb, herbs, greens, root, and anything NOT floral
                    return cat === 'veg' || cat === 'vegetable' || cat === 'vegetables' ||
                           cat === 'herb' || cat === 'herbs' ||
                           cat === 'greens' || cat === 'root' || cat === 'roots' ||
                           cat === 'leafy' || cat === 'brassica' || cat === 'allium' ||
                           cat === '' || // Empty category defaults to veg
                           (!cat.includes('floral') && !cat.includes('flower') && !cat.includes('cut'));
                } else {
                    // Florals
                    return cat === 'floral' || cat === 'florals' ||
                           cat === 'flower' || cat === 'flowers' ||
                           cat === 'cut' || cat === 'cut flower' || cat === 'cut flowers';
                }
            });


            // Get unique crop names, filtering out empty values
            const uniqueCrops = [...new Set(filteredCrops.map(p => p.Crop).filter(c => c))].sort();

            uniqueCrops.forEach(crop => {
                const option = document.createElement('option');
                option.value = crop;
                option.textContent = crop;
                cropSelect.appendChild(option);
            });

            // If no crops found, show all as fallback
            if (uniqueCrops.length === 0 && cropProfiles.length > 0) {
                console.warn('No crops matched category filter, showing all crops');
                const allCrops = [...new Set(cropProfiles.map(p => p.Crop).filter(c => c))].sort();
                allCrops.forEach(crop => {
                    const option = document.createElement('option');
                    option.value = crop;
                    option.textContent = crop;
                    cropSelect.appendChild(option);
                });
            }

            // Add "New Crop" option at the end
            const addNewOption = document.createElement('option');
            addNewOption.value = '__add_new__';
            addNewOption.textContent = '+ Add New Crop...';
            addNewOption.style.fontStyle = 'italic';
            cropSelect.appendChild(addNewOption);

            // Hide the new crop input
            document.getElementById('newCropInput').style.display = 'none';
        }

        function onCropChange() {
            const cropSelect = document.getElementById('cropSelect');
            const cropName = cropSelect.value;
            const newCropInput = document.getElementById('newCropInput');
            const newVarietyInput = document.getElementById('newVarietyInput');

            // Handle "Add New Crop" selection
            if (cropName === '__add_new__') {
                newCropInput.style.display = 'block';
                newCropInput.focus();
                newVarietyInput.style.display = 'block';
                document.getElementById('varietySelect').innerHTML = '<option value="">Enter variety below...</option>';
                selectedCrop = null;
                isNewCrop = true;
                // Set default grow settings for new crop
                clearGrowSettings();
                return;
            }

            newCropInput.style.display = 'none';
            newCropInput.value = '';
            isNewCrop = false;

            if (!cropName) {
                selectedCrop = null;
                document.getElementById('varietySelect').innerHTML = '<option value="">Select a variety...</option>';
                newVarietyInput.style.display = 'none';
                return;
            }

            // Find all profiles for this crop
            const cropData = cropProfiles.filter(p => (p.Crop || p.Crop_Name) === cropName);
            selectedCrop = cropData[0];

            // Populate varieties
            const varietySelect = document.getElementById('varietySelect');
            varietySelect.innerHTML = '<option value="">Select a variety...</option>';

            // Get unique varieties for this crop (check both Variety and Variety_Default column names)
            const varieties = [...new Set(cropData.map(p => p.Variety || p.Variety_Default).filter(v => v))];
            if (varieties.length === 0) {
                varieties.push('Standard');
            }

            varieties.forEach(variety => {
                const option = document.createElement('option');
                option.value = variety;
                option.textContent = variety;
                varietySelect.appendChild(option);
            });

            // Add "New Variety" option
            const addNewVarietyOption = document.createElement('option');
            addNewVarietyOption.value = '__add_new__';
            addNewVarietyOption.textContent = '+ Add New Variety...';
            addNewVarietyOption.style.fontStyle = 'italic';
            varietySelect.appendChild(addNewVarietyOption);

            // Hide new variety input
            newVarietyInput.style.display = 'none';
            newVarietyInput.value = '';

            // Auto-select first variety
            if (varieties.length > 0) {
                varietySelect.value = varieties[0];
                onVarietyChange();
            }
        }

        function onVarietyChange() {
            const variety = document.getElementById('varietySelect').value;
            const newVarietyInput = document.getElementById('newVarietyInput');

            // Handle "Add New Variety" selection
            if (variety === '__add_new__') {
                newVarietyInput.style.display = 'block';
                newVarietyInput.focus();
                isNewVariety = true;
                selectedVariety = null;
                // Keep parent crop's settings as defaults for new variety
                if (selectedCrop) {
                    populateGrowSettings(selectedCrop);
                }
                updateSummary();
                return;
            }

            newVarietyInput.style.display = 'none';
            newVarietyInput.value = '';
            isNewVariety = false;
            selectedVariety = variety;

            if (selectedCrop) {
                // Try to find variety-specific profile (check both Variety and Variety_Default)
                const cropName = document.getElementById('cropSelect').value;
                const varietyProfile = cropProfiles.find(p =>
                    (p.Crop || p.Crop_Name) === cropName && (p.Variety === variety || p.Variety_Default === variety)
                );

                const profile = varietyProfile || selectedCrop;
                populateGrowSettings(profile);
                updateSummary();
            }
        }

        // Handle new crop name input
        function onNewCropInput() {
            const newCropName = document.getElementById('newCropInput').value.trim();
            if (newCropName) {
                selectedCrop = { Crop: newCropName, Primary_Category: currentCategory === 'veg' ? 'Veg' : 'Floral' };
                updateSummary();
            }
        }

        // Handle new variety name input
        function onNewVarietyInput() {
            const newVarietyName = document.getElementById('newVarietyInput').value.trim();
            if (newVarietyName) {
                selectedVariety = newVarietyName;
                updateSummary();
            }
        }

        // Clear grow settings to defaults for new crop
        function clearGrowSettings() {
            document.getElementById('methodSelect').value = 'Transplant';
            document.getElementById('traySizeSelect').value = 128;
            document.getElementById('rowsInput').value = 4;
            document.getElementById('spacingInput').value = 8;
            document.getElementById('nurseryDaysInput').value = 28;
            document.getElementById('dtmInput').value = 45;
            originalSettings = null;
            document.getElementById('settingsWarning').classList.remove('visible');
            document.getElementById('autoLoadBadge').style.display = 'none';
        }

        // ========================================
        // GROW SETTINGS
        // ========================================
        function populateGrowSettings(profile) {
            const method = profile.Planting_Method || 'Transplant';
            const traySize = profile.Tray_Cell_Count || 128;

            document.getElementById('methodSelect').value = method;
            document.getElementById('traySizeSelect').value = traySize;
            document.getElementById('rowsInput').value = profile.Rows_Per_Bed || 4;
            document.getElementById('spacingInput').value = profile.Spacing || 8;
            document.getElementById('nurseryDaysInput').value = profile.Nursery_Days || 28;
            document.getElementById('dtmInput').value = profile.DTM || 45;

            // Show/hide Paperpot spacing based on method or tray size
            const paperpotSpacingGroup = document.getElementById('paperpotSpacingGroup');
            if (method === 'Paperpot' || traySize === 264) {
                paperpotSpacingGroup.style.display = 'block';
                // Set default paperpot spacing if available in profile
                if (profile.Paperpot_Spacing) {
                    document.getElementById('paperpotSpacingSelect').value = profile.Paperpot_Spacing;
                }
            } else {
                paperpotSpacingGroup.style.display = 'none';
            }

            // Store original settings for comparison
            originalSettings = {
                method: method,
                traySize: traySize,
                rows: profile.Rows_Per_Bed || 4,
                spacing: profile.Spacing || 8,
                nurseryDays: profile.Nursery_Days || 28,
                dtm: profile.DTM || 45
            };

            // Show auto-load badge
            document.getElementById('autoLoadBadge').style.display = 'inline-flex';
            setTimeout(() => {
                document.getElementById('autoLoadBadge').style.display = 'none';
            }, 3000);

            // Hide settings warning
            document.getElementById('settingsWarning').classList.remove('visible');

            // Update calculations
            onSettingsChange();
            calculateQuantities();
            onDateChange();
        }

        function onMethodChange() {
            const methodSelect = document.getElementById('methodSelect');
            const traySizeSelect = document.getElementById('traySizeSelect');
            const paperpotSpacingGroup = document.getElementById('paperpotSpacingGroup');

            // When Paperpot method is selected, default to 264-cell and show spacing
            if (methodSelect.value === 'Paperpot') {
                traySizeSelect.value = '264';
                paperpotSpacingGroup.style.display = 'block';
            } else {
                paperpotSpacingGroup.style.display = 'none';
                // If switching away from Paperpot and still on 264, switch to 128
                if (traySizeSelect.value === '264') {
                    traySizeSelect.value = '128';
                }
            }

            calculateQuantities();
            onSettingsChange();
            onDateChange();
            updateSummary();
        }

        function onTraySizeChange() {
            const traySizeSelect = document.getElementById('traySizeSelect');
            const paperpotSpacingGroup = document.getElementById('paperpotSpacingGroup');
            const methodSelect = document.getElementById('methodSelect');
            const traySize = parseInt(traySizeSelect.value);

            // Show Paperpot spacing selector when 264-cell is selected
            if (traySize === 264) {
                paperpotSpacingGroup.style.display = 'block';
                // Auto-select Paperpot method if not already
                if (methodSelect.value !== 'Paperpot') {
                    methodSelect.value = 'Paperpot';
                }
            } else {
                paperpotSpacingGroup.style.display = 'none';
            }

            // Recalculate quantities and trigger settings change
            calculateQuantities();
            onSettingsChange();
            updateSummary();
        }

        function onSettingsChange() {
            // Check if settings differ from original
            if (!originalSettings) return;

            const currentSettings = getCurrentSettings();
            const hasChanges =
                currentSettings.method !== originalSettings.method ||
                currentSettings.traySize !== originalSettings.traySize ||
                currentSettings.rows !== originalSettings.rows ||
                currentSettings.spacing !== originalSettings.spacing ||
                currentSettings.nurseryDays !== originalSettings.nurseryDays ||
                currentSettings.dtm !== originalSettings.dtm;

            document.getElementById('settingsWarning').classList.toggle('visible', hasChanges);

            // Update GH sow row visibility based on method
            const method = document.getElementById('methodSelect').value;
            document.getElementById('ghSowRow').style.display = method === 'Direct Seed' ? 'none' : 'flex';

            // Recalculate
            calculateQuantities();
            onDateChange();
            updateSummary();
        }

        function getCurrentSettings() {
            const method = document.getElementById('methodSelect').value;
            const traySize = parseInt(document.getElementById('traySizeSelect').value);
            return {
                method: method,
                traySize: traySize,
                paperpotSpacing: method === 'Paperpot' ? parseInt(document.getElementById('paperpotSpacingSelect').value) : null,
                rows: parseInt(document.getElementById('rowsInput').value),
                spacing: parseInt(document.getElementById('spacingInput').value),
                nurseryDays: parseInt(document.getElementById('nurseryDaysInput').value),
                dtm: parseInt(document.getElementById('dtmInput').value)
            };
        }

        function resetToDefaults() {
            if (originalSettings) {
                document.getElementById('methodSelect').value = originalSettings.method;
                document.getElementById('traySizeSelect').value = originalSettings.traySize;
                document.getElementById('rowsInput').value = originalSettings.rows;
                document.getElementById('spacingInput').value = originalSettings.spacing;
                document.getElementById('nurseryDaysInput').value = originalSettings.nurseryDays;
                document.getElementById('dtmInput').value = originalSettings.dtm;

                document.getElementById('settingsWarning').classList.remove('visible');
                onSettingsChange();
                showToast('Reset to crop defaults', 'success');
            }
        }

        // ========================================
        // DATE CALCULATIONS
        // ========================================
        function onDateChange() {
            const dateType = document.getElementById('dateTypeSelect').value;
            const targetDate = document.getElementById('targetDate').value;
            const nurseryDays = parseInt(document.getElementById('nurseryDaysInput').value) || 0;
            const dtm = parseInt(document.getElementById('dtmInput').value) || 45;
            const method = document.getElementById('methodSelect').value;

            // Update label
            const labels = {
                'transplant': 'Sow/Transplant Date',
                'harvest': 'Target Harvest Date',
                'ghsow': 'Greenhouse Start Date'
            };
            document.getElementById('dateLabel').textContent = labels[dateType];

            if (!targetDate) return;

            const inputDate = new Date(targetDate);
            let ghSowDate, transplantDate, harvestDate;

            if (method === 'Direct Seed') {
                // Direct seed: no GH sow
                if (dateType === 'transplant') {
                    transplantDate = inputDate;
                    harvestDate = addDays(inputDate, dtm);
                } else if (dateType === 'harvest') {
                    harvestDate = inputDate;
                    transplantDate = addDays(inputDate, -dtm);
                }
                ghSowDate = null;
            } else {
                // Transplant method
                if (dateType === 'transplant') {
                    transplantDate = inputDate;
                    ghSowDate = addDays(inputDate, -nurseryDays);
                    harvestDate = addDays(inputDate, dtm);
                } else if (dateType === 'harvest') {
                    harvestDate = inputDate;
                    transplantDate = addDays(inputDate, -dtm);
                    ghSowDate = addDays(transplantDate, -nurseryDays);
                } else if (dateType === 'ghsow') {
                    ghSowDate = inputDate;
                    transplantDate = addDays(inputDate, nurseryDays);
                    harvestDate = addDays(transplantDate, dtm);
                }
            }

            // Update display
            document.getElementById('ghSowDate').textContent = ghSowDate ? formatDate(ghSowDate) : '--';
            document.getElementById('transplantDate').textContent = transplantDate ? formatDate(transplantDate) : '--';
            document.getElementById('harvestDate').textContent = harvestDate ? formatDate(harvestDate) : '--';
            document.getElementById('harvestNote').textContent = `(${dtm} days)`;

            updateSuccessionPreview();
            updateSummary();
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatDateShort(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }

        // ========================================
        // SUCCESSION PLANNING
        // ========================================
        function toggleSuccession() {
            const enabled = document.getElementById('successionCheckbox').checked;
            document.getElementById('successionOptions').classList.toggle('visible', enabled);
            if (enabled) {
                updateSuccessionPreview();
            }
            updateSummary();
        }

        function updateSuccessionPreview() {
            const enabled = document.getElementById('successionCheckbox').checked;
            if (!enabled) return;

            const interval = parseInt(document.getElementById('intervalInput').value) || 7;
            const unit = document.getElementById('intervalUnit').value;
            const successions = parseInt(document.getElementById('successionsInput').value) || 4;
            const targetDate = document.getElementById('targetDate').value;

            if (!targetDate) return;

            const intervalDays = unit === 'weeks' ? interval * 7 : interval;
            const startDate = new Date(targetDate);
            const endDate = addDays(startDate, intervalDays * (successions - 1));

            document.getElementById('successionPreview').innerHTML = `
                <strong>${successions} plantings</strong> from ${formatDateShort(startDate)} - ${formatDateShort(endDate)}
            `;

            updateSummary();
        }

        // ========================================
        // QUANTITY CALCULATIONS
        // ========================================
        function calculateQuantities() {
            const bedFeet = parseInt(document.getElementById('bedFeetInput').value) || 100;
            const rows = parseInt(document.getElementById('rowsInput').value) || 4;
            const spacing = parseInt(document.getElementById('spacingInput').value) || 8;
            const traySize = parseInt(document.getElementById('traySizeSelect').value) || 128;

            // Plants per foot = rows / (spacing in feet)
            const spacingFeet = spacing / 12;
            const plantsPerFoot = rows / spacingFeet;
            const plantsNeeded = Math.ceil(bedFeet * plantsPerFoot);

            // Trays needed
            const traysNeeded = traySize > 0 ? Math.ceil(plantsNeeded / traySize) : 0;

            // Seeds with 5% buffer
            const seedsNeeded = Math.ceil(plantsNeeded * 1.05);

            document.getElementById('plantsNeeded').textContent = plantsNeeded.toLocaleString();
            document.getElementById('traysNeeded').textContent = traysNeeded;
            document.getElementById('seedsNeeded').textContent = seedsNeeded.toLocaleString();

            updateSummary();
        }

        // ========================================
        // SUMMARY
        // ========================================
        function updateSummary() {
            const cropName = document.getElementById('cropSelect').value;
            const variety = document.getElementById('varietySelect').value;

            if (!cropName) {
                document.getElementById('summarySection').style.display = 'none';
                return;
            }

            document.getElementById('summarySection').style.display = 'block';

            const method = document.getElementById('methodSelect').value;
            const bedFeet = parseInt(document.getElementById('bedFeetInput').value) || 100;
            const bed = document.getElementById('bedSelect').value;
            const plantsNeeded = document.getElementById('plantsNeeded').textContent;
            const traysNeeded = document.getElementById('traysNeeded').textContent;

            const ghSowDate = document.getElementById('ghSowDate').textContent;
            const transplantDate = document.getElementById('transplantDate').textContent;
            const harvestDate = document.getElementById('harvestDate').textContent;

            const successionEnabled = document.getElementById('successionCheckbox').checked;
            const successions = successionEnabled ? parseInt(document.getElementById('successionsInput').value) : 1;

            // Update summary
            document.getElementById('summaryCropIcon').textContent = cropIcons[cropName] || 'ðŸŒ±';
            document.getElementById('summaryCropName').textContent = `${cropName}${variety ? ' - ' + variety : ''}`;
            document.getElementById('summaryMethod').textContent = method;

            document.getElementById('summaryPlantings').textContent = successionEnabled
                ? `${successions} plantings Ã— ${bedFeet} ft = ${successions * bedFeet} total ft`
                : `1 planting Ã— ${bedFeet} ft`;

            const scheduleText = method === 'Direct Seed'
                ? `Field Sow: ${transplantDate} â†’ Harvest: ${harvestDate}`
                : `GH: ${ghSowDate} â†’ Transplant: ${transplantDate} â†’ Harvest: ${harvestDate}`;
            document.getElementById('summarySchedule').textContent = scheduleText;

            document.getElementById('summaryLocation').textContent = bed === 'Unassigned' ? 'Unassigned (Plan Later)' : bed;

            const traySize = document.getElementById('traySizeSelect').value;
            const trayLabel = traySize === '264' ? '264-cell Paperpot' : `${traySize}-cell`;
            document.getElementById('summaryQuantity').textContent = `${plantsNeeded} plants / ${traysNeeded} trays (${trayLabel})`;
        }

        // ========================================
        // PROFILE UPDATE
        // ========================================
        function showUpdateProfileModal() {
            const changesList = document.getElementById('changesList');
            const changes = [];

            const current = getCurrentSettings();
            if (current.method !== originalSettings.method) changes.push(`Method: ${originalSettings.method} â†’ ${current.method}`);
            if (current.traySize !== originalSettings.traySize) changes.push(`Tray Size: ${originalSettings.traySize} â†’ ${current.traySize}`);
            if (current.rows !== originalSettings.rows) changes.push(`Rows/Bed: ${originalSettings.rows} â†’ ${current.rows}`);
            if (current.spacing !== originalSettings.spacing) changes.push(`Spacing: ${originalSettings.spacing}" â†’ ${current.spacing}"`);
            if (current.nurseryDays !== originalSettings.nurseryDays) changes.push(`Nursery Days: ${originalSettings.nurseryDays} â†’ ${current.nurseryDays}`);
            if (current.dtm !== originalSettings.dtm) changes.push(`DTM: ${originalSettings.dtm} â†’ ${current.dtm}`);

            changesList.innerHTML = changes.map(c => `<li>${c}</li>`).join('');
            document.getElementById('profileModal').classList.add('visible');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('visible');
        }

        async function updateProfile() {
            const cropName = document.getElementById('cropSelect').value;
            const current = getCurrentSettings();

            showLoading();

            try {
                const params = new URLSearchParams({
                    action: 'updateCropProfile',
                    cropName: cropName,
                    plantingMethod: current.method,
                    trayCellCount: current.traySize,
                    rowsPerBed: current.rows,
                    spacing: current.spacing,
                    nurseryDays: current.nurseryDays,
                    dtm: current.dtm
                });

                const response = await fetch(`${API_URL}?${params.toString()}`);
                const data = await response.json();

                hideLoading();
                closeProfileModal();

                if (data.success) {
                    // Update original settings to current
                    originalSettings = { ...current };
                    document.getElementById('settingsWarning').classList.remove('visible');
                    showToast(`Updated ${cropName} profile defaults`, 'success');
                } else {
                    showToast('Could not update profile: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                hideLoading();
                closeProfileModal();
                showToast('Error updating profile', 'error');
                console.error(error);
            }
        }

        // ========================================
        // SAVE PLANTING
        // ========================================
        async function savePlanting() {
            // Get crop name - either from select or from new crop input
            let cropName = document.getElementById('cropSelect').value;
            if (isNewCrop || cropName === '__add_new__') {
                cropName = document.getElementById('newCropInput').value.trim();
                if (!cropName) {
                    showToast('Please enter a crop name', 'error');
                    return;
                }
            }

            // Get variety - either from select or from new variety input
            let variety = document.getElementById('varietySelect').value;
            if (isNewVariety || variety === '__add_new__') {
                variety = document.getElementById('newVarietyInput').value.trim();
                if (!variety) {
                    showToast('Please enter a variety name', 'error');
                    return;
                }
            }

            if (!cropName || cropName === '__add_new__') {
                showToast('Please select or enter a crop', 'error');
                return;
            }

            const targetDate = document.getElementById('targetDate').value;
            if (!targetDate) {
                showToast('Please select a date', 'error');
                return;
            }

            showLoading();

            const settings = getCurrentSettings();
            const bedFeet = parseInt(document.getElementById('bedFeetInput').value) || 100;
            const bed = document.getElementById('bedSelect').value;

            // Get calculated dates
            const ghSowDate = document.getElementById('ghSowDate').textContent;
            const transplantDate = document.getElementById('transplantDate').textContent;
            const harvestDate = document.getElementById('harvestDate').textContent;

            // Check succession mode
            const successionEnabled = document.getElementById('successionCheckbox').checked;
            const successions = successionEnabled ? parseInt(document.getElementById('successionsInput').value) : 1;
            const interval = parseInt(document.getElementById('intervalInput').value) || 7;
            const intervalUnit = document.getElementById('intervalUnit').value;
            const intervalDays = intervalUnit === 'weeks' ? interval * 7 : interval;

            // Generate plantings
            const plantings = [];
            const baseDate = new Date(targetDate);

            for (let i = 0; i < successions; i++) {
                const offsetDays = i * intervalDays;
                const plantingDate = addDays(baseDate, offsetDays);

                // Calculate dates for this planting
                let planGHSow, planTransplant, planFieldSow, firstHarvest;

                if (settings.method === 'Direct Seed') {
                    planFieldSow = formatDateISO(plantingDate);
                    firstHarvest = formatDateISO(addDays(plantingDate, settings.dtm));
                } else {
                    planTransplant = formatDateISO(plantingDate);
                    planGHSow = formatDateISO(addDays(plantingDate, -settings.nurseryDays));
                    firstHarvest = formatDateISO(addDays(plantingDate, settings.dtm));
                }

                // Generate batch ID
                const year = new Date().getFullYear().toString().slice(-2);
                const cropCode = cropName.substring(0, 3).toUpperCase();
                const uniqueId = Math.floor(Math.random() * 9000) + 1000;
                const batchId = `${year}-${cropCode}-${uniqueId}`;

                plantings.push({
                    Batch_ID: batchId,
                    Crop: cropName,
                    Variety: variety || 'Standard',
                    Planting_Method: settings.method,
                    Target_Bed_ID: bed,
                    Feet_Used: bedFeet,
                    Plants_Needed: parseInt(document.getElementById('plantsNeeded').textContent.replace(/,/g, '')),
                    Trays_Needed: parseInt(document.getElementById('traysNeeded').textContent),
                    Tray_Cell_Count: settings.traySize,
                    Paperpot_Spacing: settings.paperpotSpacing || '',
                    Plan_GH_Sow: planGHSow || '',
                    Plan_Field_Sow: planFieldSow || '',
                    Plan_Transplant: planTransplant || '',
                    First_Harvest: firstHarvest,
                    STATUS: 'Planned'
                });
            }

            try {
                // If new crop or new variety, create the profile first
                if (isNewCrop || isNewVariety) {
                    const profileParams = new URLSearchParams({
                        action: 'createCropProfile',
                        cropName: cropName,
                        variety: variety || '',
                        category: currentCategory === 'veg' ? 'Veg' : 'Floral',
                        dtm: settings.dtm,
                        spacing: settings.spacing,
                        rowsPerBed: settings.rows,
                        trayCellCount: settings.traySize,
                        nurseryDays: settings.nurseryDays,
                        plantingMethod: settings.method
                    });

                    const profileResponse = await fetch(`${API_URL}?${profileParams.toString()}`);
                    const profileData = await profileResponse.json();

                    if (profileData.success) {
                        showToast(`Created profile for ${cropName}${variety ? ' - ' + variety : ''}`, 'success');
                        // Add to local profiles list
                        cropProfiles.push(profileData.profile);
                    } else {
                        console.warn('Could not create profile:', profileData.error);
                    }
                }

                // Save each planting
                for (const planting of plantings) {
                    const params = new URLSearchParams({
                        action: 'savePlanting',
                        ...planting
                    });

                    const response = await fetch(`${API_URL}?${params.toString()}`);
                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.error || 'Save failed');
                    }
                }

                hideLoading();
                savedPlantingsThisSession += plantings.length;

                // Reset new crop/variety flags
                isNewCrop = false;
                isNewVariety = false;

                showToast(`Saved ${plantings.length} planting(s) to production plan!`, 'success');

                // Show add another buttons
                document.getElementById('addAnotherBtn').style.display = 'flex';
                document.getElementById('footerAddAnother').style.display = 'flex';

            } catch (error) {
                hideLoading();
                console.error('Save error:', error);
                showToast('Error saving: ' + error.message, 'error');
            }
        }

        // ========================================
        // ADD ANOTHER
        // ========================================
        function addAnother() {
            // Keep crop selected, clear variety and other fields
            document.getElementById('varietySelect').value = '';
            document.getElementById('bedSelect').value = 'Unassigned';
            document.getElementById('successionCheckbox').checked = false;
            document.getElementById('successionOptions').classList.remove('visible');

            // Reset date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('targetDate').value = today;

            // Hide add another buttons until next save
            document.getElementById('addAnotherBtn').style.display = 'none';
            document.getElementById('footerAddAnother').style.display = 'none';

            // Recalculate
            onDateChange();
            calculateQuantities();
            updateSummary();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            showToast('Ready to add another variety', 'success');
        }

        function resetForm() {
            document.getElementById('cropSelect').value = '';
            document.getElementById('varietySelect').innerHTML = '<option value="">Select a variety...</option>';
            document.getElementById('bedSelect').value = 'Unassigned';
            document.getElementById('bedFeetInput').value = 100;
            document.getElementById('successionCheckbox').checked = false;
            document.getElementById('successionOptions').classList.remove('visible');
            document.getElementById('settingsWarning').classList.remove('visible');

            selectedCrop = null;
            selectedVariety = null;
            originalSettings = null;

            // Reset date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('targetDate').value = today;

            // Hide buttons
            document.getElementById('addAnotherBtn').style.display = 'none';
            document.getElementById('footerAddAnother').style.display = 'none';

            document.getElementById('summarySection').style.display = 'none';

            onDateChange();
            calculateQuantities();
        }

        // ========================================
        // UTILITIES
        // ========================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} visible`;
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('visible');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('visible');
        }
    </script>
</body>
</html>
