<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tiny Seed OS - Field App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2d5a27;
            --primary-light: #4a7c43;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #e63946;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-light: #0f3460;
            --text-primary: #edf2f4;
            --text-secondary: #8d99ae;
            --border: rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-btn {
            width: 44px;
            height: 44px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .menu-btn:active {
            background: rgba(255,255,255,0.1);
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sync-btn {
            width: 44px;
            height: 44px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .sync-btn.syncing i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Bottom Tab Bar - Mobile Best Practice */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 200;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 64px;
            padding: 8px 4px;
        }

        .tab.active {
            color: var(--primary-light);
        }

        .tab i {
            font-size: 1.25rem;
        }

        .tab .tab-label {
            font-size: 0.68rem;
            margin-top: 2px;
        }

        /* Add Button (Center Tab) */
        .tab.add-tab {
            position: relative;
        }

        .tab.add-tab .add-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -24px;
            box-shadow: 0 4px 15px rgba(45, 90, 39, 0.4);
        }

        .tab.add-tab .add-icon i {
            color: white;
            font-size: 1.25rem;
        }

        .tab.add-tab .tab-label {
            margin-top: 6px;
        }

        /* Main Content */
        .main-content {
            margin-top: 56px;
            padding: 1rem;
            padding-bottom: 90px;
        }

        /* ========================================
           TASK CARDS - Frictionless UX
           ======================================== */
        .section-header {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin: 1rem 0 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header .date-badge {
            font-size: 0.75rem;
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* Bulk Action Bar - Mobile Optimized - Above Bottom Tabs */
        .mobile-action-bar {
            position: fixed;
            bottom: 64px;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            display: none;
            gap: 12px;
            z-index: 150;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }

        .mobile-action-bar.visible {
            display: flex;
        }

        .mobile-select-all {
            flex: 0 0 auto;
            padding: 14px 18px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-select-all.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .mobile-complete-btn {
            flex: 1;
            padding: 16px 24px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(74, 124, 67, 0.4);
        }

        .mobile-complete-btn:disabled {
            opacity: 0.5;
        }

        .mobile-complete-btn i {
            font-size: 1.2rem;
        }

        /* Task Groups */
        .task-group {
            margin-bottom: 1rem;
        }

        .task-group-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            margin-bottom: 8px;
        }

        .task-group-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .task-group-icon.gh-sow { background: rgba(74, 124, 67, 0.2); color: #4a7c43; }
        .task-group-icon.transplant { background: rgba(42, 157, 143, 0.2); color: #2a9d8f; }
        .task-group-icon.direct-seed { background: rgba(233, 196, 106, 0.2); color: #b89b3e; }
        .task-group-icon.harvest { background: rgba(230, 126, 34, 0.2); color: #e67e22; }

        .task-group-title {
            font-weight: 700;
            font-size: 1rem;
            flex: 1;
        }

        .task-group-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: rgba(255,255,255,0.08);
            padding: 4px 12px;
            border-radius: 12px;
        }

        /* Task Cards - Touch Optimized */
        .task-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 0;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.2s;
            overflow: hidden;
        }

        .task-card.selected {
            border-color: var(--primary);
            background: rgba(74, 124, 67, 0.1);
        }

        .task-card-inner {
            display: flex;
            align-items: stretch;
        }

        /* Big Checkbox Area - Easy to tap */
        .task-checkbox-area {
            width: 64px;
            min-height: 100%;
            background: rgba(255,255,255,0.03);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-right: 1px solid var(--border);
        }

        .task-checkbox {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .task-checkbox i {
            font-size: 1.3rem;
            color: white;
            opacity: 0;
        }

        .task-card.selected .task-checkbox {
            border-color: var(--primary);
            background: var(--primary);
        }

        .task-card.selected .task-checkbox i {
            opacity: 1;
        }

        /* Task Content */
        .task-content {
            flex: 1;
            padding: 14px;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .task-crop {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .task-quantity-badge {
            font-size: 0.85rem;
            font-weight: 700;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 8px;
        }

        .task-variety {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .task-location {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Quick Complete Button - Big tap target */
        .quick-complete-btn {
            width: 64px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-complete-btn:active {
            background: var(--success);
        }

        .quick-complete-btn i {
            font-size: 1.5rem;
            color: white;
        }

        .quick-complete-btn.completed {
            background: var(--success);
        }

        /* Swipe indicator */
        .swipe-hint {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: var(--text-secondary);
            padding: 4px 8px;
            opacity: 0.5;
        }

        /* Legacy complete button for compatibility */
        .complete-btn {
            width: 100%;
            min-height: 52px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .complete-btn:active {
            transform: scale(0.98);
        }

        .complete-btn.completed {
            background: var(--success);
        }

        /* Undo Toast */
        .undo-toast {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: #333;
            color: white;
            padding: 14px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 150;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .undo-toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .undo-toast .undo-btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }

        /* All Done State */
        .all-done {
            text-align: center;
            padding: 3rem 1.5rem;
        }

        .all-done i {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 1rem;
        }

        .all-done h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .all-done p {
            color: var(--text-secondary);
        }

        /* ========================================
           OVERDUE TASKS - Mobile Warning Section
           ======================================== */
        .overdue-section {
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.15), rgba(230, 57, 70, 0.05));
            border-radius: 14px;
            border: 2px solid rgba(230, 57, 70, 0.4);
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .overdue-section.visible {
            display: block;
        }

        .overdue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .overdue-header h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--danger);
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .overdue-badge {
            background: var(--danger);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .overdue-card {
            background: rgba(26, 26, 46, 0.7);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(230, 57, 70, 0.3);
            overflow: hidden;
        }

        .overdue-card.selected {
            border-color: var(--danger);
            background: rgba(230, 57, 70, 0.15);
        }

        .overdue-card-inner {
            display: flex;
            align-items: stretch;
        }

        .overdue-checkbox-area {
            width: 56px;
            background: rgba(230, 57, 70, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-right: 1px solid rgba(230, 57, 70, 0.2);
        }

        .overdue-checkbox {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 2px solid rgba(230, 57, 70, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .overdue-checkbox i {
            font-size: 1.1rem;
            color: white;
            opacity: 0;
        }

        .overdue-card.selected .overdue-checkbox {
            background: var(--danger);
            border-color: var(--danger);
        }

        .overdue-card.selected .overdue-checkbox i {
            opacity: 1;
        }

        .overdue-card-content {
            flex: 1;
            padding: 12px;
        }

        .overdue-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .overdue-crop-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .overdue-days {
            background: rgba(230, 57, 70, 0.2);
            color: var(--danger);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .overdue-card-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
        }

        .overdue-complete-btn {
            width: 56px;
            background: var(--danger);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .overdue-complete-btn i {
            font-size: 1.3rem;
            color: white;
        }

        .overdue-complete-btn:active {
            background: #c92a36;
        }

        /* Overdue Action Bar */
        .overdue-action-bar {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            background: rgba(230, 57, 70, 0.95);
            padding: 12px 16px;
            display: none;
            gap: 10px;
            z-index: 99;
            box-shadow: 0 -4px 20px rgba(230, 57, 70, 0.4);
        }

        .overdue-action-bar.visible {
            display: flex;
        }

        .overdue-select-all-mobile {
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .overdue-select-all-mobile.active {
            background: white;
            color: var(--danger);
            border-color: white;
        }

        .overdue-complete-all-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 10px;
            border: none;
            background: white;
            color: var(--danger);
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .overdue-complete-all-btn:disabled {
            opacity: 0.6;
        }

        /* Harvest Form */
        .harvest-form {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--border);
        }

        .form-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            min-height: 48px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0 14px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 80px;
            padding: 12px 14px;
            resize: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0.75rem;
        }

        .quality-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .quality-btn {
            flex: 1;
            min-height: 48px;
            border: 2px solid var(--border);
            background: var(--bg-light);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quality-btn.active {
            border-color: var(--primary-light);
            color: var(--primary-light);
            background: rgba(74, 124, 67, 0.2);
        }

        .submit-btn {
            width: 100%;
            min-height: 52px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 1rem;
        }

        /* Recent Harvests */
        .recent-harvest {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .recent-harvest:last-child {
            border-bottom: none;
        }

        .recent-harvest .info {
            font-size: 0.9rem;
        }

        .recent-harvest .time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Schedule Tab */
        .schedule-day {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .schedule-day-header {
            background: var(--bg-light);
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .schedule-day-header .date {
            color: var(--primary-light);
        }

        .schedule-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .schedule-item:last-child {
            border-bottom: none;
        }

        .schedule-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .schedule-icon.sow { background: rgba(42, 157, 143, 0.2); color: var(--success); }
        .schedule-icon.transplant { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .schedule-icon.harvest { background: rgba(233, 196, 106, 0.2); color: var(--warning); }

        .schedule-info {
            flex: 1;
        }

        .schedule-info .crop {
            font-weight: 500;
        }

        .schedule-info .details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Hamburger Menu */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .menu-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .menu-drawer {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-card);
            z-index: 201;
            transform: translateX(-100%);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        .menu-overlay.visible .menu-drawer {
            transform: translateX(0);
        }

        .menu-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .menu-header h2 {
            font-size: 1.25rem;
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .menu-header .role {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .menu-nav {
            padding: 1rem 0;
            flex: 1;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
        }

        .menu-item:active,
        .menu-item.active {
            background: rgba(45, 90, 39, 0.2);
            color: var(--primary-light);
        }

        .menu-item i {
            width: 24px;
            text-align: center;
        }

        .menu-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
        }

        .menu-link {
            display: block;
            padding: 0.75rem 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border: 1px solid var(--success);
            transition: bottom 0.3s;
            z-index: 500;
        }

        .toast.show { bottom: 20px; }
        .toast.error { border-color: var(--danger); }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-btn" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <span class="header-title">Field App</span>
        </div>
        <button class="sync-btn" id="syncBtn" onclick="syncData()">
            <i class="fas fa-sync-alt"></i>
        </button>
    </header>

    <!-- Bottom Tab Bar -->
    <nav class="tab-bar">
        <button class="tab active" data-tab="tasks" onclick="switchTab('tasks')">
            <i class="fas fa-clipboard-check"></i>
            <span class="tab-label">Tasks</span>
        </button>
        <button class="tab" data-tab="harvests" onclick="switchTab('harvests')">
            <i class="fas fa-basket-shopping"></i>
            <span class="tab-label">Harvest</span>
        </button>
        <button class="tab add-tab" onclick="openMobileAdd()">
            <div class="add-icon">
                <i class="fas fa-plus"></i>
            </div>
            <span class="tab-label">Add</span>
        </button>
        <button class="tab" data-tab="greenhouse" onclick="switchTab('greenhouse')">
            <i class="fas fa-seedling"></i>
            <span class="tab-label">GH</span>
        </button>
        <button class="tab" data-tab="schedule" onclick="switchTab('schedule')">
            <i class="fas fa-calendar"></i>
            <span class="tab-label">Schedule</span>
        </button>
    </nav>

    <!-- Mobile Bulk Action Bar -->
    <div class="mobile-action-bar" id="mobileActionBar">
        <button class="mobile-select-all" id="mobileSelectAll" onclick="toggleSelectAllMobile()">
            <i class="far fa-square"></i>
            All
        </button>
        <button class="mobile-complete-btn" id="mobileCompleteBtn" onclick="completeSelectedMobile()" disabled>
            <i class="fas fa-check-double"></i>
            <span id="mobileCompleteBtnText">Complete Selected</span>
        </button>
    </div>

    <!-- Undo Toast -->
    <div class="undo-toast" id="undoToast">
        <span id="undoMessage">Task completed</span>
        <button class="undo-btn" onclick="undoLastCompletion()">Undo</button>
    </div>

    <!-- Overdue Action Bar -->
    <div class="overdue-action-bar" id="overdueActionBar">
        <button class="overdue-select-all-mobile" id="overdueSelectAllMobile" onclick="toggleOverdueSelectAllMobile()">
            <i class="far fa-square"></i> All
        </button>
        <button class="overdue-complete-all-btn" id="overdueCompleteAllBtn" onclick="completeSelectedOverdueMobile()" disabled>
            <i class="fas fa-check-double"></i>
            <span id="overdueCompleteBtnText">Complete Selected</span>
        </button>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Tasks Tab -->
        <div class="tab-content active" id="tasksContent">
            <!-- Overdue Section -->
            <div class="overdue-section" id="overdueSection">
                <div class="overdue-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Overdue</h3>
                    <span class="overdue-badge" id="overdueBadge">0</span>
                </div>
                <div id="overdueList"></div>
            </div>

            <div class="section-header">
                <span>Today's Work</span>
                <span class="date-badge" id="todayDateBadge"></span>
            </div>
            <div id="todayTasks">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading tasks...</p>
                </div>
            </div>
            <div class="section-header" id="upcomingHeader" style="display: none;">Upcoming This Week</div>
            <div id="upcomingTasks"></div>
        </div>

        <!-- Harvests Tab -->
        <div class="tab-content" id="harvestsContent">
            <div class="harvest-form">
                <div class="form-title">
                    <i class="fas fa-basket-shopping"></i>
                    Quick Harvest Entry
                </div>
                <div class="form-group">
                    <label>Crop</label>
                    <select id="harvestCrop">
                        <option value="">Select crop...</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="harvestQty" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Unit</label>
                        <select id="harvestUnit">
                            <option value="lbs">lbs</option>
                            <option value="bunches">bunches</option>
                            <option value="heads">heads</option>
                            <option value="units">units</option>
                            <option value="oz">oz</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Quality Grade</label>
                    <div class="quality-buttons">
                        <button class="quality-btn active" data-grade="A" onclick="setQuality('A')">A</button>
                        <button class="quality-btn" data-grade="B" onclick="setQuality('B')">B</button>
                        <button class="quality-btn" data-grade="C" onclick="setQuality('C')">C</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="harvestNotes" placeholder="Any observations..."></textarea>
                </div>
                <button class="submit-btn" onclick="submitHarvest()">
                    <i class="fas fa-check"></i>
                    Log Harvest
                </button>
            </div>

            <div class="section-header">Recent Harvests</div>
            <div id="recentHarvests" style="background: var(--bg-card); border-radius: 12px; padding: 1rem; border: 1px solid var(--border);">
                <div class="empty-state">
                    <p>No harvests logged today</p>
                </div>
            </div>
        </div>

        <!-- Greenhouse Tab -->
        <div class="tab-content" id="greenhouseContent">
            <div class="section-header">
                <span>Currently in Greenhouse</span>
            </div>
            <div id="ghTraysList">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading greenhouse...</p>
                </div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div class="tab-content" id="scheduleContent">
            <div id="scheduleList">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading schedule...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Hamburger Menu -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()">
        <div class="menu-drawer" onclick="event.stopPropagation()">
            <div class="menu-header">
                <h2>Tiny Seed OS</h2>
                <div class="role">Field Worker</div>
            </div>
            <nav class="menu-nav">
                <a class="menu-item active" data-tab="tasks" onclick="switchTab('tasks'); toggleMenu();">
                    <i class="fas fa-tasks"></i>
                    <span>My Tasks</span>
                </a>
                <a class="menu-item" data-tab="harvests" onclick="switchTab('harvests'); toggleMenu();">
                    <i class="fas fa-basket-shopping"></i>
                    <span>Log Harvest</span>
                </a>
                <a class="menu-item" data-tab="schedule" onclick="switchTab('schedule'); toggleMenu();">
                    <i class="fas fa-calendar"></i>
                    <span>Schedule</span>
                </a>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 0.5rem 1.5rem;">
                <a class="menu-item" onclick="syncData(); toggleMenu();">
                    <i class="fas fa-sync-alt"></i>
                    <span>Sync Now</span>
                </a>
            </nav>
            <div class="menu-footer">
                <a class="menu-link" href="index.html">
                    <i class="fas fa-desktop"></i> Open Desktop Version
                </a>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbyaBzyy3-Ycd3tynhv_Pgsq4naGT1YtuEY-j0qFz2ZUcuyqlwmGThuUM5zcI-0lgXot/exec';

        // State
        let allPlantings = [];
        let harvestQuality = 'A';
        let currentTab = 'tasks';

        // Task selection state
        let todaysTasks = [];
        let selectedTasks = new Set();
        let lastCompletedTasks = [];
        let undoTimeout = null;

        // Overdue tasks state
        let overdueTasks = [];
        let selectedOverdueTasks = new Set();

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date badge
            const today = new Date();
            const dateBadge = document.getElementById('todayDateBadge');
            if (dateBadge) {
                dateBadge.textContent = today.toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                });
            }
            loadAllData();
        });

        async function loadAllData() {
            try {
                const response = await fetch(`${API_URL}?action=getPlanningData`);
                const data = await response.json();

                if (data.success) {
                    allPlantings = data.data;
                    renderTasks();
                    populateHarvestCrops();
                    renderSchedule();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data', true);
            }
        }

        async function syncData() {
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.classList.add('syncing');
            await loadAllData();
            syncBtn.classList.remove('syncing');
            showToast('Synced!');
        }

        // ========================================
        // TABS
        // ========================================
        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tabName);
            });

            // Update menu items
            document.querySelectorAll('.menu-item[data-tab]').forEach(m => {
                m.classList.toggle('active', m.dataset.tab === tabName);
            });

            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
            });
            document.getElementById(tabName + 'Content').classList.add('active');
        }

        function toggleMenu() {
            document.getElementById('menuOverlay').classList.toggle('visible');
        }

        function openMobileAdd() {
            // Open a quick add action sheet
            const actions = [
                { label: 'Log Harvest', icon: 'basket-shopping', action: () => switchTab('harvests') },
                { label: 'Add Planting', icon: 'seedling', action: () => window.location.href = 'succession.html' },
                { label: 'View Desktop', icon: 'desktop', action: () => window.location.href = 'index.html' }
            ];

            // Simple: just switch to harvests for now (most common mobile action)
            switchTab('harvests');
        }

        // ========================================
        // TASKS - Frictionless UX
        // ========================================
        function renderTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Clear selection on refresh
            selectedTasks.clear();
            selectedOverdueTasks.clear();
            todaysTasks = [];
            overdueTasks = [];

            allPlantings.forEach(p => {
                // GH Sow tasks
                const ghSow = parseDate(p.Plan_GH_Sow);
                if (ghSow && !p.Act_GH_Sow) {
                    const task = {
                        id: `${p.Batch_ID}-ghSow`,
                        type: 'ghSow',
                        typeLabel: 'GH Sow',
                        groupClass: 'gh-sow',
                        icon: 'fa-seedling',
                        crop: p.Crop,
                        variety: p.Variety,
                        location: 'Greenhouse',
                        quantity: `${p.Trays_Needed || '--'} trays`,
                        date: ghSow,
                        batchId: p.Batch_ID,
                        taskType: 'ghSow',
                        daysOverdue: Math.floor((today - ghSow) / (1000 * 60 * 60 * 24))
                    };
                    if (ghSow >= today && ghSow < tomorrow) {
                        todaysTasks.push(task);
                    } else if (ghSow < today) {
                        overdueTasks.push(task);
                    }
                }

                // Field Sow tasks (direct seed)
                const fieldSow = parseDate(p.Plan_Field_Sow);
                if (fieldSow && !p.Act_Field_Sow && !p.Plan_GH_Sow) {
                    const task = {
                        id: `${p.Batch_ID}-fieldSow`,
                        type: 'fieldSow',
                        typeLabel: 'Direct Sow',
                        groupClass: 'direct-seed',
                        icon: 'fa-tractor',
                        crop: p.Crop,
                        variety: p.Variety,
                        location: p.Target_Bed_ID || 'Unassigned',
                        quantity: `${p.Feet_Used || '--'} ft`,
                        date: fieldSow,
                        batchId: p.Batch_ID,
                        taskType: 'fieldSow',
                        daysOverdue: Math.floor((today - fieldSow) / (1000 * 60 * 60 * 24))
                    };
                    if (fieldSow >= today && fieldSow < tomorrow) {
                        todaysTasks.push(task);
                    } else if (fieldSow < today) {
                        overdueTasks.push(task);
                    }
                }

                // Transplant tasks
                const transplant = parseDate(p.Plan_Transplant);
                if (transplant && !p.Act_Transplant && (p.STATUS === 'Sown' || p.STATUS === 'In GH')) {
                    const task = {
                        id: `${p.Batch_ID}-transplant`,
                        type: 'transplant',
                        typeLabel: 'Transplant',
                        groupClass: 'transplant',
                        icon: 'fa-exchange-alt',
                        crop: p.Crop,
                        variety: p.Variety,
                        location: p.Target_Bed_ID || 'Unassigned',
                        quantity: `${p.Plants_Needed || '--'} plants`,
                        date: transplant,
                        batchId: p.Batch_ID,
                        taskType: 'transplant',
                        daysOverdue: Math.floor((today - transplant) / (1000 * 60 * 60 * 24))
                    };
                    if (transplant >= today && transplant < tomorrow) {
                        todaysTasks.push(task);
                    } else if (transplant < today) {
                        overdueTasks.push(task);
                    }
                }
            });

            // Sort by type order
            const typeOrder = { ghSow: 0, transplant: 1, fieldSow: 2 };
            todaysTasks.sort((a, b) => typeOrder[a.type] - typeOrder[b.type]);
            overdueTasks.sort((a, b) => b.daysOverdue - a.daysOverdue);

            // Render overdue tasks
            renderOverdueTasksMobile();

            // Show/hide action bar
            const actionBar = document.getElementById('mobileActionBar');
            if (actionBar) {
                actionBar.classList.toggle('visible', todaysTasks.length > 0);
            }

            // Render today's tasks
            const todayContainer = document.getElementById('todayTasks');
            if (todaysTasks.length === 0 && overdueTasks.length === 0) {
                todayContainer.innerHTML = `
                    <div class="all-done">
                        <i class="fas fa-trophy"></i>
                        <h3>All caught up!</h3>
                        <p>No tasks scheduled for today</p>
                    </div>
                `;
            } else if (todaysTasks.length === 0) {
                todayContainer.innerHTML = `
                    <div class="all-done">
                        <i class="fas fa-calendar-check"></i>
                        <h3>No tasks for today</h3>
                        <p>Clear your overdue tasks above</p>
                    </div>
                `;
            } else {
                // Group tasks by type
                const groups = {
                    ghSow: { title: 'Greenhouse Sowing', icon: 'fa-seedling', class: 'gh-sow', tasks: [] },
                    transplant: { title: 'Transplanting', icon: 'fa-exchange-alt', class: 'transplant', tasks: [] },
                    fieldSow: { title: 'Direct Seeding', icon: 'fa-tractor', class: 'direct-seed', tasks: [] }
                };

                todaysTasks.forEach(task => {
                    if (groups[task.type]) {
                        groups[task.type].tasks.push(task);
                    }
                });

                let html = '';
                for (const [type, group] of Object.entries(groups)) {
                    if (group.tasks.length === 0) continue;

                    html += `
                        <div class="task-group" data-type="${type}">
                            <div class="task-group-header">
                                <div class="task-group-icon ${group.class}">
                                    <i class="fas ${group.icon}"></i>
                                </div>
                                <span class="task-group-title">${group.title}</span>
                                <span class="task-group-count">${group.tasks.length}</span>
                            </div>
                            ${group.tasks.map(task => renderTaskCard(task)).join('')}
                        </div>
                    `;
                }
                todayContainer.innerHTML = html;
            }

            // Hide upcoming section on mobile for cleaner UX
            const upcomingHeader = document.getElementById('upcomingHeader');
            const upcomingContainer = document.getElementById('upcomingTasks');
            if (upcomingHeader) upcomingHeader.style.display = 'none';
            if (upcomingContainer) upcomingContainer.innerHTML = '';

            updateSelectionUI();
        }

        function renderTaskCard(task) {
            const isSelected = selectedTasks.has(task.id);
            return `
                <div class="task-card ${isSelected ? 'selected' : ''}"
                     data-task-id="${task.id}"
                     data-batch-id="${task.batchId}"
                     data-type="${task.taskType}">
                    <div class="task-card-inner">
                        <div class="task-checkbox-area" onclick="toggleTaskSelection('${task.id}')">
                            <div class="task-checkbox">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <div class="task-content" onclick="toggleTaskSelection('${task.id}')">
                            <div class="task-header">
                                <div class="task-crop">${task.crop}</div>
                                <div class="task-quantity-badge">${task.quantity}</div>
                            </div>
                            <div class="task-variety">${task.variety || 'Standard'}</div>
                            <div class="task-location">
                                <i class="fas fa-map-marker-alt"></i> ${task.location}
                            </div>
                        </div>
                        <div class="quick-complete-btn" onclick="completeTask('${task.batchId}', '${task.taskType}')">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleTaskSelection(taskId) {
            if (selectedTasks.has(taskId)) {
                selectedTasks.delete(taskId);
            } else {
                selectedTasks.add(taskId);
            }

            // Update visual state
            const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskEl) {
                taskEl.classList.toggle('selected', selectedTasks.has(taskId));
            }

            updateSelectionUI();
        }

        function toggleSelectAllMobile() {
            const allSelected = todaysTasks.every(t => selectedTasks.has(t.id));

            if (allSelected) {
                selectedTasks.clear();
            } else {
                todaysTasks.forEach(t => selectedTasks.add(t.id));
            }

            // Update all task cards
            todaysTasks.forEach(task => {
                const taskEl = document.querySelector(`[data-task-id="${task.id}"]`);
                if (taskEl) {
                    taskEl.classList.toggle('selected', selectedTasks.has(task.id));
                }
            });

            updateSelectionUI();
        }

        function updateSelectionUI() {
            const selectAllBtn = document.getElementById('mobileSelectAll');
            const completeBtn = document.getElementById('mobileCompleteBtn');
            const completeBtnText = document.getElementById('mobileCompleteBtnText');

            const selectedCount = selectedTasks.size;
            const allSelected = todaysTasks.length > 0 && todaysTasks.every(t => selectedTasks.has(t.id));

            if (selectAllBtn) {
                selectAllBtn.classList.toggle('active', allSelected);
                selectAllBtn.innerHTML = allSelected
                    ? '<i class="fas fa-check-square"></i> All'
                    : '<i class="far fa-square"></i> All';
            }

            if (completeBtn) {
                completeBtn.disabled = selectedCount === 0;
            }

            if (completeBtnText) {
                completeBtnText.textContent = selectedCount > 0
                    ? `Complete ${selectedCount} Task${selectedCount !== 1 ? 's' : ''}`
                    : 'Complete Selected';
            }
        }

        async function completeSelectedMobile() {
            if (selectedTasks.size === 0) return;

            const completeBtn = document.getElementById('mobileCompleteBtn');
            completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Completing...</span>';
            completeBtn.disabled = true;

            const tasksToComplete = Array.from(selectedTasks).map(id =>
                todaysTasks.find(t => t.id === id)
            ).filter(Boolean);

            // Store for undo
            lastCompletedTasks = tasksToComplete.map(t => ({...t}));

            let successCount = 0;

            for (const task of tasksToComplete) {
                try {
                    const params = new URLSearchParams({
                        action: 'updateTaskCompletion',
                        batchId: task.batchId,
                        taskType: task.taskType
                    });

                    const response = await fetch(`${API_URL}?${params}`);
                    const data = await response.json();

                    if (data.success) {
                        successCount++;
                        // Update local data
                        const planting = allPlantings.find(p => p.Batch_ID === task.batchId);
                        if (planting) {
                            const today = new Date().toISOString().split('T')[0];
                            if (task.taskType === 'ghSow') planting.Act_GH_Sow = today;
                            else if (task.taskType === 'fieldSow') planting.Act_Field_Sow = today;
                            else if (task.taskType === 'transplant') planting.Act_Transplant = today;
                        }
                    }
                } catch (error) {
                    console.error('Error completing task:', task.id, error);
                }
            }

            selectedTasks.clear();
            renderTasks();

            if (successCount > 0) {
                showUndoToast(`${successCount} task${successCount !== 1 ? 's' : ''} completed`);
            }

            completeBtn.innerHTML = '<i class="fas fa-check-double"></i> <span id="mobileCompleteBtnText">Complete Selected</span>';
        }

        async function completeTask(batchId, taskType) {
            const task = todaysTasks.find(t => t.batchId === batchId && t.taskType === taskType);
            const taskCard = document.querySelector(`[data-batch-id="${batchId}"][data-type="${taskType}"]`);
            const completeBtn = taskCard?.querySelector('.quick-complete-btn');

            if (completeBtn) {
                completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            try {
                const params = new URLSearchParams({
                    action: 'updateTaskCompletion',
                    batchId: batchId,
                    taskType: taskType
                });

                const response = await fetch(`${API_URL}?${params}`);
                const data = await response.json();

                if (data.success) {
                    // Store for undo
                    if (task) {
                        lastCompletedTasks = [{...task}];
                    }

                    // Update local data
                    const planting = allPlantings.find(p => p.Batch_ID === batchId);
                    if (planting) {
                        const today = new Date().toISOString().split('T')[0];
                        if (taskType === 'ghSow') planting.Act_GH_Sow = today;
                        else if (taskType === 'fieldSow') planting.Act_Field_Sow = today;
                        else if (taskType === 'transplant') planting.Act_Transplant = today;
                    }

                    if (completeBtn) {
                        completeBtn.innerHTML = '<i class="fas fa-check"></i>';
                        completeBtn.classList.add('completed');
                    }

                    selectedTasks.delete(task?.id);

                    // Short delay then refresh
                    setTimeout(() => {
                        renderTasks();
                        showUndoToast('Task completed');
                    }, 300);
                } else {
                    throw new Error(data.error || 'Update failed');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                if (completeBtn) {
                    completeBtn.innerHTML = '<i class="fas fa-check"></i>';
                }
                showToast('Error completing task', true);
            }
        }

        function showUndoToast(message) {
            const toast = document.getElementById('undoToast');
            const messageEl = document.getElementById('undoMessage');

            if (toast && messageEl) {
                messageEl.textContent = message;
                toast.classList.add('visible');

                if (undoTimeout) {
                    clearTimeout(undoTimeout);
                }

                undoTimeout = setTimeout(() => {
                    toast.classList.remove('visible');
                    lastCompletedTasks = [];
                }, 5000);
            }
        }

        async function undoLastCompletion() {
            const toast = document.getElementById('undoToast');
            toast.classList.remove('visible');

            if (lastCompletedTasks.length === 0) return;

            for (const task of lastCompletedTasks) {
                try {
                    let updateField = '';
                    if (task.taskType === 'ghSow') updateField = 'Act_GH_Sow';
                    else if (task.taskType === 'fieldSow') updateField = 'Act_Field_Sow';
                    else if (task.taskType === 'transplant') updateField = 'Act_Transplant';

                    const params = new URLSearchParams({
                        action: 'updatePlanting',
                        batchId: task.batchId,
                        [updateField]: ''
                    });

                    const response = await fetch(`${API_URL}?${params}`);
                    const result = await response.json();

                    if (result.success) {
                        // Restore planting data
                        const planting = allPlantings.find(p => p.Batch_ID === task.batchId);
                        if (planting) {
                            planting[updateField] = '';
                        }
                    }
                } catch (error) {
                    console.error('Error undoing task:', error);
                }
            }

            lastCompletedTasks = [];
            renderTasks();
            showToast('Undo successful');
        }

        // ========================================
        // OVERDUE TASKS - Mobile
        // ========================================
        function renderOverdueTasksMobile() {
            const section = document.getElementById('overdueSection');
            const listContainer = document.getElementById('overdueList');
            const badge = document.getElementById('overdueBadge');
            const actionBar = document.getElementById('overdueActionBar');

            if (overdueTasks.length === 0) {
                section.classList.remove('visible');
                if (actionBar) actionBar.classList.remove('visible');
                return;
            }

            section.classList.add('visible');
            badge.textContent = overdueTasks.length;

            // Show overdue action bar when there are overdue tasks
            if (actionBar) {
                actionBar.classList.add('visible');
            }

            listContainer.innerHTML = overdueTasks.map(task => {
                const isSelected = selectedOverdueTasks.has(task.id);
                const daysText = task.daysOverdue === 1 ? '1 day' : `${task.daysOverdue}d`;

                return `
                    <div class="overdue-card ${isSelected ? 'selected' : ''}"
                         data-task-id="${task.id}"
                         data-batch-id="${task.batchId}"
                         data-type="${task.taskType}">
                        <div class="overdue-card-inner">
                            <div class="overdue-checkbox-area" onclick="toggleOverdueSelectionMobile('${task.id}')">
                                <div class="overdue-checkbox">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            <div class="overdue-card-content" onclick="toggleOverdueSelectionMobile('${task.id}')">
                                <div class="overdue-card-header">
                                    <span class="overdue-crop-name">${task.crop}</span>
                                    <span class="overdue-days">${daysText}</span>
                                </div>
                                <div class="overdue-card-details">
                                    <span>${task.typeLabel}</span>
                                    <span>${task.quantity}</span>
                                </div>
                            </div>
                            <div class="overdue-complete-btn" onclick="completeOverdueTaskMobile('${task.batchId}', '${task.taskType}', event)">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateOverdueSelectionUIMobile();
        }

        function toggleOverdueSelectionMobile(taskId) {
            if (selectedOverdueTasks.has(taskId)) {
                selectedOverdueTasks.delete(taskId);
            } else {
                selectedOverdueTasks.add(taskId);
            }

            const taskEl = document.querySelector(`.overdue-card[data-task-id="${taskId}"]`);
            if (taskEl) {
                taskEl.classList.toggle('selected', selectedOverdueTasks.has(taskId));
            }

            updateOverdueSelectionUIMobile();
        }

        function toggleOverdueSelectAllMobile() {
            const allSelected = overdueTasks.every(t => selectedOverdueTasks.has(t.id));

            if (allSelected) {
                selectedOverdueTasks.clear();
            } else {
                overdueTasks.forEach(t => selectedOverdueTasks.add(t.id));
            }

            renderOverdueTasksMobile();
        }

        function updateOverdueSelectionUIMobile() {
            const selectAllBtn = document.getElementById('overdueSelectAllMobile');
            const completeBtn = document.getElementById('overdueCompleteAllBtn');
            const completeBtnText = document.getElementById('overdueCompleteBtnText');

            const selectedCount = selectedOverdueTasks.size;
            const allSelected = overdueTasks.length > 0 && overdueTasks.every(t => selectedOverdueTasks.has(t.id));

            if (selectAllBtn) {
                selectAllBtn.classList.toggle('active', allSelected);
                selectAllBtn.innerHTML = allSelected
                    ? '<i class="fas fa-check-square"></i> All'
                    : '<i class="far fa-square"></i> All';
            }

            if (completeBtn) {
                completeBtn.disabled = selectedCount === 0;
            }

            if (completeBtnText) {
                completeBtnText.textContent = selectedCount > 0
                    ? `Complete ${selectedCount}`
                    : 'Complete Selected';
            }
        }

        async function completeSelectedOverdueMobile() {
            if (selectedOverdueTasks.size === 0) return;

            const completeBtn = document.getElementById('overdueCompleteAllBtn');
            completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Completing...</span>';
            completeBtn.disabled = true;

            const tasksToComplete = Array.from(selectedOverdueTasks).map(id =>
                overdueTasks.find(t => t.id === id)
            ).filter(Boolean);

            lastCompletedTasks = tasksToComplete.map(t => ({...t}));

            let successCount = 0;
            const today = new Date().toISOString().split('T')[0];

            for (const task of tasksToComplete) {
                try {
                    let updateField = '';
                    if (task.taskType === 'ghSow') updateField = 'Act_GH_Sow';
                    else if (task.taskType === 'fieldSow') updateField = 'Act_Field_Sow';
                    else if (task.taskType === 'transplant') updateField = 'Act_Transplant';

                    const params = new URLSearchParams({
                        action: 'updatePlanting',
                        batchId: task.batchId,
                        [updateField]: today
                    });

                    const response = await fetch(`${API_URL}?${params}`);
                    const result = await response.json();

                    if (result.success) {
                        successCount++;
                        const planting = allPlantings.find(p => p.Batch_ID === task.batchId);
                        if (planting) {
                            planting[updateField] = today;
                        }
                    }
                } catch (error) {
                    console.error('Error completing overdue task:', error);
                }
            }

            selectedOverdueTasks.clear();
            renderTasks();

            if (successCount > 0) {
                showUndoToast(`${successCount} overdue completed`);
            }

            completeBtn.innerHTML = '<i class="fas fa-check-double"></i> <span id="overdueCompleteBtnText">Complete Selected</span>';
        }

        async function completeOverdueTaskMobile(batchId, taskType, event) {
            if (event) event.stopPropagation();

            const taskCard = document.querySelector(`.overdue-card[data-batch-id="${batchId}"][data-type="${taskType}"]`);
            const btn = taskCard?.querySelector('.overdue-complete-btn');

            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            try {
                let updateField = '';
                if (taskType === 'ghSow') updateField = 'Act_GH_Sow';
                else if (taskType === 'fieldSow') updateField = 'Act_Field_Sow';
                else if (taskType === 'transplant') updateField = 'Act_Transplant';

                const today = new Date().toISOString().split('T')[0];

                const params = new URLSearchParams({
                    action: 'updatePlanting',
                    batchId: batchId,
                    [updateField]: today
                });

                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();

                if (result.success) {
                    const task = overdueTasks.find(t => t.batchId === batchId && t.taskType === taskType);
                    if (task) {
                        lastCompletedTasks = [{...task}];
                    }

                    const planting = allPlantings.find(p => p.Batch_ID === batchId);
                    if (planting) {
                        planting[updateField] = today;
                    }

                    selectedOverdueTasks.delete(`${batchId}-${taskType}`);
                    renderTasks();
                    showUndoToast('Overdue task done');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error completing overdue task:', error);
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                }
                showToast('Error completing task', true);
            }
        }

        // ========================================
        // HARVESTS
        // ========================================
        function populateHarvestCrops() {
            const select = document.getElementById('harvestCrop');
            const activePlantings = allPlantings.filter(p =>
                ['PLANTED', 'HARVESTING', 'Growing'].includes(p.STATUS)
            );

            const cropOptions = activePlantings.map(p => ({
                value: p.Batch_ID,
                label: `${p.Crop} - ${p.Variety || 'Standard'} (${p.Target_Bed_ID || 'Field'})`
            }));

            select.innerHTML = '<option value="">Select crop...</option>' +
                cropOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
        }

        function setQuality(grade) {
            harvestQuality = grade;
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.grade === grade);
            });
        }

        async function submitHarvest() {
            const crop = document.getElementById('harvestCrop').value;
            const qty = document.getElementById('harvestQty').value;
            const unit = document.getElementById('harvestUnit').value;
            const notes = document.getElementById('harvestNotes').value;

            if (!crop || !qty) {
                showToast('Please select crop and enter quantity', true);
                return;
            }

            const planting = allPlantings.find(p => p.Batch_ID === crop);
            if (!planting) {
                showToast('Planting not found', true);
                return;
            }

            try {
                const params = new URLSearchParams({
                    action: 'logHarvest',
                    crop: planting.Crop,
                    variety: planting.Variety || '',
                    bed: planting.Target_Bed_ID || '',
                    quantity: qty,
                    unit: unit,
                    quality: harvestQuality,
                    notes: notes,
                    batchId: crop
                });

                const response = await fetch(`${API_URL}?${params}`);
                const data = await response.json();

                if (data.success) {
                    showToast('Harvest logged!');
                    // Clear form
                    document.getElementById('harvestCrop').value = '';
                    document.getElementById('harvestQty').value = '';
                    document.getElementById('harvestNotes').value = '';
                    setQuality('A');

                    // Update recent harvests display
                    addRecentHarvest(planting.Crop, qty, unit);
                } else {
                    throw new Error(data.error || 'Log failed');
                }
            } catch (error) {
                console.error('Error logging harvest:', error);
                showToast('Error logging harvest', true);
            }
        }

        function addRecentHarvest(crop, qty, unit) {
            const container = document.getElementById('recentHarvests');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            // Remove empty state if present
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const item = document.createElement('div');
            item.className = 'recent-harvest';
            item.innerHTML = `
                <div class="info">${crop} - ${qty} ${unit}</div>
                <div class="time">${timeStr}</div>
            `;
            container.insertBefore(item, container.firstChild);
        }

        // ========================================
        // SCHEDULE
        // ========================================
        function renderSchedule() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            // Group plantings by date
            const scheduleByDate = {};

            allPlantings.forEach(p => {
                // Check various dates
                const dates = [
                    { date: parseDate(p.Plan_GH_Sow), type: 'sow', label: 'GH Sow' },
                    { date: parseDate(p.Plan_Field_Sow), type: 'sow', label: 'Direct Sow' },
                    { date: parseDate(p.Plan_Transplant), type: 'transplant', label: 'Transplant' },
                    { date: parseDate(p.First_Harvest), type: 'harvest', label: 'Harvest Ready' }
                ];

                dates.forEach(d => {
                    if (d.date && d.date >= today && d.date <= nextWeek) {
                        const dateKey = d.date.toISOString().split('T')[0];
                        if (!scheduleByDate[dateKey]) {
                            scheduleByDate[dateKey] = {
                                date: d.date,
                                items: []
                            };
                        }
                        scheduleByDate[dateKey].items.push({
                            type: d.type,
                            label: d.label,
                            crop: p.Crop,
                            variety: p.Variety,
                            location: p.Target_Bed_ID || 'Unassigned'
                        });
                    }
                });
            });

            // Sort dates
            const sortedDates = Object.keys(scheduleByDate).sort();

            const container = document.getElementById('scheduleList');

            if (sortedDates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-check"></i>
                        <h3>Nothing scheduled</h3>
                        <p>No activities planned for this week</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sortedDates.map(dateKey => {
                const day = scheduleByDate[dateKey];
                const isToday = dateKey === today.toISOString().split('T')[0];
                const dayName = isToday ? 'Today' : day.date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = day.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                return `
                    <div class="schedule-day">
                        <div class="schedule-day-header">
                            <span>${dayName}</span>
                            <span class="date">${dateStr}</span>
                        </div>
                        ${day.items.map(item => `
                            <div class="schedule-item">
                                <div class="schedule-icon ${item.type}">
                                    <i class="fas ${item.type === 'sow' ? 'fa-seedling' : item.type === 'transplant' ? 'fa-arrow-right' : 'fa-basket-shopping'}"></i>
                                </div>
                                <div class="schedule-info">
                                    <div class="crop">${item.label}: ${item.crop}</div>
                                    <div class="details">${item.variety || 'Standard'} - ${item.location}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // UTILITIES
        // ========================================
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function formatDateShort(date) {
            if (!date) return '--';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            document.getElementById('toastMessage').textContent = message;

            toast.className = isError ? 'toast error' : 'toast';
            icon.className = isError ? 'fas fa-times-circle' : 'fas fa-check-circle';

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
