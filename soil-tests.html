<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Test Tracker - Tiny Seed OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
        }

        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: white;
            color: #7c3aed;
        }

        .btn-primary:hover {
            background: #f1f5f9;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #7c3aed;
            background: #f5f3ff;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .tab {
            padding: 0.625rem 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
            white-space: nowrap;
            font-size: 0.875rem;
        }

        .tab:hover {
            color: #7c3aed;
            background: #f8f5ff;
        }

        .tab.active {
            color: #7c3aed;
            background: #f5f3ff;
            border-bottom: 2px solid #7c3aed;
            margin-bottom: -2px;
        }

        @media (max-width: 768px) {
            .tabs {
                gap: 0.125rem;
            }
            .tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
        }

        /* Soil Test Cards */
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .test-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .test-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .test-card-header {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: white;
            padding: 1rem 1.25rem;
        }

        .test-card-header h3 {
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .test-card-header .date {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .test-card-body {
            padding: 1.25rem;
        }

        .test-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .test-stat {
            text-align: center;
        }

        .test-stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .test-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
        }

        /* Base Saturation Bar */
        .base-sat-bar {
            height: 24px;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .base-sat-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            font-weight: 600;
            color: white;
        }

        .base-sat-ca { background: #3b82f6; }
        .base-sat-mg { background: #10b981; }
        .base-sat-k { background: #f59e0b; }
        .base-sat-na { background: #ef4444; }
        .base-sat-h { background: #6b7280; }

        /* Detail Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 1rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .modal-header h2 {
            font-size: 1.25rem;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Data Entry Form */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #7c3aed;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .form-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
        }

        .form-group input, .form-group select {
            padding: 0.625rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        /* Ideal Ranges Table */
        .ranges-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .ranges-table th, .ranges-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .ranges-table th {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-low { background: #ef4444; }
        .status-optimal { background: #10b981; }
        .status-high { background: #f59e0b; }

        /* Compare View */
        .compare-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .compare-column {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .compare-header {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e293b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1001;
        }

        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
        .toast.show { display: block; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Parsing Preview */
        .parse-preview {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .parse-preview h4 {
            margin-bottom: 1rem;
            color: #7c3aed;
        }

        .parse-sample {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .parse-sample h5 {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            color: #1e293b;
        }
    </style>
</head>
<body>
    <header class="header">
        <div>
            <h1>
                <span>ðŸ§ª</span>
                Soil Test Tracker
            </h1>
            <p style="font-size: 0.75rem; opacity: 0.85; margin-top: 0.25rem;">Farm Learning System - Building 40 Years of Knowledge</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="showManualEntry()">+ Manual Entry</button>
            <button class="btn btn-primary" onclick="window.location.href='index.html'">Dashboard</button>
        </div>
    </header>

    <main class="main-content">
        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="pdfInput" accept=".pdf" />
                <div class="upload-icon">ðŸ“„</div>
                <p class="upload-text">Drop Logan Labs PDF here or click to upload</p>
                <p class="upload-hint">We'll automatically extract the soil test data</p>
            </div>
            <div id="parsePreview" style="display: none;"></div>
        </section>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="current" onclick="switchTab('current')">Current Tests</div>
            <div class="tab" data-tab="tissueTests" onclick="switchTab('tissueTests')">Tissue Tests</div>
            <div class="tab" data-tab="archived" onclick="switchTab('archived')">Archived</div>
            <div class="tab" data-tab="compare" onclick="switchTab('compare')">Compare</div>
            <div class="tab" data-tab="amendments" onclick="switchTab('amendments')">Amendment Calculator</div>
            <div class="tab" data-tab="plantDoctor" onclick="switchTab('plantDoctor')">Plant Doctor</div>
            <div class="tab" data-tab="database" onclick="switchTab('database')">Amendments Database</div>
            <div class="tab" data-tab="fieldZones" onclick="switchTab('fieldZones')">Field Zones</div>
            <div class="tab" data-tab="compliance" onclick="switchTab('compliance')">USDA Organic</div>
            <div class="tab" data-tab="history" onclick="switchTab('history')">Amendment History</div>
            <div class="tab" data-tab="foliarProgram" onclick="switchTab('foliarProgram')">Foliar Program</div>
            <div class="tab" data-tab="fertigation" onclick="switchTab('fertigation')">Fertigation</div>
            <div class="tab" data-tab="ipmToolkit" onclick="switchTab('ipmToolkit')">IPM Toolkit</div>
            <div class="tab" data-tab="insights" onclick="switchTab('insights')">Farm Insights</div>
            <div class="tab" data-tab="inventory" onclick="switchTab('inventory')">Inventory</div>
        </div>

        <!-- Tests Grid -->
        <div id="testsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading soil tests...</p>
            </div>
        </div>
    </main>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Soil Test Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div class="modal-overlay" id="entryModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Add Soil Test</h2>
                <button class="modal-close" onclick="closeEntryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="soilTestForm" onsubmit="saveSoilTest(event)">
                    <!-- Basic Info -->
                    <div class="form-section">
                        <h3>Sample Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Sample Location / Field</label>
                                <select id="sampleLocation" required>
                                    <option value="">-- Select Field --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Test Date</label>
                                <input type="date" id="testDate" required>
                            </div>
                            <div class="form-group">
                                <label>Lab Number</label>
                                <input type="text" id="labNumber" placeholder="e.g., 77">
                            </div>
                            <div class="form-group">
                                <label>Sample Depth (inches)</label>
                                <input type="number" id="sampleDepth" value="6" step="1">
                            </div>
                        </div>
                    </div>

                    <!-- Basic Soil Properties -->
                    <div class="form-section">
                        <h3>Basic Properties</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>pH</label>
                                <input type="number" id="ph" step="0.1" min="0" max="14" required>
                            </div>
                            <div class="form-group">
                                <label>CEC / TEC (M.E.)</label>
                                <input type="number" id="cec" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Organic Matter (%)</label>
                                <input type="number" id="organicMatter" step="0.01" min="0" max="100">
                            </div>
                        </div>
                    </div>

                    <!-- Anions -->
                    <div class="form-section">
                        <h3>Anions</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Sulfur (ppm)</label>
                                <input type="number" id="sulfur" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Phosphorus P2O5 (lbs/acre)</label>
                                <input type="number" id="phosphorus" step="1" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Exchangeable Cations -->
                    <div class="form-section">
                        <h3>Exchangeable Cations (lbs/acre)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Calcium - Desired</label>
                                <input type="number" id="caDesired" step="1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Calcium - Found</label>
                                <input type="number" id="caFound" step="1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Magnesium - Desired</label>
                                <input type="number" id="mgDesired" step="1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Magnesium - Found</label>
                                <input type="number" id="mgFound" step="1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Potassium - Desired</label>
                                <input type="number" id="kDesired" step="1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Potassium - Found</label>
                                <input type="number" id="kFound" step="1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Sodium (lbs/acre)</label>
                                <input type="number" id="sodium" step="1" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Base Saturation -->
                    <div class="form-section">
                        <h3>Base Saturation (%)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Calcium % (ideal 60-70%)</label>
                                <input type="number" id="caPct" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Magnesium % (ideal 10-20%)</label>
                                <input type="number" id="mgPct" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Potassium % (ideal 2-5%)</label>
                                <input type="number" id="kPct" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Sodium % (ideal 0.5-3%)</label>
                                <input type="number" id="naPct" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Other Bases %</label>
                                <input type="number" id="otherPct" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Hydrogen % (ideal 10-15%)</label>
                                <input type="number" id="hPct" step="0.01" min="0" max="100">
                            </div>
                        </div>
                    </div>

                    <!-- Trace Elements -->
                    <div class="form-section">
                        <h3>Trace Elements (ppm)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Boron</label>
                                <input type="number" id="boron" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Iron</label>
                                <input type="number" id="iron" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Manganese</label>
                                <input type="number" id="manganese" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Copper</label>
                                <input type="number" id="copper" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Zinc</label>
                                <input type="number" id="zinc" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Aluminum</label>
                                <input type="number" id="aluminum" step="1" min="0">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeEntryModal()" style="color: #64748b;">Cancel</button>
                        <button type="submit" class="btn btn-success">Save Soil Test</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbxmiizjT_T2KI6ZZqAgDt49-8AvTPmq3penl4gSO2qPETMHVFtm0i90C47zGkwJ92vb/exec';

        // ============================================
        // BACKEND SYNC HELPERS
        // Sync data to Google Sheets with localStorage fallback
        // ============================================

        /**
         * Sync data to backend API with localStorage fallback
         * @param {string} action - The API action to call
         * @param {object} data - The data to send
         * @returns {Promise<object>} - Response from API or localStorage confirmation
         */
        async function syncToBackend(action, data) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, ...data }),
                    redirect: 'follow'
                });
                const text = await response.text();
                try {
                    const result = JSON.parse(text);
                    if (result.success) {
                        return result;
                    }
                    throw new Error(result.error || 'API error');
                } catch (parseErr) {
                    console.warn('Response parse error:', text.substring(0, 200));
                    throw new Error('Invalid response from server');
                }
            } catch (e) {
                console.warn('API sync failed, using localStorage:', e.message);
                return { success: false, error: e.message, offline: true };
            }
        }

        /**
         * Load data from backend API with localStorage fallback
         * @param {string} action - The API action to call
         * @param {object} params - Query parameters
         * @returns {Promise<object>} - Data from API or localStorage
         */
        async function loadFromBackend(action, params = {}) {
            try {
                const queryString = new URLSearchParams({ action, ...params }).toString();
                const response = await fetch(`${API_URL}?${queryString}`);
                const result = await response.json();
                if (result.success) {
                    return result;
                }
                throw new Error(result.error || 'API error');
            } catch (e) {
                console.warn('API load failed:', e.message);
                return { success: false, error: e.message, offline: true };
            }
        }

        /**
         * Initialize soil data from backend on page load
         */
        async function initializeSoilData() {
            try {
                // Load compliance records
                const complianceResult = await loadFromBackend('getComplianceRecords');
                if (complianceResult.success && complianceResult.data.length > 0) {
                    localStorage.setItem('complianceRecords', JSON.stringify(complianceResult.data));
                }

                // Load IPM schedules
                const ipmResult = await loadFromBackend('getIPMSchedules');
                if (ipmResult.success && ipmResult.data.length > 0) {
                    localStorage.setItem('mandatoryIPMSchedules', JSON.stringify(ipmResult.data));
                }

                // Load fertigation data
                const fertResult = await loadFromBackend('getFertigationData');
                if (fertResult.success) {
                    if (fertResult.data.schedules && fertResult.data.schedules.length > 0) {
                        localStorage.setItem('fertigationSchedules', JSON.stringify(fertResult.data.schedules));
                    }
                    if (fertResult.data.logs && fertResult.data.logs.length > 0) {
                        localStorage.setItem('fertigationLogs', JSON.stringify(fertResult.data.logs));
                    }
                }

                // Load foliar applications
                const foliarResult = await loadFromBackend('getFoliarApplications');
                if (foliarResult.success && foliarResult.data.length > 0) {
                    localStorage.setItem('foliarTasks', JSON.stringify(foliarResult.data));
                }

                // Load soil amendments
                const amendResult = await loadFromBackend('getSoilAmendments');
                if (amendResult.success && amendResult.data.length > 0) {
                    localStorage.setItem('plannedAmendments', JSON.stringify(amendResult.data));
                }

                console.info('Soil data initialized from backend');
            } catch (e) {
                console.warn('Could not initialize from backend, using localStorage:', e.message);
            }
        }

        // Initialize data on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeSoilData();
        });

        // ============================================
        // FARM FIELDS - Loaded from API or fallback
        // Source: 2026 Farm Records - REF_Fields
        // Total Acreage: 7.6 acres
        // ============================================
        let FARM_FIELDS = {}; // Will be populated from API

        // Fallback field data if API fails
        const FALLBACK_FIELDS = {
            // Vegetable Production Fields
            'Field F3L': { acreage: 0.51, lengthFt: 400, widthFt: 55, beds: 12, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field HOL': { acreage: 0.62, lengthFt: 540, widthFt: 50, beds: 12, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field IL': { acreage: 0.31, lengthFt: 300, widthFt: 45, beds: 11, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field IOL': { acreage: 0.37, lengthFt: 400, widthFt: 40, beds: 8, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: 'Need to measure' },
            'Field JL': { acreage: 0.42, lengthFt: 460, widthFt: 40, beds: 10, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field JS1': { acreage: 0.53, lengthFt: 320, widthFt: 72, beds: 15, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field JS10': { acreage: 0.40, lengthFt: 350, widthFt: 50, beds: 14, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: 'Need to Measure' },
            'Field JS4': { acreage: 0.28, lengthFt: 300, widthFt: 40, beds: 10, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field JS6': { acreage: 0.37, lengthFt: 360, widthFt: 45, beds: 10, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field M': { acreage: 0.48, lengthFt: 300, widthFt: 70, beds: 14, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field SO': { acreage: 0.51, lengthFt: 400, widthFt: 55, beds: 12, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Field Z3': { acreage: 0.72, lengthFt: 520, widthFt: 60, beds: 15, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: 'Need to measure' },
            'Field Z5': { acreage: 0.21, lengthFt: 300, widthFt: 30, beds: 6, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: 'Need to measure' },
            'Kretschmann Greenhouse': { acreage: 0.05, lengthFt: 100, widthFt: 20, beds: 4, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },
            'Rosemary House': { acreage: 0.03, lengthFt: 100, widthFt: 12, beds: 2, bedWidthIn: 45, pathWidthIn: 12, production: 'vegetable', notes: '' },

            // Floral Production Fields
            'Field B': { acreage: 0.06, lengthFt: 140, widthFt: 20, beds: 4, bedWidthIn: 45, pathWidthIn: 12, production: 'floral', notes: '' },
            'Field F11M': { acreage: 0.28, lengthFt: 240, widthFt: 50, beds: 10, bedWidthIn: 45, pathWidthIn: 12, production: 'floral', notes: '' },
            'Field F7M': { acreage: 0.26, lengthFt: 250, widthFt: 45, beds: 10, bedWidthIn: 45, pathWidthIn: 12, production: 'floral', notes: '' },

            // Perennial Production Fields
            'Field K1': { acreage: 0.10, lengthFt: 150, widthFt: 30, beds: 6, bedWidthIn: 45, pathWidthIn: 12, production: 'perennial', notes: 'Need to measure; Perennial' },
            'Field K2': { acreage: 0.08, lengthFt: 120, widthFt: 30, beds: 6, bedWidthIn: 45, pathWidthIn: 12, production: 'perennial', notes: 'Need to measure; Perennial' },

            // Non-Production Fields (available for rotation)
            'Field CL': { acreage: 0.28, lengthFt: 300, widthFt: 40, beds: 8, bedWidthIn: 45, pathWidthIn: 12, production: 'fallow', notes: '' },
            'Field F3M': { acreage: 0.28, lengthFt: 300, widthFt: 40, beds: 8, bedWidthIn: 45, pathWidthIn: 12, production: 'fallow', notes: '' },
            'Field JS3': { acreage: 0.38, lengthFt: 300, widthFt: 55, beds: 11, bedWidthIn: 45, pathWidthIn: 12, production: 'fallow', notes: '' },
            'Seedling House': { acreage: 0.07, lengthFt: 100, widthFt: 30, beds: 6, bedWidthIn: 45, pathWidthIn: 12, production: 'seedling', notes: '' }
        };

        // Load fields from API
        async function loadFieldsFromAPI() {
            try {
                const response = await fetch(`${API_URL}?action=getFields`);
                const data = await response.json();

                if (data.success && data.fields && data.fields.length > 0) {
                    FARM_FIELDS = {};
                    data.fields.forEach(f => {
                        // Determine production type
                        let production = 'fallow';
                        if (f.inVegProduction) production = 'vegetable';
                        else if (f.inFloralProduction) production = 'floral';
                        else if (f.inPerennialProduction) production = 'perennial';
                        else if (f.inCoverCrop) production = 'cover';

                        FARM_FIELDS[f.fieldName] = {
                            acreage: f.acreage,
                            lengthFt: f.length,
                            widthFt: f.width,
                            beds: f.numberOfBeds,
                            bedWidthIn: f.bedWidth,
                            pathWidthIn: f.pathWidth,
                            production: production,
                            notes: f.notes || ''
                        };
                    });
                    console.log(`Loaded ${data.fields.length} fields from API`);
                    return true;
                }
            } catch (error) {
                console.warn('Could not load fields from API:', error);
            }
            return false;
        }

        // Initialize FARM_FIELDS with fallback
        async function initializeFarmFields() {
            const loaded = await loadFieldsFromAPI();
            if (!loaded) {
                console.log('Using fallback field data');
                FARM_FIELDS = { ...FALLBACK_FIELDS };
            }
            populateSampleLocationDropdown();
        }

        // Helper to get field acreage
        function getFieldAcreage(fieldName) {
            const field = FARM_FIELDS[fieldName];
            return field ? field.acreage : null;
        }

        // Get fields by production type
        function getFieldsByProduction(productionType) {
            return Object.entries(FARM_FIELDS)
                .filter(([name, data]) => data.production === productionType)
                .map(([name, data]) => ({ name, ...data }));
        }

        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // State
        let soilTests = [];
        let currentTab = 'current';
        let selectedForCompare = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFarmFields();  // Load fields from API first
            loadSoilTests();
            setupUploadZone();
            document.getElementById('testDate').valueAsDate = new Date();
        });

        // Populate sample location dropdown from FARM_FIELDS
        function populateSampleLocationDropdown() {
            const select = document.getElementById('sampleLocation');
            if (!select) return;

            select.innerHTML = '<option value="">-- Select Field --</option>' +
                Object.keys(FARM_FIELDS).map(f =>
                    `<option value="${f}">${f} (${FARM_FIELDS[f].acreage} ac)</option>`
                ).join('');
        }

        // Upload Zone Setup
        function setupUploadZone() {
            const zone = document.getElementById('uploadZone');
            const input = document.getElementById('pdfInput');

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    parsePDF(file);
                }
            });

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    parsePDF(file);
                }
            });
        }

        // Parse Logan Labs PDF
        async function parsePDF(file) {
            showToast('Parsing PDF...', 'info');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();

                // Extract all text items with positions
                const items = textContent.items.map(item => ({
                    text: item.str.trim(),
                    x: Math.round(item.transform[4]),
                    y: Math.round(item.transform[5])
                })).filter(item => item.text);

                // Parse Logan Labs format
                const samples = parseLoganLabsFormat(items);

                if (samples.length > 0) {
                    showParsePreview(samples);
                    showToast(`Found ${samples.length} sample(s) in PDF`, 'success');
                } else {
                    showToast('Could not parse PDF. Try manual entry.', 'error');
                }
            } catch (error) {
                console.error('PDF parsing error:', error);
                showToast('Error parsing PDF. Try manual entry.', 'error');
            }
        }

        function parseLoganLabsFormat(items) {
            const samples = [];

            // Group items by approximate Y position (rows)
            const rows = {};
            items.forEach(item => {
                const rowKey = Math.round(item.y / 10) * 10;
                if (!rows[rowKey]) rows[rowKey] = [];
                rows[rowKey].push(item);
            });

            // Sort rows by Y (top to bottom)
            const sortedRows = Object.entries(rows)
                .sort((a, b) => b[0] - a[0])
                .map(([y, items]) => items.sort((a, b) => a.x - b.x));

            // Find sample location row and extract column positions
            let sampleLocations = [];
            let columnXPositions = [];

            for (const row of sortedRows) {
                const rowText = row.map(r => r.text).join(' ');
                if (rowText.includes('Sample Location') || rowText.includes('KRET') || rowText.includes('Field')) {
                    // This row has sample locations
                    sampleLocations = row.filter(r =>
                        r.text !== 'Sample Location' &&
                        r.text.length > 0 &&
                        !r.text.includes('Sample')
                    );
                    columnXPositions = sampleLocations.map(s => s.x);
                    break;
                }
            }

            // If no clear sample locations found, try to detect column structure
            if (sampleLocations.length === 0) {
                // Look for patterns like KRET-O, Field 1, etc.
                for (const row of sortedRows) {
                    for (const item of row) {
                        if (item.text.match(/^[A-Z]{2,}-[A-Z0-9]+$/) ||
                            item.text.match(/^Field\s*\d+$/i)) {
                            sampleLocations.push(item);
                            columnXPositions.push(item.x);
                        }
                    }
                    if (sampleLocations.length > 0) break;
                }
            }

            // Extract date
            let testDate = new Date().toISOString().split('T')[0];
            for (const row of sortedRows) {
                const rowText = row.map(r => r.text).join(' ');
                const dateMatch = rowText.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                if (dateMatch) {
                    const parts = dateMatch[1].split('/');
                    testDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                    break;
                }
            }

            // Helper to find value by label
            function findValue(label, colIndex) {
                for (const row of sortedRows) {
                    const rowText = row.map(r => r.text.toLowerCase()).join(' ');
                    if (rowText.includes(label.toLowerCase())) {
                        // Find numeric values in this row that match column position
                        const values = row.filter(r => !isNaN(parseFloat(r.text.replace(/,/g, ''))));
                        if (values.length > colIndex) {
                            // Sort by x position and get the right column
                            values.sort((a, b) => a.x - b.x);
                            if (values[colIndex]) {
                                return parseFloat(values[colIndex].text.replace(/,/g, ''));
                            }
                        }
                    }
                }
                return null;
            }

            // Helper to find values near a label
            function findValuesInRow(labelPatterns, colIndex) {
                for (const row of sortedRows) {
                    const rowText = row.map(r => r.text.toLowerCase()).join(' ');
                    const matches = labelPatterns.some(p => rowText.includes(p.toLowerCase()));
                    if (matches) {
                        const values = row.filter(r => {
                            const num = parseFloat(r.text.replace(/,/g, ''));
                            return !isNaN(num);
                        }).sort((a, b) => a.x - b.x);

                        if (values.length > colIndex) {
                            return parseFloat(values[colIndex].text.replace(/,/g, ''));
                        }
                    }
                }
                return null;
            }

            // Create sample objects
            sampleLocations.forEach((loc, idx) => {
                const sample = {
                    sampleLocation: loc.text,
                    testDate: testDate,
                    labNumber: findValuesInRow(['Lab Number'], idx),
                    sampleDepth: findValuesInRow(['Sample Depth', 'Depth'], idx) || 6,
                    ph: findValuesInRow(['pH of Soil', 'pH'], idx),
                    cec: findValuesInRow(['Total Exchange Capacity', 'TEC', 'M.E.', 'M. E.'], idx),
                    organicMatter: findValuesInRow(['Organic Matter'], idx),
                    sulfur: findValuesInRow(['SULFUR', 'Sulfur'], idx),
                    phosphorus: findValuesInRow(['Phosphorous', 'Phosphorus', 'P2O5'], idx),
                    caDesired: null,
                    caFound: null,
                    mgDesired: null,
                    mgFound: null,
                    kDesired: null,
                    kFound: null,
                    sodium: findValuesInRow(['SODIUM', 'Sodium'], idx),
                    caPct: findValuesInRow(['Calcium (60', 'Calcium%', '60 to 70'], idx),
                    mgPct: findValuesInRow(['Magnesium (10', 'Magnesium%', '10 to 20'], idx),
                    kPct: findValuesInRow(['Potassium (2', 'Potassium%', '2 to 5'], idx),
                    naPct: findValuesInRow(['Sodium (.5', 'Sodium%', '.5 to 3'], idx),
                    otherPct: findValuesInRow(['Other Bases'], idx),
                    hPct: findValuesInRow(['Exchangable Hydrogen', 'Hydrogen', '10 to 15'], idx),
                    boron: findValuesInRow(['Boron'], idx),
                    iron: findValuesInRow(['Iron'], idx),
                    manganese: findValuesInRow(['Manganese'], idx),
                    copper: findValuesInRow(['Copper'], idx),
                    zinc: findValuesInRow(['Zinc'], idx),
                    aluminum: findValuesInRow(['Aluminum'], idx)
                };

                // Try to extract Ca/Mg/K desired/found values
                // These are trickier due to multi-row layout
                let caRows = [];
                let mgRows = [];
                let kRows = [];
                let inCa = false, inMg = false, inK = false;

                for (const row of sortedRows) {
                    const rowText = row.map(r => r.text).join(' ').toUpperCase();
                    if (rowText.includes('CALCIUM')) inCa = true;
                    if (rowText.includes('MAGNESIUM')) { inCa = false; inMg = true; }
                    if (rowText.includes('POTASSIUM')) { inMg = false; inK = true; }
                    if (rowText.includes('SODIUM') && !rowText.includes('%')) { inK = false; }

                    const hasDesired = rowText.includes('DESIRED');
                    const hasFound = rowText.includes('VALUE FOUND') || rowText.includes('FOUND');

                    if (hasDesired || hasFound) {
                        const values = row.filter(r => !isNaN(parseFloat(r.text.replace(/,/g, ''))))
                            .sort((a, b) => a.x - b.x);

                        if (values.length > idx) {
                            const val = parseFloat(values[idx].text.replace(/,/g, ''));
                            if (inCa) {
                                if (hasDesired) sample.caDesired = val;
                                if (hasFound) sample.caFound = val;
                            } else if (inMg) {
                                if (hasDesired) sample.mgDesired = val;
                                if (hasFound) sample.mgFound = val;
                            } else if (inK) {
                                if (hasDesired) sample.kDesired = val;
                                if (hasFound) sample.kFound = val;
                            }
                        }
                    }
                }

                samples.push(sample);
            });

            return samples;
        }

        function showParsePreview(samples) {
            const preview = document.getElementById('parsePreview');

            let html = `
                <div class="parse-preview">
                    <h4>Parsed ${samples.length} Sample(s) from PDF</h4>
            `;

            samples.forEach((sample, idx) => {
                html += `
                    <div class="parse-sample">
                        <h5>${sample.sampleLocation} - ${sample.testDate}</h5>
                        <div class="form-grid" style="font-size: 0.875rem;">
                            <div><strong>pH:</strong> ${sample.ph || 'N/A'}</div>
                            <div><strong>CEC:</strong> ${sample.cec || 'N/A'}</div>
                            <div><strong>OM%:</strong> ${sample.organicMatter || 'N/A'}</div>
                            <div><strong>Ca%:</strong> ${sample.caPct || 'N/A'}</div>
                            <div><strong>Mg%:</strong> ${sample.mgPct || 'N/A'}</div>
                            <div><strong>K%:</strong> ${sample.kPct || 'N/A'}</div>
                        </div>
                    </div>
                `;
            });

            html += `
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-success" onclick="saveAllParsedSamples()">Save All Samples</button>
                        <button class="btn btn-secondary" onclick="editParsedSample(0)" style="color: #64748b;">Edit Before Saving</button>
                        <button class="btn btn-secondary" onclick="cancelParse()" style="color: #64748b;">Cancel</button>
                    </div>
                </div>
            `;

            preview.innerHTML = html;
            preview.style.display = 'block';

            // Store parsed samples for saving
            window.parsedSamples = samples;
        }

        function cancelParse() {
            document.getElementById('parsePreview').style.display = 'none';
            document.getElementById('pdfInput').value = '';
            window.parsedSamples = null;
        }

        async function saveAllParsedSamples() {
            if (!window.parsedSamples || window.parsedSamples.length === 0) return;

            showToast('Saving samples...', 'info');

            for (const sample of window.parsedSamples) {
                await saveSoilTestData(sample);
            }

            cancelParse();
            loadSoilTests();
            showToast(`Saved ${window.parsedSamples.length} soil test(s)`, 'success');
        }

        function editParsedSample(idx) {
            if (!window.parsedSamples || !window.parsedSamples[idx]) return;

            const sample = window.parsedSamples[idx];

            // Populate form with parsed data
            document.getElementById('sampleLocation').value = sample.sampleLocation || '';
            document.getElementById('testDate').value = sample.testDate || '';
            document.getElementById('labNumber').value = sample.labNumber || '';
            document.getElementById('sampleDepth').value = sample.sampleDepth || 6;
            document.getElementById('ph').value = sample.ph || '';
            document.getElementById('cec').value = sample.cec || '';
            document.getElementById('organicMatter').value = sample.organicMatter || '';
            document.getElementById('sulfur').value = sample.sulfur || '';
            document.getElementById('phosphorus').value = sample.phosphorus || '';
            document.getElementById('caDesired').value = sample.caDesired || '';
            document.getElementById('caFound').value = sample.caFound || '';
            document.getElementById('mgDesired').value = sample.mgDesired || '';
            document.getElementById('mgFound').value = sample.mgFound || '';
            document.getElementById('kDesired').value = sample.kDesired || '';
            document.getElementById('kFound').value = sample.kFound || '';
            document.getElementById('sodium').value = sample.sodium || '';
            document.getElementById('caPct').value = sample.caPct || '';
            document.getElementById('mgPct').value = sample.mgPct || '';
            document.getElementById('kPct').value = sample.kPct || '';
            document.getElementById('naPct').value = sample.naPct || '';
            document.getElementById('otherPct').value = sample.otherPct || '';
            document.getElementById('hPct').value = sample.hPct || '';
            document.getElementById('boron').value = sample.boron || '';
            document.getElementById('iron').value = sample.iron || '';
            document.getElementById('manganese').value = sample.manganese || '';
            document.getElementById('copper').value = sample.copper || '';
            document.getElementById('zinc').value = sample.zinc || '';
            document.getElementById('aluminum').value = sample.aluminum || '';

            cancelParse();
            showManualEntry();
        }

        // Load Soil Tests
        async function loadSoilTests() {
            const container = document.getElementById('testsContainer');

            try {
                const response = await fetch(`${API_URL}?action=getSoilTests`);
                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    soilTests = data.data;
                    // Update localStorage with server data
                    saveToLocalStorage();
                } else {
                    // Try localStorage first, then demo data
                    const localData = loadFromLocalStorage();
                    if (localData && localData.length > 0) {
                        soilTests = localData;
                    } else {
                        soilTests = getDemoData();
                    }
                }

                renderTests();
            } catch (error) {
                console.error('Error loading soil tests:', error);
                // Try localStorage first, then demo data
                const localData = loadFromLocalStorage();
                if (localData && localData.length > 0) {
                    soilTests = localData;
                    showToast('Loaded from local storage (offline mode)', 'info');
                } else {
                    soilTests = getDemoData();
                }
                renderTests();
            }
        }

        function getDemoData() {
            return [
                {
                    id: 1,
                    sampleLocation: 'KRET-O',
                    testDate: '2023-03-15',
                    labNumber: 77,
                    sampleDepth: 6,
                    ph: 7.4,
                    cec: 12.42,
                    organicMatter: 4.59,
                    sulfur: 14,
                    phosphorus: 2063,
                    caDesired: 3377,
                    caFound: 4184,
                    mgDesired: 357,
                    mgFound: 217,
                    kDesired: 387,
                    kFound: 360,
                    sodium: 45,
                    caPct: 84.24,
                    mgPct: 7.28,
                    kPct: 3.72,
                    naPct: 0.79,
                    otherPct: 4.00,
                    hPct: 0.00,
                    boron: 0.66,
                    iron: 181,
                    manganese: 110,
                    copper: 4.95,
                    zinc: 12.85,
                    aluminum: 600,
                    isArchived: false
                },
                {
                    id: 2,
                    sampleLocation: 'KRET-F3M',
                    testDate: '2023-03-15',
                    labNumber: 78,
                    sampleDepth: 6,
                    ph: 6.8,
                    cec: 7.27,
                    organicMatter: 3.81,
                    sulfur: 11,
                    phosphorus: 294,
                    caDesired: 1978,
                    caFound: 2248,
                    mgDesired: 209,
                    mgFound: 155,
                    kDesired: 226,
                    kFound: 278,
                    sodium: 46,
                    caPct: 77.27,
                    mgPct: 8.88,
                    kPct: 4.90,
                    naPct: 1.36,
                    otherPct: 4.60,
                    hPct: 3.00,
                    boron: 0.65,
                    iron: 131,
                    manganese: 59,
                    copper: 3.99,
                    zinc: 3.62,
                    aluminum: 679,
                    isArchived: false
                }
            ];
        }

        function renderTests() {
            const container = document.getElementById('testsContainer');

            let filteredTests = soilTests;
            if (currentTab === 'current') {
                filteredTests = soilTests.filter(t => !t.isArchived);
            } else if (currentTab === 'archived') {
                filteredTests = soilTests.filter(t => t.isArchived);
            } else if (currentTab === 'compare') {
                renderCompareView();
                return;
            } else if (currentTab === 'amendments') {
                renderAmendmentCalculator();
                return;
            } else if (currentTab === 'database') {
                renderAmendmentsDatabase();
                return;
            } else if (currentTab === 'compliance') {
                renderComplianceTab();
                return;
            } else if (currentTab === 'history') {
                renderAmendmentHistory();
                return;
            } else if (currentTab === 'fieldZones') {
                renderFieldZones();
                return;
            } else if (currentTab === 'insights') {
                renderFarmInsights();
                return;
            } else if (currentTab === 'plantDoctor') {
                renderPlantDoctor();
                return;
            } else if (currentTab === 'tissueTests') {
                renderTissueTests();
                return;
            } else if (currentTab === 'foliarProgram') {
                renderFoliarProgram();
                return;
            } else if (currentTab === 'fertigation') {
                renderFertigationTab();
                return;
            } else if (currentTab === 'ipmToolkit') {
                renderIPMToolkit();
                return;
            } else if (currentTab === 'inventory') {
                renderInventoryTab();
                return;
            }

            if (filteredTests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ§ª</div>
                        <h3>No soil tests found</h3>
                        <p>Upload a Logan Labs PDF or add tests manually</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="tests-grid">
                    ${filteredTests.map(test => renderTestCard(test)).join('')}
                </div>
            `;
        }

        function renderTestCard(test) {
            const caStatus = getBaseSatStatus(test.caPct, 60, 70);
            const mgStatus = getBaseSatStatus(test.mgPct, 10, 20);
            const kStatus = getBaseSatStatus(test.kPct, 2, 5);

            return `
                <div class="test-card" onclick="showTestDetail(${test.id})">
                    <div class="test-card-header">
                        <h3>${test.sampleLocation}</h3>
                        <div class="date">${formatDate(test.testDate)}</div>
                    </div>
                    <div class="test-card-body">
                        <div class="test-stats">
                            <div class="test-stat">
                                <div class="test-stat-value">${test.ph}</div>
                                <div class="test-stat-label">pH</div>
                            </div>
                            <div class="test-stat">
                                <div class="test-stat-value">${test.cec}</div>
                                <div class="test-stat-label">CEC</div>
                            </div>
                            <div class="test-stat">
                                <div class="test-stat-value">${test.organicMatter}%</div>
                                <div class="test-stat-label">OM</div>
                            </div>
                        </div>
                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Base Saturation</div>
                        <div class="base-sat-bar">
                            <div class="base-sat-segment base-sat-ca" style="width: ${test.caPct}%" title="Ca: ${test.caPct}%">Ca</div>
                            <div class="base-sat-segment base-sat-mg" style="width: ${test.mgPct}%" title="Mg: ${test.mgPct}%">Mg</div>
                            <div class="base-sat-segment base-sat-k" style="width: ${test.kPct}%" title="K: ${test.kPct}%">K</div>
                            <div class="base-sat-segment base-sat-na" style="width: ${test.naPct}%" title="Na: ${test.naPct}%"></div>
                            <div class="base-sat-segment base-sat-h" style="width: ${test.hPct || 0}%" title="H: ${test.hPct || 0}%"></div>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 0.75rem; font-size: 0.75rem;">
                            <span><span class="status-indicator status-${caStatus}"></span>Ca ${test.caPct}%</span>
                            <span><span class="status-indicator status-${mgStatus}"></span>Mg ${test.mgPct}%</span>
                            <span><span class="status-indicator status-${kStatus}"></span>K ${test.kPct}%</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getBaseSatStatus(value, min, max) {
            if (value < min) return 'low';
            if (value > max) return 'high';
            return 'optimal';
        }

        function showTestDetail(testId) {
            const test = soilTests.find(t => t.id === testId);
            if (!test) return;

            document.getElementById('modalTitle').textContent = `${test.sampleLocation} - ${formatDate(test.testDate)}`;

            const caDeficit = (test.caDesired && test.caFound) ? test.caFound - test.caDesired : null;
            const mgDeficit = (test.mgDesired && test.mgFound) ? test.mgFound - test.mgDesired : null;
            const kDeficit = (test.kDesired && test.kFound) ? test.kFound - test.kDesired : null;

            document.getElementById('modalBody').innerHTML = `
                <div class="form-section">
                    <h3>Basic Properties</h3>
                    <table class="ranges-table">
                        <tr>
                            <th>Property</th>
                            <th>Value</th>
                            <th>Ideal Range</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td>pH</td>
                            <td>${test.ph}</td>
                            <td>6.2 - 7.0</td>
                            <td><span class="status-indicator status-${test.ph >= 6.2 && test.ph <= 7.0 ? 'optimal' : (test.ph < 6.2 ? 'low' : 'high')}"></span>${test.ph >= 6.2 && test.ph <= 7.0 ? 'Optimal' : (test.ph < 6.2 ? 'Low' : 'High')}</td>
                        </tr>
                        <tr>
                            <td>CEC (M.E.)</td>
                            <td>${test.cec}</td>
                            <td>10 - 25</td>
                            <td><span class="status-indicator status-${test.cec >= 10 && test.cec <= 25 ? 'optimal' : (test.cec < 10 ? 'low' : 'high')}"></span>${test.cec >= 10 ? 'Good' : 'Low'}</td>
                        </tr>
                        <tr>
                            <td>Organic Matter</td>
                            <td>${test.organicMatter}%</td>
                            <td>3% - 6%</td>
                            <td><span class="status-indicator status-${test.organicMatter >= 3 && test.organicMatter <= 6 ? 'optimal' : (test.organicMatter < 3 ? 'low' : 'high')}"></span>${test.organicMatter >= 3 ? 'Good' : 'Low'}</td>
                        </tr>
                    </table>
                </div>

                <div class="form-section">
                    <h3>Base Saturation (Albrecht Method)</h3>
                    <table class="ranges-table">
                        <tr>
                            <th>Element</th>
                            <th>Your %</th>
                            <th>Ideal Range</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td>Calcium</td>
                            <td>${test.caPct}%</td>
                            <td>60% - 70%</td>
                            <td><span class="status-indicator status-${getBaseSatStatus(test.caPct, 60, 70)}"></span>${getBaseSatLabel(test.caPct, 60, 70)}</td>
                        </tr>
                        <tr>
                            <td>Magnesium</td>
                            <td>${test.mgPct}%</td>
                            <td>10% - 20%</td>
                            <td><span class="status-indicator status-${getBaseSatStatus(test.mgPct, 10, 20)}"></span>${getBaseSatLabel(test.mgPct, 10, 20)}</td>
                        </tr>
                        <tr>
                            <td>Potassium</td>
                            <td>${test.kPct}%</td>
                            <td>2% - 5%</td>
                            <td><span class="status-indicator status-${getBaseSatStatus(test.kPct, 2, 5)}"></span>${getBaseSatLabel(test.kPct, 2, 5)}</td>
                        </tr>
                        <tr>
                            <td>Sodium</td>
                            <td>${test.naPct}%</td>
                            <td>0.5% - 3%</td>
                            <td><span class="status-indicator status-${getBaseSatStatus(test.naPct, 0.5, 3)}"></span>${getBaseSatLabel(test.naPct, 0.5, 3)}</td>
                        </tr>
                        <tr>
                            <td>Hydrogen</td>
                            <td>${test.hPct || 0}%</td>
                            <td>10% - 15%</td>
                            <td><span class="status-indicator status-${getBaseSatStatus(test.hPct || 0, 10, 15)}"></span>${getBaseSatLabel(test.hPct || 0, 10, 15)}</td>
                        </tr>
                    </table>
                </div>

                <div class="form-section">
                    <h3>Exchangeable Cations (lbs/acre)</h3>
                    <table class="ranges-table">
                        <tr>
                            <th>Element</th>
                            <th>Desired</th>
                            <th>Found</th>
                            <th>Deficit/Surplus</th>
                        </tr>
                        <tr>
                            <td>Calcium</td>
                            <td>${test.caDesired || 'N/A'}</td>
                            <td>${test.caFound || 'N/A'}</td>
                            <td style="color: ${caDeficit > 0 ? '#10b981' : '#ef4444'}">${caDeficit !== null ? (caDeficit > 0 ? '+' : '') + caDeficit : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Magnesium</td>
                            <td>${test.mgDesired || 'N/A'}</td>
                            <td>${test.mgFound || 'N/A'}</td>
                            <td style="color: ${mgDeficit > 0 ? '#10b981' : '#ef4444'}">${mgDeficit !== null ? (mgDeficit > 0 ? '+' : '') + mgDeficit : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Potassium</td>
                            <td>${test.kDesired || 'N/A'}</td>
                            <td>${test.kFound || 'N/A'}</td>
                            <td style="color: ${kDeficit > 0 ? '#10b981' : '#ef4444'}">${kDeficit !== null ? (kDeficit > 0 ? '+' : '') + kDeficit : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>Sodium</td>
                            <td>-</td>
                            <td>${test.sodium || 'N/A'}</td>
                            <td>-</td>
                        </tr>
                    </table>
                </div>

                <div class="form-section">
                    <h3>Anions</h3>
                    <table class="ranges-table">
                        <tr>
                            <th>Element</th>
                            <th>Value</th>
                            <th>Ideal Range</th>
                        </tr>
                        <tr>
                            <td>Sulfur (ppm)</td>
                            <td>${test.sulfur}</td>
                            <td>20 - 50 ppm</td>
                        </tr>
                        <tr>
                            <td>Phosphorus P2O5 (lbs/acre)</td>
                            <td>${test.phosphorus}</td>
                            <td>200 - 400 lbs/acre</td>
                        </tr>
                    </table>
                </div>

                <div class="form-section">
                    <h3>Trace Elements (ppm)</h3>
                    <table class="ranges-table">
                        <tr>
                            <th>Element</th>
                            <th>Value</th>
                            <th>Ideal Range</th>
                        </tr>
                        <tr><td>Boron</td><td>${test.boron}</td><td>1.0 - 2.0</td></tr>
                        <tr><td>Iron</td><td>${test.iron}</td><td>50 - 200</td></tr>
                        <tr><td>Manganese</td><td>${test.manganese}</td><td>40 - 100</td></tr>
                        <tr><td>Copper</td><td>${test.copper}</td><td>2 - 5</td></tr>
                        <tr><td>Zinc</td><td>${test.zinc}</td><td>4 - 20</td></tr>
                        <tr><td>Aluminum</td><td>${test.aluminum}</td><td>&lt; 800</td></tr>
                    </table>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="archiveTest(${test.id})" style="color: #64748b;">
                        ${test.isArchived ? 'Restore' : 'Archive'}
                    </button>
                    <button class="btn btn-secondary" onclick="addToCompare(${test.id})" style="color: #7c3aed;">
                        Add to Compare
                    </button>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        function getBaseSatLabel(value, min, max) {
            if (value < min) return 'Low';
            if (value > max) return 'High';
            return 'Optimal';
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Compare View
        function renderCompareView() {
            const container = document.getElementById('testsContainer');

            if (soilTests.length < 2) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“Š</div>
                        <h3>Need at least 2 tests to compare</h3>
                        <p>Add more soil tests to use the comparison feature</p>
                    </div>
                `;
                return;
            }

            // Group by location for comparison
            const locations = [...new Set(soilTests.map(t => t.sampleLocation))];

            container.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 500; margin-right: 1rem;">Select tests to compare:</label>
                    <select id="compare1" onchange="updateCompare()" style="padding: 0.5rem; margin-right: 0.5rem;">
                        ${soilTests.map(t => `<option value="${t.id}">${t.sampleLocation} - ${formatDate(t.testDate)}</option>`).join('')}
                    </select>
                    <select id="compare2" onchange="updateCompare()" style="padding: 0.5rem;">
                        ${soilTests.map((t, i) => `<option value="${t.id}" ${i === 1 ? 'selected' : ''}>${t.sampleLocation} - ${formatDate(t.testDate)}</option>`).join('')}
                    </select>
                </div>
                <div id="compareResults"></div>
            `;

            updateCompare();
        }

        function updateCompare() {
            const id1 = parseInt(document.getElementById('compare1').value);
            const id2 = parseInt(document.getElementById('compare2').value);

            const test1 = soilTests.find(t => t.id === id1);
            const test2 = soilTests.find(t => t.id === id2);

            if (!test1 || !test2) return;

            const resultsDiv = document.getElementById('compareResults');

            const metrics = [
                { key: 'ph', label: 'pH', ideal: '6.2 - 7.0' },
                { key: 'cec', label: 'CEC', ideal: '10 - 25' },
                { key: 'organicMatter', label: 'Organic Matter %', ideal: '3 - 6' },
                { key: 'caPct', label: 'Calcium %', ideal: '60 - 70' },
                { key: 'mgPct', label: 'Magnesium %', ideal: '10 - 20' },
                { key: 'kPct', label: 'Potassium %', ideal: '2 - 5' },
                { key: 'sulfur', label: 'Sulfur (ppm)', ideal: '20 - 50' },
                { key: 'phosphorus', label: 'Phosphorus (lbs/ac)', ideal: '200 - 400' },
                { key: 'boron', label: 'Boron (ppm)', ideal: '1 - 2' },
                { key: 'iron', label: 'Iron (ppm)', ideal: '50 - 200' },
                { key: 'manganese', label: 'Manganese (ppm)', ideal: '40 - 100' },
                { key: 'zinc', label: 'Zinc (ppm)', ideal: '4 - 20' }
            ];

            resultsDiv.innerHTML = `
                <table class="ranges-table" style="background: white; border-radius: 0.5rem;">
                    <tr>
                        <th>Metric</th>
                        <th>${test1.sampleLocation}<br><small>${formatDate(test1.testDate)}</small></th>
                        <th>${test2.sampleLocation}<br><small>${formatDate(test2.testDate)}</small></th>
                        <th>Difference</th>
                        <th>Ideal Range</th>
                    </tr>
                    ${metrics.map(m => {
                        const v1 = test1[m.key] || 0;
                        const v2 = test2[m.key] || 0;
                        const diff = (v2 - v1).toFixed(2);
                        const diffColor = diff > 0 ? '#10b981' : (diff < 0 ? '#ef4444' : '#64748b');
                        return `
                            <tr>
                                <td><strong>${m.label}</strong></td>
                                <td>${v1}</td>
                                <td>${v2}</td>
                                <td style="color: ${diffColor}">${diff > 0 ? '+' : ''}${diff}</td>
                                <td>${m.ideal}</td>
                            </tr>
                        `;
                    }).join('')}
                </table>
            `;
        }

        function addToCompare(testId) {
            closeModal();
            switchTab('compare');
        }

        // Tab Switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            renderTests();
        }

        // Manual Entry
        function showManualEntry() {
            document.getElementById('entryModal').classList.add('active');
        }

        function closeEntryModal() {
            document.getElementById('entryModal').classList.remove('active');
        }

        async function saveSoilTest(event) {
            event.preventDefault();

            const formData = {
                sampleLocation: document.getElementById('sampleLocation').value,
                testDate: document.getElementById('testDate').value,
                labNumber: document.getElementById('labNumber').value,
                sampleDepth: parseFloat(document.getElementById('sampleDepth').value) || 6,
                ph: parseFloat(document.getElementById('ph').value),
                cec: parseFloat(document.getElementById('cec').value),
                organicMatter: parseFloat(document.getElementById('organicMatter').value),
                sulfur: parseFloat(document.getElementById('sulfur').value),
                phosphorus: parseFloat(document.getElementById('phosphorus').value),
                caDesired: parseFloat(document.getElementById('caDesired').value),
                caFound: parseFloat(document.getElementById('caFound').value),
                mgDesired: parseFloat(document.getElementById('mgDesired').value),
                mgFound: parseFloat(document.getElementById('mgFound').value),
                kDesired: parseFloat(document.getElementById('kDesired').value),
                kFound: parseFloat(document.getElementById('kFound').value),
                sodium: parseFloat(document.getElementById('sodium').value),
                caPct: parseFloat(document.getElementById('caPct').value),
                mgPct: parseFloat(document.getElementById('mgPct').value),
                kPct: parseFloat(document.getElementById('kPct').value),
                naPct: parseFloat(document.getElementById('naPct').value),
                otherPct: parseFloat(document.getElementById('otherPct').value),
                hPct: parseFloat(document.getElementById('hPct').value),
                boron: parseFloat(document.getElementById('boron').value),
                iron: parseFloat(document.getElementById('iron').value),
                manganese: parseFloat(document.getElementById('manganese').value),
                copper: parseFloat(document.getElementById('copper').value),
                zinc: parseFloat(document.getElementById('zinc').value),
                aluminum: parseFloat(document.getElementById('aluminum').value)
            };

            await saveSoilTestData(formData);
            closeEntryModal();
            loadSoilTests();

            // Reset form
            document.getElementById('soilTestForm').reset();
            document.getElementById('testDate').valueAsDate = new Date();
        }

        async function saveSoilTestData(data) {
            // Always generate an ID if not present
            const newTest = {
                id: data.id || Date.now(),
                ...data,
                isArchived: data.isArchived || false
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'saveSoilTest',
                        data: newTest
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update local array with the saved ID from server
                    newTest.id = result.id || newTest.id;

                    // Update or add to local array
                    const existingIndex = soilTests.findIndex(t => t.id === newTest.id);
                    if (existingIndex >= 0) {
                        soilTests[existingIndex] = newTest;
                    } else {
                        soilTests.push(newTest);
                    }

                    // Also save to localStorage as backup
                    saveToLocalStorage();

                    showToast('Soil test saved!', 'success');
                } else {
                    throw new Error(result.error || 'Save failed');
                }
            } catch (error) {
                console.error('Error saving soil test:', error);

                // Add to local array
                const existingIndex = soilTests.findIndex(t => t.id === newTest.id);
                if (existingIndex >= 0) {
                    soilTests[existingIndex] = newTest;
                } else {
                    soilTests.push(newTest);
                }

                // Save to localStorage as fallback
                saveToLocalStorage();

                showToast('Saved locally (will sync when online)', 'success');
            }
        }

        // Save soilTests array to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('soilTests', JSON.stringify(soilTests));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        // Load soilTests from localStorage
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('soilTests');
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
            return null;
        }

        async function archiveTest(testId) {
            const test = soilTests.find(t => t.id === testId);
            if (test) {
                test.isArchived = !test.isArchived;

                // Try to sync with backend
                try {
                    await saveSoilTestData(test);
                } catch (e) {
                    // Already handled in saveSoilTestData
                }

                closeModal();
                renderTests();
                showToast(test.isArchived ? 'Test archived' : 'Test restored', 'success');
            }
        }

        // ============================================
        // AMENDMENT CALCULATOR (Steve Solomon / Albrecht Method)
        // ============================================

        // Potassium target lookup table by TCEC
        const K_TARGETS = {
            3: 190, 4: 210, 5: 225, 6: 240, 7: 255, 8: 270, 9: 290, 10: 310,
            11: 320, 12: 335, 13: 350, 14: 365, 15: 380, 16: 390, 17: 400, 18: 410,
            19: 420, 20: 435, 21: 443, 22: 451, 23: 459, 24: 463, 25: 475, 26: 481,
            27: 487, 28: 493, 29: 500, 30: 507, 31: 511, 32: 515, 33: 519, 34: 523,
            35: 527, 36: 531, 37: 535, 38: 539, 39: 543
        };

        // ============================================
        // CROP NUTRITIONAL NEEDS DATABASE
        // Source: Northeast Organic Grower Crop Manual 2022 (Roxbury)
        // N = lbs/acre, P/K = [low, high] range lbs/acre, pH = [min, max]
        // ============================================
        const CROP_NUTRITION = {
            // General/No specific crop
            none: { name: 'General Soil Building', N: 100, P: [0, 200], K: [0, 200], pH: [6.2, 7.0], category: 'general' },

            // Leafy Greens
            arugula: { name: 'Arugula', N: 120, P: [20, 160], K: [0, 200], pH: [6.2, 6.5], category: 'leafy' },
            lettuce: { name: 'Lettuce', N: 120, P: [0, 160], K: [0, 240], pH: [6.0, 6.5], category: 'leafy' },
            spinach: { name: 'Spinach', N: 120, P: [0, 200], K: [0, 280], pH: [6.5, 6.8], category: 'leafy' },
            kale: { name: 'Kale', N: 120, P: [0, 160], K: [0, 200], pH: [6.0, 6.5], category: 'leafy' },
            chard: { name: 'Swiss Chard', N: 120, P: [0, 200], K: [0, 280], pH: [6.0, 6.5], category: 'leafy' },
            collards: { name: 'Collard Greens', N: 120, P: [0, 160], K: [0, 200], pH: [6.0, 6.5], category: 'leafy' },
            mustardGreens: { name: 'Mustard Greens', N: 100, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'leafy' },

            // Brassicas
            broccoli: { name: 'Broccoli', N: 150, P: [0, 200], K: [0, 240], pH: [6.0, 6.5], category: 'brassica' },
            cabbage: { name: 'Cabbage', N: 150, P: [0, 200], K: [0, 240], pH: [6.0, 6.5], category: 'brassica' },
            cauliflower: { name: 'Cauliflower', N: 150, P: [0, 200], K: [0, 240], pH: [6.0, 6.5], category: 'brassica' },
            brusselsSprouts: { name: 'Brussels Sprouts', N: 120, P: [0, 160], K: [0, 200], pH: [6.2, 6.5], category: 'brassica' },
            kohlrabi: { name: 'Kohlrabi', N: 100, P: [0, 160], K: [0, 200], pH: [6.0, 6.5], category: 'brassica' },
            bokChoy: { name: 'Bok Choy', N: 100, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'brassica' },

            // Solanaceae (Heavy Feeders)
            tomato: { name: 'Tomato', N: 100, P: [0, 200], K: [0, 240], pH: [6.0, 6.4], category: 'solanaceae' },
            pepper: { name: 'Pepper', N: 100, P: [0, 200], K: [0, 200], pH: [6.0, 6.5], category: 'solanaceae' },
            eggplant: { name: 'Eggplant', N: 100, P: [0, 200], K: [0, 240], pH: [6.0, 6.5], category: 'solanaceae' },
            tomatillo: { name: 'Tomatillo', N: 80, P: [0, 160], K: [0, 200], pH: [6.0, 6.5], category: 'solanaceae' },

            // Cucurbits
            cucumber: { name: 'Cucumber', N: 80, P: [0, 160], K: [0, 200], pH: [6.0, 6.5], category: 'cucurbit' },
            squashSummer: { name: 'Summer Squash/Zucchini', N: 80, P: [0, 200], K: [0, 240], pH: [6.0, 6.5], category: 'cucurbit' },
            squashWinter: { name: 'Winter Squash', N: 80, P: [0, 200], K: [0, 240], pH: [6.0, 6.5], category: 'cucurbit' },
            melon: { name: 'Cantaloupe/Melon', N: 100, P: [0, 200], K: [0, 280], pH: [6.2, 6.5], category: 'cucurbit' },
            watermelon: { name: 'Watermelon', N: 100, P: [0, 200], K: [0, 280], pH: [6.0, 6.5], category: 'cucurbit' },
            pumpkin: { name: 'Pumpkin', N: 80, P: [0, 200], K: [0, 240], pH: [6.0, 6.5], category: 'cucurbit' },

            // Root Vegetables
            carrot: { name: 'Carrot', N: 90, P: [0, 160], K: [0, 200], pH: [6.0, 6.4], category: 'root' },
            beet: { name: 'Beet', N: 100, P: [0, 160], K: [0, 200], pH: [6.2, 6.5], category: 'root' },
            radish: { name: 'Radish', N: 50, P: [0, 80], K: [0, 120], pH: [6.0, 6.5], category: 'root' },
            turnip: { name: 'Turnip', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'root' },
            rutabaga: { name: 'Rutabaga', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'root' },
            parsnip: { name: 'Parsnip', N: 60, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'root' },
            potato: { name: 'Potato', N: 120, P: [0, 240], K: [0, 280], pH: [5.8, 6.2], category: 'root' },
            sweetPotato: { name: 'Sweet Potato', N: 60, P: [0, 160], K: [0, 200], pH: [5.8, 6.2], category: 'root' },

            // Alliums
            onion: { name: 'Onion', N: 100, P: [0, 160], K: [0, 200], pH: [6.2, 6.5], category: 'allium' },
            garlic: { name: 'Garlic', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'allium' },
            leek: { name: 'Leek', N: 120, P: [0, 160], K: [0, 200], pH: [6.2, 6.5], category: 'allium' },
            scallion: { name: 'Scallion/Green Onion', N: 100, P: [0, 160], K: [0, 160], pH: [6.2, 6.5], category: 'allium' },
            shallot: { name: 'Shallot', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'allium' },

            // Legumes (N-fixing, need less N)
            beanBush: { name: 'Bush Bean', N: 40, P: [0, 100], K: [0, 80], pH: [6.2, 6.4], category: 'legume' },
            beanPole: { name: 'Pole Bean', N: 40, P: [0, 100], K: [0, 80], pH: [6.2, 6.4], category: 'legume' },
            pea: { name: 'Pea', N: 20, P: [0, 80], K: [0, 80], pH: [6.2, 6.5], category: 'legume' },
            snapPea: { name: 'Snap Pea', N: 20, P: [0, 80], K: [0, 80], pH: [6.2, 6.5], category: 'legume' },
            lima: { name: 'Lima Bean', N: 40, P: [0, 100], K: [0, 100], pH: [6.2, 6.5], category: 'legume' },
            soybean: { name: 'Edamame/Soybean', N: 20, P: [0, 80], K: [0, 80], pH: [6.0, 6.5], category: 'legume' },

            // Herbs
            basil: { name: 'Basil', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'herb' },
            cilantro: { name: 'Cilantro', N: 60, P: [0, 100], K: [0, 120], pH: [6.0, 6.5], category: 'herb' },
            parsley: { name: 'Parsley', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'herb' },
            dill: { name: 'Dill', N: 60, P: [0, 100], K: [0, 120], pH: [6.0, 6.5], category: 'herb' },
            oregano: { name: 'Oregano', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'herb' },
            thyme: { name: 'Thyme', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'herb' },
            rosemary: { name: 'Rosemary', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'herb' },
            sage: { name: 'Sage', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'herb' },
            mint: { name: 'Mint', N: 60, P: [0, 100], K: [0, 120], pH: [6.0, 7.0], category: 'herb' },
            chives: { name: 'Chives', N: 60, P: [0, 100], K: [0, 120], pH: [6.0, 6.5], category: 'herb' },

            // Corn
            sweetCorn: { name: 'Sweet Corn', N: 150, P: [0, 160], K: [0, 120], pH: [6.0, 6.5], category: 'grain' },

            // Celery Family
            celery: { name: 'Celery', N: 150, P: [0, 200], K: [0, 280], pH: [6.2, 6.5], category: 'celery' },
            celeriac: { name: 'Celeriac', N: 120, P: [0, 160], K: [0, 200], pH: [6.2, 6.5], category: 'celery' },
            fennel: { name: 'Fennel', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'celery' },

            // Asparagus
            asparagus: { name: 'Asparagus', N: 80, P: [0, 160], K: [0, 200], pH: [6.5, 7.0], category: 'perennial' },
            rhubarb: { name: 'Rhubarb', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 6.5], category: 'perennial' },

            // ============================================
            // FLORAL CROPS - Cut Flower Production
            // Sources: UMass Extension, University of Maryland Extension, Utah State University
            // N rates: lbs/acre, typical 1-2 lbs actual N per 1000 sq ft (44-88 lbs/acre)
            // pH range: 5.5-7.0 acceptable, 6.0-6.8 optimal for most species
            // ============================================

            // Annual Cut Flowers - Heavy Feeders
            zinnia: { name: 'Zinnia', N: 65, P: [0, 120], K: [0, 160], pH: [6.0, 6.8], category: 'floral', notes: 'Moderate feeder. Succession plant every 2 weeks.' },
            sunflower: { name: 'Sunflower', N: 50, P: [0, 100], K: [0, 120], pH: [6.0, 7.0], category: 'floral', notes: 'Low-moderate N needs. Heavy K for stem strength.' },
            dahlia: { name: 'Dahlia', N: 80, P: [0, 160], K: [0, 200], pH: [6.2, 6.8], category: 'floral', notes: 'Medium feeder. Heavy K for tuber and bloom production.' },
            lisianthus: { name: 'Lisianthus', N: 50, P: [0, 100], K: [0, 120], pH: [6.2, 7.0], category: 'floral', notes: 'Low-medium N. Very sensitive to pH below 6.0.' },
            snapdragon: { name: 'Snapdragon', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 7.0], category: 'floral', notes: 'Medium N needs. Prefers cooler temps.' },
            celosia: { name: 'Celosia', N: 60, P: [0, 100], K: [0, 140], pH: [6.0, 6.8], category: 'floral', notes: 'Moderate feeder. Heat loving.' },
            cosmos: { name: 'Cosmos', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'floral', notes: 'Light feeder. Too much N = all leaves, few flowers.' },
            marigold: { name: 'Marigold', N: 50, P: [0, 100], K: [0, 120], pH: [6.0, 7.0], category: 'floral', notes: 'Light-moderate feeder. Good trap crop.' },
            ageratum: { name: 'Ageratum', N: 60, P: [0, 100], K: [0, 120], pH: [6.0, 6.8], category: 'floral', notes: 'Moderate feeder. Good filler flower.' },

            // Annual Cut Flowers - Light/Moderate Feeders
            larkspur: { name: 'Larkspur', N: 50, P: [0, 100], K: [0, 120], pH: [6.5, 7.5], category: 'floral', notes: 'Prefers alkaline soil. Direct seed fall or early spring.' },
            stock: { name: 'Stock', N: 80, P: [0, 120], K: [0, 160], pH: [6.0, 7.5], category: 'floral', notes: 'Heavy feeder. Needs Ca for stem strength.' },
            statice: { name: 'Statice', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'floral', notes: 'Light feeder. Good dried flower.' },
            strawflower: { name: 'Strawflower', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'floral', notes: 'Light feeder. Excellent dried flower.' },
            gomphrena: { name: 'Gomphrena', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'floral', notes: 'Light feeder. Heat and drought tolerant.' },
            amaranth: { name: 'Amaranth', N: 50, P: [0, 100], K: [0, 120], pH: [6.0, 7.0], category: 'floral', notes: 'Light-moderate feeder. Dramatic foliage and flowers.' },

            // Perennial Cut Flowers
            peony: { name: 'Peony', N: 60, P: [0, 120], K: [0, 140], pH: [6.0, 7.0], category: 'floral', notes: 'Moderate feeder. Takes 2-3 years to establish.' },
            lily: { name: 'Lily (Asiatic/Oriental)', N: 80, P: [0, 140], K: [0, 180], pH: [6.0, 6.8], category: 'floral', notes: 'Medium-heavy feeder. Need good drainage.' },
            ranunculus: { name: 'Ranunculus', N: 60, P: [0, 100], K: [0, 140], pH: [6.0, 7.0], category: 'floral', notes: 'Moderate feeder. Cool season crop.' },
            anemone: { name: 'Anemone', N: 60, P: [0, 100], K: [0, 140], pH: [6.0, 7.0], category: 'floral', notes: 'Moderate feeder. Cool season crop.' },
            delphinium: { name: 'Delphinium', N: 80, P: [0, 120], K: [0, 160], pH: [6.5, 7.5], category: 'floral', notes: 'Heavy feeder. Prefers slightly alkaline.' },

            // Foliage/Filler Crops
            eucalyptus: { name: 'Eucalyptus', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'floral', notes: 'Light feeder. Annual in cold climates.' },
            dustyMiller: { name: 'Dusty Miller', N: 40, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'floral', notes: 'Light feeder. Silver foliage.' },
            bupleurum: { name: 'Bupleurum', N: 50, P: [0, 80], K: [0, 100], pH: [6.0, 7.0], category: 'floral', notes: 'Light feeder. Premium filler.' }
        };

        // Crop categories for grouped dropdown
        const CROP_CATEGORIES = {
            general: 'General',
            leafy: 'Leafy Greens',
            brassica: 'Brassicas',
            solanaceae: 'Tomatoes, Peppers & Eggplant',
            cucurbit: 'Cucurbits (Squash, Melons)',
            root: 'Root Vegetables',
            allium: 'Onions & Garlic',
            legume: 'Beans & Peas',
            herb: 'Herbs',
            grain: 'Corn & Grains',
            celery: 'Celery Family',
            perennial: 'Perennial Vegetables',
            floral: 'Cut Flowers'
        };

        // ============================================
        // TISSUE TEST SUFFICIENCY RANGES
        // Used to interpret plant tissue analysis results
        // Source: A & L Labs, Haifa Group, Penn State Extension
        // Values in % for macros, ppm for micros
        // ============================================
        const TISSUE_SUFFICIENCY = {
            // Vegetable Crops
            tomato: {
                name: 'Tomato',
                plantPart: '3rd-4th leaf from growing tip',
                growthStage: 'Early bloom',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 6.0], high: 6.0, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 2.0, sufficient: [2.0, 6.0], high: 6.0, unit: '%' },
                    Mg: { low: 0.5, sufficient: [0.5, 1.0], high: 1.0, unit: '%' },
                    S: { low: 0.5, sufficient: [0.5, 0.9], high: 0.9, unit: '%' },
                    B: { low: 40, sufficient: [40, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 35, sufficient: [35, 50], high: 50, unit: 'ppm' },
                    Mn: { low: 100, sufficient: [100, 200], high: 200, unit: 'ppm' },
                    Fe: { low: 100, sufficient: [100, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 8, sufficient: [8, 20], high: 20, unit: 'ppm' }
                }
            },
            pepper: {
                name: 'Pepper',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Early bloom',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 5.0], high: 5.0, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.8], high: 0.8, unit: '%' },
                    K: { low: 3.0, sufficient: [3.0, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 3.0], high: 3.0, unit: '%' },
                    Mg: { low: 0.3, sufficient: [0.3, 1.0], high: 1.0, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.6], high: 0.6, unit: '%' },
                    B: { low: 25, sufficient: [25, 75], high: 75, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Mn: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Fe: { low: 60, sufficient: [60, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 6, sufficient: [6, 20], high: 20, unit: 'ppm' }
                }
            },
            lettuce: {
                name: 'Lettuce',
                plantPart: 'Wrapper leaf',
                growthStage: 'Head formation',
                ranges: {
                    N: { low: 3.5, sufficient: [3.5, 5.5], high: 5.5, unit: '%' },
                    P: { low: 0.4, sufficient: [0.4, 0.8], high: 0.8, unit: '%' },
                    K: { low: 4.0, sufficient: [4.0, 8.0], high: 8.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 2.5], high: 2.5, unit: '%' },
                    Mg: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 25, sufficient: [25, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 25, sufficient: [25, 100], high: 100, unit: 'ppm' },
                    Mn: { low: 25, sufficient: [25, 200], high: 200, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 300], high: 300, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            cucumber: {
                name: 'Cucumber',
                plantPart: '5th leaf from growing tip',
                growthStage: 'Early fruit set',
                ranges: {
                    N: { low: 4.0, sufficient: [4.0, 6.0], high: 6.0, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 4.0], high: 4.0, unit: '%' },
                    Mg: { low: 0.4, sufficient: [0.4, 1.0], high: 1.0, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 25, sufficient: [25, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 25, sufficient: [25, 100], high: 100, unit: 'ppm' },
                    Mn: { low: 50, sufficient: [50, 300], high: 300, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 300], high: 300, unit: 'ppm' },
                    Cu: { low: 6, sufficient: [6, 20], high: 20, unit: 'ppm' }
                }
            },
            // Floral Crops - Based on general cut flower recommendations
            zinnia: {
                name: 'Zinnia',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Bud development',
                ranges: {
                    N: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.75], high: 0.75, unit: '%' },
                    K: { low: 2.0, sufficient: [2.0, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 3.0], high: 3.0, unit: '%' },
                    Mg: { low: 0.25, sufficient: [0.25, 0.75], high: 0.75, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 75], high: 75, unit: 'ppm' },
                    Mn: { low: 30, sufficient: [30, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            dahlia: {
                name: 'Dahlia',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Early bloom',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 5.5], high: 5.5, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.5], high: 5.5, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 4.0], high: 4.0, unit: '%' },
                    Mg: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.6], high: 0.6, unit: '%' },
                    B: { low: 25, sufficient: [25, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 25, sufficient: [25, 80], high: 80, unit: 'ppm' },
                    Mn: { low: 40, sufficient: [40, 175], high: 175, unit: 'ppm' },
                    Fe: { low: 60, sufficient: [60, 250], high: 250, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 18], high: 18, unit: 'ppm' }
                }
            },
            // Additional Vegetable Crops - Source: A&L Labs, Ohio State Extension
            broccoli: {
                name: 'Broccoli',
                plantPart: 'First mature leaf below developing head',
                growthStage: 'Buttoning (early head)',
                ranges: {
                    N: { low: 3.5, sufficient: [3.5, 5.5], high: 5.5, unit: '%' },
                    P: { low: 0.4, sufficient: [0.4, 0.8], high: 0.8, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 4.0], high: 4.0, unit: '%' },
                    Mg: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    S: { low: 0.5, sufficient: [0.5, 1.0], high: 1.0, unit: '%' },
                    B: { low: 25, sufficient: [25, 75], high: 75, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Mn: { low: 25, sufficient: [25, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 40, sufficient: [40, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 4, sufficient: [4, 15], high: 15, unit: 'ppm' }
                }
            },
            cabbage: {
                name: 'Cabbage',
                plantPart: 'First mature wrapper leaf',
                growthStage: 'Head formation',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 5.0], high: 5.0, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.7], high: 0.7, unit: '%' },
                    K: { low: 2.0, sufficient: [2.0, 4.5], high: 4.5, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 3.5], high: 3.5, unit: '%' },
                    Mg: { low: 0.3, sufficient: [0.3, 0.7], high: 0.7, unit: '%' },
                    S: { low: 0.4, sufficient: [0.4, 0.9], high: 0.9, unit: '%' },
                    B: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 50], high: 50, unit: 'ppm' },
                    Mn: { low: 25, sufficient: [25, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 40, sufficient: [40, 175], high: 175, unit: 'ppm' },
                    Cu: { low: 4, sufficient: [4, 12], high: 12, unit: 'ppm' }
                }
            },
            carrot: {
                name: 'Carrot',
                plantPart: 'Most recently matured leaf (whole petiole)',
                growthStage: 'Mid-growth',
                ranges: {
                    N: { low: 2.5, sufficient: [2.5, 4.0], high: 4.0, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.6], high: 0.6, unit: '%' },
                    K: { low: 3.0, sufficient: [3.0, 5.5], high: 5.5, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 3.5], high: 3.5, unit: '%' },
                    Mg: { low: 0.25, sufficient: [0.25, 0.7], high: 0.7, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 25, sufficient: [25, 75], high: 75, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 75], high: 75, unit: 'ppm' },
                    Mn: { low: 25, sufficient: [25, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 40, sufficient: [40, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            beet: {
                name: 'Beet',
                plantPart: 'Most recently matured leaf blade',
                growthStage: 'Root bulking',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 5.0], high: 5.0, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.7], high: 0.7, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 2.5], high: 2.5, unit: '%' },
                    Mg: { low: 0.4, sufficient: [0.4, 1.0], high: 1.0, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 30, sufficient: [30, 80], high: 80, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Mn: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            onion: {
                name: 'Onion',
                plantPart: 'Center mature leaf (whole leaf)',
                growthStage: 'Bulb initiation',
                ranges: {
                    N: { low: 2.5, sufficient: [2.5, 4.0], high: 4.0, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.5], high: 0.5, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 3.5], high: 3.5, unit: '%' },
                    Mg: { low: 0.2, sufficient: [0.2, 0.6], high: 0.6, unit: '%' },
                    S: { low: 0.5, sufficient: [0.5, 1.2], high: 1.2, unit: '%' },
                    B: { low: 20, sufficient: [20, 50], high: 50, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Mn: { low: 30, sufficient: [30, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 40, sufficient: [40, 150], high: 150, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            sweetCorn: {
                name: 'Sweet Corn',
                plantPart: 'Ear leaf at silking',
                growthStage: 'Silking',
                ranges: {
                    N: { low: 2.75, sufficient: [2.75, 3.5], high: 3.5, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.5], high: 0.5, unit: '%' },
                    K: { low: 1.7, sufficient: [1.7, 3.0], high: 3.0, unit: '%' },
                    Ca: { low: 0.25, sufficient: [0.25, 0.6], high: 0.6, unit: '%' },
                    Mg: { low: 0.15, sufficient: [0.15, 0.5], high: 0.5, unit: '%' },
                    S: { low: 0.15, sufficient: [0.15, 0.5], high: 0.5, unit: '%' },
                    B: { low: 5, sufficient: [5, 25], high: 25, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 70], high: 70, unit: 'ppm' },
                    Mn: { low: 20, sufficient: [20, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 20, sufficient: [20, 250], high: 250, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 20], high: 20, unit: 'ppm' }
                }
            },
            squash: {
                name: 'Squash / Zucchini',
                plantPart: '5th leaf from growing tip',
                growthStage: 'Early fruit set',
                ranges: {
                    N: { low: 4.0, sufficient: [4.0, 6.0], high: 6.0, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 4.0], high: 4.0, unit: '%' },
                    Mg: { low: 0.4, sufficient: [0.4, 1.0], high: 1.0, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 25, sufficient: [25, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 25, sufficient: [25, 100], high: 100, unit: 'ppm' },
                    Mn: { low: 50, sufficient: [50, 300], high: 300, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 300], high: 300, unit: 'ppm' },
                    Cu: { low: 6, sufficient: [6, 20], high: 20, unit: 'ppm' }
                }
            },
            bean: {
                name: 'Bean (Green/Snap)',
                plantPart: 'Most recently matured trifoliate',
                growthStage: 'Early bloom',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 5.5], high: 5.5, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.6], high: 0.6, unit: '%' },
                    K: { low: 2.0, sufficient: [2.0, 4.0], high: 4.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 2.5], high: 2.5, unit: '%' },
                    Mg: { low: 0.25, sufficient: [0.25, 0.8], high: 0.8, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.4], high: 0.4, unit: '%' },
                    B: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 100], high: 100, unit: 'ppm' },
                    Mn: { low: 20, sufficient: [20, 100], high: 100, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 300], high: 300, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 20], high: 20, unit: 'ppm' }
                }
            },
            potato: {
                name: 'Potato',
                plantPart: '4th leaf from growing tip',
                growthStage: 'Early tuber bulking',
                ranges: {
                    N: { low: 4.0, sufficient: [4.0, 6.0], high: 6.0, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.5], high: 0.5, unit: '%' },
                    K: { low: 3.5, sufficient: [3.5, 6.0], high: 6.0, unit: '%' },
                    Ca: { low: 0.5, sufficient: [0.5, 1.5], high: 1.5, unit: '%' },
                    Mg: { low: 0.25, sufficient: [0.25, 0.7], high: 0.7, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 20, sufficient: [20, 50], high: 50, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 50], high: 50, unit: 'ppm' },
                    Mn: { low: 25, sufficient: [25, 100], high: 100, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 20], high: 20, unit: 'ppm' }
                }
            },
            spinach: {
                name: 'Spinach',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Mid-growth',
                ranges: {
                    N: { low: 3.5, sufficient: [3.5, 6.0], high: 6.0, unit: '%' },
                    P: { low: 0.35, sufficient: [0.35, 0.8], high: 0.8, unit: '%' },
                    K: { low: 4.0, sufficient: [4.0, 7.0], high: 7.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 2.5], high: 2.5, unit: '%' },
                    Mg: { low: 0.4, sufficient: [0.4, 1.0], high: 1.0, unit: '%' },
                    S: { low: 0.25, sufficient: [0.25, 0.6], high: 0.6, unit: '%' },
                    B: { low: 30, sufficient: [30, 80], high: 80, unit: 'ppm' },
                    Zn: { low: 25, sufficient: [25, 100], high: 100, unit: 'ppm' },
                    Mn: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 300], high: 300, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            celery: {
                name: 'Celery',
                plantPart: 'Youngest mature leaf petiole',
                growthStage: 'Mid-growth',
                ranges: {
                    N: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.7], high: 0.7, unit: '%' },
                    K: { low: 4.0, sufficient: [4.0, 8.0], high: 8.0, unit: '%' },
                    Ca: { low: 2.0, sufficient: [2.0, 4.0], high: 4.0, unit: '%' },
                    Mg: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 30, sufficient: [30, 80], high: 80, unit: 'ppm' },
                    Zn: { low: 25, sufficient: [25, 100], high: 100, unit: 'ppm' },
                    Mn: { low: 30, sufficient: [30, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 300], high: 300, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            // Additional Floral Crops - Source: UMass Extension, Floriculture research
            sunflower: {
                name: 'Sunflower',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Pre-bloom',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 5.0], high: 5.0, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.65], high: 0.65, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 3.5], high: 3.5, unit: '%' },
                    Mg: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 25, sufficient: [25, 80], high: 80, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 70], high: 70, unit: 'ppm' },
                    Mn: { low: 30, sufficient: [30, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            snapdragon: {
                name: 'Snapdragon',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Stem elongation',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 5.5], high: 5.5, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 3.0], high: 3.0, unit: '%' },
                    Mg: { low: 0.25, sufficient: [0.25, 0.75], high: 0.75, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 70], high: 70, unit: 'ppm' },
                    Mn: { low: 30, sufficient: [30, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            lisianthus: {
                name: 'Lisianthus',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Pre-bloom',
                ranges: {
                    N: { low: 2.5, sufficient: [2.5, 4.5], high: 4.5, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.7], high: 0.7, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 2.5], high: 2.5, unit: '%' },
                    Mg: { low: 0.25, sufficient: [0.25, 0.7], high: 0.7, unit: '%' },
                    S: { low: 0.15, sufficient: [0.15, 0.4], high: 0.4, unit: '%' },
                    B: { low: 20, sufficient: [20, 50], high: 50, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Mn: { low: 25, sufficient: [25, 120], high: 120, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            celosia: {
                name: 'Celosia',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Bud development',
                ranges: {
                    N: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.7], high: 0.7, unit: '%' },
                    K: { low: 2.0, sufficient: [2.0, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 3.0], high: 3.0, unit: '%' },
                    Mg: { low: 0.25, sufficient: [0.25, 0.8], high: 0.8, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 20, sufficient: [20, 60], high: 60, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 75], high: 75, unit: 'ppm' },
                    Mn: { low: 30, sufficient: [30, 150], high: 150, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            ranunculus: {
                name: 'Ranunculus',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Pre-bloom',
                ranges: {
                    N: { low: 3.0, sufficient: [3.0, 5.0], high: 5.0, unit: '%' },
                    P: { low: 0.3, sufficient: [0.3, 0.7], high: 0.7, unit: '%' },
                    K: { low: 3.0, sufficient: [3.0, 5.5], high: 5.5, unit: '%' },
                    Ca: { low: 1.5, sufficient: [1.5, 3.5], high: 3.5, unit: '%' },
                    Mg: { low: 0.3, sufficient: [0.3, 0.8], high: 0.8, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 25, sufficient: [25, 65], high: 65, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 70], high: 70, unit: 'ppm' },
                    Mn: { low: 30, sufficient: [30, 140], high: 140, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            },
            anemone: {
                name: 'Anemone',
                plantPart: 'Most recently matured leaf',
                growthStage: 'Pre-bloom',
                ranges: {
                    N: { low: 2.5, sufficient: [2.5, 4.5], high: 4.5, unit: '%' },
                    P: { low: 0.25, sufficient: [0.25, 0.65], high: 0.65, unit: '%' },
                    K: { low: 2.5, sufficient: [2.5, 5.0], high: 5.0, unit: '%' },
                    Ca: { low: 1.0, sufficient: [1.0, 3.0], high: 3.0, unit: '%' },
                    Mg: { low: 0.25, sufficient: [0.25, 0.7], high: 0.7, unit: '%' },
                    S: { low: 0.2, sufficient: [0.2, 0.5], high: 0.5, unit: '%' },
                    B: { low: 20, sufficient: [20, 55], high: 55, unit: 'ppm' },
                    Zn: { low: 20, sufficient: [20, 65], high: 65, unit: 'ppm' },
                    Mn: { low: 25, sufficient: [25, 130], high: 130, unit: 'ppm' },
                    Fe: { low: 50, sufficient: [50, 200], high: 200, unit: 'ppm' },
                    Cu: { low: 5, sufficient: [5, 15], high: 15, unit: 'ppm' }
                }
            }
        };

        // Penn State Lab Info for tissue test submissions
        const PENN_STATE_LAB = {
            name: 'Penn State Agricultural Analytical Services Laboratory',
            address: '111 Tower Road',
            city: 'University Park',
            state: 'PA',
            zip: '16802',
            phone: '814-863-0841',
            email: 'aasl@psu.edu',
            website: 'https://agsci.psu.edu/aasl',
            costs: {
                regularAnalysis: 17,  // N, P, K, Ca, Mg
                withMicros: 23        // + Fe, Mn, Zn, Cu, B
            }
        };

        // Tissue Tests storage
        let tissueTests = JSON.parse(localStorage.getItem('tissueTests') || '[]');
        let pendingSamples = JSON.parse(localStorage.getItem('pendingTissueSamples') || '[]');

        // ============================================
        // SIDE-DRESSING SCHEDULES FOR HEAVY FEEDERS
        // Timing from transplant date for mid-season feeding
        // ============================================
        const SIDE_DRESSING_SCHEDULES = {
            // Tomatoes - Heavy feeders needing sustained nutrition
            tomato: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 14, // Days after transplant
                        name: 'Establishment Feed',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Root development' },
                            { key: 'kelpMeal', rate: 0.5, unit: 'lbs/100ft bed', purpose: 'Stress resistance' }
                        ],
                        notes: 'Light feeding to establish roots without pushing top growth'
                    },
                    {
                        timing: 35,
                        name: 'Pre-Bloom Boost',
                        amendments: [
                            { key: 'bloodMeal', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Vegetative growth' },
                            { key: 'boneMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Flower/fruit set' },
                            { key: 'potassiumSulfate', rate: 1, unit: 'lbs/100ft bed', purpose: 'Fruit quality' }
                        ],
                        notes: 'Prepare plant for heavy fruit load'
                    },
                    {
                        timing: 56,
                        name: 'First Fruit Set',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Fruit development' },
                            { key: 'magnesiumSulfate', rate: 0.5, unit: 'lbs/100ft bed', purpose: 'Chlorophyll production' }
                        ],
                        foliar: { product: 'Calcium chloride', rate: '2 tbsp/gal', purpose: 'Prevent blossom end rot' },
                        notes: 'Support heavy fruit production, prevent Ca deficiency'
                    },
                    {
                        timing: 77,
                        name: 'Mid-Season Maintenance',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Sustained N' },
                            { key: 'potassiumSulfate', rate: 1, unit: 'lbs/100ft bed', purpose: 'Continued fruiting' }
                        ],
                        notes: 'Maintain production through late season'
                    }
                ],
                commonDeficiencies: ['calcium', 'magnesium', 'potassium'],
                watchFor: 'Blossom end rot indicates Ca or water stress. Yellow older leaves = N or Mg.'
            },

            // Peppers - Similar to tomatoes but less demanding
            pepper: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 14,
                        name: 'Establishment Feed',
                        amendments: [
                            { key: 'fishMeal', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Root development' }
                        ],
                        notes: 'Peppers establish slowly - gentle feed'
                    },
                    {
                        timing: 42,
                        name: 'Pre-Bloom Boost',
                        amendments: [
                            { key: 'soybeanMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Balanced N' },
                            { key: 'boneMeal', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'P for fruiting' }
                        ],
                        notes: 'Support flower development'
                    },
                    {
                        timing: 63,
                        name: 'Fruit Load Support',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 1, unit: 'lbs/100ft bed', purpose: 'Fruit quality' },
                            { key: 'magnesiumSulfate', rate: 0.5, unit: 'lbs/100ft bed', purpose: 'Leaf health' }
                        ],
                        foliar: { product: 'Calcium chloride', rate: '2 tbsp/gal', purpose: 'BER prevention' },
                        notes: 'Peppers prone to BER - watch watering consistency'
                    }
                ],
                commonDeficiencies: ['calcium', 'magnesium'],
                watchFor: 'Blossom end rot, leaf curling (Ca). Interveinal yellowing (Mg).'
            },

            // Sweet Corn - Extreme N feeder
            sweetCorn: {
                feedingType: 'very_heavy',
                schedule: [
                    {
                        timing: 14,
                        name: 'V4 Stage Feed',
                        amendments: [
                            { key: 'bloodMeal', rate: 3, unit: 'lbs/100ft bed', purpose: 'Fast N boost' },
                            { key: 'potassiumSulfate', rate: 1, unit: 'lbs/100ft bed', purpose: 'Stalk strength' }
                        ],
                        notes: 'Critical timing - corn N demand increases rapidly'
                    },
                    {
                        timing: 35,
                        name: 'Pre-Tassel Feed',
                        amendments: [
                            { key: 'sodiumNitrate', rate: 1, unit: 'lbs/100ft bed', purpose: 'Quick N', warning: 'Emergency boost if needed' },
                            { key: 'soybeanMeal', rate: 3, unit: 'lbs/100ft bed', purpose: 'Sustained N' }
                        ],
                        notes: 'Highest N demand period - critical for ear development'
                    },
                    {
                        timing: 50,
                        name: 'Ear Fill Support',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Kernel fill' },
                            { key: 'zincSulfate', rate: 0.25, unit: 'lbs/100ft bed', purpose: 'Kernel development' }
                        ],
                        notes: 'Support kernel development'
                    }
                ],
                commonDeficiencies: ['nitrogen', 'zinc', 'potassium'],
                watchFor: 'Pale green V-shaped leaves = N. Purple stems = P. Striped leaves = Zn.'
            },

            // Broccoli/Cabbage/Cauliflower - Heavy feeders with B needs
            broccoli: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 14,
                        name: 'Post-Transplant Feed',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Vegetative growth' },
                            { key: 'borax', rate: 0.1, unit: 'lbs/100ft bed', purpose: 'Prevent hollow stem' }
                        ],
                        notes: 'Boron critical for brassicas - prevents hollow stem'
                    },
                    {
                        timing: 35,
                        name: 'Heading Boost',
                        amendments: [
                            { key: 'bloodMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Rapid head growth' },
                            { key: 'potassiumSulfate', rate: 1, unit: 'lbs/100ft bed', purpose: 'Head quality' }
                        ],
                        foliar: { product: 'Calcium + Boron', rate: 'per label', purpose: 'Head integrity' },
                        notes: 'Push head development - high N demand phase'
                    }
                ],
                commonDeficiencies: ['boron', 'calcium', 'nitrogen'],
                watchFor: 'Hollow stem (B). Brown head edges (Ca). Stunted heads (N).'
            },

            cabbage: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 14,
                        name: 'Post-Transplant Feed',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Leaf growth' },
                            { key: 'borax', rate: 0.1, unit: 'lbs/100ft bed', purpose: 'Prevent internal issues' }
                        ],
                        notes: 'Establish strong root system'
                    },
                    {
                        timing: 42,
                        name: 'Head Formation',
                        amendments: [
                            { key: 'soybeanMeal', rate: 2.5, unit: 'lbs/100ft bed', purpose: 'Sustained N' },
                            { key: 'potassiumSulfate', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Tight heads' }
                        ],
                        notes: 'Support tight head formation'
                    }
                ],
                commonDeficiencies: ['boron', 'nitrogen', 'calcium'],
                watchFor: 'Brown internal leaves (B). Loose heads (N or K). Tip burn (Ca).'
            },

            cauliflower: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 14,
                        name: 'Post-Transplant Feed',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Vegetative growth' },
                            { key: 'borax', rate: 0.15, unit: 'lbs/100ft bed', purpose: 'Curd quality' }
                        ],
                        notes: 'Cauliflower most sensitive to B deficiency'
                    },
                    {
                        timing: 35,
                        name: 'Pre-Curd Feed',
                        amendments: [
                            { key: 'bloodMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Push growth' },
                            { key: 'magnesiumSulfate', rate: 0.5, unit: 'lbs/100ft bed', purpose: 'White curd color' }
                        ],
                        notes: 'Prepare for curd formation'
                    },
                    {
                        timing: 50,
                        name: 'Curd Development',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Curd quality' }
                        ],
                        foliar: { product: 'Molybdenum solution', rate: '1/4 tsp/gal', purpose: 'Prevent whiptail' },
                        notes: 'Critical period - watch for browning, loose curds'
                    }
                ],
                commonDeficiencies: ['boron', 'molybdenum', 'calcium', 'magnesium'],
                watchFor: 'Brown curd (B). Whiptail/narrow leaves (Mo). Tip burn (Ca).'
            },

            // Celery - Extremely demanding
            celery: {
                feedingType: 'very_heavy',
                schedule: [
                    {
                        timing: 21,
                        name: 'Establishment Feed',
                        amendments: [
                            { key: 'fishMeal', rate: 3, unit: 'lbs/100ft bed', purpose: 'Strong starts' },
                            { key: 'borax', rate: 0.15, unit: 'lbs/100ft bed', purpose: 'Prevent black heart' },
                            { key: 'kelpMeal', rate: 1, unit: 'lbs/100ft bed', purpose: 'Trace minerals' }
                        ],
                        notes: 'Celery needs consistent, high nutrition from start'
                    },
                    {
                        timing: 42,
                        name: 'Growth Phase Feed',
                        amendments: [
                            { key: 'soybeanMeal', rate: 3, unit: 'lbs/100ft bed', purpose: 'Steady N' },
                            { key: 'potassiumSulfate', rate: 2, unit: 'lbs/100ft bed', purpose: 'Stalk quality' },
                            { key: 'magnesiumSulfate', rate: 1, unit: 'lbs/100ft bed', purpose: 'Green stalks' }
                        ],
                        notes: 'High demand phase - don\'t let it get hungry'
                    },
                    {
                        timing: 63,
                        name: 'Finishing Feed',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 2, unit: 'lbs/100ft bed', purpose: 'Crisp stalks' }
                        ],
                        foliar: { product: 'Calcium nitrate', rate: '2 tbsp/gal', purpose: 'Prevent blackheart' },
                        notes: 'Final push for quality - maintain even moisture'
                    }
                ],
                commonDeficiencies: ['boron', 'calcium', 'magnesium', 'nitrogen'],
                watchFor: 'Black heart (B or Ca). Yellow leaves (N or Mg). Hollow stalks (B).'
            },

            // Melons - Heavy K feeders
            melon: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 14,
                        name: 'Vine Establishment',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Vine growth' }
                        ],
                        notes: 'Establish strong vine before fruiting'
                    },
                    {
                        timing: 35,
                        name: 'Pre-Flower Feed',
                        amendments: [
                            { key: 'soybeanMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Flower production' },
                            { key: 'boneMeal', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Fruit set' }
                        ],
                        notes: 'Support abundant flowering'
                    },
                    {
                        timing: 50,
                        name: 'Fruit Development',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 2, unit: 'lbs/100ft bed', purpose: 'Sugar content' },
                            { key: 'magnesiumSulfate', rate: 0.5, unit: 'lbs/100ft bed', purpose: 'Leaf health' }
                        ],
                        notes: 'K critical for sweet melons - don\'t skimp'
                    }
                ],
                commonDeficiencies: ['potassium', 'magnesium', 'calcium'],
                watchFor: 'Bland flavor (K). Yellow older leaves (Mg). BER on fruit (Ca).'
            },

            watermelon: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 14,
                        name: 'Vine Establishment',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Vine growth' }
                        ],
                        notes: 'Watermelons need extensive vine before fruiting'
                    },
                    {
                        timing: 35,
                        name: 'Pre-Flower Feed',
                        amendments: [
                            { key: 'soybeanMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Vine support' },
                            { key: 'boneMeal', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Fruit set' }
                        ],
                        notes: 'Support fruit set'
                    },
                    {
                        timing: 56,
                        name: 'Fruit Sizing',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 2.5, unit: 'lbs/100ft bed', purpose: 'Sugar and size' }
                        ],
                        notes: 'K = sweetness. Reduce water slightly at this stage for concentration'
                    }
                ],
                commonDeficiencies: ['potassium', 'magnesium'],
                watchFor: 'White heart/bland taste (K). Yellow vines (Mg or N).'
            },

            // Potatoes - Heavy feeders with specific timing
            potato: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 21, // Days after emergence
                        name: 'Early Growth Feed',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Vegetative growth' }
                        ],
                        notes: 'Support early foliage development'
                    },
                    {
                        timing: 42,
                        name: 'Pre-Tuber Feed',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 2, unit: 'lbs/100ft bed', purpose: 'Tuber initiation' },
                            { key: 'soybeanMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Sustained N' }
                        ],
                        notes: 'Hill and feed - critical timing for tuber count'
                    },
                    {
                        timing: 60,
                        name: 'Tuber Bulking',
                        amendments: [
                            { key: 'potassiumSulfate', rate: 2, unit: 'lbs/100ft bed', purpose: 'Tuber size and quality' }
                        ],
                        notes: 'K critical for storage quality - avoid high N which delays maturity'
                    }
                ],
                commonDeficiencies: ['potassium', 'calcium', 'magnesium'],
                watchFor: 'Small tubers (K). Internal brown spots (Ca). Chlorosis (Mg).'
            },

            // Leeks - Long season, consistent feeding
            leek: {
                feedingType: 'heavy',
                schedule: [
                    {
                        timing: 21,
                        name: 'Post-Transplant Feed',
                        amendments: [
                            { key: 'fishMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Root establishment' }
                        ],
                        notes: 'Leeks are slow - be patient'
                    },
                    {
                        timing: 49,
                        name: 'Mid-Season Feed',
                        amendments: [
                            { key: 'soybeanMeal', rate: 2, unit: 'lbs/100ft bed', purpose: 'Steady growth' },
                            { key: 'potassiumSulfate', rate: 1, unit: 'lbs/100ft bed', purpose: 'Shaft quality' }
                        ],
                        notes: 'Hill as you feed to blanch shafts'
                    },
                    {
                        timing: 77,
                        name: 'Late Season Boost',
                        amendments: [
                            { key: 'bloodMeal', rate: 1.5, unit: 'lbs/100ft bed', purpose: 'Final push' }
                        ],
                        notes: 'Final feed for thick shafts'
                    }
                ],
                commonDeficiencies: ['nitrogen', 'potassium'],
                watchFor: 'Thin shafts (N). Yellow tips (K).'
            }
        };

        // Generate side-dressing tasks from planting date
        function generateSideDressingTasks(cropKey, plantingDate, fieldZone) {
            const schedule = SIDE_DRESSING_SCHEDULES[cropKey];
            if (!schedule) return [];

            const plantDate = new Date(plantingDate);
            const tasks = [];

            for (const feeding of schedule.schedule) {
                const feedDate = new Date(plantDate);
                feedDate.setDate(feedDate.getDate() + feeding.timing);

                tasks.push({
                    type: 'sidedress',
                    crop: cropKey,
                    cropName: CROP_NUTRITION[cropKey]?.name || cropKey,
                    fieldZone: fieldZone,
                    feedingName: feeding.name,
                    dueDate: feedDate.toISOString().split('T')[0],
                    daysFromPlanting: feeding.timing,
                    amendments: feeding.amendments,
                    foliar: feeding.foliar || null,
                    notes: feeding.notes,
                    status: 'pending'
                });
            }

            return tasks;
        }

        // ============================================
        // CROP NUTRIENT GROUPINGS - For Smart Field Planning
        // Crops with similar nutrient needs should be planted together
        // ============================================
        const NUTRIENT_GROUPS = {
            heavyFeeders: {
                name: 'Heavy Feeders',
                description: 'High N (100+ lbs/acre), high K demand. Require rich soil.',
                nRange: [100, 200],
                kRange: [200, 300],
                crops: ['tomato', 'pepper', 'eggplant', 'sweetCorn', 'celery', 'broccoli', 'cabbage', 'cauliflower', 'squashWinter', 'melon', 'watermelon', 'potato', 'leek'],
                color: '#ef4444', // red
                amendmentPriority: ['nitrogen', 'potassium', 'calcium']
            },
            moderateFeeders: {
                name: 'Moderate Feeders',
                description: 'Medium N (60-100 lbs/acre). Balanced nutrition.',
                nRange: [60, 100],
                kRange: [120, 200],
                crops: ['lettuce', 'spinach', 'kale', 'chard', 'arugula', 'carrot', 'beet', 'onion', 'garlic', 'cucumber', 'squashSummer', 'basil', 'parsley', 'turnip', 'kohlrabi'],
                color: '#f59e0b', // amber
                amendmentPriority: ['nitrogen', 'phosphorus', 'potassium']
            },
            lightFeeders: {
                name: 'Light Feeders',
                description: 'Low N (20-60 lbs/acre). Thrive in less rich soil.',
                nRange: [20, 60],
                kRange: [80, 160],
                crops: ['radish', 'parsnip', 'sweetPotato', 'herbs', 'oregano', 'thyme', 'rosemary', 'sage', 'cilantro', 'dill', 'fennel'],
                color: '#10b981', // green
                amendmentPriority: ['phosphorus', 'potassium', 'trace']
            },
            nitrogenFixers: {
                name: 'Nitrogen Fixers',
                description: 'Legumes that fix atmospheric N. Build soil fertility.',
                nRange: [0, 40],
                kRange: [60, 100],
                crops: ['beanBush', 'beanPole', 'pea', 'snapPea', 'lima', 'soybean'],
                color: '#8b5cf6', // purple
                amendmentPriority: ['phosphorus', 'potassium', 'calcium'],
                soilBuilder: true
            }
        };

        // ============================================
        // SEASON LENGTH CLASSIFICATIONS
        // For succession planting and field rotation planning
        // ============================================
        const SEASON_LENGTH = {
            quick: {
                name: 'Quick Crops',
                days: [21, 45],
                description: 'Ready in 3-6 weeks. Good for succession and interplanting.',
                crops: ['radish', 'arugula', 'lettuce', 'spinach', 'cilantro', 'dill', 'scallion', 'mustardGreens'],
                successionWeeks: 2, // Plant every 2 weeks
                color: '#06b6d4'
            },
            short: {
                name: 'Short Season',
                days: [45, 70],
                description: 'Ready in 6-10 weeks. Multiple plantings per season.',
                crops: ['beanBush', 'pea', 'snapPea', 'cucumber', 'squashSummer', 'beet', 'turnip', 'kohlrabi', 'bokChoy', 'basil'],
                successionWeeks: 3,
                color: '#22c55e'
            },
            medium: {
                name: 'Medium Season',
                days: [70, 100],
                description: 'Ready in 10-14 weeks. 1-2 plantings per season.',
                crops: ['carrot', 'broccoli', 'cabbage', 'cauliflower', 'kale', 'chard', 'onion', 'leek', 'pepper', 'eggplant', 'fennel', 'celeriac'],
                successionWeeks: 4,
                color: '#eab308'
            },
            long: {
                name: 'Long Season',
                days: [100, 150],
                description: 'Ready in 14-20 weeks. Single planting, full season.',
                crops: ['tomato', 'sweetCorn', 'squashWinter', 'pumpkin', 'melon', 'watermelon', 'potato', 'sweetPotato', 'celery', 'brusselsSprouts', 'parsnip', 'garlic'],
                successionWeeks: null,
                color: '#f97316'
            },
            perennial: {
                name: 'Perennial',
                days: [365, 3650],
                description: 'Multi-year crops. Harvest for 3-20+ years.',
                crops: ['asparagus', 'rhubarb'],
                successionWeeks: null,
                color: '#a855f7'
            }
        };

        // ============================================
        // NUTRIENT DEFICIENCY SYMPTOMS DATABASE
        // For AI photo analysis and visual diagnosis
        // ============================================
        const DEFICIENCY_SYMPTOMS = {
            nitrogen: {
                nutrient: 'Nitrogen (N)',
                mobility: 'mobile', // Moves from old leaves to new
                symptoms: [
                    'Overall pale green or yellow-green color (chlorosis)',
                    'Older (lower) leaves yellow first, then fall off',
                    'Stunted growth, thin stems',
                    'Small, pale leaves',
                    'Early maturity and reduced yield',
                    'Red/purple tints in stems (especially corn)'
                ],
                affectedArea: 'Lower/older leaves first (moves to new growth)',
                commonIn: ['Heavy feeders during rapid growth', 'After heavy rain leaching', 'Cold wet soils'],
                quickFix: [
                    { amendment: 'bloodMeal', rate: '3-5 lbs/100 sq ft', speed: 'fast' },
                    { amendment: 'fishMeal', rate: '5-10 lbs/100 sq ft', speed: 'medium_fast' },
                    { amendment: 'sodiumNitrate', rate: '1 lb/100 sq ft', speed: 'immediate', warning: 'Emergency only - leaches fast' }
                ],
                foliarOption: { product: 'Fish emulsion or kelp', rate: '2 tbsp/gal', frequency: 'weekly' },
                confusedWith: ['Sulfur deficiency (but S affects new leaves)', 'Root damage', 'Waterlogging']
            },
            phosphorus: {
                nutrient: 'Phosphorus (P)',
                mobility: 'mobile',
                symptoms: [
                    'Dark green leaves with purple/red undersides',
                    'Purple/bronze coloring on stems and leaf edges',
                    'Older leaves affected first',
                    'Very slow, stunted growth',
                    'Delayed maturity, poor fruit/seed development',
                    'Thin, weak stems'
                ],
                affectedArea: 'Lower/older leaves first, overall stunting',
                commonIn: ['Cold soils (P immobile when cold)', 'High pH soils', 'New gardens'],
                quickFix: [
                    { amendment: 'boneMeal', rate: '5-10 lbs/100 sq ft', speed: 'medium', note: 'Mix into root zone' },
                    { amendment: 'fishBoneMeal', rate: '3-5 lbs/100 sq ft', speed: 'medium' }
                ],
                foliarOption: { product: 'Liquid phosphorus (0-10-0)', rate: '1 tbsp/gal', frequency: 'every 2 weeks' },
                confusedWith: ['Cold damage (similar purple)', 'Nitrogen deficiency']
            },
            potassium: {
                nutrient: 'Potassium (K)',
                mobility: 'mobile',
                symptoms: [
                    'Brown scorching on leaf edges (marginal necrosis)',
                    'Older leaves show symptoms first',
                    'Curling or cupping of leaves',
                    'Weak stems, prone to lodging',
                    'Poor fruit quality, hollow stems',
                    'Increased disease susceptibility'
                ],
                affectedArea: 'Older leaf margins first, then spreads',
                commonIn: ['Sandy soils', 'After heavy yields', 'High-rainfall areas'],
                quickFix: [
                    { amendment: 'potassiumSulfate', rate: '2-4 lbs/100 sq ft', speed: 'fast' },
                    { amendment: 'woodAsh', rate: '5-10 lbs/100 sq ft', speed: 'fast', warning: 'Raises pH' },
                    { amendment: 'kMag', rate: '3-5 lbs/100 sq ft', speed: 'medium' }
                ],
                foliarOption: { product: 'Potassium sulfate solution', rate: '1 tbsp/gal', frequency: 'weekly' },
                confusedWith: ['Salt burn', 'Drought stress', 'Wind damage']
            },
            calcium: {
                nutrient: 'Calcium (Ca)',
                mobility: 'immobile', // Doesn't move from old to new
                symptoms: [
                    'Distorted, curled, or cupped new growth',
                    'Brown/dead tips on new leaves',
                    'Blossom end rot (tomatoes, peppers, squash)',
                    'Tip burn on lettuce, cabbage',
                    'Hollow stem in broccoli/cauliflower',
                    'Bitter pit in apples'
                ],
                affectedArea: 'New growth/tips affected (Ca immobile)',
                commonIn: ['Acidic soils', 'Drought stress', 'Inconsistent watering', 'High K or Mg soils'],
                quickFix: [
                    { amendment: 'gypsum', rate: '5-10 lbs/100 sq ft', speed: 'medium', note: 'Won\'t change pH' },
                    { amendment: 'calciumCarbonate', rate: '5 lbs/100 sq ft', speed: 'slow' }
                ],
                foliarOption: { product: 'Calcium chloride', rate: '2 tbsp/gal', frequency: 'weekly during fruit set' },
                confusedWith: ['Boron deficiency', 'Irregular watering']
            },
            magnesium: {
                nutrient: 'Magnesium (Mg)',
                mobility: 'mobile',
                symptoms: [
                    'Interveinal chlorosis on older leaves (veins stay green)',
                    'Yellow/bronze between leaf veins',
                    'Leaves may curl upward',
                    'Older leaves drop prematurely',
                    'Reduced fruit size'
                ],
                affectedArea: 'Older leaves first, classic interveinal pattern',
                commonIn: ['Sandy soils', 'High K soils', 'Acidic soils', 'Heavy rain areas'],
                quickFix: [
                    { amendment: 'magnesiumSulfate', rate: '1-2 lbs/100 sq ft', speed: 'immediate' },
                    { amendment: 'kMag', rate: '3-5 lbs/100 sq ft', speed: 'medium' }
                ],
                foliarOption: { product: 'Epsom salt', rate: '2 tbsp/gal', frequency: 'every 2 weeks' },
                confusedWith: ['Iron deficiency (but Fe affects new leaves)', 'Manganese deficiency']
            },
            sulfur: {
                nutrient: 'Sulfur (S)',
                mobility: 'immobile',
                symptoms: [
                    'Uniform yellowing of NEW leaves (unlike N)',
                    'Light green to yellow color throughout',
                    'Stunted growth',
                    'Thin, woody stems',
                    'Delayed maturity'
                ],
                affectedArea: 'New/young leaves first (S immobile)',
                commonIn: ['Low organic matter soils', 'Sandy soils', 'Far from industrial areas'],
                quickFix: [
                    { amendment: 'potassiumSulfate', rate: '2 lbs/100 sq ft', speed: 'fast' },
                    { amendment: 'gypsum', rate: '5 lbs/100 sq ft', speed: 'medium' },
                    { amendment: 'magnesiumSulfate', rate: '1 lb/100 sq ft', speed: 'immediate' }
                ],
                foliarOption: { product: 'Epsom salt', rate: '1 tbsp/gal', frequency: 'weekly' },
                confusedWith: ['Nitrogen deficiency (N affects old leaves first)']
            },
            iron: {
                nutrient: 'Iron (Fe)',
                mobility: 'immobile',
                symptoms: [
                    'Interveinal chlorosis on NEW leaves',
                    'Young leaves turn yellow/white with green veins',
                    'Severe: entire leaf turns white/yellow',
                    'Stunted new growth'
                ],
                affectedArea: 'New/young leaves first - classic pattern',
                commonIn: ['High pH soils (>7.0)', 'Waterlogged soils', 'High phosphorus', 'Cold soils'],
                quickFix: [
                    { amendment: 'ironSulfate', rate: '1-2 lbs/100 sq ft', speed: 'fast' }
                ],
                foliarOption: { product: 'Iron sulfate or chelated iron', rate: '1 oz/gal', frequency: 'weekly until green' },
                confusedWith: ['Manganese deficiency', 'Zinc deficiency']
            },
            manganese: {
                nutrient: 'Manganese (Mn)',
                mobility: 'immobile',
                symptoms: [
                    'Interveinal chlorosis on young leaves',
                    'Tan/gray spots in yellowed areas',
                    'Leaves may have speckled appearance',
                    'Similar to Fe but more spotty/speckled'
                ],
                affectedArea: 'New leaves, spotty pattern',
                commonIn: ['High pH soils', 'Organic soils', 'Sandy soils'],
                quickFix: [
                    { amendment: 'manganeseSulfate', rate: '0.5-1 lb/100 sq ft', speed: 'fast' }
                ],
                foliarOption: { product: 'Manganese sulfate', rate: '1 oz/gal', frequency: 'every 2 weeks' },
                confusedWith: ['Iron deficiency', 'Magnesium deficiency']
            },
            boron: {
                nutrient: 'Boron (B)',
                mobility: 'immobile',
                symptoms: [
                    'Distorted, thick, brittle new growth',
                    'Hollow or corky stems (celery, broccoli)',
                    'Brown, dead growing points',
                    'Cracked, corky fruit skin',
                    'Poor flower/fruit set',
                    'Internal cork in apples'
                ],
                affectedArea: 'Growing points, new leaves, stems, fruit',
                commonIn: ['Sandy soils', 'High pH', 'Drought conditions', 'High Ca soils'],
                quickFix: [
                    { amendment: 'borax', rate: '1-2 oz/100 sq ft', speed: 'fast', warning: 'CAREFUL - toxic in excess!' }
                ],
                foliarOption: { product: 'Solubor', rate: '1/2 tsp/gal', frequency: 'once or twice only' },
                confusedWith: ['Calcium deficiency', 'Herbicide damage']
            },
            zinc: {
                nutrient: 'Zinc (Zn)',
                mobility: 'immobile',
                symptoms: [
                    'Small, narrow leaves ("little leaf")',
                    'Shortened internodes (rosetting)',
                    'Interveinal chlorosis on young leaves',
                    'Mottled appearance',
                    'Delayed maturity'
                ],
                affectedArea: 'New growth, small distorted leaves',
                commonIn: ['High pH soils', 'High phosphorus', 'Cold soils', 'Sandy soils'],
                quickFix: [
                    { amendment: 'zincSulfate', rate: '0.5-1 lb/100 sq ft', speed: 'fast' }
                ],
                foliarOption: { product: 'Zinc sulfate', rate: '1 oz/gal', frequency: 'every 2 weeks' },
                confusedWith: ['Iron deficiency', 'Manganese deficiency']
            },
            copper: {
                nutrient: 'Copper (Cu)',
                mobility: 'immobile',
                symptoms: [
                    'Wilting of new growth',
                    'Light green/yellow new leaves',
                    'Dieback of shoot tips',
                    'Poor pollen viability',
                    'Gum pockets in fruit trees'
                ],
                affectedArea: 'New growth tips',
                commonIn: ['Organic/peaty soils', 'High pH', 'Sandy soils', 'High nitrogen'],
                quickFix: [
                    { amendment: 'copperSulfate', rate: '0.25-0.5 lb/100 sq ft', speed: 'fast', warning: 'Cu accumulates - use sparingly' }
                ],
                foliarOption: { product: 'Copper sulfate', rate: '1/4 oz/gal', frequency: 'once or twice max' },
                confusedWith: ['Drought stress', 'Boron deficiency']
            }
        };

        // Function to analyze symptoms and suggest likely deficiency
        function analyzeSymptoms(symptoms) {
            const scores = {};

            for (const [nutrient, data] of Object.entries(DEFICIENCY_SYMPTOMS)) {
                scores[nutrient] = 0;
                for (const symptom of symptoms) {
                    const symptomLower = symptom.toLowerCase();
                    for (const defSymptom of data.symptoms) {
                        if (defSymptom.toLowerCase().includes(symptomLower) ||
                            symptomLower.includes(defSymptom.toLowerCase().split(' ')[0])) {
                            scores[nutrient] += 10;
                        }
                    }
                    // Check affected area match
                    if (data.affectedArea.toLowerCase().includes(symptomLower)) {
                        scores[nutrient] += 5;
                    }
                }
            }

            // Sort by score descending
            const ranked = Object.entries(scores)
                .filter(([_, score]) => score > 0)
                .sort((a, b) => b[1] - a[1])
                .map(([nutrient, score]) => ({
                    nutrient,
                    score,
                    data: DEFICIENCY_SYMPTOMS[nutrient]
                }));

            return ranked;
        }

        // ============================================
        // FARM LEARNING DATABASE STRUCTURE
        // Core data structure for 40-year learning system
        // ============================================

        // Initialize Farm Learning System
        const FarmLearning = {
            // Version for future migrations
            version: '1.0.0',

            // Load all learning data from localStorage
            load: function() {
                return {
                    soilHistory: JSON.parse(localStorage.getItem('farmLearn_soilHistory') || '[]'),
                    amendmentHistory: JSON.parse(localStorage.getItem('farmLearn_amendmentHistory') || '[]'),
                    cropHistory: JSON.parse(localStorage.getItem('farmLearn_cropHistory') || '[]'),
                    yieldHistory: JSON.parse(localStorage.getItem('farmLearn_yieldHistory') || '[]'),
                    observations: JSON.parse(localStorage.getItem('farmLearn_observations') || '[]'),
                    fieldZones: JSON.parse(localStorage.getItem('farmLearn_fieldZones') || '[]'),
                    insights: JSON.parse(localStorage.getItem('farmLearn_insights') || '[]'),
                    microclimateData: JSON.parse(localStorage.getItem('farmLearn_microclimate') || '{}')
                };
            },

            // Save specific data type
            save: function(dataType, data) {
                localStorage.setItem(`farmLearn_${dataType}`, JSON.stringify(data));
                this.updateLastModified();
            },

            updateLastModified: function() {
                localStorage.setItem('farmLearn_lastModified', new Date().toISOString());
            },

            // Record a soil test with learning context
            recordSoilTest: function(test, fieldZone) {
                const data = this.load();
                const record = {
                    id: Date.now().toString(),
                    testId: test.id,
                    fieldZone: fieldZone,
                    location: test.sampleLocation,
                    date: test.testDate,
                    year: new Date(test.testDate).getFullYear(),
                    season: this.getSeason(test.testDate),
                    values: {
                        ph: test.ph,
                        cec: test.cec,
                        organicMatter: test.organicMatter,
                        caPct: test.caPct,
                        mgPct: test.mgPct,
                        kPct: test.kPct,
                        sulfur: test.sulfur,
                        phosphorus: test.phosphorus,
                        boron: test.boron,
                        iron: test.iron,
                        manganese: test.manganese,
                        copper: test.copper,
                        zinc: test.zinc
                    },
                    recordedAt: new Date().toISOString()
                };
                data.soilHistory.push(record);
                this.save('soilHistory', data.soilHistory);
                return record;
            },

            // Record an amendment application
            recordAmendment: function(amendment, fieldZone, actualAmounts) {
                const data = this.load();
                const record = {
                    id: Date.now().toString(),
                    fieldZone: fieldZone,
                    location: amendment.location,
                    date: amendment.applicationDate,
                    year: new Date(amendment.applicationDate).getFullYear(),
                    season: this.getSeason(amendment.applicationDate),
                    targetCrop: amendment.crop,
                    plannedAmounts: amendment.recommendations,
                    actualAmounts: actualAmounts || amendment.recommendations,
                    soilTestBefore: amendment.testId,
                    recordedAt: new Date().toISOString()
                };
                data.amendmentHistory.push(record);
                this.save('amendmentHistory', data.amendmentHistory);
                return record;
            },

            // Record crop planting
            recordCropPlanting: function(planting) {
                const data = this.load();
                const cropInfo = CROP_NUTRITION[planting.cropKey] || {};
                const record = {
                    id: Date.now().toString(),
                    cropKey: planting.cropKey,
                    cropName: cropInfo.name || planting.cropName,
                    variety: planting.variety,
                    fieldZone: planting.fieldZone,
                    location: planting.location,
                    plantDate: planting.plantDate,
                    expectedHarvest: planting.expectedHarvest,
                    area: planting.area,
                    areaUnit: planting.areaUnit,
                    seedSource: planting.seedSource,
                    nutrientGroup: this.getCropNutrientGroup(planting.cropKey),
                    seasonLength: this.getCropSeasonLength(planting.cropKey),
                    year: new Date(planting.plantDate).getFullYear(),
                    recordedAt: new Date().toISOString()
                };
                data.cropHistory.push(record);
                this.save('cropHistory', data.cropHistory);
                return record;
            },

            // Record harvest/yield data
            recordYield: function(yield_data) {
                const data = this.load();
                const record = {
                    id: Date.now().toString(),
                    cropHistoryId: yield_data.cropHistoryId,
                    cropKey: yield_data.cropKey,
                    cropName: yield_data.cropName,
                    fieldZone: yield_data.fieldZone,
                    location: yield_data.location,
                    harvestDate: yield_data.harvestDate,
                    quantity: yield_data.quantity,
                    unit: yield_data.unit,
                    quality: yield_data.quality, // 1-5 scale
                    qualityNotes: yield_data.qualityNotes,
                    marketValue: yield_data.marketValue,
                    issues: yield_data.issues, // pest, disease, weather, etc.
                    year: new Date(yield_data.harvestDate).getFullYear(),
                    recordedAt: new Date().toISOString()
                };
                data.yieldHistory.push(record);
                this.save('yieldHistory', data.yieldHistory);

                // Trigger learning analysis
                this.analyzeYieldCorrelations(record);
                return record;
            },

            // Record an observation (pest, disease, weather event, etc.)
            recordObservation: function(obs) {
                const data = this.load();
                const record = {
                    id: Date.now().toString(),
                    type: obs.type, // pest, disease, weather, soil, growth, other
                    fieldZone: obs.fieldZone,
                    location: obs.location,
                    date: obs.date,
                    description: obs.description,
                    severity: obs.severity, // 1-5
                    affectedCrops: obs.affectedCrops,
                    actionTaken: obs.actionTaken,
                    photos: obs.photos || [],
                    year: new Date(obs.date).getFullYear(),
                    recordedAt: new Date().toISOString()
                };
                data.observations.push(record);
                this.save('observations', data.observations);
                return record;
            },

            // Get season from date
            getSeason: function(dateStr) {
                const month = new Date(dateStr).getMonth();
                if (month >= 2 && month <= 4) return 'spring';
                if (month >= 5 && month <= 7) return 'summer';
                if (month >= 8 && month <= 10) return 'fall';
                return 'winter';
            },

            // Get nutrient group for a crop
            getCropNutrientGroup: function(cropKey) {
                for (const [groupKey, group] of Object.entries(NUTRIENT_GROUPS)) {
                    if (group.crops.includes(cropKey)) {
                        return groupKey;
                    }
                }
                return 'moderateFeeders'; // default
            },

            // Get season length for a crop
            getCropSeasonLength: function(cropKey) {
                for (const [lengthKey, length] of Object.entries(SEASON_LENGTH)) {
                    if (length.crops.includes(cropKey)) {
                        return lengthKey;
                    }
                }
                return 'medium'; // default
            },

            // ============================================
            // LEARNING & ANALYSIS FUNCTIONS
            // ============================================

            // Analyze yield correlations and generate insights
            analyzeYieldCorrelations: function(yieldRecord) {
                const data = this.load();

                // Find related soil test (closest before planting)
                const relatedCrop = data.cropHistory.find(c => c.id === yieldRecord.cropHistoryId);
                if (!relatedCrop) return;

                const relatedSoilTests = data.soilHistory
                    .filter(s => s.location === yieldRecord.location || s.fieldZone === yieldRecord.fieldZone)
                    .filter(s => new Date(s.date) <= new Date(relatedCrop.plantDate))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                const relatedAmendments = data.amendmentHistory
                    .filter(a => a.location === yieldRecord.location || a.fieldZone === yieldRecord.fieldZone)
                    .filter(a => {
                        const aDate = new Date(a.date);
                        const pDate = new Date(relatedCrop.plantDate);
                        // Amendments applied within 6 months before planting
                        return aDate <= pDate && (pDate - aDate) < 180 * 24 * 60 * 60 * 1000;
                    });

                // Create insight if we have enough data
                if (relatedSoilTests.length > 0) {
                    const insight = {
                        id: Date.now().toString(),
                        type: 'yield_correlation',
                        cropKey: yieldRecord.cropKey,
                        cropName: yieldRecord.cropName,
                        fieldZone: yieldRecord.fieldZone,
                        year: yieldRecord.year,
                        yieldQuality: yieldRecord.quality,
                        soilConditions: relatedSoilTests[0].values,
                        amendmentsApplied: relatedAmendments.map(a => a.plannedAmounts).flat(),
                        generatedAt: new Date().toISOString()
                    };

                    data.insights.push(insight);
                    this.save('insights', data.insights);
                }
            },

            // Get smart recommendations based on historical data
            getSmartRecommendations: function(fieldZone, plannedCrops, currentSoilTest) {
                const data = this.load();
                const recommendations = {
                    amendments: [],
                    timing: [],
                    warnings: [],
                    insights: []
                };

                // Get historical data for this field
                const fieldHistory = {
                    soilTests: data.soilHistory.filter(s => s.fieldZone === fieldZone || s.location === currentSoilTest.sampleLocation),
                    amendments: data.amendmentHistory.filter(a => a.fieldZone === fieldZone),
                    crops: data.cropHistory.filter(c => c.fieldZone === fieldZone),
                    yields: data.yieldHistory.filter(y => y.fieldZone === fieldZone)
                };

                // Analyze soil trend over time
                if (fieldHistory.soilTests.length >= 2) {
                    const trend = this.analyzeSoilTrend(fieldHistory.soilTests);
                    if (trend.improving.length > 0) {
                        recommendations.insights.push({
                            type: 'positive_trend',
                            message: `Soil improving: ${trend.improving.join(', ')} have increased over time.`
                        });
                    }
                    if (trend.declining.length > 0) {
                        recommendations.warnings.push({
                            type: 'negative_trend',
                            message: `Attention needed: ${trend.declining.join(', ')} are declining. Consider adjusting amendment strategy.`
                        });
                    }
                }

                // Analyze what worked well for similar crops
                if (plannedCrops.length > 0) {
                    for (const cropKey of plannedCrops) {
                        const cropYields = data.yieldHistory.filter(y => y.cropKey === cropKey && y.quality >= 4);
                        if (cropYields.length > 0) {
                            // Find what amendments were used for successful crops
                            const successfulAmendments = this.findSuccessfulAmendments(cropKey, data);
                            if (successfulAmendments.length > 0) {
                                recommendations.insights.push({
                                    type: 'historical_success',
                                    crop: cropKey,
                                    message: `Best results for ${CROP_NUTRITION[cropKey]?.name || cropKey} achieved with: ${successfulAmendments.join(', ')}`
                                });
                            }
                        }
                    }
                }

                // Check for nutrient group conflicts in planned crops
                const nutrientGroups = plannedCrops.map(c => this.getCropNutrientGroup(c));
                const uniqueGroups = [...new Set(nutrientGroups)];
                if (uniqueGroups.length > 2) {
                    recommendations.warnings.push({
                        type: 'nutrient_conflict',
                        message: `Planned crops have ${uniqueGroups.length} different nutrient needs. Consider grouping similar crops together.`
                    });
                }

                // Recommend based on dominant nutrient group
                const dominantGroup = this.getDominantNutrientGroup(plannedCrops);
                if (dominantGroup) {
                    recommendations.insights.push({
                        type: 'nutrient_group',
                        message: `Field is planned for ${NUTRIENT_GROUPS[dominantGroup].name}. ${NUTRIENT_GROUPS[dominantGroup].description}`
                    });
                    recommendations.amendments = NUTRIENT_GROUPS[dominantGroup].amendmentPriority;
                }

                return recommendations;
            },

            // Analyze soil trend from historical tests
            analyzeSoilTrend: function(soilTests) {
                const sorted = soilTests.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (sorted.length < 2) return { improving: [], declining: [], stable: [] };

                const first = sorted[0].values;
                const last = sorted[sorted.length - 1].values;

                const result = { improving: [], declining: [], stable: [] };

                const metrics = ['ph', 'organicMatter', 'caPct', 'mgPct', 'kPct'];
                const idealRanges = {
                    ph: [6.2, 7.0],
                    organicMatter: [3, 8],
                    caPct: [60, 70],
                    mgPct: [10, 20],
                    kPct: [2, 5]
                };

                for (const metric of metrics) {
                    if (first[metric] && last[metric]) {
                        const change = last[metric] - first[metric];
                        const changePercent = (change / first[metric]) * 100;

                        // Check if moving toward ideal range
                        const ideal = idealRanges[metric];
                        const firstInRange = first[metric] >= ideal[0] && first[metric] <= ideal[1];
                        const lastInRange = last[metric] >= ideal[0] && last[metric] <= ideal[1];

                        if (!firstInRange && lastInRange) {
                            result.improving.push(metric);
                        } else if (firstInRange && !lastInRange) {
                            result.declining.push(metric);
                        } else if (Math.abs(changePercent) < 5) {
                            result.stable.push(metric);
                        } else if (changePercent > 0 && last[metric] < ideal[1]) {
                            result.improving.push(metric);
                        } else if (changePercent < 0 && last[metric] > ideal[0]) {
                            result.improving.push(metric);
                        }
                    }
                }

                return result;
            },

            // Find amendments that correlated with successful yields
            findSuccessfulAmendments: function(cropKey, data) {
                const successfulYields = data.yieldHistory.filter(y => y.cropKey === cropKey && y.quality >= 4);
                const amendmentCounts = {};

                for (const yield_rec of successfulYields) {
                    // Find amendments applied before this crop
                    const relatedCrop = data.cropHistory.find(c => c.id === yield_rec.cropHistoryId);
                    if (!relatedCrop) continue;

                    const relatedAmendments = data.amendmentHistory.filter(a => {
                        return (a.location === yield_rec.location || a.fieldZone === yield_rec.fieldZone) &&
                               new Date(a.date) <= new Date(relatedCrop.plantDate);
                    });

                    for (const amendment of relatedAmendments) {
                        for (const rec of (amendment.plannedAmounts || [])) {
                            const material = rec.material;
                            amendmentCounts[material] = (amendmentCounts[material] || 0) + 1;
                        }
                    }
                }

                // Return top 3 most common amendments
                return Object.entries(amendmentCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([material]) => material);
            },

            // Get dominant nutrient group from planned crops
            getDominantNutrientGroup: function(cropKeys) {
                const groupCounts = {};
                for (const cropKey of cropKeys) {
                    const group = this.getCropNutrientGroup(cropKey);
                    groupCounts[group] = (groupCounts[group] || 0) + 1;
                }

                let maxGroup = null;
                let maxCount = 0;
                for (const [group, count] of Object.entries(groupCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        maxGroup = group;
                    }
                }
                return maxGroup;
            },

            // Get field zone statistics
            getFieldStats: function(fieldZone) {
                const data = this.load();
                const stats = {
                    totalSoilTests: data.soilHistory.filter(s => s.fieldZone === fieldZone).length,
                    totalAmendments: data.amendmentHistory.filter(a => a.fieldZone === fieldZone).length,
                    totalCrops: data.cropHistory.filter(c => c.fieldZone === fieldZone).length,
                    avgYieldQuality: 0,
                    topCrops: [],
                    soilTrend: null
                };

                const fieldYields = data.yieldHistory.filter(y => y.fieldZone === fieldZone);
                if (fieldYields.length > 0) {
                    stats.avgYieldQuality = fieldYields.reduce((sum, y) => sum + (y.quality || 0), 0) / fieldYields.length;

                    // Find top performing crops
                    const cropQuality = {};
                    for (const y of fieldYields) {
                        if (!cropQuality[y.cropKey]) {
                            cropQuality[y.cropKey] = { total: 0, count: 0 };
                        }
                        cropQuality[y.cropKey].total += y.quality || 0;
                        cropQuality[y.cropKey].count += 1;
                    }

                    stats.topCrops = Object.entries(cropQuality)
                        .map(([crop, data]) => ({ crop, avgQuality: data.total / data.count }))
                        .sort((a, b) => b.avgQuality - a.avgQuality)
                        .slice(0, 5);
                }

                const fieldSoilTests = data.soilHistory.filter(s => s.fieldZone === fieldZone);
                if (fieldSoilTests.length >= 2) {
                    stats.soilTrend = this.analyzeSoilTrend(fieldSoilTests);
                }

                return stats;
            },

            // Export all farm data for backup
            exportAllData: function() {
                const data = this.load();
                data.exportedAt = new Date().toISOString();
                data.version = this.version;
                return JSON.stringify(data, null, 2);
            },

            // Import farm data from backup
            importData: function(jsonString) {
                try {
                    const data = JSON.parse(jsonString);
                    if (data.soilHistory) this.save('soilHistory', data.soilHistory);
                    if (data.amendmentHistory) this.save('amendmentHistory', data.amendmentHistory);
                    if (data.cropHistory) this.save('cropHistory', data.cropHistory);
                    if (data.yieldHistory) this.save('yieldHistory', data.yieldHistory);
                    if (data.observations) this.save('observations', data.observations);
                    if (data.fieldZones) this.save('fieldZones', data.fieldZones);
                    if (data.insights) this.save('insights', data.insights);
                    if (data.microclimateData) this.save('microclimate', data.microclimateData);
                    return { success: true, message: 'Data imported successfully' };
                } catch (e) {
                    return { success: false, message: 'Failed to import: ' + e.message };
                }
            }
        };

        // ============================================
        // FIELD ZONE MANAGEMENT
        // ============================================

        const FieldZoneManager = {
            // Get all field zones
            getZones: function() {
                return JSON.parse(localStorage.getItem('farmLearn_fieldZones') || '[]');
            },

            // Save zones
            saveZones: function(zones) {
                localStorage.setItem('farmLearn_fieldZones', JSON.stringify(zones));
            },

            // Add a new zone
            addZone: function(zone) {
                const zones = this.getZones();
                const newZone = {
                    id: Date.now().toString(),
                    name: zone.name,
                    description: zone.description,
                    acreage: zone.acreage,
                    soilType: zone.soilType,
                    drainage: zone.drainage, // excellent, good, moderate, poor
                    sunExposure: zone.sunExposure, // full, partial, shade
                    microclimate: zone.microclimate, // notes about unique conditions
                    nutrientProfile: zone.nutrientProfile, // heavyFeeders, moderateFeeders, etc.
                    currentCrops: zone.currentCrops || [],
                    plannedCrops: zone.plannedCrops || [],
                    lastSoilTest: zone.lastSoilTest,
                    notes: zone.notes,
                    createdAt: new Date().toISOString()
                };
                zones.push(newZone);
                this.saveZones(zones);
                return newZone;
            },

            // Update a zone
            updateZone: function(zoneId, updates) {
                const zones = this.getZones();
                const idx = zones.findIndex(z => z.id === zoneId);
                if (idx !== -1) {
                    zones[idx] = { ...zones[idx], ...updates, updatedAt: new Date().toISOString() };
                    this.saveZones(zones);
                    return zones[idx];
                }
                return null;
            },

            // Delete a zone
            deleteZone: function(zoneId) {
                let zones = this.getZones();
                zones = zones.filter(z => z.id !== zoneId);
                this.saveZones(zones);
            },

            // Get zone by ID
            getZone: function(zoneId) {
                return this.getZones().find(z => z.id === zoneId);
            },

            // Get zones suitable for a nutrient group
            getZonesForNutrientGroup: function(nutrientGroup) {
                return this.getZones().filter(z => z.nutrientProfile === nutrientGroup);
            },

            // Suggest best zone for a crop
            suggestZoneForCrop: function(cropKey) {
                const nutrientGroup = FarmLearning.getCropNutrientGroup(cropKey);
                const zones = this.getZones();

                // First, find zones designated for this nutrient group
                const matchingZones = zones.filter(z => z.nutrientProfile === nutrientGroup);
                if (matchingZones.length > 0) {
                    return matchingZones;
                }

                // Otherwise, suggest based on soil conditions
                return zones;
            }
        };

        // ============================================
        // COMPREHENSIVE AMENDMENTS DATABASE
        // Sources: Steve Solomon, Ohio Earth Food, Advancing Eco Agriculture
        // Incorporates: Albrecht Method, Soil Food Web, Regenerative Agriculture
        // ============================================

        const AMENDMENTS_DATABASE = {
            // === LIME PRODUCTS (Calcium & pH Adjustment) ===
            limeProducts: {
                category: 'Lime & pH Adjustment',
                icon: 'fas fa-layer-group',
                items: {
                    agLime: {
                        name: 'Agricultural Lime (Hi-Cal)',
                        npk: '0-0-0',
                        Ca: 0.36, Mg: 0.02,
                        rate: '2000-8000 lbs/acre',
                        notes: 'Raises pH. Use when Ca% < 60%. Apply in fall.',
                        omri: true
                    },
                    dolomite: {
                        name: 'Dolomitic Lime',
                        npk: '0-0-0',
                        Ca: 0.22, Mg: 0.13,
                        rate: '2000-6000 lbs/acre',
                        notes: 'Use ONLY if Mg is deficient. Raises pH slowly.',
                        omri: true
                    },
                    calciumCarbonate: {
                        name: 'Calcium Carbonate (Pure)',
                        npk: '0-0-0',
                        Ca: 0.40,
                        rate: '1000-4000 lbs/acre',
                        notes: 'Finer grind than ag lime. Faster acting.',
                        omri: true
                    },
                    oysterShell: {
                        name: 'Oyster Shell Flour',
                        npk: '0-0-0',
                        Ca: 0.38, Mg: 0.005,
                        rate: '1000-3000 lbs/acre',
                        notes: 'Very slow release. Good for long-term soil building.',
                        omri: true
                    }
                }
            },

            // === GYPSUM & SULFUR PRODUCTS ===
            gypsumSulfur: {
                category: 'Gypsum & Sulfur',
                icon: 'fas fa-mountain',
                items: {
                    gypsum: {
                        name: 'Gypsum (Calcium Sulfate)',
                        npk: '0-0-0',
                        Ca: 0.205, S: 0.17,
                        rate: '500-2000 lbs/acre',
                        notes: 'Does NOT change pH. Use for Ca without pH change.',
                        omri: true
                    },
                    elementalSulfur: {
                        name: 'Elemental Sulfur',
                        npk: '0-0-0',
                        S: 0.90,
                        rate: '100-500 lbs/acre',
                        notes: 'Lowers pH. Max 100 lbs/acre at once. Needs soil biology to convert.',
                        omri: true
                    },
                    tigerSulfur: {
                        name: 'Tiger 90 Sulfur',
                        npk: '0-0-0',
                        S: 0.90,
                        rate: '100-300 lbs/acre',
                        notes: 'Pastilles for easier application. Slower acting.',
                        omri: false
                    }
                }
            },

            // === NITROGEN SOURCES (Organic) ===
            nitrogenSources: {
                category: 'Nitrogen Sources',
                icon: 'fas fa-leaf',
                items: {
                    featherMeal: {
                        name: 'Feather Meal',
                        npk: '12-0-0',
                        N: 0.12,
                        rate: '500-1500 lbs/acre',
                        notes: 'Very slow release (4+ months). Season-long N.',
                        omri: true
                    },
                    bloodMeal: {
                        name: 'Blood Meal',
                        npk: '12-0-0',
                        N: 0.12,
                        rate: '200-500 lbs/acre',
                        notes: 'Fast-acting. Can burn plants if overapplied.',
                        omri: true
                    },
                    soybeanMeal: {
                        name: 'Soybean Meal',
                        npk: '7-2-1',
                        N: 0.07, P: 0.02, K: 0.01,
                        rate: '500-1500 lbs/acre',
                        notes: 'Moderate release. Feeds soil biology well.',
                        omri: true
                    },
                    fishMeal: {
                        name: 'Fish Meal',
                        npk: '9-7-0',
                        N: 0.09, P: 0.07, Ca: 0.05,
                        rate: '200-800 lbs/acre',
                        notes: 'Fast-acting. Rich in trace minerals. May attract animals.',
                        omri: true
                    },
                    alfalfaMeal: {
                        name: 'Alfalfa Meal',
                        npk: '2.5-1-2',
                        N: 0.025, P: 0.01, K: 0.02,
                        rate: '500-1500 lbs/acre',
                        notes: 'Contains triacontanol growth hormone. Excellent for soil biology.',
                        omri: true
                    },
                    crabMeal: {
                        name: 'Crab Meal',
                        npk: '4-3-0',
                        N: 0.04, P: 0.03, Ca: 0.12,
                        rate: '500-1000 lbs/acre',
                        notes: 'High chitin content suppresses nematodes. Feeds beneficial fungi.',
                        omri: true
                    },
                    guidedNitrogen: {
                        name: 'Guided Nitrogen (Ohio Earth Food)',
                        npk: '12-0-0',
                        N: 0.12,
                        rate: '200-800 lbs/acre',
                        notes: 'Pelletized feather meal with kelp, humate, DE. Enhanced biology.',
                        omri: true,
                        source: 'Ohio Earth Food'
                    },
                    sodiumNitrate: {
                        name: 'Chilean Nitrate (16-0-0)',
                        npk: '16-0-0',
                        N: 0.16,
                        rate: '100-300 lbs/acre',
                        notes: 'Fast-acting. Organic but restricted in some certifications.',
                        omri: false
                    }
                }
            },

            // === PHOSPHORUS SOURCES ===
            phosphorusSources: {
                category: 'Phosphorus Sources',
                icon: 'fas fa-bone',
                items: {
                    boneMeal: {
                        name: 'Bone Meal (Steamed)',
                        npk: '3-15-0',
                        P: 0.15, Ca: 0.24,
                        rate: '200-600 lbs/acre',
                        notes: 'Slow release. Best at pH < 7. Contains calcium.',
                        omri: true
                    },
                    softRockPhosphate: {
                        name: 'Soft Rock Phosphate (Calphos)',
                        npk: '0-9-0',
                        P: 0.088, Ca: 0.20,
                        rate: '300-1000 lbs/acre',
                        notes: 'Best at pH < 7. Mix well - P is immobile. Contains Ca.',
                        omri: true
                    },
                    hardRockPhosphate: {
                        name: 'Hard Rock Phosphate',
                        npk: '0-3-0',
                        P: 0.03, Ca: 0.32,
                        rate: '500-2000 lbs/acre',
                        notes: 'Very slow release (3-5 years). Long-term soil building.',
                        omri: true
                    },
                    holoPhos: {
                        name: 'HoloPhos (AEA)',
                        npk: '0-25-0',
                        P: 0.25,
                        rate: '1-4 qts/acre foliar',
                        notes: 'Highly available phosphorus. Foliar or fertigation.',
                        omri: false,
                        source: 'Advancing Eco Agriculture'
                    },
                    fishBoneMeal: {
                        name: 'Fish Bone Meal',
                        npk: '3-18-0',
                        P: 0.18, Ca: 0.20, N: 0.03,
                        rate: '200-500 lbs/acre',
                        notes: 'More available than regular bone meal. Contains trace minerals.',
                        omri: true
                    }
                }
            },

            // === POTASSIUM SOURCES ===
            potassiumSources: {
                category: 'Potassium Sources',
                icon: 'fas fa-fire',
                items: {
                    potassiumSulfate: {
                        name: 'Sulfate of Potash (SOP 0-0-50)',
                        npk: '0-0-50',
                        K: 0.42, S: 0.17,
                        rate: '100-400 lbs/acre',
                        notes: 'Preferred K source. Does not build salts. Contains sulfur.',
                        omri: true
                    },
                    kMag: {
                        name: 'K-Mag / Sul-Po-Mag / Langbeinite',
                        npk: '0-0-22',
                        K: 0.22, Mg: 0.11, S: 0.22,
                        rate: '200-600 lbs/acre',
                        notes: 'Triple nutrient: K + Mg + S. Good when all three needed.',
                        omri: true
                    },
                    greensand: {
                        name: 'Greensand (Glauconite)',
                        npk: '0-0-3',
                        K: 0.03, Fe: 0.15,
                        rate: '500-2000 lbs/acre',
                        notes: 'Very slow release (10 years). Contains 32 trace minerals.',
                        omri: true
                    },
                    holoK: {
                        name: 'Holo-K (AEA)',
                        npk: '0-0-20',
                        K: 0.20,
                        rate: '1-4 qts/acre foliar',
                        notes: 'Fast-acting potassium. Enhances fruit durability and brix.',
                        omri: false,
                        source: 'Advancing Eco Agriculture'
                    },
                    woodAsh: {
                        name: 'Wood Ash (Hardwood)',
                        npk: '0-1-5',
                        K: 0.05, Ca: 0.20, Mg: 0.02,
                        rate: '500-1000 lbs/acre',
                        notes: 'Raises pH. Test before applying. Variable composition.',
                        omri: true
                    },
                    graniteMeal: {
                        name: 'Granite Meal',
                        npk: '0-0-3',
                        K: 0.03,
                        rate: '1000-3000 lbs/acre',
                        notes: 'Very slow release. Long-term soil building.',
                        omri: true
                    }
                }
            },

            // === MAGNESIUM SOURCES ===
            magnesiumSources: {
                category: 'Magnesium Sources',
                icon: 'fas fa-atom',
                items: {
                    magnesiumSulfate: {
                        name: 'Epsom Salt (Magnesium Sulfate)',
                        npk: '0-0-0',
                        Mg: 0.10, S: 0.13,
                        rate: '50-200 lbs/acre',
                        notes: 'Fast-acting. Max 10% of Mg target per year.',
                        omri: true
                    },
                    magnesiumOxide: {
                        name: 'Magnesium Oxide',
                        npk: '0-0-0',
                        Mg: 0.55,
                        rate: '50-200 lbs/acre',
                        notes: 'Concentrated Mg. Raises pH slightly.',
                        omri: true
                    }
                }
            },

            // === TRACE MINERALS / MICRONUTRIENTS ===
            traceMinerals: {
                category: 'Trace Minerals & Micronutrients',
                icon: 'fas fa-gem',
                items: {
                    azomite: {
                        name: 'Azomite',
                        npk: '0-0-0.2',
                        trace: true,
                        rate: '200-600 lbs/acre',
                        notes: 'Contains 70+ trace minerals. Volcanic origin. OMRI listed.',
                        omri: true,
                        source: 'Ohio Earth Food'
                    },
                    seaninetyPlus: {
                        name: 'Sea-90 Ocean Minerals',
                        npk: '0-0-0',
                        trace: true,
                        rate: '100-400 lbs/acre',
                        notes: 'Contains all 90 elements. Full-spectrum ocean minerals.',
                        omri: true
                    },
                    borax: {
                        name: 'Borax (20 Mule Team)',
                        npk: '0-0-0',
                        B: 0.11,
                        rate: '5-15 lbs/acre',
                        notes: 'Caution: Toxic in excess. Max 4 lbs B/acre. Critical for brassicas.',
                        omri: true
                    },
                    soluBor: {
                        name: 'Solubor (Boron 20%)',
                        npk: '0-0-0',
                        B: 0.20,
                        rate: '2-10 lbs/acre',
                        notes: 'Water soluble boron. Good for foliar application.',
                        omri: false
                    },
                    ironSulfate: {
                        name: 'Iron Sulfate (Ferrous)',
                        npk: '0-0-0',
                        Fe: 0.30, S: 0.18,
                        rate: '50-200 lbs/acre',
                        notes: 'Fast-acting iron. Also lowers pH slightly.',
                        omri: true
                    },
                    manganeseSulfate: {
                        name: 'Manganese Sulfate',
                        npk: '0-0-0',
                        Mn: 0.32, S: 0.19,
                        rate: '10-50 lbs/acre',
                        notes: 'Do not apply if pH < 5.7 (Mn toxicity risk).',
                        omri: true
                    },
                    copperSulfate: {
                        name: 'Copper Sulfate',
                        npk: '0-0-0',
                        Cu: 0.25, S: 0.125,
                        rate: '5-20 lbs/acre',
                        notes: 'Max 4 lbs Cu/acre. Handle carefully.',
                        omri: true
                    },
                    zincSulfate: {
                        name: 'Zinc Sulfate',
                        npk: '0-0-0',
                        Zn: 0.35, S: 0.17,
                        rate: '10-50 lbs/acre',
                        notes: 'Max 14 lbs Zn/acre. Mix well - Zn immobile.',
                        omri: true
                    },
                    microPak: {
                        name: 'MicroPak (AEA)',
                        npk: '0-0-0',
                        B: true, Fe: true, Mn: true, Cu: true, Zn: true, Co: true, Mo: true,
                        rate: '1-4 qts/acre',
                        notes: '8 chelated micronutrients in one package. Foliar or soil.',
                        omri: false,
                        source: 'Advancing Eco Agriculture'
                    },
                    reboundBoron: {
                        name: 'ReBound Boron (AEA)',
                        npk: '0-0-0',
                        B: 0.05,
                        rate: '1-2 qts/acre foliar',
                        notes: 'Chelated boron for maximum plant uptake.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    },
                    reboundZinc: {
                        name: 'ReBound Zinc (AEA)',
                        npk: '0-0-0',
                        Zn: 0.05,
                        rate: '1-2 qts/acre foliar',
                        notes: 'Organic chelated zinc for crops.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    },
                    reboundManganese: {
                        name: 'ReBound Manganese (AEA)',
                        npk: '0-0-0',
                        Mn: 0.05,
                        rate: '1-2 qts/acre foliar',
                        notes: 'Chelated manganese for photosynthesis support.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    },
                    reboundCopper: {
                        name: 'ReBound Copper (AEA)',
                        npk: '0-0-0',
                        Cu: 0.05,
                        rate: '0.5-2 qts/acre foliar',
                        notes: 'Organic chelated copper. Supports lignin production.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    },
                    reboundIron: {
                        name: 'ReBound Iron (AEA)',
                        npk: '0-0-0',
                        Fe: 0.05,
                        rate: '1-2 qts/acre foliar',
                        notes: 'Chelated iron for chlorophyll production.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    },
                    reboundMolybdenum: {
                        name: 'ReBound Molybdenum (AEA)',
                        npk: '0-0-0',
                        Mo: 0.01,
                        rate: '2-8 oz/acre foliar',
                        notes: 'Essential for nitrogen metabolism. Very small amounts needed.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    },
                    reboundCobalt: {
                        name: 'ReBound Cobalt (AEA)',
                        npk: '0-0-0',
                        Co: 0.01,
                        rate: '2-8 oz/acre foliar',
                        notes: 'Supports nitrogen fixation and vitamin B12 production.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    }
                }
            },

            // === KELP & SEAWEED PRODUCTS ===
            kelpProducts: {
                category: 'Kelp & Seaweed',
                icon: 'fas fa-water',
                items: {
                    kelpMeal: {
                        name: 'Kelp Meal (Ascophyllum)',
                        npk: '1-0-2',
                        N: 0.01, K: 0.02,
                        trace: true,
                        rate: '100-400 lbs/acre',
                        notes: 'Contains cytokinins, auxins, 60+ trace minerals. Stress tolerance.',
                        omri: true
                    },
                    liquidKelp: {
                        name: 'Liquid Kelp Extract',
                        npk: '0-0-1',
                        K: 0.01,
                        trace: true,
                        rate: '1-4 qts/acre',
                        notes: 'Concentrated plant hormones. Excellent foliar. Stress recovery.',
                        omri: true
                    },
                    kelpItPowder: {
                        name: 'Kelp-It Soluble Powder (Fedco)',
                        npk: '0-0-18',
                        K: 0.18,
                        trace: true,
                        rate: '1-5 lbs/acre',
                        notes: 'Concentrated soluble kelp. Drench or foliar.',
                        omri: true,
                        source: 'Fedco Seeds'
                    }
                }
            },

            // === HUMATES & CARBON SOURCES ===
            humates: {
                category: 'Humates & Carbon',
                icon: 'fas fa-circle',
                items: {
                    humicAcid: {
                        name: 'Humic Acid (Granular)',
                        npk: '0-0-0',
                        rate: '50-200 lbs/acre',
                        notes: 'Improves nutrient uptake, CEC, water holding. Feed for biology.',
                        omri: true
                    },
                    fulvicAcid: {
                        name: 'Fulvic Acid (Liquid)',
                        npk: '0-0-0',
                        rate: '1-4 qts/acre',
                        notes: 'Chelates nutrients for plant uptake. Excellent with foliar.',
                        omri: true
                    },
                    humaCarb: {
                        name: 'HumaCarb 2.0 (AEA)',
                        npk: '0-0-0',
                        rate: '1-4 qts/acre',
                        notes: 'Stabilizes nutrients. Improves fertilizer efficiency 15-30%.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    },
                    biochar: {
                        name: 'Biochar',
                        npk: '0-0-0',
                        rate: '500-2000 lbs/acre',
                        notes: 'Long-term carbon. Habitat for microbes. Best charged with compost.',
                        omri: true
                    }
                }
            },

            // === BIOLOGICAL PRODUCTS (Soil Food Web) ===
            biologicals: {
                category: 'Biological Products (Living Soil)',
                icon: 'fas fa-bacteria',
                items: {
                    wormCastings: {
                        name: 'Worm Castings (Vermicompost)',
                        npk: '1-0-0',
                        N: 0.01,
                        rate: '200-1000 lbs/acre',
                        notes: 'Excellent biology. Contains bacteria, fungi, protozoa. Humic acids.',
                        omri: true,
                        source: 'Ohio Earth Food'
                    },
                    compostTea: {
                        name: 'Actively Aerated Compost Tea (AACT)',
                        npk: 'variable',
                        rate: '5-20 gal/acre',
                        notes: 'Elaine Ingham method. Brew 24-36 hours. Apply immediately.',
                        omri: true,
                        soilFoodWeb: true
                    },
                    fungalCompost: {
                        name: 'Fungal-Dominated Compost',
                        npk: 'variable',
                        rate: '1-4 tons/acre',
                        notes: 'High C:N woody materials. Best for perennials, trees, shrubs.',
                        omri: true,
                        soilFoodWeb: true
                    },
                    bacterialCompost: {
                        name: 'Bacterial-Dominated Compost',
                        npk: 'variable',
                        rate: '1-4 tons/acre',
                        notes: 'Green materials, manure. Best for annuals, vegetables.',
                        omri: true,
                        soilFoodWeb: true
                    },
                    bioGenesis: {
                        name: 'BioGenesis NP (AEA)',
                        npk: '0-0-0',
                        rate: '1-2 gal/acre',
                        notes: 'Soil inoculant. Restores soil microbiology. Multiple species.',
                        omri: false,
                        source: 'Advancing Eco Agriculture'
                    },
                    bioDigester: {
                        name: 'BioDigester (AEA)',
                        npk: '0-0-0',
                        rate: '1-2 gal/acre',
                        notes: 'Competitive exclusion of pathogens. Disease suppression.',
                        omri: false,
                        source: 'Advancing Eco Agriculture'
                    },
                    mycorrhizae: {
                        name: 'Mycorrhizal Fungi Inoculant',
                        npk: '0-0-0',
                        rate: 'Per label',
                        notes: 'Apply at planting. Extends root system. P & water uptake.',
                        omri: true
                    },
                    micro5000: {
                        name: 'Micro 5000 Organic (AEA)',
                        npk: '0-0-0',
                        rate: '1-2 qts/acre',
                        notes: 'Biologically-enhanced foliar for organic growers.',
                        omri: true,
                        source: 'Advancing Eco Agriculture'
                    }
                }
            },

            // === COMPLETE BLENDS ===
            completeBlends: {
                category: 'Complete Fertilizer Blends',
                icon: 'fas fa-box',
                items: {
                    reVitaPro: {
                        name: 'Re-Vita Pro 5-4-5 (Ohio Earth Food)',
                        npk: '5-4-5',
                        N: 0.05, P: 0.04, K: 0.05,
                        rate: '500-1500 lbs/acre',
                        notes: 'Complete organic fertilizer. Commercial grower blend.',
                        omri: true,
                        source: 'Ohio Earth Food'
                    },
                    nutriVeg: {
                        name: 'NutriVeg 5-4-4 (Fedco)',
                        npk: '5-4-4',
                        N: 0.05, P: 0.04, K: 0.04, Ca: 0.05,
                        rate: '500-1500 lbs/acre',
                        notes: 'All-purpose blend for vegetables, trees, shrubs.',
                        omri: true,
                        source: 'Fedco Seeds'
                    },
                    accelerate: {
                        name: 'Accelerate (AEA)',
                        npk: '0-0-0',
                        rate: '1-2 qts/acre',
                        notes: 'Nutritional support for flowering and fruiting.',
                        omri: false,
                        source: 'Advancing Eco Agriculture'
                    },
                    fishHydrolysate: {
                        name: 'Fish Hydrolysate (Neptune\'s)',
                        npk: '2-4-1',
                        N: 0.02, P: 0.04, K: 0.01,
                        rate: '1-4 gal/acre',
                        notes: 'Cold-processed. Retains amino acids, enzymes. Feeds biology.',
                        omri: true
                    },
                    monsterPlantMojo: {
                        name: 'Monster Plant Mojo (Fedco)',
                        npk: '4-4-0.5',
                        N: 0.04, P: 0.04, K: 0.005,
                        rate: '1-4 gal/acre',
                        notes: 'Fish hydrolysate, kelp, humic/fulvic acids combined.',
                        omri: true,
                        source: 'Fedco Seeds'
                    }
                }
            },

            // === SPECIALTY PRODUCTS ===
            specialty: {
                category: 'Specialty & Crop Protection',
                icon: 'fas fa-shield-alt',
                items: {
                    surroundWP: {
                        name: 'Surround WP (Kaolin Clay)',
                        npk: '0-0-0',
                        rate: '25-50 lbs/acre',
                        notes: 'Particle film pest deterrent. Heat stress protection.',
                        omri: true,
                        source: 'Ohio Earth Food'
                    },
                    diatomaceousEarth: {
                        name: 'Diatomaceous Earth (Food Grade)',
                        npk: '0-0-0',
                        Si: 0.85,
                        rate: '50-200 lbs/acre',
                        notes: 'Silicon source. Pest control. Improves plant structure.',
                        omri: true
                    },
                    silica: {
                        name: 'Potassium Silicate',
                        npk: '0-0-0',
                        Si: 0.20, K: 0.10,
                        rate: '1-4 qts/acre',
                        notes: 'Strengthens cell walls. Disease resistance. Heat tolerance.',
                        omri: true
                    },
                    redmondSalt: {
                        name: 'Redmond Trace Mineral Salt',
                        npk: '0-0-0',
                        rate: '25-150 lbs/acre soil or 3.5 lb/acre foliar',
                        notes: '93% NaCl + 60+ trace minerals. Improves soil conductivity, stimulates microbes.',
                        omri: true,
                        source: 'Redmond Agriculture'
                    },
                    granularBoron: {
                        name: 'Granular Boron (14.3% B)',
                        npk: '0-0-0',
                        B: 0.143,
                        rate: '1-3 lbs/acre',
                        notes: 'Slower release than Solubor. Broadcast application for B deficiency.',
                        omri: true,
                        source: 'Ohio Earth Food'
                    }
                }
            }
        };

        // ============================================
        // IPM PEST CONTROL PRODUCTS DATABASE
        // OMRI-Listed products for organic pest management
        // Sources: Product labels, ARBICO Organics, extension research
        // ============================================
        const IPM_PEST_PRODUCTS = {
            // Insect Growth Regulators / Antifeedants
            azaguard: {
                name: 'AzaGuard',
                activeIngredient: '3% Azadirachtin',
                manufacturer: 'BioSafe Systems',
                category: 'igr',
                omriListed: true,
                mode: 'Insect growth regulator, antifeedant',
                targets: ['Aphids', 'Whiteflies', 'Thrips', 'Caterpillars', 'Beetles', 'Fungus gnats', 'Leafminers'],
                ratePerAcre: '8-21 fl oz',
                ratePerGallon: '1-2.5 tsp (0.16-0.42 oz)',
                rei: '4 hours',
                phi: '0 days',
                beeToxicity: 'Low - spray in evening',
                notes: 'Exempt from tolerances. IGR disrupts molting. Apply early in pest cycle.',
                costEstimate: 145
            },
            neemOil: {
                name: 'Neem Oil (Cold Pressed)',
                activeIngredient: 'Azadirachtin + Fatty Acids',
                manufacturer: 'Various',
                category: 'botanical',
                omriListed: true,
                mode: 'Antifeedant, repellent, suffocant',
                targets: ['Aphids', 'Mites', 'Scale', 'Whiteflies', 'Mealybugs'],
                ratePerAcre: '1-2 gal',
                ratePerGallon: '1-2 oz',
                rei: '4 hours',
                phi: '0 days',
                beeToxicity: 'Low - avoid blooms',
                notes: 'Also has fungicidal properties. Best for soft-bodied insects.',
                costEstimate: 35
            },
            // Spinosad Products
            entrustSC: {
                name: 'Entrust SC',
                activeIngredient: '22.5% Spinosad',
                manufacturer: 'Corteva (Dow)',
                category: 'spinosyn',
                omriListed: true,
                mode: 'Contact + ingestion, nervous system',
                targets: ['Caterpillars', 'Colorado potato beetle', 'Flea beetles', 'Thrips', 'Leafminers', 'Spotted wing drosophila'],
                ratePerAcre: '1.5-10 fl oz',
                ratePerGallon: '0.5-1 tsp (for small areas)',
                rei: '4 hours',
                phi: '1-7 days (crop dependent)',
                beeToxicity: 'HIGH when wet - apply evening, allow to dry',
                notes: 'Max 2 consecutive applications, then rotate. IRAC Group 5.',
                costEstimate: 280
            },
            // Pyrethrin Products
            pyganic: {
                name: 'PyGanic Specialty (5%)',
                activeIngredient: '5% Pyrethrins',
                manufacturer: 'MGK',
                category: 'pyrethrin',
                omriListed: true,
                mode: 'Contact knockdown, nervous system',
                targets: ['Aphids', 'Beetles', 'Caterpillars', 'Flies', 'Thrips', 'Whiteflies', 'Squash bugs'],
                ratePerAcre: '4.5-16 fl oz',
                ratePerGallon: '0.25-0.5 oz',
                rei: '12 hours',
                phi: '0 days',
                beeToxicity: 'HIGH - apply evening only',
                notes: 'Fast knockdown, short residual. Use as rescue treatment. No resistance.',
                costEstimate: 180
            },
            // Bacillus thuringiensis
            btKurstaki: {
                name: 'Bt (DiPel/Thuricide)',
                activeIngredient: 'Bacillus thuringiensis kurstaki',
                manufacturer: 'Various',
                category: 'biological',
                omriListed: true,
                mode: 'Stomach poison (caterpillars only)',
                targets: ['Cabbage looper', 'Imported cabbageworm', 'Diamondback moth', 'Tomato hornworm', 'Corn earworm', 'Armyworms'],
                ratePerAcre: '0.5-2 lb (WP) or 1-2 qt (liquid)',
                ratePerGallon: '1-2 tsp',
                rei: '4 hours',
                phi: '0 days',
                beeToxicity: 'Safe - does not affect bees',
                notes: 'Only affects caterpillars. Apply to small larvae. UV degrades in 1-3 days.',
                costEstimate: 45
            },
            // Insecticidal Soap
            mPede: {
                name: 'M-Pede',
                activeIngredient: 'Potassium salts of fatty acids (49%)',
                manufacturer: 'Gowan Company',
                category: 'soap',
                omriListed: true,
                mode: 'Contact - disrupts cell membranes',
                targets: ['Aphids', 'Whiteflies', 'Mites', 'Mealybugs', 'Scale crawlers', 'Thrips'],
                ratePerAcre: '1-2 gal (2% solution)',
                ratePerGallon: '2.5 oz (2% solution)',
                rei: '12 hours',
                phi: '0 days',
                beeToxicity: 'Low - safe when dry',
                notes: 'Must contact pest directly. Also controls powdery mildew. Good tank mix partner.',
                costEstimate: 55
            },
            // Beauveria bassiana
            botanigard: {
                name: 'BotaniGard 22WP',
                activeIngredient: 'Beauveria bassiana strain GHA',
                manufacturer: 'BioWorks',
                category: 'fungal',
                omriListed: true,
                mode: 'Fungal infection - spores penetrate cuticle',
                targets: ['Whiteflies', 'Aphids', 'Thrips', 'Mealybugs', 'Psyllids'],
                ratePerAcre: '0.5-2 lb per 100 gal',
                ratePerGallon: '0.5-1 tsp per gal',
                rei: '4 hours',
                phi: '0 days',
                beeToxicity: 'Safe - does not affect bees',
                notes: 'Takes 7-10 days to kill. Apply 2-3x at 3-5 day intervals. Avoid tank mixing with fungicides.',
                costEstimate: 85
            },
            // Slug/Snail Control
            sluggo: {
                name: 'Sluggo',
                activeIngredient: '1% Iron Phosphate',
                manufacturer: 'Monterey/Neudorff',
                category: 'molluscicide',
                omriListed: true,
                mode: 'Stomach poison - stops feeding immediately',
                targets: ['Slugs', 'Snails'],
                ratePerAcre: '20-44 lb',
                ratePer1000sqft: '0.5-1 lb',
                rei: 'None',
                phi: '0 days',
                beeToxicity: 'Safe - no effect on beneficials',
                notes: 'Scatter evenly, do not pile. Apply evening. Safe around pets and wildlife.',
                costEstimate: 25
            },
            // Spreader-Sticker
            nuFilmP: {
                name: 'Nu Film P',
                activeIngredient: 'Poly-1-p-menthene (96%)',
                manufacturer: 'Miller Chemical',
                category: 'adjuvant',
                omriListed: true,
                mode: 'Spreader-sticker, UV protectant',
                targets: ['Improves coverage and persistence of other products'],
                ratePerAcre: '4-8 oz per 100 gal',
                ratePerGallon: '0.25-0.5 tsp',
                rei: 'None',
                phi: '0 days',
                beeToxicity: 'N/A',
                notes: 'Extends Bt and other product efficacy. Pinene-based, natural origin.',
                costEstimate: 40
            }
        };

        // ============================================
        // DISEASE CONTROL BIOFUNGICIDES DATABASE
        // OMRI-Listed products for organic disease management
        // ============================================
        const DISEASE_CONTROL_PRODUCTS = {
            regalia: {
                name: 'Regalia CG',
                activeIngredient: 'Reynoutria sachalinensis extract (5%)',
                manufacturer: 'Pro Farm Group (Marrone Bio)',
                category: 'plant_defense',
                omriListed: true,
                mode: 'Induces systemic acquired resistance (ISR/SAR)',
                targets: ['Powdery mildew', 'Botrytis', 'Bacterial spot', 'Downy mildew', 'Anthracnose', 'Pythium', 'Phytophthora'],
                ratePerAcre: '1-4 qt',
                ratePerGallon: '1-2.5 tbsp',
                rei: '4 hours',
                phi: '0 days',
                interval: '7 days preventive',
                notes: 'Apply BEFORE disease appears. Boosts plant immunity. Excellent tank mix partner.',
                costEstimate: 165
            },
            serenadeASO: {
                name: 'Serenade ASO',
                activeIngredient: 'Bacillus subtilis strain QST 713',
                manufacturer: 'Bayer CropScience',
                category: 'biological',
                omriListed: true,
                mode: 'Competitive exclusion + lipopeptides',
                targets: ['Botrytis', 'Fire blight', 'Powdery mildew', 'Bacterial spot', 'Sclerotinia', 'Pythium', 'Rhizoctonia'],
                ratePerAcre: '2-6 qt',
                ratePerGallon: '1-2 oz',
                rei: '4 hours',
                phi: '0 days',
                interval: '7-10 days',
                notes: 'Safe same day of harvest. Colonizes leaf surface. Works best preventively.',
                costEstimate: 75
            },
            cease: {
                name: 'Cease',
                activeIngredient: 'Bacillus subtilis strain QST 713',
                manufacturer: 'BioWorks',
                category: 'biological',
                omriListed: true,
                mode: 'Competitive exclusion + lipopeptides',
                targets: ['Botrytis', 'Powdery mildew', 'Bacterial leaf spot', 'Anthracnose'],
                ratePerAcre: '4-8 qt per 100 gal',
                ratePerGallon: '2-4 oz',
                rei: '4 hours',
                phi: '0 days',
                interval: '7-14 days',
                notes: 'Same active as Serenade. Greenhouse-focused formulation.',
                costEstimate: 80
            },
            stargus: {
                name: 'Stargus',
                activeIngredient: 'Bacillus amyloliquefaciens strain F727',
                manufacturer: 'Pro Farm Group (Marrone Bio)',
                category: 'biological',
                omriListed: true,
                mode: 'Colonizes surfaces, ISR induction, antibiosis',
                targets: ['Downy mildew', 'Botrytis', 'Fusarium', 'Rhizoctonia', 'White mold', 'Bacterial diseases'],
                ratePerAcre: '0.5-4 qt foliar, 2-4 qt soil',
                ratePerGallon: '1-2 oz',
                rei: '4 hours',
                phi: '0 days',
                interval: '7-10 days',
                notes: 'Foliar + soil applications. Strong against downy mildew.',
                costEstimate: 125
            },
            nucop50: {
                name: 'NuCop 50 WP',
                activeIngredient: 'Copper hydroxide (77%)',
                manufacturer: 'Albaugh',
                category: 'copper',
                omriListed: true,
                mode: 'Contact fungicide/bactericide',
                targets: ['Bacterial spot', 'Bacterial speck', 'Early blight', 'Late blight', 'Downy mildew', 'Angular leaf spot'],
                ratePerAcre: '1-3 lb',
                ratePerGallon: '1-2 tbsp',
                rei: '24 hours',
                phi: '0 days',
                interval: '7-14 days',
                notes: 'Do not exceed 12 lb copper/acre/season. Can cause phytotoxicity in cool wet weather.',
                costEstimate: 35
            }
        };

        // ============================================
        // MANDATORY IPM PROTOCOLS - HARD-WIRED SPRAY PROGRAMS
        // These crops REQUIRE automatic spray schedules starting DAY OF GERMINATION
        // This is NON-NEGOTIABLE - flea beetles and leaf miners will destroy these crops
        // ============================================
        const MANDATORY_IPM_PROTOCOLS = {
            // BRASSICA BABY GREENS - FLEA BEETLES
            // These crops are vectors for flea beetle damage - MUST spray day of germination
            fleaBeetleProgram: {
                name: 'Flea Beetle Emergency Protocol',
                targetPest: 'Flea Beetles (Phyllotreta spp.)',
                severity: 'CRITICAL',
                reason: 'Baby greens are destroyed within 24-48 hours of flea beetle infestation. Cotyledons are especially vulnerable.',
                triggerCrops: [
                    'Petite Kale Mix', 'Summer Petite Kale Mix',
                    'Something Fresh Mix',
                    'Arugula', 'Wild Arugula', 'Sylvetta',
                    'Esmee', 'Bellezia',
                    'Mizuna', 'Mustard', 'Giant Red',
                    'Cress', 'Curly', 'Persian'
                ],
                cropFamily: 'Brassicaceae',
                schedule: [
                    {
                        day: 0,
                        dayLabel: 'GERMINATION DAY',
                        action: 'MANDATORY SPRAY',
                        products: ['entrustSC', 'pyganic'],
                        primaryProduct: 'entrustSC',
                        rate: 'Entrust SC: 6 fl oz/acre or PyGanic: 8 oz/acre',
                        notes: 'Apply in evening. This is NON-NEGOTIABLE.',
                        timing: 'Evening spray (after 6pm for bee safety)'
                    },
                    {
                        day: 3,
                        dayLabel: 'Day 3',
                        action: 'Follow-up spray',
                        products: ['azaguard'],
                        primaryProduct: 'azaguard',
                        rate: 'AzaGuard: 16 fl oz/acre',
                        notes: 'IGR to interrupt flea beetle development',
                        timing: 'Evening preferred'
                    },
                    {
                        day: 7,
                        dayLabel: 'Day 7',
                        action: 'Rotation spray',
                        products: ['entrustSC', 'pyganic'],
                        primaryProduct: 'pyganic',
                        rate: 'PyGanic: 8-12 oz/acre (rotate from Entrust)',
                        notes: 'Switch to PyGanic to rotate IRAC groups',
                        timing: 'Evening spray'
                    },
                    {
                        day: 10,
                        dayLabel: 'Day 10',
                        action: 'Maintenance spray',
                        products: ['azaguard', 'neemOil'],
                        primaryProduct: 'azaguard',
                        rate: 'AzaGuard: 16 fl oz/acre',
                        notes: 'Continue IGR pressure until canopy closes',
                        timing: 'Evening preferred'
                    },
                    {
                        day: 14,
                        dayLabel: 'Day 14',
                        action: 'Assessment spray',
                        products: ['entrustSC'],
                        primaryProduct: 'entrustSC',
                        rate: 'Entrust SC: 6 fl oz/acre (if pressure continues)',
                        notes: 'Scout first. May skip if no flea beetles visible.',
                        timing: 'Evening spray'
                    }
                ],
                rowCoverAlternative: 'If using Proteknet or similar insect netting from Day 0, spray schedule can be reduced. However, any gaps = spray immediately.',
                costPerBed: 'Approximately $2-4/bed for full protocol',
                warnings: [
                    'DO NOT SKIP DAY 0 SPRAY - This is the most critical application',
                    'Flea beetles emerge from soil - they are already present',
                    'Warm weather (>70Â°F) increases flea beetle activity dramatically',
                    'Evening application protects bees and improves efficacy'
                ]
            },

            // SPINACH - LEAF MINERS
            // Leaf miners (Liriomyza spp.) will make spinach unsellable
            leafMinerProgram: {
                name: 'Leaf Miner Prevention Protocol',
                targetPest: 'Leaf Miners (Liriomyza spp., Pegomya hyoscyami)',
                severity: 'CRITICAL',
                reason: 'Leaf miner damage is irreversible - tunneling destroys leaf tissue and makes produce unsellable. Prevention is the ONLY option.',
                triggerCrops: [
                    'Spinach', 'Baby Spinach',
                    'Kolibri', 'Seaside', 'Space', 'Gazelle',
                    'Lakeside', 'Winter Bloomsdale',
                    'Yuma', 'Pawnie'
                ],
                cropFamily: 'Amaranthaceae',
                schedule: [
                    {
                        day: 0,
                        dayLabel: 'GERMINATION DAY',
                        action: 'MANDATORY SPRAY',
                        products: ['entrustSC', 'azaguard'],
                        primaryProduct: 'entrustSC',
                        rate: 'Entrust SC: 6-8 fl oz/acre',
                        notes: 'Apply in evening. Target adult flies before they can lay eggs.',
                        timing: 'Evening spray (after 6pm)'
                    },
                    {
                        day: 5,
                        dayLabel: 'Day 5',
                        action: 'Follow-up spray',
                        products: ['azaguard'],
                        primaryProduct: 'azaguard',
                        rate: 'AzaGuard: 16-21 fl oz/acre',
                        notes: 'IGR prevents larvae from developing if eggs were laid',
                        timing: 'Morning or evening'
                    },
                    {
                        day: 10,
                        dayLabel: 'Day 10',
                        action: 'Rotation spray',
                        products: ['entrustSC', 'pyganic'],
                        primaryProduct: 'entrustSC',
                        rate: 'Entrust SC: 6-8 fl oz/acre',
                        notes: 'Target any new adult flies. Scout for mining damage.',
                        timing: 'Evening spray'
                    },
                    {
                        day: 15,
                        dayLabel: 'Day 15',
                        action: 'Maintenance spray',
                        products: ['azaguard'],
                        primaryProduct: 'azaguard',
                        rate: 'AzaGuard: 16 fl oz/acre',
                        notes: 'Continue until 1 week before harvest',
                        timing: 'Evening preferred'
                    },
                    {
                        day: 21,
                        dayLabel: 'Day 21',
                        action: 'Final spray (if needed)',
                        products: ['pyganic'],
                        primaryProduct: 'pyganic',
                        rate: 'PyGanic: 8 oz/acre (0-day PHI)',
                        notes: 'Only if adult flies still present. Check PHI for market.',
                        timing: 'Evening spray'
                    }
                ],
                rowCoverAlternative: 'Proteknet/GroGuard insect netting is highly effective for spinach. Cover immediately after seeding and seal edges with soil.',
                costPerBed: 'Approximately $2-5/bed for full protocol',
                warnings: [
                    'DO NOT SKIP DAY 0 SPRAY - Adult flies lay eggs within hours of emergence',
                    'Once larvae are IN the leaf, no spray will help - prevention only',
                    'Yellow sticky traps help monitor adult fly pressure',
                    'Leaf miner flies are TINY - visible as small yellow/black specs'
                ]
            }
        };

        // Helper function to check if a crop requires mandatory IPM protocol
        function getMandatoryIPMProtocol(cropName) {
            if (!cropName) return null;
            const name = cropName.toLowerCase();

            // Check flea beetle program
            for (const crop of MANDATORY_IPM_PROTOCOLS.fleaBeetleProgram.triggerCrops) {
                if (name.includes(crop.toLowerCase()) || crop.toLowerCase().includes(name)) {
                    return MANDATORY_IPM_PROTOCOLS.fleaBeetleProgram;
                }
            }

            // Check leaf miner program
            for (const crop of MANDATORY_IPM_PROTOCOLS.leafMinerProgram.triggerCrops) {
                if (name.includes(crop.toLowerCase()) || crop.toLowerCase().includes(name)) {
                    return MANDATORY_IPM_PROTOCOLS.leafMinerProgram;
                }
            }

            return null;
        }

        // Generate mandatory spray dates from a sowing date
        function generateMandatorySpraySchedule(cropName, sowingDate) {
            const protocol = getMandatoryIPMProtocol(cropName);
            if (!protocol) return null;

            const sowDate = new Date(sowingDate);
            const schedule = protocol.schedule.map(spray => {
                const sprayDate = new Date(sowDate);
                sprayDate.setDate(sprayDate.getDate() + spray.day);
                return {
                    ...spray,
                    date: sprayDate.toISOString().split('T')[0],
                    dateFormatted: sprayDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
                };
            });

            return {
                protocol: protocol,
                cropName: cropName,
                sowingDate: sowingDate,
                schedule: schedule
            };
        }

        // ============================================
        // AMENDMENT COSTS DATABASE
        // Approximate retail prices per 50lb bag or per unit
        // Used for cost-effective mode calculations
        // ============================================
        const AMENDMENT_COSTS = {
            // Lime Products ($/50lb)
            agLime: { price: 8, unit: '50lb', perLb: 0.16 },
            dolomite: { price: 10, unit: '50lb', perLb: 0.20 },
            calciumCarbonate: { price: 15, unit: '50lb', perLb: 0.30 },
            oysterShell: { price: 25, unit: '50lb', perLb: 0.50 },

            // Gypsum & Sulfur ($/50lb)
            gypsum: { price: 12, unit: '50lb', perLb: 0.24 },
            elementalSulfur: { price: 35, unit: '50lb', perLb: 0.70 },
            tigerSulfur: { price: 40, unit: '50lb', perLb: 0.80 },

            // Nitrogen Sources ($/50lb)
            featherMeal: { price: 45, unit: '50lb', perLb: 0.90 },
            bloodMeal: { price: 65, unit: '50lb', perLb: 1.30 },
            soybeanMeal: { price: 30, unit: '50lb', perLb: 0.60 },
            fishMeal: { price: 55, unit: '50lb', perLb: 1.10 },
            alfalfaMeal: { price: 35, unit: '50lb', perLb: 0.70 },
            crabMeal: { price: 60, unit: '50lb', perLb: 1.20 },
            guidedNitrogen: { price: 55, unit: '50lb', perLb: 1.10 },
            sodiumNitrate: { price: 50, unit: '50lb', perLb: 1.00 },

            // Phosphorus Sources ($/50lb)
            boneMeal: { price: 45, unit: '50lb', perLb: 0.90 },
            softRockPhosphate: { price: 25, unit: '50lb', perLb: 0.50 },
            hardRockPhosphate: { price: 20, unit: '50lb', perLb: 0.40 },
            fishBoneMeal: { price: 55, unit: '50lb', perLb: 1.10 },

            // Potassium Sources ($/50lb)
            potassiumSulfate: { price: 45, unit: '50lb', perLb: 0.90 },
            kMag: { price: 35, unit: '50lb', perLb: 0.70 },
            greensand: { price: 30, unit: '50lb', perLb: 0.60 },
            woodAsh: { price: 0, unit: '50lb', perLb: 0 }, // Free if you have it
            graniteMeal: { price: 20, unit: '50lb', perLb: 0.40 },

            // Magnesium Sources ($/50lb)
            magnesiumSulfate: { price: 25, unit: '50lb', perLb: 0.50 },
            magnesiumOxide: { price: 40, unit: '50lb', perLb: 0.80 },

            // Trace Minerals ($/lb or $/50lb)
            azomite: { price: 30, unit: '50lb', perLb: 0.60 },
            seaninetyPlus: { price: 35, unit: '50lb', perLb: 0.70 },
            borax: { price: 15, unit: '5lb', perLb: 3.00 },
            soluBor: { price: 25, unit: '5lb', perLb: 5.00 },
            ironSulfate: { price: 30, unit: '50lb', perLb: 0.60 },
            manganeseSulfate: { price: 40, unit: '50lb', perLb: 0.80 },
            copperSulfate: { price: 45, unit: '50lb', perLb: 0.90 },
            zincSulfate: { price: 35, unit: '50lb', perLb: 0.70 },

            // Kelp Products ($/50lb or $/gal)
            kelpMeal: { price: 55, unit: '50lb', perLb: 1.10 },
            liquidKelp: { price: 45, unit: 'gal', perGal: 45 },

            // Humates ($/50lb or $/gal)
            humicAcid: { price: 35, unit: '50lb', perLb: 0.70 },
            fulvicAcid: { price: 60, unit: 'gal', perGal: 60 },
            biochar: { price: 40, unit: '50lb', perLb: 0.80 },

            // Biologicals
            wormCastings: { price: 35, unit: '50lb', perLb: 0.70 },

            // Blends ($/50lb)
            perfectBlend: { price: 35, unit: '50lb', perLb: 0.70 },
            bioFish: { price: 50, unit: '50lb', perLb: 1.00 },

            // Specialty
            diatomaceousEarth: { price: 30, unit: '50lb', perLb: 0.60 }
        };

        // Cost-effective alternatives for each nutrient
        const COST_EFFECTIVE_OPTIONS = {
            calcium: [
                { key: 'agLime', raisespH: true },
                { key: 'gypsum', raisespH: false },
                { key: 'oysterShell', raisespH: true }
            ],
            magnesium: [
                { key: 'magnesiumSulfate', fast: true },
                { key: 'kMag', alsoProvides: ['K', 'S'] },
                { key: 'dolomite', raisespH: true }
            ],
            potassium: [
                { key: 'potassiumSulfate', preferred: true },
                { key: 'kMag', alsoProvides: ['Mg', 'S'] },
                { key: 'greensand', slowRelease: true },
                { key: 'woodAsh', free: true }
            ],
            phosphorus: [
                { key: 'softRockPhosphate', preferred: true },
                { key: 'boneMeal', alsoProvides: ['Ca'] },
                { key: 'hardRockPhosphate', verySlowRelease: true }
            ],
            nitrogen: [
                { key: 'soybeanMeal', bestValue: true },
                { key: 'alfalfaMeal', feedsBiology: true },
                { key: 'featherMeal', slowRelease: true },
                { key: 'bloodMeal', fastActing: true }
            ],
            sulfur: [
                { key: 'gypsum', doesNotChangePH: true },
                { key: 'potassiumSulfate', alsoProvides: ['K'] },
                { key: 'elementalSulfur', lowerspH: true }
            ],
            boron: [
                { key: 'borax', common: true }
            ],
            iron: [
                { key: 'ironSulfate', fast: true }
            ],
            manganese: [
                { key: 'manganeseSulfate', standard: true }
            ],
            copper: [
                { key: 'copperSulfate', standard: true }
            ],
            zinc: [
                { key: 'zincSulfate', standard: true }
            ]
        };

        // ============================================
        // AMENDMENT BIOAVAILABILITY & PERSISTENCE
        // Critical for smart recommendations - don't over-apply slow-release!
        //
        // SCIENTIFIC SOURCES:
        // - Clemson Extension HGIC 1252: "Understanding Organic Fertility"
        //   https://hgic.clemson.edu/factsheet/understanding-organic-fertility/
        //   Blood meal: 1-4 month release, Bone meal: 1-4 month release
        //
        // - NC State Extension: "Soil Acidity and Liming"
        //   https://content.ces.ncsu.edu/soil-acidity-and-liming-basic-information
        //   Lime takes 6-24 months for full reaction, test every 3-4 years
        //
        // - Ohio State NRCS 333: "Amending Soil Properties with Gypsum Products"
        //   https://agbmps.osu.edu/bmp/amending-soils-lime-or-gypsum-nrcs-333
        //   Gypsum effects last ~1 year, maximum 5 tons/acre annual
        //
        // - University of Georgia AESL Organic Fertilizers Calculator
        //   https://aesl.ces.uga.edu/calculators/nitrogen/
        //   24 organic fertilizers tested: 25-93% N available over 100 days
        //
        // - Oregon State Extension: "Choosing the Right Fertilizer"
        //   https://extension.oregonstate.edu/news/heres-scoop-chemical-organic-fertilizers
        //   Blood meal: fast-acting 6-8 weeks, Feather meal: slower than blood meal
        //
        // - SARE: "Potassium-Rich Crop Residues Used as Organic" (2021)
        //   https://projects.sare.org/media/pdf/agriculture-11-00580.pdf
        //   K solubilization driven by water, not C:N or decomposition rate
        // ============================================
        const AMENDMENT_BIOAVAILABILITY = {
            // LIME PRODUCTS - Very slow, show up in tests for years
            agLime: {
                releaseSpeed: 'very_slow',
                daysToAvailable: 180,      // 6 months to peak effect
                daysToFullEffect: 730,     // 2 years for full reaction
                persistenceYears: 3,       // Shows in tests 3+ years
                waterSoluble: false,
                bestUse: 'fall_application',
                notes: 'Apply in fall. Takes 6-24 months to fully react with soil.',
                canSideDress: false
            },
            dolomite: {
                releaseSpeed: 'very_slow',
                daysToAvailable: 180,
                daysToFullEffect: 730,
                persistenceYears: 3,
                waterSoluble: false,
                bestUse: 'fall_application',
                notes: 'Slower than ag lime. Use only if Mg is also deficient.',
                canSideDress: false
            },
            calciumCarbonate: {
                releaseSpeed: 'slow',
                daysToAvailable: 90,
                daysToFullEffect: 365,
                persistenceYears: 2,
                waterSoluble: false,
                bestUse: 'fall_application',
                notes: 'Finer grind than ag lime, reacts faster.',
                canSideDress: false
            },
            oysterShell: {
                releaseSpeed: 'very_slow',
                daysToAvailable: 365,
                daysToFullEffect: 1095,
                persistenceYears: 5,
                waterSoluble: false,
                bestUse: 'fall_application',
                notes: 'Very slow release over many years. Good for long-term Ca.',
                canSideDress: false
            },

            // GYPSUM & SULFUR
            gypsum: {
                releaseSpeed: 'medium',
                daysToAvailable: 30,
                daysToFullEffect: 180,
                persistenceYears: 1,
                waterSoluble: true,        // Moderately soluble
                bestUse: 'spring_or_fall',
                notes: 'Fairly quick Ca without pH change. Good for clay soils.',
                canSideDress: true
            },
            elementalSulfur: {
                releaseSpeed: 'slow',
                daysToAvailable: 90,
                daysToFullEffect: 365,
                persistenceYears: 2,
                waterSoluble: false,
                bestUse: 'fall_application',
                notes: 'Needs soil bacteria to convert. Apply fall before needed.',
                canSideDress: false
            },

            // NITROGEN SOURCES - Critical timing differences!
            bloodMeal: {
                releaseSpeed: 'fast',
                daysToAvailable: 7,
                daysToFullEffect: 30,
                persistenceYears: 0.25,    // 3 months
                waterSoluble: false,
                bestUse: 'sidedress',
                notes: 'Fast N release! Use for quick green-up. Can burn if over-applied.',
                canSideDress: true,
                sideDressRate: 0.3         // Apply 30% of main rate
            },
            featherMeal: {
                releaseSpeed: 'slow',
                daysToAvailable: 60,
                daysToFullEffect: 180,
                persistenceYears: 0.5,
                waterSoluble: false,
                bestUse: 'main_application',
                notes: 'Slow, steady N release. Great for season-long feeding.',
                canSideDress: false
            },
            soybeanMeal: {
                releaseSpeed: 'medium',
                daysToAvailable: 21,
                daysToFullEffect: 90,
                persistenceYears: 0.3,
                waterSoluble: false,
                bestUse: 'spring_or_sidedress',
                notes: 'Good all-around N source. Feeds soil biology too.',
                canSideDress: true,
                sideDressRate: 0.5
            },
            fishMeal: {
                releaseSpeed: 'medium_fast',
                daysToAvailable: 14,
                daysToFullEffect: 60,
                persistenceYears: 0.25,
                waterSoluble: false,
                bestUse: 'spring_or_sidedress',
                notes: 'Faster than soybean meal. Good for transplants.',
                canSideDress: true,
                sideDressRate: 0.4
            },
            alfalfaMeal: {
                releaseSpeed: 'medium',
                daysToAvailable: 21,
                daysToFullEffect: 90,
                persistenceYears: 0.3,
                waterSoluble: false,
                bestUse: 'spring_application',
                notes: 'Contains triacontanol growth stimulant. Great for tomatoes.',
                canSideDress: true,
                sideDressRate: 0.5
            },
            sodiumNitrate: {
                releaseSpeed: 'immediate',
                daysToAvailable: 1,
                daysToFullEffect: 7,
                persistenceYears: 0.1,     // Gone in a month
                waterSoluble: true,
                bestUse: 'emergency_sidedress',
                notes: 'IMMEDIATE availability. Use only for rescue/emergency. Leaches fast!',
                canSideDress: true,
                sideDressRate: 0.25,
                foliarOK: true
            },

            // PHOSPHORUS SOURCES - Generally slow
            boneMeal: {
                releaseSpeed: 'medium',
                daysToAvailable: 30,
                daysToFullEffect: 180,
                persistenceYears: 1,
                waterSoluble: false,
                bestUse: 'spring_application',
                notes: 'Needs acidic soil to release. Mix into root zone.',
                canSideDress: false
            },
            softRockPhosphate: {
                releaseSpeed: 'slow',
                daysToAvailable: 90,
                daysToFullEffect: 365,
                persistenceYears: 3,
                waterSoluble: false,
                bestUse: 'fall_application',
                notes: 'Multi-year P source. Apply and forget. Builds reserves.',
                canSideDress: false
            },
            hardRockPhosphate: {
                releaseSpeed: 'very_slow',
                daysToAvailable: 365,
                daysToFullEffect: 1095,
                persistenceYears: 5,
                waterSoluble: false,
                bestUse: 'fall_application',
                notes: 'Very slow. Best for long-term P building in acidic soils.',
                canSideDress: false
            },

            // POTASSIUM SOURCES
            potassiumSulfate: {
                releaseSpeed: 'fast',
                daysToAvailable: 7,
                daysToFullEffect: 30,
                persistenceYears: 0.5,
                waterSoluble: true,
                bestUse: 'spring_or_sidedress',
                notes: 'Quick K availability. Good for heavy feeders mid-season.',
                canSideDress: true,
                sideDressRate: 0.4,
                foliarOK: true
            },
            kMag: {
                releaseSpeed: 'medium',
                daysToAvailable: 21,
                daysToFullEffect: 90,
                persistenceYears: 0.5,
                waterSoluble: true,
                bestUse: 'spring_application',
                notes: 'K + Mg + S in one product. Very efficient.',
                canSideDress: true,
                sideDressRate: 0.3
            },
            greensand: {
                releaseSpeed: 'very_slow',
                daysToAvailable: 180,
                daysToFullEffect: 730,
                persistenceYears: 3,
                waterSoluble: false,
                bestUse: 'fall_application',
                notes: 'Multi-year K release. Don\'t expect quick results.',
                canSideDress: false
            },
            woodAsh: {
                releaseSpeed: 'fast',
                daysToAvailable: 7,
                daysToFullEffect: 30,
                persistenceYears: 0.5,
                waterSoluble: true,
                bestUse: 'spring_application',
                notes: 'Quick K + raises pH. Use carefully. Free if you have it!',
                canSideDress: true,
                sideDressRate: 0.3
            },

            // MAGNESIUM
            magnesiumSulfate: {
                releaseSpeed: 'immediate',
                daysToAvailable: 1,
                daysToFullEffect: 14,
                persistenceYears: 0.25,
                waterSoluble: true,
                bestUse: 'sidedress_or_foliar',
                notes: 'IMMEDIATE Mg. Perfect for deficiency correction. Foliar OK.',
                canSideDress: true,
                sideDressRate: 0.5,
                foliarOK: true,
                foliarRate: '2 tbsp/gal'
            },

            // TRACE MINERALS - Mostly fast when sulfate form
            borax: {
                releaseSpeed: 'fast',
                daysToAvailable: 7,
                daysToFullEffect: 30,
                persistenceYears: 0.5,
                waterSoluble: true,
                bestUse: 'spring_application',
                notes: 'Quick B release. CAREFUL - toxic in excess!',
                canSideDress: true,
                sideDressRate: 0.25
            },
            ironSulfate: {
                releaseSpeed: 'fast',
                daysToAvailable: 7,
                daysToFullEffect: 30,
                persistenceYears: 0.3,
                waterSoluble: true,
                bestUse: 'sidedress_or_foliar',
                notes: 'Quick Fe. Good for chlorosis correction.',
                canSideDress: true,
                sideDressRate: 0.5,
                foliarOK: true,
                foliarRate: '1 oz/gal'
            },
            manganeseSulfate: {
                releaseSpeed: 'fast',
                daysToAvailable: 7,
                daysToFullEffect: 30,
                persistenceYears: 0.3,
                waterSoluble: true,
                bestUse: 'sidedress_or_foliar',
                notes: 'Quick Mn availability.',
                canSideDress: true,
                sideDressRate: 0.5,
                foliarOK: true,
                foliarRate: '1 oz/gal'
            },
            copperSulfate: {
                releaseSpeed: 'fast',
                daysToAvailable: 7,
                daysToFullEffect: 30,
                persistenceYears: 1,        // Cu persists longer
                waterSoluble: true,
                bestUse: 'spring_application',
                notes: 'Cu builds up - apply carefully. Max 4 lbs/acre.',
                canSideDress: false          // Don't want to over-apply
            },
            zincSulfate: {
                releaseSpeed: 'fast',
                daysToAvailable: 7,
                daysToFullEffect: 30,
                persistenceYears: 0.5,
                waterSoluble: true,
                bestUse: 'spring_or_sidedress',
                notes: 'Quick Zn. Mix well - Zn is immobile.',
                canSideDress: true,
                sideDressRate: 0.5,
                foliarOK: true,
                foliarRate: '1 oz/gal'
            },

            // KELP & HUMATES - Biological stimulants
            kelpMeal: {
                releaseSpeed: 'medium',
                daysToAvailable: 14,
                daysToFullEffect: 60,
                persistenceYears: 0.5,
                waterSoluble: false,
                bestUse: 'spring_or_transplant',
                notes: 'Growth hormones + traces. Great for transplants.',
                canSideDress: true,
                sideDressRate: 0.25
            },
            liquidKelp: {
                releaseSpeed: 'immediate',
                daysToAvailable: 1,
                daysToFullEffect: 7,
                persistenceYears: 0.1,
                waterSoluble: true,
                bestUse: 'foliar_or_drench',
                notes: 'Immediate stress relief. Use during transplant, heat, cold.',
                canSideDress: true,
                foliarOK: true,
                foliarRate: '2 oz/gal'
            },
            humicAcid: {
                releaseSpeed: 'medium',
                daysToAvailable: 14,
                daysToFullEffect: 60,
                persistenceYears: 1,
                waterSoluble: false,
                bestUse: 'spring_application',
                notes: 'Improves nutrient uptake. Apply with fertilizers.',
                canSideDress: true,
                sideDressRate: 0.5
            },
            fulvicAcid: {
                releaseSpeed: 'immediate',
                daysToAvailable: 1,
                daysToFullEffect: 7,
                persistenceYears: 0.1,
                waterSoluble: true,
                bestUse: 'foliar_or_fertigation',
                notes: 'Chelates nutrients for fast uptake. Great foliar additive.',
                canSideDress: true,
                foliarOK: true,
                foliarRate: '1 oz/gal'
            },

            // COMPOST & BIOLOGICALS
            wormCastings: {
                releaseSpeed: 'medium',
                daysToAvailable: 14,
                daysToFullEffect: 90,
                persistenceYears: 1,
                waterSoluble: false,
                bestUse: 'transplant_or_sidedress',
                notes: 'Living biology + gentle nutrients. Perfect for transplants.',
                canSideDress: true,
                sideDressRate: 0.5
            }
        };

        // Release speed rankings for quick lookup
        const RELEASE_SPEEDS = {
            immediate: { order: 1, label: 'Immediate (1-7 days)', color: '#ef4444' },
            fast: { order: 2, label: 'Fast (1-4 weeks)', color: '#f59e0b' },
            medium_fast: { order: 3, label: 'Medium-Fast (2-6 weeks)', color: '#eab308' },
            medium: { order: 4, label: 'Medium (1-3 months)', color: '#22c55e' },
            slow: { order: 5, label: 'Slow (3-12 months)', color: '#3b82f6' },
            very_slow: { order: 6, label: 'Very Slow (1-3 years)', color: '#8b5cf6' }
        };

        // Get amendments suitable for quick correction (side-dressing)
        function getQuickFixAmendments(nutrient) {
            const quickOptions = [];
            for (const [key, data] of Object.entries(AMENDMENT_BIOAVAILABILITY)) {
                if (data.canSideDress && RELEASE_SPEEDS[data.releaseSpeed]?.order <= 3) {
                    // Check if this amendment provides the needed nutrient
                    const amendment = AMENDMENTS[key] || findAmendmentInDatabase(key);
                    if (amendment && amendment[nutrient]) {
                        quickOptions.push({
                            key,
                            ...data,
                            nutrientContent: amendment[nutrient],
                            speedLabel: RELEASE_SPEEDS[data.releaseSpeed]?.label
                        });
                    }
                }
            }
            return quickOptions.sort((a, b) =>
                RELEASE_SPEEDS[a.releaseSpeed].order - RELEASE_SPEEDS[b.releaseSpeed].order
            );
        }

        // Check if we should warn about recent slow-release applications
        function checkRecentSlowReleaseApplications(fieldZone, nutrient) {
            const warnings = [];
            const history = FarmLearning.load('amendmentHistory') || [];
            const now = new Date();

            // Filter to this field zone and last 3 years
            const relevantHistory = history.filter(h => {
                if (h.fieldZone !== fieldZone) return false;
                const appDate = new Date(h.applicationDate);
                const yearsAgo = (now - appDate) / (365 * 24 * 60 * 60 * 1000);
                return yearsAgo < 3;
            });

            for (const app of relevantHistory) {
                const bio = AMENDMENT_BIOAVAILABILITY[app.amendmentKey];
                if (!bio) continue;

                const appDate = new Date(app.applicationDate);
                const daysSinceApp = (now - appDate) / (24 * 60 * 60 * 1000);
                const stillActive = daysSinceApp < (bio.persistenceYears * 365);

                if (stillActive && bio.releaseSpeed === 'very_slow') {
                    warnings.push({
                        amendment: app.material || app.amendmentKey,
                        appliedDate: app.applicationDate,
                        expectedPeakDays: bio.daysToFullEffect - daysSinceApp,
                        message: `${app.material} applied ${Math.round(daysSinceApp)} days ago is still releasing. Peak effect expected in ${Math.round(bio.daysToFullEffect - daysSinceApp)} days.`
                    });
                }
            }

            return warnings;
        }

        // Calculate cost per lb of nutrient delivered
        function calculateNutrientCost(amendmentKey, nutrient) {
            const cost = AMENDMENT_COSTS[amendmentKey];
            const amendment = AMENDMENTS[amendmentKey] || findAmendmentInDatabase(amendmentKey);
            if (!cost || !amendment) return Infinity;

            const nutrientContent = amendment[nutrient] || 0;
            if (nutrientContent === 0) return Infinity;

            // Cost per lb of actual nutrient delivered
            return cost.perLb / nutrientContent;
        }

        function findAmendmentInDatabase(key) {
            for (const category of Object.values(AMENDMENTS_DATABASE)) {
                if (category.items && category.items[key]) {
                    return category.items[key];
                }
            }
            return null;
        }

        // Calculate amendments using cost-effective mode
        function calculateAmendmentsCostEffective(test, deficits) {
            const recommendations = [];
            const ph = test.ph || 6.5;

            // Track what we've addressed
            const addressed = { Ca: 0, Mg: 0, K: 0, P: 0, N: 0, S: 0, B: 0, Fe: 0, Mn: 0, Cu: 0, Zn: 0 };

            // Helper to add recommendation
            const addRec = (key, amount, provides, notes, costPer50lb) => {
                const cost = AMENDMENT_COSTS[key];
                const amendment = AMENDMENTS[key] || findAmendmentInDatabase(key);
                if (!amendment) return;

                const totalCost = cost ? (amount / 50 * cost.price).toFixed(2) : 'N/A';
                recommendations.push({
                    material: amendment.name,
                    amount: Math.round(amount),
                    unit: 'lbs/acre',
                    provides: provides,
                    notes: notes,
                    estimatedCost: `$${totalCost}`,
                    costPerLb: cost ? `$${cost.perLb.toFixed(2)}` : 'N/A'
                });
            };

            // 1. CALCIUM - Choose based on pH need
            if (deficits.calcium > 0) {
                if (ph < 6.2) {
                    // Need to raise pH - use lime (cheapest)
                    const limeNeeded = Math.min(deficits.calcium / 0.36, 4000);
                    addRec('agLime', limeNeeded, 'Calcium + raises pH', 'Best value for Ca when pH is low', AMENDMENT_COSTS.agLime?.price);
                    addressed.Ca = limeNeeded * 0.36;
                } else {
                    // Don't want to raise pH - use gypsum
                    const gypsumNeeded = Math.min(deficits.calcium / 0.205, 2000);
                    addRec('gypsum', gypsumNeeded, 'Calcium (no pH change)', 'Cost-effective Ca without raising pH', AMENDMENT_COSTS.gypsum?.price);
                    addressed.Ca = gypsumNeeded * 0.205;
                }
            }

            // 2. MAGNESIUM - K-Mag if also need K, otherwise Epsom
            if (deficits.magnesium > 0) {
                if (deficits.potassium > 0) {
                    // K-Mag covers both - better value
                    const kMagNeeded = Math.min(deficits.magnesium / 0.11, 600);
                    addRec('kMag', kMagNeeded, 'Magnesium + Potassium + Sulfur', 'Best value: 3 nutrients in 1', AMENDMENT_COSTS.kMag?.price);
                    addressed.Mg = kMagNeeded * 0.11;
                    addressed.K = kMagNeeded * 0.22;
                    addressed.S = kMagNeeded * 0.182;
                } else {
                    // Just Epsom salt
                    const epsomNeeded = Math.min(deficits.magnesium / 0.10, 200);
                    addRec('magnesiumSulfate', epsomNeeded, 'Magnesium + Sulfur', 'Fast-acting, economical', AMENDMENT_COSTS.magnesiumSulfate?.price);
                    addressed.Mg = epsomNeeded * 0.10;
                    addressed.S += epsomNeeded * 0.13;
                }
            }

            // 3. POTASSIUM - Account for what K-Mag provided
            const remainingK = deficits.potassium - addressed.K;
            if (remainingK > 0) {
                // SOP is most efficient K source
                const sopNeeded = Math.min(remainingK / 0.42, 400);
                addRec('potassiumSulfate', sopNeeded, 'Potassium + Sulfur', 'Highest K content, no salt buildup', AMENDMENT_COSTS.potassiumSulfate?.price);
                addressed.K += sopNeeded * 0.42;
                addressed.S += sopNeeded * 0.17;
            }

            // 4. PHOSPHORUS - Soft rock is best value
            if (deficits.phosphorus > 0) {
                // Soft rock phosphate is cheapest per lb of P
                const rockPNeeded = Math.min(deficits.phosphorus / 0.088, 1000);
                addRec('softRockPhosphate', rockPNeeded, 'Phosphorus + Calcium', 'Best value P source, slow release', AMENDMENT_COSTS.softRockPhosphate?.price);
                addressed.P = rockPNeeded * 0.088;
                addressed.Ca += rockPNeeded * 0.20;
            }

            // 5. NITROGEN - Soybean meal is best value
            if (deficits.nitrogen > 0) {
                // Soybean meal - cheapest per lb of N
                const soyNeeded = Math.min(deficits.nitrogen / 0.07, 1500);
                addRec('soybeanMeal', soyNeeded, 'Nitrogen + feeds biology', 'Best value N source, moderate release', AMENDMENT_COSTS.soybeanMeal?.price);
                addressed.N = soyNeeded * 0.07;
            }

            // 6. TRACE MINERALS - Individual sulfates are cheaper than blends
            if (deficits.boron > 0) {
                const boraxNeeded = Math.min(deficits.boron / 0.10, 15);
                addRec('borax', boraxNeeded, 'Boron', 'Very economical boron source', AMENDMENT_COSTS.borax?.price);
            }

            if (deficits.iron > 0) {
                const feNeeded = Math.min(deficits.iron / 0.30, 100);
                addRec('ironSulfate', feNeeded, 'Iron + Sulfur', 'Cost-effective iron', AMENDMENT_COSTS.ironSulfate?.price);
            }

            if (deficits.manganese > 0) {
                const mnNeeded = Math.min(deficits.manganese / 0.32, 50);
                addRec('manganeseSulfate', mnNeeded, 'Manganese + Sulfur', 'Standard Mn source', AMENDMENT_COSTS.manganeseSulfate?.price);
            }

            if (deficits.copper > 0) {
                const cuNeeded = Math.min(deficits.copper / 0.25, 16);
                addRec('copperSulfate', cuNeeded, 'Copper + Sulfur', 'Use carefully - max 4 lbs Cu/acre', AMENDMENT_COSTS.copperSulfate?.price);
            }

            if (deficits.zinc > 0) {
                const znNeeded = Math.min(deficits.zinc / 0.35, 40);
                addRec('zincSulfate', znNeeded, 'Zinc + Sulfur', 'Mix well - Zn is immobile', AMENDMENT_COSTS.zincSulfate?.price);
            }

            // Add kelp meal for trace minerals (good value)
            if (recommendations.length > 0) {
                addRec('kelpMeal', 200, 'Trace minerals, plant hormones', 'Broad-spectrum nutrition, stress tolerance', AMENDMENT_COSTS.kelpMeal?.price);
            }

            // Calculate total estimated cost
            let totalCost = 0;
            recommendations.forEach(r => {
                const costNum = parseFloat(r.estimatedCost.replace('$', ''));
                if (!isNaN(costNum)) totalCost += costNum;
            });

            // Add total cost to first recommendation's notes
            if (recommendations.length > 0) {
                recommendations.push({
                    material: 'TOTAL ESTIMATED COST',
                    amount: '-',
                    unit: '',
                    provides: `$${totalCost.toFixed(2)}/acre`,
                    notes: 'Prices are approximate retail. Bulk orders may be 20-40% less.',
                    estimatedCost: `$${totalCost.toFixed(2)}`,
                    isTotal: true
                });
            }

            return recommendations;
        }

        // Legacy AMENDMENTS object for backward compatibility with calculator
        const AMENDMENTS = {
            agLime: { name: 'Agricultural Lime', Ca: 0.36, Mg: 0.02 },
            dolomite: { name: 'Dolomitic Lime', Ca: 0.22, Mg: 0.13 },
            gypsum: { name: 'Gypsum', Ca: 0.205, S: 0.17 },
            potassiumSulfate: { name: 'Potassium Sulfate (0-0-50)', K: 0.42, S: 0.17 },
            magnesiumSulfate: { name: 'Epsom Salt', Mg: 0.10, S: 0.13 },
            borax: { name: 'Borax', B: 0.10 },
            ironSulfate: { name: 'Iron Sulfate', Fe: 0.30, S: 0.18 },
            manganeseSulfate: { name: 'Manganese Sulfate', Mn: 0.32, S: 0.19 },
            copperSulfate: { name: 'Copper Sulfate', Cu: 0.25, S: 0.125 },
            zincSulfate: { name: 'Zinc Sulfate', Zn: 0.35, S: 0.17 },
            featherMeal: { name: 'Feather Meal (12-0-0)', N: 0.12 },
            bloodMeal: { name: 'Blood Meal (13-0-0)', N: 0.13 },
            boneMeal: { name: 'Bone Meal (3-13-0)', P: 0.13, Ca: 0.12 },
            rockPhosphate: { name: 'Soft Rock Phosphate', P: 0.088, Ca: 0.20 },
            kMag: { name: 'K-Mag/Langbeinite', K: 0.22, Mg: 0.11, S: 0.182 },
            kelp: { name: 'Kelp Meal', N: 0.01, K: 0.025, S: 0.02, trace: true }
        };

        // Application limits (lbs/acre)
        const APP_LIMITS = {
            agLime: 8000,
            agSulfur: 100,
            P: 175,
            K: 200,
            Mg: null, // 10% of target
            B: 4,
            Cu: 4,
            Zn: 14
        };

        function getKTarget(tcec) {
            const roundedTCEC = Math.round(Math.max(3, Math.min(39, tcec)));
            return K_TARGETS[roundedTCEC] || 310;
        }

        function calculateTargets(test, cropKey = 'none') {
            const tcec = test.cec || 10;
            const ph = test.ph || 6.5;

            // Get crop-specific needs
            const crop = CROP_NUTRITION[cropKey] || CROP_NUTRITION.none;

            // Base target calculations (Albrecht/Solomon method)
            const baseTargets = {
                calcium: Math.round(tcec * 400 * 0.68),      // 68% base saturation
                magnesium: Math.round(tcec * 240 * 0.12),    // 12% base saturation
                potassium: getKTarget(tcec),
                phosphorus: getKTarget(tcec),                 // P = K target
                sulfur: ph < 7 ? (tcec < 10 ? 45 : 70) : Math.min(tcec * 240 * 0.12 / 2, 432),
                boron: tcec < 10 ? 2 : 4,
                iron: tcec < 10 ? 100 : 150,
                manganese: tcec < 10 ? 55 : 100,
                copper: tcec < 10 ? 6 : 10,
                zinc: Math.round(getKTarget(tcec) / 10),
                nitrogen: 100 // Base recommendation
            };

            // Adjust targets based on crop needs
            // Nitrogen: Use crop-specific N requirement
            const targets = {
                ...baseTargets,
                nitrogen: crop.N || 100,
                // P target: Use higher of base target or crop's upper P need
                phosphorus: Math.max(baseTargets.phosphorus, crop.P ? crop.P[1] : 0),
                // K target: Use higher of base target or crop's upper K need
                potassium: Math.max(baseTargets.potassium, crop.K ? crop.K[1] : 0)
            };

            // Store crop pH preference for display
            targets.cropName = crop.name;
            targets.cropPH = crop.pH;
            targets.cropN = crop.N;
            targets.cropP = crop.P;
            targets.cropK = crop.K;

            return targets;
        }

        function calculateDeficits(test, targets) {
            // Convert ppm to lbs/acre (1 ppm = 2 lbs/acre at 6" depth)
            const ppmToLbs = 2;

            const deficits = {
                calcium: Math.max(0, targets.calcium - (test.caFound || 0)),
                magnesium: Math.max(0, targets.magnesium - (test.mgFound || 0)),
                potassium: Math.max(0, targets.potassium - (test.kFound || 0)),
                phosphorus: Math.max(0, targets.phosphorus - (test.phosphorus || 0)),
                sulfur: Math.max(0, targets.sulfur - ((test.sulfur || 0) * ppmToLbs)),
                boron: Math.max(0, targets.boron - ((test.boron || 0) * ppmToLbs)),
                iron: Math.max(0, targets.iron - ((test.iron || 0) * ppmToLbs)),
                manganese: Math.max(0, targets.manganese - ((test.manganese || 0) * ppmToLbs)),
                copper: Math.max(0, targets.copper - ((test.copper || 0) * ppmToLbs)),
                zinc: Math.max(0, targets.zinc - ((test.zinc || 0) * ppmToLbs)),
                nitrogen: targets.nitrogen
            };

            return deficits;
        }

        function calculateAmendments(test, deficits) {
            const recommendations = [];
            const ph = test.ph || 6.5;
            const tcec = test.cec || 10;

            // Calcium - use lime if Ca% < 60%, gypsum if need Ca but not pH change
            if (deficits.calcium > 0) {
                const caPct = test.caPct || 60;
                if (caPct < 60 && ph < 7.0) {
                    // Use ag lime to raise Ca and pH
                    const limeNeeded = Math.min(deficits.calcium / AMENDMENTS.agLime.Ca, APP_LIMITS.agLime);
                    recommendations.push({
                        material: 'Agricultural Lime',
                        amount: Math.round(limeNeeded),
                        unit: 'lbs/acre',
                        provides: `${Math.round(limeNeeded * AMENDMENTS.agLime.Ca)} lbs Ca`,
                        notes: 'Apply in fall if possible. Raises pH.'
                    });
                } else {
                    // Use gypsum - doesn't change pH
                    const gypsumNeeded = deficits.calcium / AMENDMENTS.gypsum.Ca;
                    recommendations.push({
                        material: 'Gypsum',
                        amount: Math.round(gypsumNeeded),
                        unit: 'lbs/acre',
                        provides: `${Math.round(gypsumNeeded * AMENDMENTS.gypsum.Ca)} lbs Ca, ${Math.round(gypsumNeeded * AMENDMENTS.gypsum.S)} lbs S`,
                        notes: 'Neutral pH. Also provides sulfur.'
                    });
                }
            }

            // Magnesium
            if (deficits.magnesium > 0) {
                const mgLimit = Math.round(tcec * 240 * 0.12 * 0.1); // 10% of target max
                const mgToApply = Math.min(deficits.magnesium, mgLimit);
                const epsom = mgToApply / AMENDMENTS.magnesiumSulfate.Mg;
                recommendations.push({
                    material: 'Epsom Salt (Magnesium Sulfate)',
                    amount: Math.round(epsom),
                    unit: 'lbs/acre',
                    provides: `${Math.round(epsom * AMENDMENTS.magnesiumSulfate.Mg)} lbs Mg, ${Math.round(epsom * AMENDMENTS.magnesiumSulfate.S)} lbs S`,
                    notes: 'Apply no more than 10% of target per year.'
                });
            }

            // Potassium
            if (deficits.potassium > 0) {
                const kToApply = Math.min(deficits.potassium, APP_LIMITS.K);
                const kSulf = kToApply / AMENDMENTS.potassiumSulfate.K;
                recommendations.push({
                    material: 'Potassium Sulfate (0-0-50)',
                    amount: Math.round(kSulf),
                    unit: 'lbs/acre',
                    provides: `${Math.round(kSulf * AMENDMENTS.potassiumSulfate.K)} lbs K, ${Math.round(kSulf * AMENDMENTS.potassiumSulfate.S)} lbs S`,
                    notes: 'Reduce if applying compost (contains K).'
                });
            }

            // Phosphorus
            if (deficits.phosphorus > 0) {
                const pToApply = Math.min(deficits.phosphorus, APP_LIMITS.P);
                if (ph > 7.4) {
                    // Rock phosphate ineffective at high pH - use bone meal or MAP
                    const bone = pToApply / AMENDMENTS.boneMeal.P;
                    recommendations.push({
                        material: 'Bone Meal (steamed)',
                        amount: Math.round(bone),
                        unit: 'lbs/acre',
                        provides: `${Math.round(bone * AMENDMENTS.boneMeal.P)} lbs P`,
                        notes: 'Mix with compost for best results at high pH.'
                    });
                } else {
                    const rock = pToApply / AMENDMENTS.rockPhosphate.P;
                    recommendations.push({
                        material: 'Soft Rock Phosphate (Calphos)',
                        amount: Math.round(rock),
                        unit: 'lbs/acre',
                        provides: `${Math.round(rock * AMENDMENTS.rockPhosphate.P)} lbs P, ${Math.round(rock * AMENDMENTS.rockPhosphate.Ca)} lbs Ca`,
                        notes: 'Mix well into soil. Phosphorus is immobile.'
                    });
                }
            }

            // Boron
            if (deficits.boron > 0) {
                const bToApply = Math.min(deficits.boron, APP_LIMITS.B);
                const borax = bToApply / AMENDMENTS.borax.B;
                recommendations.push({
                    material: 'Borax',
                    amount: Math.round(borax * 10) / 10,
                    unit: 'lbs/acre',
                    provides: `${Math.round(bToApply * 10) / 10} lbs B`,
                    notes: 'Do not exceed 4 lbs B/acre. Toxic in excess.'
                });
            }

            // Iron
            if (deficits.iron > 0) {
                const feSulf = deficits.iron / AMENDMENTS.ironSulfate.Fe;
                recommendations.push({
                    material: 'Iron Sulfate',
                    amount: Math.round(feSulf),
                    unit: 'lbs/acre',
                    provides: `${Math.round(feSulf * AMENDMENTS.ironSulfate.Fe)} lbs Fe, ${Math.round(feSulf * AMENDMENTS.ironSulfate.S)} lbs S`,
                    notes: ''
                });
            }

            // Manganese (skip if pH < 5.7 - toxicity risk)
            if (deficits.manganese > 0 && ph >= 5.7) {
                const mnSulf = deficits.manganese / AMENDMENTS.manganeseSulfate.Mn;
                recommendations.push({
                    material: 'Manganese Sulfate',
                    amount: Math.round(mnSulf),
                    unit: 'lbs/acre',
                    provides: `${Math.round(mnSulf * AMENDMENTS.manganeseSulfate.Mn)} lbs Mn, ${Math.round(mnSulf * AMENDMENTS.manganeseSulfate.S)} lbs S`,
                    notes: ''
                });
            }

            // Copper
            if (deficits.copper > 0) {
                const cuToApply = Math.min(deficits.copper, APP_LIMITS.Cu);
                const cuSulf = cuToApply / AMENDMENTS.copperSulfate.Cu;
                recommendations.push({
                    material: 'Copper Sulfate',
                    amount: Math.round(cuSulf),
                    unit: 'lbs/acre',
                    provides: `${Math.round(cuSulf * AMENDMENTS.copperSulfate.Cu)} lbs Cu, ${Math.round(cuSulf * AMENDMENTS.copperSulfate.S)} lbs S`,
                    notes: 'Handle carefully. Apply separate from other minerals.'
                });
            }

            // Zinc
            if (deficits.zinc > 0) {
                const znToApply = Math.min(deficits.zinc, APP_LIMITS.Zn);
                const znSulf = znToApply / AMENDMENTS.zincSulfate.Zn;
                recommendations.push({
                    material: 'Zinc Sulfate',
                    amount: Math.round(znSulf),
                    unit: 'lbs/acre',
                    provides: `${Math.round(znSulf * AMENDMENTS.zincSulfate.Zn)} lbs Zn, ${Math.round(znSulf * AMENDMENTS.zincSulfate.S)} lbs S`,
                    notes: 'Mix well into soil. Zinc is immobile.'
                });
            }

            // Nitrogen
            recommendations.push({
                material: 'Feather Meal (12-0-0)',
                amount: Math.round(deficits.nitrogen / AMENDMENTS.featherMeal.N),
                unit: 'lbs/acre',
                provides: `${deficits.nitrogen} lbs N (slow release)`,
                notes: 'Very slow release. Good for season-long feeding.'
            });

            // Trace minerals
            recommendations.push({
                material: 'Kelp Meal or Azomite',
                amount: 100,
                unit: 'lbs/acre',
                provides: 'Trace minerals, growth stimulants',
                notes: 'Apply first year, reduce in subsequent years.'
            });

            return recommendations;
        }

        // State for calculator options
        let selectedCrop = 'none';
        let calculatorMode = 'efficient'; // efficient, costEffective, inventory

        function renderAmendmentCalculator() {
            const container = document.getElementById('testsContainer');
            const currentTests = soilTests.filter(t => !t.isArchived);

            if (currentTests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ§®</div>
                        <h3>No soil tests available</h3>
                        <p>Upload a soil test to calculate amendment recommendations</p>
                    </div>
                `;
                return;
            }

            // Build crop selector options grouped by category
            const cropOptions = Object.entries(CROP_CATEGORIES).map(([catKey, catName]) => {
                const crops = Object.entries(CROP_NUTRITION)
                    .filter(([key, crop]) => crop.category === catKey)
                    .map(([key, crop]) => `<option value="${key}" ${selectedCrop === key ? 'selected' : ''}>${crop.name}</option>`)
                    .join('');
                return crops ? `<optgroup label="${catName}">${crops}</optgroup>` : '';
            }).join('');

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">Amendment Calculator (Albrecht / Steve Solomon Method)</h3>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        Select a soil test and target crop to calculate amendment recommendations based on base cation saturation ratios (BCSR)
                        adjusted for crop-specific nutritional needs.
                    </p>

                    <!-- Row 1: Soil Test & Crop Selection -->
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 500;">Soil Test:</label>
                            <select id="amendmentTestSelect" onchange="updateAmendmentCalc()" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #e2e8f0;">
                                ${currentTests.map(t => `<option value="${t.id}">${t.sampleLocation} - ${formatDate(t.testDate)}</option>`).join('')}
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 500;">Target Crop:</label>
                            <select id="cropSelect" onchange="onCropChange()" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #e2e8f0; min-width: 180px;">
                                ${cropOptions}
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Calculator Mode -->
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                        <label style="font-weight: 500;">Calculator Mode:</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="setCalcMode('efficient')" id="modeEfficient"
                                class="btn ${calculatorMode === 'efficient' ? 'btn-success' : 'btn-secondary'}"
                                style="padding: 0.5rem 1rem; font-size: 0.875rem; ${calculatorMode !== 'efficient' ? 'color: #64748b;' : ''}">
                                Most Efficient
                            </button>
                            <button onclick="setCalcMode('costEffective')" id="modeCost"
                                class="btn ${calculatorMode === 'costEffective' ? 'btn-success' : 'btn-secondary'}"
                                style="padding: 0.5rem 1rem; font-size: 0.875rem; ${calculatorMode !== 'costEffective' ? 'color: #64748b;' : ''}">
                                Most Cost Effective
                            </button>
                            <button onclick="setCalcMode('inventory')" id="modeInventory"
                                class="btn ${calculatorMode === 'inventory' ? 'btn-success' : 'btn-secondary'}"
                                style="padding: 0.5rem 1rem; font-size: 0.875rem; ${calculatorMode !== 'inventory' ? 'color: #64748b;' : ''}">
                                Use Products on Hand
                            </button>
                        </div>
                    </div>

                    <!-- Row 3: Area Size -->
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <label style="font-weight: 500;">Area Size:</label>
                        <input type="number" id="areaSize" value="1" min="0.01" step="0.01" style="padding: 0.5rem; width: 80px; border-radius: 0.375rem; border: 1px solid #e2e8f0;" onchange="updateAmendmentCalc()">
                        <select id="areaUnit" onchange="updateAmendmentCalc()" style="padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #e2e8f0;">
                            <option value="acre">acres</option>
                            <option value="sqft">sq ft</option>
                            <option value="bed">100ft beds</option>
                        </select>
                    </div>
                </div>
                <div id="amendmentResults"></div>
            `;

            updateAmendmentCalc();
        }

        function onCropChange() {
            selectedCrop = document.getElementById('cropSelect').value;
            updateAmendmentCalc();
        }

        function setCalcMode(mode) {
            calculatorMode = mode;
            // Re-render to update button styles
            renderAmendmentCalculator();
        }

        // Helper to get cost estimate for any amendment
        function getAmendmentCost(materialName, amountLbs) {
            const costMap = {
                'Agricultural Lime': 'agLime',
                'Dolomite Lime': 'dolomite',
                'Gypsum': 'gypsum',
                'Elemental Sulfur': 'elementalSulfur',
                'Blood Meal': 'bloodMeal',
                'Feather Meal': 'featherMeal',
                'Soybean Meal': 'soybeanMeal',
                'Fish Meal': 'fishMeal',
                'Alfalfa Meal': 'alfalfaMeal',
                'Chilean Nitrate': 'sodiumNitrate',
                'Bone Meal (steamed)': 'boneMeal',
                'Soft Rock Phosphate (Calphos)': 'softRockPhosphate',
                'Soft Rock Phosphate': 'softRockPhosphate',
                'Hard Rock Phosphate': 'hardRockPhosphate',
                'Potassium Sulfate (0-0-50)': 'potassiumSulfate',
                'Potassium Sulfate': 'potassiumSulfate',
                'Sul-Po-Mag (K-Mag)': 'kMag',
                'K-Mag': 'kMag',
                'Greensand': 'greensand',
                'Kelp Meal': 'kelpMeal',
                'Azomite': 'azomite',
                'Epsom Salt (Magnesium Sulfate)': 'magnesiumSulfate',
                'Epsom Salt': 'magnesiumSulfate',
                'Borax': 'borax',
                'Iron Sulfate': 'ironSulfate',
                'Zinc Sulfate': 'zincSulfate',
                'Copper Sulfate': 'copperSulfate',
                'Manganese Sulfate': 'manganeseSulfate'
            };
            const key = costMap[materialName];
            if (key && AMENDMENT_COSTS[key]) {
                const cost = AMENDMENT_COSTS[key].perLb * amountLbs;
                return cost > 0 ? '$' + cost.toFixed(2) : 'Free';
            }
            return '-';
        }

        // Helper function to build recommendation table row - always shows cost now
        function buildRecommendationRow(r, areaInAcres, mode) {
            const yourAmount = typeof r.amount === 'number' ? r.amount * areaInAcres : 0;
            let displayAmount;
            if (r.isTotal) {
                displayAmount = '-';
            } else if (yourAmount < 1) {
                displayAmount = (yourAmount * 16).toFixed(1) + ' oz';
            } else {
                displayAmount = yourAmount.toFixed(1) + ' lbs';
            }

            // Special styling for the total row
            const rowStyle = r.isTotal ? 'background: #f0fdf4; font-weight: bold;' : '';
            const materialStyle = r.isTotal ? 'color: #10b981; font-size: 1rem;' : '';
            const costStyle = r.isTotal ? 'color: #10b981; font-size: 1.1rem; font-weight: bold;' : 'color: #3b82f6;';

            // Always calculate and show cost
            let costValue = r.estimatedCost || getAmendmentCost(r.material, typeof r.amount === 'number' ? r.amount : 0);
            let costCell = '<td style="' + costStyle + '">' + costValue + '</td>';

            return '<tr style="' + rowStyle + '">' +
                '<td><strong style="' + materialStyle + '">' + r.material + '</strong></td>' +
                '<td>' + r.amount + ' ' + (r.unit || '') + '</td>' +
                '<td style="color: #7c3aed; font-weight: 600;">' + displayAmount + '</td>' +
                '<td>' + r.provides + '</td>' +
                costCell +
                '<td style="font-size: 0.75rem; color: #64748b;">' + (r.notes || '') + '</td>' +
                '</tr>';
        }

        function updateAmendmentCalc() {
            const testId = parseInt(document.getElementById('amendmentTestSelect').value);
            const areaSize = parseFloat(document.getElementById('areaSize').value) || 1;
            const areaUnit = document.getElementById('areaUnit').value;

            const test = soilTests.find(t => t.id === testId);
            if (!test) return;

            // Convert area to acres
            let areaInAcres = areaSize;
            if (areaUnit === 'sqft') {
                areaInAcres = areaSize / 43560;
            } else if (areaUnit === 'bed') {
                areaInAcres = (areaSize * 100 * 4) / 43560; // Assume 4ft wide beds
            }

            const targets = calculateTargets(test, selectedCrop);
            const deficits = calculateDeficits(test, targets);

            // Use appropriate calculator based on mode
            let recommendations;
            if (calculatorMode === 'costEffective') {
                recommendations = calculateAmendmentsCostEffective(test, deficits);
            } else {
                recommendations = calculateAmendments(test, deficits);
            }

            const resultsDiv = document.getElementById('amendmentResults');

            // Check pH compatibility with crop
            let phWarning = '';
            if (targets.cropPH && test.ph) {
                const [minPH, maxPH] = targets.cropPH;
                if (test.ph < minPH) {
                    phWarning = `<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0.25rem;">
                        <strong>pH Alert:</strong> Your soil pH (${test.ph}) is below the ideal range for ${targets.cropName} (${minPH}-${maxPH}). Consider adding lime to raise pH.
                    </div>`;
                } else if (test.ph > maxPH) {
                    phWarning = `<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0.25rem;">
                        <strong>pH Alert:</strong> Your soil pH (${test.ph}) is above the ideal range for ${targets.cropName} (${minPH}-${maxPH}). Consider adding sulfur to lower pH.
                    </div>`;
                }
            }

            // Crop info box
            let cropInfo = '';
            if (selectedCrop !== 'none') {
                const crop = CROP_NUTRITION[selectedCrop];
                cropInfo = `
                    <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0.25rem;">
                        <strong>Crop Requirements for ${crop.name}:</strong>
                        <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem; flex-wrap: wrap; font-size: 0.875rem;">
                            <span>N: ${crop.N} lbs/acre</span>
                            <span>P: ${crop.P[0]}-${crop.P[1]} lbs/acre</span>
                            <span>K: ${crop.K[0]}-${crop.K[1]} lbs/acre</span>
                            <span>Ideal pH: ${crop.pH[0]}-${crop.pH[1]}</span>
                        </div>
                    </div>
                `;
            }

            // Mode indicator
            let modeInfo = '';
            if (calculatorMode === 'costEffective') {
                modeInfo = `<div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0.25rem;">
                    <strong>ðŸ’° Cost-Effective Mode:</strong> Recommendations optimized to minimize total cost while meeting soil needs. Prices are approximate retail - bulk orders may save 20-40%.
                </div>`;
            } else if (calculatorMode === 'inventory') {
                modeInfo = `<div style="background: #e0e7ff; border-left: 4px solid #6366f1; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0.25rem;">
                    <strong>Inventory Mode:</strong> Recommendations limited to products you have on hand. (Connect to inventory to enable)
                </div>`;
            }

            resultsDiv.innerHTML = `
                ${phWarning}
                ${cropInfo}
                ${modeInfo}
                <!-- Soil Summary -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Soil Test Summary: ${test.sampleLocation}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                        <div><strong>pH:</strong> ${test.ph} ${targets.cropPH ? `<small>(crop needs ${targets.cropPH[0]}-${targets.cropPH[1]})</small>` : ''}</div>
                        <div><strong>CEC:</strong> ${test.cec}</div>
                        <div><strong>OM%:</strong> ${test.organicMatter}%</div>
                        <div><strong>Ca%:</strong> ${test.caPct}% <small>(ideal 60-70%)</small></div>
                        <div><strong>Mg%:</strong> ${test.mgPct}% <small>(ideal 10-20%)</small></div>
                        <div><strong>K%:</strong> ${test.kPct}% <small>(ideal 2-5%)</small></div>
                    </div>
                </div>

                <!-- Targets & Deficits -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Calculated Targets & Deficits (lbs/acre)</h4>
                    <table class="ranges-table">
                        <tr>
                            <th>Element</th>
                            <th>Target</th>
                            <th>Current</th>
                            <th>Deficit</th>
                        </tr>
                        <tr>
                            <td>Calcium</td>
                            <td>${targets.calcium}</td>
                            <td>${test.caFound || 'N/A'}</td>
                            <td style="color: ${deficits.calcium > 0 ? '#ef4444' : '#10b981'}">${deficits.calcium}</td>
                        </tr>
                        <tr>
                            <td>Magnesium</td>
                            <td>${targets.magnesium}</td>
                            <td>${test.mgFound || 'N/A'}</td>
                            <td style="color: ${deficits.magnesium > 0 ? '#ef4444' : '#10b981'}">${deficits.magnesium}</td>
                        </tr>
                        <tr>
                            <td>Potassium</td>
                            <td>${targets.potassium}</td>
                            <td>${test.kFound || 'N/A'}</td>
                            <td style="color: ${deficits.potassium > 0 ? '#ef4444' : '#10b981'}">${deficits.potassium}</td>
                        </tr>
                        <tr>
                            <td>Phosphorus</td>
                            <td>${targets.phosphorus}</td>
                            <td>${test.phosphorus || 'N/A'}</td>
                            <td style="color: ${deficits.phosphorus > 0 ? '#ef4444' : '#10b981'}">${deficits.phosphorus}</td>
                        </tr>
                        <tr>
                            <td>Sulfur</td>
                            <td>${targets.sulfur}</td>
                            <td>${test.sulfur ? test.sulfur * 2 : 'N/A'}</td>
                            <td style="color: ${deficits.sulfur > 0 ? '#ef4444' : '#10b981'}">${Math.round(deficits.sulfur)}</td>
                        </tr>
                        <tr>
                            <td>Boron</td>
                            <td>${targets.boron}</td>
                            <td>${test.boron ? (test.boron * 2).toFixed(1) : 'N/A'}</td>
                            <td style="color: ${deficits.boron > 0 ? '#ef4444' : '#10b981'}">${deficits.boron.toFixed(1)}</td>
                        </tr>
                        <tr>
                            <td>Copper</td>
                            <td>${targets.copper}</td>
                            <td>${test.copper ? (test.copper * 2).toFixed(1) : 'N/A'}</td>
                            <td style="color: ${deficits.copper > 0 ? '#ef4444' : '#10b981'}">${deficits.copper.toFixed(1)}</td>
                        </tr>
                        <tr>
                            <td>Zinc</td>
                            <td>${targets.zinc}</td>
                            <td>${test.zinc ? (test.zinc * 2).toFixed(1) : 'N/A'}</td>
                            <td style="color: ${deficits.zinc > 0 ? '#ef4444' : '#10b981'}">${deficits.zinc.toFixed(1)}</td>
                        </tr>
                    </table>
                </div>

                <!-- Recommendations -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Amendment Recommendations for ${areaSize} ${areaUnit === 'acre' ? 'acre(s)' : areaUnit === 'sqft' ? 'sq ft' : '100ft bed(s)'}</h4>
                    <table class="ranges-table">
                        <tr>
                            <th>Material</th>
                            <th>Amount (per acre)</th>
                            <th>Your Area</th>
                            <th>Provides</th>
                            <th>Est. Cost</th>
                            <th>Notes</th>
                        </tr>
                        ${recommendations.map(r => buildRecommendationRow(r, areaInAcres, calculatorMode)).join('')}
                    </table>
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem; border-left: 4px solid #10b981;">
                        <strong>Application Tips:</strong>
                        <ul style="margin-top: 0.5rem; margin-left: 1.25rem; color: #166534;">
                            <li>Mix all minerals together before applying</li>
                            <li>Dig into top 6 inches of soil</li>
                            <li>Apply lime in fall if possible; other amendments in spring</li>
                            <li>Phosphorus and zinc are immobile - mix well</li>
                            <li>Retest soil same season next year</li>
                        </ul>
                    </div>

                    <!-- Plan Amendment Action -->
                    <div style="margin-top: 1.5rem; padding: 1.5rem; background: #f5f3ff; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <h4 style="color: #7c3aed; margin-bottom: 1rem;">Plan This Amendment</h4>
                        <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                            Create a planned amendment task with application date. The system will check your inventory and create order tasks for any missing products.
                        </p>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label style="font-weight: 500;">Application Date:</label>
                                <input type="date" id="amendmentDate" style="padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #e2e8f0;">
                            </div>
                            <button onclick="planAmendment()" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                                Create Planned Amendment
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Set default date to 2 weeks from now
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 14);
            setTimeout(() => {
                const dateInput = document.getElementById('amendmentDate');
                if (dateInput) {
                    dateInput.value = defaultDate.toISOString().split('T')[0];
                }
            }, 0);
        }

        // Store current recommendations for task creation
        let currentRecommendations = [];
        let currentTestLocation = '';
        let currentAreaInfo = '';

        function planAmendment() {
            const testId = parseInt(document.getElementById('amendmentTestSelect').value);
            const test = soilTests.find(t => t.id === testId);
            if (!test) return;

            const areaSize = parseFloat(document.getElementById('areaSize').value) || 1;
            const areaUnit = document.getElementById('areaUnit').value;
            const applicationDate = document.getElementById('amendmentDate').value;

            if (!applicationDate) {
                showToast('Please select an application date', 'error');
                return;
            }

            // Convert area to acres for calculations
            let areaInAcres = areaSize;
            if (areaUnit === 'sqft') {
                areaInAcres = areaSize / 43560;
            } else if (areaUnit === 'bed') {
                areaInAcres = (areaSize * 100 * 4) / 43560;
            }

            const targets = calculateTargets(test, selectedCrop);
            const deficits = calculateDeficits(test, targets);

            // Use appropriate calculator based on mode
            let recommendations;
            if (calculatorMode === 'costEffective') {
                recommendations = calculateAmendmentsCostEffective(test, deficits);
            } else {
                recommendations = calculateAmendments(test, deficits);
            }

            // Filter out the total row for planned amendments
            const actualRecommendations = recommendations.filter(r => !r.isTotal);

            const areaLabel = areaUnit === 'acre' ? `${areaSize} acre(s)` :
                              areaUnit === 'sqft' ? `${areaSize} sq ft` :
                              `${areaSize} 100ft bed(s)`;

            const cropName = selectedCrop !== 'none' ? CROP_NUTRITION[selectedCrop].name : 'General';

            // Create the planned amendment record
            const plannedAmendment = {
                id: Date.now(),
                testId: test.id,
                location: test.sampleLocation,
                crop: cropName,
                applicationDate: applicationDate,
                areaSize: areaSize,
                areaUnit: areaUnit,
                areaLabel: areaLabel,
                calculatorMode: calculatorMode,
                recommendations: actualRecommendations.map(r => ({
                    material: r.material,
                    amountPerAcre: r.amount,
                    amountForArea: typeof r.amount === 'number' ? r.amount * areaInAcres : 0,
                    unit: r.unit,
                    provides: r.provides,
                    estimatedCost: r.estimatedCost || null
                })),
                status: 'planned',
                createdAt: new Date().toISOString()
            };

            // Store in local storage
            let plannedAmendments = JSON.parse(localStorage.getItem('plannedAmendments') || '[]');
            plannedAmendments.push(plannedAmendment);
            localStorage.setItem('plannedAmendments', JSON.stringify(plannedAmendments));

            // Sync to backend
            syncToBackend('saveSoilAmendment', {
                date: plannedAmendment.createdAt,
                field: plannedAmendment.location,
                zone: plannedAmendment.areaLabel,
                products: plannedAmendment.recommendations.map(r => r.material).join(', '),
                rates: plannedAmendment.recommendations.map(r => `${r.amountPerAcre} ${r.unit}/ac`).join(', '),
                status: plannedAmendment.status,
                plannedDate: plannedAmendment.applicationDate,
                notes: `Crop: ${plannedAmendment.crop}, Area: ${plannedAmendment.areaSize} ${plannedAmendment.areaUnit}`,
                source: 'soil_test_recommendation'
            }).then(result => {
                if (result.success && result.id) {
                    let amendments = JSON.parse(localStorage.getItem('plannedAmendments') || '[]');
                    const idx = amendments.findIndex(a => a.id === plannedAmendment.id);
                    if (idx !== -1) {
                        amendments[idx].backendId = result.id;
                        amendments[idx].synced = true;
                        localStorage.setItem('plannedAmendments', JSON.stringify(amendments));
                    }
                }
            });

            // Create task for the amendment application
            createAmendmentTask(plannedAmendment);

            // Check inventory and create order tasks if needed
            checkInventoryAndCreateOrderTasks(recommendations, areaInAcres);

            showToast(`Planned amendment created for ${test.sampleLocation} on ${formatDate(applicationDate)}`, 'success');
        }

        async function createAmendmentTask(amendment) {
            // Build task description
            const materialsText = amendment.recommendations
                .map(r => `${r.material}: ${r.amountForArea < 1 ? (r.amountForArea * 16).toFixed(1) + ' oz' : r.amountForArea.toFixed(1) + ' lbs'}`)
                .join(', ');

            const taskData = {
                title: `Apply soil amendments - ${amendment.location}`,
                description: `Apply amendments for ${amendment.crop} in ${amendment.areaLabel}:\n${materialsText}`,
                dueDate: amendment.applicationDate,
                category: 'Soil Management',
                priority: 'medium',
                location: amendment.location,
                tags: ['amendment', 'soil']
            };

            try {
                // Try to save to backend
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'createTask',
                        data: taskData
                    })
                });

                const result = await response.json();
                if (result.success) {
                } else {
                }
            } catch (error) {
            }
        }

        async function checkInventoryAndCreateOrderTasks(recommendations, areaInAcres) {
            // For now, log the inventory check - will connect to actual inventory later
            console.log('Inventory check for:', recommendations.map(r => ({
                material: r.material,
                needed: r.amount * areaInAcres
            })));

            // TODO: Connect to inventory system
            // For each recommendation, check if product is in inventory
            // If not enough in stock, create an order task
        }

        // Amendments Database Viewer
        let dbSearchTerm = '';
        let dbCategoryFilter = 'all';
        let dbSourceFilter = 'all';

        function renderAmendmentsDatabase() {
            const container = document.getElementById('testsContainer');

            // Get all unique sources
            const sources = new Set();
            Object.values(AMENDMENTS_DATABASE).forEach(cat => {
                Object.values(cat.items).forEach(item => {
                    if (item.source) sources.add(item.source);
                });
            });

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 0.5rem;">Amendments Database</h3>
                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">
                        Comprehensive database of soil amendments incorporating Albrecht method, Soil Food Web (Dr. Elaine Ingham),
                        and Advancing Eco Agriculture approaches. Sources include Ohio Earth Food, Fedco Seeds, and AEA.
                    </p>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <input type="text"
                               id="dbSearch"
                               placeholder="Search amendments..."
                               value="${dbSearchTerm}"
                               onkeyup="filterAmendmentsDatabase()"
                               style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #e2e8f0; flex: 1; min-width: 200px;">
                        <select id="dbCategory" onchange="filterAmendmentsDatabase()" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #e2e8f0;">
                            <option value="all">All Categories</option>
                            ${Object.entries(AMENDMENTS_DATABASE).map(([key, cat]) =>
                                `<option value="${key}" ${dbCategoryFilter === key ? 'selected' : ''}>${cat.category}</option>`
                            ).join('')}
                        </select>
                        <select id="dbSource" onchange="filterAmendmentsDatabase()" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #e2e8f0;">
                            <option value="all">All Sources</option>
                            <option value="omri" ${dbSourceFilter === 'omri' ? 'selected' : ''}>OMRI Listed Only</option>
                            <option value="soilFoodWeb" ${dbSourceFilter === 'soilFoodWeb' ? 'selected' : ''}>Soil Food Web</option>
                            ${[...sources].map(s => `<option value="${s}" ${dbSourceFilter === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="dbResults"></div>
            `;

            filterAmendmentsDatabase();
        }

        function filterAmendmentsDatabase() {
            dbSearchTerm = document.getElementById('dbSearch').value.toLowerCase();
            dbCategoryFilter = document.getElementById('dbCategory').value;
            dbSourceFilter = document.getElementById('dbSource').value;

            const resultsDiv = document.getElementById('dbResults');
            let html = '';
            let totalCount = 0;

            Object.entries(AMENDMENTS_DATABASE).forEach(([catKey, category]) => {
                // Filter by category
                if (dbCategoryFilter !== 'all' && dbCategoryFilter !== catKey) return;

                const filteredItems = Object.entries(category.items).filter(([key, item]) => {
                    // Search filter
                    const searchMatch = !dbSearchTerm ||
                        item.name.toLowerCase().includes(dbSearchTerm) ||
                        (item.notes && item.notes.toLowerCase().includes(dbSearchTerm)) ||
                        (item.npk && item.npk.includes(dbSearchTerm));

                    // Source filter
                    let sourceMatch = true;
                    if (dbSourceFilter === 'omri') {
                        sourceMatch = item.omri === true;
                    } else if (dbSourceFilter === 'soilFoodWeb') {
                        sourceMatch = item.soilFoodWeb === true;
                    } else if (dbSourceFilter !== 'all') {
                        sourceMatch = item.source === dbSourceFilter;
                    }

                    return searchMatch && sourceMatch;
                });

                if (filteredItems.length === 0) return;

                totalCount += filteredItems.length;

                html += `
                    <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="color: #7c3aed; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="${category.icon || 'fas fa-seedling'}"></i>
                            ${category.category} (${filteredItems.length})
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                            ${filteredItems.map(([key, item]) => renderAmendmentCard(item)).join('')}
                        </div>
                    </div>
                `;
            });

            if (totalCount === 0) {
                html = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ”</div>
                        <h3>No amendments found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        function renderAmendmentCard(item) {
            // Build nutrient badges
            let nutrients = [];
            if (item.N) nutrients.push(`N: ${(item.N * 100).toFixed(0)}%`);
            if (item.P) nutrients.push(`P: ${(item.P * 100).toFixed(0)}%`);
            if (item.K) nutrients.push(`K: ${(item.K * 100).toFixed(0)}%`);
            if (item.Ca) nutrients.push(`Ca: ${(item.Ca * 100).toFixed(0)}%`);
            if (item.Mg) nutrients.push(`Mg: ${(item.Mg * 100).toFixed(0)}%`);
            if (item.S) nutrients.push(`S: ${(item.S * 100).toFixed(0)}%`);
            if (item.B) nutrients.push(typeof item.B === 'number' ? `B: ${(item.B * 100).toFixed(0)}%` : 'B');
            if (item.Fe) nutrients.push(typeof item.Fe === 'number' ? `Fe: ${(item.Fe * 100).toFixed(0)}%` : 'Fe');
            if (item.Mn) nutrients.push(typeof item.Mn === 'number' ? `Mn: ${(item.Mn * 100).toFixed(0)}%` : 'Mn');
            if (item.Cu) nutrients.push(typeof item.Cu === 'number' ? `Cu: ${(item.Cu * 100).toFixed(0)}%` : 'Cu');
            if (item.Zn) nutrients.push(typeof item.Zn === 'number' ? `Zn: ${(item.Zn * 100).toFixed(0)}%` : 'Zn');
            if (item.Mo) nutrients.push(typeof item.Mo === 'number' ? `Mo: ${(item.Mo * 100).toFixed(0)}%` : 'Mo');
            if (item.Co) nutrients.push(typeof item.Co === 'number' ? `Co: ${(item.Co * 100).toFixed(0)}%` : 'Co');
            if (item.Si) nutrients.push(`Si: ${(item.Si * 100).toFixed(0)}%`);
            if (item.trace) nutrients.push('Trace Minerals');

            return `
                <div style="background: #f8fafc; border-radius: 0.75rem; padding: 1rem; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h5 style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">${item.name}</h5>
                        <div style="display: flex; gap: 0.25rem;">
                            ${item.omri ? '<span style="background: #10b981; color: white; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 600;">OMRI</span>' : ''}
                            ${item.soilFoodWeb ? '<span style="background: #8b5cf6; color: white; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 600;">SFW</span>' : ''}
                        </div>
                    </div>
                    ${item.npk && item.npk !== '0-0-0' && item.npk !== 'variable' ? `<div style="font-size: 0.875rem; color: #7c3aed; font-weight: 600; margin-bottom: 0.5rem;">NPK: ${item.npk}</div>` : ''}
                    ${nutrients.length > 0 ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0.5rem;">
                            ${nutrients.slice(0, 6).map(n => `<span style="background: #e0e7ff; color: #4338ca; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem;">${n}</span>`).join('')}
                            ${nutrients.length > 6 ? `<span style="background: #f1f5f9; color: #64748b; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem;">+${nutrients.length - 6} more</span>` : ''}
                        </div>
                    ` : ''}
                    ${item.rate ? `<div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.375rem;"><strong>Rate:</strong> ${item.rate}</div>` : ''}
                    ${item.notes ? `<div style="font-size: 0.75rem; color: #475569; line-height: 1.4;">${item.notes}</div>` : ''}
                    ${item.source ? `<div style="font-size: 0.625rem; color: #94a3b8; margin-top: 0.375rem; font-style: italic;">Source: ${item.source}</div>` : ''}
                </div>
            `;
        }

        // ============================================
        // USDA ORGANIC COMPLIANCE TAB
        // ============================================

        // Compliance records storage
        let complianceRecords = JSON.parse(localStorage.getItem('complianceRecords') || '[]');

        function renderComplianceTab() {
            const container = document.getElementById('testsContainer');

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">USDA Organic Compliance Records</h3>
                            <p style="color: #64748b; font-size: 0.875rem;">
                                Track all material inputs for USDA Organic certification. Maintain records of amendments, fertilizers, and other inputs applied to your fields.
                            </p>
                        </div>
                        <button onclick="showAddComplianceRecord()" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                            + Add Input Record
                        </button>
                    </div>

                    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.25rem; margin-bottom: 1rem;">
                        <strong>Certification Tip:</strong> Keep records of all materials applied to certified organic land for at least 5 years. Include date, material, rate, field, and OMRI status.
                    </div>

                    <!-- Filters -->
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
                        <input type="text" id="complianceSearch" placeholder="Search records..."
                            oninput="filterComplianceRecords()"
                            style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #e2e8f0; flex: 1; min-width: 200px;">
                        <select id="complianceYear" onchange="filterComplianceRecords()" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #e2e8f0;">
                            <option value="all">All Years</option>
                            ${getComplianceYears().map(y => `<option value="${y}">${y}</option>`).join('')}
                        </select>
                        <select id="complianceField" onchange="filterComplianceRecords()" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #e2e8f0;">
                            <option value="all">All Fields</option>
                            ${getComplianceFields().map(f => `<option value="${f}">${f}</option>`).join('')}
                        </select>
                        <button onclick="exportComplianceCSV()" class="btn btn-secondary" style="color: #64748b; padding: 0.5rem 1rem;">
                            Export CSV
                        </button>
                        <button onclick="syncAllComplianceRecords()" class="btn btn-success" style="padding: 0.5rem 1rem;">
                            â˜ï¸ Sync to Sheets
                        </button>
                    </div>

                    <!-- Sync Status -->
                    <div id="syncStatus" style="margin-top: 0.5rem; font-size: 0.75rem; color: #64748b;">
                        ${getComplianceSyncStatus()}
                    </div>
                </div>

                <div id="complianceRecordsContainer"></div>

                <!-- Add/Edit Modal -->
                <div id="complianceModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 1rem; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                            <h3 id="complianceModalTitle">Add Input Record</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <form id="complianceForm" onsubmit="saveComplianceRecord(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label>Application Date *</label>
                                        <input type="date" id="compAppDate" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Field/Location *</label>
                                        <select id="compField" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <option value="">-- Select Field --</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label>Planting/Batch</label>
                                        <select id="compBatch" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <option value="">-- Select Planting (Optional) --</option>
                                        </select>
                                        <small style="color: #64748b; font-size: 0.75rem;">Links this input to a specific crop planting</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Product Category</label>
                                        <select id="compCategory" onchange="filterComplianceProducts()" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <option value="">-- All Categories --</option>
                                            <option value="AMENDMENT">Amendments</option>
                                            <option value="FERTILIZER">Fertilizers</option>
                                            <option value="PESTICIDE">Pesticides</option>
                                            <option value="BIOLOGICAL">Biologicals</option>
                                            <option value="SEED">Seeds</option>
                                            <option value="SUPPLY">Supplies</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Material/Product Name *</label>
                                    <select id="compMaterial" required onchange="autoFillProductDetails()" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">-- Select Product --</option>
                                    </select>
                                    <div id="compProductInfo" style="margin-top: 0.5rem; padding: 0.5rem; background: #f0fdf4; border-radius: 0.25rem; font-size: 0.85rem; display: none;">
                                        <span id="compProductStock" style="color: #166534;"></span>
                                    </div>
                                    <div style="margin-top: 0.5rem;">
                                        <label style="font-size: 0.85rem; color: #64748b;">
                                            <input type="checkbox" id="compManualEntry" onchange="toggleManualProductEntry()">
                                            Product not in inventory? Enter manually
                                        </label>
                                        <input type="text" id="compMaterialManual" placeholder="Enter product name manually" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; margin-top: 0.25rem; display: none;">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label>Application Rate *</label>
                                        <input type="text" id="compRate" required placeholder="e.g., 500 lbs/acre, 2 gal/100 ft" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    </div>
                                    <div class="form-group">
                                        <label>Total Amount Used</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="number" step="0.01" id="compAmount" placeholder="e.g., 10" style="flex: 1; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <select id="compAmountUnit" style="width: 80px; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                                <option value="">unit</option>
                                                <option value="lb">lb</option>
                                                <option value="oz">oz</option>
                                                <option value="gal">gal</option>
                                                <option value="qt">qt</option>
                                                <option value="pt">pt</option>
                                                <option value="fl oz">fl oz</option>
                                                <option value="each">each</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label>OMRI Status *</label>
                                        <select id="compOMRI" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <option value="omri">OMRI Listed</option>
                                            <option value="approved">Approved by Certifier</option>
                                            <option value="restricted">Restricted Use</option>
                                            <option value="pending">Pending Review</option>
                                            <option value="not_listed">Not Listed</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Applied By</label>
                                        <input type="text" id="compAppliedBy" placeholder="e.g., Sam, John" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    </div>
                                </div>

                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Manufacturer/Supplier</label>
                                    <input type="text" id="compManufacturer" placeholder="Auto-filled from product or enter manually" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>

                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Photo Documentation</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                        <button type="button" onclick="captureCompliancePhoto()" style="background: #7c3aed; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="font-size: 1.2em;">&#128247;</span> Take Photo
                                        </button>
                                        <input type="file" id="compPhotoFile" accept="image/*" capture="environment" onchange="handleCompliancePhotoFile(event)" style="display: none;">
                                        <button type="button" onclick="document.getElementById('compPhotoFile').click()" style="background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                            Upload File
                                        </button>
                                    </div>
                                    <div id="compPhotoPreview" style="margin-top: 0.5rem; display: none;">
                                        <img id="compPhotoImg" style="max-width: 200px; max-height: 150px; border-radius: 0.375rem; border: 1px solid #e2e8f0;">
                                        <button type="button" onclick="clearCompliancePhoto()" style="margin-left: 0.5rem; background: #fee2e2; color: #dc2626; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem;">Remove</button>
                                    </div>
                                    <input type="hidden" id="compPhotoUrl">
                                    <input type="hidden" id="compPhotoBase64">
                                </div>

                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Notes</label>
                                    <textarea id="compNotes" rows="2" placeholder="Additional details, lot numbers, application method..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                                </div>

                                <input type="hidden" id="compRecordId">

                                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button type="button" onclick="closeComplianceModal()" class="btn btn-secondary" style="color: #64748b;">Cancel</button>
                                    <button type="submit" class="btn btn-success">Save Record</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            filterComplianceRecords();
        }

        function getComplianceYears() {
            const years = new Set();
            complianceRecords.forEach(r => {
                if (r.applicationDate) {
                    years.add(new Date(r.applicationDate).getFullYear());
                }
            });
            return [...years].sort((a, b) => b - a);
        }

        function getComplianceFields() {
            const fields = new Set();
            complianceRecords.forEach(r => {
                if (r.field) fields.add(r.field);
            });
            return [...fields].sort();
        }

        function getComplianceSyncStatus() {
            const total = complianceRecords.length;
            const synced = complianceRecords.filter(r => r.syncedToSheets).length;
            const unsynced = total - synced;

            if (total === 0) return '';
            if (unsynced === 0) {
                return `<span style="color: #10b981;">âœ“ All ${total} records synced to Google Sheets</span>`;
            }
            return `<span style="color: #f59e0b;">${synced}/${total} records synced â€¢ ${unsynced} pending sync</span>`;
        }

        function filterComplianceRecords() {
            const search = (document.getElementById('complianceSearch')?.value || '').toLowerCase();
            const year = document.getElementById('complianceYear')?.value || 'all';
            const field = document.getElementById('complianceField')?.value || 'all';

            let filtered = complianceRecords.filter(r => {
                const matchSearch = !search ||
                    r.material?.toLowerCase().includes(search) ||
                    r.field?.toLowerCase().includes(search) ||
                    r.crop?.toLowerCase().includes(search);
                const matchYear = year === 'all' || (r.applicationDate && new Date(r.applicationDate).getFullYear().toString() === year);
                const matchField = field === 'all' || r.field === field;
                return matchSearch && matchYear && matchField;
            });

            filtered.sort((a, b) => new Date(b.applicationDate) - new Date(a.applicationDate));

            const container = document.getElementById('complianceRecordsContainer');
            if (!container) return;

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“‹</div>
                        <h3>No compliance records found</h3>
                        <p>Add your first input record to start tracking organic compliance</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; overflow: hidden;">
                    <table class="ranges-table" style="width: 100%;">
                        <thead>
                            <tr style="background: #f8fafc;">
                                <th>Date</th>
                                <th>Field</th>
                                <th>Material</th>
                                <th>Rate</th>
                                <th>OMRI</th>
                                <th>Batch</th>
                                <th style="text-align: center;">Photo</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(r => `
                                <tr>
                                    <td>${formatDate(r.applicationDate)}</td>
                                    <td><strong>${r.field}</strong></td>
                                    <td>${r.material}</td>
                                    <td>${r.rate}</td>
                                    <td>
                                        <span style="
                                            padding: 0.25rem 0.5rem;
                                            border-radius: 9999px;
                                            font-size: 0.75rem;
                                            font-weight: 500;
                                            background: ${r.omriStatus === 'omri' ? '#dcfce7' : r.omriStatus === 'approved' ? '#dbeafe' : r.omriStatus === 'restricted' ? '#fef3c7' : r.omriStatus === 'not_listed' ? '#fecaca' : '#f1f5f9'};
                                            color: ${r.omriStatus === 'omri' ? '#166534' : r.omriStatus === 'approved' ? '#1e40af' : r.omriStatus === 'restricted' ? '#92400e' : r.omriStatus === 'not_listed' ? '#991b1b' : '#64748b'};
                                        ">
                                            ${r.omriStatus === 'omri' ? 'OMRI' : r.omriStatus === 'approved' ? 'Approved' : r.omriStatus === 'restricted' ? 'Restricted' : r.omriStatus === 'not_listed' ? 'Not Listed' : 'Pending'}
                                        </span>
                                    </td>
                                    <td>${r.batchId ? `<span style="font-family: monospace; font-size: 0.8rem; background: #e0e7ff; padding: 0.125rem 0.5rem; border-radius: 0.25rem;">${r.batchId}</span>` : '-'}</td>
                                    <td style="text-align: center;">${r.photoUrl ? `<a href="${r.photoUrl}" target="_blank" style="color: #22c55e; text-decoration: none;" title="View photo">&#128247;</a>` : '-'}</td>
                                    <td>
                                        <button onclick="editComplianceRecord('${r.id}')" style="background: none; border: none; color: #7c3aed; cursor: pointer; padding: 0.25rem;">Edit</button>
                                        <button onclick="deleteComplianceRecord('${r.id}')" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.25rem;">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem; text-align: center; color: #166534;">
                    <strong>${filtered.length}</strong> record(s) | Total records this year: <strong>${complianceRecords.filter(r => r.applicationDate && new Date(r.applicationDate).getFullYear() === new Date().getFullYear()).length}</strong>
                </div>
            `;
        }

        async function showAddComplianceRecord() {
            document.getElementById('complianceModalTitle').textContent = 'Add Input Record';
            document.getElementById('complianceForm').reset();
            document.getElementById('compRecordId').value = '';
            document.getElementById('compAppDate').value = new Date().toISOString().split('T')[0];

            // Populate field dropdown from FARM_FIELDS
            const fieldSelect = document.getElementById('compField');
            fieldSelect.innerHTML = '<option value="">-- Select Field --</option>' +
                Object.keys(FARM_FIELDS).map(f =>
                    `<option value="${f}">${f} (${FARM_FIELDS[f].acreage} ac)</option>`
                ).join('');

            // Load inventory products if not already loaded
            if (inventoryProducts.length === 0) {
                try {
                    const result = await loadFromBackend('getInventoryProducts');
                    inventoryProducts = result.data || [];
                } catch (e) {
                    console.log('Could not load inventory products:', e);
                }
            }

            // Populate products dropdown
            filterComplianceProducts();

            // Populate batch dropdown with active plantings (if available)
            populateComplianceBatchDropdown();

            // Reset manual entry mode
            document.getElementById('compManualEntry').checked = false;
            document.getElementById('compMaterialManual').style.display = 'none';
            document.getElementById('compMaterial').style.display = 'block';
            document.getElementById('compProductInfo').style.display = 'none';

            // Clear photo preview
            clearCompliancePhoto();

            document.getElementById('complianceModal').style.display = 'flex';
        }

        // Filter products dropdown by category
        function filterComplianceProducts() {
            const category = document.getElementById('compCategory').value;
            const productSelect = document.getElementById('compMaterial');

            let filtered = inventoryProducts;
            if (category) {
                filtered = inventoryProducts.filter(p => p.Category === category);
            }

            productSelect.innerHTML = '<option value="">-- Select Product --</option>' +
                filtered.map(p =>
                    `<option value="${p.Product_ID}" data-name="${p.Product_Name}" data-omri="${p.OMRI_Status || ''}" data-mfg="${p.Manufacturer || ''}" data-qty="${p.Current_Qty || 0}" data-unit="${p.Unit || ''}">${p.Product_Name}${p.Manufacturer ? ' - ' + p.Manufacturer : ''}</option>`
                ).join('');
        }

        // Auto-fill product details when selection changes
        function autoFillProductDetails() {
            const productSelect = document.getElementById('compMaterial');
            const selectedOption = productSelect.options[productSelect.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                document.getElementById('compProductInfo').style.display = 'none';
                return;
            }

            // Auto-fill OMRI status
            const omriStatus = selectedOption.dataset.omri;
            if (omriStatus) {
                const omriMap = {
                    'OMRI Listed': 'omri',
                    'Approved': 'approved',
                    'Restricted': 'restricted',
                    'Pending': 'pending',
                    'Not Listed': 'not_listed'
                };
                document.getElementById('compOMRI').value = omriMap[omriStatus] || 'omri';
            }

            // Auto-fill manufacturer
            const manufacturer = selectedOption.dataset.mfg;
            if (manufacturer) {
                document.getElementById('compManufacturer').value = manufacturer;
            }

            // Show current stock
            const qty = selectedOption.dataset.qty;
            const unit = selectedOption.dataset.unit;
            document.getElementById('compProductStock').textContent =
                `Current stock: ${qty} ${unit} in inventory`;
            document.getElementById('compProductInfo').style.display = 'block';

            // Set the amount unit to match product unit
            if (unit) {
                document.getElementById('compAmountUnit').value = unit;
            }
        }

        // Toggle manual product entry
        function toggleManualProductEntry() {
            const isManual = document.getElementById('compManualEntry').checked;
            document.getElementById('compMaterial').style.display = isManual ? 'none' : 'block';
            document.getElementById('compMaterial').required = !isManual;
            document.getElementById('compMaterialManual').style.display = isManual ? 'block' : 'none';
            document.getElementById('compMaterialManual').required = isManual;
            document.getElementById('compProductInfo').style.display = 'none';
        }

        // Populate batch dropdown with active plantings
        async function populateComplianceBatchDropdown() {
            const batchSelect = document.getElementById('compBatch');
            batchSelect.innerHTML = '<option value="">-- Select Planting (Optional) --</option>';

            try {
                // Try to load planning data from backend
                const result = await loadFromBackend('getPlanningData');
                if (result.data && result.data.length > 0) {
                    // Filter for active plantings
                    const activePlantings = result.data.filter(p =>
                        ['PLANNED', 'Sown', 'PLANTED', 'HARVESTING', 'GROWING'].includes(p.STATUS)
                    );

                    batchSelect.innerHTML += activePlantings.map(p =>
                        `<option value="${p.Batch_ID}">${p.Batch_ID} - ${p.Crop_Name || 'Unknown'} - ${p.Field || 'Unknown Field'}</option>`
                    ).join('');
                }
            } catch (e) {
                console.log('Could not load planting data for batch dropdown:', e);
            }
        }

        // ============================================
        // PHOTO CAPTURE FUNCTIONS
        // ============================================

        // Capture photo using device camera
        async function captureCompliancePhoto() {
            try {
                // Check if getUserMedia is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    // Fallback to file input
                    document.getElementById('compPhotoFile').click();
                    return;
                }

                // Create camera modal
                const cameraModal = document.createElement('div');
                cameraModal.id = 'cameraModal';
                cameraModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <video id="cameraVideo" autoplay playsinline style="max-width: 100%; max-height: 70vh; border-radius: 0.5rem;"></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button onclick="takeCameraSnapshot()" style="background: #22c55e; color: white; border: none; padding: 1rem 2rem; border-radius: 9999px; cursor: pointer; font-size: 1.1em; font-weight: bold;">
                                Capture
                            </button>
                            <button onclick="closeCameraModal()" style="background: #ef4444; color: white; border: none; padding: 1rem 2rem; border-radius: 9999px; cursor: pointer; font-size: 1.1em;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(cameraModal);

                // Start camera stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                window.currentCameraStream = stream;

            } catch (err) {
                console.log('Camera error:', err);
                // Fallback to file input
                document.getElementById('compPhotoFile').click();
            }
        }

        // Take snapshot from camera video
        function takeCameraSnapshot() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');

            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Compress and get base64
            const base64 = canvas.toDataURL('image/jpeg', 0.7);

            // Set preview
            setCompliancePhotoPreview(base64);

            // Close camera modal
            closeCameraModal();
        }

        // Close camera modal and stop stream
        function closeCameraModal() {
            if (window.currentCameraStream) {
                window.currentCameraStream.getTracks().forEach(track => track.stop());
                window.currentCameraStream = null;
            }
            const modal = document.getElementById('cameraModal');
            if (modal) modal.remove();
        }

        // Handle file input for photo
        function handleCompliancePhotoFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                // Compress the image
                compressImage(e.target.result, 800, 0.7, (compressedBase64) => {
                    setCompliancePhotoPreview(compressedBase64);
                });
            };
            reader.readAsDataURL(file);
        }

        // Compress image to reduce size
        function compressImage(base64, maxWidth, quality, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Scale down if needed
                if (width > maxWidth) {
                    height = Math.round((height * maxWidth) / width);
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                callback(canvas.toDataURL('image/jpeg', quality));
            };
            img.src = base64;
        }

        // Set photo preview and store base64
        function setCompliancePhotoPreview(base64) {
            document.getElementById('compPhotoImg').src = base64;
            document.getElementById('compPhotoBase64').value = base64;
            document.getElementById('compPhotoPreview').style.display = 'block';
        }

        // Clear photo preview
        function clearCompliancePhoto() {
            document.getElementById('compPhotoImg').src = '';
            document.getElementById('compPhotoBase64').value = '';
            document.getElementById('compPhotoUrl').value = '';
            document.getElementById('compPhotoPreview').style.display = 'none';
            document.getElementById('compPhotoFile').value = '';
        }

        // Upload photo to Google Drive and get URL
        async function uploadCompliancePhoto(base64) {
            if (!base64) return null;

            try {
                // Extract just the base64 data (remove data:image/jpeg;base64, prefix)
                const base64Data = base64.split(',')[1];

                const result = await syncToBackend('uploadProductPhoto', {
                    base64: base64Data,
                    fileName: `compliance_${Date.now()}.jpg`,
                    folder: 'Compliance_Photos'
                });

                if (result.success && result.url) {
                    return result.url;
                }
            } catch (e) {
                console.log('Photo upload error:', e);
            }
            return null;
        }

        function closeComplianceModal() {
            document.getElementById('complianceModal').style.display = 'none';
            // Clean up any camera stream
            closeCameraModal();
        }

        async function saveComplianceRecord(event) {
            event.preventDefault();

            const recordId = document.getElementById('compRecordId').value;
            const isManualEntry = document.getElementById('compManualEntry').checked;

            // Get product name - from dropdown or manual entry
            let productId = '';
            let materialName = '';
            if (isManualEntry) {
                materialName = document.getElementById('compMaterialManual').value;
            } else {
                const productSelect = document.getElementById('compMaterial');
                productId = productSelect.value;
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                materialName = selectedOption ? selectedOption.dataset.name : '';
            }

            const amountValue = document.getElementById('compAmount').value;
            const amountUnit = document.getElementById('compAmountUnit').value;
            const amountWithUnit = amountValue ? `${amountValue} ${amountUnit}`.trim() : '';

            // Handle photo upload
            let photoUrl = document.getElementById('compPhotoUrl').value;
            const photoBase64 = document.getElementById('compPhotoBase64').value;
            if (photoBase64 && !photoUrl) {
                // Upload new photo
                showToast('Uploading photo...', 'info');
                photoUrl = await uploadCompliancePhoto(photoBase64);
            }

            const record = {
                id: recordId || Date.now().toString(),
                date: document.getElementById('compAppDate').value,
                applicationDate: document.getElementById('compAppDate').value,
                field: document.getElementById('compField').value,
                productId: productId,
                product: materialName,
                material: materialName,
                rate: document.getElementById('compRate').value,
                amount: amountWithUnit,
                amountQty: parseFloat(amountValue) || 0,
                amountUnit: amountUnit,
                omriStatus: document.getElementById('compOMRI').value,
                batchId: document.getElementById('compBatch').value,
                appliedBy: document.getElementById('compAppliedBy').value,
                manufacturer: document.getElementById('compManufacturer').value,
                notes: document.getElementById('compNotes').value,
                photoUrl: photoUrl || '',
                updatedAt: new Date().toISOString()
            };

            if (recordId) {
                // Update existing
                const idx = complianceRecords.findIndex(r => r.id === recordId);
                if (idx !== -1) {
                    complianceRecords[idx] = record;
                }
            } else {
                // Add new
                complianceRecords.push(record);
            }

            // Save to localStorage first (immediate)
            localStorage.setItem('complianceRecords', JSON.stringify(complianceRecords));

            // Sync to backend (async)
            syncToBackend('saveComplianceRecord', record).then(result => {
                if (result.success) {
                    showToast('Compliance record saved & synced', 'success');
                } else {
                    showToast('Compliance record saved locally', 'success');
                }
            });

            // Deduct from inventory if product is from inventory and amount was entered
            if (productId && record.amountQty > 0) {
                try {
                    await syncToBackend('deductInventoryOnApplication', {
                        productId: productId,
                        qty: record.amountQty,
                        batchId: record.batchId,
                        field: record.field,
                        appliedBy: record.appliedBy,
                        notes: `Applied ${record.rate} - ${record.notes || ''}`
                    });
                    showToast('Inventory deducted', 'success');

                    // Update local inventory cache
                    const product = inventoryProducts.find(p => p.Product_ID === productId);
                    if (product) {
                        product.Current_Qty = (parseFloat(product.Current_Qty) || 0) - record.amountQty;
                    }
                } catch (e) {
                    console.log('Could not deduct inventory:', e);
                }
            }

            closeComplianceModal();
            filterComplianceRecords();
        }

        async function editComplianceRecord(id) {
            const record = complianceRecords.find(r => r.id === id);
            if (!record) return;

            document.getElementById('complianceModalTitle').textContent = 'Edit Input Record';

            // First populate the dropdowns
            const fieldSelect = document.getElementById('compField');
            fieldSelect.innerHTML = '<option value="">-- Select Field --</option>' +
                Object.keys(FARM_FIELDS).map(f =>
                    `<option value="${f}">${f} (${FARM_FIELDS[f].acreage} ac)</option>`
                ).join('');

            // Load inventory products if needed
            if (inventoryProducts.length === 0) {
                try {
                    const result = await loadFromBackend('getInventoryProducts');
                    inventoryProducts = result.data || [];
                } catch (e) {
                    console.log('Could not load inventory products:', e);
                }
            }
            filterComplianceProducts();
            await populateComplianceBatchDropdown();

            // Now set the values
            document.getElementById('compRecordId').value = record.id;
            document.getElementById('compAppDate').value = record.applicationDate;
            document.getElementById('compField').value = record.field;
            document.getElementById('compRate').value = record.rate;
            document.getElementById('compOMRI').value = record.omriStatus;
            document.getElementById('compManufacturer').value = record.manufacturer || '';
            document.getElementById('compNotes').value = record.notes || '';
            document.getElementById('compBatch').value = record.batchId || '';
            document.getElementById('compAppliedBy').value = record.appliedBy || '';

            // Handle amount - could be stored as "10 gal" or just "10"
            if (record.amountQty) {
                document.getElementById('compAmount').value = record.amountQty;
                document.getElementById('compAmountUnit').value = record.amountUnit || '';
            } else if (record.amount) {
                // Try to parse old format "10 gal"
                const parts = record.amount.match(/^([\d.]+)\s*(.*)$/);
                if (parts) {
                    document.getElementById('compAmount').value = parts[1];
                    document.getElementById('compAmountUnit').value = parts[2] || '';
                } else {
                    document.getElementById('compAmount').value = record.amount;
                }
            }

            // Handle product - either from inventory or manual entry
            if (record.productId) {
                document.getElementById('compManualEntry').checked = false;
                document.getElementById('compMaterial').style.display = 'block';
                document.getElementById('compMaterialManual').style.display = 'none';
                document.getElementById('compMaterial').value = record.productId;
                autoFillProductDetails();
            } else if (record.material) {
                // Manual entry - check if product exists in inventory by name
                const matchingProduct = inventoryProducts.find(p => p.Product_Name === record.material);
                if (matchingProduct) {
                    document.getElementById('compManualEntry').checked = false;
                    document.getElementById('compMaterial').style.display = 'block';
                    document.getElementById('compMaterialManual').style.display = 'none';
                    document.getElementById('compMaterial').value = matchingProduct.Product_ID;
                    autoFillProductDetails();
                } else {
                    document.getElementById('compManualEntry').checked = true;
                    document.getElementById('compMaterial').style.display = 'none';
                    document.getElementById('compMaterialManual').style.display = 'block';
                    document.getElementById('compMaterialManual').value = record.material;
                }
            }

            // Load existing photo if present
            if (record.photoUrl) {
                document.getElementById('compPhotoImg').src = record.photoUrl;
                document.getElementById('compPhotoUrl').value = record.photoUrl;
                document.getElementById('compPhotoPreview').style.display = 'block';
            } else {
                clearCompliancePhoto();
            }

            document.getElementById('complianceModal').style.display = 'flex';
        }

        function deleteComplianceRecord(id) {
            if (!confirm('Are you sure you want to delete this compliance record?')) return;
            complianceRecords = complianceRecords.filter(r => r.id !== id);
            localStorage.setItem('complianceRecords', JSON.stringify(complianceRecords));
            filterComplianceRecords();
            showToast('Record deleted', 'success');
        }

        function exportComplianceCSV() {
            const headers = ['Application Date', 'Field', 'Batch_ID', 'Material', 'Rate', 'Amount', 'OMRI Status', 'Applied_By', 'Manufacturer', 'Notes', 'Photo_URL'];
            const rows = complianceRecords.map(r => [
                r.applicationDate,
                r.field,
                r.batchId || '',
                r.material,
                r.rate,
                r.amount || '',
                r.omriStatus,
                r.appliedBy || '',
                r.manufacturer || '',
                (r.notes || '').replace(/"/g, '""'),
                r.photoUrl || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `organic_compliance_records_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported successfully', 'success');
        }

        // ============================================
        // AMENDMENT HISTORY TAB
        // ============================================

        function renderAmendmentHistory() {
            const container = document.getElementById('testsContainer');
            const plannedAmendments = JSON.parse(localStorage.getItem('plannedAmendments') || '[]');

            // Helper to format amendment display with variance
            function formatAmendmentItem(r, isCompleted) {
                if (!isCompleted || !r.recommendedAmountForArea) {
                    // Planned amendment - show simple display
                    const amt = r.amountForArea < 1 ? (r.amountForArea * 16).toFixed(1) + ' oz' : r.amountForArea.toFixed(1) + ' lbs';
                    return '<span style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">' +
                           r.material + ': ' + amt + '</span>';
                }

                // Completed amendment - show recommended vs actual
                const recAmt = r.recommendedAmountForArea < 1 ?
                    (r.recommendedAmountForArea * 16).toFixed(1) + ' oz' :
                    r.recommendedAmountForArea.toFixed(1) + ' lbs';
                const actAmt = r.actualAmountForArea < 1 ?
                    (r.actualAmountForArea * 16).toFixed(1) + ' oz' :
                    r.actualAmountForArea.toFixed(1) + ' lbs';

                const variance = parseFloat(r.variancePercent);
                const hasVariance = Math.abs(variance) > 5;

                let bgColor = '#f1f5f9';
                let borderColor = '#e2e8f0';
                if (hasVariance) {
                    bgColor = variance > 0 ? '#dbeafe' : '#fef3c7';
                    borderColor = variance > 0 ? '#93c5fd' : '#fcd34d';
                }

                let html = '<div style="background: ' + bgColor + '; border: 1px solid ' + borderColor + '; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">';
                html += '<div style="font-weight: 600; margin-bottom: 0.25rem;">' + r.material + '</div>';
                html += '<div style="display: flex; gap: 0.75rem;">';
                html += '<span style="color: #64748b;">Rec: ' + recAmt + '</span>';
                html += '<span style="color: ' + (hasVariance ? (variance > 0 ? '#2563eb' : '#d97706') : '#166534') + '; font-weight: 500;">Applied: ' + actAmt + '</span>';
                if (hasVariance) {
                    html += '<span style="color: ' + (variance > 0 ? '#2563eb' : '#d97706') + ';">(' + (variance > 0 ? '+' : '') + variance + '%)</span>';
                }
                html += '</div>';
                if (r.varianceReason) {
                    html += '<div style="color: #64748b; font-style: italic; margin-top: 0.25rem; font-size: 0.7rem;">' + r.varianceReason + '</div>';
                }
                html += '</div>';
                return html;
            }

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 0.5rem;">Amendment History</h3>
                    <p style="color: #64748b; font-size: 0.875rem;">
                        View all planned and applied amendments. Track what was recommended vs what was actually applied.
                        The system learns from these differences to improve future recommendations.
                    </p>
                </div>

                ${plannedAmendments.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“Š</div>
                        <h3>No amendment history yet</h3>
                        <p>Use the Amendment Calculator to plan your first amendment and it will appear here</p>
                    </div>
                ` : `
                    <div style="background: white; border-radius: 1rem; overflow: hidden;">
                        ${plannedAmendments.sort((a, b) => new Date(b.applicationDate) - new Date(a.applicationDate)).map(a => `
                            <div style="padding: 1.25rem; border-bottom: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                    <div>
                                        <h4 style="color: #1e293b; margin-bottom: 0.25rem;">${a.location} - ${a.crop}</h4>
                                        <p style="color: #64748b; font-size: 0.875rem;">
                                            ${a.status === 'completed' ? 'Applied' : 'Planned for'} ${formatDate(a.applicationDate)} | ${a.areaLabel}
                                            ${a.hasVariance ? '<span style="color: #d97706; margin-left: 0.5rem;">(adjusted from recommendation)</span>' : ''}
                                        </p>
                                    </div>
                                    <span style="
                                        padding: 0.25rem 0.75rem;
                                        border-radius: 9999px;
                                        font-size: 0.75rem;
                                        font-weight: 600;
                                        background: ${a.status === 'completed' ? '#dcfce7' : a.status === 'planned' ? '#dbeafe' : '#f1f5f9'};
                                        color: ${a.status === 'completed' ? '#166534' : a.status === 'planned' ? '#1e40af' : '#64748b'};
                                    ">
                                        ${a.status === 'completed' ? 'Applied' : 'Planned'}
                                    </span>
                                </div>

                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    ${a.recommendations.map(r => formatAmendmentItem(r, a.status === 'completed')).join('')}
                                </div>

                                ${a.applicationNotes ? `
                                    <div style="background: #f8fafc; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.8rem; color: #475569;">
                                        <strong>Notes:</strong> ${a.applicationNotes}
                                    </div>
                                ` : ''}

                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    ${a.status === 'planned' ? `
                                        <button onclick="markAmendmentCompleted('${a.id}')" class="btn btn-success" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                                            Mark as Applied
                                        </button>
                                    ` : `
                                        <button onclick="generateAmendmentPDF('${a.id}')" class="btn btn-primary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; background: #7c3aed; color: white;">
                                            Generate Learning PDF
                                        </button>
                                    `}
                                    <button onclick="deleteAmendmentHistory('${a.id}')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; color: #ef4444;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            `;
        }

        function markAmendmentCompleted(id) {
            // Show the edit modal to allow recording actual amounts
            // This enables tracking recommended vs actual for farm learning
            showEditAmendmentModal(id);
        }

        // Sync compliance records to Google Sheets
        async function syncComplianceRecordsToSheets(records) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'syncComplianceRecords',
                        records: records
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Mark records as synced in localStorage
                    records.forEach(r => {
                        const idx = complianceRecords.findIndex(cr => cr.id === r.id);
                        if (idx !== -1) {
                            complianceRecords[idx].syncedToSheets = true;
                            complianceRecords[idx].syncedAt = new Date().toISOString();
                        }
                    });
                    localStorage.setItem('complianceRecords', JSON.stringify(complianceRecords));
                } else {
                    console.warn('Failed to sync compliance records:', result.error);
                }
            } catch (error) {
                console.error('Error syncing compliance records:', error);
                // Don't show error toast - records are saved locally and can be synced later
            }
        }

        // Manual sync all unsynced compliance records
        async function syncAllComplianceRecords() {
            const unsyncedRecords = complianceRecords.filter(r => !r.syncedToSheets);
            if (unsyncedRecords.length === 0) {
                showToast('All records are already synced', 'info');
                return;
            }

            showToast(`Syncing ${unsyncedRecords.length} records...`, 'info');
            await syncComplianceRecordsToSheets(unsyncedRecords);
            showToast(`Sync complete!`, 'success');
            filterComplianceRecords(); // Refresh display
        }

        function deleteAmendmentHistory(id) {
            if (!confirm('Are you sure you want to delete this amendment record?')) return;
            let plannedAmendments = JSON.parse(localStorage.getItem('plannedAmendments') || '[]');
            plannedAmendments = plannedAmendments.filter(a => a.id.toString() !== id.toString());
            localStorage.setItem('plannedAmendments', JSON.stringify(plannedAmendments));
            renderAmendmentHistory();
            showToast('Amendment record deleted', 'success');
        }

        // ============================================
        // PDF GENERATION - Learning Document
        // Generates a detailed PDF explaining WHY each amendment was added
        // Serves as a training document for the farm crew
        // ============================================
        function generateAmendmentPDF(id) {
            const plannedAmendments = JSON.parse(localStorage.getItem('plannedAmendments') || '[]');
            const amendment = plannedAmendments.find(a => a.id.toString() === id.toString());
            if (!amendment) return;

            // Get the associated soil test if available
            const test = soilTests.find(t => t.id === amendment.testId);

            // Build the PDF content as a printable HTML page
            const pdfWindow = window.open('', '_blank');
            pdfWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Amendment Report - ${amendment.location}</title>
                    <style>
                        @media print {
                            body { margin: 0; padding: 20px; }
                            .no-print { display: none !important; }
                        }
                        body {
                            font-family: 'Segoe UI', Arial, sans-serif;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 40px;
                            color: #1e293b;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #7c3aed;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 { color: #7c3aed; margin: 0; }
                        .header p { color: #64748b; margin: 5px 0; }
                        .section {
                            margin-bottom: 25px;
                            padding: 20px;
                            background: #f8fafc;
                            border-radius: 8px;
                        }
                        .section h2 {
                            color: #7c3aed;
                            font-size: 1.2rem;
                            margin-top: 0;
                            border-bottom: 1px solid #e2e8f0;
                            padding-bottom: 10px;
                        }
                        .amendment-item {
                            background: white;
                            padding: 15px;
                            margin: 10px 0;
                            border-radius: 6px;
                            border-left: 4px solid #7c3aed;
                        }
                        .amendment-item h3 {
                            margin: 0 0 10px 0;
                            color: #1e293b;
                        }
                        .why-box {
                            background: #f0fdf4;
                            border: 1px solid #86efac;
                            padding: 15px;
                            border-radius: 6px;
                            margin-top: 10px;
                        }
                        .data-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 15px;
                        }
                        .data-item {
                            background: white;
                            padding: 12px;
                            border-radius: 6px;
                        }
                        .data-item label {
                            font-size: 0.75rem;
                            color: #64748b;
                            display: block;
                        }
                        .data-item span {
                            font-size: 1.1rem;
                            font-weight: 600;
                            color: #1e293b;
                        }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 12px 24px;
                            background: #7c3aed;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 1rem;
                        }
                        .print-btn:hover { background: #6d28d9; }
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #e2e8f0;
                            text-align: center;
                            color: #64748b;
                            font-size: 0.85rem;
                        }
                        .variance-note {
                            background: #fef3c7;
                            border: 1px solid #fcd34d;
                            padding: 10px;
                            border-radius: 4px;
                            margin-top: 8px;
                            font-size: 0.9rem;
                        }
                        .science-note {
                            background: #e0e7ff;
                            border: 1px solid #a5b4fc;
                            padding: 12px;
                            border-radius: 6px;
                            margin-top: 10px;
                            font-size: 0.85rem;
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn no-print" onclick="window.print()">Print / Save as PDF</button>

                    <div class="header">
                        <h1>Soil Amendment Report</h1>
                        <p><strong>${amendment.location}</strong> - ${amendment.crop}</p>
                        <p>Application Date: ${formatDate(amendment.applicationDate)} | Area: ${amendment.areaLabel}</p>
                        <p style="font-size: 0.9rem;">Generated: ${new Date().toLocaleDateString()}</p>
                    </div>

                    ${test ? `
                    <div class="section">
                        <h2>Soil Test Results (Before Amendment)</h2>
                        <div class="data-grid">
                            <div class="data-item">
                                <label>pH</label>
                                <span>${test.pH || 'N/A'}</span>
                            </div>
                            <div class="data-item">
                                <label>Organic Matter</label>
                                <span>${test.organicMatter || 'N/A'}%</span>
                            </div>
                            <div class="data-item">
                                <label>Phosphorus (P)</label>
                                <span>${test.phosphorus || 'N/A'} ppm</span>
                            </div>
                            <div class="data-item">
                                <label>Potassium (K)</label>
                                <span>${test.potassium || 'N/A'} ppm</span>
                            </div>
                            <div class="data-item">
                                <label>Calcium (Ca)</label>
                                <span>${test.calcium || 'N/A'} ppm</span>
                            </div>
                            <div class="data-item">
                                <label>Magnesium (Mg)</label>
                                <span>${test.magnesium || 'N/A'} ppm</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="section">
                        <h2>Amendments Applied</h2>
                        ${amendment.recommendations.map(r => {
                            const bioData = AMENDMENT_BIOAVAILABILITY[findAmendmentKey(r.material)] || {};
                            const hasVariance = r.recommendedAmountForArea && Math.abs(parseFloat(r.variancePercent)) > 5;

                            return `
                            <div class="amendment-item">
                                <h3>${r.material}</h3>
                                <div class="data-grid">
                                    <div class="data-item">
                                        <label>Recommended Amount</label>
                                        <span>${r.recommendedAmountForArea ?
                                            (r.recommendedAmountForArea < 1 ? (r.recommendedAmountForArea * 16).toFixed(1) + ' oz' : r.recommendedAmountForArea.toFixed(1) + ' lbs') :
                                            (r.amountForArea < 1 ? (r.amountForArea * 16).toFixed(1) + ' oz' : r.amountForArea.toFixed(1) + ' lbs')}</span>
                                    </div>
                                    <div class="data-item">
                                        <label>Actual Applied</label>
                                        <span>${r.actualAmountForArea ?
                                            (r.actualAmountForArea < 1 ? (r.actualAmountForArea * 16).toFixed(1) + ' oz' : r.actualAmountForArea.toFixed(1) + ' lbs') :
                                            (r.amountForArea < 1 ? (r.amountForArea * 16).toFixed(1) + ' oz' : r.amountForArea.toFixed(1) + ' lbs')}</span>
                                    </div>
                                </div>

                                ${hasVariance ? `
                                    <div class="variance-note">
                                        <strong>Variance: ${r.variancePercent > 0 ? '+' : ''}${r.variancePercent}%</strong>
                                        ${r.varianceReason ? `<br>Reason: ${r.varianceReason}` : ''}
                                    </div>
                                ` : ''}

                                <div class="why-box">
                                    <strong>WHY THIS AMENDMENT?</strong><br>
                                    <p><strong>Provides:</strong> ${r.provides || 'Multiple nutrients'}</p>
                                    ${bioData.releaseSpeed ? `
                                        <p><strong>Release Speed:</strong> ${bioData.releaseSpeed.replace('_', ' ')} - available in ~${bioData.daysToAvailable} days</p>
                                    ` : ''}
                                    ${bioData.notes ? `<p><strong>Application Notes:</strong> ${bioData.notes}</p>` : ''}
                                </div>

                                <div class="science-note">
                                    <strong>How it works:</strong>
                                    ${getAmendmentExplanation(r.material)}
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>

                    ${amendment.applicationNotes ? `
                    <div class="section">
                        <h2>Application Notes</h2>
                        <p>${amendment.applicationNotes}</p>
                    </div>
                    ` : ''}

                    <div class="section">
                        <h2>What to Watch For</h2>
                        <p>Over the next few weeks, monitor the field for signs that the amendments are working:</p>
                        <ul>
                            <li><strong>1-2 weeks:</strong> Water-soluble amendments (gypsum, potassium sulfate) should show effects</li>
                            <li><strong>3-4 weeks:</strong> Fast-release N sources (blood meal, fish meal) peak availability</li>
                            <li><strong>6-8 weeks:</strong> Medium-release amendments fully active</li>
                            <li><strong>Next season:</strong> Slow-release amendments (rock phosphate, lime) show in tests</li>
                        </ul>
                        <p style="color: #64748b; font-size: 0.9rem;">
                            Take photos and notes of crop health changes. Record any observations in the Farm Learning system.
                        </p>
                    </div>

                    <div class="footer">
                        <p><strong>Tiny Seed Farm Learning System</strong></p>
                        <p>Building 40 years of knowledge, one season at a time.</p>
                        <p style="font-size: 0.75rem; color: #94a3b8;">
                            Data sources: University extension services, peer-reviewed agricultural research.<br>
                            See SOIL_TRACKER_PROJECT_SUMMARY.md for full citations.
                        </p>
                    </div>
                </body>
                </html>
            `);
            pdfWindow.document.close();
        }

        // Helper to find amendment key from material name
        function findAmendmentKey(materialName) {
            const nameMap = {
                'Agricultural Lime': 'agLime',
                'Dolomite Lime': 'dolomite',
                'Gypsum': 'gypsum',
                'Elemental Sulfur': 'elementalSulfur',
                'Blood Meal': 'bloodMeal',
                'Feather Meal': 'featherMeal',
                'Soybean Meal': 'soybeanMeal',
                'Fish Meal': 'fishMeal',
                'Alfalfa Meal': 'alfalfaMeal',
                'Chilean Nitrate': 'sodiumNitrate',
                'Bone Meal': 'boneMeal',
                'Soft Rock Phosphate': 'softRockPhosphate',
                'Hard Rock Phosphate': 'hardRockPhosphate',
                'Potassium Sulfate': 'potassiumSulfate',
                'Sul-Po-Mag': 'kMag',
                'K-Mag': 'kMag',
                'Greensand': 'greensand',
                'Kelp Meal': 'kelpMeal',
                'Azomite': 'azomite',
                'Epsom Salt': 'magnesiumSulfate'
            };
            return nameMap[materialName] || materialName.toLowerCase().replace(/\s+/g, '');
        }

        // Helper to get educational explanation for each amendment type
        function getAmendmentExplanation(material) {
            const explanations = {
                'Agricultural Lime': 'Lime raises soil pH by neutralizing acidity. The calcium carbonate reacts slowly with hydrogen ions in the soil, making nutrients like phosphorus and molybdenum more available. Takes 6-24 months for full effect.',
                'Dolomite Lime': 'Like ag lime but also supplies magnesium. Use only when both pH and Mg are low. The Mg helps with chlorophyll production and enzyme activation.',
                'Gypsum': 'Provides calcium and sulfur without changing pH. The calcium helps improve soil structure by displacing sodium, improving drainage in clay soils. The sulfur is essential for protein synthesis.',
                'Blood Meal': 'Very fast nitrogen release (7-14 days). The proteins break down quickly via soil microbes into plant-available ammonium, then nitrate. Use for quick green-up but be careful not to over-apply.',
                'Feather Meal': 'Slow-release nitrogen from keratin protein. Harder for soil microbes to break down, providing steady N over 2-3 months. Good for sustained feeding without leaching.',
                'Fish Meal': 'Moderate-speed N plus P and micronutrients. Contains amino acids and growth factors that stimulate soil biology. The proteins break down in 2-4 weeks.',
                'Bone Meal': 'Phosphorus plus calcium. The phosphorus is locked in calcium phosphate that releases as roots exude organic acids. Works best in slightly acidic soils.',
                'Soft Rock Phosphate': 'Multi-year slow-release phosphorus source. Builds long-term P reserves. Also contains calcium and trace minerals. Best applied in fall.',
                'Potassium Sulfate': 'Fast-acting potassium plus sulfur. Water soluble so available quickly. Essential for fruit quality, disease resistance, and water regulation.',
                'Sul-Po-Mag': 'Triple nutrient: K, Mg, S in one product. Very efficient for addressing multiple deficiencies. The sulfate forms are quickly available.',
                'Kelp Meal': 'Trace minerals, growth hormones, and potassium. Contains cytokinins and auxins that improve stress tolerance and root development.',
                'Greensand': 'Very slow potassium release (years). Also supplies iron and other trace minerals. Best for long-term soil building.',
                'Azomite': 'Volcanic trace mineral source with 70+ minerals. Supports soil biology and provides micronutrients often missing from synthetic programs.',
                'Epsom Salt': 'Fast magnesium and sulfur. Water soluble for quick uptake. Good for foliar application when Mg deficiency symptoms appear.'
            };
            return explanations[material] || 'This amendment provides essential nutrients to support healthy plant growth and soil biology.';
        }

        // ============================================
        // EDIT AMENDMENT MODAL - Track recommended vs actual
        // This allows the user to adjust amounts based on real-world conditions
        // and logs the reasoning for farm learning
        // ============================================
        let editingAmendmentId = null;

        function showEditAmendmentModal(id) {
            editingAmendmentId = id;
            const plannedAmendments = JSON.parse(localStorage.getItem('plannedAmendments') || '[]');
            const amendment = plannedAmendments.find(a => a.id.toString() === id.toString());
            if (!amendment) return;

            // Create the modal HTML dynamically
            const modalHtml = `
                <div id="editAmendmentModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 1rem; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                            <h3>Record Actual Application</h3>
                            <p style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                                ${amendment.location} - ${amendment.crop} | ${amendment.areaLabel}
                            </p>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                                <p style="font-size: 0.875rem; color: #166534;">
                                    <strong>Why track actual vs recommended?</strong><br>
                                    The system learns from differences between recommendations and reality.
                                    If you couldn't get a product, ran out, or adjusted based on experience,
                                    record it here so the system can improve future recommendations for your farm.
                                </p>
                            </div>

                            <h4 style="margin-bottom: 1rem; color: #1e293b;">Adjust Actual Amounts Applied</h4>
                            <div id="amendmentItemsEdit">
                                ${amendment.recommendations.map((r, idx) => `
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 2fr; gap: 0.75rem; align-items: end; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e2e8f0;">
                                        <div>
                                            <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.25rem;">Material</label>
                                            <div style="font-weight: 500; color: #1e293b;">${r.material}</div>
                                        </div>
                                        <div>
                                            <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.25rem;">Recommended</label>
                                            <div style="color: #7c3aed; font-weight: 500;">
                                                ${r.amountForArea < 1 ? (r.amountForArea * 16).toFixed(1) + ' oz' : r.amountForArea.toFixed(1) + ' lbs'}
                                            </div>
                                        </div>
                                        <div>
                                            <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.25rem;">Actual Applied</label>
                                            <input type="number" step="0.1" min="0"
                                                   id="actualAmount_${idx}"
                                                   value="${r.amountForArea < 1 ? (r.amountForArea * 16).toFixed(1) : r.amountForArea.toFixed(1)}"
                                                   style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <span style="font-size: 0.625rem; color: #64748b;">${r.amountForArea < 1 ? 'oz' : 'lbs'}</span>
                                        </div>
                                        <div>
                                            <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.25rem;">Reason for change (if any)</label>
                                            <input type="text"
                                                   id="actualReason_${idx}"
                                                   placeholder="e.g., ran out, substituted"
                                                   style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; font-size: 0.875rem;">
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="font-size: 0.875rem; font-weight: 500; color: #1e293b; display: block; margin-bottom: 0.5rem;">
                                    Application Notes / Conditions
                                </label>
                                <textarea id="applicationNotes"
                                          placeholder="Weather conditions, equipment used, observations, challenges encountered..."
                                          style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; min-height: 80px; font-size: 0.875rem;"></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button onclick="closeEditAmendmentModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                                    Cancel
                                </button>
                                <button onclick="saveActualAmendment()" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                                    Save & Mark as Applied
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeEditAmendmentModal() {
            const modal = document.getElementById('editAmendmentModal');
            if (modal) modal.remove();
            editingAmendmentId = null;
        }

        function saveActualAmendment() {
            if (!editingAmendmentId) return;

            let plannedAmendments = JSON.parse(localStorage.getItem('plannedAmendments') || '[]');
            const idx = plannedAmendments.findIndex(a => a.id.toString() === editingAmendmentId.toString());
            if (idx === -1) return;

            const amendment = plannedAmendments[idx];
            const applicationNotes = document.getElementById('applicationNotes').value;

            // Capture actual amounts and reasons for each recommendation
            amendment.recommendations = amendment.recommendations.map((r, i) => {
                const actualInput = document.getElementById(`actualAmount_${i}`);
                const reasonInput = document.getElementById(`actualReason_${i}`);

                const wasInOz = r.amountForArea < 1;
                const actualValue = parseFloat(actualInput.value) || 0;
                const actualInLbs = wasInOz ? actualValue / 16 : actualValue;

                return {
                    ...r,
                    // Original recommended amounts (preserved)
                    recommendedAmountForArea: r.amountForArea,
                    recommendedAmountPerAcre: r.amountPerAcre,
                    // Actual amounts applied
                    actualAmountForArea: actualInLbs,
                    actualAmountPerAcre: r.amountPerAcre * (actualInLbs / r.amountForArea),
                    amountForArea: actualInLbs, // Update the main amount to actual for compliance records
                    // Track differences
                    variancePercent: r.amountForArea > 0 ? ((actualInLbs - r.amountForArea) / r.amountForArea * 100).toFixed(1) : 0,
                    varianceReason: reasonInput.value || null
                };
            });

            // Mark as completed with tracking info
            amendment.status = 'completed';
            amendment.completedAt = new Date().toISOString();
            amendment.applicationNotes = applicationNotes;
            amendment.hasVariance = amendment.recommendations.some(r =>
                Math.abs(parseFloat(r.variancePercent)) > 5
            );

            // Save back to localStorage
            plannedAmendments[idx] = amendment;
            localStorage.setItem('plannedAmendments', JSON.stringify(plannedAmendments));

            // Create compliance records with actual amounts
            const newRecords = [];
            amendment.recommendations.forEach(r => {
                const complianceRecord = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    applicationDate: amendment.applicationDate,
                    field: amendment.location,
                    material: r.material,
                    rate: `${r.actualAmountPerAcre.toFixed(1)} ${r.unit}`,
                    amount: `${r.actualAmountForArea < 1 ? (r.actualAmountForArea * 16).toFixed(1) + ' oz' : r.actualAmountForArea.toFixed(1) + ' lbs'}`,
                    recommendedAmount: `${r.recommendedAmountForArea < 1 ? (r.recommendedAmountForArea * 16).toFixed(1) + ' oz' : r.recommendedAmountForArea.toFixed(1) + ' lbs'}`,
                    variancePercent: r.variancePercent,
                    varianceReason: r.varianceReason,
                    omriStatus: 'pending',
                    crop: amendment.crop,
                    notes: applicationNotes ? `${applicationNotes}` : 'Auto-added from amendment plan',
                    updatedAt: new Date().toISOString(),
                    source: 'amendment-plan'
                };
                complianceRecords.push(complianceRecord);
                newRecords.push(complianceRecord);
            });
            localStorage.setItem('complianceRecords', JSON.stringify(complianceRecords));

            // Sync to Google Sheets
            syncComplianceRecordsToSheets(newRecords);

            // Record in farm learning system if available
            if (typeof FarmLearning !== 'undefined' && FarmLearning.recordAmendment) {
                FarmLearning.recordAmendment({
                    date: amendment.applicationDate,
                    fieldZone: amendment.location,
                    amendments: amendment.recommendations.map(r => ({
                        material: r.material,
                        recommended: r.recommendedAmountForArea,
                        actual: r.actualAmountForArea,
                        variance: r.variancePercent,
                        reason: r.varianceReason
                    })),
                    notes: applicationNotes,
                    crop: amendment.crop
                });
            }

            closeEditAmendmentModal();
            renderAmendmentHistory();
            showToast('Amendment recorded with actual amounts - synced to Google Sheets!', 'success');
        }

        // ============================================
        // FIELD ZONES MANAGEMENT TAB
        // ============================================

        function renderFieldZones() {
            const container = document.getElementById('testsContainer');
            const zones = FieldZoneManager.getZones();

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">Field Zones Management</h3>
                            <p style="color: #64748b; font-size: 0.875rem;">
                                Organize your farm into zones with similar soil conditions and nutrient needs.
                                Group crops by their feeding requirements for optimal soil management.
                            </p>
                        </div>
                        <button onclick="showAddFieldZone()" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                            + Add Field Zone
                        </button>
                    </div>

                    <!-- Nutrient Group Legend -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <strong style="display: block; margin-bottom: 0.5rem;">Nutrient Groups for Smart Planting:</strong>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${Object.entries(NUTRIENT_GROUPS).map(([key, group]) => `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: ${group.color};"></span>
                                    <span style="font-size: 0.875rem;"><strong>${group.name}</strong> - ${group.description.split('.')[0]}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                ${zones.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ—ºï¸</div>
                        <h3>No field zones defined</h3>
                        <p>Create field zones to organize your farm and get smarter amendment recommendations</p>
                        <button onclick="showAddFieldZone()" class="btn btn-success" style="margin-top: 1rem;">Create First Zone</button>
                    </div>
                ` : `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
                        ${zones.map(zone => {
                            const stats = FarmLearning.getFieldStats(zone.id);
                            const nutrientGroup = NUTRIENT_GROUPS[zone.nutrientProfile] || NUTRIENT_GROUPS.moderateFeeders;
                            return `
                                <div style="background: white; border-radius: 1rem; padding: 1.25rem; border-left: 4px solid ${nutrientGroup.color};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                        <div>
                                            <h4 style="margin-bottom: 0.25rem;">${zone.name}</h4>
                                            <span style="
                                                font-size: 0.75rem;
                                                padding: 0.25rem 0.5rem;
                                                border-radius: 9999px;
                                                background: ${nutrientGroup.color}20;
                                                color: ${nutrientGroup.color};
                                            ">${nutrientGroup.name}</span>
                                        </div>
                                        <span style="font-size: 0.875rem; color: #64748b;">${zone.acreage || '?'} acres</span>
                                    </div>

                                    ${zone.description ? `<p style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.75rem;">${zone.description}</p>` : ''}

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.75rem; margin-bottom: 0.75rem;">
                                        <div><strong>Soil Type:</strong> ${zone.soilType || 'Not set'}</div>
                                        <div><strong>Drainage:</strong> ${zone.drainage || 'Not set'}</div>
                                        <div><strong>Sun:</strong> ${zone.sunExposure || 'Not set'}</div>
                                        <div><strong>Soil Tests:</strong> ${stats.totalSoilTests}</div>
                                    </div>

                                    ${zone.currentCrops && zone.currentCrops.length > 0 ? `
                                        <div style="margin-bottom: 0.75rem;">
                                            <strong style="font-size: 0.75rem; color: #64748b;">Current Crops:</strong>
                                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.25rem;">
                                                ${zone.currentCrops.map(c => `
                                                    <span style="background: #f1f5f9; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem;">
                                                        ${CROP_NUTRITION[c]?.name || c}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${stats.topCrops.length > 0 ? `
                                        <div style="background: #f0fdf4; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.75rem;">
                                            <strong style="font-size: 0.7rem; color: #166534;">Top Performers:</strong>
                                            <span style="font-size: 0.7rem; color: #166534;">
                                                ${stats.topCrops.slice(0, 3).map(c => CROP_NUTRITION[c.crop]?.name || c.crop).join(', ')}
                                            </span>
                                        </div>
                                    ` : ''}

                                    ${zone.microclimate ? `
                                        <div style="font-size: 0.75rem; color: #64748b; font-style: italic; margin-bottom: 0.75rem;">
                                            Microclimate: ${zone.microclimate}
                                        </div>
                                    ` : ''}

                                    <div style="display: flex; gap: 0.5rem; border-top: 1px solid #e2e8f0; padding-top: 0.75rem;">
                                        <button onclick="editFieldZone('${zone.id}')" style="flex: 1; padding: 0.375rem; background: #f1f5f9; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
                                            Edit
                                        </button>
                                        <button onclick="viewZoneHistory('${zone.id}')" style="flex: 1; padding: 0.375rem; background: #dbeafe; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem; color: #1e40af;">
                                            History
                                        </button>
                                        <button onclick="deleteFieldZone('${zone.id}')" style="padding: 0.375rem 0.75rem; background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.75rem;">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}

                <!-- Add/Edit Zone Modal -->
                <div id="zoneModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 1rem; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                            <h3 id="zoneModalTitle">Add Field Zone</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <form id="zoneForm" onsubmit="saveFieldZone(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label>Zone Name *</label>
                                        <select id="zoneName" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <option value="">-- Select Zone/Field --</option>
                                            ${Object.keys(FARM_FIELDS).map(f => `<option value="${f}">${f}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Acreage</label>
                                        <input type="number" id="zoneAcreage" step="0.01" placeholder="e.g., 0.5" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    </div>
                                </div>

                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Nutrient Profile *</label>
                                    <select id="zoneNutrientProfile" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        ${Object.entries(NUTRIENT_GROUPS).map(([key, group]) => `
                                            <option value="${key}">${group.name} - ${group.description.split('.')[0]}</option>
                                        `).join('')}
                                    </select>
                                    <small style="color: #64748b;">Group crops with similar nutrient needs in the same zone</small>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label>Soil Type</label>
                                        <select id="zoneSoilType" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <option value="">Select...</option>
                                            <option value="sandy">Sandy</option>
                                            <option value="sandy-loam">Sandy Loam</option>
                                            <option value="loam">Loam</option>
                                            <option value="silt-loam">Silt Loam</option>
                                            <option value="clay-loam">Clay Loam</option>
                                            <option value="clay">Clay</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Drainage</label>
                                        <select id="zoneDrainage" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <option value="">Select...</option>
                                            <option value="excellent">Excellent</option>
                                            <option value="good">Good</option>
                                            <option value="moderate">Moderate</option>
                                            <option value="poor">Poor</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Sun Exposure</label>
                                        <select id="zoneSunExposure" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                            <option value="">Select...</option>
                                            <option value="full">Full Sun</option>
                                            <option value="partial">Partial Sun</option>
                                            <option value="shade">Shade</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Current Crops (select multiple)</label>
                                    <select id="zoneCurrentCrops" multiple style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; height: 120px;">
                                        ${Object.entries(CROP_CATEGORIES).filter(([k]) => k !== 'general').map(([catKey, catName]) => {
                                            const crops = Object.entries(CROP_NUTRITION)
                                                .filter(([key, crop]) => crop.category === catKey)
                                                .map(([key, crop]) => `<option value="${key}">${crop.name}</option>`)
                                                .join('');
                                            return crops ? `<optgroup label="${catName}">${crops}</optgroup>` : '';
                                        }).join('')}
                                    </select>
                                    <small style="color: #64748b;">Hold Ctrl/Cmd to select multiple crops</small>
                                </div>

                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Microclimate Notes</label>
                                    <textarea id="zoneMicroclimate" rows="2" placeholder="e.g., Protected from north wind, early warming in spring, frost pocket..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                                </div>

                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label>Description</label>
                                    <textarea id="zoneDescription" rows="2" placeholder="General notes about this zone..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                                </div>

                                <input type="hidden" id="zoneId">

                                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button type="button" onclick="closeZoneModal()" class="btn btn-secondary" style="color: #64748b;">Cancel</button>
                                    <button type="submit" class="btn btn-success">Save Zone</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAddFieldZone() {
            document.getElementById('zoneModalTitle').textContent = 'Add Field Zone';
            document.getElementById('zoneForm').reset();
            document.getElementById('zoneId').value = '';
            document.getElementById('zoneModal').style.display = 'flex';
        }

        function closeZoneModal() {
            document.getElementById('zoneModal').style.display = 'none';
        }

        function saveFieldZone(event) {
            event.preventDefault();

            const zoneId = document.getElementById('zoneId').value;
            const currentCropsSelect = document.getElementById('zoneCurrentCrops');
            const selectedCrops = Array.from(currentCropsSelect.selectedOptions).map(opt => opt.value);

            const zoneData = {
                name: document.getElementById('zoneName').value,
                acreage: parseFloat(document.getElementById('zoneAcreage').value) || null,
                nutrientProfile: document.getElementById('zoneNutrientProfile').value,
                soilType: document.getElementById('zoneSoilType').value,
                drainage: document.getElementById('zoneDrainage').value,
                sunExposure: document.getElementById('zoneSunExposure').value,
                currentCrops: selectedCrops,
                microclimate: document.getElementById('zoneMicroclimate').value,
                description: document.getElementById('zoneDescription').value
            };

            if (zoneId) {
                FieldZoneManager.updateZone(zoneId, zoneData);
                showToast('Field zone updated', 'success');
            } else {
                FieldZoneManager.addZone(zoneData);
                showToast('Field zone created', 'success');
            }

            closeZoneModal();
            renderFieldZones();
        }

        function editFieldZone(zoneId) {
            const zone = FieldZoneManager.getZone(zoneId);
            if (!zone) return;

            document.getElementById('zoneModalTitle').textContent = 'Edit Field Zone';
            document.getElementById('zoneId').value = zone.id;
            document.getElementById('zoneName').value = zone.name || '';
            document.getElementById('zoneAcreage').value = zone.acreage || '';
            document.getElementById('zoneNutrientProfile').value = zone.nutrientProfile || 'moderateFeeders';
            document.getElementById('zoneSoilType').value = zone.soilType || '';
            document.getElementById('zoneDrainage').value = zone.drainage || '';
            document.getElementById('zoneSunExposure').value = zone.sunExposure || '';
            document.getElementById('zoneMicroclimate').value = zone.microclimate || '';
            document.getElementById('zoneDescription').value = zone.description || '';

            // Set current crops
            const select = document.getElementById('zoneCurrentCrops');
            Array.from(select.options).forEach(opt => {
                opt.selected = (zone.currentCrops || []).includes(opt.value);
            });

            document.getElementById('zoneModal').style.display = 'flex';
        }

        function deleteFieldZone(zoneId) {
            if (!confirm('Are you sure you want to delete this field zone? This will not delete associated soil tests or history.')) return;
            FieldZoneManager.deleteZone(zoneId);
            renderFieldZones();
            showToast('Field zone deleted', 'success');
        }

        function viewZoneHistory(zoneId) {
            // Switch to insights tab with zone filter
            currentTab = 'insights';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="insights"]').classList.add('active');
            renderFarmInsights(zoneId);
        }

        // ============================================
        // TISSUE TESTS TAB - Plant Tissue Analysis
        // Submit samples to Penn State, track results, tie to lot numbers
        // ============================================

        function renderTissueTests() {
            const container = document.getElementById('testsContainer');

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">Plant Tissue Analysis</h3>
                            <p style="color: #64748b; font-size: 0.875rem;">
                                Track leaf tissue nutrient levels to catch deficiencies before symptoms appear.
                                Submit samples to Penn State AASL for analysis.
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button onclick="showTissueSampleSubmitForm()" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                                + Submit New Sample
                            </button>
                            <label class="btn btn-primary" style="padding: 0.75rem 1.5rem; background: #7c3aed; color: white; cursor: pointer;">
                                Upload Results PDF
                                <input type="file" id="tissuePdfInput" accept=".pdf" onchange="handleTissuePdfUpload(event)" style="display: none;">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Upload Results Section (for manual entry without pending sample) -->
                <div id="tissueUploadZone" style="background: #f5f3ff; border: 2px dashed #7c3aed; border-radius: 1rem; padding: 2rem; margin-bottom: 1.5rem; text-align: center; cursor: pointer;" onclick="document.getElementById('tissuePdfInput').click()">
                    <div style="color: #7c3aed; font-size: 2rem; margin-bottom: 0.5rem;">ðŸ“„</div>
                    <p style="color: #5b21b6; font-weight: 600;">Drop Penn State PDF here or click to upload</p>
                    <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;">
                        Automatically extract results from Penn State tissue analysis reports
                    </p>
                </div>

                <!-- Pending Samples Section -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Pending Samples (${pendingSamples.length})</h4>
                    ${pendingSamples.length === 0 ? `
                        <p style="color: #64748b; font-style: italic;">No pending samples. Click "Submit New Sample" to create a submission.</p>
                    ` : `
                        <div style="display: grid; gap: 1rem;">
                            ${pendingSamples.map(s => `
                                <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 0.5rem; padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong style="color: #92400e;">${s.sampleId}</strong>
                                            <span style="background: #fef08a; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem;">Awaiting Results</span>
                                        </div>
                                        <span style="color: #64748b; font-size: 0.875rem;">${formatDate(s.collectionDate)}</span>
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #78350f;">
                                        ${s.crop} | ${s.fieldZone} | Lot: ${s.lotNumber || 'N/A'}
                                    </div>
                                    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button onclick="printTissueLabel('${s.id}')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                                            Reprint Label
                                        </button>
                                        <button onclick="enterTissueResults('${s.id}')" class="btn btn-primary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; background: #10b981; color: white;">
                                            Enter Results
                                        </button>
                                        <button onclick="deletePendingSample('${s.id}')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; color: #ef4444;">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>

                <!-- Completed Tissue Tests -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Completed Tests (${tissueTests.length})</h4>
                    ${tissueTests.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸŒ¿</div>
                            <h3>No tissue tests yet</h3>
                            <p>Submit a sample to Penn State and enter results when they arrive</p>
                        </div>
                    ` : `
                        <div style="display: grid; gap: 1rem;">
                            ${tissueTests.sort((a, b) => new Date(b.testDate) - new Date(a.testDate)).map(t => renderTissueTestCard(t)).join('')}
                        </div>
                    `}
                </div>

                <!-- Sampling Guide -->
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 1rem; padding: 1.5rem;">
                    <h4 style="color: #166534; margin-bottom: 1rem;">Tissue Sampling Guide</h4>
                    <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #166534;">When to Sample</strong>
                            <ul style="margin-top: 0.5rem; margin-left: 1rem; color: #14532d; font-size: 0.875rem;">
                                <li>Weekly or biweekly during active growth</li>
                                <li>Before symptoms appear (proactive!)</li>
                                <li>Morning hours, after dew dries</li>
                            </ul>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #166534;">How to Sample</strong>
                            <ul style="margin-top: 0.5rem; margin-left: 1rem; color: #14532d; font-size: 0.875rem;">
                                <li>Collect 25-100 leaves per sample</li>
                                <li>Use recently matured leaves (not old, not new)</li>
                                <li>Avoid damaged or diseased foliage</li>
                            </ul>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #166534;">Storage & Shipping</strong>
                            <ul style="margin-top: 0.5rem; margin-left: 1rem; color: #14532d; font-size: 0.875rem;">
                                <li>Use PAPER bags only (not plastic!)</li>
                                <li>Air dry if moist</li>
                                <li>Ship same day or next day</li>
                            </ul>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #166534;">Penn State Cost</strong>
                            <ul style="margin-top: 0.5rem; margin-left: 1rem; color: #14532d; font-size: 0.875rem;">
                                <li>Regular (N,P,K,Ca,Mg): $${PENN_STATE_LAB.costs.regularAnalysis}</li>
                                <li>With micros (+Fe,Mn,Zn,Cu,B): $${PENN_STATE_LAB.costs.withMicros}</li>
                                <li>Results in 5-7 business days</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Tissue Sample Submit Modal -->
                <div id="tissueSubmitModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                </div>

                <!-- Enter Results Modal -->
                <div id="tissueResultsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                </div>
            `;
        }

        function renderTissueTestCard(test) {
            const sufficiency = TISSUE_SUFFICIENCY[test.crop] || TISSUE_SUFFICIENCY.tomato;
            const deficiencies = [];
            const excesses = [];

            // Check each nutrient against sufficiency ranges
            Object.entries(test.results || {}).forEach(([nutrient, value]) => {
                const range = sufficiency.ranges[nutrient];
                if (range) {
                    if (value < range.low) deficiencies.push(nutrient);
                    else if (value > range.high) excesses.push(nutrient);
                }
            });

            const statusColor = deficiencies.length > 0 ? '#ef4444' : excesses.length > 0 ? '#f59e0b' : '#10b981';
            const statusText = deficiencies.length > 0 ? 'Deficiencies Found' : excesses.length > 0 ? 'High Levels' : 'All Sufficient';

            return `
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong style="color: #1e293b;">${test.crop}</strong>
                            <span style="color: #64748b; margin-left: 0.5rem; font-size: 0.875rem;">
                                ${test.fieldZone} | Lot: ${test.lotNumber || 'N/A'}
                            </span>
                        </div>
                        <span style="background: ${statusColor}20; color: ${statusColor}; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                            ${statusText}
                        </span>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;">
                        Sampled: ${formatDate(test.collectionDate)} | Results: ${formatDate(test.testDate)}
                    </div>
                    ${deficiencies.length > 0 ? `
                        <div style="margin-top: 0.75rem; background: #fef2f2; border: 1px solid #fecaca; padding: 0.5rem; border-radius: 0.25rem;">
                            <span style="color: #991b1b; font-weight: 600; font-size: 0.75rem;">Low:</span>
                            <span style="color: #991b1b; font-size: 0.75rem;">${deficiencies.join(', ')}</span>
                        </div>
                    ` : ''}
                    ${excesses.length > 0 ? `
                        <div style="margin-top: 0.5rem; background: #fffbeb; border: 1px solid #fed7aa; padding: 0.5rem; border-radius: 0.25rem;">
                            <span style="color: #92400e; font-weight: 600; font-size: 0.75rem;">High:</span>
                            <span style="color: #92400e; font-size: 0.75rem;">${excesses.join(', ')}</span>
                        </div>
                    ` : ''}
                    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                        <button onclick="viewTissueDetail('${test.id}')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                            View Details
                        </button>
                        <button onclick="createTissueAmendment('${test.id}')" class="btn btn-primary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; background: #7c3aed; color: white;">
                            Create Amendment
                        </button>
                    </div>
                </div>
            `;
        }

        function showTissueSampleSubmitForm() {
            const modal = document.getElementById('tissueSubmitModal');
            const fieldOptions = Object.keys(FARM_FIELDS).map(f =>
                '<option value="' + f + '">' + f + ' (' + FARM_FIELDS[f].acreage + ' ac)</option>'
            ).join('');

            const cropOptions = Object.entries(TISSUE_SUFFICIENCY).map(([key, val]) =>
                '<option value="' + key + '">' + val.name + '</option>'
            ).join('');

            const sampleId = 'TS-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + Math.random().toString(36).substr(2,4).toUpperCase();

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>Submit Tissue Sample to Penn State</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.25rem;">
                            Generate a submission form and mailing label
                        </p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form id="tissueSampleForm" onsubmit="submitTissueSample(event)">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label>Sample ID</label>
                                    <input type="text" id="tissueSampleId" value="${sampleId}" readonly style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; background: #f8fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Collection Date *</label>
                                    <input type="date" id="tissueCollectionDate" required value="${new Date().toISOString().slice(0,10)}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label>Crop *</label>
                                    <select id="tissueCrop" required onchange="updatePlantPartGuidance()" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">Select crop...</option>
                                        ${cropOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Field Zone *</label>
                                    <select id="tissueFieldZone" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">Select field...</option>
                                        ${fieldOptions}
                                    </select>
                                </div>
                            </div>

                            <div id="plantPartGuidance" style="background: #dbeafe; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; display: none;">
                                <strong style="color: #1e40af; font-size: 0.875rem;">Sampling Guidance:</strong>
                                <span id="plantPartText" style="color: #1e40af; font-size: 0.875rem;"></span>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label>Lot Number (for traceability)</label>
                                    <input type="text" id="tissueLotNumber" placeholder="e.g., TOM-2026-001" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label>Growth Stage</label>
                                    <select id="tissueGrowthStage" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="vegetative">Vegetative</option>
                                        <option value="budding">Budding/Pre-bloom</option>
                                        <option value="bloom" selected>Early Bloom</option>
                                        <option value="fruiting">Fruit Set</option>
                                        <option value="harvest">Near Harvest</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>Analysis Type *</label>
                                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="analysisType" value="regular" checked>
                                        <span>Regular ($${PENN_STATE_LAB.costs.regularAnalysis}) - N, P, K, Ca, Mg</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="analysisType" value="withMicros">
                                        <span>With Micros ($${PENN_STATE_LAB.costs.withMicros}) - + Fe, Mn, Zn, Cu, B</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>Symptoms/Observations</label>
                                <textarea id="tissueSymptoms" rows="2" placeholder="Any visible symptoms, concerns, or reasons for testing..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                            </div>

                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <strong style="color: #166534;">Next Steps:</strong>
                                <ol style="margin-top: 0.5rem; margin-left: 1.25rem; color: #14532d; font-size: 0.875rem;">
                                    <li>Click "Generate Submission" below</li>
                                    <li>Print the mailing label and sample tag</li>
                                    <li>Collect 25-100 leaves in a PAPER bag</li>
                                    <li>Attach the sample tag to the bag</li>
                                    <li>Mail to Penn State the same day</li>
                                </ol>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="closeTissueSubmitModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                                    Generate Submission
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function updatePlantPartGuidance() {
            const crop = document.getElementById('tissueCrop').value;
            const guidance = document.getElementById('plantPartGuidance');
            const text = document.getElementById('plantPartText');

            if (crop && TISSUE_SUFFICIENCY[crop]) {
                const spec = TISSUE_SUFFICIENCY[crop];
                text.textContent = 'Sample ' + spec.plantPart + ' during ' + spec.growthStage;
                guidance.style.display = 'block';
            } else {
                guidance.style.display = 'none';
            }
        }

        function closeTissueSubmitModal() {
            document.getElementById('tissueSubmitModal').style.display = 'none';
        }

        function submitTissueSample(event) {
            event.preventDefault();

            const sample = {
                id: Date.now().toString(),
                sampleId: document.getElementById('tissueSampleId').value,
                collectionDate: document.getElementById('tissueCollectionDate').value,
                crop: document.getElementById('tissueCrop').value,
                fieldZone: document.getElementById('tissueFieldZone').value,
                lotNumber: document.getElementById('tissueLotNumber').value,
                growthStage: document.getElementById('tissueGrowthStage').value,
                analysisType: document.querySelector('input[name="analysisType"]:checked').value,
                symptoms: document.getElementById('tissueSymptoms').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            // Save to pending samples
            pendingSamples.push(sample);
            localStorage.setItem('pendingTissueSamples', JSON.stringify(pendingSamples));

            closeTissueSubmitModal();

            // Generate and open the mailing label PDF
            generateTissueSubmissionPDF(sample);

            renderTissueTests();
            showToast('Tissue sample submission created! Print the label and mail today.', 'success');
        }

        function generateTissueSubmissionPDF(sample) {
            const cropName = TISSUE_SUFFICIENCY[sample.crop]?.name || sample.crop;
            const fieldInfo = FARM_FIELDS[sample.fieldZone] || {};
            const analysisPrice = sample.analysisType === 'withMicros' ? PENN_STATE_LAB.costs.withMicros : PENN_STATE_LAB.costs.regularAnalysis;

            const pdfWindow = window.open('', '_blank');
            pdfWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Tissue Sample - ${sample.sampleId}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none !important; }
                            .page-break { page-break-before: always; }
                        }
                        body {
                            font-family: 'Segoe UI', Arial, sans-serif;
                            padding: 20px;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 12px 24px;
                            background: #10b981;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 1rem;
                        }
                        .print-btn:hover { background: #059669; }
                        .label-box {
                            border: 3px dashed #374151;
                            padding: 20px;
                            margin: 20px 0;
                            background: #f9fafb;
                        }
                        .address-label {
                            border: 2px solid #000;
                            padding: 15px;
                            width: 4in;
                            height: 2in;
                            display: inline-block;
                        }
                        .sample-tag {
                            border: 2px solid #000;
                            padding: 10px;
                            width: 3in;
                            display: inline-block;
                            margin-top: 20px;
                        }
                        h1 { color: #10b981; }
                        h2 { color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
                        .info-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 1rem;
                            margin: 1rem 0;
                        }
                        .info-item { padding: 0.5rem 0; }
                        .info-item label { color: #6b7280; font-size: 0.875rem; display: block; }
                        .info-item span { font-weight: 600; }
                    </style>
                </head>
                <body>
                    <button class="print-btn no-print" onclick="window.print()">Print All</button>

                    <h1>Penn State Tissue Analysis Submission</h1>
                    <p>Generated: ${new Date().toLocaleDateString()}</p>

                    <h2>Sample Information</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Sample ID</label>
                            <span style="font-size: 1.25rem;">${sample.sampleId}</span>
                        </div>
                        <div class="info-item">
                            <label>Collection Date</label>
                            <span>${formatDate(sample.collectionDate)}</span>
                        </div>
                        <div class="info-item">
                            <label>Crop</label>
                            <span>${cropName}</span>
                        </div>
                        <div class="info-item">
                            <label>Field Zone</label>
                            <span>${sample.fieldZone} (${fieldInfo.acreage || '?'} ac)</span>
                        </div>
                        <div class="info-item">
                            <label>Lot Number</label>
                            <span>${sample.lotNumber || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>Growth Stage</label>
                            <span>${sample.growthStage}</span>
                        </div>
                        <div class="info-item">
                            <label>Analysis Type</label>
                            <span>${sample.analysisType === 'withMicros' ? 'With Micronutrients' : 'Regular'} ($${analysisPrice})</span>
                        </div>
                        <div class="info-item">
                            <label>Plant Part to Sample</label>
                            <span>${TISSUE_SUFFICIENCY[sample.crop]?.plantPart || 'Most recently matured leaf'}</span>
                        </div>
                    </div>

                    ${sample.symptoms ? `
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;">
                            <strong>Observations/Symptoms:</strong> ${sample.symptoms}
                        </div>
                    ` : ''}

                    <h2 style="margin-top: 2rem;">Mailing Label (Cut & Attach to Package)</h2>
                    <div class="label-box">
                        <div class="address-label">
                            <div style="font-size: 0.75rem; color: #666;">TO:</div>
                            <div style="font-size: 1.1rem; font-weight: bold; margin-top: 5px;">
                                ${PENN_STATE_LAB.name}
                            </div>
                            <div style="margin-top: 5px;">
                                ${PENN_STATE_LAB.address}<br>
                                ${PENN_STATE_LAB.city}, ${PENN_STATE_LAB.state} ${PENN_STATE_LAB.zip}
                            </div>
                            <div style="margin-top: 10px; font-size: 0.75rem; color: #666;">
                                Phone: ${PENN_STATE_LAB.phone}
                            </div>
                        </div>
                    </div>

                    <h2>Sample Tag (Cut & Attach to Paper Bag)</h2>
                    <div class="label-box">
                        <div class="sample-tag">
                            <div style="font-weight: bold; font-size: 1.25rem; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 5px;">
                                ${sample.sampleId}
                            </div>
                            <div style="font-size: 0.875rem;">
                                <strong>Crop:</strong> ${cropName}<br>
                                <strong>Date:</strong> ${formatDate(sample.collectionDate)}<br>
                                <strong>Lot:</strong> ${sample.lotNumber || 'N/A'}<br>
                                <strong>Field:</strong> ${sample.fieldZone}
                            </div>
                        </div>
                    </div>

                    <div class="page-break"></div>

                    <h2>Submission Checklist</h2>
                    <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 0.5rem;">
                        <ol style="margin-left: 1rem; line-height: 2;">
                            <li>Collect 25-100 ${TISSUE_SUFFICIENCY[sample.crop]?.plantPart || 'recently matured leaves'}</li>
                            <li>Place in a clean PAPER bag (not plastic!)</li>
                            <li>Attach the sample tag to the bag</li>
                            <li>Fill out Penn State submission form (or include this printout)</li>
                            <li>Include payment: $${analysisPrice} (check payable to "Penn State")</li>
                            <li>Ship SAME DAY via USPS Priority or FedEx</li>
                        </ol>
                    </div>

                    <h2 style="margin-top: 2rem;">Penn State Submission Form Reference</h2>
                    <p style="color: #666;">
                        Download the official form at: <br>
                        <a href="https://agsci.psu.edu/aasl/plant-analysis" target="_blank">https://agsci.psu.edu/aasl/plant-analysis</a>
                    </p>
                    <p style="color: #666; font-size: 0.875rem;">
                        Use Submission Form C for Vegetable Crops or Form B for Floriculture Crops.
                        Reference this sample ID (${sample.sampleId}) on the form.
                    </p>

                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.75rem;">
                        <p><strong>Tiny Seed Farm Learning System</strong></p>
                        <p>This submission was generated to track tissue analysis results and tie them to lot numbers for food safety traceability.</p>
                    </div>
                </body>
                </html>
            `);
            pdfWindow.document.close();
        }

        function printTissueLabel(id) {
            const sample = pendingSamples.find(s => s.id === id);
            if (sample) generateTissueSubmissionPDF(sample);
        }

        function deletePendingSample(id) {
            if (!confirm('Cancel this tissue sample submission?')) return;
            pendingSamples = pendingSamples.filter(s => s.id !== id);
            localStorage.setItem('pendingTissueSamples', JSON.stringify(pendingSamples));
            renderTissueTests();
            showToast('Sample submission cancelled', 'info');
        }

        function enterTissueResults(id) {
            const sample = pendingSamples.find(s => s.id === id);
            if (!sample) return;

            const modal = document.getElementById('tissueResultsModal');
            const sufficiency = TISSUE_SUFFICIENCY[sample.crop] || TISSUE_SUFFICIENCY.tomato;
            const nutrients = ['N', 'P', 'K', 'Ca', 'Mg', 'S', 'B', 'Zn', 'Mn', 'Fe', 'Cu'];

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>Enter Tissue Analysis Results</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9;">Sample: ${sample.sampleId} | ${sample.crop} | ${sample.fieldZone}</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form id="tissueResultsForm" onsubmit="saveTissueResults(event, '${id}')">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>Test Date (date on lab report)</label>
                                <input type="date" id="tissueTestDate" required value="${new Date().toISOString().slice(0,10)}" style="width: 200px; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>

                            <h4 style="margin-bottom: 1rem; color: #374151;">Macronutrients (%)</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                ${['N', 'P', 'K', 'Ca', 'Mg', 'S'].map(n => {
                                    const range = sufficiency.ranges[n];
                                    return '<div class="form-group">' +
                                        '<label>' + n + ' <span style="color: #9ca3af; font-size: 0.75rem;">(Suff: ' + range.sufficient[0] + '-' + range.sufficient[1] + '%)</span></label>' +
                                        '<input type="number" step="0.01" id="tissue_' + n + '" placeholder="e.g., ' + ((range.sufficient[0] + range.sufficient[1])/2).toFixed(2) + '" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">' +
                                        '</div>';
                                }).join('')}
                            </div>

                            <h4 style="margin-bottom: 1rem; color: #374151;">Micronutrients (ppm)</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                ${['B', 'Zn', 'Mn', 'Fe', 'Cu'].map(n => {
                                    const range = sufficiency.ranges[n];
                                    return '<div class="form-group">' +
                                        '<label>' + n + ' <span style="color: #9ca3af; font-size: 0.75rem;">(Suff: ' + range.sufficient[0] + '-' + range.sufficient[1] + ')</span></label>' +
                                        '<input type="number" step="0.1" id="tissue_' + n + '" placeholder="e.g., ' + ((range.sufficient[0] + range.sufficient[1])/2).toFixed(0) + '" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">' +
                                        '</div>';
                                }).join('')}
                            </div>

                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label>Lab Notes/Comments</label>
                                <textarea id="tissueLabNotes" rows="2" placeholder="Any notes from the lab report..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="closeTissueResultsModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                                    Save Results
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function closeTissueResultsModal() {
            document.getElementById('tissueResultsModal').style.display = 'none';
        }

        function saveTissueResults(event, pendingId) {
            event.preventDefault();

            const sample = pendingSamples.find(s => s.id === pendingId);
            if (!sample) return;

            const results = {};
            ['N', 'P', 'K', 'Ca', 'Mg', 'S', 'B', 'Zn', 'Mn', 'Fe', 'Cu'].forEach(n => {
                const val = parseFloat(document.getElementById('tissue_' + n).value);
                if (!isNaN(val)) results[n] = val;
            });

            const tissueTest = {
                id: Date.now().toString(),
                sampleId: sample.sampleId,
                collectionDate: sample.collectionDate,
                testDate: document.getElementById('tissueTestDate').value,
                crop: sample.crop,
                fieldZone: sample.fieldZone,
                lotNumber: sample.lotNumber,
                growthStage: sample.growthStage,
                results: results,
                labNotes: document.getElementById('tissueLabNotes').value,
                symptoms: sample.symptoms,
                createdAt: new Date().toISOString()
            };

            // Save to tissue tests
            tissueTests.push(tissueTest);
            localStorage.setItem('tissueTests', JSON.stringify(tissueTests));

            // Remove from pending
            pendingSamples = pendingSamples.filter(s => s.id !== pendingId);
            localStorage.setItem('pendingTissueSamples', JSON.stringify(pendingSamples));

            closeTissueResultsModal();
            renderTissueTests();
            showToast('Tissue analysis results saved!', 'success');
        }

        function viewTissueDetail(id) {
            const test = tissueTests.find(t => t.id === id);
            if (!test) return;
            // For now, show an alert with details. Could expand to full modal later.
            const sufficiency = TISSUE_SUFFICIENCY[test.crop] || TISSUE_SUFFICIENCY.tomato;
            let details = 'Tissue Test Details\n\n';
            details += 'Sample: ' + test.sampleId + '\n';
            details += 'Crop: ' + test.crop + ' | Field: ' + test.fieldZone + '\n';
            details += 'Lot: ' + (test.lotNumber || 'N/A') + '\n\n';
            details += 'Results:\n';
            Object.entries(test.results).forEach(([n, v]) => {
                const range = sufficiency.ranges[n];
                let status = 'OK';
                if (range && v < range.low) status = 'LOW!';
                else if (range && v > range.high) status = 'HIGH';
                details += n + ': ' + v + (range ? range.unit : '') + ' [' + status + ']\n';
            });
            alert(details);
        }

        function createTissueAmendment(id) {
            const test = tissueTests.find(t => t.id === id);
            if (!test) return;
            // Switch to Plant Doctor tab to create a correction plan
            showToast('Use the Plant Doctor tab to diagnose deficiencies and create a correction plan', 'info');
            switchTab('plantDoctor');
        }

        // ============================================
        // TISSUE TEST PDF UPLOAD & PARSING
        // Parse Penn State AASL tissue analysis reports
        // ============================================

        async function handleTissuePdfUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                showToast('Please upload a PDF file', 'error');
                return;
            }

            showToast('Parsing tissue test PDF...', 'info');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let allText = '';
                // Parse all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    allText += textContent.items.map(item => item.str).join(' ') + '\n';
                }

                // Parse Penn State format
                const results = parsePennStateTissueReport(allText);

                if (results) {
                    showTissuePdfPreview(results);
                    showToast('Tissue test data extracted! Please review and save.', 'success');
                } else {
                    showToast('Could not parse PDF. Use manual entry instead.', 'error');
                }
            } catch (error) {
                console.error('Tissue PDF parsing error:', error);
                showToast('Error parsing PDF: ' + error.message, 'error');
            }

            // Clear the file input
            event.target.value = '';
        }

        function parsePennStateTissueReport(text) {
            // Penn State AASL report format varies, but generally includes:
            // Sample ID, client name, analysis date, and nutrient values
            // This parser handles common formats

            const results = {
                sampleId: null,
                testDate: new Date().toISOString().slice(0, 10),
                crop: null,
                nutrients: {}
            };

            // Try to find sample ID
            const sampleIdMatch = text.match(/Sample\s*(?:ID|#|No\.?)?\s*:?\s*([A-Z0-9-]+)/i);
            if (sampleIdMatch) results.sampleId = sampleIdMatch[1];

            // Try to find date
            const dateMatch = text.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
            if (dateMatch) {
                const parts = dateMatch[1].split(/[\/\-]/);
                if (parts.length === 3) {
                    let year = parts[2];
                    if (year.length === 2) year = '20' + year;
                    results.testDate = year + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
                }
            }

            // Parse nutrient values - look for common patterns in tissue reports
            // Penn State typically reports macros as % and micros as ppm

            // Nitrogen (N) - usually 2-6%
            const nMatch = text.match(/\bN(?:itrogen)?\s*:?\s*([0-9]+\.?[0-9]*)\s*%/i) ||
                           text.match(/([0-9]+\.[0-9]+)\s*%?\s*N(?:itrogen)?\b/i);
            if (nMatch) results.nutrients.N = parseFloat(nMatch[1]);

            // Phosphorus (P) - usually 0.2-0.8%
            const pMatch = text.match(/\bP(?:hosphorus)?\s*:?\s*([0-9]+\.?[0-9]*)\s*%/i) ||
                           text.match(/([0-9]+\.[0-9]+)\s*%?\s*P(?:hosphorus)?\b/i);
            if (pMatch) results.nutrients.P = parseFloat(pMatch[1]);

            // Potassium (K) - usually 2-6%
            const kMatch = text.match(/\bK(?:alium|[^a-z]|$)\s*:?\s*([0-9]+\.?[0-9]*)\s*%/i) ||
                           text.match(/([0-9]+\.[0-9]+)\s*%?\s*K(?:[^a-z]|$)/i);
            if (kMatch) results.nutrients.K = parseFloat(kMatch[1]);

            // Calcium (Ca) - usually 1-4%
            const caMatch = text.match(/\bCa(?:lcium)?\s*:?\s*([0-9]+\.?[0-9]*)\s*%/i);
            if (caMatch) results.nutrients.Ca = parseFloat(caMatch[1]);

            // Magnesium (Mg) - usually 0.2-1%
            const mgMatch = text.match(/\bMg\s*:?\s*([0-9]+\.?[0-9]*)\s*%/i) ||
                            text.match(/Magnesium\s*:?\s*([0-9]+\.?[0-9]*)\s*%/i);
            if (mgMatch) results.nutrients.Mg = parseFloat(mgMatch[1]);

            // Sulfur (S) - usually 0.2-0.6%
            const sMatch = text.match(/\bS(?:ulfur)?\s*:?\s*([0-9]+\.?[0-9]*)\s*%/i);
            if (sMatch) results.nutrients.S = parseFloat(sMatch[1]);

            // Micronutrients (in ppm)
            // Boron (B) - usually 20-80 ppm
            const bMatch = text.match(/\bB(?:oron)?\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i);
            if (bMatch) results.nutrients.B = parseFloat(bMatch[1]);

            // Zinc (Zn) - usually 20-100 ppm
            const znMatch = text.match(/\bZn\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i) ||
                            text.match(/Zinc\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i);
            if (znMatch) results.nutrients.Zn = parseFloat(znMatch[1]);

            // Manganese (Mn) - usually 20-200 ppm
            const mnMatch = text.match(/\bMn\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i) ||
                            text.match(/Manganese\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i);
            if (mnMatch) results.nutrients.Mn = parseFloat(mnMatch[1]);

            // Iron (Fe) - usually 50-300 ppm
            const feMatch = text.match(/\bFe\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i) ||
                            text.match(/Iron\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i);
            if (feMatch) results.nutrients.Fe = parseFloat(feMatch[1]);

            // Copper (Cu) - usually 5-20 ppm
            const cuMatch = text.match(/\bCu\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i) ||
                            text.match(/Copper\s*:?\s*([0-9]+\.?[0-9]*)\s*(?:ppm|mg\/kg)/i);
            if (cuMatch) results.nutrients.Cu = parseFloat(cuMatch[1]);

            // Only return results if we found at least some nutrient values
            if (Object.keys(results.nutrients).length >= 3) {
                return results;
            }

            // Alternative parsing - look for tabular data
            // Penn State sometimes uses tables like: Element | Result | Sufficiency Range
            const tableMatch = text.match(/N(?:itrogen)?\s+(\d+\.\d+)/g);
            if (tableMatch) {
                // Try alternative parsing for different formats
                const altResults = parseAlternativeTissueFormat(text);
                if (altResults && Object.keys(altResults.nutrients).length >= 3) {
                    return altResults;
                }
            }

            return null;
        }

        function parseAlternativeTissueFormat(text) {
            // Handle tabular or different Penn State report formats
            const results = {
                sampleId: 'TS-UPLOAD-' + Date.now().toString().slice(-6),
                testDate: new Date().toISOString().slice(0, 10),
                crop: null,
                nutrients: {}
            };

            // Look for nutrient values in various formats
            const patterns = [
                { nutrient: 'N', regex: /Nitrogen[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*%/i },
                { nutrient: 'P', regex: /Phosphorus[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*%/i },
                { nutrient: 'K', regex: /Potassium[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*%/i },
                { nutrient: 'Ca', regex: /Calcium[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*%/i },
                { nutrient: 'Mg', regex: /Magnesium[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*%/i },
                { nutrient: 'S', regex: /Sulfur[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*%/i },
                { nutrient: 'B', regex: /Boron[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*(?:ppm|mg)/i },
                { nutrient: 'Zn', regex: /Zinc[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*(?:ppm|mg)/i },
                { nutrient: 'Mn', regex: /Manganese[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*(?:ppm|mg)/i },
                { nutrient: 'Fe', regex: /Iron[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*(?:ppm|mg)/i },
                { nutrient: 'Cu', regex: /Copper[\s\S]{0,30}?([0-9]+\.?[0-9]*)\s*(?:ppm|mg)/i }
            ];

            patterns.forEach(p => {
                const match = text.match(p.regex);
                if (match) {
                    results.nutrients[p.nutrient] = parseFloat(match[1]);
                }
            });

            return results;
        }

        function showTissuePdfPreview(parsedResults) {
            // Show a modal for user to verify/edit extracted data and link to pending sample
            const modal = document.getElementById('tissueResultsModal');
            const cropOptions = Object.entries(TISSUE_SUFFICIENCY).map(([key, val]) =>
                '<option value="' + key + '">' + val.name + '</option>'
            ).join('');

            const fieldOptions = Object.keys(FARM_FIELDS).map(f =>
                '<option value="' + f + '">' + f + '</option>'
            ).join('');

            // Try to match with pending samples
            const pendingOptions = pendingSamples.length > 0 ?
                '<option value="">-- Link to Pending Sample --</option>' +
                pendingSamples.map(s =>
                    '<option value="' + s.id + '">' + s.sampleId + ' (' + s.crop + ' - ' + s.fieldZone + ')</option>'
                ).join('') :
                '<option value="">No pending samples</option>';

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>Review Extracted Tissue Test Data</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9;">Verify the data below and link to sample info</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form id="tissuePdfReviewForm" onsubmit="saveTissuePdfResults(event)">
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <strong style="color: #92400e;">Link to Pending Sample (Optional)</strong>
                                <select id="pdfLinkPending" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; margin-top: 0.5rem;" onchange="fillFromPendingSample(this.value)">
                                    ${pendingOptions}
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label>Sample ID</label>
                                    <input type="text" id="pdfSampleId" value="${parsedResults.sampleId || 'TS-UPLOAD-' + Date.now().toString().slice(-6)}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label>Test Date</label>
                                    <input type="date" id="pdfTestDate" value="${parsedResults.testDate}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label>Crop *</label>
                                    <select id="pdfCrop" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">Select crop...</option>
                                        ${cropOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Field Zone *</label>
                                    <select id="pdfFieldZone" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">Select field...</option>
                                        ${fieldOptions}
                                    </select>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div class="form-group">
                                    <label>Lot Number</label>
                                    <input type="text" id="pdfLotNumber" placeholder="e.g., TOM-2026-001" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label>Collection Date</label>
                                    <input type="date" id="pdfCollectionDate" value="${new Date().toISOString().slice(0, 10)}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                            </div>

                            <h4 style="margin-bottom: 1rem; color: #374151;">Extracted Nutrient Values</h4>
                            <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">Edit any values that were not correctly extracted:</p>

                            <h5 style="margin-bottom: 0.5rem; color: #6b7280;">Macronutrients (%)</h5>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                ${['N', 'P', 'K', 'Ca', 'Mg', 'S'].map(n => `
                                    <div class="form-group">
                                        <label>${n}</label>
                                        <input type="number" step="0.01" id="pdf_${n}" value="${parsedResults.nutrients[n] || ''}" placeholder="-" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; ${parsedResults.nutrients[n] ? 'background: #f0fdf4;' : ''}">
                                    </div>
                                `).join('')}
                            </div>

                            <h5 style="margin-bottom: 0.5rem; color: #6b7280;">Micronutrients (ppm)</h5>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                ${['B', 'Zn', 'Mn', 'Fe', 'Cu'].map(n => `
                                    <div class="form-group">
                                        <label>${n}</label>
                                        <input type="number" step="0.1" id="pdf_${n}" value="${parsedResults.nutrients[n] || ''}" placeholder="-" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; ${parsedResults.nutrients[n] ? 'background: #f0fdf4;' : ''}">
                                    </div>
                                `).join('')}
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="closeTissueResultsModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                                    Save Tissue Test
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function fillFromPendingSample(pendingId) {
            if (!pendingId) return;

            const sample = pendingSamples.find(s => s.id === pendingId);
            if (!sample) return;

            document.getElementById('pdfSampleId').value = sample.sampleId;
            document.getElementById('pdfCrop').value = sample.crop;
            document.getElementById('pdfFieldZone').value = sample.fieldZone;
            document.getElementById('pdfLotNumber').value = sample.lotNumber || '';
            document.getElementById('pdfCollectionDate').value = sample.collectionDate;
        }

        function saveTissuePdfResults(event) {
            event.preventDefault();

            const results = {};
            ['N', 'P', 'K', 'Ca', 'Mg', 'S', 'B', 'Zn', 'Mn', 'Fe', 'Cu'].forEach(n => {
                const val = parseFloat(document.getElementById('pdf_' + n).value);
                if (!isNaN(val)) results[n] = val;
            });

            if (Object.keys(results).length === 0) {
                showToast('Please enter at least one nutrient value', 'error');
                return;
            }

            const crop = document.getElementById('pdfCrop').value;
            const fieldZone = document.getElementById('pdfFieldZone').value;

            if (!crop || !fieldZone) {
                showToast('Please select crop and field zone', 'error');
                return;
            }

            const tissueTest = {
                id: Date.now().toString(),
                sampleId: document.getElementById('pdfSampleId').value,
                collectionDate: document.getElementById('pdfCollectionDate').value,
                testDate: document.getElementById('pdfTestDate').value,
                crop: crop,
                fieldZone: fieldZone,
                lotNumber: document.getElementById('pdfLotNumber').value,
                growthStage: 'unknown',
                results: results,
                source: 'pdf_upload',
                createdAt: new Date().toISOString()
            };

            // Save to tissue tests
            tissueTests.push(tissueTest);
            localStorage.setItem('tissueTests', JSON.stringify(tissueTests));

            // If linked to pending sample, remove it
            const linkedPendingId = document.getElementById('pdfLinkPending').value;
            if (linkedPendingId) {
                pendingSamples = pendingSamples.filter(s => s.id !== linkedPendingId);
                localStorage.setItem('pendingTissueSamples', JSON.stringify(pendingSamples));
            }

            closeTissueResultsModal();
            renderTissueTests();
            showToast('Tissue test saved from PDF!', 'success');
        }

        // ============================================
        // FOLIAR PROGRAM - AEA Products & Scheduling
        // Based on Advancing Eco Agriculture methodology
        // ============================================

        // AEA Products Database - Source: advancingecoag.com
        const AEA_PRODUCTS = {
            // ESSENTIALS - Foundation products
            biocoatGold: {
                name: 'BioCoat Gold',
                category: 'seed_treatment',
                purpose: 'Seed germination catalyst with mycorrhizal inoculant',
                ratePerAcre: '1 gram per pound of seed',
                ratePerSqFt: 'Mix with seed before planting',
                timing: 'At planting',
                frequency: 'Once',
                organic: true,
                tier: 1,
                priceEstimate: 50, // per unit
                benefits: ['30-50% better germination', 'Stronger seedlings', 'Earlier root establishment']
            },
            spectrum: {
                name: 'Spectrum',
                category: 'soil_biology',
                purpose: 'Soil inoculant with beneficial microorganisms',
                ratePerAcre: '1-2 gal',
                ratePerSqFt: '3-6 oz per 1000 sqft',
                timing: 'Soil prep, transplant, mid-season',
                frequency: '2-3x per season',
                organic: true,
                tier: 1,
                priceEstimate: 45,
                benefits: ['Restores soil microbiome', 'Nutrient cycling', 'Disease suppression']
            },
            rejuvenate: {
                name: 'Rejuvenate',
                category: 'soil_biology',
                purpose: 'Microbial food - feeds soil biology',
                ratePerAcre: '1-2 gal',
                ratePerSqFt: '3-6 oz per 1000 sqft',
                timing: 'Apply with Spectrum',
                frequency: '2-3x per season',
                organic: true,
                tier: 1,
                priceEstimate: 40,
                benefits: ['Activates dormant biology', 'Increases microbial diversity', 'Improves nutrient availability']
            },
            macroPak: {
                name: 'MacroPak',
                category: 'foliar_nutrition',
                purpose: 'Complete macronutrient formula (N-P-K-Ca-Mg-S)',
                ratePerAcre: '2 qt foliar / 2 gal fertigation',
                ratePerSqFt: '1.5 oz foliar / 6 oz fertigation per 1000 sqft',
                timing: 'Throughout growing season',
                frequency: 'Bi-weekly',
                organic: true,
                tier: 1,
                priceEstimate: 27,
                benefits: ['Complete macros', 'Supports photosynthesis', 'Plant available forms']
            },
            microPak: {
                name: 'MicroPak',
                category: 'foliar_nutrition',
                purpose: 'Essential micronutrients (B-Co-Cu-Fe-Mo-Mn-Zn)',
                ratePerAcre: '1 pt foliar',
                ratePerSqFt: '0.5 oz per 1000 sqft',
                timing: 'Throughout growing season',
                frequency: 'Bi-weekly',
                organic: true,
                tier: 1,
                priceEstimate: 25,
                benefits: ['8 essential micros', 'Enzyme activation', 'Chlorophyll production']
            },
            // FUNCTIONAL - Strategic timing products
            accelerate: {
                name: 'Accelerate',
                category: 'functional',
                purpose: 'Flowering and fruiting support',
                ratePerAcre: '2-4 gal',
                ratePerSqFt: '6-12 oz per 1000 sqft',
                timing: '1-2 weeks before bloom, then bi-weekly for continuous croppers',
                frequency: 'As needed during reproductive phase',
                organic: true,
                tier: 2,
                priceEstimate: 32,
                benefits: ['Better fruit set', 'Increased pod count', 'Quality improvement']
            },
            seaStim: {
                name: 'SeaStim',
                category: 'functional',
                purpose: 'Kelp-based vegetative growth support',
                ratePerAcre: '2 qt',
                ratePerSqFt: '1.5 oz per 1000 sqft',
                timing: 'During vegetative growth',
                frequency: 'Bi-weekly',
                organic: true,
                tier: 2,
                priceEstimate: 35,
                benefits: ['Root development', 'Stress resistance', 'Vegetative vigor']
            },
            forageFoliar: {
                name: 'Forage Foliar Blend',
                category: 'complete_nutrition',
                purpose: 'Combined vegetative nutrition (HoloPhos+SeaStim+PhotoMag+MicroPak)',
                ratePerAcre: '1-3 gal foliar',
                ratePerSqFt: '4-12 oz per 1000 sqft',
                timing: 'Vegetative phase through early reproductive',
                frequency: 'Every 2-4 weeks',
                organic: true,
                tier: 2,
                priceEstimate: 155,
                benefits: ['Complete vegetative nutrition', 'Stress recovery', 'Simplified application'],
                notes: 'Pre-blended for convenience. Equivalent to 4 separate products.'
            },
            pinion: {
                name: 'Pinion',
                category: 'disease_prevention',
                purpose: 'Foliar disease prevention without disrupting microbiome',
                ratePerAcre: '2-3 qt preventative / 1 gal responsive',
                ratePerSqFt: '1.5-3 oz per 1000 sqft',
                timing: '30 days after germination, then monthly',
                frequency: 'Monthly preventative or as needed',
                organic: true,
                tier: 2,
                priceEstimate: 20,
                benefits: ['59% reduction in powdery mildew', 'Broad spectrum', 'Safe for beneficials']
            },
            photoMag: {
                name: 'PhotoMag',
                category: 'functional',
                purpose: 'Photosynthesis optimizer',
                ratePerAcre: '2 qt',
                ratePerSqFt: '1.5 oz per 1000 sqft',
                timing: 'Before/after stress events, during fruit fill',
                frequency: 'As needed',
                organic: true,
                tier: 2,
                priceEstimate: 30,
                benefits: ['3-4x photosynthesis increase', 'Stress recovery', 'Sugar production']
            },
            micro5000: {
                name: 'Micro5000 Organic',
                category: 'biological',
                purpose: 'Foliar microbial inoculant',
                ratePerAcre: '75 grams',
                ratePerSqFt: '2 grams per 1000 sqft',
                timing: 'Add to foliar tank mixes',
                frequency: 'Every spray',
                organic: true,
                tier: 2,
                priceEstimate: 49,
                benefits: ['Leaf surface colonization', 'Nutrient solubilization', 'Disease competition']
            },
            // NUTRITIONAL - Targeted corrections
            reboundBoron: {
                name: 'ReBound Boron',
                category: 'micronutrient',
                purpose: 'Chelated boron for fruit set and cell walls',
                ratePerAcre: '1-2 pt',
                ratePerSqFt: '0.5-1 oz per 1000 sqft',
                timing: 'Pre-bloom, fruit set',
                frequency: 'As indicated by sap/tissue analysis',
                organic: true,
                tier: 3,
                priceEstimate: 23,
                benefits: ['Better pollination', 'Strong cell walls', 'Prevents hollow stem']
            },
            reboundManganese: {
                name: 'ReBound Manganese',
                category: 'micronutrient',
                purpose: 'Chelated manganese for photosynthesis',
                ratePerAcre: '1-2 pt',
                ratePerSqFt: '0.5-1 oz per 1000 sqft',
                timing: 'When deficiency indicated',
                frequency: 'As needed',
                organic: true,
                tier: 3,
                priceEstimate: 25,
                benefits: ['Chlorophyll production', 'Water splitting in photosynthesis', 'Enzyme activation']
            },
            reboundIron: {
                name: 'ReBound Iron',
                category: 'micronutrient',
                purpose: 'Chelated iron for chlorophyll',
                ratePerAcre: '1-2 pt',
                ratePerSqFt: '0.5-1 oz per 1000 sqft',
                timing: 'When deficiency indicated',
                frequency: 'As needed',
                organic: true,
                tier: 3,
                priceEstimate: 22,
                benefits: ['Chlorophyll assembly', 'Dark green foliage', 'Enzyme function']
            },
            holoCal: {
                name: 'HoloCal',
                category: 'macronutrient',
                purpose: 'Fast-acting bioavailable calcium',
                ratePerAcre: '2-4 qt',
                ratePerSqFt: '1.5-3 oz per 1000 sqft',
                timing: 'Fruit development, high demand periods',
                frequency: 'Weekly during fruit fill',
                organic: true,
                tier: 3,
                priceEstimate: 40,
                benefits: ['Prevents BER', 'Cell wall strength', 'Shelf life improvement']
            },
            holoK: {
                name: 'Holo-K',
                category: 'macronutrient',
                purpose: 'Potassium for fruit quality',
                ratePerAcre: '2-4 qt',
                ratePerSqFt: '1.5-3 oz per 1000 sqft',
                timing: 'Fruit sizing and ripening',
                frequency: 'Weekly during fruit fill',
                organic: true,
                tier: 3,
                priceEstimate: 53,
                benefits: ['Sugar transport', 'Fruit size', 'Color development']
            }
        };

        // Standard Tank Mix Recipes
        const FOLIAR_RECIPES = {
            baseNutrition: {
                name: 'Base Nutrition Mix',
                description: 'Bi-weekly foundation spray for all crops',
                products: [
                    { product: 'macroPak', parts: 4 },
                    { product: 'microPak', parts: 1 },
                    { product: 'micro5000', parts: 1 }
                ],
                waterRatio: '10:1 minimum dilution',
                timing: 'Every 2 weeks, evening application',
                crops: 'all'
            },
            fruitingCrops: {
                name: 'Fruiting Crop Mix',
                description: 'For tomatoes, peppers, squash, cucumbers during flowering/fruiting',
                products: [
                    { product: 'accelerate', parts: 4 },
                    { product: 'microPak', parts: 1 },
                    { product: 'micro5000', parts: 1 }
                ],
                waterRatio: '10:1 minimum dilution',
                timing: 'Bi-weekly during reproductive phase',
                crops: ['tomato', 'pepper', 'squash', 'cucumber', 'melon', 'eggplant']
            },
            vegetativeCrops: {
                name: 'Vegetative Crop Mix',
                description: 'For leafy greens, brassicas, root crops',
                products: [
                    { product: 'seaStim', parts: 4 },
                    { product: 'microPak', parts: 1 },
                    { product: 'micro5000', parts: 1 }
                ],
                waterRatio: '10:1 minimum dilution',
                timing: 'Bi-weekly during growth',
                crops: ['lettuce', 'spinach', 'kale', 'broccoli', 'cabbage', 'carrot', 'beet']
            },
            diseasePreventative: {
                name: 'Disease Prevention Mix',
                description: 'Monthly preventative for disease-prone crops',
                products: [
                    { product: 'pinion', parts: 2 },
                    { product: 'macroPak', parts: 2 },
                    { product: 'microPak', parts: 1 }
                ],
                waterRatio: '10:1 minimum dilution',
                timing: 'Monthly, starting 30 days after germination',
                crops: ['tomato', 'squash', 'cucumber', 'zinnia', 'dahlia']
            },
            floralProduction: {
                name: 'Cut Flower Mix',
                description: 'For dahlias, zinnias, sunflowers, lisianthus',
                products: [
                    { product: 'accelerate', parts: 3 },
                    { product: 'macroPak', parts: 2 },
                    { product: 'microPak', parts: 1 }
                ],
                waterRatio: '10:1 minimum dilution',
                timing: 'Bi-weekly from bud initiation through harvest',
                crops: ['dahlia', 'zinnia', 'sunflower', 'lisianthus', 'snapdragon', 'celosia']
            },
            stressRecovery: {
                name: 'Stress Recovery Mix',
                description: 'After hail, frost, heat stress, transplant shock',
                products: [
                    { product: 'photoMag', parts: 2 },
                    { product: 'seaStim', parts: 2 },
                    { product: 'micro5000', parts: 1 }
                ],
                waterRatio: '10:1 minimum dilution',
                timing: 'Within 24 hours of stress event',
                crops: 'all'
            }
        };

        // Critical Points of Influence - Key spray windows
        const CRITICAL_POINTS = {
            seedTreatment: {
                name: 'Seed Treatment',
                daysFromPlanting: 0,
                products: ['biocoatGold'],
                priority: 'essential',
                description: 'Coat seeds before planting for 30-50% better germination'
            },
            transplant: {
                name: 'Transplant Drench',
                daysFromPlanting: 0,
                products: ['spectrum', 'rejuvenate'],
                priority: 'essential',
                description: 'Root zone drench at transplant establishes beneficial biology'
            },
            earlyVegetative: {
                name: 'Early Vegetative',
                daysFromPlanting: 14,
                products: ['macroPak', 'microPak', 'seaStim'],
                priority: 'important',
                description: 'Build strong plant structure and root system'
            },
            preBloom: {
                name: 'Pre-Bloom',
                daysFromPlanting: null, // varies by crop
                weeksBefore: 2,
                products: ['accelerate', 'reboundBoron', 'microPak'],
                priority: 'critical',
                description: 'Set up flower initiation and pollination success'
            },
            fruitSet: {
                name: 'Fruit Set',
                daysFromPlanting: null,
                weeksAfterBloom: 1,
                products: ['holoCal', 'accelerate', 'reboundBoron'],
                priority: 'critical',
                description: 'Prevent BER and ensure strong cell development'
            },
            fruitFill: {
                name: 'Fruit Fill',
                daysFromPlanting: null,
                products: ['photoMag', 'holoK', 'holoCal'],
                priority: 'important',
                description: 'Maximize size, sugar content, and quality'
            },
            stressEvent: {
                name: 'Stress Recovery',
                daysFromPlanting: null,
                products: ['photoMag', 'seaStim'],
                priority: 'responsive',
                description: 'Apply within 24 hours of frost, hail, or heat stress'
            }
        };

        // Plant Health Pyramid Levels
        const PLANT_HEALTH_PYRAMID = {
            level1: {
                name: 'Complete Photosynthesis',
                immunity: 'Soil-borne fungi (fusarium, pythium, verticillium)',
                minerals: ['Mg', 'Fe', 'Mn', 'N', 'P'],
                products: ['macroPak', 'microPak', 'reboundManganese', 'reboundIron'],
                achievableIn: '2-4 weeks',
                description: 'Plants produce 3-4x more sugars through proper photosynthesis'
            },
            level2: {
                name: 'Complete Protein Synthesis',
                immunity: 'Sucking/larval insects (aphids, hornworms, whiteflies)',
                minerals: ['Mg', 'S', 'Mo', 'B'],
                products: ['macroPak', 'reboundBoron'],
                achievableIn: '24-48 hours after application',
                description: 'All nitrogen converts to complete proteins - insects starve'
            },
            level3: {
                name: 'Lipid Synthesis',
                immunity: 'Airborne pathogens (powdery mildew, rust, fire blight)',
                minerals: ['Requires functional soil biology'],
                products: ['spectrum', 'rejuvenate', 'pinion'],
                achievableIn: '1-2 seasons',
                description: 'Plants build protective waxy coatings on leaves'
            },
            level4: {
                name: 'Secondary Metabolites',
                immunity: 'Chewing insects (beetles, stink bugs), nematodes',
                minerals: ['Diverse soil microbiome required'],
                products: ['spectrum', 'rejuvenate', 'micro5000'],
                achievableIn: '2-3 seasons',
                description: 'Plants produce defensive compounds (flavanols, phytoalexins)'
            }
        };

        // LocalStorage for foliar schedule
        let foliarSchedule = JSON.parse(localStorage.getItem('foliarSchedule') || '[]');
        let foliarTasks = JSON.parse(localStorage.getItem('foliarTasks') || '[]');

        function renderFoliarProgram() {
            const container = document.getElementById('testsContainer');
            const today = new Date();
            const thisWeek = foliarTasks.filter(t => {
                const taskDate = new Date(t.scheduledDate);
                const diffDays = Math.ceil((taskDate - today) / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 7 && t.status !== 'completed';
            });

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">Foliar & Fertigation Program</h3>
                            <p style="color: #64748b; font-size: 0.875rem;">
                                Build plant health systematically using AEA methodology. Spray schedules, tank mixes, and SOPs.
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button onclick="showGenerateScheduleModal()" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                                + Generate Schedule
                            </button>
                            <button onclick="showQuickSprayModal()" class="btn btn-primary" style="padding: 0.75rem 1.5rem; background: #7c3aed;">
                                Quick Spray Task
                            </button>
                        </div>
                    </div>
                </div>

                <!-- This Week's Tasks -->
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #92400e; margin-bottom: 1rem;">This Week's Spray Tasks (${thisWeek.length})</h4>
                    ${thisWeek.length === 0 ? `
                        <p style="color: #78350f; font-style: italic;">No spray tasks scheduled this week. Generate a schedule or add a quick task.</p>
                    ` : `
                        <div style="display: grid; gap: 0.75rem;">
                            ${thisWeek.map(task => `
                                <div style="background: white; border-radius: 0.5rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                    <div>
                                        <strong style="color: #1e293b;">${task.name}</strong>
                                        <div style="font-size: 0.875rem; color: #64748b;">
                                            ${task.fields.join(', ')} | ${formatDate(task.scheduledDate)}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #7c3aed; margin-top: 0.25rem;">
                                            ${task.products.map(p => AEA_PRODUCTS[p]?.name || p).join(' + ')}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="viewSprayTask('${task.id}')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                                            View SOP
                                        </button>
                                        <button onclick="completeSprayTask('${task.id}')" class="btn btn-success" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                                            Complete
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>

                <!-- Tank Mix Recipes -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Standard Tank Mix Recipes</h4>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">Pre-configured recipes based on AEA recommendations. Click to view full SOP.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                        ${Object.entries(FOLIAR_RECIPES).map(([key, recipe]) => `
                            <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; cursor: pointer;" onclick="showRecipeDetail('${key}')">
                                <h5 style="color: #1e293b; margin-bottom: 0.5rem;">${recipe.name}</h5>
                                <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.5rem;">${recipe.description}</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                    ${recipe.products.map(p => `
                                        <span style="background: #f0fdf4; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                            ${AEA_PRODUCTS[p.product]?.name || p.product}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Plant Health Pyramid -->
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #166534; margin-bottom: 1rem;">Plant Health Pyramid (John Kempf / AEA)</h4>
                    <p style="color: #14532d; font-size: 0.875rem; margin-bottom: 1rem;">Build immunity systematically. Levels 1-2 through nutrition, Levels 3-4 through soil biology.</p>
                    <div style="display: grid; gap: 1rem;">
                        ${Object.entries(PLANT_HEALTH_PYRAMID).map(([level, data], idx) => `
                            <div style="background: white; border-radius: 0.5rem; padding: 1rem; border-left: 4px solid ${idx === 0 ? '#22c55e' : idx === 1 ? '#84cc16' : idx === 2 ? '#eab308' : '#f97316'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">
                                    <div>
                                        <strong style="color: #1e293b;">Level ${idx + 1}: ${data.name}</strong>
                                        <div style="color: #64748b; font-size: 0.875rem; margin-top: 0.25rem;">
                                            <strong>Immunity:</strong> ${data.immunity}
                                        </div>
                                        <div style="color: #64748b; font-size: 0.875rem;">
                                            <strong>Key Minerals:</strong> ${Array.isArray(data.minerals) ? data.minerals.join(', ') : data.minerals}
                                        </div>
                                    </div>
                                    <span style="background: ${idx < 2 ? '#dcfce7' : '#fef9c3'}; color: ${idx < 2 ? '#166534' : '#854d0e'}; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                        ${data.achievableIn}
                                    </span>
                                </div>
                                <p style="color: #475569; font-size: 0.875rem; margin-top: 0.5rem; font-style: italic;">${data.description}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- AEA Products Database -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">AEA Products Reference</h4>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button onclick="filterAEAProducts('all')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">All</button>
                        <button onclick="filterAEAProducts(1)" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Tier 1 (Essential)</button>
                        <button onclick="filterAEAProducts(2)" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Tier 2 (Functional)</button>
                        <button onclick="filterAEAProducts(3)" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Tier 3 (Targeted)</button>
                    </div>
                    <div id="aeaProductsList" style="display: grid; gap: 0.75rem;">
                        ${renderAEAProductsList('all')}
                    </div>
                </div>

                <!-- Critical Points of Influence -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Critical Points of Influence (CPIs)</h4>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">These are the "don't miss" spray windows for maximum impact.</p>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e2e8f0;">CPI</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Timing</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Products</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Priority</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(CRITICAL_POINTS).map(([key, cpi]) => `
                                    <tr style="border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.75rem; font-weight: 600;">${cpi.name}</td>
                                        <td style="padding: 0.75rem; color: #64748b;">
                                            ${cpi.daysFromPlanting !== null ? 'Day ' + cpi.daysFromPlanting :
                                              cpi.weeksBefore ? cpi.weeksBefore + ' weeks before bloom' :
                                              cpi.weeksAfterBloom ? cpi.weeksAfterBloom + ' week after bloom' : 'As needed'}
                                        </td>
                                        <td style="padding: 0.75rem;">
                                            ${cpi.products.map(p => `<span style="background: #f0fdf4; color: #166534; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.75rem; margin-right: 0.25rem;">${AEA_PRODUCTS[p]?.name || p}</span>`).join('')}
                                        </td>
                                        <td style="padding: 0.75rem;">
                                            <span style="background: ${cpi.priority === 'essential' ? '#fee2e2' : cpi.priority === 'critical' ? '#fef3c7' : cpi.priority === 'important' ? '#dbeafe' : '#f3f4f6'};
                                                         color: ${cpi.priority === 'essential' ? '#991b1b' : cpi.priority === 'critical' ? '#92400e' : cpi.priority === 'important' ? '#1e40af' : '#374151'};
                                                         padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase;">
                                                ${cpi.priority}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Spray History -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Recent Spray Applications</h4>
                    ${foliarTasks.filter(t => t.status === 'completed').length === 0 ? `
                        <p style="color: #64748b; font-style: italic;">No spray applications recorded yet.</p>
                    ` : `
                        <div style="display: grid; gap: 0.5rem;">
                            ${foliarTasks.filter(t => t.status === 'completed').slice(-10).reverse().map(task => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 0.375rem;">
                                    <div>
                                        <span style="font-weight: 500;">${task.name}</span>
                                        <span style="color: #64748b; font-size: 0.875rem;"> - ${task.fields.join(', ')}</span>
                                    </div>
                                    <span style="color: #10b981; font-size: 0.875rem;">${formatDate(task.completedDate || task.scheduledDate)}</span>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>

                <!-- Generate Schedule Modal -->
                <div id="foliarScheduleModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 1rem;"></div>
            `;
        }

        function renderAEAProductsList(filter) {
            const products = Object.entries(AEA_PRODUCTS).filter(([key, p]) =>
                filter === 'all' || p.tier === filter
            );

            return products.map(([key, product]) => `
                <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <strong style="color: #1e293b;">${product.name}</strong>
                            <span style="background: ${product.tier === 1 ? '#dcfce7' : product.tier === 2 ? '#dbeafe' : '#fef3c7'};
                                         color: ${product.tier === 1 ? '#166534' : product.tier === 2 ? '#1e40af' : '#92400e'};
                                         padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem;">
                                Tier ${product.tier}
                            </span>
                            ${product.organic ? '<span style="background: #f0fdf4; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.25rem;">OMRI</span>' : ''}
                        </div>
                        <span style="color: #64748b; font-size: 0.875rem;">~$${product.priceEstimate}/unit</span>
                    </div>
                    <p style="color: #64748b; font-size: 0.875rem; margin: 0.5rem 0;">${product.purpose}</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.75rem; color: #475569;">
                        <div><strong>Rate:</strong> ${product.ratePerAcre}/acre</div>
                        <div><strong>Frequency:</strong> ${product.frequency}</div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem;">
                        ${product.benefits.map(b => `<span style="background: #f1f5f9; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem; color: #475569;">${b}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function filterAEAProducts(tier) {
            document.getElementById('aeaProductsList').innerHTML = renderAEAProductsList(tier);
        }

        function showGenerateScheduleModal() {
            const modal = document.getElementById('foliarScheduleModal');
            const fieldOptions = Object.keys(FARM_FIELDS).map(f =>
                `<label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0;">
                    <input type="checkbox" name="scheduleFields" value="${f}"> ${f}
                </label>`
            ).join('');

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>Generate Spray Schedule</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9;">Create a bi-weekly spray schedule for your fields</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form onsubmit="generateFoliarSchedule(event)">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Schedule Type</label>
                                <select id="scheduleType" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    <option value="baseNutrition">Base Nutrition (All Crops)</option>
                                    <option value="fruitingCrops">Fruiting Crops Program</option>
                                    <option value="vegetativeCrops">Vegetative Crops Program</option>
                                    <option value="floralProduction">Cut Flower Program</option>
                                    <option value="full">Full Season Program (Recommended)</option>
                                </select>
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Select Fields</label>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.5rem;">
                                    ${fieldOptions}
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600;">Start Date</label>
                                    <input type="date" id="scheduleStartDate" value="${new Date().toISOString().slice(0, 10)}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600;">Duration (weeks)</label>
                                    <select id="scheduleDuration" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="4">4 weeks</option>
                                        <option value="8" selected>8 weeks</option>
                                        <option value="12">12 weeks</option>
                                        <option value="16">16 weeks (full season)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Spray Day</label>
                                <select id="sprayDay" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    <option value="1">Monday</option>
                                    <option value="2" selected>Tuesday</option>
                                    <option value="3">Wednesday</option>
                                    <option value="4">Thursday</option>
                                    <option value="5">Friday</option>
                                </select>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeFoliarScheduleModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Cancel</button>
                                <button type="submit" class="btn btn-success" style="padding: 0.75rem 1.5rem;">Generate Schedule</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function closeFoliarScheduleModal() {
            document.getElementById('foliarScheduleModal').style.display = 'none';
        }

        function generateFoliarSchedule(event) {
            event.preventDefault();

            const scheduleType = document.getElementById('scheduleType').value;
            const startDate = new Date(document.getElementById('scheduleStartDate').value);
            const duration = parseInt(document.getElementById('scheduleDuration').value);
            const sprayDay = parseInt(document.getElementById('sprayDay').value);
            const selectedFields = Array.from(document.querySelectorAll('input[name="scheduleFields"]:checked')).map(cb => cb.value);

            if (selectedFields.length === 0) {
                showToast('Please select at least one field', 'error');
                return;
            }

            // Find first spray day
            let currentDate = new Date(startDate);
            while (currentDate.getDay() !== sprayDay) {
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const newTasks = [];
            const recipes = scheduleType === 'full' ?
                ['baseNutrition', 'fruitingCrops', 'vegetativeCrops', 'diseasePreventative'] :
                [scheduleType];

            // Generate bi-weekly tasks
            for (let week = 0; week < duration; week += 2) {
                const taskDate = new Date(currentDate);
                taskDate.setDate(taskDate.getDate() + (week * 7));

                const recipeKey = recipes[Math.floor(week / 2) % recipes.length];
                const recipe = FOLIAR_RECIPES[recipeKey];

                newTasks.push({
                    id: Date.now().toString() + '-' + week,
                    name: recipe.name,
                    recipeKey: recipeKey,
                    products: recipe.products.map(p => p.product),
                    fields: selectedFields,
                    scheduledDate: taskDate.toISOString().slice(0, 10),
                    status: 'pending',
                    notes: recipe.description,
                    createdAt: new Date().toISOString()
                });
            }

            foliarTasks = [...foliarTasks, ...newTasks];
            localStorage.setItem('foliarTasks', JSON.stringify(foliarTasks));

            closeFoliarScheduleModal();
            renderFoliarProgram();
            showToast(`Generated ${newTasks.length} spray tasks over ${duration} weeks`, 'success');
        }

        function showQuickSprayModal() {
            const modal = document.getElementById('foliarScheduleModal');
            const fieldOptions = Object.keys(FARM_FIELDS).map(f =>
                `<label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0;">
                    <input type="checkbox" name="quickFields" value="${f}"> ${f}
                </label>`
            ).join('');

            const productOptions = Object.entries(AEA_PRODUCTS).map(([key, p]) =>
                `<label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0;">
                    <input type="checkbox" name="quickProducts" value="${key}"> ${p.name} (${p.category})
                </label>`
            ).join('');

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>Quick Spray Task</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9;">Create a one-time spray task</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form onsubmit="createQuickSprayTask(event)">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Task Name</label>
                                <input type="text" id="quickTaskName" placeholder="e.g., Pre-bloom Accelerate spray" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Or Select Recipe</label>
                                <select id="quickRecipe" onchange="fillQuickRecipe()" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    <option value="">-- Custom Mix --</option>
                                    ${Object.entries(FOLIAR_RECIPES).map(([k, r]) => `<option value="${k}">${r.name}</option>`).join('')}
                                </select>
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Products</label>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.5rem;">
                                    ${productOptions}
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Fields</label>
                                <div style="max-height: 100px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.5rem;">
                                    ${fieldOptions}
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Scheduled Date</label>
                                <input type="date" id="quickDate" value="${new Date().toISOString().slice(0, 10)}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Notes</label>
                                <textarea id="quickNotes" rows="2" placeholder="Any special instructions..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeFoliarScheduleModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Cancel</button>
                                <button type="submit" class="btn btn-success" style="padding: 0.75rem 1.5rem;">Create Task</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function fillQuickRecipe() {
            const recipeKey = document.getElementById('quickRecipe').value;
            if (!recipeKey) return;

            const recipe = FOLIAR_RECIPES[recipeKey];
            document.getElementById('quickTaskName').value = recipe.name;

            // Uncheck all products first
            document.querySelectorAll('input[name="quickProducts"]').forEach(cb => cb.checked = false);

            // Check products in recipe
            recipe.products.forEach(p => {
                const cb = document.querySelector(`input[name="quickProducts"][value="${p.product}"]`);
                if (cb) cb.checked = true;
            });
        }

        function createQuickSprayTask(event) {
            event.preventDefault();

            const name = document.getElementById('quickTaskName').value || 'Custom Spray';
            const products = Array.from(document.querySelectorAll('input[name="quickProducts"]:checked')).map(cb => cb.value);
            const fields = Array.from(document.querySelectorAll('input[name="quickFields"]:checked')).map(cb => cb.value);
            const date = document.getElementById('quickDate').value;
            const notes = document.getElementById('quickNotes').value;

            if (products.length === 0) {
                showToast('Please select at least one product', 'error');
                return;
            }
            if (fields.length === 0) {
                showToast('Please select at least one field', 'error');
                return;
            }

            const task = {
                id: Date.now().toString(),
                name: name,
                products: products,
                fields: fields,
                scheduledDate: date,
                status: 'pending',
                notes: notes,
                createdAt: new Date().toISOString()
            };

            foliarTasks.push(task);
            localStorage.setItem('foliarTasks', JSON.stringify(foliarTasks));

            // Sync to backend
            syncToBackend('saveFoliarApplication', {
                date: task.scheduledDate,
                recipe: task.name,
                field: task.fields.join(', '),
                products: task.products.join(', '),
                notes: task.notes,
                status: task.status
            }).then(result => {
                if (result.success && result.id) {
                    const idx = foliarTasks.findIndex(t => t.id === task.id);
                    if (idx !== -1) {
                        foliarTasks[idx].backendId = result.id;
                        foliarTasks[idx].synced = true;
                        localStorage.setItem('foliarTasks', JSON.stringify(foliarTasks));
                    }
                }
            });

            closeFoliarScheduleModal();
            renderFoliarProgram();
            showToast('Spray task created!', 'success');
        }

        function viewSprayTask(taskId) {
            const task = foliarTasks.find(t => t.id === taskId);
            if (!task) return;

            // Calculate total area
            const totalAcres = task.fields.reduce((sum, f) => sum + (FARM_FIELDS[f]?.acreage || 0), 0);
            const totalSqFt = totalAcres * 43560;

            // Build product details with rates
            const productDetails = task.products.map(pKey => {
                const product = AEA_PRODUCTS[pKey];
                if (!product) return null;
                return {
                    name: product.name,
                    ratePerAcre: product.ratePerAcre,
                    totalAmount: `${product.ratePerAcre} x ${totalAcres.toFixed(2)} acres`,
                    purpose: product.purpose
                };
            }).filter(Boolean);

            const sopHtml = `
                <html>
                <head>
                    <title>Spray SOP - ${task.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                        h1 { color: #7c3aed; border-bottom: 2px solid #7c3aed; padding-bottom: 10px; }
                        .header-info { background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        .section { margin-bottom: 20px; }
                        .section h3 { color: #1e293b; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                        th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: left; }
                        th { background: #f1f5f9; }
                        .checklist { list-style: none; padding: 0; }
                        .checklist li { padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
                        .checklist li:before { content: "â˜ "; font-size: 1.2em; }
                        .warning { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 10px; margin: 10px 0; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1>Spray Application SOP</h1>

                    <div class="header-info">
                        <strong>Task:</strong> ${task.name}<br>
                        <strong>Scheduled Date:</strong> ${formatDate(task.scheduledDate)}<br>
                        <strong>Fields:</strong> ${task.fields.join(', ')}<br>
                        <strong>Total Area:</strong> ${totalAcres.toFixed(2)} acres (${Math.round(totalSqFt).toLocaleString()} sq ft)
                    </div>

                    <div class="section">
                        <h3>Products & Rates</h3>
                        <table>
                            <tr>
                                <th>Product</th>
                                <th>Rate/Acre</th>
                                <th>Total Needed</th>
                                <th>Purpose</th>
                            </tr>
                            ${productDetails.map(p => `
                                <tr>
                                    <td><strong>${p.name}</strong></td>
                                    <td>${p.ratePerAcre}</td>
                                    <td>${p.totalAmount}</td>
                                    <td>${p.purpose}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>

                    <div class="section">
                        <h3>Pre-Spray Checklist</h3>
                        <ul class="checklist">
                            <li>Check weather forecast - no rain expected for 6+ hours</li>
                            <li>Temperature below 85Â°F (spray in evening if hot)</li>
                            <li>Wind speed below 10 mph</li>
                            <li>Test water quality (pH, bicarbonates, chlorine)</li>
                            <li>Clean sprayer tank and nozzles</li>
                            <li>Calibrate sprayer output</li>
                            <li>Gather all products and measure amounts</li>
                        </ul>
                    </div>

                    <div class="section">
                        <h3>Mixing Instructions</h3>
                        <ol>
                            <li>Fill tank 1/3 full with clean water (rainwater preferred)</li>
                            <li>If using municipal water, add HumaCarb at 0.25% to neutralize chlorine</li>
                            <li>Start agitation</li>
                            <li>Add products in this order: biologicals first, then minerals, then oils</li>
                            <li>Continue agitation while adding remaining water</li>
                            <li>Maintain minimum 10:1 water dilution ratio</li>
                        </ol>
                    </div>

                    <div class="warning">
                        <strong>Best Practices:</strong><br>
                        â€¢ Apply in evening (after 5 PM) for best absorption<br>
                        â€¢ Light mist - don't saturate to dripping<br>
                        â€¢ Cover all leaf surfaces (top and bottom)<br>
                        â€¢ Plants absorb foliar nutrients within 2-6 hours
                    </div>

                    <div class="section">
                        <h3>Post-Spray</h3>
                        <ul class="checklist">
                            <li>Record actual application in farm records</li>
                            <li>Note any deviations from planned rates</li>
                            <li>Clean sprayer thoroughly</li>
                            <li>Store products properly</li>
                            <li>Schedule next application (2 weeks)</li>
                        </ul>
                    </div>

                    ${task.notes ? `
                        <div class="section">
                            <h3>Notes</h3>
                            <p>${task.notes}</p>
                        </div>
                    ` : ''}

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0; font-size: 0.9em; color: #64748b;">
                        Generated by Tiny Seed OS - Foliar Program<br>
                        Based on Advancing Eco Agriculture (AEA) methodology
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(sopHtml);
            printWindow.document.close();
        }

        function completeSprayTask(taskId) {
            const taskIndex = foliarTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            foliarTasks[taskIndex].status = 'completed';
            foliarTasks[taskIndex].completedDate = new Date().toISOString().slice(0, 10);

            localStorage.setItem('foliarTasks', JSON.stringify(foliarTasks));

            // Record in FarmLearning
            const task = foliarTasks[taskIndex];
            task.products.forEach(pKey => {
                const product = AEA_PRODUCTS[pKey];
                if (product) {
                    FarmLearning.recordAmendment({
                        date: task.completedDate,
                        fieldZone: task.fields[0],
                        material: product.name,
                        rate: product.ratePerAcre,
                        method: 'foliar',
                        notes: 'AEA foliar program - ' + task.name
                    });
                }
            });

            renderFoliarProgram();
            showToast('Spray task completed and recorded!', 'success');
        }

        function showRecipeDetail(recipeKey) {
            const recipe = FOLIAR_RECIPES[recipeKey];
            if (!recipe) return;

            const productDetails = recipe.products.map(p => {
                const product = AEA_PRODUCTS[p.product];
                return product ? { ...product, parts: p.parts } : null;
            }).filter(Boolean);

            alert(
                recipe.name + '\n\n' +
                recipe.description + '\n\n' +
                'Products:\n' + productDetails.map(p => `- ${p.name} (${p.parts} parts): ${p.purpose}`).join('\n') + '\n\n' +
                'Timing: ' + recipe.timing + '\n' +
                'Dilution: ' + recipe.waterRatio
            );
        }

        // ============================================
        // FARM INSIGHTS TAB - Learning Dashboard
        // ============================================

        function renderFarmInsights(filterZone = null) {
            const container = document.getElementById('testsContainer');
            const data = FarmLearning.load();
            const zones = FieldZoneManager.getZones();

            // Calculate summary stats
            const totalYears = new Set([
                ...data.soilHistory.map(s => s.year),
                ...data.cropHistory.map(c => c.year),
                ...data.yieldHistory.map(y => y.year)
            ].filter(Boolean)).size;

            const avgQuality = data.yieldHistory.length > 0
                ? (data.yieldHistory.reduce((sum, y) => sum + (y.quality || 0), 0) / data.yieldHistory.length).toFixed(1)
                : 'N/A';

            // Get recent insights
            const recentInsights = data.insights.slice(-10).reverse();

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 0.5rem;">Farm Learning Insights</h3>
                    <p style="color: #64748b; font-size: 0.875rem;">
                        Your farm's collective knowledge base. Every soil test, amendment, and harvest makes the system smarter.
                    </p>
                </div>

                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: white; border-radius: 0.75rem; padding: 1.25rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #7c3aed;">${totalYears || 0}</div>
                        <div style="color: #64748b; font-size: 0.875rem;">Years of Data</div>
                    </div>
                    <div style="background: white; border-radius: 0.75rem; padding: 1.25rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #10b981;">${data.soilHistory.length}</div>
                        <div style="color: #64748b; font-size: 0.875rem;">Soil Tests</div>
                    </div>
                    <div style="background: white; border-radius: 0.75rem; padding: 1.25rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">${data.amendmentHistory.length}</div>
                        <div style="color: #64748b; font-size: 0.875rem;">Amendments Applied</div>
                    </div>
                    <div style="background: white; border-radius: 0.75rem; padding: 1.25rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #06b6d4;">${data.yieldHistory.length}</div>
                        <div style="color: #64748b; font-size: 0.875rem;">Harvests Recorded</div>
                    </div>
                    <div style="background: white; border-radius: 0.75rem; padding: 1.25rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #ec4899;">${avgQuality}</div>
                        <div style="color: #64748b; font-size: 0.875rem;">Avg Yield Quality</div>
                    </div>
                    <div style="background: white; border-radius: 0.75rem; padding: 1.25rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6;">${zones.length}</div>
                        <div style="color: #64748b; font-size: 0.875rem;">Field Zones</div>
                    </div>
                </div>

                <!-- Data Management -->
                <div style="background: white; border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Data Management</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button onclick="exportFarmData()" class="btn btn-secondary" style="padding: 0.5rem 1rem; color: #64748b;">
                            Export All Farm Data (JSON)
                        </button>
                        <button onclick="document.getElementById('importFileInput').click()" class="btn btn-secondary" style="padding: 0.5rem 1rem; color: #64748b;">
                            Import Farm Data
                        </button>
                        <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importFarmData(event)">
                    </div>
                </div>

                <!-- Recent Insights -->
                <div style="background: white; border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">System-Generated Insights</h4>
                    ${recentInsights.length === 0 ? `
                        <p style="color: #64748b; font-style: italic;">
                            Insights will appear here as you record more data. The system learns from:
                            soil tests, amendments applied, crops grown, and harvest results.
                        </p>
                    ` : `
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            ${recentInsights.map(insight => `
                                <div style="padding: 0.75rem; background: #f0fdf4; border-left: 3px solid #10b981; border-radius: 0.25rem;">
                                    <div style="font-size: 0.875rem;">
                                        ${insight.type === 'yield_correlation' ?
                                            `<strong>${insight.cropName}</strong> yield quality: ${insight.yieldQuality}/5 in ${insight.year}` :
                                            insight.message || JSON.stringify(insight)
                                        }
                                    </div>
                                    <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">
                                        ${formatDate(insight.generatedAt)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>

                <!-- Field Zone Performance -->
                ${zones.length > 0 ? `
                    <div style="background: white; border-radius: 1rem; padding: 1.25rem;">
                        <h4 style="margin-bottom: 1rem;">Field Zone Performance</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                            ${zones.map(zone => {
                                const stats = FarmLearning.getFieldStats(zone.id);
                                const nutrientGroup = NUTRIENT_GROUPS[zone.nutrientProfile];
                                return `
                                    <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <strong>${zone.name}</strong>
                                            <span style="font-size: 0.75rem; padding: 0.125rem 0.5rem; background: ${nutrientGroup?.color}20; color: ${nutrientGroup?.color}; border-radius: 9999px;">
                                                ${nutrientGroup?.name || 'Not Set'}
                                            </span>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem;">
                                            <div>Soil Tests: <strong>${stats.totalSoilTests}</strong></div>
                                            <div>Amendments: <strong>${stats.totalAmendments}</strong></div>
                                            <div>Crops Grown: <strong>${stats.totalCrops}</strong></div>
                                            <div>Avg Quality: <strong>${stats.avgYieldQuality ? stats.avgYieldQuality.toFixed(1) + '/5' : 'N/A'}</strong></div>
                                        </div>
                                        ${stats.soilTrend ? `
                                            <div style="margin-top: 0.5rem; font-size: 0.75rem;">
                                                ${stats.soilTrend.improving.length > 0 ? `<span style="color: #10b981;">Improving: ${stats.soilTrend.improving.join(', ')}</span>` : ''}
                                                ${stats.soilTrend.declining.length > 0 ? `<span style="color: #ef4444; margin-left: 0.5rem;">Declining: ${stats.soilTrend.declining.join(', ')}</span>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Getting Started Guide -->
                ${data.soilHistory.length === 0 ? `
                    <div style="background: #f5f3ff; border-radius: 1rem; padding: 1.5rem; margin-top: 1.5rem;">
                        <h4 style="color: #7c3aed; margin-bottom: 1rem;">Getting Started with Farm Learning</h4>
                        <ol style="color: #64748b; line-height: 1.8;">
                            <li><strong>Create Field Zones</strong> - Organize your farm into zones with similar conditions</li>
                            <li><strong>Upload Soil Tests</strong> - Add your Logan Labs results to track soil health over time</li>
                            <li><strong>Plan Amendments</strong> - Use the calculator and link amendments to field zones</li>
                            <li><strong>Record Harvests</strong> - Log yields and quality to find what works best</li>
                            <li><strong>Review Insights</strong> - The system will learn and provide smarter recommendations</li>
                        </ol>
                    </div>
                ` : ''}
            `;
        }

        function exportFarmData() {
            const jsonData = FarmLearning.exportAllData();
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `farm_learning_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Farm data exported successfully', 'success');
        }

        function importFarmData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const result = FarmLearning.importData(e.target.result);
                if (result.success) {
                    showToast('Farm data imported successfully', 'success');
                    renderFarmInsights();
                } else {
                    showToast(result.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // ============================================
        // PLANT DOCTOR TAB - Deficiency Diagnosis & Quick Fix
        // ============================================

        let currentDiagnosisResults = null;

        function renderPlantDoctor() {
            const container = document.getElementById('testsContainer');
            const zones = FieldZoneManager.getZones();
            const crops = Object.entries(CROP_NUTRITION).filter(([k]) => k !== 'none');

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">ðŸ©º</span> Plant Doctor
                    </h3>
                    <p style="color: #64748b; font-size: 0.875rem;">
                        Diagnose nutrient deficiencies, get quick-fix recommendations, and generate side-dressing schedules.
                        The system learns from your applications and crop outcomes.
                    </p>
                </div>

                <!-- Two Column Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

                    <!-- Left Column: Diagnosis -->
                    <div>
                        <!-- Visual Symptom Checker -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <h4 style="color: #7c3aed; margin-bottom: 1rem;">Visual Symptom Checker</h4>
                            <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                                Select the symptoms you're observing. Check all that apply.
                            </p>

                            <div id="symptomChecklist" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="yellowing older leaves">
                                    <span style="font-size: 0.875rem;">Yellowing older leaves</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="yellowing new leaves">
                                    <span style="font-size: 0.875rem;">Yellowing new leaves</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="interveinal chlorosis">
                                    <span style="font-size: 0.875rem;">Yellow between veins</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="purple leaves stems">
                                    <span style="font-size: 0.875rem;">Purple leaves/stems</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="brown leaf edges">
                                    <span style="font-size: 0.875rem;">Brown leaf edges</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="blossom end rot">
                                    <span style="font-size: 0.875rem;">Blossom end rot</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="stunted growth">
                                    <span style="font-size: 0.875rem;">Stunted growth</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="distorted new growth">
                                    <span style="font-size: 0.875rem;">Distorted new growth</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="hollow stem">
                                    <span style="font-size: 0.875rem;">Hollow stems</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0;">
                                    <input type="checkbox" class="symptom-check" value="pale overall">
                                    <span style="font-size: 0.875rem;">Pale overall color</span>
                                </label>
                            </div>

                            <button onclick="diagnoseFromSymptoms()" class="btn btn-success" style="width: 100%; padding: 0.75rem;">
                                Diagnose Deficiency
                            </button>
                        </div>

                        <!-- Photo Analysis -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem;">
                            <h4 style="color: #7c3aed; margin-bottom: 1rem;">Photo Analysis (AI-Assisted)</h4>
                            <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                                Upload a photo of affected plant tissue for AI-assisted diagnosis.
                            </p>

                            <div id="photoUploadZone" style="border: 2px dashed #cbd5e1; border-radius: 0.75rem; padding: 2rem; text-align: center; cursor: pointer; margin-bottom: 1rem;"
                                onclick="document.getElementById('plantPhotoInput').click()">
                                <input type="file" id="plantPhotoInput" accept="image/*" style="display: none;" onchange="handlePlantPhoto(event)">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ“¸</div>
                                <p style="color: #64748b;">Click or drag photo here</p>
                                <p style="color: #94a3b8; font-size: 0.75rem;">Best: close-up of affected leaves</p>
                            </div>

                            <div id="photoPreview" style="display: none; margin-bottom: 1rem;"></div>

                            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem; border-radius: 0.25rem; font-size: 0.8rem;">
                                <strong>Note:</strong> AI analysis provides suggestions based on visual patterns.
                                Always confirm with soil tests and field observations. The system learns from your corrections.
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Results & Actions -->
                    <div>
                        <!-- Diagnosis Results -->
                        <div id="diagnosisResults" style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <h4 style="color: #7c3aed; margin-bottom: 1rem;">Diagnosis Results</h4>
                            <div style="text-align: center; padding: 2rem; color: #64748b;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ”¬</div>
                                <p>Select symptoms or upload a photo to get diagnosis</p>
                            </div>
                        </div>

                        <!-- Side-Dressing Task Generator -->
                        <div style="background: white; border-radius: 1rem; padding: 1.5rem;">
                            <h4 style="color: #7c3aed; margin-bottom: 1rem;">Side-Dressing Schedule Generator</h4>
                            <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                                Generate feeding schedule tasks for heavy-feeding crops based on planting date.
                            </p>

                            <div style="display: grid; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label>Crop</label>
                                    <select id="sideDressCrop" onchange="updateSideDressPreview()" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">Select a heavy feeder...</option>
                                        ${Object.keys(SIDE_DRESSING_SCHEDULES).map(key => `
                                            <option value="${key}">${CROP_NUTRITION[key]?.name || key}</option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Transplant/Plant Date</label>
                                    <input type="date" id="sideDressPlantDate" onchange="updateSideDressPreview()"
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>

                                <div class="form-group">
                                    <label>Field Zone</label>
                                    <select id="sideDressZone" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">Select zone (optional)</option>
                                        ${zones.map(z => `<option value="${z.id}">${z.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <div id="sideDressPreview" style="margin-bottom: 1rem;"></div>

                            <button onclick="createSideDressTasks()" class="btn btn-success" style="width: 100%; padding: 0.75rem;">
                                Generate Feeding Tasks
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Reference: Amendment Speed Guide -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Amendment Release Speed Reference</h4>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                        Choose the right amendment based on how quickly you need results. Slow-release amendments will show in future soil tests!
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                        ${Object.entries(RELEASE_SPEEDS).map(([key, data]) => `
                            <div style="padding: 0.75rem; border-radius: 0.5rem; border: 2px solid ${data.color}20; background: ${data.color}10;">
                                <div style="font-weight: 600; color: ${data.color}; margin-bottom: 0.25rem;">${data.label}</div>
                                <div style="font-size: 0.75rem; color: #64748b;">
                                    ${key === 'immediate' ? 'Epsom salt, Sodium nitrate, Liquid kelp' :
                                      key === 'fast' ? 'Blood meal, Potassium sulfate, Iron sulfate' :
                                      key === 'medium_fast' ? 'Fish meal' :
                                      key === 'medium' ? 'Soybean meal, Bone meal, Gypsum, K-Mag' :
                                      key === 'slow' ? 'Feather meal, Soft rock phosphate, Elemental S' :
                                      'Ag lime, Greensand, Hard rock phosphate'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function diagnoseFromSymptoms() {
            const checkedSymptoms = Array.from(document.querySelectorAll('.symptom-check:checked'))
                .map(cb => cb.value);

            if (checkedSymptoms.length === 0) {
                showToast('Please select at least one symptom', 'error');
                return;
            }

            const results = analyzeSymptoms(checkedSymptoms);
            currentDiagnosisResults = results;
            renderDiagnosisResults(results, checkedSymptoms);
        }

        function renderDiagnosisResults(results, symptoms) {
            const container = document.getElementById('diagnosisResults');

            if (results.length === 0) {
                container.innerHTML = `
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Diagnosis Results</h4>
                    <div style="background: #fef2f2; padding: 1rem; border-radius: 0.5rem; color: #dc2626;">
                        No deficiency pattern matched. Try selecting different symptoms or consult a soil test.
                    </div>
                `;
                return;
            }

            const topResult = results[0];
            const defData = topResult.data;

            container.innerHTML = `
                <h4 style="color: #7c3aed; margin-bottom: 1rem;">Diagnosis Results</h4>

                <!-- Primary Diagnosis -->
                <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="font-size: 1.1rem; color: #10b981;">Most Likely: ${defData.nutrient}</strong>
                        <span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                            ${Math.round(topResult.score * 10)}% match
                        </span>
                    </div>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.75rem;">
                        ${defData.mobility === 'mobile' ?
                            'Mobile nutrient - affects older leaves first (nutrient moves to new growth)' :
                            'Immobile nutrient - affects new growth first (nutrient stays where deposited)'}
                    </p>

                    <!-- Symptoms -->
                    <div style="margin-bottom: 1rem;">
                        <strong style="font-size: 0.875rem;">Classic Symptoms:</strong>
                        <ul style="margin: 0.5rem 0 0 1.25rem; font-size: 0.875rem; color: #64748b;">
                            ${defData.symptoms.slice(0, 4).map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>

                    <!-- Quick Fix -->
                    <div style="background: white; border-radius: 0.375rem; padding: 0.75rem;">
                        <strong style="color: #10b981;">Quick Fix Options:</strong>
                        <div style="margin-top: 0.5rem;">
                            ${defData.quickFix.map(fix => {
                                const bio = AMENDMENT_BIOAVAILABILITY[fix.amendment] || {};
                                const speedColor = RELEASE_SPEEDS[bio.releaseSpeed]?.color || '#64748b';
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                                        <span><strong>${fix.amendment}</strong> - ${fix.rate}</span>
                                        <span style="color: ${speedColor}; font-size: 0.75rem;">
                                            ${RELEASE_SPEEDS[bio.releaseSpeed]?.label || 'Unknown speed'}
                                        </span>
                                    </div>
                                    ${fix.warning ? `<div style="color: #f59e0b; font-size: 0.75rem; padding-left: 0.5rem;">âš ï¸ ${fix.warning}</div>` : ''}
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Foliar Option -->
                    ${defData.foliarOption ? `
                        <div style="background: #dbeafe; border-radius: 0.375rem; padding: 0.75rem; margin-top: 0.75rem;">
                            <strong style="color: #3b82f6;">Foliar Spray Option (Fastest):</strong>
                            <div style="font-size: 0.875rem; margin-top: 0.25rem;">
                                ${defData.foliarOption.product} @ ${defData.foliarOption.rate} - ${defData.foliarOption.frequency}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- Other Possibilities -->
                ${results.length > 1 ? `
                    <div style="margin-bottom: 1rem;">
                        <strong style="font-size: 0.875rem; color: #64748b;">Also Consider:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                            ${results.slice(1, 4).map(r => `
                                <span style="background: #f1f5f9; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem;">
                                    ${r.data.nutrient} (${Math.round(r.score * 10)}%)
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Don't Confuse With -->
                ${defData.confusedWith ? `
                    <div style="background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem;">
                        <strong style="color: #92400e;">Don't confuse with:</strong>
                        ${defData.confusedWith.join(', ')}
                    </div>
                ` : ''}

                <!-- Action Buttons -->
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button onclick="recordDiagnosis('${topResult.nutrient}')" class="btn btn-success" style="flex: 1; padding: 0.5rem;">
                        Record This Diagnosis
                    </button>
                    <button onclick="showQuickFixDetails('${topResult.nutrient}')" class="btn btn-secondary" style="flex: 1; padding: 0.5rem; color: #64748b;">
                        View Full Protocol
                    </button>
                </div>
            `;
        }

        function handlePlantPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('photoPreview').innerHTML = `
                    <img src="${e.target.result}" style="max-width: 100%; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="text-align: center;">
                        <button onclick="analyzePhoto()" class="btn btn-success" style="padding: 0.5rem 1rem;">
                            Analyze Photo
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function analyzePhoto() {
            // In a real implementation, this would send to an AI API
            // For now, we'll show a helpful message and suggest manual symptom selection
            const container = document.getElementById('diagnosisResults');
            container.innerHTML = `
                <h4 style="color: #7c3aed; margin-bottom: 1rem;">Photo Analysis</h4>
                <div style="background: #dbeafe; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <strong style="color: #3b82f6;">AI Analysis Tips:</strong>
                    <ul style="margin: 0.5rem 0 0 1.25rem; font-size: 0.875rem; color: #64748b;">
                        <li>Look at which leaves are affected (old vs new)</li>
                        <li>Check if yellowing is between veins or whole leaf</li>
                        <li>Note any purple/red coloring on stems or undersides</li>
                        <li>Look for brown edges, spots, or tip burn</li>
                    </ul>
                </div>
                <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                    For best results, use the symptom checklist to describe what you see.
                    The system will learn from your diagnoses and outcomes over time.
                </p>
                <div style="background: #f5f3ff; padding: 1rem; border-radius: 0.5rem;">
                    <strong style="color: #7c3aed;">Future Enhancement:</strong>
                    <p style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">
                        Full AI image analysis coming soon! The system will recognize visual patterns
                        and correlate them with your historical diagnoses and outcomes.
                    </p>
                </div>
            `;
        }

        function recordDiagnosis(nutrient) {
            const observation = {
                type: 'deficiency_diagnosis',
                nutrient: nutrient,
                date: new Date().toISOString(),
                symptoms: Array.from(document.querySelectorAll('.symptom-check:checked')).map(cb => cb.value),
                fieldZone: document.getElementById('sideDressZone')?.value || null,
                status: 'diagnosed'
            };

            FarmLearning.recordObservation(observation);
            showToast(`${nutrient} deficiency diagnosis recorded. Update outcome after treatment!`, 'success');
        }

        function showQuickFixDetails(nutrient) {
            const data = DEFICIENCY_SYMPTOMS[nutrient];
            if (!data) return;

            alert(`Full ${data.nutrient} Protocol:\n\n` +
                `SYMPTOMS:\n${data.symptoms.join('\n')}\n\n` +
                `COMMONLY SEEN IN: ${data.commonIn.join(', ')}\n\n` +
                `QUICK FIX OPTIONS:\n${data.quickFix.map(f => `- ${f.amendment}: ${f.rate}`).join('\n')}\n\n` +
                `FOLIAR: ${data.foliarOption ? `${data.foliarOption.product} @ ${data.foliarOption.rate}` : 'N/A'}`);
        }

        function updateSideDressPreview() {
            const cropKey = document.getElementById('sideDressCrop').value;
            const plantDate = document.getElementById('sideDressPlantDate').value;
            const preview = document.getElementById('sideDressPreview');

            if (!cropKey || !plantDate) {
                preview.innerHTML = '';
                return;
            }

            const schedule = SIDE_DRESSING_SCHEDULES[cropKey];
            if (!schedule) {
                preview.innerHTML = '<p style="color: #64748b; font-size: 0.875rem;">No side-dressing schedule for this crop.</p>';
                return;
            }

            const tasks = generateSideDressingTasks(cropKey, plantDate, '');

            preview.innerHTML = `
                <div style="background: #f0fdf4; border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.5rem;">
                    <strong style="color: #10b981; font-size: 0.875rem;">Schedule Preview:</strong>
                    <div style="margin-top: 0.5rem;">
                        ${tasks.map(t => `
                            <div style="display: flex; justify-content: space-between; padding: 0.375rem 0; border-bottom: 1px solid #bbf7d0; font-size: 0.8rem;">
                                <span>${t.feedingName}</span>
                                <span style="color: #64748b;">${formatDate(t.dueDate)}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${schedule.watchFor ? `
                        <div style="margin-top: 0.75rem; padding: 0.5rem; background: #fef3c7; border-radius: 0.25rem; font-size: 0.75rem;">
                            <strong>Watch for:</strong> ${schedule.watchFor}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function createSideDressTasks() {
            const cropKey = document.getElementById('sideDressCrop').value;
            const plantDate = document.getElementById('sideDressPlantDate').value;
            const zoneId = document.getElementById('sideDressZone').value;

            if (!cropKey || !plantDate) {
                showToast('Please select a crop and planting date', 'error');
                return;
            }

            const tasks = generateSideDressingTasks(cropKey, plantDate, zoneId);

            if (tasks.length === 0) {
                showToast('No side-dressing schedule available for this crop', 'error');
                return;
            }

            // Store tasks for later integration with task system
            let sideDressTasks = JSON.parse(localStorage.getItem('sideDressTasks') || '[]');
            sideDressTasks = sideDressTasks.concat(tasks);
            localStorage.setItem('sideDressTasks', JSON.stringify(sideDressTasks));

            // Also record in FarmLearning
            const planting = {
                crop: cropKey,
                cropName: CROP_NUTRITION[cropKey]?.name || cropKey,
                fieldZone: zoneId,
                plantingDate: plantDate,
                sideDressScheduleGenerated: true,
                year: new Date(plantDate).getFullYear()
            };
            FarmLearning.recordCropPlanting(planting);

            showToast(`Created ${tasks.length} side-dressing tasks for ${CROP_NUTRITION[cropKey]?.name}!`, 'success');
            updateSideDressPreview();
        }

        // Utilities
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ============================================
        // FERTIGATION SYSTEM
        // Based on University Extension Research
        // Sources: UF/IFAS, Penn State, Missouri Extension, eOrganic
        // ============================================

        // OMRI-Approved Liquid Fertilizers for Fertigation
        const FERTIGATION_PRODUCTS = {
            // Fish-Based Products
            fishEmulsion: {
                name: 'Fish Emulsion (5-1-1)',
                npk: { N: 5, P: 1, K: 1 },
                category: 'fish',
                omriListed: true,
                ratePerGalWater: '2-3 tbsp',
                ratePerAcre: '2-4 gal',
                frequency: 'Every 1-2 weeks',
                costPerGal: 25,
                source: 'Illinois Extension',
                notes: 'Fast-acting N source. Feeds soil microbes. May attract animals.',
                bestFor: ['leafy greens', 'transplant establishment', 'general fertility'],
                applicationMethod: ['drip', 'foliar', 'drench']
            },
            fishHydrolysate: {
                name: 'Fish Hydrolysate (2-4-1)',
                npk: { N: 2, P: 4, K: 1 },
                category: 'fish',
                omriListed: true,
                ratePerGalWater: '1-2 tbsp',
                ratePerAcre: '1-2 gal',
                frequency: 'Every 1-2 weeks',
                costPerGal: 35,
                source: 'eOrganic',
                notes: 'Cold-processed, retains amino acids and oils. Superior to emulsion.',
                bestFor: ['fruiting crops', 'root development', 'soil biology'],
                applicationMethod: ['drip', 'foliar', 'drench']
            },
            neptunesHarvest: {
                name: 'Neptune\'s Harvest Fish & Seaweed (2-3-1)',
                npk: { N: 2, P: 3, K: 1 },
                category: 'fish',
                omriListed: true,
                ratePerGalWater: '1 tbsp',
                ratePerAcre: '1-2 gal',
                frequency: 'Every 2 weeks',
                costPerGal: 40,
                source: 'Commercial',
                notes: 'Fish hydrolysate + kelp combo. Excellent all-purpose.',
                bestFor: ['all crops', 'stress recovery', 'transplant drench'],
                applicationMethod: ['drip', 'foliar', 'drench']
            },
            // Kelp/Seaweed Products
            liquidKelpConcentrate: {
                name: 'Liquid Kelp Extract (0-0-1)',
                npk: { N: 0, P: 0, K: 1 },
                category: 'kelp',
                omriListed: true,
                ratePerGalWater: '1-2 tsp',
                ratePerAcre: '1-2 qt',
                frequency: 'Every 2-4 weeks',
                costPerGal: 45,
                source: 'WSU Extension',
                notes: 'Cytokinins, auxins, trace minerals. Stress resistance booster.',
                bestFor: ['stress recovery', 'root development', 'fruit set'],
                applicationMethod: ['drip', 'foliar', 'drench']
            },
            maxicrop: {
                name: 'Maxicrop Liquid Seaweed (0-0-1)',
                npk: { N: 0, P: 0, K: 1 },
                category: 'kelp',
                omriListed: true,
                ratePerGalWater: '1 tbsp',
                ratePerAcre: '1 qt',
                frequency: 'Every 2 weeks',
                costPerGal: 30,
                source: 'Commercial',
                notes: 'Ascophyllum nodosum extract. Growth hormones and trace minerals.',
                bestFor: ['transplant drench', 'foliar spray', 'seed soak'],
                applicationMethod: ['drip', 'foliar', 'drench']
            },
            // High-N Products
            agroThrive: {
                name: 'AgroThrive LF (3-3-2)',
                npk: { N: 3, P: 3, K: 2 },
                category: 'complete',
                omriListed: true,
                ratePerGalWater: '2-4 oz',
                ratePerAcre: '2-4 gal',
                frequency: 'Weekly during active growth',
                costPerGal: 28,
                source: 'Commercial - OMRI',
                notes: 'Digested fish/plants. Clean for drip. Well-filtered.',
                bestFor: ['greenhouse crops', 'fruiting vegetables', 'heavy feeders'],
                applicationMethod: ['drip', 'foliar']
            },
            phytaminFish: {
                name: 'Phytamin Fish Plus (4.5-4-1)',
                npk: { N: 4.5, P: 4, K: 1 },
                category: 'fish',
                omriListed: true,
                ratePerGalWater: '1-2 oz',
                ratePerAcre: '2-3 gal',
                frequency: 'Every 1-2 weeks',
                costPerGal: 32,
                source: 'eOrganic Product List',
                notes: 'Higher N than standard fish. Good for heavy feeders.',
                bestFor: ['tomatoes', 'peppers', 'corn', 'brassicas'],
                applicationMethod: ['drip', 'foliar']
            },
            // Compost Tea
            compostTea: {
                name: 'Aerated Compost Tea (AACT)',
                npk: { N: 0.5, P: 0.3, K: 0.5 },
                category: 'biological',
                omriListed: true,
                ratePerGalWater: 'Full strength or 1:4 dilution',
                ratePerAcre: '20-50 gal',
                frequency: 'Every 2-4 weeks',
                costPerGal: 5,
                source: 'UVM Extension, SARE Research',
                notes: 'Must be used within 4-6 hours of brewing. Biological inoculant.',
                bestFor: ['soil biology', 'disease suppression', 'nutrient cycling'],
                applicationMethod: ['drip', 'foliar', 'drench'],
                brewingTime: '24-48 hours',
                recipeNote: 'See Compost Tea Recipes section'
            },
            // Specialty Products
            proteinHydrolysate: {
                name: 'Plant-Based Protein Hydrolysate',
                npk: { N: 10, P: 0, K: 0 },
                category: 'specialty',
                omriListed: true,
                ratePerGalWater: '0.5-1 oz',
                ratePerAcre: '1-2 gal',
                frequency: 'As needed for N boost',
                costPerGal: 55,
                source: 'Research trials',
                notes: 'Fast N for deficiency correction. Low salt index.',
                bestFor: ['N deficiency correction', 'heavy feeders', 'rapid growth'],
                applicationMethod: ['drip', 'foliar']
            },
            calciumChloride: {
                name: 'Calcium Chloride Solution',
                npk: { N: 0, P: 0, K: 0, Ca: 36 },
                category: 'calcium',
                omriListed: true,
                ratePerGalWater: '2-4 tbsp',
                ratePerAcre: '5-8 lb',
                frequency: 'Weekly during fruit set',
                costPerGal: 15,
                source: 'Penn State Extension',
                notes: 'Fast calcium for BER prevention. Apply to small fruits.',
                bestFor: ['tomatoes', 'peppers', 'squash', 'melons'],
                applicationMethod: ['foliar']
            }
        };

        // Greenhouse Fertigation Schedules by Crop
        // Source: UF/IFAS HS1392, Missouri Extension G6462
        const FERTIGATION_SCHEDULES = {
            tomato: {
                name: 'Greenhouse Tomato',
                totalSeasonN: 200, // lb/acre
                totalSeasonK: 200,
                schedule: [
                    { stage: 'Transplant Week', weeksFromTransplant: 0, nRate: 1.5, kRate: 1.5, notes: 'Drench with fish + kelp at transplant' },
                    { stage: 'Establishment', weeksFromTransplant: 1, nRate: 1.5, kRate: 1.5, notes: 'Light fertigation, focus on roots' },
                    { stage: 'Early Vegetative', weeksFromTransplant: 2, nRate: 2.0, kRate: 2.0, notes: 'Increase N for leaf growth' },
                    { stage: 'Vegetative Growth', weeksFromTransplant: 3, nRate: 2.0, kRate: 2.0, notes: 'Building plant structure' },
                    { stage: 'Pre-Bloom', weeksFromTransplant: 4, nRate: 2.5, kRate: 2.5, notes: 'Add Ca foliar spray' },
                    { stage: 'First Bloom', weeksFromTransplant: 5, nRate: 2.5, kRate: 2.5, notes: 'Critical Ca period - BER prevention' },
                    { stage: 'Fruit Set', weeksFromTransplant: 6, nRate: 2.5, kRate: 2.5, notes: 'Maintain consistent irrigation' },
                    { stage: 'Fruit Development 1', weeksFromTransplant: 7, nRate: 2.5, kRate: 2.5, notes: 'Heavy K demand begins' },
                    { stage: 'Fruit Development 2', weeksFromTransplant: 8, nRate: 2.5, kRate: 2.5, notes: 'Continue Ca foliar weekly' },
                    { stage: 'First Harvest', weeksFromTransplant: 9, nRate: 2.5, kRate: 2.5, notes: 'Maintain fertility through harvest' },
                    { stage: 'Peak Production', weeksFromTransplant: 10, nRate: 2.5, kRate: 2.5, notes: 'Consistent fertigation critical' },
                    { stage: 'Extended Harvest', weeksFromTransplant: 11, nRate: 2.5, kRate: 2.5, notes: 'Monitor tissue tests' },
                    { stage: 'Late Season', weeksFromTransplant: 12, nRate: 2.0, kRate: 2.0, notes: 'Reduce slightly as season ends' },
                    { stage: 'Wind Down', weeksFromTransplant: 13, nRate: 1.5, kRate: 1.5, notes: 'Taper off fertigation' }
                ],
                products: ['agroThrive', 'fishHydrolysate', 'calciumChloride', 'liquidKelpConcentrate'],
                foliarSchedule: [
                    { timing: 'Weekly from first bloom', product: 'Calcium chloride', rate: '2 tbsp/gal', purpose: 'BER prevention' },
                    { timing: 'Bi-weekly', product: 'Fish + Kelp', rate: '1 tbsp each/gal', purpose: 'Micronutrients + hormones' }
                ],
                notes: 'Source: UF/IFAS HS1392, Missouri Extension G6462. Rates in lb N/acre/day.'
            },
            cucumber: {
                name: 'Greenhouse Cucumber',
                totalSeasonN: 150,
                totalSeasonK: 175,
                schedule: [
                    { stage: 'Transplant', weeksFromTransplant: 0, nRate: 1.0, kRate: 1.0, notes: 'Light starter solution' },
                    { stage: 'Establishment', weeksFromTransplant: 1, nRate: 1.5, kRate: 1.5, notes: 'Root development focus' },
                    { stage: 'Vegetative', weeksFromTransplant: 2, nRate: 2.0, kRate: 2.0, notes: 'Rapid vine growth' },
                    { stage: 'Pre-Flower', weeksFromTransplant: 3, nRate: 2.5, kRate: 2.5, notes: 'Heavy feeding begins' },
                    { stage: 'Flowering', weeksFromTransplant: 4, nRate: 2.5, kRate: 3.0, notes: 'Increase K for fruit' },
                    { stage: 'Fruit Set', weeksFromTransplant: 5, nRate: 2.5, kRate: 3.0, notes: 'Peak nutrient demand' },
                    { stage: 'Harvest 1', weeksFromTransplant: 6, nRate: 2.5, kRate: 3.0, notes: 'Daily harvest begins' },
                    { stage: 'Peak Harvest', weeksFromTransplant: 7, nRate: 2.5, kRate: 3.0, notes: 'Maintain high K' },
                    { stage: 'Extended', weeksFromTransplant: 8, nRate: 2.0, kRate: 2.5, notes: 'Taper as plants age' }
                ],
                products: ['agroThrive', 'fishEmulsion', 'liquidKelpConcentrate'],
                foliarSchedule: [
                    { timing: 'Weekly during production', product: 'Kelp extract', rate: '1 tsp/gal', purpose: 'Stress tolerance' }
                ],
                notes: 'Cucumbers have shorter season than tomatoes. Higher K:N ratio for fruit quality.'
            },
            pepper: {
                name: 'Greenhouse Pepper',
                totalSeasonN: 180,
                totalSeasonK: 200,
                schedule: [
                    { stage: 'Transplant', weeksFromTransplant: 0, nRate: 1.0, kRate: 1.0, notes: 'Gentle start - peppers sensitive' },
                    { stage: 'Establishment', weeksFromTransplant: 1, nRate: 1.5, kRate: 1.5, notes: 'Slow growth initially' },
                    { stage: 'Early Veg', weeksFromTransplant: 2, nRate: 1.5, kRate: 1.5, notes: 'Patience - peppers grow slowly' },
                    { stage: 'Vegetative', weeksFromTransplant: 3, nRate: 2.0, kRate: 2.0, notes: 'Building plant structure' },
                    { stage: 'Pre-Bloom', weeksFromTransplant: 4, nRate: 2.0, kRate: 2.0, notes: 'Ca foliar starts now' },
                    { stage: 'First Bloom', weeksFromTransplant: 5, nRate: 2.5, kRate: 2.5, notes: 'Critical Ca period' },
                    { stage: 'Fruit Set', weeksFromTransplant: 6, nRate: 2.5, kRate: 2.5, notes: 'BER risk high' },
                    { stage: 'Fruit Development', weeksFromTransplant: 7, nRate: 2.5, kRate: 2.5, notes: 'Weekly Ca foliar' },
                    { stage: 'Color Break', weeksFromTransplant: 8, nRate: 2.5, kRate: 3.0, notes: 'K for color development' },
                    { stage: 'Harvest', weeksFromTransplant: 9, nRate: 2.5, kRate: 3.0, notes: 'Maintain through harvest' },
                    { stage: 'Extended', weeksFromTransplant: 10, nRate: 2.0, kRate: 2.5, notes: 'Continue as long as productive' }
                ],
                products: ['agroThrive', 'fishHydrolysate', 'calciumChloride', 'liquidKelpConcentrate'],
                foliarSchedule: [
                    { timing: 'Weekly from first bloom', product: 'Calcium chloride', rate: '2 tbsp/gal', purpose: 'BER prevention' },
                    { timing: 'Bi-weekly', product: 'Epsom salt', rate: '1 tbsp/gal', purpose: 'Mg for photosynthesis' }
                ],
                notes: 'Similar to tomato but slower start. Very BER susceptible.'
            },
            leafyGreens: {
                name: 'Leafy Greens (Lettuce, Spinach, Kale)',
                totalSeasonN: 100,
                totalSeasonK: 80,
                schedule: [
                    { stage: 'Seeding/Transplant', weeksFromTransplant: 0, nRate: 1.0, kRate: 0.5, notes: 'Light N to start' },
                    { stage: 'Establishment', weeksFromTransplant: 1, nRate: 1.5, kRate: 1.0, notes: 'Fish emulsion excellent here' },
                    { stage: 'Rapid Growth', weeksFromTransplant: 2, nRate: 2.0, kRate: 1.5, notes: 'Peak N demand' },
                    { stage: 'Pre-Harvest', weeksFromTransplant: 3, nRate: 2.0, kRate: 1.5, notes: 'Maintain consistent N' },
                    { stage: 'Harvest Window', weeksFromTransplant: 4, nRate: 1.5, kRate: 1.0, notes: 'Reduce slightly before harvest' }
                ],
                products: ['fishEmulsion', 'compostTea', 'liquidKelpConcentrate'],
                foliarSchedule: [
                    { timing: 'Weekly', product: 'Dilute fish emulsion', rate: '1 tbsp/gal', purpose: 'Quick N boost' }
                ],
                notes: 'Short season crops. N drives growth. Avoid excess N near harvest (nitrate accumulation).'
            }
        };

        // Compost Tea Recipes - Source: Arizona Extension, UVM, SARE
        const COMPOST_TEA_RECIPES = {
            basicAACT: {
                name: 'Basic Aerated Compost Tea',
                purpose: 'General soil biology inoculant',
                ingredients: [
                    { item: 'Finished compost', amount: '2-3 lbs', notes: 'Well-aged, earthy smell' },
                    { item: 'Non-chlorinated water', amount: '5 gallons', notes: 'Let tap water sit 24hr or use rainwater' },
                    { item: 'Unsulfured molasses', amount: '1-2 oz', notes: 'Feeds bacteria during brewing' }
                ],
                equipment: ['5-gal bucket', 'Aquarium air pump', 'Air stones', 'Mesh bag for compost'],
                brewTime: '24-36 hours',
                application: 'Use immediately. Drench soil at 1-2 gal/100 sqft or foliar at 1:4 dilution',
                source: 'Arizona Extension az1739'
            },
            fungalDominant: {
                name: 'Fungal-Dominant Tea',
                purpose: 'Perennials, woody plants, established beds',
                ingredients: [
                    { item: 'Forest floor compost or leaf mold', amount: '3 lbs', notes: 'High fungal content' },
                    { item: 'Non-chlorinated water', amount: '5 gallons', notes: '' },
                    { item: 'Kelp meal', amount: '1 oz', notes: 'Fungal food' },
                    { item: 'Humic acid', amount: '0.5 oz', notes: 'Supports fungal growth' },
                    { item: 'Oat flour', amount: '1 oz', notes: 'Fungal food source' }
                ],
                equipment: ['5-gal bucket', 'Aquarium air pump', 'Air stones', 'Mesh bag'],
                brewTime: '36-48 hours',
                application: 'Soil drench only. Best in morning. Use within 4 hours.',
                source: 'Soil Food Web approach'
            },
            bacterialDominant: {
                name: 'Bacterial-Dominant Tea',
                purpose: 'Annual vegetables, transplant drench',
                ingredients: [
                    { item: 'Thermophilic compost', amount: '2 lbs', notes: 'Hot compost, high bacteria' },
                    { item: 'Non-chlorinated water', amount: '5 gallons', notes: '' },
                    { item: 'Molasses', amount: '2 oz', notes: 'Feeds bacteria' },
                    { item: 'Fish hydrolysate', amount: '1 oz', notes: 'Bacterial food + nutrients' }
                ],
                equipment: ['5-gal bucket', 'Aquarium air pump', 'Air stones', 'Mesh bag'],
                brewTime: '18-24 hours',
                application: 'Soil drench or foliar. Use within 4 hours of completion.',
                source: 'SARE research'
            }
        };

        // LocalStorage for fertigation
        let fertigationSchedules = JSON.parse(localStorage.getItem('fertigationSchedules') || '[]');
        let fertigationLogs = JSON.parse(localStorage.getItem('fertigationLogs') || '[]');

        function renderFertigationTab() {
            const container = document.getElementById('testsContainer');

            // Get active schedules
            const activeSchedules = fertigationSchedules.filter(s => s.status === 'active');
            const today = new Date();

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">Fertigation System</h3>
                            <p style="color: #64748b; font-size: 0.875rem;">
                                Drip-applied liquid fertilizers for greenhouse and high tunnel crops.
                                <br><span style="font-size: 0.75rem;">Sources: UF/IFAS, Penn State Extension, Missouri Extension, eOrganic</span>
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button onclick="showNewFertigationSchedule()" class="btn btn-success" style="padding: 0.75rem 1.5rem;">
                                + New Schedule
                            </button>
                            <button onclick="showQuickFertigation()" class="btn btn-primary" style="padding: 0.75rem 1.5rem; background: #06b6d4;">
                                Quick Application
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Schedules -->
                <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #065f46; margin-bottom: 1rem;">Active Fertigation Schedules (${activeSchedules.length})</h4>
                    ${activeSchedules.length === 0 ? `
                        <p style="color: #047857; font-style: italic;">No active fertigation schedules. Create one to track your greenhouse crops.</p>
                    ` : `
                        <div style="display: grid; gap: 1rem;">
                            ${activeSchedules.map(schedule => renderActiveFertigationSchedule(schedule, today)).join('')}
                        </div>
                    `}
                </div>

                <!-- OMRI Products Reference -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">OMRI-Listed Liquid Fertilizers for Fertigation</h4>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                        Products suitable for drip irrigation. Always flush lines after fertigation.
                    </p>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button onclick="filterFertigationProducts('all')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">All</button>
                        <button onclick="filterFertigationProducts('fish')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Fish-Based</button>
                        <button onclick="filterFertigationProducts('kelp')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Kelp/Seaweed</button>
                        <button onclick="filterFertigationProducts('complete')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Complete</button>
                        <button onclick="filterFertigationProducts('biological')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Biological</button>
                    </div>
                    <div id="fertigationProductsList" style="display: grid; gap: 0.75rem;">
                        ${renderFertigationProducts('all')}
                    </div>
                </div>

                <!-- Crop Schedules Reference -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Greenhouse Fertigation Schedules by Crop</h4>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                        Research-based schedules from UF/IFAS and Missouri Extension. Rates in lb N/acre/day.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                        ${Object.entries(FERTIGATION_SCHEDULES).map(([key, sched]) => `
                            <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; cursor: pointer;" onclick="showCropScheduleDetail('${key}')">
                                <h5 style="color: #1e293b; margin-bottom: 0.5rem;">${sched.name}</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem; color: #64748b;">
                                    <div>Season N: ${sched.totalSeasonN} lb/ac</div>
                                    <div>Season K: ${sched.totalSeasonK} lb/ac</div>
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #7c3aed;">
                                    ${sched.schedule.length} stages â€¢ Click for details
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Compost Tea Recipes -->
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #92400e; margin-bottom: 1rem;">Compost Tea Recipes</h4>
                    <p style="color: #78350f; font-size: 0.875rem; margin-bottom: 1rem;">
                        Actively Aerated Compost Tea (AACT) for biological fertigation. Use within 4-6 hours of brewing.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                        ${Object.entries(COMPOST_TEA_RECIPES).map(([key, recipe]) => `
                            <div style="background: white; border-radius: 0.5rem; padding: 1rem;">
                                <h5 style="color: #1e293b; margin-bottom: 0.5rem;">${recipe.name}</h5>
                                <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.5rem;">${recipe.purpose}</p>
                                <div style="font-size: 0.75rem; color: #78350f;">
                                    <strong>Brew time:</strong> ${recipe.brewTime}
                                </div>
                                <button onclick="showCompostTeaRecipe('${key}')" class="btn btn-secondary" style="margin-top: 0.5rem; padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                                    View Full Recipe
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Drip Calculator -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Fertigation Calculator</h4>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                        Calculate product amounts for your drip system. Based on Clemson Extension calculator methodology.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Product</label>
                            <select id="calcProduct" onchange="updateFertigationCalc()" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                ${Object.entries(FERTIGATION_PRODUCTS).map(([k, p]) => `<option value="${k}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Target N Rate (lb/acre)</label>
                            <input type="number" id="calcNRate" value="2.5" step="0.5" min="0.5" max="10" onchange="updateFertigationCalc()" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                        </div>
                        <div class="form-group">
                            <label>Area (sq ft)</label>
                            <input type="number" id="calcArea" value="1000" step="100" onchange="updateFertigationCalc()" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                        </div>
                    </div>
                    <div id="fertigationCalcResults" style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem;">
                        ${calculateFertigationAmount()}
                    </div>
                </div>

                <!-- Recent Applications -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Recent Fertigation Applications</h4>
                    ${fertigationLogs.length === 0 ? `
                        <p style="color: #64748b; font-style: italic;">No fertigation applications recorded yet.</p>
                    ` : `
                        <div style="display: grid; gap: 0.5rem;">
                            ${fertigationLogs.slice(-10).reverse().map(log => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 0.375rem;">
                                    <div>
                                        <span style="font-weight: 500;">${FERTIGATION_PRODUCTS[log.product]?.name || log.product}</span>
                                        <span style="color: #64748b; font-size: 0.875rem;"> - ${log.field || 'Greenhouse'}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="color: #10b981; font-size: 0.875rem;">${log.amount}</span>
                                        <div style="color: #64748b; font-size: 0.75rem;">${formatDate(log.date)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>

                <!-- Modal container -->
                <div id="fertigationModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 1rem;"></div>
            `;
        }

        function renderActiveFertigationSchedule(schedule, today) {
            const crop = FERTIGATION_SCHEDULES[schedule.cropKey];
            const transplantDate = new Date(schedule.transplantDate);
            const weeksElapsed = Math.floor((today - transplantDate) / (7 * 24 * 60 * 60 * 1000));
            const currentStage = crop?.schedule.find(s => s.weeksFromTransplant === weeksElapsed) ||
                                 crop?.schedule[crop.schedule.length - 1];

            return `
                <div style="background: white; border-radius: 0.5rem; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <strong style="color: #1e293b;">${schedule.name || crop?.name}</strong>
                            <div style="font-size: 0.875rem; color: #64748b;">
                                ${schedule.field || 'Greenhouse'} | Transplanted: ${formatDate(schedule.transplantDate)}
                            </div>
                            <div style="font-size: 0.875rem; color: #059669; margin-top: 0.25rem;">
                                Week ${weeksElapsed}: ${currentStage?.stage || 'Complete'}
                            </div>
                            ${currentStage ? `
                                <div style="font-size: 0.75rem; color: #7c3aed; margin-top: 0.25rem;">
                                    Current rates: N ${currentStage.nRate} lb/ac/day, K ${currentStage.kRate} lb/ac/day
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="logFertigationApplication('${schedule.id}')" class="btn btn-success" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                                Log Application
                            </button>
                            <button onclick="viewFertigationSchedule('${schedule.id}')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                                View Schedule
                            </button>
                        </div>
                    </div>
                    ${currentStage?.notes ? `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 0.25rem; font-size: 0.75rem; color: #92400e;">
                            ${currentStage.notes}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderFertigationProducts(filter) {
            const products = Object.entries(FERTIGATION_PRODUCTS).filter(([key, p]) =>
                filter === 'all' || p.category === filter
            );

            return products.map(([key, product]) => `
                <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <strong style="color: #1e293b;">${product.name}</strong>
                            ${product.omriListed ? '<span style="background: #f0fdf4; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem;">OMRI</span>' : ''}
                        </div>
                        <span style="color: #64748b; font-size: 0.875rem;">~$${product.costPerGal}/gal</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-wrap: wrap;">
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem;">
                            N: ${product.npk.N}%
                        </span>
                        <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem;">
                            P: ${product.npk.P}%
                        </span>
                        <span style="background: #f3e8ff; color: #7c3aed; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem;">
                            K: ${product.npk.K}%
                        </span>
                    </div>
                    <p style="color: #64748b; font-size: 0.875rem; margin: 0.5rem 0;">${product.notes}</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.75rem; color: #475569;">
                        <div><strong>Rate:</strong> ${product.ratePerGalWater}/gal water</div>
                        <div><strong>Frequency:</strong> ${product.frequency}</div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.7rem; color: #64748b;">
                        <strong>Best for:</strong> ${product.bestFor.join(', ')}
                    </div>
                    <div style="margin-top: 0.25rem; font-size: 0.7rem; color: #94a3b8;">
                        Source: ${product.source}
                    </div>
                </div>
            `).join('');
        }

        function filterFertigationProducts(category) {
            document.getElementById('fertigationProductsList').innerHTML = renderFertigationProducts(category);
        }

        function calculateFertigationAmount() {
            const productKey = document.getElementById('calcProduct')?.value || 'fishEmulsion';
            const nRate = parseFloat(document.getElementById('calcNRate')?.value) || 2.5;
            const area = parseFloat(document.getElementById('calcArea')?.value) || 1000;

            const product = FERTIGATION_PRODUCTS[productKey];
            if (!product) return '<p>Select a product</p>';

            const acreage = area / 43560;
            const nNeeded = nRate * acreage; // lb N needed
            const productN = product.npk.N / 100; // N as decimal

            // Liquid products: assume 10 lb/gallon weight
            const gallonsNeeded = productN > 0 ? nNeeded / (10 * productN) : 0;
            const ozNeeded = gallonsNeeded * 128;

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="font-size: 0.75rem; color: #64748b;">Product</div>
                        <div style="font-weight: 600; color: #1e293b;">${product.name}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #64748b;">Area</div>
                        <div style="font-weight: 600; color: #1e293b;">${area.toLocaleString()} sq ft</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #64748b;">N Rate Target</div>
                        <div style="font-weight: 600; color: #1e293b;">${nRate} lb/acre/day</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #64748b;">Amount Needed</div>
                        <div style="font-weight: 600; color: #10b981;">${ozNeeded < 32 ? ozNeeded.toFixed(1) + ' oz' : (gallonsNeeded).toFixed(2) + ' gal'}</div>
                    </div>
                </div>
                <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #64748b;">
                    <strong>Application tip:</strong> ${product.ratePerGalWater} per gallon of water. Flush drip lines for 20+ minutes after fertigation.
                </div>
            `;
        }

        function updateFertigationCalc() {
            document.getElementById('fertigationCalcResults').innerHTML = calculateFertigationAmount();
        }

        function showNewFertigationSchedule() {
            const modal = document.getElementById('fertigationModal');
            const fieldOptions = Object.keys(FARM_FIELDS).map(f =>
                `<option value="${f}">${f}</option>`
            ).join('');

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>New Fertigation Schedule</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9;">Create a schedule for greenhouse crop fertigation</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form onsubmit="createFertigationSchedule(event)">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Crop</label>
                                <select id="fertCrop" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    ${Object.entries(FERTIGATION_SCHEDULES).map(([k, s]) => `<option value="${k}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Field/Location</label>
                                <select id="fertField" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    <option value="Greenhouse">Greenhouse</option>
                                    <option value="High Tunnel">High Tunnel</option>
                                    ${fieldOptions}
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Transplant Date</label>
                                <input type="date" id="fertTransplantDate" value="${new Date().toISOString().slice(0, 10)}" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Area (sq ft)</label>
                                <input type="number" id="fertArea" value="1000" step="100" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Notes</label>
                                <textarea id="fertNotes" rows="2" placeholder="Variety, bed numbers, etc." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Cancel</button>
                                <button type="submit" class="btn btn-success" style="padding: 0.75rem 1.5rem;">Create Schedule</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function closeFertigationModal() {
            document.getElementById('fertigationModal').style.display = 'none';
        }

        function createFertigationSchedule(event) {
            event.preventDefault();

            const cropKey = document.getElementById('fertCrop').value;
            const field = document.getElementById('fertField').value;
            const transplantDate = document.getElementById('fertTransplantDate').value;
            const area = document.getElementById('fertArea').value;
            const notes = document.getElementById('fertNotes').value;

            const schedule = {
                id: Date.now().toString(),
                cropKey: cropKey,
                name: FERTIGATION_SCHEDULES[cropKey]?.name,
                field: field,
                transplantDate: transplantDate,
                area: parseFloat(area),
                notes: notes,
                status: 'active',
                createdAt: new Date().toISOString()
            };

            fertigationSchedules.push(schedule);
            localStorage.setItem('fertigationSchedules', JSON.stringify(fertigationSchedules));

            // Sync to backend
            syncToBackend('saveFertigationData', {
                type: 'schedule',
                cropKey: schedule.cropKey,
                field: schedule.field,
                data: schedule
            }).then(result => {
                if (result.success && result.id) {
                    // Update local record with backend ID
                    const idx = fertigationSchedules.findIndex(s => s.id === schedule.id);
                    if (idx !== -1) {
                        fertigationSchedules[idx].backendId = result.id;
                        fertigationSchedules[idx].synced = true;
                        localStorage.setItem('fertigationSchedules', JSON.stringify(fertigationSchedules));
                    }
                }
            });

            closeFertigationModal();
            renderFertigationTab();
            showToast('Fertigation schedule created!', 'success');
        }

        function showQuickFertigation() {
            const modal = document.getElementById('fertigationModal');
            const fieldOptions = Object.keys(FARM_FIELDS).map(f =>
                `<option value="${f}">${f}</option>`
            ).join('');

            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>Log Fertigation Application</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9;">Record a one-time fertigation application</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form onsubmit="logQuickFertigation(event)">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Product</label>
                                <select id="quickFertProduct" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    ${Object.entries(FERTIGATION_PRODUCTS).map(([k, p]) => `<option value="${k}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Amount Applied</label>
                                <input type="text" id="quickFertAmount" placeholder="e.g., 2 gal, 16 oz" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Field/Location</label>
                                <select id="quickFertField" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    <option value="Greenhouse">Greenhouse</option>
                                    <option value="High Tunnel">High Tunnel</option>
                                    ${fieldOptions}
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Date</label>
                                <input type="date" id="quickFertDate" value="${new Date().toISOString().slice(0, 10)}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600;">Notes</label>
                                <textarea id="quickFertNotes" rows="2" placeholder="Dilution rate, conditions, etc." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Cancel</button>
                                <button type="submit" class="btn btn-success" style="padding: 0.75rem 1.5rem;">Log Application</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function logQuickFertigation(event) {
            event.preventDefault();

            const log = {
                id: Date.now().toString(),
                product: document.getElementById('quickFertProduct').value,
                amount: document.getElementById('quickFertAmount').value,
                field: document.getElementById('quickFertField').value,
                date: document.getElementById('quickFertDate').value,
                notes: document.getElementById('quickFertNotes').value
            };

            fertigationLogs.push(log);
            localStorage.setItem('fertigationLogs', JSON.stringify(fertigationLogs));

            // Sync to backend
            syncToBackend('saveFertigationData', {
                type: 'log',
                field: log.field,
                data: log
            }).then(result => {
                if (result.success && result.id) {
                    const idx = fertigationLogs.findIndex(l => l.id === log.id);
                    if (idx !== -1) {
                        fertigationLogs[idx].backendId = result.id;
                        fertigationLogs[idx].synced = true;
                        localStorage.setItem('fertigationLogs', JSON.stringify(fertigationLogs));
                    }
                }
            });

            // Also record in FarmLearning
            const product = FERTIGATION_PRODUCTS[log.product];
            if (product) {
                FarmLearning.recordAmendment({
                    date: log.date,
                    fieldZone: log.field,
                    material: product.name,
                    rate: log.amount,
                    method: 'fertigation',
                    notes: log.notes
                });
            }

            closeFertigationModal();
            renderFertigationTab();
            showToast('Fertigation application logged!', 'success');
        }

        function showCropScheduleDetail(cropKey) {
            const schedule = FERTIGATION_SCHEDULES[cropKey];
            if (!schedule) return;

            const modal = document.getElementById('fertigationModal');
            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>${schedule.name} Fertigation Schedule</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9;">Season totals: N ${schedule.totalSeasonN} lb/ac, K ${schedule.totalSeasonK} lb/ac</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Week</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Stage</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #e2e8f0;">N Rate</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #e2e8f0;">K Rate</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e2e8f0;">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${schedule.schedule.map(s => `
                                        <tr style="border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.75rem;">${s.weeksFromTransplant}</td>
                                            <td style="padding: 0.75rem; font-weight: 500;">${s.stage}</td>
                                            <td style="padding: 0.75rem; text-align: center; color: #2563eb;">${s.nRate}</td>
                                            <td style="padding: 0.75rem; text-align: center; color: #7c3aed;">${s.kRate}</td>
                                            <td style="padding: 0.75rem; font-size: 0.8rem; color: #64748b;">${s.notes}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        ${schedule.foliarSchedule ? `
                            <div style="margin-top: 1.5rem;">
                                <h4 style="color: #7c3aed; margin-bottom: 0.75rem;">Recommended Foliar Applications</h4>
                                <div style="display: grid; gap: 0.5rem;">
                                    ${schedule.foliarSchedule.map(f => `
                                        <div style="padding: 0.75rem; background: #f0fdf4; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <strong>${f.timing}:</strong> ${f.product} @ ${f.rate} - ${f.purpose}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem; font-size: 0.875rem; color: #92400e;">
                            <strong>Note:</strong> ${schedule.notes}
                        </div>

                        <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function showCompostTeaRecipe(recipeKey) {
            const recipe = COMPOST_TEA_RECIPES[recipeKey];
            if (!recipe) return;

            const modal = document.getElementById('fertigationModal');
            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3>${recipe.name}</h3>
                        <p style="font-size: 0.875rem; opacity: 0.9;">${recipe.purpose}</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: #92400e; margin-bottom: 0.75rem;">Ingredients</h4>
                            <div style="display: grid; gap: 0.5rem;">
                                ${recipe.ingredients.map(i => `
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #fef3c7; border-radius: 0.375rem;">
                                        <span style="font-weight: 500;">${i.item}</span>
                                        <span style="color: #92400e;">${i.amount}</span>
                                    </div>
                                    ${i.notes ? `<div style="font-size: 0.75rem; color: #78350f; margin-left: 0.5rem; margin-top: -0.25rem;">${i.notes}</div>` : ''}
                                `).join('')}
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: #92400e; margin-bottom: 0.75rem;">Equipment Needed</h4>
                            <ul style="list-style: disc; padding-left: 1.5rem; color: #78350f;">
                                ${recipe.equipment.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="padding: 1rem; background: #ecfdf5; border-radius: 0.5rem;">
                                <div style="font-size: 0.75rem; color: #065f46;">Brew Time</div>
                                <div style="font-weight: 600; color: #047857;">${recipe.brewTime}</div>
                            </div>
                            <div style="padding: 1rem; background: #fef3c7; border-radius: 0.5rem;">
                                <div style="font-size: 0.75rem; color: #92400e;">Source</div>
                                <div style="font-weight: 600; color: #78350f;">${recipe.source}</div>
                            </div>
                        </div>

                        <div style="padding: 1rem; background: #dbeafe; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <strong style="color: #1e40af;">Application:</strong>
                            <p style="color: #1e3a8a; font-size: 0.875rem; margin-top: 0.25rem;">${recipe.application}</p>
                        </div>

                        <div style="padding: 1rem; background: #fee2e2; border-radius: 0.5rem;">
                            <strong style="color: #991b1b;">Important:</strong>
                            <p style="color: #7f1d1d; font-size: 0.875rem; margin-top: 0.25rem;">
                                Use within 4-6 hours of brewing completion. Do not let tea go anaerobic.
                            </p>
                        </div>

                        <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function logFertigationApplication(scheduleId) {
            const schedule = fertigationSchedules.find(s => s.id === scheduleId);
            if (!schedule) return;

            // Pre-fill the quick fertigation form with schedule info
            showQuickFertigation();
            setTimeout(() => {
                document.getElementById('quickFertField').value = schedule.field || 'Greenhouse';
            }, 100);
        }

        function viewFertigationSchedule(scheduleId) {
            const schedule = fertigationSchedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            showCropScheduleDetail(schedule.cropKey);
        }

        // ============================================
        // IPM TOOLKIT TAB
        // Integrated Pest Management & Disease Control
        // ============================================

        function renderIPMToolkit() {
            const container = document.getElementById('testsContainer');

            container.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">IPM Toolkit - Organic Pest & Disease Control</h3>
                            <p style="color: #64748b; font-size: 0.875rem;">
                                OMRI-listed products from your organic certification input sheet.
                                <br><span style="font-size: 0.75rem;">All products verified OMRI Listed for NOP compliance.</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ========================================== -->
                <!-- MANDATORY IPM PROTOCOLS - HARD-WIRED -->
                <!-- These are NON-NEGOTIABLE spray schedules -->
                <!-- ========================================== -->
                <div style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; border: 3px solid #7f1d1d;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                        <span style="font-size: 2rem;">ðŸš¨</span>
                        <div>
                            <h3 style="color: white; margin: 0; font-size: 1.25rem;">MANDATORY SPRAY PROTOCOLS</h3>
                            <p style="color: #fecaca; font-size: 0.875rem; margin: 0;">Hard-wired programs - SPRAY DAY OF GERMINATION or lose the crop</p>
                        </div>
                    </div>

                    <!-- Spray Schedule Generator -->
                    <div style="background: white; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="color: #1e293b; margin-bottom: 0.75rem; font-size: 1rem;">Generate Spray Schedule</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.75rem; align-items: end;">
                            <div>
                                <label style="font-size: 0.875rem; color: #64748b; display: block; margin-bottom: 0.25rem;">Crop</label>
                                <select id="mandatoryCropSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; font-size: 0.875rem;">
                                    <option value="">-- Select crop --</option>
                                    <optgroup label="Flea Beetle Program (Brassica Baby Greens)">
                                        <option value="Petite Kale Mix">Petite Kale Mix</option>
                                        <option value="Summer Petite Kale Mix">Summer Petite Kale Mix</option>
                                        <option value="Something Fresh Mix">Something Fresh Mix</option>
                                        <option value="Arugula">Arugula</option>
                                        <option value="Wild Arugula">Wild Arugula (Sylvetta)</option>
                                        <option value="Mizuna">Mizuna</option>
                                        <option value="Mustard">Mustard Greens</option>
                                        <option value="Cress">Cress</option>
                                    </optgroup>
                                    <optgroup label="Leaf Miner Program (Spinach)">
                                        <option value="Spinach">Spinach (all varieties)</option>
                                        <option value="Baby Spinach">Baby Spinach</option>
                                        <option value="Kolibri">Kolibri Spinach</option>
                                        <option value="Space">Space Spinach</option>
                                        <option value="Gazelle">Gazelle Spinach</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.875rem; color: #64748b; display: block; margin-bottom: 0.25rem;">Sowing/Germination Date</label>
                                <input type="date" id="mandatorySowDate" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; font-size: 0.875rem;" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <button onclick="generateMandatoryScheduleUI()" class="btn btn-primary" style="padding: 0.5rem 1rem; background: #dc2626; border-color: #dc2626;">
                                Generate Schedule
                            </button>
                        </div>
                        <div id="mandatoryScheduleOutput" style="margin-top: 1rem;"></div>
                    </div>

                    <!-- Flea Beetle Protocol Card -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
                        <div style="background: white; border-radius: 0.75rem; padding: 1rem; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.5rem;">ðŸª²</span>
                                <h4 style="color: #1e293b; margin: 0;">Flea Beetle Protocol</h4>
                            </div>
                            <p style="font-size: 0.875rem; color: #dc2626; font-weight: 600; margin-bottom: 0.5rem;">
                                FOR: Brassica Baby Greens - Petite Kale Mix, Arugula, Something Fresh Mix
                            </p>
                            <div style="background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                <p style="font-size: 0.875rem; color: #92400e; margin: 0; font-weight: 600;">
                                    DAY 0 (GERMINATION): MANDATORY SPRAY - Entrust SC (6 oz/acre) evening application
                                </p>
                            </div>
                            <div style="font-size: 0.8rem; color: #475569;">
                                <p style="margin: 0.25rem 0;"><strong>Day 3:</strong> AzaGuard 16 oz/acre (IGR follow-up)</p>
                                <p style="margin: 0.25rem 0;"><strong>Day 7:</strong> PyGanic 8-12 oz/acre (rotate)</p>
                                <p style="margin: 0.25rem 0;"><strong>Day 10:</strong> AzaGuard 16 oz/acre</p>
                                <p style="margin: 0.25rem 0;"><strong>Day 14:</strong> Entrust SC (if needed)</p>
                            </div>
                            <div style="background: #fee2e2; padding: 0.5rem; border-radius: 0.375rem; margin-top: 0.75rem;">
                                <p style="font-size: 0.75rem; color: #991b1b; margin: 0;">
                                    <strong>WARNING:</strong> Flea beetles destroy cotyledons within 24-48 hours. Do NOT skip Day 0.
                                </p>
                            </div>
                        </div>

                        <!-- Leaf Miner Protocol Card -->
                        <div style="background: white; border-radius: 0.75rem; padding: 1rem; border-left: 4px solid #10b981;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.5rem;">ðŸª°</span>
                                <h4 style="color: #1e293b; margin: 0;">Leaf Miner Protocol</h4>
                            </div>
                            <p style="font-size: 0.875rem; color: #dc2626; font-weight: 600; margin-bottom: 0.5rem;">
                                FOR: All Spinach - Kolibri, Seaside, Space, Gazelle, Baby Spinach
                            </p>
                            <div style="background: #d1fae5; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                <p style="font-size: 0.875rem; color: #065f46; margin: 0; font-weight: 600;">
                                    DAY 0 (GERMINATION): MANDATORY SPRAY - Entrust SC (6-8 oz/acre) evening application
                                </p>
                            </div>
                            <div style="font-size: 0.8rem; color: #475569;">
                                <p style="margin: 0.25rem 0;"><strong>Day 5:</strong> AzaGuard 16-21 oz/acre (IGR)</p>
                                <p style="margin: 0.25rem 0;"><strong>Day 10:</strong> Entrust SC 6-8 oz/acre</p>
                                <p style="margin: 0.25rem 0;"><strong>Day 15:</strong> AzaGuard 16 oz/acre</p>
                                <p style="margin: 0.25rem 0;"><strong>Day 21:</strong> PyGanic 8 oz/acre (if needed)</p>
                            </div>
                            <div style="background: #fee2e2; padding: 0.5rem; border-radius: 0.375rem; margin-top: 0.75rem;">
                                <p style="font-size: 0.75rem; color: #991b1b; margin: 0;">
                                    <strong>WARNING:</strong> Once larvae are IN the leaf, damage is irreversible. Prevention ONLY.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Product Quick Reference -->
                    <div style="background: rgba(255,255,255,0.9); border-radius: 0.5rem; padding: 0.75rem; margin-top: 1rem;">
                        <h5 style="color: #1e293b; margin: 0 0 0.5rem 0; font-size: 0.875rem;">Quick Product Reference for Mandatory Protocols</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.75rem;">
                            <div style="background: white; padding: 0.5rem; border-radius: 0.25rem;">
                                <strong style="color: #7c3aed;">Entrust SC</strong><br>
                                <span style="color: #64748b;">6-10 fl oz/acre | PHI: 1-7 days | Apply evening</span>
                            </div>
                            <div style="background: white; padding: 0.5rem; border-radius: 0.25rem;">
                                <strong style="color: #7c3aed;">AzaGuard</strong><br>
                                <span style="color: #64748b;">16-21 fl oz/acre | PHI: 0 days | IGR mode</span>
                            </div>
                            <div style="background: white; padding: 0.5rem; border-radius: 0.25rem;">
                                <strong style="color: #7c3aed;">PyGanic 5%</strong><br>
                                <span style="color: #64748b;">8-16 fl oz/acre | PHI: 0 days | Knockdown</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pest Control Products -->
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #92400e; margin-bottom: 1rem;">Insect Pest Control Products</h4>
                    <p style="color: #78350f; font-size: 0.875rem; margin-bottom: 1rem;">
                        Products for managing insect pests. Always rotate modes of action to prevent resistance.
                    </p>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button onclick="filterIPMProducts('all')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">All</button>
                        <button onclick="filterIPMProducts('igr')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">IGR/Neem</button>
                        <button onclick="filterIPMProducts('biological')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Biological (Bt)</button>
                        <button onclick="filterIPMProducts('contact')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Contact</button>
                        <button onclick="filterIPMProducts('fungal')" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Fungal</button>
                    </div>
                    <div id="ipmProductsList" style="display: grid; gap: 0.75rem;">
                        ${renderIPMProducts('all')}
                    </div>
                </div>

                <!-- Disease Control Products -->
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #1e40af; margin-bottom: 1rem;">Disease Control Biofungicides</h4>
                    <p style="color: #1e3a8a; font-size: 0.875rem; margin-bottom: 1rem;">
                        Biological and copper-based products for fungal and bacterial disease management. Apply preventively for best results.
                    </p>
                    <div id="diseaseProductsList" style="display: grid; gap: 0.75rem;">
                        ${renderDiseaseProducts()}
                    </div>
                </div>

                <!-- Quick Pest Lookup -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Quick Pest Lookup</h4>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                        Select a pest to see recommended products.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                        ${renderPestButtons()}
                    </div>
                    <div id="pestRecommendations" style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; display: none;">
                    </div>
                </div>

                <!-- Safety & Rotation Guide -->
                <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #991b1b; margin-bottom: 1rem;">Important Safety Notes</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                            <h5 style="color: #dc2626; margin-bottom: 0.5rem;">Bee Safety</h5>
                            <ul style="font-size: 0.875rem; color: #7f1d1d; padding-left: 1.25rem; margin: 0;">
                                <li>Entrust & PyGanic: HIGH toxicity when wet - apply evening only</li>
                                <li>Allow products to dry completely before bee activity</li>
                                <li>Never spray blooming crops during day</li>
                                <li>Bt, M-Pede, BotaniGard are bee-safe</li>
                            </ul>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                            <h5 style="color: #dc2626; margin-bottom: 0.5rem;">Resistance Management</h5>
                            <ul style="font-size: 0.875rem; color: #7f1d1d; padding-left: 1.25rem; margin: 0;">
                                <li>Rotate IRAC groups - max 2 consecutive sprays same group</li>
                                <li>Entrust (Group 5): Rotate after 2 applications</li>
                                <li>Bt has no resistance issues - use freely</li>
                                <li>Copper: Max 12 lb/acre/season</li>
                            </ul>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                            <h5 style="color: #dc2626; margin-bottom: 0.5rem;">REI/PHI Guide</h5>
                            <ul style="font-size: 0.875rem; color: #7f1d1d; padding-left: 1.25rem; margin: 0;">
                                <li>REI = Re-Entry Interval (worker safety)</li>
                                <li>PHI = Pre-Harvest Interval</li>
                                <li>Most products: 0-day PHI, 4-12 hour REI</li>
                                <li>NuCop: 24-hour REI due to copper</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Spray Calendar Suggestion -->
                <div style="background: white; border-radius: 1rem; padding: 1.5rem;">
                    <h4 style="color: #7c3aed; margin-bottom: 1rem;">Sample Preventive Spray Schedule</h4>
                    <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                        Example rotations for common situations. Adjust based on pest pressure.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                        <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                            <h5 style="color: #1e293b; margin-bottom: 0.5rem;">Brassica Rotation</h5>
                            <ol style="font-size: 0.875rem; color: #64748b; padding-left: 1.25rem; margin: 0;">
                                <li>Week 1: Bt (caterpillars)</li>
                                <li>Week 2: AzaGuard (aphids, flea beetles)</li>
                                <li>Week 3: Bt</li>
                                <li>Week 4: Entrust (if CBW pressure)</li>
                                <li>Repeat, alternating Bt with AzaGuard/Entrust</li>
                            </ol>
                        </div>
                        <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                            <h5 style="color: #1e293b; margin-bottom: 0.5rem;">Cucurbit Disease Prevention</h5>
                            <ol style="font-size: 0.875rem; color: #64748b; padding-left: 1.25rem; margin: 0;">
                                <li>Week 1: Regalia (ISR induction)</li>
                                <li>Week 2: Serenade ASO</li>
                                <li>Week 3: Stargus</li>
                                <li>Week 4: Regalia + NuCop (if DM pressure)</li>
                                <li>Repeat 7-10 day intervals</li>
                            </ol>
                        </div>
                        <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                            <h5 style="color: #1e293b; margin-bottom: 0.5rem;">Greenhouse Whitefly</h5>
                            <ol style="font-size: 0.875rem; color: #64748b; padding-left: 1.25rem; margin: 0;">
                                <li>Week 1: M-Pede (knockdown adults)</li>
                                <li>Week 2: BotaniGard (fungal infection)</li>
                                <li>Week 3: AzaGuard (IGR for nymphs)</li>
                                <li>Week 4: BotaniGard</li>
                                <li>Continue BotaniGard every 5-7 days until controlled</li>
                            </ol>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderIPMProducts(filter) {
            const products = Object.entries(IPM_PEST_PRODUCTS).filter(([key, p]) => {
                if (filter === 'all') return true;
                if (filter === 'igr') return ['igr', 'botanical'].includes(p.category);
                if (filter === 'contact') return ['pyrethrin', 'soap', 'spinosyn'].includes(p.category);
                if (filter === 'biological') return p.category === 'biological';
                if (filter === 'fungal') return p.category === 'fungal';
                return p.category === filter;
            });

            return products.map(([key, product]) => `
                <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <strong style="color: #1e293b;">${product.name}</strong>
                            ${product.omriListed ? '<span style="background: #f0fdf4; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem;">OMRI</span>' : ''}
                        </div>
                        <span style="color: #64748b; font-size: 0.875rem;">~$${product.costEstimate}/unit</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #7c3aed; margin: 0.25rem 0;">
                        ${product.activeIngredient}
                    </div>
                    <p style="color: #64748b; font-size: 0.875rem; margin: 0.5rem 0;">
                        <strong>Mode:</strong> ${product.mode}
                    </p>
                    <div style="display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-wrap: wrap;">
                        ${product.targets.slice(0, 5).map(t => `
                            <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem;">
                                ${t}
                            </span>
                        `).join('')}
                        ${product.targets.length > 5 ? `<span style="color: #64748b; font-size: 0.7rem;">+${product.targets.length - 5} more</span>` : ''}
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.75rem; color: #475569; margin-top: 0.5rem;">
                        <div><strong>Rate/acre:</strong> ${product.ratePerAcre}</div>
                        <div><strong>Rate/gal:</strong> ${product.ratePerGallon || product.ratePer1000sqft || 'See label'}</div>
                        <div><strong>REI:</strong> ${product.rei}</div>
                        <div><strong>PHI:</strong> ${product.phi}</div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.7rem; padding: 0.5rem; border-radius: 0.25rem; ${product.beeToxicity?.includes('HIGH') ? 'background: #fee2e2; color: #991b1b;' : 'background: #f0fdf4; color: #166534;'}">
                        <strong>Bee Safety:</strong> ${product.beeToxicity}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #64748b;">
                        ${product.notes}
                    </div>
                </div>
            `).join('');
        }

        function filterIPMProducts(category) {
            document.getElementById('ipmProductsList').innerHTML = renderIPMProducts(category);
        }

        function renderDiseaseProducts() {
            return Object.entries(DISEASE_CONTROL_PRODUCTS).map(([key, product]) => `
                <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <strong style="color: #1e293b;">${product.name}</strong>
                            ${product.omriListed ? '<span style="background: #f0fdf4; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem;">OMRI</span>' : ''}
                        </div>
                        <span style="color: #64748b; font-size: 0.875rem;">~$${product.costEstimate}/unit</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #1e40af; margin: 0.25rem 0;">
                        ${product.activeIngredient}
                    </div>
                    <p style="color: #64748b; font-size: 0.875rem; margin: 0.5rem 0;">
                        <strong>Mode:</strong> ${product.mode}
                    </p>
                    <div style="display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-wrap: wrap;">
                        ${product.targets.slice(0, 4).map(t => `
                            <span style="background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem;">
                                ${t}
                            </span>
                        `).join('')}
                        ${product.targets.length > 4 ? `<span style="color: #64748b; font-size: 0.7rem;">+${product.targets.length - 4} more</span>` : ''}
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.75rem; color: #475569; margin-top: 0.5rem;">
                        <div><strong>Rate/acre:</strong> ${product.ratePerAcre}</div>
                        <div><strong>Rate/gal:</strong> ${product.ratePerGallon}</div>
                        <div><strong>Interval:</strong> ${product.interval}</div>
                        <div><strong>REI:</strong> ${product.rei} | <strong>PHI:</strong> ${product.phi}</div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #64748b;">
                        ${product.notes}
                    </div>
                </div>
            `).join('');
        }

        function renderPestButtons() {
            const commonPests = [
                { name: 'Aphids', icon: 'bug' },
                { name: 'Caterpillars', icon: 'worm' },
                { name: 'Whiteflies', icon: 'wind' },
                { name: 'Thrips', icon: 'seedling' },
                { name: 'Flea Beetles', icon: 'bug' },
                { name: 'Slugs', icon: 'snail' },
                { name: 'Powdery Mildew', icon: 'cloud' },
                { name: 'Downy Mildew', icon: 'tint' },
                { name: 'Botrytis', icon: 'disease' },
                { name: 'Bacterial Spot', icon: 'circle' }
            ];

            return commonPests.map(pest => `
                <button onclick="showPestRecommendation('${pest.name}')"
                    style="padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; background: white; cursor: pointer; text-align: left; transition: all 0.2s;"
                    onmouseover="this.style.borderColor='#7c3aed'; this.style.background='#f5f3ff';"
                    onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='white';">
                    <span style="font-weight: 500; color: #1e293b;">${pest.name}</span>
                </button>
            `).join('');
        }

        function showPestRecommendation(pestName) {
            const recommendations = {
                'Aphids': {
                    products: ['M-Pede', 'AzaGuard', 'BotaniGard', 'Neem Oil'],
                    strategy: 'Start with M-Pede for knockdown, follow with AzaGuard or BotaniGard for residual control. Scout undersides of leaves.',
                    timing: 'Apply early morning or evening. Repeat every 5-7 days until controlled.'
                },
                'Caterpillars': {
                    products: ['Bt (DiPel)', 'Entrust SC', 'PyGanic'],
                    strategy: 'Bt is first choice - very effective, bee-safe, no resistance. Use Entrust for heavy pressure or larger larvae.',
                    timing: 'Apply when larvae are small. Add Nu Film P to extend Bt efficacy. Evening application best.'
                },
                'Whiteflies': {
                    products: ['M-Pede', 'BotaniGard', 'AzaGuard'],
                    strategy: 'M-Pede kills adults on contact. BotaniGard infects all stages. AzaGuard prevents nymphs from maturing.',
                    timing: 'Yellow sticky traps for monitoring. Apply 2-3x per week in greenhouse.'
                },
                'Thrips': {
                    products: ['Entrust SC', 'BotaniGard', 'AzaGuard'],
                    strategy: 'Entrust is most effective but use sparingly (resistance). Rotate with BotaniGard and AzaGuard.',
                    timing: 'Target flowers and growing points. Blue sticky traps for monitoring.'
                },
                'Flea Beetles': {
                    products: ['Entrust SC', 'PyGanic', 'AzaGuard'],
                    strategy: 'Row cover is best prevention. PyGanic for knockdown, Entrust for residual. AzaGuard as IGR.',
                    timing: 'Most active in warm weather. Apply to transplants immediately.'
                },
                'Slugs': {
                    products: ['Sluggo'],
                    strategy: 'Scatter bait evenly around plants. Do not pile. Apply to moist soil.',
                    timing: 'Evening application. Reapply after heavy rain or every 2 weeks.'
                },
                'Powdery Mildew': {
                    products: ['Regalia CG', 'Serenade ASO', 'Cease'],
                    strategy: 'Preventive applications are key. Regalia induces plant immunity. Rotate biologicals.',
                    timing: 'Start before symptoms appear. Apply every 7-10 days.'
                },
                'Downy Mildew': {
                    products: ['Stargus', 'Regalia CG', 'NuCop 50'],
                    strategy: 'Stargus specifically targets downy mildew. Copper provides backup protection.',
                    timing: 'Watch weather - humidity and cool temps increase risk. Preventive sprays critical.'
                },
                'Botrytis': {
                    products: ['Serenade ASO', 'Cease', 'Stargus'],
                    strategy: 'Improve air circulation. Remove infected tissue. Apply biologicals preventively.',
                    timing: 'High risk during flowering and in humid conditions. Apply every 7 days.'
                },
                'Bacterial Spot': {
                    products: ['NuCop 50', 'Serenade ASO', 'Regalia CG'],
                    strategy: 'Copper is primary control. Avoid overhead irrigation. Use disease-free transplants.',
                    timing: 'Apply before rain events. 7-10 day intervals during high-risk periods.'
                }
            };

            const rec = recommendations[pestName];
            if (!rec) return;

            const recDiv = document.getElementById('pestRecommendations');
            recDiv.style.display = 'block';
            recDiv.innerHTML = `
                <h5 style="color: #7c3aed; margin-bottom: 0.75rem;">${pestName} Control Recommendations</h5>
                <div style="margin-bottom: 0.75rem;">
                    <strong style="color: #1e293b;">Recommended Products:</strong>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.25rem;">
                        ${rec.products.map(p => `
                            <span style="background: #f0fdf4; color: #166534; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem;">
                                ${p}
                            </span>
                        `).join('')}
                    </div>
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <strong style="color: #1e293b;">Strategy:</strong>
                    <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.25rem;">${rec.strategy}</p>
                </div>
                <div>
                    <strong style="color: #1e293b;">Timing:</strong>
                    <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.25rem;">${rec.timing}</p>
                </div>
            `;
        }

        // ============================================
        // MANDATORY IPM SCHEDULE GENERATOR UI
        // Generates printable spray schedules with actual dates
        // ============================================
        function generateMandatoryScheduleUI() {
            const cropSelect = document.getElementById('mandatoryCropSelect');
            const dateInput = document.getElementById('mandatorySowDate');
            const outputDiv = document.getElementById('mandatoryScheduleOutput');

            const cropName = cropSelect.value;
            const sowingDate = dateInput.value;

            if (!cropName) {
                outputDiv.innerHTML = '<p style="color: #dc2626;">Please select a crop.</p>';
                return;
            }

            if (!sowingDate) {
                outputDiv.innerHTML = '<p style="color: #dc2626;">Please select a sowing/germination date.</p>';
                return;
            }

            const scheduleData = generateMandatorySpraySchedule(cropName, sowingDate);

            if (!scheduleData) {
                outputDiv.innerHTML = '<p style="color: #64748b;">No mandatory protocol found for this crop.</p>';
                return;
            }

            const protocol = scheduleData.protocol;
            const isFleaBeetle = protocol.name.includes('Flea Beetle');

            outputDiv.innerHTML = `
                <div style="border: 2px solid ${isFleaBeetle ? '#f59e0b' : '#10b981'}; border-radius: 0.75rem; padding: 1rem; background: ${isFleaBeetle ? '#fffbeb' : '#ecfdf5'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                        <div>
                            <h4 style="margin: 0; color: #1e293b;">${protocol.name}</h4>
                            <p style="margin: 0.25rem 0 0 0; color: ${isFleaBeetle ? '#92400e' : '#065f46'}; font-size: 0.875rem;">
                                <strong>Crop:</strong> ${cropName} | <strong>Sown:</strong> ${new Date(sowingDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                            </p>
                        </div>
                        <button onclick="printMandatorySchedule()" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                            Print Schedule
                        </button>
                    </div>

                    <div style="background: white; border-radius: 0.5rem; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: ${isFleaBeetle ? '#fef3c7' : '#d1fae5'};">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Date</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Day</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Action</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Product & Rate</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Timing</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${scheduleData.schedule.map((spray, idx) => `
                                    <tr style="background: ${spray.day === 0 ? (isFleaBeetle ? '#fee2e2' : '#dcfce7') : (idx % 2 === 0 ? 'white' : '#f8fafc')};">
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-weight: ${spray.day === 0 ? '700' : '400'};">
                                            ${spray.dateFormatted}
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-weight: ${spray.day === 0 ? '700' : '400'}; color: ${spray.day === 0 ? '#dc2626' : '#475569'};">
                                            ${spray.dayLabel}
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-weight: ${spray.day === 0 ? '700' : '400'}; color: ${spray.day === 0 ? '#dc2626' : '#475569'};">
                                            ${spray.action}
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                                            ${spray.rate}
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; color: #64748b;">
                                            ${spray.timing}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 1rem; padding: 0.75rem; background: #fee2e2; border-radius: 0.5rem;">
                        <h5 style="color: #991b1b; margin: 0 0 0.5rem 0;">Critical Warnings:</h5>
                        <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.8rem; color: #7f1d1d;">
                            ${protocol.warnings.map(w => `<li style="margin-bottom: 0.25rem;">${w}</li>`).join('')}
                        </ul>
                    </div>

                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #64748b;">
                        <strong>Row Cover Alternative:</strong> ${protocol.rowCoverAlternative}<br>
                        <strong>Est. Cost:</strong> ${protocol.costPerBed}
                    </div>
                </div>

                <!-- Save to localStorage for persistence -->
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button onclick="saveMandatorySchedule('${cropName}', '${sowingDate}')" class="btn btn-primary" style="padding: 0.5rem 1rem;">
                        Save to Active Schedules
                    </button>
                    <button onclick="exportMandatorySchedule('${cropName}', '${sowingDate}')" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                        Export as CSV
                    </button>
                </div>
            `;
        }

        // Save mandatory spray schedule to localStorage AND backend
        async function saveMandatorySchedule(cropName, sowingDate) {
            const scheduleData = generateMandatorySpraySchedule(cropName, sowingDate);
            if (!scheduleData) return;

            const savedSchedules = JSON.parse(localStorage.getItem('mandatoryIPMSchedules') || '[]');

            // Check for duplicates
            const exists = savedSchedules.some(s => s.cropName === cropName && s.sowingDate === sowingDate);
            if (exists) {
                alert('This schedule already exists in your saved schedules.');
                return;
            }

            const newSchedule = {
                id: Date.now(),
                cropName: cropName,
                sowingDate: sowingDate,
                protocolName: scheduleData.protocol.name,
                schedule: scheduleData.schedule,
                createdAt: new Date().toISOString()
            };

            // Save to localStorage first (immediate)
            savedSchedules.push(newSchedule);
            localStorage.setItem('mandatoryIPMSchedules', JSON.stringify(savedSchedules));

            // Sync to backend (async)
            const result = await syncToBackend('saveIPMSchedule', newSchedule);
            if (result.success) {
                alert(`Saved & Synced! ${scheduleData.protocol.name} for ${cropName} added to active schedules.`);
            } else {
                alert(`Saved locally! ${scheduleData.protocol.name} for ${cropName} added. (Will sync when online)`);
            }
        }

        // Export schedule as CSV
        function exportMandatorySchedule(cropName, sowingDate) {
            const scheduleData = generateMandatorySpraySchedule(cropName, sowingDate);
            if (!scheduleData) return;

            const rows = [
                ['Mandatory IPM Schedule - ' + scheduleData.protocol.name],
                ['Crop: ' + cropName],
                ['Sowing Date: ' + sowingDate],
                [''],
                ['Date', 'Day', 'Action', 'Product & Rate', 'Timing', 'Notes']
            ];

            scheduleData.schedule.forEach(spray => {
                rows.push([
                    spray.date,
                    spray.dayLabel,
                    spray.action,
                    spray.rate,
                    spray.timing,
                    spray.notes
                ]);
            });

            const csvContent = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `IPM_Schedule_${cropName.replace(/\s+/g, '_')}_${sowingDate}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Print schedule
        function printMandatorySchedule() {
            window.print();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INVENTORY MANAGEMENT SYSTEM
        // Complete inventory tracking with seed-to-sale traceability
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let inventoryProducts = [];
        let inventoryTransactions = [];
        let lowStockProducts = [];
        let inventorySearchTerm = '';
        let inventoryCategoryFilter = 'all';
        let inventoryLocationFilter = 'all';

        const PRODUCT_CATEGORIES = ['SEED', 'AMENDMENT', 'FERTILIZER', 'PESTICIDE', 'BIOLOGICAL', 'SUPPLY'];
        const STORAGE_LOCATIONS = ['Barn', 'Greenhouse', 'High Tunnel', 'Field Shed', 'Other'];
        const OMRI_STATUSES = ['OMRI Listed', 'Approved by Certifier', 'Restricted Use', 'Not Listed'];

        /**
         * Load inventory data from backend
         */
        async function loadInventoryData() {
            try {
                const [productsResult, lowStockResult] = await Promise.all([
                    loadFromBackend('getInventoryProducts'),
                    loadFromBackend('getLowStockProducts')
                ]);

                if (productsResult.success) {
                    inventoryProducts = productsResult.data || [];
                }
                if (lowStockResult.success) {
                    lowStockProducts = lowStockResult.data || [];
                }
            } catch (e) {
                console.warn('Failed to load inventory data:', e);
            }
        }

        /**
         * Render the main inventory tab
         */
        async function renderInventoryTab() {
            const container = document.getElementById('testsContainer');
            container.innerHTML = `<div class="loading"><div class="spinner"></div><p>Loading inventory...</p></div>`;

            await loadInventoryData();

            const filteredProducts = inventoryProducts.filter(p => {
                const matchesSearch = !inventorySearchTerm ||
                    p.Product_Name?.toLowerCase().includes(inventorySearchTerm.toLowerCase()) ||
                    p.Manufacturer?.toLowerCase().includes(inventorySearchTerm.toLowerCase());
                const matchesCategory = inventoryCategoryFilter === 'all' || p.Category === inventoryCategoryFilter;
                const matchesLocation = inventoryLocationFilter === 'all' || p.Location === inventoryLocationFilter;
                return matchesSearch && matchesCategory && matchesLocation;
            });

            container.innerHTML = `
                <div style="padding: 1.5rem;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: #1e293b;">Inventory Management</h2>
                        <button onclick="showAddProductModal()" class="btn btn-primary" style="background: #7c3aed; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                            + Add Product
                        </button>
                    </div>

                    <!-- Low Stock Alerts -->
                    ${lowStockProducts.length > 0 ? `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                            <h3 style="color: #dc2626; margin: 0 0 0.75rem 0; font-size: 0.95rem;">Low Stock Alerts (${lowStockProducts.length})</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                ${lowStockProducts.slice(0, 6).map(p => `
                                    <div style="background: white; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 0.75rem; min-width: 150px;">
                                        <div style="font-weight: 600; font-size: 0.875rem;">${p.Product_Name}</div>
                                        <div style="color: #dc2626; font-size: 0.8rem;">${p.Current_Qty} ${p.Unit} left</div>
                                        <div style="color: #6b7280; font-size: 0.75rem;">Reorder: ${p.Reorder_Point} ${p.Unit}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Filters -->
                    <div style="background: white; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" placeholder="Search products..." value="${inventorySearchTerm}"
                                onchange="inventorySearchTerm = this.value; renderInventoryTab();"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                        </div>
                        <div>
                            <select onchange="inventoryCategoryFilter = this.value; renderInventoryTab();"
                                style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                <option value="all" ${inventoryCategoryFilter === 'all' ? 'selected' : ''}>All Categories</option>
                                ${PRODUCT_CATEGORIES.map(cat => `
                                    <option value="${cat}" ${inventoryCategoryFilter === cat ? 'selected' : ''}>${cat}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <select onchange="inventoryLocationFilter = this.value; renderInventoryTab();"
                                style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                <option value="all" ${inventoryLocationFilter === 'all' ? 'selected' : ''}>All Locations</option>
                                ${STORAGE_LOCATIONS.map(loc => `
                                    <option value="${loc}" ${inventoryLocationFilter === loc ? 'selected' : ''}>${loc}</option>
                                `).join('')}
                            </select>
                        </div>
                        <button onclick="showRecordPurchaseModal()" class="btn" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer;">
                            + Record Purchase
                        </button>
                    </div>

                    <!-- Products Table -->
                    <div style="background: white; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        ${filteredProducts.length === 0 ? `
                            <div style="padding: 3rem; text-align: center; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“¦</div>
                                <h3>No products found</h3>
                                <p>Add products to start tracking your inventory</p>
                            </div>
                        ` : `
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                        <th style="padding: 0.75rem 1rem; text-align: left;">Product</th>
                                        <th style="padding: 0.75rem 1rem; text-align: left;">Category</th>
                                        <th style="padding: 0.75rem 1rem; text-align: left;">Location</th>
                                        <th style="padding: 0.75rem 1rem; text-align: right;">Stock</th>
                                        <th style="padding: 0.75rem 1rem; text-align: right;">Reorder</th>
                                        <th style="padding: 0.75rem 1rem; text-align: center;">OMRI</th>
                                        <th style="padding: 0.75rem 1rem; text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredProducts.map(p => {
                                        const isLow = parseFloat(p.Current_Qty) <= parseFloat(p.Reorder_Point);
                                        return `
                                            <tr style="border-bottom: 1px solid #e2e8f0; ${isLow ? 'background: #fef2f2;' : ''}">
                                                <td style="padding: 0.75rem 1rem;">
                                                    <div style="font-weight: 600;">${p.Product_Name || 'Unnamed'}</div>
                                                    <div style="font-size: 0.75rem; color: #6b7280;">${p.Manufacturer || ''}</div>
                                                </td>
                                                <td style="padding: 0.75rem 1rem;">
                                                    <span style="background: ${getCategoryColor(p.Category)}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                                        ${p.Category || 'N/A'}
                                                    </span>
                                                </td>
                                                <td style="padding: 0.75rem 1rem; color: #6b7280;">${p.Location || '-'}</td>
                                                <td style="padding: 0.75rem 1rem; text-align: right; font-weight: 600; ${isLow ? 'color: #dc2626;' : ''}">
                                                    ${p.Current_Qty || 0} ${p.Unit || ''}
                                                </td>
                                                <td style="padding: 0.75rem 1rem; text-align: right; color: #6b7280;">
                                                    ${p.Reorder_Point || 0} ${p.Unit || ''}
                                                </td>
                                                <td style="padding: 0.75rem 1rem; text-align: center;">
                                                    ${p.OMRI_Status === 'OMRI Listed' ? '<span style="color: #10b981;">âœ“</span>' :
                                                      p.OMRI_Status === 'Not Listed' ? '<span style="color: #ef4444;">âœ—</span>' :
                                                      '<span style="color: #f59e0b;">â—‹</span>'}
                                                </td>
                                                <td style="padding: 0.75rem 1rem; text-align: center;">
                                                    <button onclick="showEditProductModal('${p.Product_ID}')" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 0.25rem;">âœï¸</button>
                                                    <button onclick="showProductHistory('${p.Product_ID}')" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 0.25rem;">ðŸ“‹</button>
                                                    <button onclick="showQuickAdjustModal('${p.Product_ID}')" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 0.25rem;">Â±</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>

                    <!-- Summary Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                        <div style="background: white; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">${inventoryProducts.length}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Total Products</div>
                        </div>
                        <div style="background: white; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;">${lowStockProducts.length}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Low Stock</div>
                        </div>
                        <div style="background: white; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${inventoryProducts.filter(p => p.OMRI_Status === 'OMRI Listed').length}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">OMRI Listed</div>
                        </div>
                        <div style="background: white; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${inventoryProducts.filter(p => p.Category === 'SEED').length}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Seed Varieties</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCategoryColor(category) {
            const colors = {
                'SEED': '#f59e0b',
                'AMENDMENT': '#8b5cf6',
                'FERTILIZER': '#10b981',
                'PESTICIDE': '#ef4444',
                'BIOLOGICAL': '#06b6d4',
                'SUPPLY': '#6b7280'
            };
            return colors[category] || '#6b7280';
        }

        /**
         * Show modal to add a new product
         */
        function showAddProductModal() {
            const modal = document.getElementById('fertigationModal'); // Reuse existing modal
            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3 style="margin: 0;">Add New Product</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.875rem;">Add a product to your inventory catalog</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form id="addProductForm" onsubmit="saveNewProduct(event)">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Product Name *</label>
                                    <input type="text" id="prodName" required placeholder="e.g., Entrust SC" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Category *</label>
                                    <select id="prodCategory" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        ${PRODUCT_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Manufacturer</label>
                                    <input type="text" id="prodManufacturer" placeholder="e.g., Corteva" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">OMRI Status *</label>
                                    <select id="prodOMRI" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        ${OMRI_STATUSES.map(s => `<option value="${s}">${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Unit</label>
                                    <select id="prodUnit" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="qt">Quart (qt)</option>
                                        <option value="gal">Gallon (gal)</option>
                                        <option value="lb">Pound (lb)</option>
                                        <option value="oz">Ounce (oz)</option>
                                        <option value="fl oz">Fluid Ounce (fl oz)</option>
                                        <option value="bag">Bag</option>
                                        <option value="pint">Pint</option>
                                        <option value="each">Each</option>
                                        <option value="pack">Pack</option>
                                        <option value="tray">Tray</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Cost per Unit ($)</label>
                                    <input type="number" step="0.01" id="prodCost" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Current Quantity</label>
                                    <input type="number" step="0.01" id="prodQty" value="0" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Reorder Point</label>
                                    <input type="number" step="0.01" id="prodReorder" value="0" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Storage Location</label>
                                    <select id="prodLocation" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">Select location...</option>
                                        ${STORAGE_LOCATIONS.map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Lot Number</label>
                                    <input type="text" id="prodLot" placeholder="Supplier's lot #" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                            </div>

                            <!-- Seed-specific fields -->
                            <div id="seedFields" style="display: none; margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem;">
                                <h4 style="margin: 0 0 0.75rem 0; color: #92400e;">Seed Information</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Seeds per Pack</label>
                                        <input type="number" id="prodSeedsPerPack" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    </div>
                                    <div class="form-group">
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Germination Rate (%)</label>
                                        <input type="number" id="prodGermRate" min="0" max="100" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: 1rem;">
                                <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Notes</label>
                                <textarea id="prodNotes" rows="2" placeholder="Application rates, storage notes, etc." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;"></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: 1px solid #e2e8f0; background: white; border-radius: 0.375rem; cursor: pointer;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem; background: #7c3aed; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 600;">Save Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';

            // Show/hide seed fields based on category
            document.getElementById('prodCategory').addEventListener('change', (e) => {
                document.getElementById('seedFields').style.display = e.target.value === 'SEED' ? 'block' : 'none';
            });
        }

        /**
         * Save a new product to inventory
         */
        async function saveNewProduct(event) {
            event.preventDefault();

            const productData = {
                Product_Name: document.getElementById('prodName').value,
                Category: document.getElementById('prodCategory').value,
                Manufacturer: document.getElementById('prodManufacturer').value,
                OMRI_Status: document.getElementById('prodOMRI').value,
                Unit: document.getElementById('prodUnit').value,
                Cost_Per_Unit: parseFloat(document.getElementById('prodCost').value) || 0,
                Current_Qty: parseFloat(document.getElementById('prodQty').value) || 0,
                Reorder_Point: parseFloat(document.getElementById('prodReorder').value) || 0,
                Location: document.getElementById('prodLocation').value,
                Lot_Number: document.getElementById('prodLot').value,
                Notes: document.getElementById('prodNotes').value,
                Active: true
            };

            // Add seed-specific fields if applicable
            if (productData.Category === 'SEED') {
                productData.Seeds_Per_Pack = parseInt(document.getElementById('prodSeedsPerPack').value) || 0;
                productData.Germination_Rate = parseInt(document.getElementById('prodGermRate').value) || 0;
            }

            const result = await syncToBackend('saveProduct', productData);

            if (result.success) {
                showToast('Product added to inventory!', 'success');
                closeFertigationModal();
                renderInventoryTab();
            } else {
                showToast('Failed to save product: ' + (result.error || 'Unknown error'), 'error');
            }
        }

        /**
         * Show modal to record a purchase (stock in)
         */
        function showRecordPurchaseModal() {
            const modal = document.getElementById('fertigationModal');
            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 500px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3 style="margin: 0;">Record Purchase</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.875rem;">Add stock to your inventory</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form onsubmit="recordPurchase(event)">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Product *</label>
                                <select id="purchaseProduct" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                    <option value="">Select product...</option>
                                    ${inventoryProducts.map(p => `<option value="${p.Product_ID}" data-unit="${p.Unit}">${p.Product_Name} (${p.Current_Qty} ${p.Unit} in stock)</option>`).join('')}
                                </select>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Quantity *</label>
                                    <input type="number" step="0.01" id="purchaseQty" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Date</label>
                                    <input type="date" id="purchaseDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Notes</label>
                                <input type="text" id="purchaseNotes" placeholder="Vendor, invoice #, etc." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: 1px solid #e2e8f0; background: white; border-radius: 0.375rem; cursor: pointer;">Cancel</button>
                                <button type="submit" class="btn btn-success" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 600;">Record Purchase</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        /**
         * Record a purchase transaction
         */
        async function recordPurchase(event) {
            event.preventDefault();

            const productId = document.getElementById('purchaseProduct').value;
            const qty = parseFloat(document.getElementById('purchaseQty').value);
            const date = document.getElementById('purchaseDate').value;
            const notes = document.getElementById('purchaseNotes').value;

            const result = await syncToBackend('recordTransaction', {
                productId: productId,
                type: 'PURCHASE',
                qty: qty, // Positive for purchase
                date: date,
                notes: notes
            });

            if (result.success) {
                showToast(`Added ${qty} to inventory!`, 'success');
                closeFertigationModal();
                renderInventoryTab();
            } else {
                showToast('Failed to record purchase: ' + (result.error || 'Unknown error'), 'error');
            }
        }

        /**
         * Show quick adjust modal for a product
         */
        function showQuickAdjustModal(productId) {
            const product = inventoryProducts.find(p => p.Product_ID === productId);
            if (!product) return;

            const modal = document.getElementById('fertigationModal');
            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 400px; width: 95%;">
                    <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3 style="margin: 0;">Adjust Inventory</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.875rem;">${product.Product_Name}</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div style="font-size: 2rem; font-weight: 700;">${product.Current_Qty} ${product.Unit}</div>
                            <div style="color: #6b7280;">Current Stock</div>
                        </div>
                        <form onsubmit="quickAdjustInventory(event, '${productId}')">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Adjustment (+/-)</label>
                                <input type="number" step="0.01" id="adjustQty" required placeholder="e.g., -2 or +5" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; font-size: 1.25rem; text-align: center;">
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Reason</label>
                                <input type="text" id="adjustReason" placeholder="e.g., Spoilage, count correction" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: 1px solid #e2e8f0; background: white; border-radius: 0.375rem; cursor: pointer;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem; background: #6366f1; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 600;">Adjust</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        /**
         * Quick adjust inventory quantity
         */
        async function quickAdjustInventory(event, productId) {
            event.preventDefault();

            const qty = parseFloat(document.getElementById('adjustQty').value);
            const reason = document.getElementById('adjustReason').value;

            const result = await syncToBackend('adjustInventory', {
                productId: productId,
                qty: qty,
                reason: reason
            });

            if (result.success) {
                showToast('Inventory adjusted!', 'success');
                closeFertigationModal();
                renderInventoryTab();
            } else {
                showToast('Failed to adjust: ' + (result.error || 'Unknown error'), 'error');
            }
        }

        /**
         * Show product transaction history
         */
        async function showProductHistory(productId) {
            const product = inventoryProducts.find(p => p.Product_ID === productId);
            if (!product) return;

            const result = await loadFromBackend('getTransactionHistory', { productId: productId });

            const modal = document.getElementById('fertigationModal');
            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3 style="margin: 0;">${product.Product_Name}</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.875rem;">Transaction History</p>
                    </div>
                    <div style="padding: 1.5rem;">
                        ${result.success && result.data.length > 0 ? `
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 0.5rem; text-align: left;">Date</th>
                                        <th style="padding: 0.5rem; text-align: left;">Type</th>
                                        <th style="padding: 0.5rem; text-align: right;">Qty</th>
                                        <th style="padding: 0.5rem; text-align: left;">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.data.map(t => `
                                        <tr style="border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.5rem;">${t.Date}</td>
                                            <td style="padding: 0.5rem;">
                                                <span style="background: ${t.Transaction_Type === 'PURCHASE' ? '#10b981' : t.Transaction_Type === 'APPLICATION' ? '#ef4444' : '#6b7280'}; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                                    ${t.Transaction_Type}
                                                </span>
                                            </td>
                                            <td style="padding: 0.5rem; text-align: right; color: ${parseFloat(t.Qty) >= 0 ? '#10b981' : '#ef4444'};">
                                                ${parseFloat(t.Qty) >= 0 ? '+' : ''}${t.Qty}
                                            </td>
                                            <td style="padding: 0.5rem; color: #6b7280;">${t.Notes || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                No transactions recorded yet
                            </div>
                        `}
                        <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: 1px solid #e2e8f0; background: white; border-radius: 0.375rem; cursor: pointer;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        /**
         * Show edit product modal
         */
        function showEditProductModal(productId) {
            const product = inventoryProducts.find(p => p.Product_ID === productId);
            if (!product) return;

            const modal = document.getElementById('fertigationModal');
            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.5rem; border-radius: 1rem 1rem 0 0;">
                        <h3 style="margin: 0;">Edit Product</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <form onsubmit="updateProduct(event, '${productId}')">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Product Name *</label>
                                    <input type="text" id="editProdName" value="${product.Product_Name || ''}" required style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Category</label>
                                    <select id="editProdCategory" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        ${PRODUCT_CATEGORIES.map(cat => `<option value="${cat}" ${product.Category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Manufacturer</label>
                                    <input type="text" id="editProdManufacturer" value="${product.Manufacturer || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">OMRI Status</label>
                                    <select id="editProdOMRI" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        ${OMRI_STATUSES.map(s => `<option value="${s}" ${product.OMRI_Status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Unit</label>
                                    <select id="editProdUnit" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        ${['qt', 'gal', 'lb', 'oz', 'fl oz', 'bag', 'pint', 'each', 'pack', 'tray'].map(u =>
                                            `<option value="${u}" ${product.Unit === u ? 'selected' : ''}>${u}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Cost per Unit ($)</label>
                                    <input type="number" step="0.01" id="editProdCost" value="${product.Cost_Per_Unit || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Reorder Point</label>
                                    <input type="number" step="0.01" id="editProdReorder" value="${product.Reorder_Point || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Location</label>
                                    <select id="editProdLocation" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
                                        <option value="">Select...</option>
                                        ${STORAGE_LOCATIONS.map(loc => `<option value="${loc}" ${product.Location === loc ? 'selected' : ''}>${loc}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Notes</label>
                                <textarea id="editProdNotes" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;">${product.Notes || ''}</textarea>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeFertigationModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; border: 1px solid #e2e8f0; background: white; border-radius: 0.375rem; cursor: pointer;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem; background: #7c3aed; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 600;">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        /**
         * Update an existing product
         */
        async function updateProduct(event, productId) {
            event.preventDefault();

            const productData = {
                Product_ID: productId,
                Product_Name: document.getElementById('editProdName').value,
                Category: document.getElementById('editProdCategory').value,
                Manufacturer: document.getElementById('editProdManufacturer').value,
                OMRI_Status: document.getElementById('editProdOMRI').value,
                Unit: document.getElementById('editProdUnit').value,
                Cost_Per_Unit: parseFloat(document.getElementById('editProdCost').value) || 0,
                Reorder_Point: parseFloat(document.getElementById('editProdReorder').value) || 0,
                Location: document.getElementById('editProdLocation').value,
                Notes: document.getElementById('editProdNotes').value
            };

            const result = await syncToBackend('saveProduct', productData);

            if (result.success) {
                showToast('Product updated!', 'success');
                closeFertigationModal();
                renderInventoryTab();
            } else {
                showToast('Failed to update: ' + (result.error || 'Unknown error'), 'error');
            }
        }

        /**
         * Get products for dropdown (for use in other forms like compliance)
         */
        function getInventoryDropdownOptions(category = null) {
            let filtered = inventoryProducts.filter(p => p.Active !== false && p.Active !== 'false');
            if (category) {
                filtered = filtered.filter(p => p.Category === category);
            }
            return filtered.map(p => ({
                value: p.Product_ID,
                label: p.Product_Name,
                omriStatus: p.OMRI_Status,
                unit: p.Unit,
                currentQty: p.Current_Qty
            }));
        }

    </script>
</body>
</html>
