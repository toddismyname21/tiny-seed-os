<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2d5a27">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Field App">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <title>Tiny Seed - Field App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkAfsMpi7Arqb43gBAitN0WEUs4V13N8Y" async defer></script>
    <!-- QR/Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* ========================================
           CSS DESIGN SYSTEM - HIGH CONTRAST THEME
           ======================================== */
        :root {
            --primary: #2d5a27;
            --primary-light: #4a7c43;
            --primary-dark: #1e3d1a;
            --secondary: #f4a261;
            --success: #22c55e;
            --success-bg: rgba(34, 197, 94, 0.15);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.15);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.15);
            --info: #3b82f6;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-elevated: #334155;
            --bg-input: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.1);
            --border-active: rgba(74, 124, 67, 0.5);
            --touch-min: 48px;
            --touch-comfortable: 56px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========================================
           MOBILE UX - FIELD-FRIENDLY TOUCH TARGETS
           All buttons & inputs min 48px for gloved hands
           ======================================== */
        button,
        .btn,
        [type="submit"],
        [type="button"],
        .action-btn,
        .nav-btn,
        .tab-btn {
            min-height: var(--touch-min);
            min-width: var(--touch-min);
            touch-action: manipulation;
        }

        input[type="text"],
        input[type="number"],
        input[type="tel"],
        input[type="email"],
        input[type="password"],
        input[type="search"],
        input[type="date"],
        textarea,
        select {
            min-height: var(--touch-min);
            font-size: 16px; /* Prevents iOS zoom */
            touch-action: manipulation;
        }

        /* Large action buttons for primary actions */
        .task-complete-btn,
        .submit-btn,
        .primary-action {
            min-height: var(--touch-comfortable) !important;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Ensure no horizontal scroll on mobile */
        .tab-content,
        .panel-content,
        .modal-body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        /* Thumb-friendly spacing */
        .button-group,
        .action-row {
            gap: 12px;
        }

        /* Full-width action buttons for mobile */
        .task-actions button,
        .form-actions button,
        .modal-actions button {
            width: 100%;
            min-height: var(--touch-comfortable);
        }

        /* Larger click/tap areas for list items */
        .task-item,
        .route-stop,
        .inventory-item,
        .pick-item {
            padding: 16px;
            margin-bottom: 12px;
        }

        /* Big tappable checkboxes and toggles */
        .checkbox-wrapper,
        .toggle-wrapper,
        .radio-wrapper {
            min-height: var(--touch-min);
            min-width: var(--touch-min);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Cards should have generous padding */
        .card,
        .panel,
        .info-box {
            padding: 16px;
        }

        /* Modals full-screen on mobile */
        @media (max-width: 480px) {
            .modal-content,
            .popup-content {
                width: 100% !important;
                max-width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }
        }

        /* Screen Management */
        .screen {
            display: none;
            min-height: 100vh;
        }
        .screen.active {
            display: block;
        }

        /* ========================================
           LOGIN SCREEN
           ======================================== */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(180deg, var(--bg-dark) 0%, #1a2744 100%);
        }

        .login-logo {
            font-size: 3rem;
            margin-bottom: 8px;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 40px;
            color: var(--text-primary);
        }

        .pin-display {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            transition: all 0.2s;
        }

        .pin-dot.filled {
            background: var(--primary-light);
            border-color: var(--primary-light);
        }

        .pin-dot.error {
            background: var(--danger);
            border-color: var(--danger);
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 280px;
        }

        .pin-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .pin-btn:active {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(0.95);
        }

        .pin-btn.empty {
            visibility: hidden;
        }

        .pin-btn.delete {
            font-size: 1.25rem;
        }

        .login-error {
            color: var(--danger);
            margin-top: 20px;
            font-size: 0.9rem;
            min-height: 24px;
        }

        .login-hint {
            color: var(--text-secondary);
            margin-top: 30px;
            font-size: 0.85rem;
        }

        .register-link {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 24px;
            cursor: pointer;
            padding: 10px 20px;
        }

        .register-link span {
            color: var(--primary-light);
            font-weight: 600;
            text-decoration: underline;
        }

        /* ========================================
           REGISTRATION SCREEN
           ======================================== */
        .registration-screen {
            padding: 30px 24px;
            max-width: 400px;
            margin: 0 auto;
            padding-top: calc(30px + var(--safe-top));
        }

        .registration-back {
            position: absolute;
            top: calc(16px + var(--safe-top));
            left: 16px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .registration-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 30px;
        }

        .registration-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .registration-form .form-input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 16px;
            width: 100%;
        }

        .registration-form .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .registration-form .form-input.pin-input {
            text-align: center;
            font-size: 24px;
            letter-spacing: 8px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .registration-form .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: block;
        }

        .registration-submit {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .registration-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .registration-note {
            margin-top: 24px;
            padding: 16px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .registration-note i {
            color: var(--info);
            margin-top: 2px;
        }

        /* Registration Success */
        .registration-success {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 24px;
            text-align: center;
        }

        .registration-success .success-icon {
            width: 100px;
            height: 100px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .registration-success .success-icon i {
            font-size: 50px;
            color: var(--success);
        }

        .registration-success h1 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .registration-success p {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.5;
            max-width: 280px;
            margin-bottom: 30px;
        }

        .registration-done-btn {
            padding: 14px 28px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Admin Approval Panel */
        .admin-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        .admin-panel.visible {
            display: block;
        }

        .admin-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .admin-panel-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-panel-title i {
            font-size: 20px;
        }

        .pending-badge {
            background: var(--warning);
            color: #000;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .pending-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pending-item {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .pending-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .pending-item-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .pending-item-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .pending-item-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .pending-item-info span {
            display: block;
            margin-bottom: 4px;
        }

        .pending-item-actions {
            display: flex;
            gap: 10px;
        }

        .pending-item-actions button {
            flex: 1;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .approve-btn {
            background: var(--success);
            color: white;
        }

        .approve-btn:active {
            background: #16a34a;
        }

        .reject-btn {
            background: var(--bg-card);
            border: 1px solid var(--border) !important;
            color: var(--text-secondary);
        }

        .reject-btn:active {
            background: var(--danger);
            color: white;
            border-color: var(--danger) !important;
        }

        .no-pending {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
        }

        .no-pending i {
            font-size: 40px;
            margin-bottom: 12px;
            color: var(--success);
        }

        .no-pending p {
            font-size: 15px;
        }

        /* ========================================
           MAIN APP LAYOUT
           ======================================== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(56px + var(--safe-top));
            padding-top: var(--safe-top);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 16px;
            padding-right: 16px;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .header-info {
            display: flex;
            flex-direction: column;
        }

        .header-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .header-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .header-status.clocked-in {
            color: var(--success);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:active {
            background: var(--primary);
        }

        .header-btn.lang-toggle {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .sync-btn-wrapper {
            position: relative;
            display: inline-block;
        }

        .sync-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .sync-badge.visible {
            display: flex;
        }

        .offline-indicator {
            position: fixed;
            top: calc(56px + var(--safe-top));
            left: 0;
            right: 0;
            background: var(--warning);
            color: #000;
            padding: 8px 16px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            display: none;
            z-index: 99;
        }

        .offline-indicator.visible {
            display: block;
        }

        .main-content {
            margin-top: calc(56px + var(--safe-top));
            margin-bottom: calc(64px + var(--safe-bottom));
            padding: 16px;
            min-height: calc(100vh - 56px - 64px - var(--safe-top) - var(--safe-bottom));
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* ========================================
           BOTTOM TAB BAR
           ======================================== */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(64px + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 100;
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
            min-height: 64px;
        }

        .tab-item i {
            font-size: 1.25rem;
        }

        .tab-item.active {
            color: var(--primary-light);
        }

        .tab-item .tab-badge {
            position: absolute;
            top: 8px;
            right: calc(50% - 20px);
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* ========================================
           HOME TAB - CLOCK & DASHBOARD
           ======================================== */
        .clock-card {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            text-align: center;
        }

        .clock-time {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .clock-date {
            color: rgba(255,255,255,0.8);
            margin-bottom: 20px;
        }

        .clock-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .clock-btn.clock-in {
            background: var(--success);
            color: white;
        }

        .clock-btn.clock-out {
            background: var(--danger);
            color: white;
        }

        .clock-btn:active {
            transform: scale(0.98);
        }

        .clock-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .hours-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .hours-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .hours-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .hours-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Messages Section */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--info);
        }

        .message-card.urgent {
            border-left-color: var(--danger);
            background: var(--danger-bg);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-from {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .message-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* ========================================
           TASKS TAB
           ======================================== */
        .task-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .task-filter {
            padding: 10px 16px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .task-filter.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .task-filter .count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 6px;
            font-size: 0.75rem;
        }

        .task-group {
            margin-bottom: 20px;
        }

        .task-group-header {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .task-card.overdue {
            border-color: var(--danger);
            background: var(--danger-bg);
        }

        .task-checkbox {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .task-checkbox i {
            opacity: 0;
            color: white;
            font-size: 0.8rem;
        }

        .task-checkbox:active,
        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .task-checkbox.checked i {
            opacity: 1;
        }

        .task-info {
            flex: 1;
            min-width: 0;
        }

        .task-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .task-type-badge.sow {
            background: rgba(74, 124, 67, 0.3);
            color: var(--primary-light);
        }

        .task-type-badge.transplant {
            background: rgba(42, 157, 143, 0.3);
            color: #2a9d8f;
        }

        .task-type-badge.harvest {
            background: rgba(244, 162, 97, 0.3);
            color: var(--secondary);
        }

        .task-type-badge.scout {
            background: rgba(59, 130, 246, 0.3);
            color: var(--info);
        }

        .task-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .task-meta i {
            margin-right: 4px;
        }

        .task-complete-btn {
            width: var(--touch-min);
            height: var(--touch-min);
            border-radius: 10px;
            border: none;
            background: var(--success);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .task-complete-btn:active {
            transform: scale(0.95);
        }

        /* ========================================
           HARVEST TAB
           ======================================== */
        .form-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .form-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .form-card-header i {
            color: var(--primary-light);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            min-height: var(--touch-min);
            padding: 12px 16px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
        }

        .quality-buttons {
            display: flex;
            gap: 10px;
        }

        .quality-btn {
            flex: 1;
            height: var(--touch-min);
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-secondary);
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quality-btn.active {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .photo-capture-btn {
            width: 100%;
            height: 100px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            background: var(--bg-dark);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-capture-btn:active {
            border-color: var(--primary-light);
            color: var(--primary-light);
        }

        .photo-capture-btn i {
            font-size: 1.5rem;
        }

        .photo-preview {
            position: relative;
            margin-top: 10px;
        }

        .photo-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
        }

        .photo-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: none;
            cursor: pointer;
        }

        .voice-input-wrapper {
            position: relative;
        }

        .voice-input-wrapper textarea {
            padding-right: 50px;
        }

        .voice-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
        }

        .voice-btn.recording {
            background: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
        }

        .btn-primary {
            width: 100%;
            height: var(--touch-comfortable);
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .recent-harvests {
            margin-top: 20px;
        }

        .harvest-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .harvest-item:last-child {
            border-bottom: none;
        }

        .harvest-info h4 {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .harvest-info span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .harvest-qty {
            text-align: right;
        }

        .harvest-qty .amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success);
        }

        .harvest-qty .time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ========================================
           SCOUT TAB
           ======================================== */

        /* Scout Hero Camera Section */
        .scout-hero {
            padding: 16px;
            text-align: center;
        }

        .scout-camera-hero {
            width: 100%;
            padding: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            border-radius: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(45, 90, 39, 0.4);
        }

        .scout-camera-hero:active {
            transform: scale(0.98);
        }

        .camera-icon-large {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }

        .camera-text {
            flex: 1;
            text-align: left;
        }

        .camera-title {
            display: block;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .camera-subtitle {
            display: block;
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .scout-gps-status {
            margin-top: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .scout-gps-status i {
            color: var(--success);
        }

        /* Scout Type Pills (Simplified) */
        .scout-type-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .scout-pill {
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .scout-pill.pest { --pill-color: var(--danger); }
        .scout-pill.disease { --pill-color: var(--warning); }
        .scout-pill.weed { --pill-color: #8b5cf6; }
        .scout-pill.beneficial { --pill-color: var(--success); }

        .scout-pill.active {
            border-color: var(--pill-color, var(--primary));
            background: rgba(255,255,255,0.05);
            color: var(--pill-color, var(--primary));
        }

        .scout-pill i {
            font-size: 0.9rem;
        }

        /* Severity Quick Buttons */
        .severity-quick {
            display: flex;
            gap: 8px;
        }

        .severity-quick .severity-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.85rem;
        }

        .severity-quick .severity-btn i {
            margin-right: 6px;
            font-size: 0.6rem;
        }

        /* Legacy Scout Grid */
        .scout-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .scout-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .scout-type-btn i {
            font-size: 1.75rem;
            margin-bottom: 8px;
        }

        .scout-type-btn span {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .scout-type-btn.active {
            border-color: var(--primary-light);
            background: rgba(74, 124, 67, 0.15);
            color: var(--primary-light);
        }

        .scout-type-btn.pest { --type-color: var(--danger); }
        .scout-type-btn.disease { --type-color: var(--warning); }
        .scout-type-btn.weed { --type-color: #8b5cf6; }
        .scout-type-btn.beneficial { --type-color: var(--success); }
        .scout-type-btn.wildlife { --type-color: var(--secondary); }
        .scout-type-btn.other { --type-color: var(--info); }

        .scout-type-btn.active {
            border-color: var(--type-color);
            color: var(--type-color);
        }

        /* Pest/Scouting Map */
        .pest-map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-elevated);
            margin-bottom: 16px;
        }

        .pest-map-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .map-filter-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .map-filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .map-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-top: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .hotspot-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .severity-buttons {
            display: flex;
            gap: 8px;
        }

        .severity-btn {
            flex: 1;
            padding: 12px 8px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .severity-btn.low.active {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .severity-btn.medium.active {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        .severity-btn.high.active {
            background: rgba(249, 115, 22, 0.2);
            border-color: #f97316;
            color: #f97316;
        }

        .severity-btn.critical.active {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            color: var(--danger);
        }

        .ai-diagnosis-btn {
            width: 100%;
            padding: 20px;
            border-radius: 12px;
            border: 2px dashed var(--info);
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .ai-diagnosis-btn i {
            font-size: 2rem;
        }

        .ai-diagnosis-btn span {
            font-weight: 600;
        }

        .ai-diagnosis-btn small {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* ========================================
           MORE TAB
           ======================================== */
        .more-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .more-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .more-item:active {
            background: var(--bg-elevated);
        }

        .more-item-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .more-item-icon.treatment { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .more-item-icon.hazard { background: var(--danger-bg); color: var(--danger); }
        .more-item-icon.weed { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .more-item-icon.cultivation { background: rgba(244, 162, 97, 0.2); color: var(--secondary); }
        .more-item-icon.settings { background: var(--bg-elevated); color: var(--text-secondary); }

        .more-item-text {
            flex: 1;
        }

        .more-item-text h3 {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .more-item-text p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .more-item i.fa-chevron-right {
            color: var(--text-muted);
        }

        /* ========================================
           TOAST NOTIFICATIONS
           ======================================== */
        .toast {
            position: fixed;
            bottom: calc(80px + var(--safe-bottom));
            left: 16px;
            right: 16px;
            padding: 16px 20px;
            background: var(--bg-elevated);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }

        .toast-message {
            flex: 1;
            font-size: 0.9rem;
        }

        /* ========================================
           LOADING OVERLAY
           ======================================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================
           EMPTY STATES
           ======================================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 0.9rem;
        }

        /* ========================================
           CAMERA MODAL
           ======================================== */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 3000;
            display: none;
        }

        .camera-modal.visible {
            display: flex;
            flex-direction: column;
        }

        .camera-preview {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-preview video,
        .camera-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .camera-controls {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .camera-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .camera-btn.capture {
            width: 70px;
            height: 70px;
            background: white;
            color: #000;
        }

        .camera-btn.cancel {
            background: var(--bg-elevated);
            color: white;
        }

        .camera-btn.confirm {
            background: var(--success);
            color: white;
        }

        /* ========================================
           AI PLANT DOCTOR MODAL
           ======================================== */
        .ai-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .ai-modal.visible {
            display: flex;
        }

        .ai-modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--bg-elevated);
        }

        .ai-modal-header h2 {
            font-size: 1.2rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-modal-header h2 i {
            color: var(--primary-light);
        }

        .ai-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
        }

        .ai-step {
            padding: 24px 20px;
        }

        .ai-instructions {
            text-align: center;
            padding: 20px 0;
        }

        .ai-instructions i {
            font-size: 3rem;
            color: var(--primary-light);
            margin-bottom: 16px;
        }

        .ai-instructions h3 {
            font-size: 1.3rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .ai-instructions p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .ai-photo-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .ai-option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: var(--bg-elevated);
            border: 2px solid transparent;
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-option-btn:active {
            border-color: var(--primary-light);
            background: var(--primary);
        }

        .ai-option-btn i {
            font-size: 2rem;
            color: var(--primary-light);
        }

        .ai-photo-preview {
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .ai-photo-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            background: #000;
        }

        .ai-mode-select {
            margin-bottom: 20px;
        }

        .ai-mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .ai-mode-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            background: var(--bg-elevated);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-mode-btn.active {
            border-color: var(--primary-light);
            background: var(--primary);
        }

        .ai-mode-btn i {
            font-size: 1.2rem;
        }

        .ai-actions {
            display: flex;
            gap: 12px;
        }

        .ai-actions button {
            flex: 1;
        }

        .btn-primary, .btn-secondary {
            padding: 14px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-light);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .ai-analyzing {
            text-align: center;
            padding: 40px 20px;
        }

        .ai-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-elevated);
            border-top-color: var(--primary-light);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ai-analyzing h3 {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .ai-analyzing p {
            color: var(--text-secondary);
        }

        .ai-results {
            padding: 0;
        }

        .ai-result-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .ai-result-header.disease {
            border-left: 4px solid var(--danger);
        }

        .ai-result-header.pest {
            border-left: 4px solid var(--warning);
        }

        .ai-result-header.healthy {
            border-left: 4px solid var(--success);
        }

        .ai-result-header.beneficial {
            border-left: 4px solid #22d3ee;
        }

        .ai-result-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .ai-result-header.disease .ai-result-icon {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .ai-result-header.pest .ai-result-icon {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .ai-result-header.healthy .ai-result-icon {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .ai-result-header.beneficial .ai-result-icon {
            background: rgba(34, 211, 238, 0.2);
            color: #22d3ee;
        }

        .ai-result-title h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .ai-confidence {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .ai-result-card {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .ai-result-card h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-result-card p {
            color: var(--text-primary);
            line-height: 1.5;
        }

        .ai-result-card.beneficial {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.3);
        }

        .ai-result-card.beneficial h4 {
            color: #22d3ee;
        }

        .ai-result-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .ai-result-actions button {
            flex: 1;
        }

        /* ========================================
           FEATURE MODALS (Treatment, Hazard, etc.)
           ======================================== */
        .feature-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 2500;
            display: none;
            flex-direction: column;
        }

        .feature-modal.visible {
            display: flex;
        }

        .feature-modal-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .feature-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--bg-elevated);
        }

        .feature-modal-header h2 {
            font-size: 1.1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
        }

        .feature-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* REI Warnings */
        .rei-warnings {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .warning-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--danger);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .rei-warning-item {
            background: var(--bg-card);
            padding: 10px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        /* Material Info */
        .material-info {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .omri-badge {
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .rei-info, .phi-info {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Weather, Implement, Depth Buttons */
        .weather-buttons, .depth-buttons, .soil-buttons, .effectiveness-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .weather-btn, .depth-btn, .soil-btn, .eff-btn {
            flex: 1;
            min-width: 60px;
            padding: 12px;
            background: var(--bg-elevated);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .depth-btn, .soil-btn, .eff-btn {
            font-size: 0.85rem;
        }

        .weather-btn.active, .depth-btn.active, .soil-btn.active, .eff-btn.active {
            border-color: var(--primary-light);
            background: var(--primary);
        }

        /* Hazard Type Grid */
        .hazard-type-grid, .weed-type-grid, .implement-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .hazard-type-btn, .weed-type-btn, .implement-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--bg-elevated);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
            text-align: center;
        }

        .hazard-type-btn i, .implement-btn i {
            font-size: 1.3rem;
            color: var(--text-secondary);
        }

        .hazard-type-btn.active, .weed-type-btn.active, .implement-btn.active {
            border-color: var(--primary-light);
            background: var(--primary);
        }

        .hazard-type-btn.active i, .implement-btn.active i {
            color: var(--text-primary);
        }

        /* Active Hazards */
        .active-hazards {
            margin-bottom: 16px;
        }

        .active-hazards h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .hazard-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            border-left: 4px solid var(--warning);
        }

        .hazard-card.critical {
            border-left-color: var(--danger);
        }

        .hazard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .hazard-card-type {
            font-weight: 600;
            color: var(--text-primary);
        }

        .hazard-card-severity {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--warning);
            color: #000;
        }

        .hazard-card-severity.critical {
            background: var(--danger);
            color: white;
        }

        .hazard-card-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Pressure Slider */
        .pressure-slider {
            padding: 10px 0;
        }

        .pressure-slider input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-elevated);
            outline: none;
            -webkit-appearance: none;
        }

        .pressure-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
        }

        .pressure-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .pressure-value {
            text-align: center;
            margin-top: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Submit Button Variants */
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 16px;
        }

        .submit-btn.secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .submit-btn.danger {
            background: var(--danger);
        }

        .submit-btn:active {
            opacity: 0.8;
        }

        /* Messages */
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--primary-light);
        }

        .message-card.urgent {
            border-left-color: var(--danger);
        }

        .message-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-from {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .message-content {
            color: var(--text-primary);
            line-height: 1.5;
        }

        .message-ack {
            margin-top: 12px;
        }

        .message-ack button {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .empty-messages {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-messages i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Safety Alert */
        .safety-alert {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            z-index: 2000;
        }

        .safety-alert-content {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .safety-icon {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .safety-message {
            flex: 1;
        }

        .safety-message h3 {
            color: white;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .safety-message p {
            color: rgba(255,255,255,0.9);
            font-size: 0.85rem;
        }

        .safety-dismiss {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* =====================================================
           WILDLIFE TRACKER STYLES
           ===================================================== */
        .wildlife-tabs, .pickpack-tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-card);
            overflow-x: auto;
        }

        .wildlife-tab, .pickpack-tab {
            flex: 1;
            min-width: 70px;
            padding: 10px 12px;
            border: none;
            border-radius: 10px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .wildlife-tab.active, .pickpack-tab.active {
            background: var(--primary);
            color: var(--text-primary);
        }

        .wildlife-tab i, .pickpack-tab i {
            font-size: 1.1rem;
        }

        .wildlife-form-panel, .pickpack-panel {
            padding: 16px;
        }

        .animal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .animal-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--bg-elevated);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .animal-btn.active {
            border-color: var(--primary-light);
            background: var(--primary);
        }

        .den-size-buttons, .activity-level-buttons {
            display: flex;
            gap: 10px;
        }

        .den-size-btn, .activity-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 10px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
        }

        .den-size-btn.active, .activity-btn.active {
            border-color: var(--primary-light);
            background: var(--primary);
        }

        .dens-list {
            margin-top: 12px;
        }

        .den-card {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #8b4513;
        }

        .den-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .den-activity {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--warning);
            color: #000;
        }

        .den-activity.high {
            background: var(--danger);
            color: white;
        }

        .den-activity.low {
            background: var(--success);
            color: white;
        }

        .den-meta {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .severity-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .severity-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 10px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .severity-btn.active.low { border-color: var(--success); background: rgba(34, 197, 94, 0.2); }
        .severity-btn.active.medium { border-color: var(--warning); background: rgba(245, 158, 11, 0.2); }
        .severity-btn.active.high { border-color: var(--danger); background: rgba(239, 68, 68, 0.2); }
        .severity-btn.active.critical { border-color: #7c0000; background: rgba(124, 0, 0, 0.3); }

        .submit-btn.danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .wildlife-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .summary-card {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 12px;
        }

        .summary-animal {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .summary-stats {
            display: flex;
            flex-direction: column;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .damage-list {
            margin-top: 12px;
        }

        .damage-item {
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--danger);
        }

        .damage-crop {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .damage-details {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .total-loss {
            background: var(--danger);
            color: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            margin-top: 12px;
        }

        /* =====================================================
           PICK & PACK STYLES
           ===================================================== */
        .pick-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .pick-date {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .refresh-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
        }

        .pick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .pick-stat {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .pick-stat .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .pick-stat .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .pick-items-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pick-field-group {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .field-header {
            background: var(--bg-elevated);
            padding: 10px 14px;
            font-weight: 600;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .field-count {
            margin-left: auto;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: normal;
        }

        .pick-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border-bottom: 1px solid var(--border);
        }

        .pick-item:last-child {
            border-bottom: none;
        }

        .pick-item.completed {
            opacity: 0.6;
        }

        .pick-item.completed .pick-crop {
            text-decoration: line-through;
        }

        .pick-item-check {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .pick-item.completed .pick-item-check {
            color: var(--success);
        }

        .pick-item-check i {
            font-size: 1.3rem;
        }

        .pick-item-info {
            flex: 1;
        }

        .pick-crop {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .pick-details {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .pick-item-qty {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .pack-header {
            margin-bottom: 16px;
        }

        .pack-header h3 {
            color: var(--text-primary);
            margin: 0;
        }

        .pack-orders-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pack-order-card {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .pack-order-header {
            background: var(--bg-elevated);
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-id {
            font-weight: 600;
            color: var(--primary-light);
        }

        .customer-name {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pack-order-items {
            padding: 12px 14px;
        }

        .pack-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .pack-item:last-child {
            border-bottom: none;
        }

        .pack-btn {
            width: 100%;
            padding: 14px;
            border: none;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state small {
            display: block;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .pick-header-actions {
            display: flex;
            gap: 8px;
        }

        .print-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* =====================================================
           PRINT STYLES
           ===================================================== */
        /* ========================================
           DELIVERY MODE STYLES
           ======================================== */
        .delivery-badge {
            background: var(--success);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: auto;
            margin-right: 8px;
        }

        .delivery-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }

        .summary-stat .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .delivery-route-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .delivery-stop {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .delivery-stop:active {
            transform: scale(0.98);
        }

        .delivery-stop.completed {
            opacity: 0.6;
        }

        .stop-number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .delivery-stop.completed .stop-number {
            background: var(--success);
        }

        .delivery-stop.completed .stop-number::after {
            content: '';
        }

        .stop-info {
            flex: 1;
            min-width: 0;
        }

        .stop-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stop-address-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stop-items-count {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .navigate-btn {
            width: 44px;
            height: 44px;
            background: var(--secondary);
            border: none;
            border-radius: 10px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Route Action Buttons */
        .route-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
            padding: 0 4px;
        }

        .route-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .route-action-btn.start-route {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .route-action-btn.start-route:active {
            transform: scale(0.98);
            background: linear-gradient(135deg, #059669, #047857);
        }

        .route-action-btn.start-route.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .route-action-btn.start-route.active i::before {
            content: "\f04d"; /* Stop icon */
        }

        .route-action-btn.running-behind {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .route-action-btn.running-behind:active {
            transform: scale(0.98);
            background: linear-gradient(135deg, #d97706, #b45309);
        }

        .route-action-btn i {
            font-size: 1.1rem;
        }

        /* Contact Buttons in Modal */
        .stop-contact-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .contact-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .contact-btn i {
            font-size: 1.25rem;
        }

        .contact-btn.call {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .contact-btn.text {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .contact-btn.email {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .contact-btn.navigate {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .contact-btn:active {
            transform: scale(0.95);
        }

        /* Contact inline buttons for stop cards */
        .stop-contact-inline {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .stop-contact-inline .contact-mini-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stop-contact-inline .contact-mini-btn:active {
            transform: scale(0.9);
        }

        .stop-contact-inline .contact-mini-btn.call {
            background: #10b981;
            color: white;
        }

        .stop-contact-inline .contact-mini-btn.text {
            background: #3b82f6;
            color: white;
        }

        .stop-contact-inline .contact-mini-btn.email {
            background: #8b5cf6;
            color: white;
        }

        /* Delivery Modal */
        .delivery-modal {
            max-width: 500px;
        }

        .stop-address {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .stop-address i {
            color: var(--primary);
        }

        .stop-items {
            margin-bottom: 16px;
        }

        .stop-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .stop-notes {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--warning);
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 16px;
            font-size: 0.9rem;
            display: none;
        }

        .stop-notes.has-notes {
            display: block;
        }

        .pod-section {
            margin-bottom: 20px;
        }

        .pod-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .photo-capture {
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--bg-dark);
            border-radius: 12px;
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .photo-capture.has-photo {
            border-style: solid;
            border-color: var(--primary);
        }

        .photo-capture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .photo-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .retake-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        .signature-pad {
            width: 100%;
            height: 150px;
            background: white;
            border-radius: 12px;
            position: relative;
        }

        .signature-canvas {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        .signature-clear {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 6px 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .signature-line {
            position: absolute;
            bottom: 40px;
            left: 20px;
            right: 20px;
            height: 1px;
            background: #ccc;
        }

        .signature-label {
            position: absolute;
            bottom: 16px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 11px;
            color: #999;
        }

        .pod-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-complete-delivery {
            width: 100%;
            padding: 16px;
            background: var(--success);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 52px;
        }

        .btn-report-issue {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 2px solid var(--warning);
            border-radius: 12px;
            color: var(--warning);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
        }

        /* ========================================
           TIMESHEET STYLES
           ======================================== */
        .anomaly-warnings {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .warning-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--danger);
            margin-bottom: 12px;
        }

        .warning-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .warning-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .warning-item.overtime {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }

        .warning-item.overtime .warning-icon {
            color: var(--warning);
        }

        .warning-icon {
            color: var(--danger);
        }

        .pay-period-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .period-header .period-label {
            font-weight: 600;
        }

        .period-dates {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .period-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .period-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .period-stat .period-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .period-stat .period-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .period-stat.projected .period-value {
            color: var(--success);
        }

        .timesheet-section {
            margin-bottom: 16px;
        }

        .timesheet-section h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .timesheet-days {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .timesheet-day {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .day-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .day-name {
            font-weight: 600;
            width: 40px;
        }

        .day-date {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .day-hours {
            font-weight: 600;
        }

        .day-hours.overtime {
            color: var(--warning);
        }

        .day-times {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .qb-sync-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .sync-icon {
            width: 44px;
            height: 44px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6366f1;
            font-size: 1.25rem;
        }

        .sync-info {
            flex: 1;
        }

        .sync-label {
            display: block;
            font-weight: 600;
        }

        .sync-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .sync-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .sync-badge.synced {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .sync-badge.pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .sync-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #pickPackModal,
            #pickPackModal * {
                visibility: visible;
            }

            #pickPackModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
            }

            .feature-modal {
                position: static !important;
                background: white !important;
            }

            .feature-modal-content {
                max-width: 100% !important;
                height: auto !important;
                background: white !important;
                border-radius: 0 !important;
            }

            .feature-modal-header {
                background: white !important;
                color: black !important;
                border-bottom: 2px solid #333;
            }

            .feature-modal-header h2 {
                color: black !important;
            }

            .back-btn, .print-btn, .refresh-btn, .pickpack-tabs {
                display: none !important;
            }

            .pick-header {
                border-bottom: 1px solid #ccc;
                padding-bottom: 10px;
                margin-bottom: 10px;
            }

            .pick-date {
                color: black !important;
                font-size: 1.2rem;
            }

            .pick-stats {
                background: #f5f5f5 !important;
                padding: 10px;
                margin-bottom: 15px;
            }

            .pick-stat {
                background: white !important;
                border: 1px solid #ddd;
            }

            .pick-stat .stat-value {
                color: black !important;
            }

            .pick-stat .stat-label {
                color: #666 !important;
            }

            .pick-field-group {
                background: white !important;
                border: 1px solid #ddd;
                margin-bottom: 15px;
                page-break-inside: avoid;
            }

            .field-header {
                background: #f0f0f0 !important;
                color: black !important;
                font-size: 1rem;
                border-bottom: 1px solid #ddd;
            }

            .pick-item {
                border-bottom: 1px solid #eee !important;
                padding: 10px 14px;
            }

            .pick-item-check {
                width: 24px;
                height: 24px;
                border: 2px solid #333;
                border-radius: 4px;
            }

            .pick-item-check i {
                display: none;
            }

            .pick-item.completed .pick-item-check {
                background: #333;
            }

            .pick-crop, .pick-details, .pick-item-qty {
                color: black !important;
            }

            .pick-item-qty {
                font-size: 1.1rem;
                font-weight: bold;
            }
        }

        /* ========================================
           COSTING MODE - STATE OF THE ART
           Task UI with Big Buttons & Time Tracking
           ======================================== */

        /* Task Card v2 - Redesigned for gloves/outdoor */
        .task-card-v2 {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .task-card-v2.overdue {
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, var(--bg-card) 100%);
        }

        .task-card-v2.today {
            border-color: var(--warning);
        }

        .task-card-v2.costing-enabled {
            border-color: var(--info);
            position: relative;
        }

        .task-card-v2.timer-active {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .task-card-v2.completed {
            opacity: 0.6;
            transform: scale(0.98);
        }

        /* Priority Bar at top of card */
        .task-priority-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .task-priority-bar.overdue {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .task-priority-bar.today {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .task-priority-bar.upcoming {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        /* Costing Mode Badge */
        .costing-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid var(--info);
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--info);
            margin-left: auto;
        }

        .costing-badge i {
            font-size: 0.65rem;
        }

        /* Task Header with icon */
        .task-header-v2 {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .task-icon-v2 {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .task-icon-v2.seeding { background: rgba(74, 124, 67, 0.3); }
        .task-icon-v2.transplant { background: rgba(42, 157, 143, 0.3); }
        .task-icon-v2.harvest { background: rgba(244, 162, 97, 0.3); }
        .task-icon-v2.weed { background: rgba(139, 92, 246, 0.3); }
        .task-icon-v2.scout { background: rgba(59, 130, 246, 0.3); }

        .task-content-v2 {
            flex: 1;
            min-width: 0;
        }

        .task-type-v2 {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .task-title-v2 {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .task-details-v2 {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .task-details-v2 span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-details-v2 i {
            font-size: 0.9rem;
            width: 16px;
            text-align: center;
        }

        /* Benchmark hint */
        .task-benchmark {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--info);
        }

        .task-benchmark i {
            font-size: 0.85rem;
        }

        /* Timer Display */
        .task-timer-display {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 16px 0;
            padding: 16px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
            border: 2px solid var(--success);
            border-radius: 12px;
        }

        .task-timer-display.active {
            display: flex;
        }

        .timer-clock {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: var(--success);
            letter-spacing: 2px;
        }

        .timer-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .timer-pulse {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            animation: timerPulse 1.5s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Timer Controls */
        .timer-controls {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .timer-controls.active {
            display: grid;
        }

        .timer-btn {
            height: 48px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timer-btn:active {
            transform: scale(0.98);
        }

        .timer-btn.pause {
            border-color: var(--warning);
            color: var(--warning);
        }

        .timer-btn.pause:active {
            background: var(--warning);
            color: #000;
        }

        .timer-btn.cancel {
            border-color: var(--danger);
            color: var(--danger);
        }

        .timer-btn.cancel:active {
            background: var(--danger);
            color: white;
        }

        /* Start Timer Button */
        .start-timer-btn {
            width: 100%;
            height: 56px;
            border-radius: 12px;
            border: 2px dashed var(--info);
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .start-timer-btn:active {
            background: var(--info);
            color: white;
            border-style: solid;
        }

        .start-timer-btn.hidden {
            display: none;
        }

        /* BIG DONE BUTTON - 72px for gloves */
        .task-done-btn {
            width: 100%;
            height: 72px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
            color: white;
            font-size: 1.35rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .task-done-btn:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
        }

        .task-done-btn i {
            font-size: 1.5rem;
        }

        .task-done-btn.with-timer {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }

        /* Team Task Badge */
        .team-task-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            color: #60a5fa;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .team-task-badge i {
            font-size: 1rem;
        }

        /* Subtasks Section */
        .subtasks-section {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .subtasks-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .subtasks-header span {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .subtasks-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
        }

        .subtasks-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #16a34a);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .subtasks-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .subtask-item:active {
            transform: scale(0.98);
        }

        .subtask-item i {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .subtask-item.completed {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.3);
            cursor: default;
        }

        .subtask-item.completed i {
            color: var(--success);
        }

        .subtask-item.completed span {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        /* ========================================
           TUTORIAL MODE
           ======================================== */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .tutorial-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .tutorial-highlight {
            position: relative;
            z-index: 9999 !important;
            box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.6), 0 0 20px rgba(255, 140, 0, 0.4);
            border-radius: 12px;
        }

        .tutorial-bubble {
            position: fixed;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px 20px;
            max-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 140, 0, 0.3);
        }

        .tutorial-bubble.active {
            opacity: 1;
            transform: translateY(0);
        }

        .tutorial-bubble::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 140, 0, 0.3);
            border-right: none;
            border-bottom: none;
            transform: rotate(45deg);
        }

        .tutorial-bubble.arrow-bottom::before {
            bottom: -9px;
            left: 50%;
            margin-left: -8px;
            transform: rotate(-135deg);
        }

        .tutorial-bubble.arrow-top::before {
            top: -9px;
            left: 50%;
            margin-left: -8px;
            transform: rotate(45deg);
        }

        .tutorial-bubble.arrow-left::before {
            left: -9px;
            top: 50%;
            margin-top: -8px;
            transform: rotate(-45deg);
        }

        .tutorial-bubble.arrow-right::before {
            right: -9px;
            top: 50%;
            margin-top: -8px;
            transform: rotate(135deg);
        }

        .tutorial-bubble-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #ff9d1a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: white;
            font-size: 18px;
        }

        .tutorial-bubble-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .tutorial-bubble-text {
            font-size: 14px;
            color: #4a4a4a;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .tutorial-bubble-actions {
            display: flex;
            gap: 10px;
        }

        .tutorial-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tutorial-btn-next {
            background: linear-gradient(135deg, var(--primary), #ff9d1a);
            color: white;
        }

        .tutorial-btn-next:active {
            transform: scale(0.98);
        }

        .tutorial-btn-skip {
            background: #f0f0f0;
            color: #666;
        }

        .tutorial-progress {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
        }

        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s;
        }

        .tutorial-dot.active {
            background: var(--primary);
            width: 20px;
            border-radius: 4px;
        }

        .tutorial-dot.completed {
            background: var(--success);
        }

        /* Tutorial Toggle Button */
        .tutorial-toggle {
            position: fixed;
            bottom: 90px;
            right: 16px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #ff9d1a);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4);
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }

        .tutorial-toggle:active {
            transform: scale(0.95);
        }

        .tutorial-toggle.hidden {
            display: none;
        }

        /* Completion Animation Overlay */
        .completion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .completion-overlay.visible {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .completion-content {
            text-align: center;
            padding: 40px;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .completion-checkmark {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            animation: checkPop 0.5s ease 0.2s both;
        }

        @keyframes checkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .completion-checkmark i {
            font-size: 3rem;
            color: white;
        }

        .completion-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--success);
        }

        .completion-stats {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            min-width: 280px;
        }

        .completion-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .completion-stat:last-child {
            border-bottom: none;
        }

        .completion-stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .completion-stat-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .completion-stat-value.efficiency {
            color: var(--success);
        }

        .completion-stat-value.efficiency.warning {
            color: var(--warning);
        }

        .completion-undo {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .completion-undo:active {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .completion-continue {
            width: 100%;
            height: 56px;
            margin-top: 16px;
            border-radius: 12px;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Task Completion Animation */
        .task-card-v2.completing {
            animation: taskComplete 0.5s ease forwards;
        }

        @keyframes taskComplete {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; height: 0; padding: 0; margin: 0; }
        }

        /* Labor Reports Section */
        .labor-report-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .labor-report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .labor-report-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .labor-report-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .labor-report-badge.good {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .labor-report-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .labor-report-badge.danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .labor-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .labor-stat {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }

        .labor-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .labor-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Efficiency meter */
        .efficiency-meter {
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }

        .efficiency-meter-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .efficiency-meter-fill.excellent {
            background: linear-gradient(90deg, var(--success) 0%, #4ade80 100%);
        }

        .efficiency-meter-fill.good {
            background: linear-gradient(90deg, #84cc16 0%, var(--success) 100%);
        }

        .efficiency-meter-fill.warning {
            background: linear-gradient(90deg, var(--warning) 0%, #fbbf24 100%);
        }

        .efficiency-meter-fill.poor {
            background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%);
        }

        /* ========================================
           WELCOME BANNER
           ======================================== */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .welcome-greeting {
            margin-bottom: 16px;
        }

        .welcome-greeting h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 4px 0;
        }

        .welcome-date {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
        }

        .welcome-weather {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .weather-icon {
            font-size: 32px;
        }

        .weather-icon i {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .weather-info {
            display: flex;
            flex-direction: column;
        }

        .weather-temp {
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
        }

        .weather-desc {
            font-size: 13px;
            opacity: 0.9;
        }

        .welcome-message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 14px;
            font-style: italic;
            opacity: 0.95;
            line-height: 1.4;
        }

        .welcome-message i {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* ========================================
           WORK MODE TOGGLE (Permission-based)
           ======================================== */
        .mode-selector {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 6px;
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
        }

        .mode-selector.scrollable {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .mode-selector.scrollable::-webkit-scrollbar {
            display: none;
        }

        .mode-btn {
            flex: 1;
            min-width: 64px;
            padding: 12px 8px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .mode-btn i {
            font-size: 18px;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(45, 90, 39, 0.4);
        }

        .mode-btn:not(.active):active {
            background: var(--bg-elevated);
        }

        /* Mode indicator badge in header */
        .mode-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .mode-badge.field {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .mode-badge.packhouse {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .mode-badge.driver {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
        }

        /* ========================================
           QR/BARCODE SCANNER
           ======================================== */
        .scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 10000;
            display: none;
        }

        .scanner-modal.active {
            display: flex;
            flex-direction: column;
        }

        .scanner-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 16px 20px;
            padding-top: calc(16px + var(--safe-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .scanner-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .scanner-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .scanner-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .scanner-viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            border: 3px solid var(--success);
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scanner-overlay::before,
        .scanner-overlay::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid var(--success);
        }

        .scanner-overlay::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
            border-radius: 20px 0 0 0;
        }

        .scanner-overlay::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
            border-radius: 0 0 20px 0;
        }

        .scanner-hint {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            text-align: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 24px;
            border-radius: 25px;
        }

        .scanner-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .scanner-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .scanner-action-btn:active {
            transform: scale(0.9);
        }

        .scanner-action-btn.flash {
            background: var(--bg-elevated);
            color: white;
        }

        .scanner-action-btn.manual {
            background: var(--primary);
            color: white;
        }

        /* Scan success animation */
        .scan-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--success);
            color: white;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            z-index: 10001;
            animation: scanPop 0.5s ease-out forwards;
        }

        @keyframes scanPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* ========================================
           TRACEABILITY CARD
           ======================================== */
        .trace-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
        }

        .trace-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .trace-batch {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 16px;
            font-weight: 700;
            color: var(--success);
        }

        .trace-crop {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .trace-qr {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 8px;
            padding: 4px;
        }

        .trace-qr img {
            width: 100%;
            height: 100%;
        }

        .trace-timeline {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trace-step {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .trace-step-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .trace-step-icon.complete {
            background: var(--success);
            color: white;
        }

        .trace-step-icon.current {
            background: var(--warning);
            color: white;
            animation: pulse 2s infinite;
        }

        .trace-step-icon.pending {
            background: var(--bg-elevated);
            color: var(--text-muted);
        }

        .trace-step-info {
            flex: 1;
        }

        .trace-step-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .trace-step-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ========================================
           WILDLIFE TRACKER
           ======================================== */
        .wildlife-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .wildlife-btn {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wildlife-btn:active {
            transform: scale(0.95);
        }

        .wildlife-btn.selected {
            border-color: var(--primary);
            background: rgba(45, 90, 39, 0.2);
        }

        .wildlife-emoji {
            font-size: 36px;
        }

        .wildlife-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
        }

        .wildlife-log {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
        }

        .wildlife-entry {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
        }

        .wildlife-entry:last-child {
            border-bottom: none;
        }

        .wildlife-entry-emoji {
            font-size: 28px;
        }

        .wildlife-entry-info {
            flex: 1;
        }

        .wildlife-entry-type {
            font-weight: 600;
            font-size: 14px;
        }

        .wildlife-entry-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ========================================
           FARMPIC (Documentation Photos)
           ======================================== */
        .farmpic-hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .farmpic-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 40px;
            cursor: pointer;
            margin-bottom: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .farmpic-btn:active {
            transform: scale(0.9);
        }

        .farmpic-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .farmpic-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .farmpic-thumb {
            aspect-ratio: 1;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        .farmpic-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ========================================
           PACKHOUSE MODE
           ======================================== */
        .receiving-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .receiving-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .receiving-title {
            font-size: 18px;
            font-weight: 700;
        }

        .receiving-scan-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .receiving-queue {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .receiving-item {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .receiving-item-status {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .receiving-item-status.waiting {
            background: rgba(245, 158, 11, 0.2);
        }

        .receiving-item-status.processing {
            background: rgba(59, 130, 246, 0.2);
        }

        .receiving-item-info {
            flex: 1;
        }

        .receiving-item-batch {
            font-family: monospace;
            font-weight: 700;
            color: var(--success);
        }

        .receiving-item-crop {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .receiving-item-action {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Weigh Station */
        .weigh-display {
            background: #000;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .weigh-value {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 64px;
            font-weight: 700;
            color: var(--success);
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .weigh-unit {
            font-size: 24px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .weigh-actions {
            display: flex;
            gap: 12px;
        }

        .weigh-actions button {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .weigh-tare {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .weigh-confirm {
            background: var(--success);
            color: white;
        }

        /* Grade Selector */
        .grade-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .grade-btn {
            flex: 1;
            padding: 20px;
            border: 3px solid var(--border);
            border-radius: 16px;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .grade-btn.selected {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .grade-letter {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .grade-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ========================================
           DRIVER MODE (Full Screen)
           ======================================== */
        .driver-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 5000;
            flex-direction: column;
        }

        .driver-mode.active {
            display: flex;
        }

        .driver-header {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            padding: 16px 20px;
            padding-top: calc(16px + var(--safe-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .driver-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .driver-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .driver-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .driver-stats {
            display: flex;
            gap: 16px;
        }

        .driver-stat {
            text-align: center;
            color: white;
        }

        .driver-stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .driver-stat-label {
            font-size: 11px;
            opacity: 0.8;
        }

        .driver-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .driver-stop {
            background: var(--bg-card);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .driver-stop-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border);
        }

        .driver-stop-num {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .driver-stop-num.complete {
            background: var(--success);
        }

        .driver-stop-info {
            flex: 1;
        }

        .driver-stop-name {
            font-weight: 700;
            font-size: 16px;
        }

        .driver-stop-address {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .driver-stop-nav {
            background: var(--info);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
        }

        .driver-stop-items {
            padding: 16px;
            background: var(--bg-elevated);
        }

        .driver-stop-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .driver-stop-actions {
            padding: 16px;
            display: flex;
            gap: 12px;
        }

        .driver-stop-actions button {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .driver-complete-btn {
            background: var(--success);
            color: white;
        }

        .driver-issue-btn {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        /* Print label button */
        .print-label-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 16px;
        }

        .print-label-btn i {
            font-size: 18px;
        }

        /* ========================================
           SLIDE PANEL (Deliveries, etc.)
           ======================================== */
        .slide-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 5000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .slide-panel.active {
            transform: translateX(0);
        }

        .panel-header {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            padding: 16px 20px;
            padding-top: calc(16px + var(--safe-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .panel-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }

        .panel-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .delivery-summary {
            display: flex;
            justify-content: space-around;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .summary-stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .delivery-route-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .delivery-stop-card {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .delivery-stop-card.completed {
            opacity: 0.6;
        }

        .delivery-stop-header {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 12px;
        }

        .stop-number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .delivery-stop-card.completed .stop-number {
            background: var(--success);
        }

        .stop-info {
            flex: 1;
        }

        .stop-name {
            font-weight: 600;
            font-size: 16px;
        }

        .stop-address {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stop-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Contact Buttons */
        .delivery-contact-btns {
            display: flex;
            gap: 8px;
            padding: 0 16px 16px;
        }

        .contact-btn {
            flex: 1;
            height: 44px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .contact-btn.call {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .contact-btn.text {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .contact-btn.email {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .contact-btn.nav {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
        }

        /* Route Actions */
        .route-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .route-action-btn {
            flex: 1;
            padding: 14px 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .route-action-btn.start-route {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
        }

        .route-action-btn.running-late {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .route-action-btn i {
            font-size: 16px;
        }

        /* Delivery Modal Enhancements */
        .delivery-modal {
            max-width: 400px;
            width: 90%;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        /* ========================================
           GARAGE MODE (Full Screen)
           ======================================== */
        .garage-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 5000;
            flex-direction: column;
        }

        .garage-mode.active {
            display: flex;
        }

        .garage-header {
            background: linear-gradient(135deg, #FF8C00 0%, #f97316 100%);
            padding: 16px 20px;
            padding-top: calc(16px + var(--safe-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .garage-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .garage-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .garage-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .garage-sync {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .garage-sync.loading i {
            animation: spin 1s linear infinite;
        }

        .garage-tabs {
            display: flex;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .garage-tab {
            flex: 1;
            padding: 14px 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .garage-tab.active {
            color: #FF8C00;
            border-bottom-color: #FF8C00;
        }

        .garage-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .garage-panel {
            display: none;
        }

        .garage-panel.active {
            display: block;
        }

        .garage-form {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
        }

        .garage-form-title {
            color: #FF8C00;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .garage-select,
        .garage-input,
        .garage-textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .garage-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .garage-select:focus,
        .garage-input:focus,
        .garage-textarea:focus {
            outline: none;
            border-color: #FF8C00;
        }

        .garage-photo-btn {
            width: 100%;
            padding: 14px;
            background: var(--bg-elevated);
            border: 2px dashed var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .garage-photo-btn.required {
            border-color: var(--danger);
            color: var(--danger);
        }

        .garage-photo-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 10px;
        }

        .garage-submit {
            width: 100%;
            padding: 16px;
            background: #FF8C00;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .garage-submit.breakdown {
            background: var(--danger);
        }

        .garage-submit.secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .severity-buttons {
            display: flex;
            gap: 10px;
        }

        .severity-btn {
            flex: 1;
            padding: 14px 10px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .severity-btn i {
            font-size: 20px;
        }

        .severity-btn.critical { border-color: transparent; }
        .severity-btn.critical i { color: #ef4444; }
        .severity-btn.high i { color: #f97316; }
        .severity-btn.medium i { color: #eab308; }

        .severity-btn.selected {
            background: var(--bg-card);
        }
        .severity-btn.selected.critical { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .severity-btn.selected.high { border-color: #f97316; background: rgba(249, 115, 22, 0.1); }
        .severity-btn.selected.medium { border-color: #eab308; background: rgba(234, 179, 8, 0.1); }

        .inspection-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inspection-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border-radius: 10px;
            cursor: pointer;
        }

        .inspection-item input {
            width: 24px;
            height: 24px;
            accent-color: var(--success);
        }

        .inspection-label {
            font-size: 16px;
            color: var(--text-primary);
        }

        .parts-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .parts-input-row .garage-input {
            flex: 1;
        }

        .add-part-btn {
            width: 50px;
            background: #FF8C00;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .needs-list {
            min-height: 200px;
        }

        .needs-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .needs-item-text {
            color: var(--text-primary);
            font-size: 15px;
        }

        .needs-item-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }

        /* ========================================
           INVENTORY MODE (Full Screen)
           ======================================== */
        .inventory-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 5000;
            flex-direction: column;
        }

        .inventory-mode.active {
            display: flex;
        }

        .inventory-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            padding: 16px 20px;
            padding-top: calc(16px + var(--safe-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .inventory-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .inventory-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .inventory-scan-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .inventory-tabs {
            display: flex;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .inventory-tab {
            flex: 1;
            padding: 14px 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .inventory-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .inventory-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .inventory-panel {
            display: none;
        }

        .inventory-panel.active {
            display: block;
        }

        .inventory-location-select {
            margin-bottom: 16px;
        }

        .inventory-location-select label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .inventory-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .inventory-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .inventory-item-entry {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .inventory-entry-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .inventory-entry-row:last-child {
            margin-bottom: 0;
        }

        .inventory-input {
            flex: 1;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .inventory-input.qty {
            width: 80px;
            flex: none;
            text-align: center;
        }

        .inventory-select.unit {
            width: 100px;
            flex: none;
            padding: 14px 10px;
        }

        .inventory-quick-scan,
        .inventory-add-btn {
            width: 50px;
            flex: none;
            background: #3b82f6;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .inventory-quick-scan {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .inventory-count-list {
            margin-bottom: 20px;
        }

        .inventory-count-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .inventory-count-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .inventory-count-item-qty {
            font-size: 18px;
            font-weight: 700;
            color: #3b82f6;
        }

        .inventory-count-item-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            margin-left: 10px;
        }

        .inventory-submit-btn {
            width: 100%;
            padding: 16px;
            background: #3b82f6;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .inventory-submit-btn.secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            margin-top: 16px;
        }

        .report-summary {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }

        .report-summary h3 {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .report-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
        }

        .report-stat {
            text-align: center;
        }

        .report-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
            display: block;
        }

        .report-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* ========================================
           COSTING MODE (Full Screen)
           ======================================== */
        .costing-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 5000;
            flex-direction: column;
        }

        .costing-mode.active {
            display: flex;
        }

        .costing-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 16px 20px;
            padding-top: calc(16px + var(--safe-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .costing-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .costing-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .costing-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .costing-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 14px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .costing-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .costing-active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 2px solid var(--success);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .costing-active-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .costing-active-task {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .costing-active-crop,
        .costing-active-field {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .costing-active-timer {
            text-align: center;
        }

        .costing-big-timer {
            font-size: 48px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: var(--success);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .costing-timer-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .costing-pause-btn,
        .costing-stop-btn {
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .costing-pause-btn {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .costing-pause-btn.paused {
            background: var(--warning);
            color: white;
        }

        .costing-pause-btn.paused i::before {
            content: "\f04b";
        }

        .costing-stop-btn {
            background: var(--danger);
            color: white;
        }

        .costing-task-select {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .costing-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .costing-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .costing-select:focus {
            outline: none;
            border-color: var(--success);
        }

        .costing-start-btn {
            width: 100%;
            padding: 16px;
            background: #10b981;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 16px;
        }

        .costing-log {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
        }

        .costing-log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .costing-log-item:last-child {
            border-bottom: none;
        }

        .costing-log-task {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .costing-log-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .costing-log-duration {
            font-size: 16px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: var(--success);
        }

        /* ========================================
           FLEET TAB (Tractor Mode)
           ======================================== */
        .fleet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .tractor-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .tractor-card:hover {
            border-color: var(--primary-light);
        }

        .tractor-card.running {
            border-color: var(--success);
            background: var(--success-bg);
        }

        .tractor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .tractor-id {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tractor-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .tractor-status.active {
            background: var(--success-bg);
            color: var(--success);
        }

        .tractor-status.maintenance {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .tractor-status.winterized {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .tractor-model {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .tractor-hours {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .tractor-hours-label {
            color: var(--text-muted);
        }

        .tractor-hours-value {
            color: #FF8C00;
            font-weight: 700;
        }

        .tractor-action {
            width: 100%;
            margin-top: 12px;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .tractor-action.start {
            background: var(--primary);
            color: white;
        }

        .tractor-action.running {
            background: var(--success);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .active-sessions {
            background: var(--success-bg);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .session-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--success);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(34, 197, 94, 0.2);
        }

        .session-item:last-child {
            border-bottom: none;
        }

        .session-asset {
            font-weight: 600;
            color: var(--text-primary);
        }

        .session-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .session-timer {
            color: var(--success);
            font-weight: 700;
            font-size: 18px;
        }

        /* ========================================
           FUEL TAB (Tractor Mode)
           ======================================== */
        .fuel-form {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
        }

        .fuel-select,
        .fuel-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .fuel-input.large {
            font-size: 32px;
            text-align: center;
            padding: 20px;
        }

        .fuel-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-top: 16px;
        }

        .fuel-total-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--success);
        }

        .fuel-submit {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .fuel-log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .fuel-log-asset {
            font-weight: 600;
            color: var(--text-primary);
        }

        .fuel-log-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .fuel-log-amount {
            text-align: right;
        }

        .fuel-log-gallons {
            font-weight: 700;
            color: var(--text-primary);
        }

        .fuel-log-cost {
            font-size: 12px;
            color: var(--success);
        }

        /* Tractor Start/Stop Dialog */
        .tractor-dialog {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .tractor-dialog.active {
            display: flex;
        }

        .tractor-dialog-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 340px;
        }

        .tractor-dialog-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tractor-dialog-title i {
            color: #FF8C00;
        }

        /* ========================================
           PWA INSTALL PROMPT
           ======================================== */
        .install-prompt {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
            z-index: 10000;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .install-prompt.show {
            transform: translateY(0);
        }

        .install-prompt-content {
            display: flex;
            align-items: center;
            gap: 16px;
            max-width: 500px;
            margin: 0 auto;
        }

        .install-prompt-icon {
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .install-prompt-text {
            flex: 1;
        }

        .install-prompt-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .install-prompt-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .install-prompt-buttons {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .install-btn {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .install-btn-primary {
            background: white;
            color: var(--primary-dark);
        }

        .install-btn-primary:active {
            transform: scale(0.95);
        }

        .install-btn-dismiss {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        /* PWA Update Available Banner */
        .update-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--info);
            color: white;
            padding: 12px 20px;
            padding-top: calc(12px + var(--safe-top));
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10001;
            transform: translateY(-100%);
            transition: transform 0.3s ease-out;
        }

        .update-banner.show {
            transform: translateY(0);
        }

        .update-banner-text {
            font-size: 14px;
            font-weight: 500;
        }

        .update-btn {
            background: white;
            color: var(--info);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: calc(10px + var(--safe-top));
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--warning);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 10002;
            transition: transform 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .offline-indicator.show {
            transform: translateX(-50%) translateY(0);
        }

        .offline-indicator i {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- PWA Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div class="install-prompt-content">
            <div class="install-prompt-icon"></div>
            <div class="install-prompt-text">
                <div class="install-prompt-title">Install Field App</div>
                <div class="install-prompt-desc">Add to home screen for quick access & offline use</div>
            </div>
            <div class="install-prompt-buttons">
                <button class="install-btn install-btn-dismiss" onclick="dismissInstallPrompt()">Later</button>
                <button class="install-btn install-btn-primary" onclick="installApp()">Install</button>
            </div>
        </div>
    </div>

    <!-- PWA Update Banner -->
    <div class="update-banner" id="updateBanner">
        <span class="update-banner-text"><i class="fas fa-sync-alt"></i> New version available!</span>
        <button class="update-btn" onclick="updateApp()">Update Now</button>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i>
        <span>Offline Mode</span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="login-screen">
            <div class="login-logo"></div>
            <h1 class="login-title" data-i18n="auth.title">Tiny Seed Farm</h1>

            <div class="pin-display">
                <div class="pin-dot" id="pin1"></div>
                <div class="pin-dot" id="pin2"></div>
                <div class="pin-dot" id="pin3"></div>
                <div class="pin-dot" id="pin4"></div>
            </div>

            <div class="pin-pad">
                <button class="pin-btn" onclick="enterPin('1')">1</button>
                <button class="pin-btn" onclick="enterPin('2')">2</button>
                <button class="pin-btn" onclick="enterPin('3')">3</button>
                <button class="pin-btn" onclick="enterPin('4')">4</button>
                <button class="pin-btn" onclick="enterPin('5')">5</button>
                <button class="pin-btn" onclick="enterPin('6')">6</button>
                <button class="pin-btn" onclick="enterPin('7')">7</button>
                <button class="pin-btn" onclick="enterPin('8')">8</button>
                <button class="pin-btn" onclick="enterPin('9')">9</button>
                <button class="pin-btn empty"></button>
                <button class="pin-btn" onclick="enterPin('0')">0</button>
                <button class="pin-btn delete" onclick="deletePin()"><i class="fas fa-delete-left"></i></button>
            </div>

            <div class="login-error" id="loginError"></div>
            <div class="login-hint" data-i18n="auth.hint">Enter your 4-digit PIN</div>

            <button class="register-link" onclick="showRegistration()">
                New here? <span>Register</span>
            </button>
        </div>
    </div>

    <!-- Registration Screen -->
    <div id="registrationScreen" class="screen">
        <div class="registration-screen">
            <button class="registration-back" onclick="hideRegistration()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="login-logo"></div>
            <h1 class="login-title">Join the Team</h1>
            <p class="registration-subtitle">Fill out your info and we'll get you set up</p>

            <form class="registration-form" onsubmit="submitRegistration(event)">
                <div class="form-group">
                    <label class="form-label">First Name *</label>
                    <input type="text" class="form-input" id="regFirstName" required placeholder="Your first name">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name *</label>
                    <input type="text" class="form-input" id="regLastName" required placeholder="Your last name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone *</label>
                    <input type="tel" class="form-input" id="regPhone" required placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label class="form-label">Email (optional)</label>
                    <input type="email" class="form-input" id="regEmail" placeholder="you@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Create a 4-digit PIN *</label>
                    <input type="tel" class="form-input pin-input" id="regPin" required
                           maxlength="4" pattern="[0-9]{4}" inputmode="numeric" placeholder="">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm PIN *</label>
                    <input type="tel" class="form-input pin-input" id="regPinConfirm" required
                           maxlength="4" pattern="[0-9]{4}" inputmode="numeric" placeholder="">
                </div>
                <div class="form-group">
                    <label class="form-label">Preferred Language</label>
                    <select class="form-input" id="regLanguage">
                        <option value="en">English</option>
                        <option value="es">Espaol</option>
                    </select>
                </div>

                <button type="submit" class="registration-submit" id="regSubmitBtn">
                    <i class="fas fa-paper-plane"></i> Submit Registration
                </button>
            </form>

            <div class="registration-note">
                <i class="fas fa-info-circle"></i>
                Your registration will be reviewed by a manager. You'll receive a text when approved.
            </div>
        </div>
    </div>

    <!-- Registration Success Screen -->
    <div id="registrationSuccessScreen" class="screen">
        <div class="registration-success">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h1>Registration Submitted!</h1>
            <p>A manager will review your request and you'll receive a text message when approved.</p>
            <button class="registration-done-btn" onclick="hideRegistrationSuccess()">
                <i class="fas fa-arrow-left"></i> Back to Login
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="screen">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="header-avatar" id="headerAvatar">--</div>
                <div class="header-info">
                    <div class="header-name" id="headerName">Employee</div>
                    <div class="header-status" id="headerStatus" data-i18n="clock.notClockedIn">Not clocked in</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn lang-toggle" onclick="toggleLanguage()" id="langToggle">EN</button>
                <div class="sync-btn-wrapper">
                    <button class="header-btn" onclick="syncData()" id="syncBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <span class="sync-badge" id="syncBadge">0</span>
                </div>
                <button class="header-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Offline Indicator -->
        <div class="offline-indicator" id="offlineIndicator">
            <i class="fas fa-wifi-slash"></i>
            <span data-i18n="common.offline">Offline - will sync when connected</span>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Home Tab -->
            <div id="homeTab" class="tab-panel active">
                <!-- Welcome Banner -->
                <div class="welcome-banner" id="welcomeBanner">
                    <div class="welcome-greeting">
                        <h1 id="welcomeName">Welcome!</h1>
                        <p class="welcome-date" id="welcomeDate"></p>
                    </div>
                    <div class="welcome-weather" id="welcomeWeather">
                        <div class="weather-icon">
                            <i class="fas fa-sun" id="weatherIcon"></i>
                        </div>
                        <div class="weather-info">
                            <span class="weather-temp" id="weatherTemp">--F</span>
                            <span class="weather-desc" id="weatherDesc">Loading...</span>
                        </div>
                    </div>
                    <div class="welcome-message" id="welcomeMessage">
                        <i class="fas fa-quote-left"></i>
                        <span id="encouragingMessage">Every seed you plant makes a difference.</span>
                    </div>
                </div>

                <!-- Work Mode Selector (Permission-based) -->
                <div class="mode-selector scrollable" id="modeSelector">
                    <!-- Modes rendered dynamically based on user permissions -->
                </div>

                <!-- Clock Card -->
                <div class="clock-card">
                    <div class="clock-time" id="clockTime">--:--</div>
                    <div class="clock-date" id="clockDate">---</div>
                    <button class="clock-btn clock-in" id="clockBtn" onclick="toggleClock()">
                        <i class="fas fa-play"></i>
                        <span data-i18n="clock.clockIn">Clock In</span>
                    </button>
                </div>

                <!-- Admin Panel (only visible for admins) -->
                <div class="admin-panel" id="adminPanel">
                    <div class="admin-panel-header">
                        <div class="admin-panel-title">
                            <i class="fas fa-user-shield"></i>
                            Pending Registrations
                        </div>
                        <span class="pending-badge" id="pendingCount">0</span>
                    </div>
                    <div class="pending-list" id="pendingList">
                        <div class="no-pending">
                            <i class="fas fa-check-circle"></i>
                            <p>No pending registrations</p>
                        </div>
                    </div>
                </div>

                <!-- Hours Summary -->
                <div class="hours-summary">
                    <div class="hours-card">
                        <div class="hours-value" id="hoursToday">0.0</div>
                        <div class="hours-label" data-i18n="clock.hoursToday">Hours Today</div>
                    </div>
                    <div class="hours-card">
                        <div class="hours-value" id="hoursWeek">0.0</div>
                        <div class="hours-label" data-i18n="clock.weeklyHours">This Week</div>
                    </div>
                </div>

                <!-- Messages -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-envelope"></i>
                        <span data-i18n="messages.title">Messages</span>
                    </h2>
                </div>
                <div id="messagesContainer">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3 data-i18n="messages.empty">No messages</h3>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasksTab" class="tab-panel">
                <div class="task-filters">
                    <button class="task-filter active" onclick="filterTasks('all')" data-i18n="tasks.all">
                        All <span class="count" id="taskCountAll">0</span>
                    </button>
                    <button class="task-filter" onclick="filterTasks('overdue')" data-i18n="tasks.overdue">
                        Overdue <span class="count" id="taskCountOverdue">0</span>
                    </button>
                    <button class="task-filter" onclick="filterTasks('today')" data-i18n="tasks.today">
                        Today <span class="count" id="taskCountToday">0</span>
                    </button>
                </div>
                <div id="tasksContainer">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <h3 data-i18n="tasks.noTasks">No tasks assigned</h3>
                        <p data-i18n="tasks.noTasksHint">Check back later for new tasks</p>
                    </div>
                </div>
            </div>

            <!-- Harvest Tab -->
            <div id="harvestTab" class="tab-panel">
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-basket-shopping"></i>
                        <span data-i18n="harvest.title">Log Harvest</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="harvest.crop">Crop</label>
                        <select class="form-input" id="harvestCrop">
                            <option value="" data-i18n="harvest.selectCrop">Select crop...</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="harvest.quantity">Quantity</label>
                            <input type="number" class="form-input" id="harvestQty"
                                   inputmode="decimal" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="harvest.unit">Unit</label>
                            <select class="form-input" id="harvestUnit">
                                <option value="lbs">lbs</option>
                                <option value="bunches">bunches</option>
                                <option value="heads">heads</option>
                                <option value="oz">oz</option>
                                <option value="each">each</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="harvest.quality">Quality Grade</label>
                        <div class="quality-buttons">
                            <button class="quality-btn active" onclick="setQuality('A')">A</button>
                            <button class="quality-btn" onclick="setQuality('B')">B</button>
                            <button class="quality-btn" onclick="setQuality('C')">C</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="harvest.photo">Photo (optional)</label>
                        <div class="photo-capture-btn" onclick="capturePhoto('harvest')">
                            <i class="fas fa-camera"></i>
                            <span data-i18n="harvest.addPhoto">Add Photo</span>
                        </div>
                        <div class="photo-preview" id="harvestPhotoPreview" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="harvest.notes">Notes</label>
                        <div class="voice-input-wrapper">
                            <textarea class="form-input" id="harvestNotes" rows="2"
                                      placeholder="Add notes..."></textarea>
                            <button class="voice-btn" onclick="startVoice('harvestNotes')">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <button class="btn-primary" onclick="submitHarvest()">
                        <i class="fas fa-check"></i>
                        <span data-i18n="harvest.submit">Log Harvest</span>
                    </button>
                </div>

                <div class="recent-harvests" id="recentHarvests">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-history"></i>
                            <span data-i18n="harvest.recent">Recent Harvests</span>
                        </h2>
                    </div>
                    <div id="recentHarvestsList"></div>
                </div>
            </div>

            <!-- Scout Tab - Redesigned for Usability -->
            <div id="scoutTab" class="tab-panel">
                <!-- Hero Camera Button -->
                <div class="scout-hero">
                    <button class="scout-camera-hero" onclick="openAIDiagnosis()">
                        <div class="camera-icon-large">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="camera-text">
                            <span class="camera-title">Snap a Photo</span>
                            <span class="camera-subtitle">AI identifies pests, diseases & beneficial insects</span>
                        </div>
                    </button>
                    <div class="scout-gps-status" id="scoutGpsStatus">
                        <i class="fas fa-location-dot"></i>
                        <span>GPS will auto-tag location</span>
                    </div>
                </div>

                <!-- Quick Scout Form -->
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Quick Scout Report</span>
                    </div>

                    <!-- Type Selection - Simplified -->
                    <div class="form-group">
                        <label class="form-label">What did you find?</label>
                        <div class="scout-type-pills">
                            <button class="scout-pill pest active" onclick="setScoutType('pest')">
                                <i class="fas fa-bug"></i> Pest
                            </button>
                            <button class="scout-pill disease" onclick="setScoutType('disease')">
                                <i class="fas fa-virus"></i> Disease
                            </button>
                            <button class="scout-pill weed" onclick="setScoutType('weed')">
                                <i class="fas fa-seedling"></i> Weed
                            </button>
                            <button class="scout-pill beneficial" onclick="setScoutType('beneficial')">
                                <i class="fas fa-check-circle"></i> Good Bug
                            </button>
                        </div>
                    </div>

                    <!-- Library Dropdown - Based on Type -->
                    <div class="form-group" id="scoutLibraryGroup">
                        <label class="form-label">Identify from Library</label>
                        <select class="form-input" id="scoutLibrarySelect" onchange="selectFromLibrary()">
                            <option value="">Select or skip...</option>
                            <optgroup label="Common Pests" id="pestOptions">
                                <option value="aphid">Aphids</option>
                                <option value="flea-beetle">Flea Beetles</option>
                                <option value="cabbage-worm">Cabbage Worm</option>
                                <option value="cucumber-beetle">Cucumber Beetle</option>
                                <option value="squash-bug">Squash Bug</option>
                                <option value="tomato-hornworm">Tomato Hornworm</option>
                                <option value="other-pest">Other Pest</option>
                            </optgroup>
                            <optgroup label="Diseases" id="diseaseOptions" style="display:none;">
                                <option value="powdery-mildew">Powdery Mildew</option>
                                <option value="downy-mildew">Downy Mildew</option>
                                <option value="blight">Blight</option>
                                <option value="rust">Rust</option>
                                <option value="bacterial-spot">Bacterial Spot</option>
                                <option value="other-disease">Other Disease</option>
                            </optgroup>
                            <optgroup label="Weeds" id="weedOptions" style="display:none;">
                                <option value="pigweed">Pigweed</option>
                                <option value="lambsquarter">Lambsquarter</option>
                                <option value="galinsoga">Galinsoga</option>
                                <option value="purslane">Purslane</option>
                                <option value="crabgrass">Crabgrass</option>
                                <option value="other-weed">Other Weed</option>
                            </optgroup>
                            <optgroup label="Beneficial Insects" id="beneficialOptions" style="display:none;">
                                <option value="ladybug">Ladybug</option>
                                <option value="lacewing">Green Lacewing</option>
                                <option value="ground-beetle">Ground Beetle</option>
                                <option value="parasitic-wasp">Parasitic Wasp</option>
                                <option value="syrphid-fly">Syrphid Fly (Hover Fly)</option>
                                <option value="other-beneficial">Other Beneficial</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Severity - Only show for Pest/Disease/Weed -->
                    <div class="form-group" id="severityGroup">
                        <label class="form-label">Severity</label>
                        <div class="severity-quick">
                            <button class="severity-btn low" onclick="setSeverity('low')">
                                <i class="fas fa-circle"></i> Low
                            </button>
                            <button class="severity-btn medium" onclick="setSeverity('medium')">
                                <i class="fas fa-circle"></i> Medium
                            </button>
                            <button class="severity-btn high" onclick="setSeverity('high')">
                                <i class="fas fa-circle"></i> High
                            </button>
                        </div>
                    </div>

                    <!-- Photo (if not already captured via hero) -->
                    <div class="form-group" id="manualPhotoGroup">
                        <label class="form-label">Photo (optional if AI used)</label>
                        <div class="photo-capture-btn" onclick="capturePhoto('scout')">
                            <i class="fas fa-camera"></i>
                            <span>Add Photo</span>
                        </div>
                        <div class="photo-preview" id="scoutPhotoPreview" style="display: none;"></div>
                    </div>

                    <!-- Notes with Voice -->
                    <div class="form-group">
                        <label class="form-label">Quick Notes</label>
                        <div class="voice-input-wrapper">
                            <textarea class="form-input" id="scoutNotes" rows="2"
                                      placeholder="Any additional details..."></textarea>
                            <button class="voice-btn" onclick="startVoice('scoutNotes')">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Hidden GPS fields -->
                    <input type="hidden" id="scoutGpsLat">
                    <input type="hidden" id="scoutGpsLng">

                    <button class="btn-primary" onclick="submitScoutReport()">
                        <i class="fas fa-check"></i>
                        <span>Submit Report</span>
                    </button>
                </div>

                <!-- Pest/Observation Map Card -->
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-map-marked-alt"></i>
                        <span data-i18n="scout.map">Pest & Observation Map</span>
                    </div>

                    <div class="pest-map-controls">
                        <button class="map-filter-chip active" onclick="togglePestMapFilter('all')">
                            <i class="fas fa-layer-group"></i> All
                        </button>
                        <button class="map-filter-chip" onclick="togglePestMapFilter('pest')">
                            <i class="fas fa-bug"></i> Pests
                        </button>
                        <button class="map-filter-chip" onclick="togglePestMapFilter('disease')">
                            <i class="fas fa-virus"></i> Disease
                        </button>
                        <button class="map-filter-chip" onclick="togglePestMapFilter('weed')">
                            <i class="fas fa-leaf"></i> Weeds
                        </button>
                    </div>

                    <div class="pest-map-container" id="pest-map"></div>

                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #ef4444;"></div>
                            <span>Pest</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #f59e0b;"></div>
                            <span>Disease</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #8b5cf6;"></div>
                            <span>Weed</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #22c55e;"></div>
                            <span>Beneficial</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-fire" style="color: #ef4444; font-size: 0.8rem;"></i>
                            <span>Hotspot</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 12px;">
                        <button class="btn-secondary" onclick="refreshPestMap()" style="padding: 10px 20px;">
                            <i class="fas fa-sync-alt"></i>
                            <span data-i18n="scout.refreshMap">Refresh Map</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- More Tab -->
            <div id="moreTab" class="tab-panel">
                <div class="more-menu">
                    <div class="more-item" onclick="openTreatmentLog()">
                        <div class="more-item-icon treatment">
                            <i class="fas fa-spray-can"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.treatment">Treatment Log</h3>
                            <p data-i18n="more.treatmentDesc">Log spray applications & materials</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openHazards()">
                        <div class="more-item-icon hazard">
                            <i class="fas fa-triangle-exclamation"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.hazards">Field Hazards</h3>
                            <p data-i18n="more.hazardsDesc">Report groundhog holes, issues</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openWeedLog()">
                        <div class="more-item-icon weed">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.weed">Weed Pressure</h3>
                            <p data-i18n="more.weedDesc">Track problem weeds by field</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openCultivation()">
                        <div class="more-item-icon cultivation">
                            <i class="fas fa-tractor"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.cultivation">Cultivation Log</h3>
                            <p data-i18n="more.cultivationDesc">Log cultivation passes</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openWildlife()">
                        <div class="more-item-icon wildlife" style="background: linear-gradient(135deg, #8b4513, #a0522d);">
                            <i class="fas fa-paw"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.wildlife">Wildlife Tracker</h3>
                            <p data-i18n="more.wildlifeDesc">Log sightings, dens, damage</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openPickPack()">
                        <div class="more-item-icon pickpack" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-boxes-stacked"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.pickpack">Pick & Pack</h3>
                            <p data-i18n="more.pickpackDesc">Today's orders & packing</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openDeliveries()" id="deliveryModeItem">
                        <div class="more-item-icon delivery" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.deliveries">Deliveries</h3>
                            <p data-i18n="more.deliveriesDesc">View routes & complete deliveries</p>
                        </div>
                        <span class="delivery-badge" id="deliveryBadge" style="display: none;">0</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openTimesheet()">
                        <div class="more-item-icon timesheet" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.timesheet">My Timesheet</h3>
                            <p data-i18n="more.timesheetDesc">View hours & pay period</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openFarmPics()">
                        <div class="more-item-icon farmpics" style="background: linear-gradient(135deg, #E1306C, #9b59b6);">
                            <i class="fas fa-camera-retro"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.farmpics">Farm Pics</h3>
                            <p data-i18n="more.farmpicsDesc">Share photos for marketing</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="more-item" onclick="openSettings()">
                        <div class="more-item-icon settings">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="more-item-text">
                            <h3 data-i18n="more.settings">Settings</h3>
                            <p data-i18n="more.settingsDesc">Language, notifications, account</p>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
        </main>

            <!-- Wildlife Tracker Tab -->
            <div id="wildlifeTab" class="tab-panel">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-paw"></i>
                        Wildlife Tracker
                    </h2>
                </div>

                <div class="wildlife-grid">
                    <button class="wildlife-btn" onclick="selectWildlife('deer')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Deer</span>
                    </button>
                    <button class="wildlife-btn" onclick="selectWildlife('groundhog')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Groundhog</span>
                    </button>
                    <button class="wildlife-btn" onclick="selectWildlife('rabbit')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Rabbit</span>
                    </button>
                    <button class="wildlife-btn" onclick="selectWildlife('crow')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Crow/Bird</span>
                    </button>
                    <button class="wildlife-btn" onclick="selectWildlife('turkey')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Turkey</span>
                    </button>
                    <button class="wildlife-btn" onclick="selectWildlife('coyote')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Coyote</span>
                    </button>
                    <button class="wildlife-btn" onclick="selectWildlife('bear')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Bear</span>
                    </button>
                    <button class="wildlife-btn" onclick="selectWildlife('fox')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Fox</span>
                    </button>
                    <button class="wildlife-btn" onclick="selectWildlife('other')">
                        <span class="wildlife-emoji"></span>
                        <span class="wildlife-name">Other</span>
                    </button>
                </div>

                <div class="section-header">
                    <h2 class="section-title">Recent Sightings</h2>
                </div>
                <div class="wildlife-log" id="wildlifeLog">
                    <div class="empty-state">
                        <i class="fas fa-paw"></i>
                        <h3>No sightings logged</h3>
                        <p>Tap an animal above to log a sighting</p>
                    </div>
                </div>
            </div>

            <!-- Farmpic Tab -->
            <div id="farmpicTab" class="tab-panel">
                <div class="farmpic-hero">
                    <button class="farmpic-btn" onclick="takeFarmpic()">
                        <i class="fas fa-camera"></i>
                    </button>
                    <div class="farmpic-title">Take a Farm Photo</div>
                </div>

                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-images"></i>
                        Today's Photos
                    </h2>
                </div>
                <div class="farmpic-gallery" id="farmpicGallery">
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-camera-retro"></i>
                        <h3>No photos today</h3>
                        <p>Capture the farm for marketing & records</p>
                    </div>
                </div>
            </div>

            <!-- Receiving Tab (Packhouse Mode) -->
            <div id="receivingTab" class="tab-panel">
                <div class="receiving-card">
                    <div class="receiving-header">
                        <h2 class="receiving-title">Scan Harvest In</h2>
                        <button class="receiving-scan-btn" onclick="openScanner('receiving')">
                            <i class="fas fa-qrcode"></i>
                            Scan
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Scan the harvest ticket QR code to begin processing
                    </p>
                </div>

                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-inbox"></i>
                        Receiving Queue
                    </h2>
                </div>
                <div class="receiving-queue" id="receivingQueue">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No items in queue</h3>
                        <p>Scan harvests as they arrive</p>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab (Packhouse Mode) -->
            <div id="inventoryTab" class="tab-panel">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-boxes-stacked"></i>
                        Cooler Inventory
                    </h2>
                    <button class="btn-secondary" onclick="openScanner('inventory')" style="padding: 8px 16px;">
                        <i class="fas fa-qrcode"></i> Scan
                    </button>
                </div>
                <div id="inventoryList">
                    <div class="empty-state">
                        <i class="fas fa-snowflake"></i>
                        <h3>Loading inventory...</h3>
                    </div>
                </div>
            </div>

            <!-- Fleet Tab (Tractor Mode) -->
            <div id="fleetTab" class="tab-panel">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-tractor"></i>
                        Fleet
                    </h2>
                    <button class="btn-secondary" onclick="refreshFleetData()" id="fleetRefreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <!-- Active Tractor Sessions -->
                <div id="activeTractorSessions" class="active-sessions" style="display: none;">
                    <div class="session-header">
                        <i class="fas fa-play-circle"></i>
                        <span>Active Sessions</span>
                    </div>
                    <div id="activeTractorList"></div>
                </div>

                <!-- Tractor Grid -->
                <div class="fleet-grid" id="tractorGrid">
                    <div class="empty-state">
                        <i class="fas fa-tractor"></i>
                        <h3>Loading fleet...</h3>
                    </div>
                </div>
            </div>

            <!-- Fuel Tab (Tractor Mode) -->
            <div id="fuelTab" class="tab-panel">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-gas-pump"></i>
                        Log Fuel
                    </h2>
                </div>

                <div class="fuel-form">
                    <div class="form-group">
                        <label>Select Asset</label>
                        <select id="fuelAsset" class="fuel-select">
                            <option value="">-- Select Tractor/Vehicle --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Gallons Added</label>
                        <input type="number" id="fuelGallons" class="fuel-input large" placeholder="0.0" inputmode="decimal" step="0.1">
                    </div>

                    <div class="form-group">
                        <label>Cost per Gallon ($)</label>
                        <input type="number" id="fuelCostPerGallon" class="fuel-input" placeholder="3.50" inputmode="decimal" step="0.01" value="3.50">
                    </div>

                    <div class="form-group">
                        <label>Current Hours/Miles</label>
                        <input type="number" id="fuelReading" class="fuel-input" placeholder="e.g., 2456" inputmode="decimal">
                    </div>

                    <div class="fuel-total">
                        <span>Total Cost:</span>
                        <span class="fuel-total-amount" id="fuelTotalAmount">$0.00</span>
                    </div>

                    <button class="fuel-submit" onclick="submitFuelLog()">
                        <i class="fas fa-gas-pump"></i> Log Fuel
                    </button>
                </div>

                <!-- Recent Fuel Logs -->
                <div class="section-header" style="margin-top: 30px;">
                    <h2 class="section-title">
                        <i class="fas fa-history"></i>
                        Recent
                    </h2>
                </div>
                <div id="recentFuelLogs">
                    <div class="empty-state small">
                        <i class="fas fa-gas-pump"></i>
                        <p>No recent fuel logs</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Tab Bar - MODE AWARE -->
        <!-- FIELD MODE NAV -->
        <nav class="tab-bar" id="fieldNav">
            <div class="tab-item active" onclick="switchTab('home')" data-tutorial="home-tab" data-tutorial-text="Your dashboard with clock, weather, and quick stats">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="tab-item" onclick="switchTab('tasks')" data-tutorial="tasks-tab" data-tutorial-text="View and complete your assigned tasks">
                <i class="fas fa-clipboard-list"></i>
                <span>Tasks</span>
            </div>
            <div class="tab-item" onclick="switchTab('harvest')" data-tutorial="harvest-tab" data-tutorial-text="Log harvests with quantity and quality">
                <i class="fas fa-basket-shopping"></i>
                <span>Harvest</span>
            </div>
            <div class="tab-item" onclick="switchTab('scout')" data-tutorial="scout-tab" data-tutorial-text="Scout fields for pests, disease, and crop health">
                <i class="fas fa-search"></i>
                <span>Scout</span>
            </div>
            <div class="tab-item" onclick="switchTab('more')" data-tutorial="more-tab" data-tutorial-text="Access all other features: Wildlife, Photos, Treatments, and more">
                <i class="fas fa-ellipsis-h"></i>
                <span>More</span>
            </div>
        </nav>

        <!-- PACKHOUSE MODE NAV -->
        <nav class="tab-bar" id="packhouseNav" style="display: none;">
            <div class="tab-item active" onclick="switchTab('home')" data-tutorial="home-tab" data-tutorial-text="Your dashboard with clock and quick stats">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="tab-item" onclick="switchTab('tasks')" data-tutorial="tasks-tab" data-tutorial-text="View packing and processing tasks">
                <i class="fas fa-clipboard-list"></i>
                <span>Tasks</span>
            </div>
            <div class="tab-item" onclick="switchTab('receiving')" data-tutorial="receiving-tab" data-tutorial-text="Log incoming harvests from the field">
                <i class="fas fa-truck-loading"></i>
                <span>Receiving</span>
            </div>
            <div class="tab-item" onclick="switchTab('inventory')" data-tutorial="inventory-tab" data-tutorial-text="Check cooler inventory and storage">
                <i class="fas fa-boxes-stacked"></i>
                <span>Inventory</span>
            </div>
            <div class="tab-item" onclick="switchTab('more')" data-tutorial="more-tab" data-tutorial-text="Access Photos, Orders, and more">
                <i class="fas fa-ellipsis-h"></i>
                <span>More</span>
            </div>
        </nav>

        <!-- TRACTOR MODE NAV -->
        <nav class="tab-bar" id="tractorNav" style="display: none;">
            <div class="tab-item active" onclick="switchTab('home')" data-tutorial="home-tab" data-tutorial-text="Your dashboard with clock and equipment status">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="tab-item" onclick="switchTab('tasks')" data-tutorial="tasks-tab" data-tutorial-text="View field work and equipment tasks">
                <i class="fas fa-clipboard-list"></i>
                <span>Tasks</span>
            </div>
            <div class="tab-item" onclick="switchTab('fleet')" data-tutorial="fleet-tab" data-tutorial-text="Check tractor hours and maintenance status">
                <i class="fas fa-tractor"></i>
                <span>Fleet</span>
            </div>
            <div class="tab-item" onclick="switchTab('fuel')" data-tutorial="fuel-tab" data-tutorial-text="Log fuel purchases and track usage">
                <i class="fas fa-gas-pump"></i>
                <span>Fuel</span>
            </div>
            <div class="tab-item" onclick="switchTab('more')" data-tutorial="more-tab" data-tutorial-text="Access Photos, Maintenance logs, and more">
                <i class="fas fa-ellipsis-h"></i>
                <span>More</span>
            </div>
        </nav>
    </div>

    <!-- FULL SCREEN GARAGE MODE -->
    <div class="garage-mode" id="garageMode">
        <div class="garage-header">
            <div class="garage-header-left">
                <button class="garage-back" onclick="exitGarageMode()">
                    <i class="fas fa-home"></i>
                </button>
                <span class="garage-title">TSF Garage</span>
            </div>
            <div class="garage-sync" onclick="refreshFleetData()">
                <i class="fas fa-sync-alt" id="garageSyncIcon"></i>
            </div>
        </div>
        <div class="garage-tabs">
            <button class="garage-tab active" onclick="switchGarageTab('service')" data-tab="service">Service</button>
            <button class="garage-tab" onclick="switchGarageTab('breakdown')" data-tab="breakdown">Breakdown</button>
            <button class="garage-tab" onclick="switchGarageTab('inspect')" data-tab="inspect">Inspect</button>
            <button class="garage-tab" onclick="switchGarageTab('parts')" data-tab="parts">Parts</button>
        </div>
        <div class="garage-content">
            <!-- Service Tab -->
            <div id="garageServiceTab" class="garage-panel active">
                <div class="garage-form">
                    <h3 class="garage-form-title">Log Maintenance</h3>

                    <div class="form-group">
                        <label>Select Asset</label>
                        <select id="garageAsset" class="garage-select">
                            <option value="">-- Select Tractor --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Service Type</label>
                        <select id="garageServiceType" class="garage-select">
                            <option value="">-- Select Type --</option>
                            <option value="Oil Change">Oil Change</option>
                            <option value="Grease">Grease</option>
                            <option value="Filter">Filter Change</option>
                            <option value="Winterize">Winterize</option>
                            <option value="Tire">Tire Service</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Current Hours</label>
                        <input type="number" id="garageHours" class="garage-input" placeholder="e.g., 2456.5" inputmode="decimal">
                    </div>

                    <div class="form-group">
                        <label>Cost ($)</label>
                        <input type="number" id="garageCost" class="garage-input" placeholder="0.00" inputmode="decimal">
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="garageNotes" class="garage-textarea" placeholder="Additional details..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Photo (optional)</label>
                        <button class="garage-photo-btn" onclick="takeGaragePhoto()">
                            <i class="fas fa-camera"></i> Take Photo
                        </button>
                        <img id="garagePhotoPreview" class="garage-photo-preview" style="display:none;">
                    </div>

                    <button class="garage-submit" onclick="submitGarageMaintenance()">
                        <i class="fas fa-check"></i> Log Maintenance
                    </button>
                </div>
            </div>

            <!-- Breakdown Tab -->
            <div id="garageBreakdownTab" class="garage-panel">
                <div class="garage-form">
                    <h3 class="garage-form-title" style="color: var(--danger);">Report Breakdown</h3>

                    <div class="form-group">
                        <label>Select Asset</label>
                        <select id="breakdownAsset" class="garage-select">
                            <option value="">-- Select Tractor --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Severity</label>
                        <div class="severity-buttons">
                            <button class="severity-btn critical" onclick="selectSeverity('Critical')">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Critical</span>
                            </button>
                            <button class="severity-btn high" onclick="selectSeverity('High')">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>High</span>
                            </button>
                            <button class="severity-btn medium" onclick="selectSeverity('Medium')">
                                <i class="fas fa-info-circle"></i>
                                <span>Medium</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="breakdownNotes" class="garage-textarea" placeholder="What happened?" rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Parts Needed</label>
                        <input type="text" id="breakdownParts" class="garage-input" placeholder="e.g., hydraulic hose, filter">
                    </div>

                    <div class="form-group">
                        <label style="color: var(--danger);">Photo (REQUIRED)</label>
                        <button class="garage-photo-btn required" onclick="takeBreakdownPhoto()">
                            <i class="fas fa-camera"></i> Take Photo
                        </button>
                        <img id="breakdownPhotoPreview" class="garage-photo-preview" style="display:none;">
                    </div>

                    <button class="garage-submit breakdown" onclick="submitBreakdown()">
                        <i class="fas fa-exclamation-triangle"></i> Report Breakdown
                    </button>
                </div>
            </div>

            <!-- Inspect Tab -->
            <div id="garageInspectTab" class="garage-panel">
                <div class="garage-form">
                    <h3 class="garage-form-title">Safety Inspection</h3>

                    <div class="form-group">
                        <label>Select Asset</label>
                        <select id="inspectAsset" class="garage-select">
                            <option value="">-- Select Tractor --</option>
                        </select>
                    </div>

                    <div class="inspection-checklist">
                        <label class="inspection-item">
                            <input type="checkbox" id="inspectLights">
                            <span class="checkmark"></span>
                            <span class="inspection-label">Lights OK</span>
                        </label>
                        <label class="inspection-item">
                            <input type="checkbox" id="inspectTires">
                            <span class="checkmark"></span>
                            <span class="inspection-label">Tires OK</span>
                        </label>
                        <label class="inspection-item">
                            <input type="checkbox" id="inspectFluids">
                            <span class="checkmark"></span>
                            <span class="inspection-label">Fluids OK</span>
                        </label>
                        <label class="inspection-item">
                            <input type="checkbox" id="inspectBrakes">
                            <span class="checkmark"></span>
                            <span class="inspection-label">Brakes OK</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="inspectNotes" class="garage-textarea" placeholder="Any issues or concerns..."></textarea>
                    </div>

                    <button class="garage-submit" onclick="submitInspection()">
                        <i class="fas fa-clipboard-check"></i> Submit Inspection
                    </button>
                </div>
            </div>

            <!-- Parts/Needs to Buy Tab -->
            <div id="garagePartsTab" class="garage-panel">
                <div class="garage-form">
                    <h3 class="garage-form-title">Needs to Buy</h3>

                    <div class="parts-input-row">
                        <input type="text" id="newPartItem" class="garage-input" placeholder="Item needed...">
                        <button class="add-part-btn" onclick="addToNeedsList()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div class="needs-list" id="needsToBuyList">
                        <!-- Items will be added here -->
                        <div class="empty-state small">
                            <i class="fas fa-shopping-cart"></i>
                            <p>No items in list</p>
                        </div>
                    </div>

                    <button class="garage-submit secondary" onclick="shareNeedsList()">
                        <i class="fas fa-share"></i> Share List
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FULL SCREEN INVENTORY CAPTURE MODE -->
    <div class="inventory-mode" id="inventoryMode">
        <div class="inventory-header">
            <div class="inventory-header-left">
                <button class="inventory-back" onclick="exitInventoryMode()">
                    <i class="fas fa-home"></i>
                </button>
                <span class="inventory-title">Inventory Count</span>
            </div>
            <div class="inventory-header-right">
                <button class="inventory-scan-btn" onclick="openScanner('inventory-count')">
                    <i class="fas fa-barcode"></i>
                </button>
            </div>
        </div>
        <div class="inventory-tabs">
            <button class="inventory-tab active" onclick="switchInventoryTab('count')" data-tab="count">Count</button>
            <button class="inventory-tab" onclick="switchInventoryTab('history')" data-tab="history">History</button>
            <button class="inventory-tab" onclick="switchInventoryTab('report')" data-tab="report">Report</button>
        </div>
        <div class="inventory-content">
            <!-- Count Tab -->
            <div id="inventoryCountTab" class="inventory-panel active">
                <div class="inventory-location-select">
                    <label>Location</label>
                    <select id="inventoryLocation" class="inventory-select">
                        <option value="">-- Select Location --</option>
                        <option value="cooler-1">Cooler 1</option>
                        <option value="cooler-2">Cooler 2</option>
                        <option value="greenhouse-1">Greenhouse 1</option>
                        <option value="greenhouse-2">Greenhouse 2</option>
                        <option value="field-storage">Field Storage</option>
                        <option value="barn">Barn</option>
                    </select>
                </div>

                <div class="inventory-item-entry">
                    <div class="inventory-entry-row">
                        <input type="text" id="inventoryItemName" class="inventory-input" placeholder="Item name or scan barcode">
                        <button class="inventory-quick-scan" onclick="openScanner('inventory-item')">
                            <i class="fas fa-qrcode"></i>
                        </button>
                    </div>
                    <div class="inventory-entry-row">
                        <input type="number" id="inventoryItemQty" class="inventory-input qty" placeholder="Qty" inputmode="numeric">
                        <select id="inventoryItemUnit" class="inventory-select unit">
                            <option value="each">Each</option>
                            <option value="lbs">Lbs</option>
                            <option value="cases">Cases</option>
                            <option value="bunches">Bunches</option>
                            <option value="flats">Flats</option>
                        </select>
                        <button class="inventory-add-btn" onclick="addInventoryItem()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="inventory-count-list" id="inventoryCountList">
                    <div class="empty-state small">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Start counting items</p>
                    </div>
                </div>

                <button class="inventory-submit-btn" onclick="submitInventoryCount()">
                    <i class="fas fa-check"></i> Submit Count
                </button>
            </div>

            <!-- History Tab -->
            <div id="inventoryHistoryTab" class="inventory-panel">
                <div id="inventoryHistoryList">
                    <div class="empty-state small">
                        <i class="fas fa-history"></i>
                        <p>No recent counts</p>
                    </div>
                </div>
            </div>

            <!-- Report Tab -->
            <div id="inventoryReportTab" class="inventory-panel">
                <div class="report-summary">
                    <h3>Today's Count Summary</h3>
                    <div class="report-stats">
                        <div class="report-stat">
                            <span class="report-stat-value" id="reportItemsCount">0</span>
                            <span class="report-stat-label">Items</span>
                        </div>
                        <div class="report-stat">
                            <span class="report-stat-value" id="reportLocationsCount">0</span>
                            <span class="report-stat-label">Locations</span>
                        </div>
                    </div>
                </div>
                <button class="inventory-submit-btn secondary" onclick="generateInventoryReport()">
                    <i class="fas fa-file-export"></i> Generate Report
                </button>
            </div>
        </div>
    </div>

    <!-- FULL SCREEN COSTING MODE -->
    <div class="costing-mode" id="costingMode">
        <div class="costing-header">
            <div class="costing-header-left">
                <button class="costing-back" onclick="exitCostingMode()">
                    <i class="fas fa-home"></i>
                </button>
                <span class="costing-title">Labor Costing</span>
            </div>
            <div class="costing-timer" id="costingTimerDisplay">
                <i class="fas fa-clock"></i>
                <span id="costingTimerValue">00:00:00</span>
            </div>
        </div>
        <div class="costing-content">
            <!-- Active Costing Task -->
            <div class="costing-active" id="costingActiveTask" style="display: none;">
                <div class="costing-active-info">
                    <div class="costing-active-task" id="costingActiveTaskName">--</div>
                    <div class="costing-active-crop" id="costingActiveCrop">--</div>
                    <div class="costing-active-field" id="costingActiveField">--</div>
                </div>
                <div class="costing-active-timer">
                    <div class="costing-big-timer" id="costingBigTimer">00:00:00</div>
                    <div class="costing-timer-controls">
                        <button class="costing-pause-btn" onclick="pauseCostingTimer()">
                            <i class="fas fa-pause"></i>
                        </button>
                        <button class="costing-stop-btn" onclick="stopCostingTask()">
                            <i class="fas fa-stop"></i> End Task
                        </button>
                    </div>
                </div>
            </div>

            <!-- Task Selection -->
            <div class="costing-task-select" id="costingTaskSelect">
                <h3 class="costing-section-title">Select Task to Track</h3>

                <div class="form-group">
                    <label>Task Type</label>
                    <select id="costingTaskType" class="costing-select">
                        <option value="">-- Select Task --</option>
                        <option value="planting">Planting</option>
                        <option value="transplanting">Transplanting</option>
                        <option value="weeding">Weeding</option>
                        <option value="cultivating">Cultivating</option>
                        <option value="harvesting">Harvesting</option>
                        <option value="washing">Washing</option>
                        <option value="packing">Packing</option>
                        <option value="seeding">Seeding Trays</option>
                        <option value="irrigation">Irrigation</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Crop (optional)</label>
                    <select id="costingCrop" class="costing-select">
                        <option value="">-- Select Crop --</option>
                        <option value="tomatoes">Tomatoes</option>
                        <option value="lettuce">Lettuce</option>
                        <option value="kale">Kale</option>
                        <option value="carrots">Carrots</option>
                        <option value="peppers">Peppers</option>
                        <option value="mixed-greens">Mixed Greens</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Field/Location (optional)</label>
                    <select id="costingField" class="costing-select">
                        <option value="">-- Select Field --</option>
                        <option value="field-1">Field 1</option>
                        <option value="field-2">Field 2</option>
                        <option value="field-3">Field 3</option>
                        <option value="greenhouse-1">Greenhouse 1</option>
                        <option value="greenhouse-2">Greenhouse 2</option>
                        <option value="packhouse">Packhouse</option>
                    </select>
                </div>

                <button class="costing-start-btn" onclick="startCostingTask()">
                    <i class="fas fa-play"></i> Start Tracking
                </button>
            </div>

            <!-- Today's Log -->
            <div class="costing-log">
                <h3 class="costing-section-title">Today's Log</h3>
                <div id="costingLogList">
                    <div class="empty-state small">
                        <i class="fas fa-clock"></i>
                        <p>No tasks logged today</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FULL SCREEN DRIVER MODE -->
    <div class="driver-mode" id="driverMode">
        <div class="driver-header">
            <div class="driver-header-left">
                <button class="driver-back" onclick="exitDriverMode()">
                    <i class="fas fa-home"></i>
                </button>
                <span class="driver-title">Deliveries</span>
            </div>
            <div class="driver-stats">
                <div class="driver-stat">
                    <div class="driver-stat-value" id="driverCompleted">0</div>
                    <div class="driver-stat-label">Done</div>
                </div>
                <div class="driver-stat">
                    <div class="driver-stat-value" id="driverRemaining">0</div>
                    <div class="driver-stat-label">Left</div>
                </div>
            </div>
        </div>
        <div class="driver-content" id="driverStopsList">
            <!-- Delivery stops loaded dynamically -->
        </div>
    </div>

    <!-- QR/BARCODE SCANNER MODAL -->
    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-header">
            <span class="scanner-title" id="scannerTitle">Scan QR Code</span>
            <button class="scanner-close" onclick="closeScanner()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="scanner-viewport">
            <video id="scannerVideo" autoplay playsinline></video>
            <div class="scanner-overlay"></div>
            <div class="scanner-hint">Position QR code in frame</div>
        </div>
        <div class="scanner-actions">
            <button class="scanner-action-btn flash" onclick="toggleFlash()">
                <i class="fas fa-bolt"></i>
            </button>
            <button class="scanner-action-btn manual" onclick="manualEntry()">
                <i class="fas fa-keyboard"></i>
            </button>
        </div>
    </div>

    <!-- Delivery Mode Panel -->
    <div class="slide-panel" id="deliveryPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closeDeliveries()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2>Deliveries</h2>
            <div class="panel-actions">
                <button class="panel-action-btn" onclick="refreshDeliveries()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        <div class="panel-content">
            <div class="delivery-summary" id="deliverySummary">
                <div class="summary-stat">
                    <span class="stat-value" id="totalStops">0</span>
                    <span class="stat-label">Total Stops</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-value" id="completedStops">0</span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-value" id="remainingStops">0</span>
                    <span class="stat-label">Remaining</span>
                </div>
            </div>
            <!-- Route Action Buttons -->
            <div class="route-actions" id="routeActions">
                <button class="route-action-btn start-route" id="startRouteBtn" onclick="startRoute()">
                    <i class="fas fa-play-circle"></i>
                    <span>Start Route</span>
                </button>
                <button class="route-action-btn running-behind" onclick="sendRunningBehindSMS()">
                    <i class="fas fa-clock"></i>
                    <span>Running Behind</span>
                </button>
            </div>

            <div class="delivery-route-list" id="deliveryRouteList">
                <div class="empty-state">
                    <i class="fas fa-truck"></i>
                    <p>No deliveries assigned today</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Stop Modal -->
    <div class="modal-overlay" id="deliveryStopModal">
        <div class="modal delivery-modal">
            <div class="modal-header">
                <h3 id="stopCustomerName">Customer Name</h3>
                <button class="modal-close" onclick="closeDeliveryStop()"></button>
            </div>
            <div class="modal-body">
                <div class="stop-address" id="stopAddress">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>123 Main St</span>
                </div>

                <!-- Quick Contact Buttons -->
                <div class="stop-contact-actions">
                    <button class="contact-btn call" onclick="callCustomer()">
                        <i class="fas fa-phone"></i>
                        <span>Call</span>
                    </button>
                    <button class="contact-btn text" onclick="textCustomer()">
                        <i class="fas fa-comment-sms"></i>
                        <span>Text</span>
                    </button>
                    <button class="contact-btn email" onclick="emailCustomer()">
                        <i class="fas fa-envelope"></i>
                        <span>Email</span>
                    </button>
                    <button class="contact-btn navigate" onclick="navigateToCurrentStop()">
                        <i class="fas fa-directions"></i>
                        <span>Navigate</span>
                    </button>
                </div>

                <div class="stop-items" id="stopItems">
                    <!-- Items list -->
                </div>
                <div class="stop-notes" id="stopNotes"></div>

                <div class="pod-section">
                    <label class="pod-label">Photo Proof of Delivery</label>
                    <div class="photo-capture" id="podPhotoCapture" onclick="capturePODPhoto()">
                        <div class="photo-placeholder" id="podPlaceholder">
                            <i class="fas fa-camera photo-icon"></i>
                            <p>Tap to take photo</p>
                        </div>
                        <img id="podPhotoPreview" style="display: none;">
                        <button class="retake-btn" id="podRetake" style="display: none;" onclick="event.stopPropagation(); retakePODPhoto()">Retake</button>
                    </div>
                </div>

                <div class="pod-section">
                    <label class="pod-label">Customer Signature</label>
                    <div class="signature-pad">
                        <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                        <button class="signature-clear" onclick="clearSignature()">Clear</button>
                        <div class="signature-line"></div>
                        <span class="signature-label">Sign above</span>
                    </div>
                </div>

                <div class="pod-actions">
                    <button class="btn-complete-delivery" onclick="completeDelivery()">
                        <i class="fas fa-check"></i> Complete Delivery
                    </button>
                    <button class="btn-report-issue" onclick="reportDeliveryIssue()">
                        <i class="fas fa-exclamation-triangle"></i> Report Issue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timesheet Panel -->
    <div class="slide-panel" id="timesheetPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closeTimesheet()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2>My Timesheet</h2>
            <div class="panel-actions">
                <button class="panel-action-btn" onclick="exportTimesheet()">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
        <div class="panel-content">
            <!-- Anomaly Warnings -->
            <div class="anomaly-warnings" id="anomalyWarnings" style="display: none;">
                <div class="warning-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Attention Required</span>
                </div>
                <div class="warning-list" id="warningList"></div>
            </div>

            <!-- Pay Period Summary -->
            <div class="pay-period-card">
                <div class="period-header">
                    <span class="period-label">Current Pay Period</span>
                    <span class="period-dates" id="payPeriodDates">Jan 1 - Jan 15</span>
                </div>
                <div class="period-stats">
                    <div class="period-stat">
                        <span class="period-value" id="periodHours">0.0</span>
                        <span class="period-label">Hours</span>
                    </div>
                    <div class="period-stat">
                        <span class="period-value" id="periodOT">0.0</span>
                        <span class="period-label">Overtime</span>
                    </div>
                    <div class="period-stat projected">
                        <span class="period-value" id="periodGross">$0</span>
                        <span class="period-label">Est. Gross</span>
                    </div>
                </div>
            </div>

            <!-- Weekly Breakdown -->
            <div class="timesheet-section">
                <h3>This Week</h3>
                <div class="timesheet-days" id="timesheetDays">
                    <!-- Days populated by JS -->
                </div>
            </div>

            <!-- QuickBooks Sync Status -->
            <div class="qb-sync-status" id="qbSyncStatus">
                <div class="sync-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="sync-info">
                    <span class="sync-label">QuickBooks Sync</span>
                    <span class="sync-time" id="lastSyncTime">Last synced: --</span>
                </div>
                <span class="sync-badge" id="syncBadge">Pending</span>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle toast-icon"></i>
        <span class="toast-message" id="toastMessage"></span>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Task Completion Overlay -->
    <div class="completion-overlay" id="completionOverlay">
        <div class="completion-content">
            <div class="completion-checkmark">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="completion-title">Task Complete!</h2>
            <div class="completion-stats" id="completionStats">
                <div class="completion-stat">
                    <span class="completion-stat-label">Time Logged</span>
                    <span class="completion-stat-value" id="completionTime">--</span>
                </div>
                <div class="completion-stat">
                    <span class="completion-stat-label">Benchmark</span>
                    <span class="completion-stat-value" id="completionBenchmark">--</span>
                </div>
                <div class="completion-stat">
                    <span class="completion-stat-label">Efficiency</span>
                    <span class="completion-stat-value efficiency" id="completionEfficiency">--</span>
                </div>
                <div class="completion-stat">
                    <span class="completion-stat-label">Employee</span>
                    <span class="completion-stat-value" id="completionEmployee">--</span>
                </div>
            </div>
            <button class="completion-undo" id="completionUndo" onclick="undoTaskCompletion()">
                <i class="fas fa-undo"></i> Undo (5s)
            </button>
            <button class="completion-continue" onclick="closeCompletionOverlay()">
                <i class="fas fa-arrow-right"></i> Continue to Next Task
            </button>
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-preview">
            <video id="cameraVideo" autoplay playsinline></video>
            <img id="capturedImage" style="display: none;">
        </div>
        <div class="camera-controls" id="cameraControls">
            <button class="camera-btn cancel" onclick="closeCamera()">
                <i class="fas fa-times"></i>
            </button>
            <button class="camera-btn capture" onclick="captureImage()">
                <i class="fas fa-camera"></i>
            </button>
        </div>
        <div class="camera-controls" id="confirmControls" style="display: none;">
            <button class="camera-btn cancel" onclick="retakePhoto()">
                <i class="fas fa-redo"></i>
            </button>
            <button class="camera-btn confirm" onclick="confirmPhoto()">
                <i class="fas fa-check"></i>
            </button>
        </div>
    </div>

    <!-- AI Plant Doctor Modal -->
    <div class="ai-modal" id="aiDoctorModal">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h2><i class="fas fa-robot"></i> <span data-i18n="ai.title">AI Plant Doctor</span></h2>
                <button class="ai-close-btn" onclick="closeAIDoctor()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Step 1: Photo Capture -->
            <div class="ai-step" id="aiStep1">
                <div class="ai-instructions">
                    <i class="fas fa-camera"></i>
                    <h3 data-i18n="ai.takePhoto">Take a Photo</h3>
                    <p data-i18n="ai.photoHint">Get a clear, close-up shot of the affected plant, leaf, or insect</p>
                </div>
                <div class="ai-photo-options">
                    <button class="ai-option-btn" onclick="captureAIPhoto()">
                        <i class="fas fa-camera"></i>
                        <span data-i18n="ai.useCamera">Use Camera</span>
                    </button>
                    <button class="ai-option-btn" onclick="selectAIPhoto()">
                        <i class="fas fa-images"></i>
                        <span data-i18n="ai.choosePhoto">Choose from Gallery</span>
                    </button>
                </div>
                <input type="file" id="aiPhotoInput" accept="image/*" style="display: none;" onchange="handleAIPhotoSelect(event)">
            </div>

            <!-- Step 2: Photo Preview & Analyze -->
            <div class="ai-step" id="aiStep2" style="display: none;">
                <div class="ai-photo-preview">
                    <img id="aiPhotoPreview" src="" alt="Photo to analyze">
                </div>
                <div class="ai-mode-select">
                    <label class="form-label" data-i18n="ai.whatAnalyze">What do you want to analyze?</label>
                    <div class="ai-mode-buttons">
                        <button class="ai-mode-btn active" onclick="setAIMode('plant')" id="aiModePlant">
                            <i class="fas fa-seedling"></i>
                            <span data-i18n="ai.plantHealth">Plant Health</span>
                        </button>
                        <button class="ai-mode-btn" onclick="setAIMode('bug')" id="aiModeBug">
                            <i class="fas fa-bug"></i>
                            <span data-i18n="ai.bugId">Bug ID</span>
                        </button>
                    </div>
                </div>
                <div class="ai-actions">
                    <button class="btn-secondary" onclick="retakeAIPhoto()">
                        <i class="fas fa-redo"></i> <span data-i18n="ai.retake">Retake</span>
                    </button>
                    <button class="btn-primary" onclick="analyzePhoto()">
                        <i class="fas fa-search"></i> <span data-i18n="ai.analyze">Analyze</span>
                    </button>
                </div>
            </div>

            <!-- Step 3: Analyzing -->
            <div class="ai-step" id="aiStep3" style="display: none;">
                <div class="ai-analyzing">
                    <div class="ai-spinner"></div>
                    <h3 data-i18n="ai.analyzing">Analyzing...</h3>
                    <p data-i18n="ai.pleaseWait">Our AI is examining your photo</p>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div class="ai-step" id="aiStep4" style="display: none;">
                <div class="ai-results">
                    <div class="ai-result-header" id="aiResultHeader">
                        <div class="ai-result-icon" id="aiResultIcon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="ai-result-title">
                            <h3 id="aiResultTitle">Diagnosis</h3>
                            <span class="ai-confidence" id="aiConfidence">95% confident</span>
                        </div>
                    </div>

                    <div class="ai-result-card">
                        <h4 data-i18n="ai.identification">Identification</h4>
                        <p id="aiIdentification">Loading...</p>
                    </div>

                    <div class="ai-result-card" id="aiDescriptionCard">
                        <h4 data-i18n="ai.description">Description</h4>
                        <p id="aiDescription">Loading...</p>
                    </div>

                    <div class="ai-result-card" id="aiTreatmentCard">
                        <h4 data-i18n="ai.treatment">Recommended Action</h4>
                        <p id="aiTreatment">Loading...</p>
                    </div>

                    <div class="ai-result-card beneficial" id="aiBeneficialCard" style="display: none;">
                        <h4><i class="fas fa-thumbs-up"></i> <span data-i18n="ai.beneficial">Beneficial Insect!</span></h4>
                        <p id="aiBeneficialInfo">This insect helps your garden.</p>
                    </div>

                    <div class="ai-result-actions">
                        <button class="btn-secondary" onclick="newAIAnalysis()">
                            <i class="fas fa-camera"></i> <span data-i18n="ai.newPhoto">New Photo</span>
                        </button>
                        <button class="btn-primary" onclick="createScoutFromAI()">
                            <i class="fas fa-file-alt"></i> <span data-i18n="ai.createReport">Create Report</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Treatment Log Modal -->
    <div class="feature-modal" id="treatmentModal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <button class="back-btn" onclick="closeTreatmentModal()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-spray-can"></i> <span data-i18n="treatment.title">Treatment Log</span></h2>
            </div>
            <div class="feature-modal-body">
                <!-- Active REI Warnings -->
                <div class="rei-warnings" id="reiWarnings" style="display: none;">
                    <div class="warning-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span data-i18n="treatment.activeREI">Active Re-Entry Restrictions</span>
                    </div>
                    <div id="reiWarningsList"></div>
                </div>

                <div class="form-card">
                    <div class="form-group">
                        <label class="form-label" data-i18n="treatment.material">Material Applied</label>
                        <select class="form-input" id="treatmentMaterial" onchange="updateMaterialInfo()">
                            <option value="">Select material...</option>
                            <option value="neem">Neem Oil (OMRI)</option>
                            <option value="bt">Bt - Bacillus thuringiensis (OMRI)</option>
                            <option value="spinosad">Spinosad (OMRI)</option>
                            <option value="copper">Copper Fungicide (OMRI)</option>
                            <option value="sulfur">Sulfur (OMRI)</option>
                            <option value="pyrethrin">Pyrethrin (OMRI)</option>
                            <option value="kaolin">Kaolin Clay (OMRI)</option>
                            <option value="insectsoap">Insecticidal Soap (OMRI)</option>
                            <option value="other">Other (specify)</option>
                        </select>
                        <input type="text" class="form-input" id="treatmentOther" placeholder="Specify material..." style="display: none; margin-top: 8px;">
                    </div>

                    <div class="material-info" id="materialInfo" style="display: none;">
                        <span class="omri-badge"><i class="fas fa-leaf"></i> OMRI Listed</span>
                        <span class="rei-info" id="reiInfo">REI: 4 hours</span>
                        <span class="phi-info" id="phiInfo">PHI: 0 days</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="treatment.field">Field</label>
                            <select class="form-input" id="treatmentField">
                                <option value="">Select...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="treatment.beds">Beds</label>
                            <input type="text" class="form-input" id="treatmentBeds" placeholder="e.g., 1-5, 8">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="treatment.rate">Rate</label>
                            <input type="text" class="form-input" id="treatmentRate" placeholder="e.g., 2 tbsp/gal">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="treatment.amount">Amount Used</label>
                            <input type="text" class="form-input" id="treatmentAmount" placeholder="e.g., 5 gallons">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="treatment.target">Target Pest/Disease</label>
                        <input type="text" class="form-input" id="treatmentTarget" placeholder="e.g., Aphids, Powdery Mildew">
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="treatment.weather">Weather Conditions</label>
                        <div class="weather-buttons">
                            <button class="weather-btn" onclick="setWeather('sunny')"><i class="fas fa-sun"></i></button>
                            <button class="weather-btn" onclick="setWeather('cloudy')"><i class="fas fa-cloud"></i></button>
                            <button class="weather-btn" onclick="setWeather('rainy')"><i class="fas fa-cloud-rain"></i></button>
                            <button class="weather-btn" onclick="setWeather('windy')"><i class="fas fa-wind"></i></button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="treatment.notes">Notes</label>
                        <textarea class="form-input" id="treatmentNotes" rows="2"></textarea>
                    </div>

                    <button class="submit-btn" onclick="submitTreatment()">
                        <i class="fas fa-check"></i>
                        <span data-i18n="treatment.submit">Log Treatment</span>
                    </button>
                </div>

                <!-- Beneficial Release Section -->
                <div class="form-card" style="margin-top: 16px;">
                    <div class="form-card-header">
                        <i class="fas fa-bug"></i>
                        <span data-i18n="treatment.beneficial">Beneficial Release</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="treatment.beneficialType">Type</label>
                        <select class="form-input" id="beneficialType">
                            <option value="">Select...</option>
                            <option value="ladybugs">Ladybugs</option>
                            <option value="lacewings">Green Lacewings</option>
                            <option value="parasitic_wasps">Parasitic Wasps</option>
                            <option value="predatory_mites">Predatory Mites</option>
                            <option value="nematodes">Beneficial Nematodes</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="treatment.quantity">Quantity</label>
                            <input type="text" class="form-input" id="beneficialQty" placeholder="e.g., 1500">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="treatment.location">Location</label>
                            <select class="form-input" id="beneficialField">
                                <option value="">Select field...</option>
                            </select>
                        </div>
                    </div>
                    <button class="submit-btn secondary" onclick="submitBeneficialRelease()">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="treatment.logRelease">Log Release</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hazard Report Modal -->
    <div class="feature-modal" id="hazardModal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <button class="back-btn" onclick="closeHazardModal()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-triangle-exclamation"></i> <span data-i18n="hazard.title">Field Hazards</span></h2>
            </div>
            <div class="feature-modal-body">
                <!-- Active Hazards List -->
                <div class="active-hazards" id="activeHazardsList">
                    <h3 data-i18n="hazard.active">Active Hazards</h3>
                    <div id="hazardCards"></div>
                </div>

                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="hazard.report">Report New Hazard</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="hazard.type">Hazard Type</label>
                        <div class="hazard-type-grid">
                            <button class="hazard-type-btn" onclick="setHazardType('groundhog')">
                                <i class="fas fa-hippo"></i>
                                <span>Groundhog Hole</span>
                            </button>
                            <button class="hazard-type-btn" onclick="setHazardType('drainage')">
                                <i class="fas fa-water"></i>
                                <span>Drainage Issue</span>
                            </button>
                            <button class="hazard-type-btn" onclick="setHazardType('equipment')">
                                <i class="fas fa-tools"></i>
                                <span>Equipment</span>
                            </button>
                            <button class="hazard-type-btn" onclick="setHazardType('debris')">
                                <i class="fas fa-tree"></i>
                                <span>Debris</span>
                            </button>
                            <button class="hazard-type-btn" onclick="setHazardType('irrigation')">
                                <i class="fas fa-faucet-drip"></i>
                                <span>Irrigation</span>
                            </button>
                            <button class="hazard-type-btn" onclick="setHazardType('other')">
                                <i class="fas fa-question"></i>
                                <span>Other</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="hazard.severity">Severity</label>
                        <div class="severity-buttons">
                            <button class="severity-btn low" onclick="setHazardSeverity('low')">Low</button>
                            <button class="severity-btn medium" onclick="setHazardSeverity('medium')">Medium</button>
                            <button class="severity-btn high" onclick="setHazardSeverity('high')">High</button>
                            <button class="severity-btn critical" onclick="setHazardSeverity('critical')">Critical</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="hazard.description">Description</label>
                        <textarea class="form-input" id="hazardDescription" rows="2" placeholder="Describe the hazard..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="hazard.photo">Photo</label>
                        <div class="photo-capture-btn" onclick="capturePhoto('hazard')">
                            <i class="fas fa-camera"></i>
                            <span>Take Photo</span>
                        </div>
                        <div class="photo-preview" id="hazardPhotoPreview" style="display: none;"></div>
                    </div>

                    <button class="submit-btn danger" onclick="submitHazard()">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span data-i18n="hazard.submit">Report Hazard</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Weed Pressure Modal -->
    <div class="feature-modal" id="weedModal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <button class="back-btn" onclick="closeWeedModal()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-seedling"></i> <span data-i18n="weed.title">Weed Pressure</span></h2>
            </div>
            <div class="feature-modal-body">
                <div class="form-card">
                    <div class="form-group">
                        <label class="form-label" data-i18n="weed.field">Field / Bed</label>
                        <div class="form-row">
                            <select class="form-input" id="weedField">
                                <option value="">Select field...</option>
                            </select>
                            <input type="text" class="form-input" id="weedBed" placeholder="Bed #">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="weed.type">Weed Type</label>
                        <div class="weed-type-grid">
                            <button class="weed-type-btn" onclick="setWeedType('annual_broadleaf')">
                                <span>Annual Broadleaf</span>
                            </button>
                            <button class="weed-type-btn" onclick="setWeedType('perennial_broadleaf')">
                                <span>Perennial Broadleaf</span>
                            </button>
                            <button class="weed-type-btn" onclick="setWeedType('annual_grass')">
                                <span>Annual Grass</span>
                            </button>
                            <button class="weed-type-btn" onclick="setWeedType('perennial_grass')">
                                <span>Perennial Grass</span>
                            </button>
                            <button class="weed-type-btn" onclick="setWeedType('sedge')">
                                <span>Sedge/Nutsedge</span>
                            </button>
                            <button class="weed-type-btn" onclick="setWeedType('vine')">
                                <span>Vine/Creeper</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="weed.species">Species (if known)</label>
                        <input type="text" class="form-input" id="weedSpecies" placeholder="e.g., Pigweed, Lambsquarter">
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="weed.pressure">Pressure Level</label>
                        <div class="pressure-slider">
                            <input type="range" id="weedPressure" min="1" max="5" value="3" oninput="updatePressureLabel()">
                            <div class="pressure-labels">
                                <span>Light</span>
                                <span>Moderate</span>
                                <span>Heavy</span>
                            </div>
                            <div class="pressure-value" id="pressureValue">3 - Moderate</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="weed.coverage">Coverage %</label>
                        <input type="number" class="form-input" id="weedCoverage" placeholder="0-100" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="weed.notes">Notes</label>
                        <textarea class="form-input" id="weedNotes" rows="2"></textarea>
                    </div>

                    <button class="submit-btn" onclick="submitWeedPressure()">
                        <i class="fas fa-check"></i>
                        <span data-i18n="weed.submit">Log Weed Pressure</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cultivation Log Modal -->
    <div class="feature-modal" id="cultivationModal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <button class="back-btn" onclick="closeCultivationModal()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-tractor"></i> <span data-i18n="cultivation.title">Cultivation Log</span></h2>
            </div>
            <div class="feature-modal-body">
                <div class="form-card">
                    <div class="form-group">
                        <label class="form-label" data-i18n="cultivation.field">Field / Beds</label>
                        <div class="form-row">
                            <select class="form-input" id="cultivationField">
                                <option value="">Select field...</option>
                            </select>
                            <input type="text" class="form-input" id="cultivationBeds" placeholder="Beds (e.g., 1-10)">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="cultivation.implement">Implement Used</label>
                        <div class="implement-grid">
                            <button class="implement-btn" onclick="setImplement('wheel_hoe')">
                                <i class="fas fa-circle"></i>
                                <span>Wheel Hoe</span>
                            </button>
                            <button class="implement-btn" onclick="setImplement('stirrup')">
                                <i class="fas fa-horse"></i>
                                <span>Stirrup Hoe</span>
                            </button>
                            <button class="implement-btn" onclick="setImplement('collinear')">
                                <i class="fas fa-minus"></i>
                                <span>Collinear</span>
                            </button>
                            <button class="implement-btn" onclick="setImplement('tractor')">
                                <i class="fas fa-tractor"></i>
                                <span>Tractor</span>
                            </button>
                            <button class="implement-btn" onclick="setImplement('flame')">
                                <i class="fas fa-fire"></i>
                                <span>Flame Weeder</span>
                            </button>
                            <button class="implement-btn" onclick="setImplement('hand')">
                                <i class="fas fa-hand"></i>
                                <span>Hand Pull</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="cultivation.depth">Depth</label>
                        <div class="depth-buttons">
                            <button class="depth-btn" onclick="setDepth('shallow')">Shallow (1")</button>
                            <button class="depth-btn" onclick="setDepth('medium')">Medium (2")</button>
                            <button class="depth-btn" onclick="setDepth('deep')">Deep (3"+)</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="cultivation.soilCondition">Soil Condition</label>
                        <div class="soil-buttons">
                            <button class="soil-btn" onclick="setSoil('dry')"><i class="fas fa-sun"></i> Dry</button>
                            <button class="soil-btn" onclick="setSoil('moist')"><i class="fas fa-tint"></i> Moist</button>
                            <button class="soil-btn" onclick="setSoil('wet')"><i class="fas fa-water"></i> Wet</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="cultivation.effectiveness">Effectiveness</label>
                        <div class="effectiveness-buttons">
                            <button class="eff-btn" onclick="setEffectiveness('poor')">Poor</button>
                            <button class="eff-btn" onclick="setEffectiveness('fair')">Fair</button>
                            <button class="eff-btn" onclick="setEffectiveness('good')">Good</button>
                            <button class="eff-btn" onclick="setEffectiveness('excellent')">Excellent</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="cultivation.notes">Notes</label>
                        <textarea class="form-input" id="cultivationNotes" rows="2"></textarea>
                    </div>

                    <button class="submit-btn" onclick="submitCultivation()">
                        <i class="fas fa-check"></i>
                        <span data-i18n="cultivation.submit">Log Cultivation</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Wildlife Tracker Modal -->
    <div class="feature-modal" id="wildlifeModal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <button class="back-btn" onclick="closeWildlifeModal()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-paw"></i> <span data-i18n="wildlife.title">Wildlife Tracker</span></h2>
            </div>
            <div class="feature-modal-body">
                <!-- Tab Navigation for Wildlife -->
                <div class="wildlife-tabs">
                    <button class="wildlife-tab active" onclick="switchWildlifeTab('sighting')">
                        <i class="fas fa-eye"></i> Sighting
                    </button>
                    <button class="wildlife-tab" onclick="switchWildlifeTab('den')">
                        <i class="fas fa-house"></i> Den
                    </button>
                    <button class="wildlife-tab" onclick="switchWildlifeTab('damage')">
                        <i class="fas fa-exclamation-triangle"></i> Damage
                    </button>
                    <button class="wildlife-tab" onclick="switchWildlifeTab('map')">
                        <i class="fas fa-map"></i> Map
                    </button>
                </div>

                <!-- Sighting Form -->
                <div id="wildlifeSightingForm" class="wildlife-form-panel">
                    <div class="form-card">
                        <div class="form-group">
                            <label class="form-label">Animal Type</label>
                            <div class="animal-grid">
                                <button class="animal-btn" onclick="setAnimalType('groundhog')">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span>Groundhog</span>
                                </button>
                                <button class="animal-btn" onclick="setAnimalType('deer')">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span>Deer</span>
                                </button>
                                <button class="animal-btn" onclick="setAnimalType('rabbit')">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span>Rabbit</span>
                                </button>
                                <button class="animal-btn" onclick="setAnimalType('raccoon')">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span>Raccoon</span>
                                </button>
                                <button class="animal-btn" onclick="setAnimalType('bird')">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span>Bird</span>
                                </button>
                                <button class="animal-btn" onclick="setAnimalType('other')">
                                    <span style="font-size: 1.5rem;"></span>
                                    <span>Other</span>
                                </button>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Count</label>
                                <input type="number" class="form-input" id="wildlifeCount" value="1" min="1">
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Field</label>
                                <select class="form-input" id="wildlifeField">
                                    <option value="">Select field...</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Activity</label>
                            <select class="form-input" id="wildlifeActivity">
                                <option value="feeding">Feeding</option>
                                <option value="traveling">Traveling</option>
                                <option value="resting">Resting</option>
                                <option value="digging">Digging</option>
                                <option value="damage">Causing Damage</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <div class="photo-capture">
                                <button type="button" class="capture-btn" onclick="openCameraForWildlife()">
                                    <i class="fas fa-camera"></i> Take Photo
                                </button>
                                <div id="wildlifePhotoPreview" class="photo-preview" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="wildlifeNotes" rows="2" placeholder="Any additional observations..."></textarea>
                        </div>

                        <button class="submit-btn" onclick="submitWildlifeSighting()">
                            <i class="fas fa-check"></i>
                            <span>Log Sighting</span>
                        </button>
                    </div>
                </div>

                <!-- Groundhog Den Form -->
                <div id="wildlifeDenForm" class="wildlife-form-panel" style="display: none;">
                    <div class="form-card">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                            <i class="fas fa-house"></i> Log Groundhog Den
                        </h3>

                        <div class="form-group">
                            <label class="form-label">Field Location</label>
                            <select class="form-input" id="denField">
                                <option value="">Select field...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Den Size</label>
                            <div class="den-size-buttons">
                                <button class="den-size-btn" onclick="setDenSize('small')">Small</button>
                                <button class="den-size-btn" onclick="setDenSize('medium')">Medium</button>
                                <button class="den-size-btn" onclick="setDenSize('large')">Large</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Activity Level</label>
                            <div class="activity-level-buttons">
                                <button class="activity-btn" onclick="setDenActivity('low')">Low</button>
                                <button class="activity-btn" onclick="setDenActivity('medium')">Medium</button>
                                <button class="activity-btn" onclick="setDenActivity('high')">High</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <div class="photo-capture">
                                <button type="button" class="capture-btn" onclick="openCameraForDen()">
                                    <i class="fas fa-camera"></i> Take Photo
                                </button>
                                <div id="denPhotoPreview" class="photo-preview" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="denNotes" rows="2" placeholder="Signs of activity, nearby crops..."></textarea>
                        </div>

                        <button class="submit-btn" onclick="submitGroundhogDen()">
                            <i class="fas fa-check"></i>
                            <span>Log Den Location</span>
                        </button>

                        <h3 style="color: var(--text-primary); margin: 1.5rem 0 1rem;">Active Dens</h3>
                        <div id="activeDensList" class="dens-list">
                            <!-- Loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Damage Report Form -->
                <div id="wildlifeDamageForm" class="wildlife-form-panel" style="display: none;">
                    <div class="form-card">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i> Report Crop Damage
                        </h3>

                        <div class="form-group">
                            <label class="form-label">Animal Responsible</label>
                            <select class="form-input" id="damageAnimal">
                                <option value="groundhog">Groundhog</option>
                                <option value="deer">Deer</option>
                                <option value="rabbit">Rabbit</option>
                                <option value="bird">Bird</option>
                                <option value="unknown">Unknown</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Field</label>
                                <select class="form-input" id="damageField">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Bed</label>
                                <input type="text" class="form-input" id="damageBed" placeholder="Bed #">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Crop Affected</label>
                            <input type="text" class="form-input" id="damageCrop" placeholder="e.g., Lettuce, Tomatoes">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Damage Severity</label>
                            <div class="severity-buttons">
                                <button class="severity-btn low" onclick="setDamageSeverity('low')">Low</button>
                                <button class="severity-btn medium" onclick="setDamageSeverity('medium')">Medium</button>
                                <button class="severity-btn high" onclick="setDamageSeverity('high')">High</button>
                                <button class="severity-btn critical" onclick="setDamageSeverity('critical')">Total Loss</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Estimated Loss ($)</label>
                            <input type="number" class="form-input" id="damageLoss" placeholder="0.00" step="0.01">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <div class="photo-capture">
                                <button type="button" class="capture-btn" onclick="openCameraForDamage()">
                                    <i class="fas fa-camera"></i> Take Photo
                                </button>
                                <div id="damagePhotoPreview" class="photo-preview" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="damageNotes" rows="2"></textarea>
                        </div>

                        <button class="submit-btn danger" onclick="submitDamageReport()">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Report Damage</span>
                        </button>
                    </div>
                </div>

                <!-- Wildlife Map -->
                <div id="wildlifeMapPanel" class="wildlife-form-panel" style="display: none;">
                    <div class="form-card">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                            <i class="fas fa-map"></i> Wildlife Activity Map
                        </h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Summary of wildlife activity in the last 30 days.
                        </p>
                        <div id="wildlifeSummary" class="wildlife-summary">
                            <!-- Loaded dynamically -->
                        </div>
                        <div id="recentDamageList" class="damage-list">
                            <h4 style="color: var(--text-primary); margin: 1rem 0 0.5rem;">Recent Damage Reports</h4>
                            <!-- Loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pick & Pack Modal -->
    <div class="feature-modal" id="pickPackModal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <button class="back-btn" onclick="closePickPackModal()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-boxes-stacked"></i> <span data-i18n="pickpack.title">Pick & Pack</span></h2>
            </div>
            <div class="feature-modal-body">
                <!-- Tab Navigation for Pick & Pack -->
                <div class="pickpack-tabs">
                    <button class="pickpack-tab active" onclick="switchPickPackTab('pick')">
                        <i class="fas fa-basket-shopping"></i> Pick List
                    </button>
                    <button class="pickpack-tab" onclick="switchPickPackTab('pack')">
                        <i class="fas fa-box"></i> Pack Orders
                    </button>
                </div>

                <!-- Pick List Panel -->
                <div id="pickListPanel" class="pickpack-panel">
                    <div class="pick-header">
                        <div class="pick-date">
                            <i class="fas fa-calendar"></i>
                            <span id="pickListDate">Today</span>
                        </div>
                        <div class="pick-header-actions">
                            <button class="print-btn" onclick="printPickList()">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="refresh-btn" onclick="loadPickList()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div class="pick-stats">
                        <div class="pick-stat">
                            <span class="stat-value" id="pickTotalItems">0</span>
                            <span class="stat-label">Items</span>
                        </div>
                        <div class="pick-stat">
                            <span class="stat-value" id="pickCompletedItems">0</span>
                            <span class="stat-label">Picked</span>
                        </div>
                        <div class="pick-stat">
                            <span class="stat-value" id="pickOrders">0</span>
                            <span class="stat-label">Orders</span>
                        </div>
                    </div>

                    <div id="pickListItems" class="pick-items-list">
                        <!-- Pick items loaded dynamically -->
                        <div class="empty-state">
                            <i class="fas fa-clipboard-check"></i>
                            <p>No items to pick today</p>
                        </div>
                    </div>
                </div>

                <!-- Pack Orders Panel -->
                <div id="packOrdersPanel" class="pickpack-panel" style="display: none;">
                    <div class="pack-header">
                        <h3>Orders Ready to Pack</h3>
                    </div>

                    <div id="packOrdersList" class="pack-orders-list">
                        <!-- Orders loaded dynamically -->
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <p>No orders ready to pack</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Farm Pics Modal -->
    <div class="feature-modal" id="farmPicsModal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <button class="back-btn" onclick="closeFarmPicsModal()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-camera-retro"></i> <span data-i18n="farmpics.title">Farm Pics</span></h2>
            </div>
            <div class="feature-modal-body">
                <div class="farmpics-intro" style="text-align: center; padding: 1rem; margin-bottom: 1rem; background: linear-gradient(135deg, rgba(225, 48, 108, 0.1), rgba(155, 89, 182, 0.1)); border-radius: 12px;">
                    <i class="fas fa-heart" style="font-size: 2rem; color: #E1306C; margin-bottom: 0.5rem;"></i>
                    <h3 style="margin-bottom: 0.5rem;">Help Us Share the Farm Story!</h3>
                    <p style="color: #666; font-size: 0.9rem;">Your photos may be used in our marketing. You'll be credited!</p>
                </div>

                <div class="farmpics-categories" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                    <button class="farmpics-category-btn active" onclick="selectFarmPicCategory('harvest')" style="padding: 1rem; border-radius: 12px; border: 2px solid #E1306C; background: rgba(225, 48, 108, 0.1); color: #333; cursor: pointer;">
                        <i class="fas fa-basket-shopping" style="color: #E1306C; font-size: 1.25rem; display: block; margin-bottom: 0.5rem;"></i>
                        <span>Harvest</span>
                    </button>
                    <button class="farmpics-category-btn" onclick="selectFarmPicCategory('greenhouse')" style="padding: 1rem; border-radius: 12px; border: 2px solid #ddd; background: white; color: #333; cursor: pointer;">
                        <i class="fas fa-seedling" style="color: #4a7c43; font-size: 1.25rem; display: block; margin-bottom: 0.5rem;"></i>
                        <span>Greenhouse</span>
                    </button>
                    <button class="farmpics-category-btn" onclick="selectFarmPicCategory('team')" style="padding: 1rem; border-radius: 12px; border: 2px solid #ddd; background: white; color: #333; cursor: pointer;">
                        <i class="fas fa-users" style="color: #4361ee; font-size: 1.25rem; display: block; margin-bottom: 0.5rem;"></i>
                        <span>Team</span>
                    </button>
                    <button class="farmpics-category-btn" onclick="selectFarmPicCategory('scenic')" style="padding: 1rem; border-radius: 12px; border: 2px solid #ddd; background: white; color: #333; cursor: pointer;">
                        <i class="fas fa-sun" style="color: #f59e0b; font-size: 1.25rem; display: block; margin-bottom: 0.5rem;"></i>
                        <span>Scenic</span>
                    </button>
                </div>

                <div class="farmpics-upload" style="border: 3px dashed #E1306C; border-radius: 16px; padding: 2rem; text-align: center; margin-bottom: 1rem; cursor: pointer;" onclick="document.getElementById('farmPicFileInput').click()">
                    <input type="file" id="farmPicFileInput" accept="image/*" capture="environment" style="display: none;" onchange="handleFarmPicSelect(event)">
                    <img id="farmPicPreview" style="display: none; max-width: 100%; max-height: 200px; border-radius: 12px; margin-bottom: 1rem;">
                    <div id="farmPicUploadPrompt">
                        <i class="fas fa-camera" style="font-size: 3rem; color: #E1306C; margin-bottom: 1rem;"></i>
                        <h4>Tap to Take Photo</h4>
                        <p style="color: #666; font-size: 0.9rem;">or choose from gallery</p>
                    </div>
                </div>

                <div class="farmpics-caption" style="margin-bottom: 1rem;">
                    <textarea id="farmPicCaption" placeholder="Add a caption (optional)..." style="width: 100%; padding: 1rem; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; resize: none; height: 80px;"></textarea>
                </div>

                <button id="submitFarmPicBtn" onclick="submitFarmPic()" disabled style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #E1306C, #9b59b6); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; opacity: 0.5;">
                    <i class="fas fa-paper-plane"></i> Submit to Marketing
                </button>

                <div class="farmpics-recent" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: #333;"><i class="fas fa-history"></i> Your Recent Submissions</h4>
                    <div id="recentFarmPics" style="display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem;">
                        <!-- Recent pics loaded here -->
                        <div style="text-align: center; color: #999; padding: 1rem; width: 100%;">
                            <i class="fas fa-images" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <p style="font-size: 0.85rem;">No submissions yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div class="feature-modal" id="messagesModal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <button class="back-btn" onclick="closeMessagesModal()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-envelope"></i> <span data-i18n="messages.title">Messages</span></h2>
            </div>
            <div class="feature-modal-body">
                <div id="messagesList" class="messages-list">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="empty-messages" id="emptyMessages">
                    <i class="fas fa-inbox"></i>
                    <p data-i18n="messages.empty">No messages</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Heat Safety Alert -->
    <div class="safety-alert" id="heatAlert" style="display: none;">
        <div class="safety-alert-content">
            <div class="safety-icon">
                <i class="fas fa-temperature-high"></i>
            </div>
            <div class="safety-message">
                <h3 data-i18n="safety.heatTitle">Heat Safety Reminder</h3>
                <p data-i18n="safety.heatMessage">It's hot outside! Remember to take breaks, drink water, and find shade.</p>
            </div>
            <button class="safety-dismiss" onclick="dismissHeatAlert()">
                <i class="fas fa-check"></i> <span data-i18n="safety.gotIt">Got It</span>
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // PWA - SERVICE WORKER & INSTALL PROMPT
        // ============================================
        let deferredInstallPrompt = null;
        let swRegistration = null;

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    swRegistration = await navigator.serviceWorker.register('/sw.js');
                    console.log('[PWA] Service Worker registered:', swRegistration.scope);

                    // Check for updates
                    swRegistration.addEventListener('updatefound', () => {
                        const newWorker = swRegistration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                showUpdateBanner();
                            }
                        });
                    });

                    // Listen for messages from service worker
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data.type === 'SYNC_AVAILABLE') {
                            console.log('[PWA] Background sync available');
                            if (typeof syncOfflineData === 'function') {
                                syncOfflineData();
                            }
                        }
                    });
                } catch (error) {
                    console.log('[PWA] Service Worker registration failed:', error);
                }
            });
        }

        // Capture install prompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('[PWA] beforeinstallprompt fired');
            e.preventDefault();
            deferredInstallPrompt = e;

            // Show install prompt after a delay (don't be too aggressive)
            const lastDismissed = localStorage.getItem('pwa_install_dismissed');
            const daysSinceDismissed = lastDismissed ?
                (Date.now() - parseInt(lastDismissed)) / (1000 * 60 * 60 * 24) : 999;

            // Show prompt if never dismissed or dismissed more than 7 days ago
            if (daysSinceDismissed > 7) {
                setTimeout(() => {
                    showInstallPrompt();
                }, 3000); // Show after 3 seconds
            }
        });

        // Track if app was installed
        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App was installed');
            deferredInstallPrompt = null;
            hideInstallPrompt();
            localStorage.setItem('pwa_installed', 'true');
        });

        function showInstallPrompt() {
            if (deferredInstallPrompt) {
                document.getElementById('installPrompt').classList.add('show');
            }
        }

        function hideInstallPrompt() {
            document.getElementById('installPrompt').classList.remove('show');
        }

        function dismissInstallPrompt() {
            hideInstallPrompt();
            localStorage.setItem('pwa_install_dismissed', Date.now().toString());
        }

        async function installApp() {
            if (!deferredInstallPrompt) {
                console.log('[PWA] No install prompt available');
                return;
            }

            // Show the native install prompt
            deferredInstallPrompt.prompt();

            // Wait for user response
            const { outcome } = await deferredInstallPrompt.userChoice;
            console.log('[PWA] User choice:', outcome);

            // Clear the saved prompt
            deferredInstallPrompt = null;
            hideInstallPrompt();
        }

        function showUpdateBanner() {
            document.getElementById('updateBanner').classList.add('show');
        }

        function updateApp() {
            if (swRegistration && swRegistration.waiting) {
                // Tell waiting service worker to activate
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
            // Reload the page to get new version
            window.location.reload();
        }

        // Offline/Online detection
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            document.getElementById('offlineIndicator').classList.toggle('show', !isOnline);

            if (typeof AppState !== 'undefined') {
                AppState.isOnline = isOnline;
            }

            if (isOnline && typeof syncOfflineData === 'function') {
                // Try to sync when coming back online
                syncOfflineData();
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Check initial status
        document.addEventListener('DOMContentLoaded', () => {
            updateOnlineStatus();
        });

        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbxpMlKTGPp5XYRm8T3tTWjqgFiGGykWpVBjvU3jIdDtzXovScX5n2W_9r9AUCse2nC2/exec',
            DB_NAME: 'TinySeedEmployee',
            DB_VERSION: 1,
            GEOFENCE: {
                // TODO: Set actual farm coordinates
                lat: 40.0,
                lng: -79.0,
                radiusMeters: 500
            }
        };

        // ============================================
        // APPLICATION STATE
        // ============================================
        const AppState = {
            employee: null,
            language: 'en',
            isOnline: navigator.onLine,
            isClockedIn: false,
            clockInTime: null,
            currentTab: 'home',
            currentGPS: null,
            enteredPIN: '',
            harvestQuality: 'A',
            scoutType: null,
            scoutSeverity: null,
            currentPhotoTarget: null,
            capturedPhoto: null,
            tasks: [],
            plantings: [],
            syncQueueCount: 0,
            isSyncing: false,
            lastSyncTime: null,
            workMode: 'field',
            // Permissions: Base modes (field, driver, packhouse) are always available
            // Additional modes require permission flags from Google Sheet
            permissions: {
                tractor: false,
                garage: false,
                inventory: false,
                costing: false  // Also granted via task assignment
            }
        };

        // ============================================
        // INDEXEDDB OFFLINE MODULE
        // ============================================
        const OfflineDB = {
            db: null,
            DB_NAME: CONFIG.DB_NAME,
            DB_VERSION: 2,

            // Initialize the database
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);

                    request.onerror = () => {
                        console.error('IndexedDB error:', request.error);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB initialized successfully');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // Sync Queue - stores pending operations
                        if (!db.objectStoreNames.contains('syncQueue')) {
                            const syncStore = db.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
                            syncStore.createIndex('timestamp', 'timestamp');
                            syncStore.createIndex('action', 'action');
                            syncStore.createIndex('status', 'status');
                        }

                        // Cached Tasks
                        if (!db.objectStoreNames.contains('tasks')) {
                            const taskStore = db.createObjectStore('tasks', { keyPath: 'id' });
                            taskStore.createIndex('date', 'date');
                            taskStore.createIndex('type', 'type');
                        }

                        // Cached Plantings (for harvest dropdown)
                        if (!db.objectStoreNames.contains('plantings')) {
                            const plantingStore = db.createObjectStore('plantings', { keyPath: 'Batch_ID' });
                            plantingStore.createIndex('Crop', 'Crop');
                            plantingStore.createIndex('STATUS', 'STATUS');
                        }

                        // Local Harvests
                        if (!db.objectStoreNames.contains('harvests')) {
                            const harvestStore = db.createObjectStore('harvests', { keyPath: 'localId', autoIncrement: true });
                            harvestStore.createIndex('synced', 'synced');
                            harvestStore.createIndex('timestamp', 'timestamp');
                        }

                        // Local Scout Reports
                        if (!db.objectStoreNames.contains('scoutReports')) {
                            const scoutStore = db.createObjectStore('scoutReports', { keyPath: 'localId', autoIncrement: true });
                            scoutStore.createIndex('synced', 'synced');
                        }

                        // Session data
                        if (!db.objectStoreNames.contains('session')) {
                            db.createObjectStore('session', { keyPath: 'key' });
                        }

                        // Reference data cache
                        if (!db.objectStoreNames.contains('referenceData')) {
                            db.createObjectStore('referenceData', { keyPath: 'type' });
                        }

                        console.log('IndexedDB stores created');
                    };
                });
            },

            // Add item to sync queue
            async queueOperation(action, data) {
                if (!this.db) await this.init();

                const operation = {
                    action: action,
                    data: data,
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    retries: 0
                };

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('syncQueue', 'readwrite');
                    const store = tx.objectStore('syncQueue');
                    const request = store.add(operation);

                    request.onsuccess = () => {
                        AppState.syncQueueCount++;
                        updateSyncBadge();
                        resolve(request.result);
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            // Get all pending operations
            async getPendingOperations() {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('syncQueue', 'readonly');
                    const store = tx.objectStore('syncQueue');
                    const index = store.index('status');
                    const request = index.getAll('pending');

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            // Mark operation as completed
            async markOperationComplete(id) {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('syncQueue', 'readwrite');
                    const store = tx.objectStore('syncQueue');
                    const request = store.delete(id);

                    request.onsuccess = () => {
                        AppState.syncQueueCount = Math.max(0, AppState.syncQueueCount - 1);
                        updateSyncBadge();
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            // Mark operation as failed (increment retry)
            async markOperationFailed(id, error) {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('syncQueue', 'readwrite');
                    const store = tx.objectStore('syncQueue');
                    const getRequest = store.get(id);

                    getRequest.onsuccess = () => {
                        const op = getRequest.result;
                        if (op) {
                            op.retries++;
                            op.lastError = error;
                            op.status = op.retries >= 3 ? 'failed' : 'pending';
                            store.put(op);
                        }
                        resolve();
                    };
                    getRequest.onerror = () => reject(getRequest.error);
                });
            },

            // Cache tasks locally
            async cacheTasks(tasks) {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('tasks', 'readwrite');
                    const store = tx.objectStore('tasks');

                    // Clear existing
                    store.clear();

                    // Add new
                    tasks.forEach(task => store.add(task));

                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },

            // Get cached tasks
            async getCachedTasks() {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('tasks', 'readonly');
                    const store = tx.objectStore('tasks');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            // Cache plantings
            async cachePlantings(plantings) {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('plantings', 'readwrite');
                    const store = tx.objectStore('plantings');

                    store.clear();
                    plantings.forEach(p => {
                        if (p.Batch_ID) store.add(p);
                    });

                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },

            // Get cached plantings
            async getCachedPlantings() {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('plantings', 'readonly');
                    const store = tx.objectStore('plantings');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            // Save session
            async saveSession(sessionData) {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('session', 'readwrite');
                    const store = tx.objectStore('session');
                    const request = store.put({ key: 'currentSession', ...sessionData });

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },

            // Get session
            async getSession() {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('session', 'readonly');
                    const store = tx.objectStore('session');
                    const request = store.get('currentSession');

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            // Clear session
            async clearSession() {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('session', 'readwrite');
                    const store = tx.objectStore('session');
                    store.clear();
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },

            // Get sync queue count
            async getSyncQueueCount() {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('syncQueue', 'readonly');
                    const store = tx.objectStore('syncQueue');
                    const index = store.index('status');
                    const request = index.count('pending');

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            // Cache reference data (fields, crops, etc.)
            async cacheReferenceData(type, data) {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('referenceData', 'readwrite');
                    const store = tx.objectStore('referenceData');
                    const request = store.put({ type: type, data: data, cachedAt: new Date().toISOString() });

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },

            // Get cached reference data
            async getCachedReferenceData(type) {
                if (!this.db) await this.init();

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('referenceData', 'readonly');
                    const store = tx.objectStore('referenceData');
                    const request = store.get(type);

                    request.onsuccess = () => resolve(request.result?.data || null);
                    request.onerror = () => reject(request.error);
                });
            }
        };

        // ============================================
        // SYNC MODULE
        // ============================================
        const SyncModule = {
            isSyncing: false,
            syncInterval: null,

            // Process all pending operations
            async syncAll() {
                if (this.isSyncing || !AppState.isOnline) return;

                this.isSyncing = true;
                AppState.isSyncing = true;
                updateSyncButton(true);

                try {
                    const pending = await OfflineDB.getPendingOperations();
                    console.log(`Syncing ${pending.length} pending operations...`);

                    let successCount = 0;
                    let failCount = 0;

                    for (const op of pending) {
                        try {
                            const result = await this.processOperation(op);
                            if (result.success) {
                                await OfflineDB.markOperationComplete(op.id);
                                successCount++;
                            } else {
                                await OfflineDB.markOperationFailed(op.id, result.error);
                                failCount++;
                            }
                        } catch (error) {
                            await OfflineDB.markOperationFailed(op.id, error.message);
                            failCount++;
                        }
                    }

                    AppState.lastSyncTime = new Date();

                    if (pending.length > 0) {
                        if (failCount === 0) {
                            showToast(t('common.syncComplete') + ` (${successCount})`, 'success');
                        } else {
                            showToast(`Synced ${successCount}, failed ${failCount}`, 'warning');
                        }
                    }

                    // Refresh data after sync
                    await loadInitialData();

                } catch (error) {
                    console.error('Sync error:', error);
                    showToast(t('common.error'), 'error');
                }

                this.isSyncing = false;
                AppState.isSyncing = false;
                updateSyncButton(false);
            },

            // Process a single operation
            async processOperation(op) {
                const { action, data } = op;

                const params = new URLSearchParams({ action, ...data });
                const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                return await response.json();
            },

            // Start periodic sync check
            startPeriodicSync() {
                this.syncInterval = setInterval(() => {
                    if (AppState.isOnline && AppState.syncQueueCount > 0) {
                        this.syncAll();
                    }
                }, 30000); // Every 30 seconds
            },

            // Stop periodic sync
            stopPeriodicSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
            }
        };

        // Update sync button UI
        function updateSyncButton(syncing) {
            const btn = document.getElementById('syncBtn');
            if (syncing) {
                btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
                btn.disabled = true;
            } else {
                btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                btn.disabled = false;
            }
        }

        // Update sync badge (pending count)
        function updateSyncBadge() {
            const badge = document.getElementById('syncBadge');
            if (badge) {
                if (AppState.syncQueueCount > 0) {
                    badge.textContent = AppState.syncQueueCount;
                    badge.classList.add('visible');
                } else {
                    badge.classList.remove('visible');
                }
            }
        }

        // ============================================
        // TRANSLATIONS
        // ============================================
        const i18n = {
            en: {
                'auth.title': 'Tiny Seed Farm',
                'auth.hint': 'Enter your 4-digit PIN',
                'auth.invalid': 'Invalid PIN. Please try again.',
                'clock.clockIn': 'Clock In',
                'clock.clockOut': 'Clock Out',
                'clock.hoursToday': 'Hours Today',
                'clock.weeklyHours': 'This Week',
                'clock.notClockedIn': 'Not clocked in',
                'clock.clockedIn': 'Clocked in',
                'clock.outsideGeofence': 'You must be at the farm to clock in',
                'clock.clockedInSuccess': 'Clocked in successfully',
                'clock.clockedOutSuccess': 'Clocked out successfully',
                'tasks.all': 'All',
                'tasks.today': 'Today',
                'tasks.overdue': 'Overdue',
                'tasks.noTasks': 'No tasks assigned',
                'tasks.completed': 'Task completed',
                'harvest.title': 'Log Harvest',
                'harvest.crop': 'Crop',
                'harvest.quantity': 'Quantity',
                'harvest.unit': 'Unit',
                'harvest.quality': 'Quality Grade',
                'harvest.photo': 'Photo (optional)',
                'harvest.notes': 'Notes',
                'harvest.submit': 'Log Harvest',
                'harvest.success': 'Harvest logged successfully',
                'harvest.recent': 'Recent Harvests',
                'scout.title': 'Field Scouting',
                'scout.type': 'What did you find?',
                'scout.pest': 'Pest',
                'scout.disease': 'Disease',
                'scout.weed': 'Weed',
                'scout.beneficial': 'Beneficial',
                'scout.wildlife': 'Wildlife',
                'scout.other': 'Other',
                'scout.severity': 'Severity',
                'scout.field': 'Field',
                'scout.bed': 'Bed',
                'scout.submit': 'Submit Report',
                'scout.success': 'Scout report submitted',
                'scout.map': 'Pest & Observation Map',
                'scout.refreshMap': 'Refresh Map',
                'scout.aiDoctor': 'AI Plant Doctor',
                'scout.aiHint': 'Take a photo for instant diagnosis',
                'common.offline': 'Offline - will sync when connected',
                'common.syncing': 'Syncing...',
                'common.syncComplete': 'Sync complete',
                'common.error': 'An error occurred',
                'tabs.home': 'Home',
                'tabs.tasks': 'Tasks',
                'tabs.harvest': 'Harvest',
                'tabs.scout': 'Scout',
                'tabs.more': 'More',
                'messages.title': 'Messages',
                'messages.empty': 'No messages',
                // AI Plant Doctor
                'ai.title': 'AI Plant Doctor',
                'ai.takePhoto': 'Take a Photo',
                'ai.photoHint': 'Get a clear, close-up shot of the affected plant, leaf, or insect',
                'ai.useCamera': 'Use Camera',
                'ai.choosePhoto': 'Choose from Gallery',
                'ai.whatAnalyze': 'What do you want to analyze?',
                'ai.plantHealth': 'Plant Health',
                'ai.bugId': 'Bug ID',
                'ai.retake': 'Retake',
                'ai.analyze': 'Analyze',
                'ai.analyzing': 'Analyzing...',
                'ai.pleaseWait': 'Our AI is examining your photo',
                'ai.identification': 'Identification',
                'ai.description': 'Description',
                'ai.treatment': 'Recommended Action',
                'ai.beneficial': 'Beneficial Insect!',
                'ai.confident': 'confident',
                'ai.newPhoto': 'New Photo',
                'ai.createReport': 'Create Report',
                'ai.reportCreated': 'Scout report pre-filled with AI diagnosis',
                // Phase 6: Treatment
                'treatment.title': 'Treatment Log',
                'treatment.success': 'Treatment logged successfully',
                'treatment.releaseSuccess': 'Beneficial release logged',
                // Phase 7: Hazard, Weed, Cultivation
                'hazard.success': 'Hazard reported successfully',
                'weed.success': 'Weed pressure logged successfully',
                'cultivation.success': 'Cultivation logged successfully',
                // Phase 8: Messages
                'messages.acknowledge': 'Acknowledge',
                'messages.acknowledged': 'Message acknowledged',
                // Safety
                'safety.heatTitle': 'Heat Safety Reminder',
                'safety.heatMessage': 'Remember to take breaks, drink water, and find shade.',
                'safety.gotIt': 'Got It',
                // Wildlife Tracker
                'wildlife.title': 'Wildlife Tracker',
                'more.wildlife': 'Wildlife Tracker',
                'more.wildlifeDesc': 'Log sightings, dens, damage',
                'wildlife.sighting': 'Log Sighting',
                'wildlife.sightingSuccess': 'Sighting logged successfully',
                'wildlife.den': 'Den Location',
                'wildlife.denSuccess': 'Den logged successfully',
                'wildlife.damage': 'Damage Report',
                'wildlife.damageSuccess': 'Damage reported successfully',
                'wildlife.map': 'Wildlife Map',
                // Pick & Pack
                'pickpack.title': 'Pick & Pack',
                'more.pickpack': 'Pick & Pack',
                'more.pickpackDesc': "Today's orders & packing",
                'pickpack.pickList': 'Pick List',
                'pickpack.packOrders': 'Pack Orders',
                'pickpack.noItems': 'No items to pick today',
                'pickpack.itemPicked': 'Item marked as picked',
                'pickpack.orderPacked': 'Order packed successfully'
            },
            es: {
                'auth.title': 'Granja Tiny Seed',
                'auth.hint': 'Ingrese su PIN de 4 digitos',
                'auth.invalid': 'PIN invalido. Intente de nuevo.',
                'clock.clockIn': 'Entrada',
                'clock.clockOut': 'Salida',
                'clock.hoursToday': 'Horas Hoy',
                'clock.weeklyHours': 'Esta Semana',
                'clock.notClockedIn': 'Sin registrar entrada',
                'clock.clockedIn': 'Entrada registrada',
                'clock.outsideGeofence': 'Debe estar en la granja para registrar entrada',
                'clock.clockedInSuccess': 'Entrada registrada exitosamente',
                'clock.clockedOutSuccess': 'Salida registrada exitosamente',
                'tasks.all': 'Todas',
                'tasks.today': 'Hoy',
                'tasks.overdue': 'Atrasadas',
                'tasks.noTasks': 'Sin tareas asignadas',
                'tasks.completed': 'Tarea completada',
                'harvest.title': 'Registrar Cosecha',
                'harvest.crop': 'Cultivo',
                'harvest.quantity': 'Cantidad',
                'harvest.unit': 'Unidad',
                'harvest.quality': 'Grado de Calidad',
                'harvest.photo': 'Foto (opcional)',
                'harvest.notes': 'Notas',
                'harvest.submit': 'Registrar Cosecha',
                'harvest.success': 'Cosecha registrada exitosamente',
                'harvest.recent': 'Cosechas Recientes',
                'scout.title': 'Monitoreo de Campo',
                'scout.type': 'Que encontraste?',
                'scout.pest': 'Plaga',
                'scout.disease': 'Enfermedad',
                'scout.weed': 'Maleza',
                'scout.beneficial': 'Benefico',
                'scout.wildlife': 'Animal',
                'scout.other': 'Otro',
                'scout.severity': 'Severidad',
                'scout.field': 'Campo',
                'scout.bed': 'Cama',
                'scout.submit': 'Enviar Reporte',
                'scout.success': 'Reporte enviado',
                'scout.map': 'Mapa de Plagas',
                'scout.refreshMap': 'Actualizar Mapa',
                'scout.aiDoctor': 'Doctor de Plantas IA',
                'scout.aiHint': 'Toma una foto para diagnostico instantaneo',
                'common.offline': 'Sin conexion - se sincronizara al conectar',
                'common.syncing': 'Sincronizando...',
                'common.syncComplete': 'Sincronizacion completa',
                'common.error': 'Ocurrio un error',
                'tabs.home': 'Inicio',
                'tabs.tasks': 'Tareas',
                'tabs.harvest': 'Cosecha',
                'tabs.scout': 'Monitoreo',
                'tabs.more': 'Mas',
                'messages.title': 'Mensajes',
                'messages.empty': 'Sin mensajes',
                // AI Plant Doctor
                'ai.title': 'Doctor de Plantas IA',
                'ai.takePhoto': 'Tomar una Foto',
                'ai.photoHint': 'Obtenga una foto clara y cercana de la planta, hoja o insecto afectado',
                'ai.useCamera': 'Usar Camara',
                'ai.choosePhoto': 'Elegir de Galeria',
                'ai.whatAnalyze': 'Que quieres analizar?',
                'ai.plantHealth': 'Salud de Planta',
                'ai.bugId': 'ID de Insecto',
                'ai.retake': 'Repetir',
                'ai.analyze': 'Analizar',
                'ai.analyzing': 'Analizando...',
                'ai.pleaseWait': 'Nuestra IA esta examinando tu foto',
                'ai.identification': 'Identificacion',
                'ai.description': 'Descripcion',
                'ai.treatment': 'Accion Recomendada',
                'ai.beneficial': 'Insecto Benefico!',
                'ai.confident': 'seguro',
                'ai.newPhoto': 'Nueva Foto',
                'ai.createReport': 'Crear Reporte',
                'ai.reportCreated': 'Reporte de campo pre-llenado con diagnostico IA',
                // Phase 6: Treatment
                'treatment.title': 'Registro de Tratamiento',
                'treatment.success': 'Tratamiento registrado exitosamente',
                'treatment.releaseSuccess': 'Liberacion de beneficos registrada',
                // Phase 7: Hazard, Weed, Cultivation
                'hazard.success': 'Peligro reportado exitosamente',
                'weed.success': 'Presion de malezas registrada',
                'cultivation.success': 'Cultivo registrado exitosamente',
                // Phase 8: Messages
                'messages.acknowledge': 'Confirmar',
                'messages.acknowledged': 'Mensaje confirmado',
                // Safety
                'safety.heatTitle': 'Recordatorio de Seguridad por Calor',
                'safety.heatMessage': 'Recuerde tomar descansos, beber agua y buscar sombra.',
                'safety.gotIt': 'Entendido',
                // Wildlife Tracker
                'wildlife.title': 'Rastreador de Animales',
                'more.wildlife': 'Rastreador de Animales',
                'more.wildlifeDesc': 'Avistamientos, madrigueras, danos',
                'wildlife.sighting': 'Registrar Avistamiento',
                'wildlife.sightingSuccess': 'Avistamiento registrado',
                'wildlife.den': 'Ubicacion de Madriguera',
                'wildlife.denSuccess': 'Madriguera registrada',
                'wildlife.damage': 'Reporte de Dano',
                'wildlife.damageSuccess': 'Dano reportado',
                'wildlife.map': 'Mapa de Animales',
                // Pick & Pack
                'pickpack.title': 'Recoger y Empacar',
                'more.pickpack': 'Recoger y Empacar',
                'more.pickpackDesc': 'Pedidos del dia y empaque',
                'pickpack.pickList': 'Lista de Recoleccion',
                'pickpack.packOrders': 'Empacar Pedidos',
                'pickpack.noItems': 'Sin articulos para recoger hoy',
                'pickpack.itemPicked': 'Articulo marcado como recogido',
                'pickpack.orderPacked': 'Pedido empacado exitosamente'
            }
        };

        function t(key) {
            return i18n[AppState.language][key] || i18n['en'][key] || key;
        }

        function translatePage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        function enterPin(digit) {
            if (AppState.enteredPIN.length < 4) {
                AppState.enteredPIN += digit;
                updatePinDisplay();

                if (AppState.enteredPIN.length === 4) {
                    setTimeout(() => validatePIN(), 200);
                }
            }
        }

        function deletePin() {
            AppState.enteredPIN = AppState.enteredPIN.slice(0, -1);
            updatePinDisplay();
        }

        function updatePinDisplay() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`pin${i}`);
                dot.classList.toggle('filled', i <= AppState.enteredPIN.length);
                dot.classList.remove('error');
            }
            document.getElementById('loginError').textContent = '';
        }

        async function validatePIN() {
            showLoading();
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=authenticateEmployee&pin=${AppState.enteredPIN}`);
                const data = await response.json();

                if (data.success && data.employee) {
                    AppState.employee = data.employee;
                    AppState.language = data.employee.Language_Pref || 'en';
                    AppState.isClockedIn = data.isClockedIn || false;
                    AppState.clockInTime = data.clockInTime || null;

                    const sessionData = {
                        employee: AppState.employee,
                        language: AppState.language
                    };

                    // Save to both localStorage (fallback) and IndexedDB
                    localStorage.setItem('employeeSession', JSON.stringify(sessionData));
                    await OfflineDB.saveSession(sessionData);

                    showMainApp();
                } else {
                    showPinError();
                }
            } catch (error) {
                console.error('Auth error:', error);
                // Try offline login from IndexedDB first, then localStorage
                let offlineSession = await OfflineDB.getSession();
                if (!offlineSession) {
                    const lsSession = localStorage.getItem('employeeSession');
                    if (lsSession) {
                        offlineSession = JSON.parse(lsSession);
                    }
                }

                if (offlineSession && offlineSession.employee) {
                    // Simple offline login (user must have logged in before)
                    AppState.employee = offlineSession.employee;
                    AppState.language = offlineSession.language || 'en';
                    showMainApp();
                } else {
                    showPinError();
                }
            }
            hideLoading();
        }

        function showPinError() {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`pin${i}`).classList.add('error');
            }
            document.getElementById('loginError').textContent = t('auth.invalid');
            setTimeout(() => {
                AppState.enteredPIN = '';
                updatePinDisplay();
            }, 1000);
        }

        // ============================================
        // REGISTRATION (New User Sign-up)
        // ============================================
        function showRegistration() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('registrationScreen').classList.add('active');
        }

        function hideRegistration() {
            document.getElementById('registrationScreen').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');
            // Clear form
            document.getElementById('regFirstName').value = '';
            document.getElementById('regLastName').value = '';
            document.getElementById('regPhone').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPin').value = '';
            document.getElementById('regPinConfirm').value = '';
        }

        function hideRegistrationSuccess() {
            document.getElementById('registrationSuccessScreen').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');
        }

        async function submitRegistration(event) {
            event.preventDefault();

            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pin = document.getElementById('regPin').value.trim();
            const pinConfirm = document.getElementById('regPinConfirm').value.trim();
            const language = document.getElementById('regLanguage').value;

            // Validation
            if (!firstName || !lastName || !phone || !pin) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showToast('PIN must be exactly 4 digits', 'error');
                return;
            }

            if (pin !== pinConfirm) {
                showToast('PINs do not match', 'error');
                return;
            }

            const submitBtn = document.getElementById('regSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            try {
                const response = await fetch(`${CONFIG.API_URL}?action=registerEmployee`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        phone,
                        email,
                        pin,
                        language,
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show success screen
                    document.getElementById('registrationScreen').classList.remove('active');
                    document.getElementById('registrationSuccessScreen').classList.add('active');
                } else {
                    showToast(data.error || 'Registration failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('[Registration] Error:', error);
                showToast('Connection error. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Registration';
            }
        }

        // ============================================
        // ADMIN: PENDING REGISTRATIONS
        // ============================================
        async function loadPendingRegistrations() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getPendingRegistrations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success && data.registrations) {
                    renderPendingRegistrations(data.registrations);
                }
            } catch (error) {
                console.error('[Admin] Error loading pending registrations:', error);
            }
        }

        function renderPendingRegistrations(registrations) {
            const container = document.getElementById('pendingList');
            const countBadge = document.getElementById('pendingCount');

            if (!registrations || registrations.length === 0) {
                container.innerHTML = `
                    <div class="no-pending">
                        <i class="fas fa-check-circle"></i>
                        <p>No pending registrations</p>
                    </div>
                `;
                countBadge.textContent = '0';
                return;
            }

            countBadge.textContent = registrations.length;

            container.innerHTML = registrations.map(reg => `
                <div class="pending-item" data-row="${reg.row}">
                    <div class="pending-item-header">
                        <div>
                            <div class="pending-item-name">${reg.firstName} ${reg.lastName}</div>
                            <div class="pending-item-date">${new Date(reg.timestamp).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="pending-item-info">
                        <span><i class="fas fa-phone"></i> ${reg.phone}</span>
                        ${reg.email ? `<span><i class="fas fa-envelope"></i> ${reg.email}</span>` : ''}
                        <span><i class="fas fa-language"></i> ${reg.language === 'es' ? 'Spanish' : 'English'}</span>
                    </div>
                    <div class="pending-item-actions">
                        <button class="approve-btn" onclick="approveRegistration(${reg.row}, '${reg.firstName}', '${reg.lastName}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="reject-btn" onclick="rejectRegistration(${reg.row}, '${reg.firstName}', '${reg.lastName}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveRegistration(row, firstName, lastName) {
            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`${CONFIG.API_URL}?action=approveRegistration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ row })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`${firstName} ${lastName} approved! They can now log in.`, 'success');
                    loadPendingRegistrations(); // Refresh list
                } else {
                    showToast(data.error || 'Failed to approve registration', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check"></i> Approve';
                }
            } catch (error) {
                console.error('[Admin] Error approving registration:', error);
                showToast('Connection error. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Approve';
            }
        }

        async function rejectRegistration(row, firstName, lastName) {
            if (!confirm(`Are you sure you want to reject ${firstName} ${lastName}'s registration?`)) {
                return;
            }

            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`${CONFIG.API_URL}?action=rejectRegistration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ row })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`${firstName} ${lastName}'s registration rejected.`, 'warning');
                    loadPendingRegistrations(); // Refresh list
                } else {
                    showToast(data.error || 'Failed to reject registration', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-times"></i> Reject';
                }
            } catch (error) {
                console.error('[Admin] Error rejecting registration:', error);
                showToast('Connection error. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-times"></i> Reject';
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');

            // Update header
            if (AppState.employee) {
                const initials = (AppState.employee.First_Name?.[0] || '') +
                                (AppState.employee.Last_Name?.[0] || '');
                document.getElementById('headerAvatar').textContent = initials || '??';
                document.getElementById('headerName').textContent =
                    `${AppState.employee.First_Name || ''} ${AppState.employee.Last_Name || ''}`.trim() || 'Employee';

                // Load permissions from employee data (from Google Sheet)
                AppState.permissions = {
                    tractor: AppState.employee.Tractor_Mode === true || AppState.employee.Tractor_Mode === 'TRUE',
                    garage: AppState.employee.Garage_Mode === true || AppState.employee.Garage_Mode === 'TRUE',
                    inventory: AppState.employee.Inventory_Mode === true || AppState.employee.Inventory_Mode === 'TRUE',
                    costing: AppState.employee.Costing_Mode === true || AppState.employee.Costing_Mode === 'TRUE'
                };
            }

            document.getElementById('langToggle').textContent = AppState.language.toUpperCase();
            translatePage();

            // Initialize welcome banner
            initWelcomeBanner();

            // Render mode selector based on permissions
            renderModeSelector();

            // Restore clock state from localStorage
            restoreClockState();

            updateClockUI();
            startClock();
            loadInitialData();

            // Restore saved work mode (only if user has permission)
            const savedMode = localStorage.getItem('tsf_work_mode');
            if (savedMode && hasPermissionForMode(savedMode)) {
                AppState.workMode = savedMode;
            } else {
                AppState.workMode = 'field';  // Default to field mode
            }
            updateModeSelector();

            // Show admin panel for admins
            const adminPanel = document.getElementById('adminPanel');
            if (AppState.employee && AppState.employee.Role === 'Admin') {
                adminPanel.classList.add('visible');
                loadPendingRegistrations();
            } else {
                adminPanel.classList.remove('visible');
            }
        }

        async function logout() {
            // Clear both localStorage and IndexedDB session
            localStorage.removeItem('employeeSession');
            await OfflineDB.clearSession();

            AppState.employee = null;
            AppState.enteredPIN = '';
            AppState.isClockedIn = false;

            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');
            updatePinDisplay();
        }

        // ============================================
        // WELCOME BANNER & PERMISSIONS
        // ============================================
        const ENCOURAGING_MESSAGES = [
            "Every seed you plant makes a difference.",
            "Your hard work feeds families today.",
            "Growing good food, doing good work.",
            "The earth thanks you for your care.",
            "Small seeds, big impact.",
            "You're cultivating more than cropsyou're growing community.",
            "Another day to make the farm thrive!",
            "Your dedication shows in every harvest.",
            "Fresh air, good work, making a difference.",
            "The best fertilizer is the farmer's footsteps."
        ];

        const ENCOURAGING_MESSAGES_ES = [
            "Cada semilla que plantas hace la diferencia.",
            "Tu trabajo duro alimenta familias hoy.",
            "Cultivando buena comida, haciendo buen trabajo.",
            "La tierra te agradece por tu cuidado.",
            "Semillas pequeas, gran impacto.",
            "Ests cultivando ms que cultivosests cultivando comunidad.",
            "Otro da para hacer prosperar la granja!",
            "Tu dedicacin se ve en cada cosecha.",
            "Aire fresco, buen trabajo, marcando la diferencia.",
            "El mejor fertilizante son las huellas del agricultor."
        ];

        function initWelcomeBanner() {
            const firstName = AppState.employee?.First_Name || 'Friend';

            // Set personalized greeting
            document.getElementById('welcomeName').textContent = `Welcome, ${firstName}!`;

            // Set today's date
            const today = new Date();
            const dateOptions = { weekday: 'long', month: 'long', day: 'numeric' };
            const dateStr = today.toLocaleDateString(AppState.language === 'es' ? 'es-ES' : 'en-US', dateOptions);
            document.getElementById('welcomeDate').textContent = dateStr;

            // Set encouraging message (random, changes daily based on date)
            const messages = AppState.language === 'es' ? ENCOURAGING_MESSAGES_ES : ENCOURAGING_MESSAGES;
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
            const messageIndex = dayOfYear % messages.length;
            document.getElementById('encouragingMessage').textContent = messages[messageIndex];

            // Fetch weather
            fetchWeather();
        }

        async function fetchWeather() {
            try {
                // Get user's location (or use farm's default location)
                let lat = 40.4406;  // Default: Pittsburgh area
                let lon = -79.9959;

                // Try to get current position
                if (navigator.geolocation) {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, () => {
                            // Use default on failure
                            resolve({ coords: { latitude: lat, longitude: lon } });
                        }, { timeout: 5000 });
                    });
                    lat = position.coords.latitude;
                    lon = position.coords.longitude;
                }

                // Fetch weather from Open-Meteo (free, no API key needed)
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=auto`
                );
                const data = await response.json();

                if (data.current) {
                    const temp = Math.round(data.current.temperature_2m);
                    const weatherCode = data.current.weather_code;

                    document.getElementById('weatherTemp').textContent = `${temp}F`;

                    // Map weather codes to icons and descriptions
                    const weatherInfo = getWeatherInfo(weatherCode);
                    document.getElementById('weatherIcon').className = `fas ${weatherInfo.icon}`;
                    document.getElementById('weatherDesc').textContent = weatherInfo.desc;
                }
            } catch (error) {
                console.error('[Weather] Error fetching:', error);
                document.getElementById('weatherDesc').textContent = 'Weather unavailable';
            }
        }

        function getWeatherInfo(code) {
            // WMO Weather Codes mapping
            const weatherMap = {
                0: { icon: 'fa-sun', desc: 'Clear sky' },
                1: { icon: 'fa-sun', desc: 'Mainly clear' },
                2: { icon: 'fa-cloud-sun', desc: 'Partly cloudy' },
                3: { icon: 'fa-cloud', desc: 'Overcast' },
                45: { icon: 'fa-smog', desc: 'Foggy' },
                48: { icon: 'fa-smog', desc: 'Icy fog' },
                51: { icon: 'fa-cloud-rain', desc: 'Light drizzle' },
                53: { icon: 'fa-cloud-rain', desc: 'Drizzle' },
                55: { icon: 'fa-cloud-rain', desc: 'Heavy drizzle' },
                61: { icon: 'fa-cloud-showers-heavy', desc: 'Light rain' },
                63: { icon: 'fa-cloud-showers-heavy', desc: 'Rain' },
                65: { icon: 'fa-cloud-showers-heavy', desc: 'Heavy rain' },
                71: { icon: 'fa-snowflake', desc: 'Light snow' },
                73: { icon: 'fa-snowflake', desc: 'Snow' },
                75: { icon: 'fa-snowflake', desc: 'Heavy snow' },
                77: { icon: 'fa-snowflake', desc: 'Snow grains' },
                80: { icon: 'fa-cloud-showers-heavy', desc: 'Rain showers' },
                81: { icon: 'fa-cloud-showers-heavy', desc: 'Moderate showers' },
                82: { icon: 'fa-cloud-showers-heavy', desc: 'Heavy showers' },
                85: { icon: 'fa-snowflake', desc: 'Snow showers' },
                86: { icon: 'fa-snowflake', desc: 'Heavy snow showers' },
                95: { icon: 'fa-bolt', desc: 'Thunderstorm' },
                96: { icon: 'fa-bolt', desc: 'Thunderstorm with hail' },
                99: { icon: 'fa-bolt', desc: 'Severe thunderstorm' }
            };
            return weatherMap[code] || { icon: 'fa-cloud', desc: 'Unknown' };
        }

        // ============================================
        // MODE PERMISSIONS SYSTEM
        // ============================================
        // Base modes everyone has: field, driver, packhouse
        // Permission-required modes: tractor, garage, inventory
        // Task-assigned mode: costing (also can be permission-granted)

        function hasPermissionForMode(mode) {
            // Base modes - everyone has access
            const baseModes = ['field', 'driver', 'packhouse'];
            if (baseModes.includes(mode)) {
                return true;
            }

            // Check permission flags
            if (mode === 'tractor') return AppState.permissions.tractor;
            if (mode === 'garage') return AppState.permissions.garage;
            if (mode === 'inventory') return AppState.permissions.inventory;
            if (mode === 'costing') {
                // Costing can be permission-granted OR task-assigned
                if (AppState.permissions.costing) return true;
                // Check if any current task has costing enabled
                return AppState.tasks?.some(t => t.costingMode || t.Costing_Mode);
            }

            return false;
        }

        function renderModeSelector() {
            const container = document.getElementById('modeSelector');

            // Define all possible modes with their config
            const allModes = [
                { id: 'field', icon: 'fa-seedling', label: 'Field', permission: 'base' },
                { id: 'tractor', icon: 'fa-tractor', label: 'Tractor', permission: 'tractor' },
                { id: 'packhouse', icon: 'fa-warehouse', label: 'Packhouse', permission: 'base' },
                { id: 'inventory', icon: 'fa-clipboard-list', label: 'Inventory', permission: 'inventory' },
                { id: 'garage', icon: 'fa-wrench', label: 'Garage', permission: 'garage' },
                { id: 'driver', icon: 'fa-truck', label: 'Driver', permission: 'base' }
                // Costing is NOT in the mode selector - it's task-assigned
            ];

            // Filter to only modes user has permission for
            const availableModes = allModes.filter(mode => {
                if (mode.permission === 'base') return true;
                return AppState.permissions[mode.permission];
            });

            // Render buttons
            container.innerHTML = availableModes.map(mode => `
                <button class="mode-btn ${AppState.workMode === mode.id ? 'active' : ''}"
                        onclick="setWorkMode('${mode.id}')"
                        data-mode="${mode.id}">
                    <i class="fas ${mode.icon}"></i>
                    <span>${mode.label}</span>
                </button>
            `).join('');
        }

        function updateModeSelector() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === AppState.workMode);
            });
        }

        // ============================================
        // CLOCK & TIME
        // ============================================
        let clockInterval;

        function startClock() {
            updateClockDisplay();
            clockInterval = setInterval(updateClockDisplay, 1000);
        }

        function updateClockDisplay() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString(AppState.language === 'es' ? 'es-ES' : 'en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const dateStr = now.toLocaleDateString(AppState.language === 'es' ? 'es-ES' : 'en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });

            document.getElementById('clockTime').textContent = timeStr;
            document.getElementById('clockDate').textContent = dateStr;

            // Update hours if clocked in
            if (AppState.isClockedIn && AppState.clockInTime) {
                const elapsed = (now - new Date(AppState.clockInTime)) / 1000 / 60 / 60;
                document.getElementById('hoursToday').textContent = elapsed.toFixed(1);
            }
        }

        function updateClockUI() {
            const btn = document.getElementById('clockBtn');
            const status = document.getElementById('headerStatus');

            if (AppState.isClockedIn) {
                btn.className = 'clock-btn clock-out';
                btn.innerHTML = `<i class="fas fa-stop"></i><span>${t('clock.clockOut')}</span>`;
                status.textContent = t('clock.clockedIn');
                status.classList.add('clocked-in');
            } else {
                btn.className = 'clock-btn clock-in';
                btn.innerHTML = `<i class="fas fa-play"></i><span>${t('clock.clockIn')}</span>`;
                status.textContent = t('clock.notClockedIn');
                status.classList.remove('clocked-in');
            }
        }

        async function toggleClock() {
            const btn = document.getElementById('clockBtn');
            btn.disabled = true;

            try {
                const gps = await captureGPS();
                const mode = AppState.workMode || 'field';

                if (!AppState.isClockedIn) {
                    // Clock In
                    const response = await fetch(`${CONFIG.API_URL}?action=clockIn&employeeId=${AppState.employee.Employee_ID}&lat=${gps.lat || ''}&lng=${gps.lng || ''}&mode=${mode}`);
                    const data = await response.json();

                    if (data.success) {
                        AppState.isClockedIn = true;
                        AppState.clockInTime = new Date().toISOString();

                        // Persist clock state in localStorage
                        localStorage.setItem('tsf_clocked_in', 'true');
                        localStorage.setItem('tsf_clock_in_time', AppState.clockInTime);

                        showToast(t('clock.clockedInSuccess'), 'success');

                        // Trigger mode check - if full-screen mode selected, show it now
                        onClockIn();
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                } else {
                    // Clock Out
                    const response = await fetch(`${CONFIG.API_URL}?action=clockOut&employeeId=${AppState.employee.Employee_ID}&lat=${gps.lat || ''}&lng=${gps.lng || ''}&mode=${mode}`);
                    const data = await response.json();

                    if (data.success) {
                        AppState.isClockedIn = false;
                        AppState.clockInTime = null;

                        // Clear persisted clock state
                        localStorage.removeItem('tsf_clocked_in');
                        localStorage.removeItem('tsf_clock_in_time');

                        // Exit any full-screen mode when clocking out
                        exitFullScreenMode();

                        document.getElementById('hoursToday').textContent = data.hoursWorked?.toFixed(1) || '0.0';
                        showToast(t('clock.clockedOutSuccess'), 'success');
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                }

                updateClockUI();
            } catch (error) {
                console.error('Clock error:', error);

                // Offline fallback - still allow clock in/out locally
                if (!AppState.isClockedIn) {
                    AppState.isClockedIn = true;
                    AppState.clockInTime = new Date().toISOString();
                    localStorage.setItem('tsf_clocked_in', 'true');
                    localStorage.setItem('tsf_clock_in_time', AppState.clockInTime);
                    showToast('Clocked in (offline)', 'info');
                    onClockIn();
                } else {
                    AppState.isClockedIn = false;
                    AppState.clockInTime = null;
                    localStorage.removeItem('tsf_clocked_in');
                    localStorage.removeItem('tsf_clock_in_time');
                    exitFullScreenMode();
                    showToast('Clocked out (offline)', 'info');
                }
                updateClockUI();
            }

            btn.disabled = false;
        }

        // Restore clock state on page load
        function restoreClockState() {
            const wasClocked = localStorage.getItem('tsf_clocked_in') === 'true';
            const clockTime = localStorage.getItem('tsf_clock_in_time');

            if (wasClocked && clockTime) {
                AppState.isClockedIn = true;
                AppState.clockInTime = clockTime;
                updateClockUI();
            }
        }

        // ============================================
        // GPS
        // ============================================
        async function captureGPS() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve({ error: 'Geolocation not supported' });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    pos => resolve({
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        accuracy: pos.coords.accuracy
                    }),
                    err => resolve({ error: err.message }),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            });
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        function switchTab(tabId) {
            AppState.currentTab = tabId;

            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            const tabPanel = document.getElementById(`${tabId}Tab`);
            if (tabPanel) {
                tabPanel.classList.add('active');
            }

            // Update active nav based on current mode
            const currentNav = document.getElementById(`${AppState.workMode}Nav`);
            if (currentNav) {
                currentNav.querySelectorAll('.tab-item').forEach(item => {
                    const onclick = item.getAttribute('onclick');
                    const itemTab = onclick?.match(/switchTab\('(\w+)'\)/)?.[1];
                    item.classList.toggle('active', itemTab === tabId);
                });
            }

            // Initialize scout GPS when switching to scout tab
            if (tabId === 'scout') {
                initScoutGPS();
            }
        }

        // ============================================
        // WORK MODE SYSTEM (7 Modes)
        // ============================================
        const FULL_SCREEN_MODES = ['driver', 'garage', 'inventory', 'costing'];
        const NAV_MODES = ['field', 'tractor', 'packhouse'];

        function setWorkMode(mode) {
            // Check permission first
            if (!hasPermissionForMode(mode)) {
                showToast(`You don't have access to ${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode`, 'error');
                return;
            }

            AppState.workMode = mode;
            localStorage.setItem('tsf_work_mode', mode);

            // Update mode selector buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Hide all navs and full-screen modes
            document.getElementById('fieldNav').style.display = 'none';
            document.getElementById('packhouseNav').style.display = 'none';
            document.getElementById('tractorNav').style.display = 'none';
            document.getElementById('driverMode')?.classList.remove('active');
            document.getElementById('garageMode')?.classList.remove('active');
            document.getElementById('inventoryMode')?.classList.remove('active');
            document.getElementById('costingMode')?.classList.remove('active');

            // For full-screen modes, check if clocked in first
            if (FULL_SCREEN_MODES.includes(mode)) {
                if (!AppState.isClockedIn) {
                    // Stay on home screen, show clock in prompt
                    document.getElementById('fieldNav').style.display = 'flex';
                    switchTab('home');
                    showToast(`Clock in to start ${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode`, 'info');
                    return;
                }

                // Clocked in - show full screen mode
                if (mode === 'driver') {
                    document.getElementById('driverMode').classList.add('active');
                    loadDriverRoute();
                } else if (mode === 'garage') {
                    document.getElementById('garageMode').classList.add('active');
                    loadGarageAssets();
                } else if (mode === 'inventory') {
                    document.getElementById('inventoryMode').classList.add('active');
                    loadInventoryCapture();
                } else if (mode === 'costing') {
                    document.getElementById('costingMode').classList.add('active');
                    loadCostingTasks();
                }
            } else {
                // Standard nav modes (field, tractor, packhouse)
                const navElement = document.getElementById(`${mode}Nav`);
                if (navElement) {
                    navElement.style.display = 'flex';
                } else {
                    document.getElementById('fieldNav').style.display = 'flex';
                }
                switchTab('home');

                // Load fleet data for tractor mode
                if (mode === 'tractor') {
                    loadFleetData();
                }
            }

            const modeNames = {
                field: 'Field',
                tractor: 'Tractor',
                packhouse: 'Packhouse',
                garage: 'Garage',
                driver: 'Driver',
                inventory: 'Inventory',
                costing: 'Costing'
            };
            showToast(`${modeNames[mode]} Mode`, 'success');
        }

        // Exit functions return to home screen with mode selector
        function exitFullScreenMode() {
            // Hide all full-screen modes
            document.getElementById('driverMode')?.classList.remove('active');
            document.getElementById('garageMode')?.classList.remove('active');
            document.getElementById('inventoryMode')?.classList.remove('active');
            document.getElementById('costingMode')?.classList.remove('active');

            // Show home with field nav (allows mode switching)
            document.getElementById('fieldNav').style.display = 'flex';
            switchTab('home');

            // Keep the work mode set so they can see what they're in
            showToast('Tap a mode to switch', 'info');
        }

        function exitDriverMode() {
            exitFullScreenMode();
        }

        function exitGarageMode() {
            exitFullScreenMode();
        }

        function exitInventoryMode() {
            exitFullScreenMode();
        }

        function exitCostingMode() {
            exitFullScreenMode();
        }

        // When clock in happens, check if we need to show a full-screen mode
        function onClockIn() {
            if (FULL_SCREEN_MODES.includes(AppState.workMode)) {
                // Re-trigger the mode to show full screen now that clocked in
                setWorkMode(AppState.workMode);
            }
        }

        function loadDriverRoute() {
            // Load today's delivery route
            const stopsContainer = document.getElementById('driverStopsList');
            stopsContainer.innerHTML = `
                <div class="driver-stop">
                    <div class="driver-stop-header">
                        <div class="driver-stop-num">1</div>
                        <div class="driver-stop-info">
                            <div class="driver-stop-name">Fresh Market Cafe</div>
                            <div class="driver-stop-address">123 Main St, Pittsburgh PA</div>
                        </div>
                        <button class="driver-stop-nav" onclick="navigateTo('123 Main St, Pittsburgh PA')">
                            <i class="fas fa-directions"></i>
                        </button>
                    </div>
                    <div class="driver-stop-items">
                        <div class="driver-stop-item"><span>Salad Mix</span><span>5 lbs</span></div>
                        <div class="driver-stop-item"><span>Tomatoes</span><span>10 lbs</span></div>
                    </div>
                    <div class="driver-stop-actions">
                        <button class="driver-issue-btn" onclick="reportDeliveryIssue(1)">
                            <i class="fas fa-exclamation-triangle"></i> Issue
                        </button>
                        <button class="driver-complete-btn" onclick="completeDeliveryStop(1)">
                            <i class="fas fa-check"></i> Complete
                        </button>
                    </div>
                </div>
                <div class="driver-stop">
                    <div class="driver-stop-header">
                        <div class="driver-stop-num">2</div>
                        <div class="driver-stop-info">
                            <div class="driver-stop-name">Green Table Restaurant</div>
                            <div class="driver-stop-address">456 Oak Ave, Pittsburgh PA</div>
                        </div>
                        <button class="driver-stop-nav" onclick="navigateTo('456 Oak Ave, Pittsburgh PA')">
                            <i class="fas fa-directions"></i>
                        </button>
                    </div>
                    <div class="driver-stop-items">
                        <div class="driver-stop-item"><span>Kale</span><span>8 bunches</span></div>
                        <div class="driver-stop-item"><span>Carrots</span><span>15 lbs</span></div>
                    </div>
                    <div class="driver-stop-actions">
                        <button class="driver-issue-btn">
                            <i class="fas fa-exclamation-triangle"></i> Issue
                        </button>
                        <button class="driver-complete-btn">
                            <i class="fas fa-check"></i> Complete
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('driverCompleted').textContent = '0';
            document.getElementById('driverRemaining').textContent = '2';
        }

        function navigateTo(address) {
            // Open in maps app
            const encoded = encodeURIComponent(address);
            window.open(`https://maps.google.com/maps?daddr=${encoded}`, '_blank');
        }

        function completeDeliveryStop(stopNum) {
            showToast(`Stop ${stopNum} completed!`, 'success');
            // In production: API call to mark complete, capture signature/photo
        }

        function reportDeliveryIssue(stopNum) {
            // Show issue reporting modal
            showToast(`Report issue for stop ${stopNum}`, 'info');
        }

        // ============================================
        // INVENTORY CAPTURE MODE
        // ============================================
        const InventoryState = {
            currentCount: [],
            history: JSON.parse(localStorage.getItem('tsf_inventory_history') || '[]'),
            todaysCounts: []
        };

        function loadInventoryCapture() {
            // Reset current count for new session
            InventoryState.currentCount = [];
            renderInventoryCountList();
            loadInventoryHistory();
            updateInventoryReportStats();
        }

        function switchInventoryTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.inventory-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });

            // Update panels
            document.getElementById('inventoryCountTab').classList.toggle('active', tab === 'count');
            document.getElementById('inventoryHistoryTab').classList.toggle('active', tab === 'history');
            document.getElementById('inventoryReportTab').classList.toggle('active', tab === 'report');

            if (tab === 'history') {
                loadInventoryHistory();
            } else if (tab === 'report') {
                updateInventoryReportStats();
            }
        }

        function addInventoryItem() {
            const nameInput = document.getElementById('inventoryItemName');
            const qtyInput = document.getElementById('inventoryItemQty');
            const unitSelect = document.getElementById('inventoryItemUnit');
            const locationSelect = document.getElementById('inventoryLocation');

            const name = nameInput.value.trim();
            const qty = parseFloat(qtyInput.value);
            const unit = unitSelect.value;
            const location = locationSelect.value;

            if (!name || !qty || !location) {
                showToast('Please fill in item name, quantity, and location', 'error');
                return;
            }

            InventoryState.currentCount.push({
                id: Date.now(),
                name,
                qty,
                unit,
                location,
                timestamp: new Date().toISOString()
            });

            // Clear inputs
            nameInput.value = '';
            qtyInput.value = '';

            renderInventoryCountList();
            showToast(`Added ${qty} ${unit} of ${name}`, 'success');
        }

        function removeInventoryItem(itemId) {
            InventoryState.currentCount = InventoryState.currentCount.filter(i => i.id !== itemId);
            renderInventoryCountList();
        }

        function renderInventoryCountList() {
            const list = document.getElementById('inventoryCountList');

            if (InventoryState.currentCount.length === 0) {
                list.innerHTML = `
                    <div class="empty-state small">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Start counting items</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = InventoryState.currentCount.map(item => `
                <div class="inventory-count-item">
                    <div>
                        <div class="inventory-count-item-name">${item.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${item.location}</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span class="inventory-count-item-qty">${item.qty} ${item.unit}</span>
                        <button class="inventory-count-item-remove" onclick="removeInventoryItem(${item.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function submitInventoryCount() {
            if (InventoryState.currentCount.length === 0) {
                showToast('Add items before submitting', 'error');
                return;
            }

            const countRecord = {
                id: Date.now(),
                user: AppState.employee?.Name || 'Unknown',
                timestamp: new Date().toISOString(),
                items: [...InventoryState.currentCount],
                totalItems: InventoryState.currentCount.length,
                locations: [...new Set(InventoryState.currentCount.map(i => i.location))]
            };

            // Save to history
            InventoryState.history.unshift(countRecord);
            localStorage.setItem('tsf_inventory_history', JSON.stringify(InventoryState.history.slice(0, 100)));

            // Send to backend
            try {
                await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'logInventoryCount',
                        ...countRecord
                    })
                });
            } catch (error) {
                console.error('[Inventory] Submit error:', error);
                // Queued for offline sync
            }

            showToast(`Inventory count submitted: ${countRecord.totalItems} items`, 'success');

            // Reset current count
            InventoryState.currentCount = [];
            renderInventoryCountList();
            updateInventoryReportStats();
        }

        function loadInventoryHistory() {
            const list = document.getElementById('inventoryHistoryList');

            if (InventoryState.history.length === 0) {
                list.innerHTML = `
                    <div class="empty-state small">
                        <i class="fas fa-history"></i>
                        <p>No recent counts</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = InventoryState.history.slice(0, 20).map(record => `
                <div class="costing-log-item">
                    <div>
                        <div class="costing-log-task">${record.totalItems} items</div>
                        <div class="costing-log-meta">
                            ${record.locations.join(', ')} &bull; ${new Date(record.timestamp).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="costing-log-duration" style="color: #3b82f6;">
                        ${record.user}
                    </div>
                </div>
            `).join('');
        }

        function updateInventoryReportStats() {
            const today = new Date().toDateString();
            const todaysCounts = InventoryState.history.filter(r =>
                new Date(r.timestamp).toDateString() === today
            );

            const totalItems = todaysCounts.reduce((sum, r) => sum + r.totalItems, 0);
            const uniqueLocations = [...new Set(todaysCounts.flatMap(r => r.locations))];

            document.getElementById('reportItemsCount').textContent = totalItems;
            document.getElementById('reportLocationsCount').textContent = uniqueLocations.length;
        }

        function generateInventoryReport() {
            const today = new Date().toDateString();
            const todaysCounts = InventoryState.history.filter(r =>
                new Date(r.timestamp).toDateString() === today
            );

            if (todaysCounts.length === 0) {
                showToast('No counts recorded today', 'info');
                return;
            }

            // Generate CSV or export
            const items = todaysCounts.flatMap(r => r.items);
            const csvContent = [
                ['Item', 'Quantity', 'Unit', 'Location', 'Time', 'User'].join(','),
                ...items.map(i => [
                    i.name,
                    i.qty,
                    i.unit,
                    i.location,
                    new Date(i.timestamp).toLocaleTimeString(),
                    todaysCounts.find(r => r.items.includes(i))?.user || ''
                ].join(','))
            ].join('\n');

            // For mobile, copy to clipboard
            navigator.clipboard?.writeText(csvContent);
            showToast('Report copied to clipboard!', 'success');
        }

        // ============================================
        // LABOR COSTING MODE
        // ============================================
        const CostingState = {
            activeTask: null,
            startTime: null,
            pausedTime: 0,
            isPaused: false,
            timerInterval: null,
            todaysLog: JSON.parse(localStorage.getItem('tsf_costing_log') || '[]')
        };

        function loadCostingTasks() {
            // Filter to today's log only
            const today = new Date().toDateString();
            CostingState.todaysLog = CostingState.todaysLog.filter(r =>
                new Date(r.timestamp).toDateString() === today
            );

            renderCostingLog();
            updateCostingTimerDisplay();

            // Restore active task if any
            const savedTask = localStorage.getItem('tsf_active_costing_task');
            if (savedTask) {
                const task = JSON.parse(savedTask);
                if (task.date === today) {
                    CostingState.activeTask = task;
                    CostingState.startTime = new Date(task.startTime);
                    CostingState.pausedTime = task.pausedTime || 0;
                    showActiveTaskPanel();
                    startCostingTimerInterval();
                }
            }
        }

        function startCostingTask() {
            const taskType = document.getElementById('costingTaskType').value;
            const crop = document.getElementById('costingCrop').value;
            const field = document.getElementById('costingField').value;

            if (!taskType) {
                showToast('Please select a task type', 'error');
                return;
            }

            CostingState.activeTask = {
                type: taskType,
                crop: crop || 'N/A',
                field: field || 'N/A',
                startTime: new Date().toISOString(),
                date: new Date().toDateString(),
                user: AppState.employee?.Name || 'Unknown'
            };

            CostingState.startTime = new Date();
            CostingState.pausedTime = 0;
            CostingState.isPaused = false;

            // Save active task
            localStorage.setItem('tsf_active_costing_task', JSON.stringify(CostingState.activeTask));

            showActiveTaskPanel();
            startCostingTimerInterval();

            showToast(`Started tracking: ${taskType}`, 'success');
        }

        function showActiveTaskPanel() {
            document.getElementById('costingActiveTask').style.display = 'block';
            document.getElementById('costingTaskSelect').style.display = 'none';

            const taskNames = {
                planting: 'Planting', transplanting: 'Transplanting', weeding: 'Weeding',
                cultivating: 'Cultivating', harvesting: 'Harvesting', washing: 'Washing',
                packing: 'Packing', seeding: 'Seeding Trays', irrigation: 'Irrigation', other: 'Other'
            };

            document.getElementById('costingActiveTaskName').textContent =
                taskNames[CostingState.activeTask.type] || CostingState.activeTask.type;
            document.getElementById('costingActiveCrop').textContent =
                CostingState.activeTask.crop !== 'N/A' ? CostingState.activeTask.crop : '';
            document.getElementById('costingActiveField').textContent =
                CostingState.activeTask.field !== 'N/A' ? CostingState.activeTask.field : '';
        }

        function hideActiveTaskPanel() {
            document.getElementById('costingActiveTask').style.display = 'none';
            document.getElementById('costingTaskSelect').style.display = 'block';
        }

        function startCostingTimerInterval() {
            if (CostingState.timerInterval) {
                clearInterval(CostingState.timerInterval);
            }

            CostingState.timerInterval = setInterval(() => {
                if (!CostingState.isPaused) {
                    updateCostingTimerDisplay();
                }
            }, 1000);
        }

        function updateCostingTimerDisplay() {
            if (!CostingState.startTime) {
                document.getElementById('costingTimerValue').textContent = '00:00:00';
                document.getElementById('costingBigTimer').textContent = '00:00:00';
                return;
            }

            const now = new Date();
            let elapsed = (now - CostingState.startTime) / 1000 - CostingState.pausedTime;
            if (elapsed < 0) elapsed = 0;

            const hours = Math.floor(elapsed / 3600);
            const mins = Math.floor((elapsed % 3600) / 60);
            const secs = Math.floor(elapsed % 60);

            const timeStr = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            document.getElementById('costingTimerValue').textContent = timeStr;
            document.getElementById('costingBigTimer').textContent = timeStr;
        }

        function pauseCostingTimer() {
            const pauseBtn = document.querySelector('.costing-pause-btn');

            if (CostingState.isPaused) {
                // Resume
                CostingState.isPaused = false;
                pauseBtn.classList.remove('paused');
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                showToast('Timer resumed', 'info');
            } else {
                // Pause
                CostingState.isPaused = true;
                CostingState.pauseStartTime = new Date();
                pauseBtn.classList.add('paused');
                pauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                showToast('Timer paused', 'info');
            }
        }

        async function stopCostingTask() {
            if (!CostingState.activeTask) return;

            // Calculate duration
            const now = new Date();
            let totalSeconds = (now - CostingState.startTime) / 1000 - CostingState.pausedTime;
            if (totalSeconds < 0) totalSeconds = 0;

            const hours = Math.floor(totalSeconds / 3600);
            const mins = Math.floor((totalSeconds % 3600) / 60);
            const durationStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

            // Create log entry
            const logEntry = {
                id: Date.now(),
                ...CostingState.activeTask,
                endTime: now.toISOString(),
                timestamp: now.toISOString(),
                durationSeconds: totalSeconds,
                durationFormatted: durationStr
            };

            // Save to log
            CostingState.todaysLog.unshift(logEntry);
            localStorage.setItem('tsf_costing_log', JSON.stringify(CostingState.todaysLog.slice(0, 500)));

            // Clear active task
            localStorage.removeItem('tsf_active_costing_task');

            // Send to backend
            try {
                await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'logLaborCost',
                        ...logEntry
                    })
                });
            } catch (error) {
                console.error('[Costing] Submit error:', error);
            }

            showToast(`Task logged: ${durationStr}`, 'success');

            // Reset state
            clearInterval(CostingState.timerInterval);
            CostingState.activeTask = null;
            CostingState.startTime = null;
            CostingState.pausedTime = 0;
            CostingState.isPaused = false;

            hideActiveTaskPanel();
            updateCostingTimerDisplay();
            renderCostingLog();
        }

        function renderCostingLog() {
            const list = document.getElementById('costingLogList');

            if (CostingState.todaysLog.length === 0) {
                list.innerHTML = `
                    <div class="empty-state small">
                        <i class="fas fa-clock"></i>
                        <p>No tasks logged today</p>
                    </div>
                `;
                return;
            }

            const taskNames = {
                planting: 'Planting', transplanting: 'Transplanting', weeding: 'Weeding',
                cultivating: 'Cultivating', harvesting: 'Harvesting', washing: 'Washing',
                packing: 'Packing', seeding: 'Seeding Trays', irrigation: 'Irrigation', other: 'Other'
            };

            list.innerHTML = CostingState.todaysLog.map(entry => `
                <div class="costing-log-item">
                    <div>
                        <div class="costing-log-task">${taskNames[entry.type] || entry.type}</div>
                        <div class="costing-log-meta">
                            ${entry.crop !== 'N/A' ? entry.crop + '  ' : ''}${entry.field !== 'N/A' ? entry.field : ''}
                        </div>
                    </div>
                    <div class="costing-log-duration">${entry.durationFormatted}</div>
                </div>
            `).join('');
        }

        // ============================================
        // FLEET MANAGEMENT (Tractor Mode)
        // ============================================
        const FLEET_API_URL = 'https://script.google.com/macros/s/AKfycbxkBTDNjrQJJS4ioZpqd2BC1LNLPVUsmAoYAlh2I4apIuoi3MmBoEb4E54kVYNhEd0RBA/exec';

        const FleetState = {
            tractors: [],
            utilities: [],
            runningAssets: {},  // { assetId: { startTime, startHours, operator, task } }
            needsToBuy: JSON.parse(localStorage.getItem('tsf_needs_list') || '[]')
        };

        async function loadFleetData() {
            try {
                const btn = document.getElementById('fleetRefreshBtn');
                if (btn) btn.querySelector('i').classList.add('fa-spin');

                const response = await fetch(FLEET_API_URL);
                const data = await response.json();

                FleetState.tractors = data.tractors || [];
                FleetState.utilities = data.utilities || [];

                renderFleetGrid();
                populateFleetSelects();

                if (btn) btn.querySelector('i').classList.remove('fa-spin');
            } catch (error) {
                console.error('[Fleet] Error loading:', error);
                // Use fallback data
                FleetState.tractors = [
                    { id: 'BCS-853', model: 'BCS 853 (15hp)', currenthours: 245, hoursremaining: 5, status: 'Active' },
                    { id: 'K-LX3310', model: 'Kubota LX3310', currenthours: 156, hoursremaining: 44, status: 'Active' },
                    { id: 'K-L3901', model: 'Kubota L3901', currenthours: 312, hoursremaining: 88, status: 'Active' },
                    { id: 'MF-1840M', model: 'Massey 1840M', currenthours: 423, hoursremaining: -23, status: 'Service Due' },
                ];
                renderFleetGrid();
                populateFleetSelects();
            }
        }

        function refreshFleetData() {
            loadFleetData();
            showToast('Refreshing fleet data...', 'info');
        }

        function renderFleetGrid() {
            const grid = document.getElementById('tractorGrid');
            if (!grid) return;

            if (FleetState.tractors.length === 0) {
                grid.innerHTML = `<div class="empty-state"><i class="fas fa-tractor"></i><h3>No tractors found</h3></div>`;
                return;
            }

            grid.innerHTML = FleetState.tractors.map(t => {
                const isRunning = FleetState.runningAssets[t.id];
                const statusClass = (t.status || '').toLowerCase().replace(' ', '-') || 'active';
                const hours = parseFloat(t.currenthours || t.currentHours || 0);

                return `
                    <div class="tractor-card ${isRunning ? 'running' : ''}" onclick="openTractorDialog('${t.id}')">
                        <div class="tractor-card-header">
                            <span class="tractor-id">${t.id}</span>
                            <span class="tractor-status ${statusClass}">${t.status || 'Active'}</span>
                        </div>
                        <div class="tractor-model">${t.model || 'Unknown'}</div>
                        <div class="tractor-hours">
                            <span class="tractor-hours-label">Hours</span>
                            <span class="tractor-hours-value">${hours.toLocaleString()}</span>
                        </div>
                        <button class="tractor-action ${isRunning ? 'running' : 'start'}" onclick="event.stopPropagation(); ${isRunning ? `stopTractor('${t.id}')` : `startTractor('${t.id}')`}">
                            <i class="fas fa-${isRunning ? 'stop' : 'play'}"></i>
                            ${isRunning ? 'RUNNING' : 'Start'}
                        </button>
                    </div>
                `;
            }).join('');

            // Update active sessions
            updateActiveSessions();
        }

        function updateActiveSessions() {
            const container = document.getElementById('activeTractorSessions');
            const list = document.getElementById('activeTractorList');
            if (!container || !list) return;

            const running = Object.entries(FleetState.runningAssets);
            if (running.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = running.map(([assetId, data]) => {
                const elapsed = Math.floor((Date.now() - data.startTime) / 60000);
                return `
                    <div class="session-item">
                        <div>
                            <div class="session-asset">${assetId}</div>
                            <div class="session-meta">${data.task} - ${data.operator}</div>
                        </div>
                        <div class="session-timer">${elapsed}m</div>
                    </div>
                `;
            }).join('');
        }

        function startTractor(assetId) {
            // Show start dialog
            const tractor = FleetState.tractors.find(t => t.id === assetId);
            const hours = parseFloat(tractor?.currenthours || tractor?.currentHours || 0);

            const dialog = document.createElement('div');
            dialog.className = 'tractor-dialog active';
            dialog.id = 'tractorStartDialog';
            dialog.innerHTML = `
                <div class="tractor-dialog-content">
                    <div class="tractor-dialog-title">
                        <i class="fas fa-tractor"></i>
                        Start ${assetId}
                    </div>
                    <div class="form-group">
                        <label>Operator</label>
                        <input type="text" id="tractorOperator" class="garage-input" value="${AppState.employee?.Name || ''}" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label>Task</label>
                        <select id="tractorTask" class="garage-select">
                            <option value="">-- Select Task --</option>
                            <option value="Primary Tillage">Primary Tillage (Plowing)</option>
                            <option value="Tillage">Tillage (Discing, Rototilling)</option>
                            <option value="Cultivation">Cultivation (Weed control)</option>
                            <option value="Site Maintenance">Site Maintenance (Mowing, Loader)</option>
                            <option value="Transport">Transport</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Starting Hours</label>
                        <input type="number" id="tractorStartHours" class="garage-input" value="${hours}" placeholder="Current hours" inputmode="decimal" step="0.1">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="garage-submit secondary" onclick="closeTractorDialog()" style="flex: 1;">Cancel</button>
                        <button class="garage-submit" onclick="confirmStartTractor('${assetId}')" style="flex: 1; background: var(--success);">
                            <i class="fas fa-play"></i> Start
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        async function confirmStartTractor(assetId) {
            const operator = document.getElementById('tractorOperator').value;
            const task = document.getElementById('tractorTask').value;
            const startHours = parseFloat(document.getElementById('tractorStartHours').value);

            if (!operator || !task) {
                showToast('Please fill in all fields', 'warning');
                return;
            }

            // Save to local state
            FleetState.runningAssets[assetId] = {
                startTime: Date.now(),
                startHours: startHours,
                operator: operator,
                task: task
            };

            // Send to API
            try {
                await fetch(FLEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'usage_start',
                        assetId: assetId,
                        operator: operator,
                        task: task,
                        reading: startHours,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (e) {
                console.log('[Fleet] API call queued for sync');
            }

            closeTractorDialog();
            renderFleetGrid();
            showToast(`${assetId} started - ${task}`, 'success');

            // Create a task for this work session
            generateChainTask(assetId, 'tractor-work', task);
        }

        function stopTractor(assetId) {
            const running = FleetState.runningAssets[assetId];
            if (!running) return;

            const elapsed = Math.floor((Date.now() - running.startTime) / 60000);

            const dialog = document.createElement('div');
            dialog.className = 'tractor-dialog active';
            dialog.id = 'tractorStartDialog';
            dialog.innerHTML = `
                <div class="tractor-dialog-content">
                    <div class="tractor-dialog-title">
                        <i class="fas fa-stop-circle" style="color: var(--success);"></i>
                        Stop ${assetId}
                    </div>
                    <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="color: var(--text-secondary); font-size: 13px;">Session Info</div>
                        <div style="color: var(--text-primary);">Operator: ${running.operator}</div>
                        <div style="color: var(--text-primary);">Task: ${running.task}</div>
                        <div style="color: var(--text-primary);">Started: ${running.startHours} hrs</div>
                        <div style="color: var(--success); font-weight: 700;">Time: ${elapsed} minutes</div>
                    </div>
                    <div class="form-group">
                        <label>Ending Hours</label>
                        <input type="number" id="tractorEndHours" class="garage-input" placeholder="Current hours on meter" inputmode="decimal" step="0.1">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="garage-submit secondary" onclick="closeTractorDialog()" style="flex: 1;">Cancel</button>
                        <button class="garage-submit" onclick="confirmStopTractor('${assetId}')" style="flex: 1;">
                            <i class="fas fa-check"></i> Log Hours
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        async function confirmStopTractor(assetId) {
            const endHours = parseFloat(document.getElementById('tractorEndHours').value);
            const running = FleetState.runningAssets[assetId];

            if (!endHours || endHours < running.startHours) {
                showToast('Please enter valid ending hours', 'warning');
                return;
            }

            const hoursRun = endHours - running.startHours;

            // Send to API
            try {
                await fetch(FLEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'usage_end',
                        assetId: assetId,
                        reading: endHours,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (e) {
                console.log('[Fleet] API call queued for sync');
            }

            // Clear from running
            delete FleetState.runningAssets[assetId];

            closeTractorDialog();
            renderFleetGrid();
            showToast(`Logged ${hoursRun.toFixed(1)} hours for ${assetId}`, 'success');
        }

        function closeTractorDialog() {
            const dialog = document.getElementById('tractorStartDialog');
            if (dialog) dialog.remove();
        }

        function openTractorDialog(assetId) {
            // Show tractor details/wheel specs
            const tractor = FleetState.tractors.find(t => t.id === assetId);
            showToast(`${assetId}: ${tractor?.model || 'Unknown'}`, 'info');
        }

        function populateFleetSelects() {
            const selects = ['fuelAsset', 'garageAsset', 'breakdownAsset', 'inspectAsset'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;

                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select --</option>';

                FleetState.tractors.forEach(t => {
                    select.innerHTML += `<option value="${t.id}">${t.id} - ${t.model || 'Tractor'}</option>`;
                });

                FleetState.utilities.forEach(u => {
                    select.innerHTML += `<option value="${u.id}">${u.id} - ${u.model || 'Vehicle'}</option>`;
                });

                if (currentValue) select.value = currentValue;
            });
        }

        // ============================================
        // FUEL LOGGING (Tractor Mode)
        // ============================================
        function updateFuelTotal() {
            const gallons = parseFloat(document.getElementById('fuelGallons')?.value || 0);
            const costPerGallon = parseFloat(document.getElementById('fuelCostPerGallon')?.value || 0);
            const total = gallons * costPerGallon;
            const display = document.getElementById('fuelTotalAmount');
            if (display) display.textContent = `$${total.toFixed(2)}`;
        }

        // Add event listeners for fuel inputs
        document.addEventListener('DOMContentLoaded', () => {
            const fuelGallons = document.getElementById('fuelGallons');
            const fuelCost = document.getElementById('fuelCostPerGallon');
            if (fuelGallons) fuelGallons.addEventListener('input', updateFuelTotal);
            if (fuelCost) fuelCost.addEventListener('input', updateFuelTotal);
        });

        async function submitFuelLog() {
            const assetId = document.getElementById('fuelAsset').value;
            const gallons = parseFloat(document.getElementById('fuelGallons').value);
            const costPerGallon = parseFloat(document.getElementById('fuelCostPerGallon').value);
            const reading = document.getElementById('fuelReading').value;

            if (!assetId || !gallons) {
                showToast('Please select asset and enter gallons', 'warning');
                return;
            }

            const fuelLog = {
                assetId,
                gallons,
                costPerGallon,
                totalCost: gallons * costPerGallon,
                reading,
                timestamp: new Date().toISOString(),
                employee: AppState.employee?.Name || 'Unknown'
            };

            // Send to API (could add fuel logging endpoint)
            console.log('[Fuel] Logged:', fuelLog);

            // Clear form
            document.getElementById('fuelGallons').value = '';
            document.getElementById('fuelReading').value = '';

            showToast(`Logged ${gallons} gal for ${assetId}`, 'success');

            // Add to recent list
            addFuelToRecentList(fuelLog);
        }

        function addFuelToRecentList(log) {
            const container = document.getElementById('recentFuelLogs');
            if (!container) return;

            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const item = document.createElement('div');
            item.className = 'fuel-log-item';
            item.innerHTML = `
                <div>
                    <div class="fuel-log-asset">${log.assetId}</div>
                    <div class="fuel-log-meta">Just now</div>
                </div>
                <div class="fuel-log-amount">
                    <div class="fuel-log-gallons">${log.gallons} gal</div>
                    <div class="fuel-log-cost">$${log.totalCost.toFixed(2)}</div>
                </div>
            `;
            container.insertBefore(item, container.firstChild);
        }

        // ============================================
        // GARAGE MODE
        // ============================================
        let garagePhotoData = null;
        let breakdownPhotoData = null;
        let selectedSeverity = null;

        function loadGarageAssets() {
            loadFleetData();
        }

        function switchGarageTab(tab) {
            document.querySelectorAll('.garage-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            document.querySelectorAll('.garage-panel').forEach(p => {
                p.classList.toggle('active', p.id === `garage${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`);
            });
        }

        function selectSeverity(severity) {
            selectedSeverity = severity;
            document.querySelectorAll('.severity-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.trim().toLowerCase().includes(severity.toLowerCase()));
            });
        }

        function takeGaragePhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        garagePhotoData = ev.target.result;
                        const preview = document.getElementById('garagePhotoPreview');
                        preview.src = garagePhotoData;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function takeBreakdownPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        breakdownPhotoData = ev.target.result;
                        const preview = document.getElementById('breakdownPhotoPreview');
                        preview.src = breakdownPhotoData;
                        preview.style.display = 'block';
                        document.querySelector('.garage-photo-btn.required').classList.remove('required');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        async function submitGarageMaintenance() {
            const assetId = document.getElementById('garageAsset').value;
            const serviceType = document.getElementById('garageServiceType').value;
            const hours = document.getElementById('garageHours').value;
            const cost = document.getElementById('garageCost').value;
            const notes = document.getElementById('garageNotes').value;

            if (!assetId || !serviceType) {
                showToast('Please select asset and service type', 'warning');
                return;
            }

            const payload = {
                type: 'maintenance',
                assetId: assetId,
                category: serviceType,
                reading: parseFloat(hours) || 0,
                notes: notes,
                cost: parseFloat(cost) || 0,
                image: garagePhotoData || '',
                winterized: serviceType === 'Winterize',
                user: AppState.employee?.Name || 'Staff',
                timestamp: new Date().toISOString()
            };

            try {
                await fetch(FLEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showToast(`${serviceType} logged for ${assetId}`, 'success');

                // Clear form
                document.getElementById('garageAsset').value = '';
                document.getElementById('garageServiceType').value = '';
                document.getElementById('garageHours').value = '';
                document.getElementById('garageCost').value = '';
                document.getElementById('garageNotes').value = '';
                garagePhotoData = null;
                document.getElementById('garagePhotoPreview').style.display = 'none';

            } catch (e) {
                showToast('Logged locally - will sync when online', 'info');
            }
        }

        async function submitBreakdown() {
            const assetId = document.getElementById('breakdownAsset').value;
            const notes = document.getElementById('breakdownNotes').value;
            const parts = document.getElementById('breakdownParts').value;

            if (!assetId || !selectedSeverity || !breakdownPhotoData) {
                showToast('Please fill all fields and take a photo', 'warning');
                return;
            }

            const payload = {
                type: 'breakdown',
                assetId: assetId,
                severity: selectedSeverity,
                notes: notes,
                parts: parts,
                image: breakdownPhotoData,
                user: AppState.employee?.Name || 'Staff',
                timestamp: new Date().toISOString()
            };

            try {
                await fetch(FLEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showToast(`Breakdown reported for ${assetId}`, 'success');

                // Clear form
                document.getElementById('breakdownAsset').value = '';
                document.getElementById('breakdownNotes').value = '';
                document.getElementById('breakdownParts').value = '';
                breakdownPhotoData = null;
                selectedSeverity = null;
                document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById('breakdownPhotoPreview').style.display = 'none';

            } catch (e) {
                showToast('Reported locally - will sync when online', 'info');
            }
        }

        async function submitInspection() {
            const assetId = document.getElementById('inspectAsset').value;
            const lights = document.getElementById('inspectLights').checked;
            const tires = document.getElementById('inspectTires').checked;
            const fluids = document.getElementById('inspectFluids').checked;
            const brakes = document.getElementById('inspectBrakes').checked;
            const notes = document.getElementById('inspectNotes').value;

            if (!assetId) {
                showToast('Please select an asset', 'warning');
                return;
            }

            const payload = {
                type: 'inspection',
                assetId: assetId,
                lights: lights,
                tires: tires,
                fluids: fluids,
                brakes: brakes,
                notes: notes,
                user: AppState.employee?.Name || 'Staff',
                timestamp: new Date().toISOString()
            };

            try {
                await fetch(FLEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showToast(`Inspection complete for ${assetId}`, 'success');

                // Clear form
                document.getElementById('inspectAsset').value = '';
                document.getElementById('inspectLights').checked = false;
                document.getElementById('inspectTires').checked = false;
                document.getElementById('inspectFluids').checked = false;
                document.getElementById('inspectBrakes').checked = false;
                document.getElementById('inspectNotes').value = '';

            } catch (e) {
                showToast('Logged locally - will sync when online', 'info');
            }
        }

        // ============================================
        // NEEDS TO BUY LIST
        // ============================================
        function addToNeedsList() {
            const input = document.getElementById('newPartItem');
            const item = input.value.trim();
            if (!item) return;

            FleetState.needsToBuy.push({
                id: Date.now(),
                item: item,
                addedBy: AppState.employee?.Name || 'Unknown',
                addedAt: new Date().toISOString()
            });

            localStorage.setItem('tsf_needs_list', JSON.stringify(FleetState.needsToBuy));
            input.value = '';
            renderNeedsList();
            showToast('Item added to list', 'success');
        }

        function removeFromNeedsList(id) {
            FleetState.needsToBuy = FleetState.needsToBuy.filter(i => i.id !== id);
            localStorage.setItem('tsf_needs_list', JSON.stringify(FleetState.needsToBuy));
            renderNeedsList();
        }

        function renderNeedsList() {
            const container = document.getElementById('needsToBuyList');
            if (!container) return;

            if (FleetState.needsToBuy.length === 0) {
                container.innerHTML = `<div class="empty-state small"><i class="fas fa-shopping-cart"></i><p>No items in list</p></div>`;
                return;
            }

            container.innerHTML = FleetState.needsToBuy.map(item => `
                <div class="needs-item">
                    <span class="needs-item-text">${item.item}</span>
                    <button class="needs-item-remove" onclick="removeFromNeedsList(${item.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function shareNeedsList() {
            const items = FleetState.needsToBuy.map(i => `- ${i.item}`).join('\n');
            const text = `Tiny Seed Farm - Needs to Buy\n\n${items || 'No items'}`;

            if (navigator.share) {
                navigator.share({ title: 'TSF Needs List', text: text });
            } else {
                navigator.clipboard.writeText(text);
                showToast('List copied to clipboard', 'success');
            }
        }

        // Initialize needs list on load
        document.addEventListener('DOMContentLoaded', renderNeedsList);

        // ============================================
        // QR/BARCODE SCANNER
        // ============================================
        let scannerStream = null;
        let scannerContext = null;
        let html5QrCode = null;

        async function openScanner(context) {
            scannerContext = context;
            document.getElementById('scannerTitle').textContent =
                context === 'receiving' ? 'Scan Harvest Ticket' :
                context === 'inventory' ? 'Scan Product Label' :
                'Scan QR Code';

            document.getElementById('scannerModal').classList.add('active');

            // Initialize html5-qrcode scanner
            const scannerContainer = document.getElementById('scannerVideo');

            // Clear any existing video element content and set up for html5-qrcode
            scannerContainer.innerHTML = '';
            scannerContainer.id = 'qr-reader';

            try {
                html5QrCode = new Html5Qrcode('qr-reader');

                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.QR_CODE,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.UPC_A
                    ]
                };

                await html5QrCode.start(
                    { facingMode: 'environment' },
                    config,
                    (decodedText, decodedResult) => {
                        // Successfully scanned
                        console.log('[Scanner] Detected:', decodedText, decodedResult);
                        handleScannedCode(decodedText);
                        closeScanner();
                    },
                    (errorMessage) => {
                        // Scanning in progress, ignore frame errors
                    }
                );

                showToast('Point camera at QR code or barcode', 'info');

            } catch (error) {
                console.error('Scanner error:', error);
                showToast('Camera access denied - use manual entry', 'warning');
                // Don't close - allow manual entry
            }
        }

        async function closeScanner() {
            document.getElementById('scannerModal').classList.remove('active');

            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                } catch (e) {
                    // Ignore stop errors
                }
                html5QrCode = null;
            }

            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }

            // Restore the element ID
            const reader = document.getElementById('qr-reader');
            if (reader) {
                reader.id = 'scannerVideo';
            }
        }

        function manualEntry() {
            closeScanner();

            // Create a nicer manual entry modal
            const batchId = prompt('Enter Batch ID or scan code manually:');
            if (batchId && batchId.trim()) {
                handleScannedCode(batchId.trim().toUpperCase());
            }
        }

        function handleScannedCode(code) {
            // Show success animation
            const success = document.createElement('div');
            success.className = 'scan-success';
            success.innerHTML = '<i class="fas fa-check"></i>';
            document.body.appendChild(success);
            setTimeout(() => success.remove(), 600);

            // Handle based on context
            if (scannerContext === 'receiving') {
                addToReceivingQueue(code);
            } else if (scannerContext === 'inventory') {
                lookupInventoryItem(code);
            }

            showToast(`Scanned: ${code}`, 'success');
        }

        function addToReceivingQueue(batchId) {
            const queue = document.getElementById('receivingQueue');
            queue.innerHTML = `
                <div class="receiving-item">
                    <div class="receiving-item-status waiting"></div>
                    <div class="receiving-item-info">
                        <div class="receiving-item-batch">${batchId}</div>
                        <div class="receiving-item-crop">Loading crop info...</div>
                    </div>
                    <button class="receiving-item-action" onclick="startProcessing('${batchId}')">
                        Start Wash
                    </button>
                </div>
            ` + queue.innerHTML;

            // Generate task: "Wash & Sort [batchId]"
            generateChainTask(batchId, 'wash', 'Wash & Sort');
        }

        function lookupInventoryItem(code) {
            // Look up product in cooler inventory
            showToast(`Looking up ${code}...`, 'info');
            // In production: fetch from API and display details
        }

        // ============================================
        // PACKHOUSE PROCESSING FLOW
        // ============================================
        const ProcessingState = {
            currentBatch: null,
            step: null, // 'wash', 'weigh', 'grade', 'pack'
            startTime: null,
            data: {}
        };

        function startProcessing(batchId) {
            ProcessingState.currentBatch = batchId;
            ProcessingState.step = 'wash';
            ProcessingState.startTime = Date.now();
            ProcessingState.data = { batchId };

            showProcessingModal(batchId, 'wash');
        }

        function showProcessingModal(batchId, step) {
            // Create/show processing modal
            let modal = document.getElementById('processingModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'processingModal';
                modal.className = 'processing-modal';
                document.body.appendChild(modal);
            }

            const steps = {
                wash: {
                    title: 'Wash & Sort',
                    icon: 'droplet',
                    instruction: 'Wash produce and sort by quality. Remove damaged items.',
                    action: 'Complete Wash',
                    next: 'weigh'
                },
                weigh: {
                    title: 'Weigh',
                    icon: 'scale-balanced',
                    instruction: 'Place on scale and record weight.',
                    action: 'Record Weight',
                    next: 'grade',
                    hasInput: true,
                    inputType: 'number',
                    inputLabel: 'Weight (lbs)',
                    inputId: 'processWeight'
                },
                grade: {
                    title: 'Grade Quality',
                    icon: 'star',
                    instruction: 'Select quality grade for this batch.',
                    action: 'Set Grade',
                    next: 'pack',
                    hasGrade: true
                },
                pack: {
                    title: 'Pack & Label',
                    icon: 'box',
                    instruction: 'Pack into containers and print labels.',
                    action: 'Print Label & Complete',
                    next: null
                }
            };

            const s = steps[step];

            modal.innerHTML = `
                <div class="processing-content">
                    <div class="processing-header">
                        <span class="processing-batch">${batchId}</span>
                        <button class="processing-close" onclick="cancelProcessing()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="processing-step-indicator">
                        <div class="step-dot ${step === 'wash' ? 'active' : 'done'}"></div>
                        <div class="step-line ${['weigh','grade','pack'].includes(step) ? 'done' : ''}"></div>
                        <div class="step-dot ${step === 'weigh' ? 'active' : (step === 'grade' || step === 'pack') ? 'done' : ''}"></div>
                        <div class="step-line ${['grade','pack'].includes(step) ? 'done' : ''}"></div>
                        <div class="step-dot ${step === 'grade' ? 'active' : step === 'pack' ? 'done' : ''}"></div>
                        <div class="step-line ${step === 'pack' ? 'done' : ''}"></div>
                        <div class="step-dot ${step === 'pack' ? 'active' : ''}"></div>
                    </div>

                    <div class="processing-main">
                        <div class="processing-icon">
                            <i class="fas fa-${s.icon}"></i>
                        </div>
                        <h2 class="processing-title">${s.title}</h2>
                        <p class="processing-instruction">${s.instruction}</p>

                        ${s.hasInput ? `
                            <div class="processing-input-group">
                                <label>${s.inputLabel}</label>
                                <input type="${s.inputType}" id="${s.inputId}" class="processing-input" placeholder="0.0" inputmode="decimal">
                            </div>
                        ` : ''}

                        ${s.hasGrade ? `
                            <div class="grade-selector">
                                <button class="grade-btn grade-a" onclick="selectGrade('A')">
                                    <span class="grade-letter">A</span>
                                    <span class="grade-label">Premium</span>
                                </button>
                                <button class="grade-btn grade-b" onclick="selectGrade('B')">
                                    <span class="grade-letter">B</span>
                                    <span class="grade-label">Standard</span>
                                </button>
                                <button class="grade-btn grade-c" onclick="selectGrade('C')">
                                    <span class="grade-letter">C</span>
                                    <span class="grade-label">Processing</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <button class="processing-action-btn" onclick="completeProcessingStep('${step}')">
                        ${s.action} <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `;

            modal.classList.add('active');

            // Add CSS if not exists
            if (!document.getElementById('processingModalStyles')) {
                const styles = document.createElement('style');
                styles.id = 'processingModalStyles';
                styles.textContent = `
                    .processing-modal {
                        position: fixed;
                        inset: 0;
                        background: var(--bg-dark);
                        z-index: 9999;
                        display: none;
                        flex-direction: column;
                    }
                    .processing-modal.active { display: flex; }
                    .processing-content {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        padding: 20px;
                        padding-top: calc(20px + var(--safe-top));
                    }
                    .processing-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    }
                    .processing-batch {
                        font-size: 14px;
                        color: var(--text-secondary);
                        background: var(--bg-card);
                        padding: 6px 12px;
                        border-radius: 20px;
                    }
                    .processing-close {
                        background: none;
                        border: none;
                        color: var(--text-secondary);
                        font-size: 20px;
                        padding: 8px;
                    }
                    .processing-step-indicator {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 4px;
                        margin-bottom: 30px;
                    }
                    .step-dot {
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        background: var(--bg-elevated);
                    }
                    .step-dot.active { background: var(--success); box-shadow: 0 0 10px var(--success); }
                    .step-dot.done { background: var(--primary-light); }
                    .step-line {
                        width: 30px;
                        height: 3px;
                        background: var(--bg-elevated);
                    }
                    .step-line.done { background: var(--primary-light); }
                    .processing-main {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                    }
                    .processing-icon {
                        width: 80px;
                        height: 80px;
                        border-radius: 50%;
                        background: var(--primary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 32px;
                        color: white;
                        margin-bottom: 20px;
                    }
                    .processing-title {
                        font-size: 24px;
                        margin-bottom: 10px;
                        color: var(--text-primary);
                    }
                    .processing-instruction {
                        color: var(--text-secondary);
                        margin-bottom: 30px;
                        max-width: 280px;
                    }
                    .processing-input-group {
                        width: 100%;
                        max-width: 200px;
                        margin-bottom: 20px;
                    }
                    .processing-input-group label {
                        display: block;
                        color: var(--text-secondary);
                        font-size: 14px;
                        margin-bottom: 8px;
                    }
                    .processing-input {
                        width: 100%;
                        padding: 16px;
                        font-size: 32px;
                        text-align: center;
                        background: var(--bg-card);
                        border: 2px solid var(--border);
                        border-radius: 12px;
                        color: var(--text-primary);
                    }
                    .processing-input:focus {
                        outline: none;
                        border-color: var(--primary-light);
                    }
                    .grade-selector {
                        display: flex;
                        gap: 16px;
                    }
                    .grade-btn {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        padding: 20px 24px;
                        border: 2px solid var(--border);
                        border-radius: 12px;
                        background: var(--bg-card);
                        color: var(--text-primary);
                        cursor: pointer;
                    }
                    .grade-btn.selected { border-color: var(--success); background: var(--success-bg); }
                    .grade-letter { font-size: 28px; font-weight: 700; }
                    .grade-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
                    .grade-a .grade-letter { color: #22c55e; }
                    .grade-b .grade-letter { color: #f59e0b; }
                    .grade-c .grade-letter { color: #94a3b8; }
                    .processing-action-btn {
                        width: 100%;
                        padding: 18px;
                        background: var(--success);
                        border: none;
                        border-radius: 12px;
                        color: white;
                        font-size: 18px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        margin-bottom: var(--safe-bottom, 20px);
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        function selectGrade(grade) {
            ProcessingState.data.grade = grade;
            document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        function completeProcessingStep(step) {
            const steps = {
                wash: { next: 'weigh' },
                weigh: { next: 'grade' },
                grade: { next: 'pack' },
                pack: { next: null }
            };

            // Collect data for this step
            if (step === 'weigh') {
                const weight = document.getElementById('processWeight')?.value;
                if (!weight || parseFloat(weight) <= 0) {
                    showToast('Please enter weight', 'warning');
                    return;
                }
                ProcessingState.data.weight = parseFloat(weight);
            }

            if (step === 'grade' && !ProcessingState.data.grade) {
                showToast('Please select a grade', 'warning');
                return;
            }

            // Move to next step or complete
            const nextStep = steps[step].next;
            if (nextStep) {
                ProcessingState.step = nextStep;
                showProcessingModal(ProcessingState.currentBatch, nextStep);

                // Generate chain task for the step we just completed
                generateChainTask(ProcessingState.currentBatch, nextStep, TASK_CHAIN[step]?.label || nextStep);
            } else {
                // Processing complete - print label and finish
                completeProcessing();
            }
        }

        async function completeProcessing() {
            const data = ProcessingState.data;

            // Print label
            await printLabel('inventory', {
                batchId: data.batchId,
                weight: data.weight,
                grade: data.grade,
                packDate: new Date().toLocaleDateString(),
                packedBy: AppState.employee?.Name || 'Staff'
            });

            // Log traceability event
            const traceEvent = {
                batchId: data.batchId,
                action: 'packed',
                weight: data.weight,
                grade: data.grade,
                timestamp: new Date().toISOString(),
                employee: AppState.employee?.Employee_ID,
                duration: Math.round((Date.now() - ProcessingState.startTime) / 60000)
            };

            console.log('[Traceability] Pack complete:', traceEvent);

            // In production: POST to API
            if (AppState.isOnline) {
                try {
                    const params = new URLSearchParams({
                        action: 'logTraceability',
                        ...traceEvent
                    });
                    await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                } catch (e) {
                    console.log('[Traceability] Will sync when online');
                }
            }

            // Generate final task: Move to Storage
            generateChainTask(data.batchId, 'store', 'Move to Storage');

            // Close modal
            document.getElementById('processingModal')?.classList.remove('active');

            // Show success
            showToast(`${data.batchId} packed! Label printed.`, 'success');

            // Clear state
            ProcessingState.currentBatch = null;
            ProcessingState.step = null;
            ProcessingState.data = {};

            // Update receiving queue UI
            const queueItem = document.querySelector(`.receiving-item-batch:contains("${data.batchId}")`);
            if (queueItem) {
                queueItem.closest('.receiving-item')?.remove();
            }
        }

        function cancelProcessing() {
            if (confirm('Cancel processing this batch?')) {
                document.getElementById('processingModal')?.classList.remove('active');
                ProcessingState.currentBatch = null;
                ProcessingState.step = null;
                ProcessingState.data = {};
            }
        }

        // ============================================
        // TASK CHAIN SYSTEM (Seed-to-Sale)
        // ============================================
        const TASK_CHAIN = {
            'harvest': { next: 'transport', label: 'Transport to Packhouse' },
            'transport': { next: 'wash', label: 'Wash & Sort' },
            'wash': { next: 'weigh', label: 'Weigh & Grade' },
            'weigh': { next: 'pack', label: 'Pack & Label' },
            'pack': { next: 'store', label: 'Move to Storage' },
            'store': { next: null, label: null }
        };

        async function generateChainTask(batchId, taskType, label) {
            const task = {
                id: `chain-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                batchId: batchId,
                Batch_ID: batchId,
                taskType: taskType,
                type: taskType,
                Task: `${label} - ${batchId}`,
                description: `${label} - ${batchId}`,
                createdAt: new Date().toISOString(),
                status: 'pending',
                costingMode: true, // Track labor cost for traceability
                Costing_Mode: true,
                assignedTo: AppState.employee?.Employee_ID || 'crew',
                priority: taskType === 'wash' ? 'high' : 'medium',
                // Traceability metadata
                chainStep: taskType,
                previousStep: TASK_CHAIN[taskType]?.prev || null
            };

            console.log('[TaskChain] Generated:', task);

            // Add to local task list immediately
            AppState.tasks.unshift(task);

            // Update UI if on tasks tab
            if (typeof renderTasksV2 === 'function') {
                renderTasksV2();
            }

            // Sync to backend
            if (AppState.isOnline) {
                try {
                    const params = new URLSearchParams({
                        action: 'createChainTask',
                        batchId: batchId,
                        taskType: taskType,
                        label: label,
                        employeeId: AppState.employee?.Employee_ID || ''
                    });
                    await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                } catch (e) {
                    console.log('[TaskChain] Will sync when online');
                }
            } else {
                // Queue for offline sync
                await OfflineDB.queueOperation('createChainTask', task);
            }

            showToast(`Next: ${label}`, 'info');
        }

        async function completeTaskWithChain(taskId, batchId, taskType) {
            // Complete the current task
            // ... existing completion logic ...

            // Generate the next task in the chain
            const chain = TASK_CHAIN[taskType];
            if (chain && chain.next) {
                await generateChainTask(batchId, chain.next, chain.label);
            }
        }

        // ============================================
        // WILDLIFE TRACKER
        // ============================================
        function selectWildlife(type) {
            // Update button selection
            document.querySelectorAll('.wildlife-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Get GPS location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => logWildlife(type, position.coords),
                    () => logWildlife(type, null)
                );
            } else {
                logWildlife(type, null);
            }
        }

        function logWildlife(type, coords) {
            const emojis = {
                deer: '', groundhog: '', rabbit: '', crow: '',
                turkey: '', coyote: '', bear: '', fox: '', other: ''
            };

            const entry = {
                type: type,
                emoji: emojis[type],
                timestamp: new Date().toISOString(),
                lat: coords?.latitude,
                lng: coords?.longitude,
                employee: AppState.employee?.Name
            };

            // Add to log display
            const log = document.getElementById('wildlifeLog');
            const existingEmpty = log.querySelector('.empty-state');
            if (existingEmpty) existingEmpty.remove();

            const entryEl = document.createElement('div');
            entryEl.className = 'wildlife-entry';
            entryEl.innerHTML = `
                <span class="wildlife-entry-emoji">${entry.emoji}</span>
                <div class="wildlife-entry-info">
                    <div class="wildlife-entry-type">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="wildlife-entry-meta">Just now  ${coords ? 'GPS tagged' : 'No GPS'}</div>
                </div>
            `;
            log.insertBefore(entryEl, log.firstChild);

            showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} sighting logged!`, 'success');

            // In production: POST to API
            // fetch(CONFIG.API_URL, { method: 'POST', body: JSON.stringify({ action: 'logWildlife', ...entry }) });
        }

        // ============================================
        // FARMPIC (Documentation Photos)
        // ============================================
        async function takeFarmpic() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                // In production: Show camera view, capture photo
                // For now: Open file picker
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';
                input.onchange = (e) => handleFarmpic(e.target.files[0]);
                input.click();
                stream.getTracks().forEach(t => t.stop());
            } catch (error) {
                // Fallback to file picker
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => handleFarmpic(e.target.files[0]);
                input.click();
            }
        }

        function handleFarmpic(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                addToFarmpicGallery(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function addToFarmpicGallery(imageData) {
            const gallery = document.getElementById('farmpicGallery');
            const existingEmpty = gallery.querySelector('.empty-state');
            if (existingEmpty) existingEmpty.remove();

            const thumb = document.createElement('div');
            thumb.className = 'farmpic-thumb';
            thumb.innerHTML = `<img src="${imageData}" alt="Farm photo">`;
            gallery.insertBefore(thumb, gallery.firstChild);

            showToast('Photo added!', 'success');

            // In production: Upload to storage, tag with GPS & timestamp
        }

        // ============================================
        // LABEL PRINTING (Zebra ZPL)
        // ============================================
        async function printLabel(type, data) {
            // Generate ZPL code for Zebra printer
            const zpl = generateZPL(type, data);

            // Try Bluetooth printing (Zebra printers support this)
            try {
                if ('bluetooth' in navigator) {
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: ['printer_service'] }]
                    });
                    // Connect and send ZPL
                    console.log('Bluetooth printing:', device.name);
                }
            } catch (error) {
                // Fallback: Show ZPL for manual copy or use print server
                console.log('ZPL for printing:', zpl);
                showToast('Label sent to printer', 'success');
            }
        }

        function generateZPL(type, data) {
            // ZPL template for different label types
            if (type === 'harvest') {
                return `^XA
^FO50,50^A0N,40,40^FD${data.batchId}^FS
^FO50,100^A0N,30,30^FD${data.crop} - ${data.variety}^FS
^FO50,140^A0N,25,25^FDHarvested: ${data.date}^FS
^FO50,170^A0N,25,25^FDBy: ${data.harvester}^FS
^FO50,210^BQN,2,5^FDLA,${data.batchId}^FS
^XZ`;
            }
            return '^XA^FO50,50^A0N,40,40^FDLabel^FS^XZ';
        }

        // ============================================
        // LANGUAGE TOGGLE
        // ============================================
        function toggleLanguage() {
            AppState.language = AppState.language === 'en' ? 'es' : 'en';
            document.getElementById('langToggle').textContent = AppState.language.toUpperCase();
            translatePage();

            // Save preference
            if (AppState.employee) {
                fetch(`${CONFIG.API_URL}?action=updateEmployeeLanguage&employeeId=${AppState.employee.Employee_ID}&lang=${AppState.language}`);
            }
        }

        // ============================================
        // HARVEST
        // ============================================
        function setQuality(grade) {
            AppState.harvestQuality = grade;
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === grade);
            });
        }

        async function submitHarvest() {
            const crop = document.getElementById('harvestCrop').value;
            const qty = document.getElementById('harvestQty').value;
            const unit = document.getElementById('harvestUnit').value;
            const notes = document.getElementById('harvestNotes').value;

            if (!crop || !qty) {
                showToast('Please select crop and enter quantity', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();

                const harvestData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    crop: crop,
                    quantity: qty,
                    unit: unit,
                    quality: AppState.harvestQuality,
                    notes: notes,
                    lat: gps.lat || '',
                    lng: gps.lng || '',
                    photo: AppState.capturedPhoto || ''
                };

                if (AppState.isOnline) {
                    // Online: submit directly
                    const params = new URLSearchParams({
                        action: 'logHarvestWithDetails',
                        ...harvestData
                    });

                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();

                    if (data.success) {
                        showToast(t('harvest.success'), 'success');
                        resetHarvestForm();
                        loadRecentHarvests();
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                } else {
                    // Offline: queue for later sync
                    await OfflineDB.queueOperation('logHarvestWithDetails', harvestData);
                    showToast(t('harvest.success') + ' ' + t('common.offline'), 'success');
                    resetHarvestForm();
                }
            } catch (error) {
                console.error('Harvest error:', error);
                // Network error - queue offline
                if (!AppState.isOnline) {
                    const gps = await captureGPS();
                    await OfflineDB.queueOperation('logHarvestWithDetails', {
                        employeeId: AppState.employee?.Employee_ID || '',
                        crop: crop,
                        quantity: qty,
                        unit: unit,
                        quality: AppState.harvestQuality,
                        notes: notes,
                        lat: gps.lat || '',
                        lng: gps.lng || ''
                    });
                    showToast(t('harvest.success') + ' ' + t('common.offline'), 'success');
                    resetHarvestForm();
                } else {
                    showToast(t('common.error'), 'error');
                }
            }
            hideLoading();
        }

        function resetHarvestForm() {
            document.getElementById('harvestCrop').value = '';
            document.getElementById('harvestQty').value = '';
            document.getElementById('harvestNotes').value = '';
            AppState.harvestQuality = 'A';
            setQuality('A');
            AppState.capturedPhoto = null;
            document.getElementById('harvestPhotoPreview').style.display = 'none';
        }

        // ============================================
        // SCOUTING
        // ============================================
        function setScoutType(type) {
            AppState.scoutType = type;

            // Update both old buttons and new pills
            document.querySelectorAll('.scout-type-btn, .scout-pill').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(type));
            });

            // Update library dropdown visibility based on type
            const select = document.getElementById('scoutLibrarySelect');
            if (select) {
                // Hide all optgroups first
                select.querySelectorAll('optgroup').forEach(og => og.style.display = 'none');

                // Show relevant optgroup
                const optgroupMap = {
                    'pest': 'pestOptions',
                    'disease': 'diseaseOptions',
                    'weed': 'weedOptions',
                    'beneficial': 'beneficialOptions'
                };
                const optgroup = document.getElementById(optgroupMap[type]);
                if (optgroup) {
                    optgroup.style.display = 'block';
                }
                select.value = ''; // Reset selection
            }

            // Hide severity for beneficial insects
            const severityGroup = document.getElementById('severityGroup');
            if (severityGroup) {
                severityGroup.style.display = type === 'beneficial' ? 'none' : 'block';
            }
        }

        function selectFromLibrary() {
            const select = document.getElementById('scoutLibrarySelect');
            if (select && select.value) {
                // Could add logic to auto-fill notes or severity based on selection
                const selectedText = select.options[select.selectedIndex].text;
                const notes = document.getElementById('scoutNotes');
                if (notes && !notes.value) {
                    notes.value = selectedText + ' observed';
                }
            }
        }

        // Initialize GPS for scout tab
        function initScoutGPS() {
            captureGPS().then(gps => {
                const latField = document.getElementById('scoutGpsLat');
                const lngField = document.getElementById('scoutGpsLng');
                const statusEl = document.getElementById('scoutGpsStatus');

                if (gps.lat && gps.lng) {
                    if (latField) latField.value = gps.lat;
                    if (lngField) lngField.value = gps.lng;
                    if (statusEl) {
                        statusEl.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success);"></i> <span>Location captured</span>`;
                    }
                } else {
                    if (statusEl) {
                        statusEl.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> <span>GPS unavailable - report will still submit</span>`;
                    }
                }
            });
        }

        function setSeverity(severity) {
            AppState.scoutSeverity = severity;
            document.querySelectorAll('.severity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(severity));
            });
        }

        async function submitScoutReport() {
            if (!AppState.scoutType) {
                showToast('Please select observation type', 'error');
                return;
            }

            showLoading();
            try {
                // Get GPS from hidden fields or capture fresh
                let lat = document.getElementById('scoutGpsLat')?.value || '';
                let lng = document.getElementById('scoutGpsLng')?.value || '';

                // If no cached GPS, capture now
                if (!lat || !lng) {
                    const gps = await captureGPS();
                    lat = gps.lat || '';
                    lng = gps.lng || '';
                }

                // Get library selection for identification
                const librarySelect = document.getElementById('scoutLibrarySelect');
                const libraryValue = librarySelect ? librarySelect.value : '';
                const libraryText = librarySelect && librarySelect.selectedIndex > 0
                    ? librarySelect.options[librarySelect.selectedIndex].text
                    : '';

                const notes = document.getElementById('scoutNotes').value;

                const scoutData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    type: AppState.scoutType,
                    severity: AppState.scoutSeverity || (AppState.scoutType === 'beneficial' ? 'none' : 'medium'),
                    identification: libraryText,
                    identificationCode: libraryValue,
                    notes: notes,
                    lat: lat,
                    lng: lng,
                    photo: AppState.capturedPhoto || ''
                };

                if (AppState.isOnline) {
                    // Online: submit directly
                    const params = new URLSearchParams({
                        action: 'saveScoutingReport',
                        ...scoutData
                    });

                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();

                    if (data.success) {
                        showToast(t('scout.success'), 'success');
                        resetScoutForm();
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                } else {
                    // Offline: queue for later sync
                    await OfflineDB.queueOperation('saveScoutingReport', scoutData);
                    showToast(t('scout.success') + ' ' + t('common.offline'), 'success');
                    resetScoutForm();
                }
            } catch (error) {
                console.error('Scout error:', error);
                // Network error - queue offline
                if (!AppState.isOnline) {
                    const gps = await captureGPS();
                    await OfflineDB.queueOperation('saveScoutingReport', {
                        employeeId: AppState.employee?.Employee_ID || '',
                        type: AppState.scoutType,
                        severity: AppState.scoutSeverity || 'medium',
                        field: document.getElementById('scoutField').value,
                        bed: document.getElementById('scoutBed').value,
                        notes: document.getElementById('scoutNotes').value,
                        lat: gps.lat || '',
                        lng: gps.lng || ''
                    });
                    showToast(t('scout.success') + ' ' + t('common.offline'), 'success');
                    resetScoutForm();
                } else {
                    showToast(t('common.error'), 'error');
                }
            }
            hideLoading();
        }

        function resetScoutForm() {
            AppState.scoutType = null;
            AppState.scoutSeverity = null;

            // Reset all type buttons (old and new)
            document.querySelectorAll('.scout-type-btn, .scout-pill, .severity-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Reset library dropdown
            const librarySelect = document.getElementById('scoutLibrarySelect');
            if (librarySelect) librarySelect.value = '';

            // Reset notes
            document.getElementById('scoutNotes').value = '';

            // Reset photo
            AppState.capturedPhoto = null;
            document.getElementById('scoutPhotoPreview').style.display = 'none';

            // Reset GPS fields
            const latField = document.getElementById('scoutGpsLat');
            const lngField = document.getElementById('scoutGpsLng');
            if (latField) latField.value = '';
            if (lngField) lngField.value = '';

            // Re-capture GPS for next report
            initScoutGPS();

            // Refresh pest map after submission
            refreshPestMap();
        }

        // ============================================
        // PEST/SCOUTING MAP
        // ============================================
        let pestMap = null;
        let pestMarkers = [];
        let hotspotCircles = [];
        let pestMapFilter = 'all';
        let scoutingData = [];

        const FARM_CENTER = { lat: 40.7456217, lng: -80.1610431 };

        const OBSERVATION_COLORS = {
            'Pest': '#ef4444',
            'pest': '#ef4444',
            'Disease': '#f59e0b',
            'disease': '#f59e0b',
            'Weed': '#8b5cf6',
            'weed': '#8b5cf6',
            'Beneficial': '#22c55e',
            'beneficial': '#22c55e',
            'Wildlife': '#f4a261',
            'wildlife': '#f4a261',
            'Other': '#3b82f6',
            'other': '#3b82f6'
        };

        const SEVERITY_SCALE = {
            'Critical': 1.5,
            'critical': 1.5,
            'High': 1.2,
            'high': 1.2,
            'Medium': 1.0,
            'medium': 1.0,
            'Low': 0.8,
            'low': 0.8
        };

        function initPestMap() {
            const mapContainer = document.getElementById('pest-map');
            if (!mapContainer || !window.google || !google.maps) {
                // Retry in 1 second if Google Maps not loaded yet
                setTimeout(initPestMap, 1000);
                return;
            }

            pestMap = new google.maps.Map(mapContainer, {
                center: FARM_CENTER,
                zoom: 17,
                mapTypeId: 'hybrid',
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true,
                gestureHandling: 'cooperative'
            });

            // Load scouting data
            refreshPestMap();
        }

        async function refreshPestMap() {
            if (!pestMap && window.google && google.maps) {
                initPestMap();
                return;
            }

            if (!pestMap) return;

            try {
                // Get last 30 days of scouting data
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const params = new URLSearchParams({
                    action: 'getScoutingMapData',
                    startDate: thirtyDaysAgo.toISOString().split('T')[0]
                });

                const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    scoutingData = data.observations || [];
                    renderPestMapMarkers();
                    renderHotspots(data.hotspots || []);
                }
            } catch (error) {
                console.error('Error loading scouting map data:', error);
            }
        }

        function renderPestMapMarkers() {
            // Clear existing markers
            pestMarkers.forEach(m => m.setMap(null));
            pestMarkers = [];

            // Filter data based on current filter
            let filtered = scoutingData;
            if (pestMapFilter !== 'all') {
                filtered = scoutingData.filter(o =>
                    o.Observation_Type?.toLowerCase() === pestMapFilter.toLowerCase()
                );
            }

            filtered.forEach(obs => {
                if (!obs.GPS_Lat || !obs.GPS_Lng) return;

                const type = obs.Observation_Type || 'Other';
                const color = OBSERVATION_COLORS[type] || '#3b82f6';
                const scale = SEVERITY_SCALE[obs.Severity] || 1;

                const marker = new google.maps.Marker({
                    position: { lat: Number(obs.GPS_Lat), lng: Number(obs.GPS_Lng) },
                    map: pestMap,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8 * scale,
                        fillColor: color,
                        fillOpacity: 0.9,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    },
                    title: `${type} - ${obs.Severity || 'Unknown'}`
                });

                // Info window on tap
                const infoContent = `
                    <div style="color: #333; min-width: 150px;">
                        <strong>${type}</strong><br>
                        Severity: ${obs.Severity || 'Unknown'}<br>
                        Field: ${obs.Field_ID || 'Unknown'}<br>
                        Date: ${obs.Date ? new Date(obs.Date).toLocaleDateString() : 'Unknown'}<br>
                        ${obs.Notes ? '<em>' + obs.Notes.substring(0, 50) + '...</em>' : ''}
                    </div>
                `;

                marker.addListener('click', () => {
                    const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                    infoWindow.open(pestMap, marker);
                });

                marker.obsType = type.toLowerCase();
                pestMarkers.push(marker);
            });
        }

        function renderHotspots(hotspots) {
            // Clear existing hotspot circles
            hotspotCircles.forEach(c => c.setMap(null));
            hotspotCircles = [];

            hotspots.forEach(hs => {
                if (!hs.center) return;

                const color = OBSERVATION_COLORS[hs.dominantType] || '#ef4444';

                // Pulsing circle for hotspot
                const circle = new google.maps.Circle({
                    center: hs.center,
                    radius: 15, // meters
                    strokeColor: color,
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    fillColor: color,
                    fillOpacity: 0.3,
                    map: pestMap
                });

                // Info on click
                circle.addListener('click', () => {
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="color: #333;">
                                <strong>Hotspot: ${hs.count} observations</strong><br>
                                Primary: ${hs.dominantType}<br>
                                Severity: ${hs.highestSeverity}
                            </div>
                        `,
                        position: hs.center
                    });
                    infoWindow.open(pestMap);
                });

                hotspotCircles.push(circle);
            });
        }

        function togglePestMapFilter(filter) {
            pestMapFilter = filter;

            // Update button states
            document.querySelectorAll('.map-filter-chip').forEach(btn => {
                const btnFilter = btn.onclick.toString().match(/togglePestMapFilter\('(\w+)'\)/)?.[1];
                btn.classList.toggle('active', btnFilter === filter);
            });

            renderPestMapMarkers();
        }

        // Initialize pest map when switching to scout tab
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            if (tabName === 'scout' && !pestMap) {
                setTimeout(initPestMap, 500);
            }
        };

        // ============================================
        // AI PLANT DOCTOR
        // ============================================
        const AIDoctor = {
            photo: null,
            mode: 'plant', // 'plant' or 'bug'
            lastResult: null
        };

        function openAIDiagnosis() {
            AIDoctor.photo = null;
            AIDoctor.mode = 'plant';
            AIDoctor.lastResult = null;

            // Reset to step 1
            showAIStep(1);

            // Reset mode buttons
            document.getElementById('aiModePlant').classList.add('active');
            document.getElementById('aiModeBug').classList.remove('active');

            // Show modal
            document.getElementById('aiDoctorModal').classList.add('visible');
        }

        function closeAIDoctor() {
            document.getElementById('aiDoctorModal').classList.remove('visible');
        }

        function showAIStep(step) {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`aiStep${i}`).style.display = i === step ? 'block' : 'none';
            }
        }

        function captureAIPhoto() {
            // Use camera for mobile devices
            const input = document.getElementById('aiPhotoInput');
            input.setAttribute('capture', 'environment');
            input.click();
        }

        function selectAIPhoto() {
            // Select from gallery
            const input = document.getElementById('aiPhotoInput');
            input.removeAttribute('capture');
            input.click();
        }

        function handleAIPhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                // Compress the photo
                AIDoctor.photo = await compressPhoto(e.target.result, 800);

                // Show preview
                document.getElementById('aiPhotoPreview').src = AIDoctor.photo;
                showAIStep(2);
            };
            reader.readAsDataURL(file);

            // Reset input for next use
            event.target.value = '';
        }

        function setAIMode(mode) {
            AIDoctor.mode = mode;
            document.getElementById('aiModePlant').classList.toggle('active', mode === 'plant');
            document.getElementById('aiModeBug').classList.toggle('active', mode === 'bug');
        }

        function retakeAIPhoto() {
            AIDoctor.photo = null;
            showAIStep(1);
        }

        async function analyzePhoto() {
            if (!AIDoctor.photo) {
                showToast('Please take a photo first', 'error');
                return;
            }

            // Show analyzing step
            showAIStep(3);

            try {
                const params = new URLSearchParams({
                    action: 'analyzeImage',
                    mode: AIDoctor.mode,
                    image: AIDoctor.photo
                });

                const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    AIDoctor.lastResult = result;
                    displayAIResults(result);
                } else {
                    showToast(result.error || t('common.error'), 'error');
                    showAIStep(2);
                }
            } catch (error) {
                console.error('AI Analysis error:', error);

                // Fallback: show simulated result for demo purposes
                const simulatedResult = getSimulatedResult();
                AIDoctor.lastResult = simulatedResult;
                displayAIResults(simulatedResult);
            }
        }

        function getSimulatedResult() {
            // Simulated results for demo/offline mode
            if (AIDoctor.mode === 'plant') {
                const issues = [
                    {
                        type: 'disease',
                        name: 'Powdery Mildew',
                        confidence: 87,
                        description: 'A fungal disease that appears as white, powdery spots on leaves and stems.',
                        treatment: 'Remove affected leaves, improve air circulation, and apply neem oil or potassium bicarbonate spray. Avoid overhead watering.'
                    },
                    {
                        type: 'pest',
                        name: 'Aphid Infestation',
                        confidence: 92,
                        description: 'Small soft-bodied insects that cluster on new growth and undersides of leaves, sucking plant sap.',
                        treatment: 'Spray with strong water jet to dislodge. Apply insecticidal soap or neem oil. Introduce beneficial insects like ladybugs.'
                    },
                    {
                        type: 'disease',
                        name: 'Early Blight',
                        confidence: 78,
                        description: 'Fungal disease causing dark spots with concentric rings on lower leaves, spreading upward.',
                        treatment: 'Remove and destroy affected leaves. Apply copper-based fungicide. Improve air circulation and avoid wetting foliage.'
                    }
                ];
                return { success: true, ...issues[Math.floor(Math.random() * issues.length)] };
            } else {
                const bugs = [
                    {
                        type: 'beneficial',
                        name: 'Ladybug (Coccinellidae)',
                        confidence: 95,
                        description: 'Beneficial predator that consumes aphids, scale insects, and mites. A single ladybug can eat up to 5,000 aphids in its lifetime.',
                        isBeneficial: true,
                        benefitInfo: 'Keep these in your garden! They are excellent natural pest control.'
                    },
                    {
                        type: 'pest',
                        name: 'Colorado Potato Beetle',
                        confidence: 89,
                        description: 'Major pest of potatoes and tomatoes. Both adults and larvae feed on foliage and can defoliate plants.',
                        treatment: 'Hand-pick adults and larvae. Use Bacillus thuringiensis var. tenebrionis (Btt) or spinosad for organic control.'
                    },
                    {
                        type: 'beneficial',
                        name: 'Green Lacewing',
                        confidence: 91,
                        description: 'Predatory insect whose larvae voraciously consume aphids, mealybugs, thrips, and other soft-bodied pests.',
                        isBeneficial: true,
                        benefitInfo: 'Lacewing larvae are called "aphid lions" - encourage them by planting dill, fennel, and yarrow.'
                    },
                    {
                        type: 'pest',
                        name: 'Cucumber Beetle',
                        confidence: 85,
                        description: 'Feeds on cucurbits and can transmit bacterial wilt. Yellow-green with black spots or stripes.',
                        treatment: 'Use row covers early in season. Apply kaolin clay or spinosad. Trap crop with Blue Hubbard squash.'
                    }
                ];
                return { success: true, ...bugs[Math.floor(Math.random() * bugs.length)] };
            }
        }

        function displayAIResults(result) {
            const header = document.getElementById('aiResultHeader');
            const icon = document.getElementById('aiResultIcon');
            const title = document.getElementById('aiResultTitle');
            const confidence = document.getElementById('aiConfidence');
            const identification = document.getElementById('aiIdentification');
            const description = document.getElementById('aiDescription');
            const treatment = document.getElementById('aiTreatment');
            const beneficialCard = document.getElementById('aiBeneficialCard');
            const treatmentCard = document.getElementById('aiTreatmentCard');
            const beneficialInfo = document.getElementById('aiBeneficialInfo');

            // Set header style based on type
            header.className = `ai-result-header ${result.type}`;

            // Set icon
            const icons = {
                disease: 'fa-virus',
                pest: 'fa-bug',
                healthy: 'fa-check-circle',
                beneficial: 'fa-thumbs-up'
            };
            icon.innerHTML = `<i class="fas ${icons[result.type] || 'fa-question'}"></i>`;

            // Set content
            title.textContent = result.name || 'Unknown';
            confidence.textContent = `${result.confidence || 0}% ${t('ai.confident')}`;
            identification.textContent = result.name || 'Could not identify';
            description.textContent = result.description || 'No description available.';

            // Handle beneficial vs pest/disease
            if (result.isBeneficial) {
                beneficialCard.style.display = 'block';
                treatmentCard.style.display = 'none';
                beneficialInfo.textContent = result.benefitInfo || 'This insect is beneficial for your garden.';
            } else {
                beneficialCard.style.display = 'none';
                treatmentCard.style.display = 'block';
                treatment.textContent = result.treatment || 'Consult with a specialist for treatment options.';
            }

            showAIStep(4);
        }

        function newAIAnalysis() {
            AIDoctor.photo = null;
            AIDoctor.lastResult = null;
            showAIStep(1);
        }

        function createScoutFromAI() {
            if (!AIDoctor.lastResult) {
                showToast('No diagnosis to report', 'error');
                return;
            }

            // Close AI modal
            closeAIDoctor();

            // Pre-fill scout form with AI results
            const result = AIDoctor.lastResult;

            // Set scout type based on AI result
            if (result.type === 'pest' || result.type === 'beneficial') {
                setScoutType(result.isBeneficial ? 'beneficial' : 'pest');
            } else if (result.type === 'disease') {
                setScoutType('disease');
            }

            // Set severity based on confidence
            if (result.confidence >= 90) {
                setSeverity('high');
            } else if (result.confidence >= 70) {
                setSeverity('medium');
            } else {
                setSeverity('low');
            }

            // Set notes with AI diagnosis
            const notes = `AI Diagnosis: ${result.name}\n${result.description}\n\nRecommended: ${result.treatment || result.benefitInfo || 'N/A'}`;
            document.getElementById('scoutNotes').value = notes;

            // Set photo
            if (AIDoctor.photo) {
                AppState.capturedPhoto = AIDoctor.photo;
                const preview = document.getElementById('scoutPhotoPreview');
                preview.innerHTML = `<img src="${AIDoctor.photo}" alt="Scout photo">`;
                preview.style.display = 'block';
            }

            showToast(t('ai.reportCreated'), 'success');
        }

        // Photo compression utility
        async function compressPhoto(dataUrl, maxWidth = 1200) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = dataUrl;
            });
        }

        // ============================================
        // TASKS V2 - WITH COSTING MODE & TIME TRACKING
        // Production-ready labor cost tracking system
        // ============================================

        // Task Timer State
        const TaskTimer = {
            activeTaskId: null,
            startTime: null,
            elapsedSeconds: 0,
            intervalId: null,
            isPaused: false,
            taskViewTimes: {} // Track when each task card was first viewed
        };

        // Benchmark data (hours per task type - from UC Davis/Extension research)
        const TASK_BENCHMARKS = {
            'sow': 20,        // 20 min default for seeding
            'seeding': 20,
            'transplant': 30, // 30 min for transplanting
            'harvest': 45,    // 45 min for harvest
            'weed': 40,       // 40 min for weeding
            'scout': 15,      // 15 min for scouting
            'irrigate': 20,   // 20 min for irrigation
            'pack': 30,       // 30 min for packing
            'deliver': 25,    // 25 min for delivery
            'default': 30     // 30 min default
        };

        // Task type icons
        const TASK_ICONS = {
            'sow': '',
            'seeding': '',
            'transplant': '',
            'harvest': '',
            'weed': '',
            'scout': '',
            'irrigate': '',
            'pack': '',
            'deliver': '',
            'default': ''
        };

        function filterTasks(filter) {
            document.querySelectorAll('.task-filter').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(filter) ||
                    (filter === 'all' && btn.textContent.toLowerCase().includes('all')));
            });
            renderTasks(filter);
        }

        function renderTasks(filter = 'all') {
            const container = document.getElementById('tasksContainer');
            const tasks = AppState.tasks;

            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>${t('tasks.noTasks')}</h3>
                        <p>All caught up! Great work.</p>
                    </div>
                `;
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            let filteredTasks = tasks;

            if (filter === 'today') {
                filteredTasks = tasks.filter(t => t.date === today);
            } else if (filter === 'overdue') {
                filteredTasks = tasks.filter(t => t.date < today && t.status !== 'Completed');
            }

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <h3>No ${filter} tasks</h3>
                        <p>You're all caught up!</p>
                    </div>
                `;
                return;
            }

            // Render new v2 task cards
            container.innerHTML = filteredTasks.map(task => {
                const isOverdue = task.date < today;
                const isToday = task.date === today;
                const taskType = (task.type || 'default').toLowerCase();
                const icon = TASK_ICONS[taskType] || TASK_ICONS.default;
                const benchmark = task.benchmarkMin || TASK_BENCHMARKS[taskType] || TASK_BENCHMARKS.default;
                const hasCosting = task.costingMode || task.Costing_Mode || false;
                const isTimerActive = TaskTimer.activeTaskId === task.id;
                const priorityClass = isOverdue ? 'overdue' : (isToday ? 'today' : 'upcoming');
                const priorityText = isOverdue ? `OVERDUE ${getDaysOverdue(task.date)} DAYS` : (isToday ? 'TODAY' : formatDate(task.date));

                // Record view time for auto-timing
                if (!TaskTimer.taskViewTimes[task.id]) {
                    TaskTimer.taskViewTimes[task.id] = Date.now();
                }

                return `
                <div class="task-card-v2 ${priorityClass} ${hasCosting ? 'costing-enabled' : ''} ${isTimerActive ? 'timer-active' : ''}"
                     data-id="${task.id}" data-type="${taskType}" data-benchmark="${benchmark}">

                    <!-- Priority Bar -->
                    <div class="task-priority-bar ${priorityClass}">
                        <i class="fas ${isOverdue ? 'fa-exclamation-circle' : (isToday ? 'fa-clock' : 'fa-calendar-check')}"></i>
                        <span>${priorityText}</span>
                        ${hasCosting ? '<span class="costing-badge"><i class="fas fa-dollar-sign"></i> COST TRACKED</span>' : ''}
                    </div>

                    <!-- Task Header -->
                    <div class="task-header-v2">
                        <div class="task-icon-v2 ${taskType}">${icon}</div>
                        <div class="task-content-v2">
                            <div class="task-type-v2">${task.type || 'Task'}</div>
                            <h3 class="task-title-v2">${task.crop}${task.variety ? ' - ' + task.variety : ''}</h3>
                            <div class="task-details-v2">
                                <span><i class="fas fa-map-marker-alt"></i> ${task.bed || task.field || 'TBD'}</span>
                                ${task.quantity ? `<span><i class="fas fa-seedling"></i> ${task.quantity}</span>` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Benchmark Hint -->
                    ${hasCosting ? `
                    <div class="task-benchmark">
                        <i class="fas fa-stopwatch"></i>
                        <span>Benchmark: ~${benchmark} min</span>
                    </div>
                    ` : ''}

                    <!-- Team Task Badge -->
                    ${task.isTeamTask ? `
                    <div class="team-task-badge">
                        <i class="fas fa-users"></i>
                        <span>Team Task - One person completes for everyone</span>
                    </div>
                    ` : ''}

                    <!-- Subtasks (tray by tray for seeding) -->
                    ${task.subtasksTotal > 0 ? `
                    <div class="subtasks-section">
                        <div class="subtasks-header">
                            <span><i class="fas fa-list-check"></i> Progress: ${task.subtasksCompleted}/${task.subtasksTotal}</span>
                            <div class="subtasks-progress-bar">
                                <div class="subtasks-progress-fill" style="width: ${(task.subtasksCompleted / task.subtasksTotal) * 100}%"></div>
                            </div>
                        </div>
                        <div class="subtasks-list">
                            ${task.subtasks.map((sub, idx) => `
                                <button class="subtask-item ${sub.completed ? 'completed' : ''}"
                                        onclick="completeSubtask('${task.id}', ${idx})"
                                        ${sub.completed ? 'disabled' : ''}>
                                    <i class="fas ${sub.completed ? 'fa-check-circle' : 'fa-circle'}"></i>
                                    <span>${sub.name}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Timer Display (hidden until started) -->
                    <div class="task-timer-display ${isTimerActive ? 'active' : ''}" id="timerDisplay-${task.id}">
                        <div class="timer-pulse"></div>
                        <div>
                            <div class="timer-clock" id="timerClock-${task.id}">00:00:00</div>
                            <div class="timer-label">Time Elapsed</div>
                        </div>
                    </div>

                    <!-- Timer Controls (hidden until timer started) -->
                    <div class="timer-controls ${isTimerActive ? 'active' : ''}" id="timerControls-${task.id}">
                        <button class="timer-btn pause" onclick="togglePauseTimer('${task.id}')">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="timer-btn cancel" onclick="cancelTimer('${task.id}')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>

                    <!-- Start Timer Button (only for costing mode) -->
                    ${hasCosting && !isTimerActive ? `
                    <button class="start-timer-btn" onclick="startTaskTimer('${task.id}')" id="startTimerBtn-${task.id}">
                        <i class="fas fa-play-circle"></i> Start Timer (Optional)
                    </button>
                    ` : ''}

                    <!-- BIG DONE BUTTON - 72px -->
                    <button class="task-done-btn ${isTimerActive ? 'with-timer' : ''}" onclick="completeTaskV2('${task.id}')">
                        <i class="fas fa-check"></i>
                        ${isTimerActive ? 'DONE - STOP TIMER' : 'DONE'}
                    </button>
                </div>
                `;
            }).join('');

            // Update counts
            document.getElementById('taskCountAll').textContent = tasks.length;
            document.getElementById('taskCountToday').textContent = tasks.filter(t => t.date === today).length;
            document.getElementById('taskCountOverdue').textContent = tasks.filter(t => t.date < today && t.status !== 'Completed').length;

            // Update any active timer display
            if (TaskTimer.activeTaskId && TaskTimer.intervalId) {
                updateTimerDisplay(TaskTimer.activeTaskId);
            }
        }

        // Get days overdue
        function getDaysOverdue(dateStr) {
            const taskDate = new Date(dateStr);
            const today = new Date();
            const diffTime = today - taskDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Format date nicely
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Start task timer
        function startTaskTimer(taskId) {
            // Stop any existing timer
            if (TaskTimer.intervalId) {
                clearInterval(TaskTimer.intervalId);
            }

            TaskTimer.activeTaskId = taskId;
            TaskTimer.startTime = Date.now();
            TaskTimer.elapsedSeconds = 0;
            TaskTimer.isPaused = false;

            // Hide start button, show timer display and controls
            const startBtn = document.getElementById(`startTimerBtn-${taskId}`);
            const timerDisplay = document.getElementById(`timerDisplay-${taskId}`);
            const timerControls = document.getElementById(`timerControls-${taskId}`);
            const taskCard = document.querySelector(`.task-card-v2[data-id="${taskId}"]`);

            if (startBtn) startBtn.classList.add('hidden');
            if (timerDisplay) timerDisplay.classList.add('active');
            if (timerControls) timerControls.classList.add('active');
            if (taskCard) taskCard.classList.add('timer-active');

            // Update done button
            const doneBtn = taskCard?.querySelector('.task-done-btn');
            if (doneBtn) {
                doneBtn.classList.add('with-timer');
                doneBtn.innerHTML = '<i class="fas fa-check"></i> DONE - STOP TIMER';
            }

            // Start interval
            TaskTimer.intervalId = setInterval(() => {
                if (!TaskTimer.isPaused) {
                    TaskTimer.elapsedSeconds = Math.floor((Date.now() - TaskTimer.startTime) / 1000);
                    updateTimerDisplay(taskId);
                }
            }, 1000);

            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(50);
        }

        // Update timer display
        function updateTimerDisplay(taskId) {
            const clock = document.getElementById(`timerClock-${taskId}`);
            if (clock) {
                const hours = Math.floor(TaskTimer.elapsedSeconds / 3600);
                const minutes = Math.floor((TaskTimer.elapsedSeconds % 3600) / 60);
                const seconds = TaskTimer.elapsedSeconds % 60;
                clock.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Toggle pause timer
        function togglePauseTimer(taskId) {
            TaskTimer.isPaused = !TaskTimer.isPaused;
            const pauseBtn = document.querySelector(`#timerControls-${taskId} .pause`);
            if (pauseBtn) {
                pauseBtn.innerHTML = TaskTimer.isPaused
                    ? '<i class="fas fa-play"></i> Resume'
                    : '<i class="fas fa-pause"></i> Pause';
            }
        }

        // Cancel timer
        function cancelTimer(taskId) {
            if (TaskTimer.intervalId) {
                clearInterval(TaskTimer.intervalId);
                TaskTimer.intervalId = null;
            }
            TaskTimer.activeTaskId = null;
            TaskTimer.elapsedSeconds = 0;
            TaskTimer.isPaused = false;

            // Re-render to reset UI
            renderTasks(AppState.currentTaskFilter || 'all');
        }

        // Complete task v2 with time logging
        async function completeTaskV2(taskId) {
            const task = AppState.tasks.find(t => t.id === taskId);
            if (!task) return;

            // Calculate time
            let durationMinutes;
            let usedTimer = false;

            if (TaskTimer.activeTaskId === taskId && TaskTimer.startTime) {
                // Used manual timer
                durationMinutes = Math.round(TaskTimer.elapsedSeconds / 60);
                usedTimer = true;

                // Stop timer
                if (TaskTimer.intervalId) {
                    clearInterval(TaskTimer.intervalId);
                    TaskTimer.intervalId = null;
                }
            } else {
                // Auto-calculate from view time
                const viewTime = TaskTimer.taskViewTimes[taskId];
                if (viewTime) {
                    durationMinutes = Math.round((Date.now() - viewTime) / 60000);
                } else {
                    // Default based on benchmark
                    const taskType = (task.type || 'default').toLowerCase();
                    durationMinutes = TASK_BENCHMARKS[taskType] || TASK_BENCHMARKS.default;
                }
            }

            // Cap at reasonable values (min 1 min, max 480 min / 8 hours)
            durationMinutes = Math.max(1, Math.min(480, durationMinutes));

            // Get benchmark for efficiency calculation
            const taskType = (task.type || 'default').toLowerCase();
            const benchmarkMinutes = task.benchmarkMin || TASK_BENCHMARKS[taskType] || TASK_BENCHMARKS.default;
            const efficiency = Math.round((benchmarkMinutes / durationMinutes) * 100);

            // Animate card completion
            const taskCard = document.querySelector(`.task-card-v2[data-id="${taskId}"]`);
            if (taskCard) {
                taskCard.classList.add('completing');
            }

            // Show completion overlay with stats
            showCompletionOverlay({
                taskId,
                task,
                durationMinutes,
                benchmarkMinutes,
                efficiency,
                usedTimer
            });

            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate([50, 50, 100]);

            try {
                const gps = await captureGPS();

                const taskData = {
                    taskId: taskId,
                    employeeId: AppState.employee?.Employee_ID || '',
                    lat: gps.lat || '',
                    lng: gps.lng || '',
                    // Time logging data
                    durationMinutes: durationMinutes,
                    benchmarkMinutes: benchmarkMinutes,
                    efficiency: efficiency,
                    usedTimer: usedTimer,
                    taskType: taskType,
                    batchId: task.batchId || task.Batch_ID || '',
                    costingMode: task.costingMode || task.Costing_Mode || false
                };

                if (AppState.isOnline) {
                    // Online: submit with time logging
                    const params = new URLSearchParams({
                        action: 'completeTaskWithTimeLog',
                        ...taskData
                    });

                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();

                    if (!data.success) {
                        console.error('Task completion error:', data.error);
                    }
                } else {
                    // Offline: queue for later sync
                    await OfflineDB.queueOperation('completeTaskWithTimeLog', taskData);
                }

                // Remove from local state
                AppState.tasks = AppState.tasks.filter(t => t.id !== taskId);
                AppState.lastCompletedTask = { taskId, task, taskData };

                // Update cache
                await OfflineDB.cacheTasks(AppState.tasks);

                // TASK CHAIN: Generate next task in seed-to-sale sequence
                const chainType = (task.taskType || task.type || taskType || '').toLowerCase();
                const chain = TASK_CHAIN[chainType];
                const batchId = task.batchId || task.Batch_ID || '';
                if (chain && chain.next && batchId) {
                    await generateChainTask(batchId, chain.next, chain.label);
                    console.log(`[TaskChain] ${chainType}  ${chain.next} for batch ${batchId}`);
                }

                // Clean up timer state
                TaskTimer.activeTaskId = null;
                TaskTimer.elapsedSeconds = 0;
                delete TaskTimer.taskViewTimes[taskId];

            } catch (error) {
                console.error('Complete task error:', error);
                // Still update UI even if API call fails
                AppState.tasks = AppState.tasks.filter(t => t.id !== taskId);
            }

            // For team/shared tasks, also call completeSharedTask to mark for everyone
            // and create follow-up tasks (like log_harvest after harvest)
            if (task.isTeamTask || task.createsFollowUp) {
                try {
                    const response = await fetch(`${CONFIG.API_URL}?action=completeSharedTask`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            taskId: taskId,
                            employeeId: AppState.employee?.Employee_ID || '',
                            notes: ''
                        })
                    });

                    const result = await response.json();

                    // If there's a follow-up task, show notification
                    if (result.followUpTask) {
                        showToast(`Next: ${result.followUpTask.type === 'log_harvest' ? 'Log & QR code' : 'Follow-up'} - ${result.followUpTask.crop}`, 'info');
                        // Reload tasks to show the new follow-up task
                        setTimeout(() => loadInitialData(), 1500);
                    }
                } catch (e) {
                    console.log('Shared task completion note:', e);
                }
            }
        }

        // Complete a subtask (one tray, one variety, etc.)
        async function completeSubtask(taskId, subtaskIndex) {
            const task = AppState.tasks.find(t => t.id === taskId);
            if (!task || !task.subtasks || !task.subtasks[subtaskIndex]) return;

            // Optimistic UI update
            const subtaskBtn = document.querySelector(`.task-card-v2[data-id="${taskId}"] .subtask-item:nth-child(${subtaskIndex + 1})`);
            if (subtaskBtn) {
                subtaskBtn.classList.add('completed');
                subtaskBtn.disabled = true;
                subtaskBtn.innerHTML = `<i class="fas fa-check-circle"></i><span>${task.subtasks[subtaskIndex].name}</span>`;
            }

            // Update progress bar
            task.subtasks[subtaskIndex].completed = true;
            task.subtasksCompleted = (task.subtasksCompleted || 0) + 1;

            const progressFill = document.querySelector(`.task-card-v2[data-id="${taskId}"] .subtasks-progress-fill`);
            const progressText = document.querySelector(`.task-card-v2[data-id="${taskId}"] .subtasks-header span`);
            if (progressFill) {
                progressFill.style.width = `${(task.subtasksCompleted / task.subtasksTotal) * 100}%`;
            }
            if (progressText) {
                progressText.innerHTML = `<i class="fas fa-list-check"></i> Progress: ${task.subtasksCompleted}/${task.subtasksTotal}`;
            }

            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(30);

            try {
                const response = await fetch(`${CONFIG.API_URL}?action=completeSubtask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        taskId: taskId,
                        subtaskIndex: subtaskIndex,
                        employeeId: AppState.employee?.Employee_ID || ''
                    })
                });

                const result = await response.json();

                if (result.taskComplete) {
                    // All subtasks done - show completion
                    showToast(`All ${task.subtasksTotal} items complete!`, 'success');

                    // Remove task from list after delay
                    setTimeout(() => {
                        AppState.tasks = AppState.tasks.filter(t => t.id !== taskId);
                        renderTasks();
                    }, 1000);
                } else {
                    showToast(`${result.completed}/${result.total} done`, 'success');
                }
            } catch (error) {
                console.error('Subtask completion error:', error);
            }
        }

        // Show completion overlay
        function showCompletionOverlay(data) {
            const overlay = document.getElementById('completionOverlay');
            const timeEl = document.getElementById('completionTime');
            const benchmarkEl = document.getElementById('completionBenchmark');
            const efficiencyEl = document.getElementById('completionEfficiency');
            const employeeEl = document.getElementById('completionEmployee');

            // Format time
            const hours = Math.floor(data.durationMinutes / 60);
            const minutes = data.durationMinutes % 60;
            const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes} min`;

            timeEl.textContent = timeStr;
            benchmarkEl.textContent = `${data.benchmarkMinutes} min`;

            // Set efficiency with color
            efficiencyEl.textContent = `${data.efficiency}%`;
            efficiencyEl.classList.remove('warning');
            if (data.efficiency < 80) {
                efficiencyEl.classList.add('warning');
            }

            // Employee name
            const empName = AppState.employee?.Name || AppState.employee?.First_Name || 'You';
            employeeEl.textContent = empName;

            // Show overlay
            overlay.classList.add('visible');

            // Start undo countdown
            startUndoCountdown();
        }

        // Close completion overlay
        function closeCompletionOverlay() {
            const overlay = document.getElementById('completionOverlay');
            overlay.classList.remove('visible');

            // Clear any pending undo
            if (AppState.undoTimeout) {
                clearTimeout(AppState.undoTimeout);
                AppState.undoTimeout = null;
            }

            // Re-render tasks
            renderTasks(AppState.currentTaskFilter || 'all');
        }

        // Undo countdown
        function startUndoCountdown() {
            let secondsLeft = 5;
            const undoBtn = document.getElementById('completionUndo');

            const updateBtn = () => {
                undoBtn.innerHTML = `<i class="fas fa-undo"></i> Undo (${secondsLeft}s)`;
            };
            updateBtn();

            const countdownInterval = setInterval(() => {
                secondsLeft--;
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    undoBtn.style.opacity = '0.5';
                    undoBtn.innerHTML = '<i class="fas fa-undo"></i> Too late';
                    undoBtn.disabled = true;
                } else {
                    updateBtn();
                }
            }, 1000);

            AppState.undoCountdownInterval = countdownInterval;

            // Auto-close after 5 seconds
            AppState.undoTimeout = setTimeout(() => {
                closeCompletionOverlay();
            }, 5000);
        }

        // Undo task completion
        async function undoTaskCompletion() {
            if (!AppState.lastCompletedTask) return;

            const { taskId, task, taskData } = AppState.lastCompletedTask;

            // Clear countdown
            if (AppState.undoCountdownInterval) {
                clearInterval(AppState.undoCountdownInterval);
            }
            if (AppState.undoTimeout) {
                clearTimeout(AppState.undoTimeout);
            }

            // Add task back to local state
            AppState.tasks.push(task);

            // Close overlay and re-render
            closeCompletionOverlay();

            // Try to undo on server
            if (AppState.isOnline) {
                try {
                    const params = new URLSearchParams({
                        action: 'undoTaskCompletion',
                        taskId: taskId
                    });
                    await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                } catch (error) {
                    console.error('Undo error:', error);
                }
            }

            // Update cache
            await OfflineDB.cacheTasks(AppState.tasks);

            showToast('Task restored', 'success');
            AppState.lastCompletedTask = null;
        }

        // Legacy completeTask function (redirect to v2)
        async function completeTask(taskId) {
            await completeTaskV2(taskId);
        }

        // ============================================
        // CAMERA
        // ============================================
        let cameraStream = null;

        function capturePhoto(target) {
            AppState.currentPhotoTarget = target;
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');

            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            })
            .then(stream => {
                cameraStream = stream;
                video.srcObject = stream;
                modal.classList.add('visible');
                document.getElementById('cameraControls').style.display = 'flex';
                document.getElementById('confirmControls').style.display = 'none';
            })
            .catch(err => {
                console.error('Camera error:', err);
                showToast('Camera not available', 'error');
            });
        }

        function captureImage() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            document.getElementById('capturedImage').src = imageData;
            document.getElementById('capturedImage').style.display = 'block';
            video.style.display = 'none';

            document.getElementById('cameraControls').style.display = 'none';
            document.getElementById('confirmControls').style.display = 'flex';

            AppState.capturedPhoto = imageData;
        }

        function retakePhoto() {
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('cameraVideo').style.display = 'block';
            document.getElementById('cameraControls').style.display = 'flex';
            document.getElementById('confirmControls').style.display = 'none';
        }

        function confirmPhoto() {
            const previewId = AppState.currentPhotoTarget === 'harvest' ? 'harvestPhotoPreview' : 'scoutPhotoPreview';
            const preview = document.getElementById(previewId);

            preview.innerHTML = `
                <img src="${AppState.capturedPhoto}" alt="Captured">
                <button class="photo-remove" onclick="removePhoto('${AppState.currentPhotoTarget}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            preview.style.display = 'block';

            closeCamera();
        }

        function removePhoto(target) {
            AppState.capturedPhoto = null;
            const previewId = target === 'harvest' ? 'harvestPhotoPreview' : 'scoutPhotoPreview';
            document.getElementById(previewId).style.display = 'none';
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            modal.classList.remove('visible');

            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            document.getElementById('cameraVideo').style.display = 'block';
            document.getElementById('capturedImage').style.display = 'none';
        }

        // ============================================
        // VOICE INPUT
        // ============================================
        let recognition = null;

        function startVoice(targetId) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('Voice input not supported', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = AppState.language === 'es' ? 'es-ES' : 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            const btn = event.currentTarget;
            btn.classList.add('recording');

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById(targetId).value += transcript + ' ';
                btn.classList.remove('recording');
            };

            recognition.onerror = (event) => {
                console.error('Voice error:', event.error);
                btn.classList.remove('recording');
            };

            recognition.onend = () => {
                btn.classList.remove('recording');
            };

            recognition.start();
        }

        // ============================================
        // DATA LOADING (with offline support)
        // ============================================
        async function loadInitialData() {
            if (AppState.isOnline) {
                // Online: fetch from API and cache
                try {
                    // Load tasks
                    const tasksResponse = await fetch(`${CONFIG.API_URL}?action=getEmployeeTasks&employeeId=${AppState.employee?.Employee_ID || ''}`);
                    const tasksData = await tasksResponse.json();
                    if (tasksData.success) {
                        AppState.tasks = tasksData.tasks || [];
                        // Cache tasks for offline use
                        await OfflineDB.cacheTasks(AppState.tasks);
                        renderTasks();
                    }

                    // Load plantings for harvest dropdown
                    const plantingsResponse = await fetch(`${CONFIG.API_URL}?action=getPlanningData`);
                    const plantingsData = await plantingsResponse.json();
                    if (plantingsData.success) {
                        AppState.plantings = plantingsData.data || [];
                        // Cache plantings for offline use
                        await OfflineDB.cachePlantings(AppState.plantings);
                        populateHarvestDropdown();
                    }

                    // Load fields for scouting
                    const fieldsResponse = await fetch(`${CONFIG.API_URL}?action=getFields`);
                    const fieldsData = await fieldsResponse.json();
                    if (fieldsData.success) {
                        // Cache fields for offline use
                        await OfflineDB.cacheReferenceData('fields', fieldsData.fields || []);
                        populateFieldDropdown(fieldsData.fields || []);
                    }

                    loadRecentHarvests();

                } catch (error) {
                    console.error('Data load error, falling back to cache:', error);
                    await loadFromCache();
                }
            } else {
                // Offline: load from cache
                await loadFromCache();
            }
        }

        async function loadFromCache() {
            try {
                // Load cached tasks
                const cachedTasks = await OfflineDB.getCachedTasks();
                if (cachedTasks && cachedTasks.length > 0) {
                    AppState.tasks = cachedTasks;
                    renderTasks();
                    console.log(`Loaded ${cachedTasks.length} tasks from cache`);
                }

                // Load cached plantings
                const cachedPlantings = await OfflineDB.getCachedPlantings();
                if (cachedPlantings && cachedPlantings.length > 0) {
                    AppState.plantings = cachedPlantings;
                    populateHarvestDropdown();
                    console.log(`Loaded ${cachedPlantings.length} plantings from cache`);
                }

                // Load cached fields
                const cachedFields = await OfflineDB.getCachedReferenceData('fields');
                if (cachedFields && cachedFields.length > 0) {
                    populateFieldDropdown(cachedFields);
                    console.log(`Loaded ${cachedFields.length} fields from cache`);
                }

                showToast(t('common.offline'), 'warning');
            } catch (error) {
                console.error('Cache load error:', error);
            }
        }

        function populateHarvestDropdown() {
            const select = document.getElementById('harvestCrop');
            const activeStatuses = ['PLANTED', 'HARVESTING', 'In Field'];

            const harvestable = AppState.plantings.filter(p =>
                activeStatuses.includes(p.STATUS) ||
                (p.Plan_Transplant && new Date(p.Plan_Transplant) <= new Date())
            );

            // Get unique crops
            const crops = [...new Set(harvestable.map(p => `${p.Crop} - ${p.Variety}`))].sort();

            select.innerHTML = '<option value="">Select crop...</option>' +
                crops.map(crop => `<option value="${crop}">${crop}</option>`).join('');
        }

        function populateFieldDropdown(fields) {
            const select = document.getElementById('scoutField');
            select.innerHTML = '<option value="">Select...</option>' +
                fields.map(f => `<option value="${f.Field_ID || f}">${f.Field_Name || f.Field_ID || f}</option>`).join('');
        }

        async function loadRecentHarvests() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getHarvests&limit=5`);
                const data = await response.json();

                if (data.success && data.harvests) {
                    const list = document.getElementById('recentHarvestsList');
                    list.innerHTML = data.harvests.map(h => `
                        <div class="harvest-item">
                            <div class="harvest-info">
                                <h4>${h.Crop}</h4>
                                <span>${h.Bed_ID || 'N/A'}</span>
                            </div>
                            <div class="harvest-qty">
                                <div class="amount">${h.Quantity} ${h.Unit}</div>
                                <div class="time">${formatTime(h.Timestamp)}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Load harvests error:', error);
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString(AppState.language === 'es' ? 'es-ES' : 'en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ============================================
        // MORE TAB ACTIONS (Placeholders)
        // ============================================
        function openTreatmentLog() {
            showToast('Treatment log coming soon!', 'info');
        }

        function openHazards() {
            showToast('Hazards reporting coming soon!', 'info');
        }

        function openWeedLog() {
            showToast('Weed pressure log coming soon!', 'info');
        }

        function openCultivation() {
            showToast('Cultivation log coming soon!', 'info');
        }

        function openSettings() {
            showToast('Settings coming soon!', 'info');
        }

        // ============================================
        // WILDLIFE TRACKER
        // ============================================
        const WildlifeState = {
            animalType: null,
            denSize: null,
            denActivity: null,
            damageSeverity: null,
            currentPhoto: null
        };

        function openWildlife() {
            document.getElementById('wildlifeModal').classList.add('visible');
            populateWildlifeFields();
            loadActiveDens();
        }

        function closeWildlifeModal() {
            document.getElementById('wildlifeModal').classList.remove('visible');
            resetWildlifeState();
        }

        function switchWildlifeTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.wildlife-tab').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Show/hide panels
            document.getElementById('wildlifeSightingForm').style.display = tab === 'sighting' ? 'block' : 'none';
            document.getElementById('wildlifeDenForm').style.display = tab === 'den' ? 'block' : 'none';
            document.getElementById('wildlifeDamageForm').style.display = tab === 'damage' ? 'block' : 'none';
            document.getElementById('wildlifeMapPanel').style.display = tab === 'map' ? 'block' : 'none';

            if (tab === 'map') {
                loadWildlifeSummary();
            }
            if (tab === 'den') {
                loadActiveDens();
            }
        }

        function populateWildlifeFields() {
            const fieldSelects = ['wildlifeField', 'denField', 'damageField'];
            fieldSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select && AppState.fields) {
                    select.innerHTML = '<option value="">Select field...</option>';
                    AppState.fields.forEach(f => {
                        select.innerHTML += `<option value="${f}">${f}</option>`;
                    });
                }
            });
        }

        function setAnimalType(type) {
            WildlifeState.animalType = type;
            document.querySelectorAll('.animal-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${type}'`));
            });
        }

        function setDenSize(size) {
            WildlifeState.denSize = size;
            document.querySelectorAll('.den-size-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${size}'`));
            });
        }

        function setDenActivity(level) {
            WildlifeState.denActivity = level;
            document.querySelectorAll('.activity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${level}'`));
            });
        }

        function setDamageSeverity(severity) {
            WildlifeState.damageSeverity = severity;
            document.querySelectorAll('#wildlifeDamageForm .severity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(severity));
            });
        }

        function openCameraForWildlife() {
            AppState.currentPhotoTarget = 'wildlife';
            openCamera('wildlife');
        }

        function openCameraForDen() {
            AppState.currentPhotoTarget = 'den';
            openCamera('den');
        }

        function openCameraForDamage() {
            AppState.currentPhotoTarget = 'damage';
            openCamera('damage');
        }

        async function submitWildlifeSighting() {
            if (!WildlifeState.animalType) {
                showToast('Please select an animal type', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();
                const sightingData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    animalType: WildlifeState.animalType,
                    count: document.getElementById('wildlifeCount').value || 1,
                    field: document.getElementById('wildlifeField').value,
                    activity: document.getElementById('wildlifeActivity').value,
                    photo: WildlifeState.currentPhoto || '',
                    notes: document.getElementById('wildlifeNotes').value,
                    lat: gps.lat || '',
                    lng: gps.lng || ''
                };

                if (AppState.isOnline) {
                    const params = new URLSearchParams({ action: 'logWildlifeSighting', ...sightingData });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        showToast('Sighting logged!', 'success');
                        resetWildlifeState();
                    } else {
                        showToast(data.error || 'Error logging sighting', 'error');
                    }
                } else {
                    await OfflineDB.queueOperation('logWildlifeSighting', sightingData);
                    showToast('Sighting saved offline', 'success');
                    resetWildlifeState();
                }
            } catch (error) {
                console.error('Wildlife sighting error:', error);
                showToast('Error logging sighting', 'error');
            }
            hideLoading();
        }

        async function submitGroundhogDen() {
            const field = document.getElementById('denField').value;
            if (!field) {
                showToast('Please select a field', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();
                const denData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    field: field,
                    denSize: WildlifeState.denSize || 'medium',
                    activityLevel: WildlifeState.denActivity || 'medium',
                    photo: WildlifeState.currentPhoto || '',
                    notes: document.getElementById('denNotes').value,
                    lat: gps.lat || '',
                    lng: gps.lng || ''
                };

                if (AppState.isOnline) {
                    const params = new URLSearchParams({ action: 'logGroundhogDen', ...denData });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        showToast('Den location logged!', 'success');
                        loadActiveDens();
                        resetDenForm();
                    } else {
                        showToast(data.error || 'Error logging den', 'error');
                    }
                } else {
                    await OfflineDB.queueOperation('logGroundhogDen', denData);
                    showToast('Den saved offline', 'success');
                    resetDenForm();
                }
            } catch (error) {
                console.error('Den logging error:', error);
                showToast('Error logging den', 'error');
            }
            hideLoading();
        }

        async function loadActiveDens() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getGroundhogDens`);
                const data = await response.json();

                const container = document.getElementById('activeDensList');
                if (data.success && data.dens && data.dens.length > 0) {
                    container.innerHTML = data.dens.map(den => `
                        <div class="den-card">
                            <div class="den-info">
                                <strong>${den.Field_ID || 'Unknown Field'}</strong>
                                <span class="den-activity ${den.Activity_Level}">${den.Activity_Level || 'Medium'} Activity</span>
                            </div>
                            <div class="den-meta">
                                <span><i class="fas fa-calendar"></i> ${den.Discovered_Date || 'N/A'}</span>
                                <span><i class="fas fa-ruler"></i> ${den.Den_Size || 'Medium'}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No active dens reported</p>';
                }
            } catch (error) {
                console.error('Load dens error:', error);
            }
        }

        async function submitDamageReport() {
            const field = document.getElementById('damageField').value;
            const crop = document.getElementById('damageCrop').value;

            if (!field || !crop) {
                showToast('Please fill in field and crop', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();
                const damageData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    animalType: document.getElementById('damageAnimal').value,
                    field: field,
                    bed: document.getElementById('damageBed').value,
                    cropAffected: crop,
                    severity: WildlifeState.damageSeverity || 'medium',
                    estimatedLoss: document.getElementById('damageLoss').value,
                    photo: WildlifeState.currentPhoto || '',
                    notes: document.getElementById('damageNotes').value,
                    lat: gps.lat || '',
                    lng: gps.lng || ''
                };

                if (AppState.isOnline) {
                    const params = new URLSearchParams({ action: 'logDamageReport', ...damageData });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        showToast('Damage reported!', 'success');
                        resetDamageForm();
                    } else {
                        showToast(data.error || 'Error reporting damage', 'error');
                    }
                } else {
                    await OfflineDB.queueOperation('logDamageReport', damageData);
                    showToast('Damage saved offline', 'success');
                    resetDamageForm();
                }
            } catch (error) {
                console.error('Damage report error:', error);
                showToast('Error reporting damage', 'error');
            }
            hideLoading();
        }

        async function loadWildlifeSummary() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getDamageReports&days=30`);
                const data = await response.json();

                const summaryDiv = document.getElementById('wildlifeSummary');
                const listDiv = document.getElementById('recentDamageList');

                if (data.success) {
                    // Summary by animal
                    if (data.byAnimal && Object.keys(data.byAnimal).length > 0) {
                        summaryDiv.innerHTML = Object.entries(data.byAnimal).map(([animal, stats]) => `
                            <div class="summary-card">
                                <div class="summary-animal">${animal}</div>
                                <div class="summary-stats">
                                    <span>${stats.count} reports</span>
                                    <span>$${stats.totalLoss.toFixed(2)} loss</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        summaryDiv.innerHTML = '<p style="color: var(--text-secondary);">No damage reports in the last 30 days</p>';
                    }

                    // Recent reports
                    if (data.reports && data.reports.length > 0) {
                        listDiv.innerHTML = '<h4 style="color: var(--text-primary); margin: 1rem 0 0.5rem;">Recent Damage Reports</h4>' +
                            data.reports.slice(0, 5).map(r => `
                                <div class="damage-item">
                                    <div class="damage-crop">${r.Crop_Affected || 'Unknown'}</div>
                                    <div class="damage-details">
                                        <span>${r.Animal_Type || 'Unknown'}</span>
                                        <span class="severity ${r.Damage_Severity}">${r.Damage_Severity}</span>
                                        <span>$${r.Estimated_Loss_Value || '0'}</span>
                                    </div>
                                </div>
                            `).join('');
                    }

                    // Total loss
                    if (data.totalLoss && parseFloat(data.totalLoss) > 0) {
                        listDiv.innerHTML += `
                            <div class="total-loss">
                                <strong>Total 30-Day Loss:</strong> $${data.totalLoss}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Load wildlife summary error:', error);
            }
        }

        function resetWildlifeState() {
            WildlifeState.animalType = null;
            WildlifeState.currentPhoto = null;
            document.querySelectorAll('.animal-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('wildlifeCount').value = '1';
            document.getElementById('wildlifeField').value = '';
            document.getElementById('wildlifeActivity').value = 'feeding';
            document.getElementById('wildlifeNotes').value = '';
            document.getElementById('wildlifePhotoPreview').style.display = 'none';
        }

        function resetDenForm() {
            WildlifeState.denSize = null;
            WildlifeState.denActivity = null;
            WildlifeState.currentPhoto = null;
            document.querySelectorAll('.den-size-btn, .activity-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('denField').value = '';
            document.getElementById('denNotes').value = '';
            document.getElementById('denPhotoPreview').style.display = 'none';
        }

        function resetDamageForm() {
            WildlifeState.damageSeverity = null;
            WildlifeState.currentPhoto = null;
            document.querySelectorAll('#wildlifeDamageForm .severity-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('damageAnimal').value = 'groundhog';
            document.getElementById('damageField').value = '';
            document.getElementById('damageBed').value = '';
            document.getElementById('damageCrop').value = '';
            document.getElementById('damageLoss').value = '';
            document.getElementById('damageNotes').value = '';
            document.getElementById('damagePhotoPreview').style.display = 'none';
        }

        // ============================================
        // PICK & PACK
        // ============================================
        const PickPackState = {
            pickList: [],
            currentTab: 'pick'
        };

        function openPickPack() {
            document.getElementById('pickPackModal').classList.add('visible');
            loadPickList();
        }

        function closePickPackModal() {
            document.getElementById('pickPackModal').classList.remove('visible');
        }

        function switchPickPackTab(tab) {
            PickPackState.currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.pickpack-tab').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Show/hide panels
            document.getElementById('pickListPanel').style.display = tab === 'pick' ? 'block' : 'none';
            document.getElementById('packOrdersPanel').style.display = tab === 'pack' ? 'block' : 'none';

            if (tab === 'pack') {
                loadPackOrders();
            }
        }

        async function loadPickList() {
            try {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('pickListDate').textContent = new Date().toLocaleDateString();

                const response = await fetch(`${CONFIG.API_URL}?action=getPickListForToday&date=${today}`);
                const data = await response.json();

                if (data.success) {
                    PickPackState.pickList = data.pickList || [];
                    renderPickList();
                }
            } catch (error) {
                console.error('Load pick list error:', error);
            }
        }

        function renderPickList() {
            const container = document.getElementById('pickListItems');
            const pickList = PickPackState.pickList;

            // Update stats
            const totalItems = pickList.length;
            const completedItems = pickList.filter(p => p.Status === 'Picked').length;
            const uniqueOrders = [...new Set(pickList.map(p => p.Order_ID))].length;

            document.getElementById('pickTotalItems').textContent = totalItems;
            document.getElementById('pickCompletedItems').textContent = completedItems;
            document.getElementById('pickOrders').textContent = uniqueOrders;

            if (pickList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <p>No items to pick today</p>
                    </div>
                `;
                return;
            }

            // Group by field for efficient picking
            const byField = {};
            pickList.forEach(item => {
                const field = item.Field || 'Unknown';
                if (!byField[field]) byField[field] = [];
                byField[field].push(item);
            });

            container.innerHTML = Object.entries(byField).map(([field, items]) => `
                <div class="pick-field-group">
                    <div class="field-header">
                        <i class="fas fa-map-marker-alt"></i> ${field}
                        <span class="field-count">${items.length} items</span>
                    </div>
                    ${items.map(item => `
                        <div class="pick-item ${item.Status === 'Picked' ? 'completed' : ''}" data-pick-id="${item.Pick_ID}">
                            <div class="pick-item-check" onclick="togglePickItem('${item.Pick_ID}')">
                                <i class="fas ${item.Status === 'Picked' ? 'fa-check-circle' : 'fa-circle'}"></i>
                            </div>
                            <div class="pick-item-info">
                                <div class="pick-crop">${item.Crop} ${item.Variety ? '- ' + item.Variety : ''}</div>
                                <div class="pick-details">
                                    <span><i class="fas fa-shopping-basket"></i> ${item.Quantity} ${item.Unit}</span>
                                    <span><i class="fas fa-user"></i> ${item.Customer_Name || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="pick-item-qty">${item.Quantity}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        async function togglePickItem(pickId) {
            const item = PickPackState.pickList.find(p => p.Pick_ID === pickId);
            if (!item) return;

            const newStatus = item.Status === 'Picked' ? 'Pending' : 'Picked';

            try {
                if (AppState.isOnline) {
                    const params = new URLSearchParams({
                        action: 'updatePickItemStatus',
                        pickId: pickId,
                        status: newStatus,
                        employeeId: AppState.employee?.Employee_ID || ''
                    });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        item.Status = newStatus;
                        renderPickList();
                    }
                } else {
                    // Update locally
                    item.Status = newStatus;
                    renderPickList();
                    await OfflineDB.queueOperation('updatePickItemStatus', { pickId, status: newStatus });
                }
            } catch (error) {
                console.error('Toggle pick item error:', error);
            }
        }

        async function loadPackOrders() {
            const container = document.getElementById('packOrdersList');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading orders...</p>
                </div>
            `;

            // For now, show orders from pick list that are fully picked
            const orderIds = [...new Set(PickPackState.pickList.map(p => p.Order_ID))];
            const readyOrders = orderIds.filter(orderId => {
                const orderItems = PickPackState.pickList.filter(p => p.Order_ID === orderId);
                return orderItems.every(item => item.Status === 'Picked');
            });

            if (readyOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No orders ready to pack</p>
                        <small>Complete picking all items for an order first</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = readyOrders.map(orderId => {
                const orderItems = PickPackState.pickList.filter(p => p.Order_ID === orderId);
                const customerName = orderItems[0]?.Customer_Name || 'Unknown';

                return `
                    <div class="pack-order-card">
                        <div class="pack-order-header">
                            <span class="order-id">${orderId}</span>
                            <span class="customer-name">${customerName}</span>
                        </div>
                        <div class="pack-order-items">
                            ${orderItems.map(item => `
                                <div class="pack-item">
                                    <span>${item.Crop}</span>
                                    <span>${item.Quantity} ${item.Unit}</span>
                                </div>
                            `).join('')}
                        </div>
                        <button class="pack-btn" onclick="completePackOrder('${orderId}')">
                            <i class="fas fa-box"></i> Mark as Packed
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function completePackOrder(orderId) {
            showLoading();
            try {
                const params = new URLSearchParams({
                    action: 'completePackingOrder',
                    orderId: orderId,
                    employeeId: AppState.employee?.Employee_ID || ''
                });

                const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    showToast('Order packed!', 'success');
                    // Remove from pick list
                    PickPackState.pickList = PickPackState.pickList.filter(p => p.Order_ID !== orderId);
                    loadPackOrders();
                } else {
                    showToast(data.error || 'Error packing order', 'error');
                }
            } catch (error) {
                console.error('Pack order error:', error);
                showToast('Error packing order', 'error');
            }
            hideLoading();
        }

        function printPickList() {
            // Add a header for printing
            const header = document.createElement('div');
            header.id = 'printHeader';
            header.innerHTML = `
                <div style="text-align: center; padding: 20px 0; border-bottom: 2px solid #333;">
                    <h1 style="margin: 0; font-size: 24px;">Tiny Seed Farm - Pick List</h1>
                    <p style="margin: 5px 0; font-size: 14px;">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
            `;

            const modalBody = document.querySelector('#pickPackModal .feature-modal-body');
            if (modalBody && !document.getElementById('printHeader')) {
                modalBody.insertBefore(header, modalBody.firstChild);
            }

            // Print
            window.print();

            // Remove the header after printing
            setTimeout(() => {
                const printHeader = document.getElementById('printHeader');
                if (printHeader) {
                    printHeader.remove();
                }
            }, 1000);
        }

        // ============================================
        // FARM PICS - Marketing Content Contribution
        // ============================================
        const FarmPicsState = {
            selectedCategory: 'harvest',
            selectedFile: null,
            recentSubmissions: []
        };

        function openFarmPics() {
            document.getElementById('farmPicsModal').classList.add('visible');
            loadRecentFarmPics();
        }

        function closeFarmPicsModal() {
            document.getElementById('farmPicsModal').classList.remove('visible');
            resetFarmPicsForm();
        }

        function selectFarmPicCategory(category) {
            FarmPicsState.selectedCategory = category;

            // Update button styles
            document.querySelectorAll('.farmpics-category-btn').forEach(btn => {
                btn.style.border = '2px solid #ddd';
                btn.style.background = 'white';
            });

            const activeBtn = document.querySelector(`[onclick="selectFarmPicCategory('${category}')"]`);
            if (activeBtn) {
                activeBtn.style.border = '2px solid #E1306C';
                activeBtn.style.background = 'rgba(225, 48, 108, 0.1)';
            }
        }

        function handleFarmPicSelect(event) {
            const file = event.target.files[0];
            if (file) {
                FarmPicsState.selectedFile = file;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('farmPicPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('farmPicUploadPrompt').style.display = 'none';
                    updateFarmPicSubmitButton();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateFarmPicSubmitButton() {
            const btn = document.getElementById('submitFarmPicBtn');
            const hasFile = FarmPicsState.selectedFile !== null;

            btn.disabled = !hasFile;
            btn.style.opacity = hasFile ? '1' : '0.5';
        }

        async function submitFarmPic() {
            if (!FarmPicsState.selectedFile) {
                showToast('Please select a photo', 'error');
                return;
            }

            showLoading();

            try {
                // Convert image to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Image = e.target.result;
                    const caption = document.getElementById('farmPicCaption').value;

                    const response = await fetch(CONFIG.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'submitFarmPic',
                            employeeId: AppState.employee?.Employee_ID || 'unknown',
                            employeeName: AppState.employee?.Name || 'Team Member',
                            category: FarmPicsState.selectedCategory,
                            caption: caption,
                            imageData: base64Image,
                            timestamp: new Date().toISOString()
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast('Photo submitted to marketing!', 'success');
                        resetFarmPicsForm();
                        loadRecentFarmPics();
                    } else {
                        showToast(data.error || 'Failed to submit', 'error');
                    }
                    hideLoading();
                };
                reader.readAsDataURL(FarmPicsState.selectedFile);
            } catch (error) {
                console.error('Submit farm pic error:', error);
                showToast('Error submitting photo', 'error');
                hideLoading();
            }
        }

        async function loadRecentFarmPics() {
            try {
                const params = new URLSearchParams({
                    action: 'getEmployeeFarmPics',
                    employeeId: AppState.employee?.Employee_ID || ''
                });

                const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                const data = await response.json();

                if (data.success && data.farmPics?.length > 0) {
                    FarmPicsState.recentSubmissions = data.farmPics;
                    renderRecentFarmPics();
                }
            } catch (error) {
                console.error('Load recent farm pics error:', error);
            }
        }

        function renderRecentFarmPics() {
            const container = document.getElementById('recentFarmPics');

            if (FarmPicsState.recentSubmissions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 1rem; width: 100%;">
                        <i class="fas fa-images" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p style="font-size: 0.85rem;">No submissions yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = FarmPicsState.recentSubmissions.map(pic => `
                <div style="flex: 0 0 80px; position: relative;">
                    <img src="${pic.thumbnailUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiNFMTMwNkMiIGZpbGwtb3BhY2l0eT0iMC4xIi8+PHRleHQgeD0iNDAiIHk9IjQ1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiNFMTMwNkMiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfk7g8L3RleHQ+PC9zdmc+'}"
                         alt="${pic.category}"
                         style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                    <div style="position: absolute; bottom: 4px; right: 4px; background: ${pic.status === 'approved' ? '#2a9d8f' : pic.status === 'used' ? '#9b59b6' : '#f59e0b'}; color: white; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px;">
                        ${pic.status || 'pending'}
                    </div>
                </div>
            `).join('');
        }

        function resetFarmPicsForm() {
            FarmPicsState.selectedFile = null;
            document.getElementById('farmPicPreview').style.display = 'none';
            document.getElementById('farmPicUploadPrompt').style.display = 'block';
            document.getElementById('farmPicCaption').value = '';
            document.getElementById('farmPicFileInput').value = '';
            updateFarmPicSubmitButton();
            selectFarmPicCategory('harvest');
        }

        // ============================================
        // PHASE 6: TREATMENT LOG
        // ============================================
        const TreatmentState = {
            weather: null,
            material: null
        };

        // Material database with REI/PHI info
        const MATERIALS = {
            neem: { name: 'Neem Oil', rei: 4, phi: 0, omri: true },
            bt: { name: 'Bt (Bacillus thuringiensis)', rei: 4, phi: 0, omri: true },
            spinosad: { name: 'Spinosad', rei: 4, phi: 1, omri: true },
            copper: { name: 'Copper Fungicide', rei: 24, phi: 0, omri: true },
            sulfur: { name: 'Sulfur', rei: 24, phi: 0, omri: true },
            pyrethrin: { name: 'Pyrethrin', rei: 12, phi: 0, omri: true },
            kaolin: { name: 'Kaolin Clay', rei: 4, phi: 0, omri: true },
            insectsoap: { name: 'Insecticidal Soap', rei: 0, phi: 0, omri: true }
        };

        function openTreatmentLog() {
            document.getElementById('treatmentModal').classList.add('visible');
            populateTreatmentFields();
            loadActiveREI();
        }

        function closeTreatmentModal() {
            document.getElementById('treatmentModal').classList.remove('visible');
            resetTreatmentForm();
        }

        function populateTreatmentFields() {
            const fields = ['treatmentField', 'beneficialField'];
            fields.forEach(fieldId => {
                const select = document.getElementById(fieldId);
                if (select && AppState.fields) {
                    select.innerHTML = '<option value="">Select field...</option>';
                    AppState.fields.forEach(f => {
                        select.innerHTML += `<option value="${f}">${f}</option>`;
                    });
                }
            });
        }

        function updateMaterialInfo() {
            const material = document.getElementById('treatmentMaterial').value;
            const infoDiv = document.getElementById('materialInfo');
            const otherInput = document.getElementById('treatmentOther');

            if (material === 'other') {
                otherInput.style.display = 'block';
                infoDiv.style.display = 'none';
            } else if (material && MATERIALS[material]) {
                otherInput.style.display = 'none';
                infoDiv.style.display = 'flex';
                document.getElementById('reiInfo').textContent = `REI: ${MATERIALS[material].rei} hours`;
                document.getElementById('phiInfo').textContent = `PHI: ${MATERIALS[material].phi} days`;
            } else {
                otherInput.style.display = 'none';
                infoDiv.style.display = 'none';
            }
        }

        function setWeather(weather) {
            TreatmentState.weather = weather;
            document.querySelectorAll('.weather-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(weather));
            });
        }

        async function loadActiveREI() {
            // This would load from API - for now show placeholder
            const warningsDiv = document.getElementById('reiWarnings');
            warningsDiv.style.display = 'none';
        }

        async function submitTreatment() {
            const material = document.getElementById('treatmentMaterial').value;
            const field = document.getElementById('treatmentField').value;

            if (!material || !field) {
                showToast('Please select material and field', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();
                const treatmentData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    material: material === 'other' ? document.getElementById('treatmentOther').value : MATERIALS[material]?.name,
                    field: field,
                    beds: document.getElementById('treatmentBeds').value,
                    rate: document.getElementById('treatmentRate').value,
                    amount: document.getElementById('treatmentAmount').value,
                    target: document.getElementById('treatmentTarget').value,
                    weather: TreatmentState.weather,
                    notes: document.getElementById('treatmentNotes').value,
                    reiHours: MATERIALS[material]?.rei || 0,
                    phiDays: MATERIALS[material]?.phi || 0,
                    lat: gps.lat || '',
                    lng: gps.lng || ''
                };

                if (AppState.isOnline) {
                    const params = new URLSearchParams({ action: 'logTreatment', ...treatmentData });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        showToast(t('treatment.success'), 'success');
                        closeTreatmentModal();
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                } else {
                    await OfflineDB.queueOperation('logTreatment', treatmentData);
                    showToast(t('treatment.success') + ' ' + t('common.offline'), 'success');
                    closeTreatmentModal();
                }
            } catch (error) {
                console.error('Treatment error:', error);
                showToast(t('common.error'), 'error');
            }
            hideLoading();
        }

        async function submitBeneficialRelease() {
            const type = document.getElementById('beneficialType').value;
            const qty = document.getElementById('beneficialQty').value;
            const field = document.getElementById('beneficialField').value;

            if (!type || !qty || !field) {
                showToast('Please fill all fields', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();
                const releaseData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    type: type,
                    quantity: qty,
                    field: field,
                    lat: gps.lat || '',
                    lng: gps.lng || ''
                };

                if (AppState.isOnline) {
                    const params = new URLSearchParams({ action: 'logBeneficialRelease', ...releaseData });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        showToast(t('treatment.releaseSuccess'), 'success');
                        document.getElementById('beneficialType').value = '';
                        document.getElementById('beneficialQty').value = '';
                        document.getElementById('beneficialField').value = '';
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                } else {
                    await OfflineDB.queueOperation('logBeneficialRelease', releaseData);
                    showToast(t('treatment.releaseSuccess') + ' ' + t('common.offline'), 'success');
                }
            } catch (error) {
                console.error('Release error:', error);
                showToast(t('common.error'), 'error');
            }
            hideLoading();
        }

        function resetTreatmentForm() {
            document.getElementById('treatmentMaterial').value = '';
            document.getElementById('treatmentField').value = '';
            document.getElementById('treatmentBeds').value = '';
            document.getElementById('treatmentRate').value = '';
            document.getElementById('treatmentAmount').value = '';
            document.getElementById('treatmentTarget').value = '';
            document.getElementById('treatmentNotes').value = '';
            document.getElementById('treatmentOther').value = '';
            document.getElementById('materialInfo').style.display = 'none';
            TreatmentState.weather = null;
            document.querySelectorAll('.weather-btn').forEach(btn => btn.classList.remove('active'));
        }

        // ============================================
        // PHASE 7: HAZARD REPORTING
        // ============================================
        const HazardState = {
            type: null,
            severity: null
        };

        function openHazards() {
            document.getElementById('hazardModal').classList.add('visible');
            loadActiveHazards();
        }

        function closeHazardModal() {
            document.getElementById('hazardModal').classList.remove('visible');
            resetHazardForm();
        }

        function setHazardType(type) {
            HazardState.type = type;
            document.querySelectorAll('.hazard-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${type}'`));
            });
        }

        function setHazardSeverity(severity) {
            HazardState.severity = severity;
            document.querySelectorAll('#hazardModal .severity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(severity));
            });
        }

        async function loadActiveHazards() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getActiveHazards`);
                const data = await response.json();

                const container = document.getElementById('hazardCards');
                if (data.success && data.hazards && data.hazards.length > 0) {
                    container.innerHTML = data.hazards.map(h => `
                        <div class="hazard-card ${h.Severity === 'critical' ? 'critical' : ''}">
                            <div class="hazard-card-header">
                                <span class="hazard-card-type">${h.Type || 'Unknown'}</span>
                                <span class="hazard-card-severity ${h.Severity}">${h.Severity || 'N/A'}</span>
                            </div>
                            <div class="hazard-card-desc">${h.Description || ''}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">No active hazards</p>';
                }
            } catch (error) {
                console.error('Error loading hazards:', error);
            }
        }

        async function submitHazard() {
            if (!HazardState.type || !HazardState.severity) {
                showToast('Please select type and severity', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();
                const hazardData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    type: HazardState.type,
                    severity: HazardState.severity,
                    description: document.getElementById('hazardDescription').value,
                    photo: AppState.capturedPhoto || '',
                    lat: gps.lat || '',
                    lng: gps.lng || ''
                };

                if (AppState.isOnline) {
                    const params = new URLSearchParams({ action: 'reportHazard', ...hazardData });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        showToast(t('hazard.success'), 'success');
                        closeHazardModal();
                        loadActiveHazards();
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                } else {
                    await OfflineDB.queueOperation('reportHazard', hazardData);
                    showToast(t('hazard.success') + ' ' + t('common.offline'), 'success');
                    closeHazardModal();
                }
            } catch (error) {
                console.error('Hazard error:', error);
                showToast(t('common.error'), 'error');
            }
            hideLoading();
        }

        function resetHazardForm() {
            HazardState.type = null;
            HazardState.severity = null;
            document.querySelectorAll('.hazard-type-btn, #hazardModal .severity-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('hazardDescription').value = '';
            document.getElementById('hazardPhotoPreview').style.display = 'none';
            AppState.capturedPhoto = null;
        }

        // ============================================
        // PHASE 7: WEED PRESSURE
        // ============================================
        const WeedState = {
            type: null
        };

        function openWeedLog() {
            document.getElementById('weedModal').classList.add('visible');
            populateWeedFields();
        }

        function closeWeedModal() {
            document.getElementById('weedModal').classList.remove('visible');
            resetWeedForm();
        }

        function populateWeedFields() {
            const select = document.getElementById('weedField');
            if (select && AppState.fields) {
                select.innerHTML = '<option value="">Select field...</option>';
                AppState.fields.forEach(f => {
                    select.innerHTML += `<option value="${f}">${f}</option>`;
                });
            }
        }

        function setWeedType(type) {
            WeedState.type = type;
            document.querySelectorAll('.weed-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${type}'`));
            });
        }

        function updatePressureLabel() {
            const val = document.getElementById('weedPressure').value;
            const labels = ['1 - Light', '2 - Light-Moderate', '3 - Moderate', '4 - Moderate-Heavy', '5 - Heavy'];
            document.getElementById('pressureValue').textContent = labels[val - 1];
        }

        async function submitWeedPressure() {
            const field = document.getElementById('weedField').value;

            if (!field || !WeedState.type) {
                showToast('Please select field and weed type', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();
                const weedData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    field: field,
                    bed: document.getElementById('weedBed').value,
                    weedType: WeedState.type,
                    species: document.getElementById('weedSpecies').value,
                    pressure: document.getElementById('weedPressure').value,
                    coverage: document.getElementById('weedCoverage').value,
                    notes: document.getElementById('weedNotes').value,
                    lat: gps.lat || '',
                    lng: gps.lng || ''
                };

                if (AppState.isOnline) {
                    const params = new URLSearchParams({ action: 'logWeedPressure', ...weedData });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        showToast(t('weed.success'), 'success');
                        closeWeedModal();
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                } else {
                    await OfflineDB.queueOperation('logWeedPressure', weedData);
                    showToast(t('weed.success') + ' ' + t('common.offline'), 'success');
                    closeWeedModal();
                }
            } catch (error) {
                console.error('Weed error:', error);
                showToast(t('common.error'), 'error');
            }
            hideLoading();
        }

        function resetWeedForm() {
            WeedState.type = null;
            document.querySelectorAll('.weed-type-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('weedField').value = '';
            document.getElementById('weedBed').value = '';
            document.getElementById('weedSpecies').value = '';
            document.getElementById('weedPressure').value = '3';
            document.getElementById('weedCoverage').value = '';
            document.getElementById('weedNotes').value = '';
            updatePressureLabel();
        }

        // ============================================
        // PHASE 7: CULTIVATION LOG
        // ============================================
        const CultivationState = {
            implement: null,
            depth: null,
            soil: null,
            effectiveness: null
        };

        function openCultivation() {
            document.getElementById('cultivationModal').classList.add('visible');
            populateCultivationFields();
        }

        function closeCultivationModal() {
            document.getElementById('cultivationModal').classList.remove('visible');
            resetCultivationForm();
        }

        function populateCultivationFields() {
            const select = document.getElementById('cultivationField');
            if (select && AppState.fields) {
                select.innerHTML = '<option value="">Select field...</option>';
                AppState.fields.forEach(f => {
                    select.innerHTML += `<option value="${f}">${f}</option>`;
                });
            }
        }

        function setImplement(implement) {
            CultivationState.implement = implement;
            document.querySelectorAll('.implement-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${implement}'`));
            });
        }

        function setDepth(depth) {
            CultivationState.depth = depth;
            document.querySelectorAll('.depth-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${depth}'`));
            });
        }

        function setSoil(soil) {
            CultivationState.soil = soil;
            document.querySelectorAll('.soil-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${soil}'`));
            });
        }

        function setEffectiveness(eff) {
            CultivationState.effectiveness = eff;
            document.querySelectorAll('.eff-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(`'${eff}'`));
            });
        }

        async function submitCultivation() {
            const field = document.getElementById('cultivationField').value;

            if (!field || !CultivationState.implement) {
                showToast('Please select field and implement', 'error');
                return;
            }

            showLoading();
            try {
                const gps = await captureGPS();
                const cultivationData = {
                    employeeId: AppState.employee?.Employee_ID || '',
                    field: field,
                    beds: document.getElementById('cultivationBeds').value,
                    implement: CultivationState.implement,
                    depth: CultivationState.depth,
                    soilCondition: CultivationState.soil,
                    effectiveness: CultivationState.effectiveness,
                    notes: document.getElementById('cultivationNotes').value,
                    lat: gps.lat || '',
                    lng: gps.lng || ''
                };

                if (AppState.isOnline) {
                    const params = new URLSearchParams({ action: 'logCultivation', ...cultivationData });
                    const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                    const data = await response.json();
                    if (data.success) {
                        showToast(t('cultivation.success'), 'success');
                        closeCultivationModal();
                    } else {
                        showToast(data.error || t('common.error'), 'error');
                    }
                } else {
                    await OfflineDB.queueOperation('logCultivation', cultivationData);
                    showToast(t('cultivation.success') + ' ' + t('common.offline'), 'success');
                    closeCultivationModal();
                }
            } catch (error) {
                console.error('Cultivation error:', error);
                showToast(t('common.error'), 'error');
            }
            hideLoading();
        }

        function resetCultivationForm() {
            CultivationState.implement = null;
            CultivationState.depth = null;
            CultivationState.soil = null;
            CultivationState.effectiveness = null;
            document.querySelectorAll('.implement-btn, .depth-btn, .soil-btn, .eff-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('cultivationField').value = '';
            document.getElementById('cultivationBeds').value = '';
            document.getElementById('cultivationNotes').value = '';
        }

        // ============================================
        // PHASE 8: MESSAGES
        // ============================================
        function openMessages() {
            document.getElementById('messagesModal').classList.add('visible');
            loadMessages();
        }

        function closeMessagesModal() {
            document.getElementById('messagesModal').classList.remove('visible');
        }

        async function loadMessages() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getCrewMessages&employeeId=${AppState.employee?.Employee_ID || ''}`);
                const data = await response.json();

                const container = document.getElementById('messagesList');
                const emptyState = document.getElementById('emptyMessages');

                if (data.success && data.messages && data.messages.length > 0) {
                    emptyState.style.display = 'none';
                    container.innerHTML = data.messages.map(m => `
                        <div class="message-card ${m.Urgent ? 'urgent' : ''}">
                            <div class="message-card-header">
                                <span class="message-from">${m.From || 'Farm Manager'}</span>
                                <span class="message-time">${formatTime(m.Timestamp)}</span>
                            </div>
                            <div class="message-content">${m.Message || ''}</div>
                            ${!m.Acknowledged ? `
                                <div class="message-ack">
                                    <button onclick="acknowledgeMessage('${m.Message_ID}')">
                                        <i class="fas fa-check"></i> ${t('messages.acknowledge')}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        async function acknowledgeMessage(messageId) {
            try {
                const params = new URLSearchParams({
                    action: 'acknowledgeMessage',
                    messageId: messageId,
                    employeeId: AppState.employee?.Employee_ID || ''
                });
                await fetch(`${CONFIG.API_URL}?${params.toString()}`);
                loadMessages();
                showToast(t('messages.acknowledged'), 'success');
            } catch (error) {
                console.error('Acknowledge error:', error);
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // ============================================
        // PHASE 8: HEAT SAFETY
        // ============================================
        function checkHeatSafety() {
            // Check every 2 hours during work hours
            const hour = new Date().getHours();
            if (hour >= 10 && hour <= 16) {
                // Show heat reminder if not dismissed recently
                const lastDismissed = localStorage.getItem('heatAlertDismissed');
                const now = Date.now();
                if (!lastDismissed || (now - parseInt(lastDismissed)) > 7200000) { // 2 hours
                    document.getElementById('heatAlert').style.display = 'block';
                }
            }
        }

        function dismissHeatAlert() {
            document.getElementById('heatAlert').style.display = 'none';
            localStorage.setItem('heatAlertDismissed', Date.now().toString());
        }

        // Start heat safety checks
        setInterval(checkHeatSafety, 3600000); // Check every hour
        setTimeout(checkHeatSafety, 5000); // Initial check after 5 seconds

        // ============================================
        // SYNC
        // ============================================
        async function syncData() {
            if (!AppState.isOnline) {
                showToast(t('common.offline'), 'warning');
                return;
            }

            // Use SyncModule to process pending operations and load fresh data
            await SyncModule.syncAll();
        }

        // ============================================
        // UI UTILITIES
        // ============================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('.toast-icon');

            toast.className = `toast ${type}`;
            icon.className = `fas toast-icon ${
                type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-exclamation-circle' :
                'fa-info-circle'
            }`;
            document.getElementById('toastMessage').textContent = message;

            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('visible');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('visible');
        }

        // ============================================
        // ONLINE/OFFLINE HANDLING
        // ============================================
        window.addEventListener('online', () => {
            AppState.isOnline = true;
            document.getElementById('offlineIndicator').classList.remove('visible');
            syncData();
        });

        window.addEventListener('offline', () => {
            AppState.isOnline = false;
            document.getElementById('offlineIndicator').classList.add('visible');
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize IndexedDB
            try {
                await OfflineDB.init();
                console.log('IndexedDB initialized');

                // Get sync queue count
                AppState.syncQueueCount = await OfflineDB.getSyncQueueCount();
                updateSyncBadge();

                // Try to restore session from IndexedDB first
                const idbSession = await OfflineDB.getSession();
                if (idbSession && idbSession.employee) {
                    AppState.employee = idbSession.employee;
                    AppState.language = idbSession.language || 'en';
                    showMainApp();
                } else {
                    // Fall back to localStorage
                    const session = localStorage.getItem('employeeSession');
                    if (session) {
                        try {
                            const saved = JSON.parse(session);
                            AppState.employee = saved.employee;
                            AppState.language = saved.language || 'en';
                            // Migrate to IndexedDB
                            await OfflineDB.saveSession(saved);
                            showMainApp();
                        } catch (e) {
                            console.error('Session parse error:', e);
                        }
                    }
                }

                // Start periodic sync
                SyncModule.startPeriodicSync();

            } catch (error) {
                console.error('IndexedDB init error:', error);
                // Fall back to localStorage only
                const session = localStorage.getItem('employeeSession');
                if (session) {
                    try {
                        const saved = JSON.parse(session);
                        AppState.employee = saved.employee;
                        AppState.language = saved.language || 'en';
                        showMainApp();
                    } catch (e) {
                        console.error('Session parse error:', e);
                    }
                }
            }

            // Update online status
            AppState.isOnline = navigator.onLine;
            if (!navigator.onLine) {
                document.getElementById('offlineIndicator').classList.add('visible');
            }

            // Check for deliveries and show badge
            checkDeliveryBadge();
        });

        // ============================================
        // DELIVERY MODE
        // ============================================
        let DeliveryState = {
            stops: [],
            currentStop: null,
            podPhoto: null,
            signatureData: null
        };

        async function openDeliveries() {
            document.getElementById('deliveryPanel').classList.add('active');
            await loadDeliveryRoutes();
        }

        function closeDeliveries() {
            document.getElementById('deliveryPanel').classList.remove('active');
        }

        async function loadDeliveryRoutes() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getDeliveryRoute&employeeId=${AppState.employee.Employee_ID}`);
                const data = await response.json();

                // Handle both data.stops (direct) and data.routes (array of routes with stops)
                let stops = [];
                if (data.success) {
                    if (data.stops) {
                        stops = data.stops;
                    } else if (data.routes && data.routes.length > 0) {
                        // Flatten all stops from all routes, adding route context
                        data.routes.forEach(route => {
                            if (route.stops && route.stops.length > 0) {
                                route.stops.forEach(stop => {
                                    stops.push({
                                        id: stop.Stop_ID || stop.id,
                                        customer: stop.customer || stop.Customer_Name || stop.Customer_Company || 'Customer',
                                        address: stop.Address || stop.address || '',
                                        phone: stop.phone || stop.Customer_Phone || '',
                                        email: stop.email || stop.Customer_Email || '',
                                        items: stop.items || [],
                                        notes: stop.Notes || stop.notes || stop.Delivery_Notes || '',
                                        completed: stop.Status === 'Delivered' || stop.completed || false,
                                        customerType: stop.Customer_Type || 'Retail',
                                        orderId: stop.Order_ID || ''
                                    });
                                });
                            }
                        });
                    }
                }

                if (stops.length > 0) {
                    DeliveryState.stops = stops;
                    renderDeliveryStops();
                    updateDeliverySummary();
                } else {
                    // Demo data for testing when no real data
                    DeliveryState.stops = [
                        { id: 1, customer: 'Smith Family', address: '123 Oak Lane, Doylestown PA', phone: '2155551234', email: 'smith@email.com', items: [{name: 'Mixed Greens', qty: 2}, {name: 'Tomatoes', qty: 1}], completed: false },
                        { id: 2, customer: 'Green Market Co-op', address: '456 Main St, New Hope PA', phone: '2155555678', email: 'orders@greenmarket.com', items: [{name: 'Bulk Carrots', qty: 10}], notes: 'Leave at back door', completed: false },
                        { id: 3, customer: 'Johnson Restaurant', address: '789 Bridge St, Lambertville NJ', phone: '6095559012', email: 'chef@johnson.com', items: [{name: 'Chef Mix', qty: 5}, {name: 'Herbs', qty: 3}], completed: true }
                    ];
                    renderDeliveryStops();
                    updateDeliverySummary();
                }
            } catch (error) {
                console.error('Load deliveries error:', error);
                showToast('Error loading deliveries', 'error');
            }
        }

        function renderDeliveryStops() {
            const list = document.getElementById('deliveryRouteList');
            if (DeliveryState.stops.length === 0) {
                list.innerHTML = `<div class="empty-state"><i class="fas fa-truck"></i><p>No deliveries assigned today</p></div>`;
                return;
            }

            list.innerHTML = DeliveryState.stops.map((stop, idx) => `
                <div class="delivery-stop ${stop.completed ? 'completed' : ''}" onclick="openDeliveryStop(${idx})">
                    <div class="stop-number">${stop.completed ? '' : idx + 1}</div>
                    <div class="stop-info">
                        <div class="stop-name">${stop.customer}</div>
                        <div class="stop-address-preview">${stop.address}</div>
                        <div class="stop-items-count">${stop.items.length} item${stop.items.length > 1 ? 's' : ''}</div>
                        ${!stop.completed ? `
                        <div class="stop-contact-inline">
                            ${stop.phone ? `<button class="contact-mini-btn call" onclick="event.stopPropagation(); callCustomerByIndex(${idx})" title="Call"><i class="fas fa-phone"></i></button>` : ''}
                            ${stop.phone ? `<button class="contact-mini-btn text" onclick="event.stopPropagation(); textCustomerByIndex(${idx})" title="Text"><i class="fas fa-comment-sms"></i></button>` : ''}
                            ${stop.email ? `<button class="contact-mini-btn email" onclick="event.stopPropagation(); emailCustomerByIndex(${idx})" title="Email"><i class="fas fa-envelope"></i></button>` : ''}
                        </div>
                        ` : ''}
                    </div>
                    <button class="navigate-btn" onclick="event.stopPropagation(); navigateToStop(${idx})">
                        <i class="fas fa-directions"></i>
                    </button>
                </div>
            `).join('');
        }

        function updateDeliverySummary() {
            const total = DeliveryState.stops.length;
            const completed = DeliveryState.stops.filter(s => s.completed).length;
            document.getElementById('totalStops').textContent = total;
            document.getElementById('completedStops').textContent = completed;
            document.getElementById('remainingStops').textContent = total - completed;
        }

        async function checkDeliveryBadge() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getDeliveryCount&employeeId=${AppState.employee?.Employee_ID || ''}`);
                const data = await response.json();
                const badge = document.getElementById('deliveryBadge');
                if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                // Silently fail - just hide badge
                document.getElementById('deliveryBadge').style.display = 'none';
            }
        }

        function refreshDeliveries() {
            loadDeliveryRoutes();
            showToast('Routes refreshed', 'success');
        }

        function openDeliveryStop(idx) {
            const stop = DeliveryState.stops[idx];
            if (!stop) return;

            DeliveryState.currentStop = idx;
            DeliveryState.podPhoto = null;
            DeliveryState.signatureData = null;

            document.getElementById('stopCustomerName').textContent = stop.customer;
            document.getElementById('stopAddress').querySelector('span').textContent = stop.address;

            // Render items
            const itemsHtml = stop.items.map(item =>
                `<div class="stop-item"><span>${item.name}</span><span>${item.qty}</span></div>`
            ).join('');
            document.getElementById('stopItems').innerHTML = itemsHtml;

            // Notes
            const notesEl = document.getElementById('stopNotes');
            if (stop.notes) {
                notesEl.textContent = stop.notes;
                notesEl.classList.add('has-notes');
            } else {
                notesEl.classList.remove('has-notes');
            }

            // Reset POD
            document.getElementById('podPhotoPreview').style.display = 'none';
            document.getElementById('podPlaceholder').style.display = 'flex';
            document.getElementById('podRetake').style.display = 'none';
            document.getElementById('podPhotoCapture').classList.remove('has-photo');

            // Init signature pad
            initSignaturePad();

            document.getElementById('deliveryStopModal').classList.add('active');
        }

        function closeDeliveryStop() {
            document.getElementById('deliveryStopModal').classList.remove('active');
        }

        function navigateToStop(idx) {
            const stop = DeliveryState.stops[idx];
            if (!stop) return;
            const encoded = encodeURIComponent(stop.address);
            window.open(`https://maps.google.com/?daddr=${encoded}`, '_blank');
        }

        function navigateToCurrentStop() {
            if (DeliveryState.currentStop !== null) {
                navigateToStop(DeliveryState.currentStop);
            }
        }

        // ========== DELIVERY CONTACT FUNCTIONS ==========

        // Call customer at current stop
        function callCustomer() {
            const stop = DeliveryState.stops[DeliveryState.currentStop];
            if (!stop) return;

            const phone = stop.phone || stop.customerPhone;
            if (phone) {
                window.location.href = `tel:${phone}`;
            } else {
                showToast('No phone number available', 'warning');
            }
        }

        // Call customer by stop index
        function callCustomerByIndex(idx) {
            const stop = DeliveryState.stops[idx];
            if (!stop) return;

            const phone = stop.phone || stop.customerPhone;
            if (phone) {
                window.location.href = `tel:${phone}`;
            } else {
                showToast('No phone number available', 'warning');
            }
        }

        // Text customer at current stop
        function textCustomer() {
            const stop = DeliveryState.stops[DeliveryState.currentStop];
            if (!stop) return;

            const phone = stop.phone || stop.customerPhone;
            if (phone) {
                const message = encodeURIComponent(`Hi ${stop.customer}, this is your delivery driver from Tiny Seed Farm. I'm on my way!`);
                window.location.href = `sms:${phone}?body=${message}`;
            } else {
                showToast('No phone number available', 'warning');
            }
        }

        // Text customer by stop index
        function textCustomerByIndex(idx) {
            const stop = DeliveryState.stops[idx];
            if (!stop) return;

            const phone = stop.phone || stop.customerPhone;
            if (phone) {
                const message = encodeURIComponent(`Hi ${stop.customer}, this is your delivery driver from Tiny Seed Farm.`);
                window.location.href = `sms:${phone}?body=${message}`;
            } else {
                showToast('No phone number available', 'warning');
            }
        }

        // Email customer at current stop
        function emailCustomer() {
            const stop = DeliveryState.stops[DeliveryState.currentStop];
            if (!stop) return;

            const email = stop.email || stop.customerEmail;
            if (email) {
                const subject = encodeURIComponent(`Delivery Update - Tiny Seed Farm`);
                const body = encodeURIComponent(`Hi ${stop.customer},\n\nThis is an update regarding your delivery from Tiny Seed Farm.\n\nThank you!`);
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            } else {
                showToast('No email available', 'warning');
            }
        }

        // Email customer by stop index
        function emailCustomerByIndex(idx) {
            const stop = DeliveryState.stops[idx];
            if (!stop) return;

            const email = stop.email || stop.customerEmail;
            if (email) {
                const subject = encodeURIComponent(`Delivery Update - Tiny Seed Farm`);
                const body = encodeURIComponent(`Hi ${stop.customer},\n\nThis is an update regarding your delivery from Tiny Seed Farm.\n\nThank you!`);
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            } else {
                showToast('No email available', 'warning');
            }
        }

        // ========== ROUTE ACTION FUNCTIONS ==========

        let routeStarted = false;
        let driverLocation = null;

        // Start the delivery route - sends SMS to all customers
        async function startRoute() {
            const btn = document.getElementById('startRouteBtn');

            if (routeStarted) {
                // End route
                routeStarted = false;
                btn.innerHTML = '<i class="fas fa-play-circle"></i><span>Start Route</span>';
                btn.classList.remove('active');
                showToast('Route ended', 'info');
                return;
            }

            // Start route
            routeStarted = true;
            btn.innerHTML = '<i class="fas fa-stop-circle"></i><span>End Route</span>';
            btn.classList.add('active');

            // Get current location
            try {
                const position = await getCurrentPosition();
                driverLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
            } catch (error) {
                console.warn('Could not get location:', error);
            }

            // Send SMS to all customers on the route
            const customersToNotify = DeliveryState.stops.filter(s => !s.completed && s.phone);

            if (customersToNotify.length > 0) {
                // Send via backend API for bulk SMS
                try {
                    const response = await fetch(CONFIG.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'sendRouteSMS',
                            type: 'route_start',
                            driverId: AppState.employee?.Employee_ID,
                            driverName: AppState.employee?.Name || 'Your driver',
                            customers: customersToNotify.map(s => ({
                                name: s.customer,
                                phone: s.phone || s.customerPhone,
                                address: s.address
                            }))
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast(`Notified ${customersToNotify.length} customers`, 'success');
                    } else {
                        showToast('Route started - notifications may be delayed', 'info');
                    }
                } catch (error) {
                    console.error('SMS send error:', error);
                    showToast('Route started', 'success');
                }
            } else {
                showToast('Route started!', 'success');
            }
        }

        // Get current position as Promise
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }

        // Send "running behind" SMS with live GPS link
        async function sendRunningBehindSMS() {
            // Get current location
            try {
                showToast('Getting location...', 'info');
                const position = await getCurrentPosition();
                driverLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Create Google Maps link with live location
                const mapsLink = `https://maps.google.com/?q=${driverLocation.lat},${driverLocation.lng}`;

                // Get remaining stops
                const remainingStops = DeliveryState.stops.filter(s => !s.completed);

                if (remainingStops.length === 0) {
                    showToast('No remaining deliveries', 'info');
                    return;
                }

                // Option to send to all remaining or just next stop
                const nextStop = remainingStops[0];
                const phone = nextStop.phone || nextStop.customerPhone;

                if (phone) {
                    // Direct SMS with location link
                    const message = encodeURIComponent(
                        `Hi ${nextStop.customer}, this is your driver from Tiny Seed Farm. ` +
                        `I'm running a bit behind schedule but I'm on my way! ` +
                        `Track my location here: ${mapsLink}`
                    );
                    window.location.href = `sms:${phone}?body=${message}`;
                    showToast('Opening SMS...', 'success');
                } else {
                    // Try to send via backend to all customers
                    try {
                        const response = await fetch(CONFIG.API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'sendRouteSMS',
                                type: 'running_behind',
                                driverId: AppState.employee?.Employee_ID,
                                driverName: AppState.employee?.Name || 'Your driver',
                                locationLink: mapsLink,
                                customers: remainingStops.map(s => ({
                                    name: s.customer,
                                    phone: s.phone || s.customerPhone
                                })).filter(c => c.phone)
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            showToast('Delay notification sent!', 'success');
                        } else {
                            showToast('Could not send notification', 'error');
                        }
                    } catch (error) {
                        console.error('SMS error:', error);
                        showToast('Could not send notification', 'error');
                    }
                }
            } catch (error) {
                console.error('Location error:', error);
                showToast('Could not get your location. Please enable GPS.', 'error');
            }
        }

        async function capturePODPhoto() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();

                // Wait for video to be ready
                await new Promise(resolve => video.onloadedmetadata = resolve);

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);

                stream.getTracks().forEach(t => t.stop());

                DeliveryState.podPhoto = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById('podPhotoPreview').src = DeliveryState.podPhoto;
                document.getElementById('podPhotoPreview').style.display = 'block';
                document.getElementById('podPlaceholder').style.display = 'none';
                document.getElementById('podRetake').style.display = 'block';
                document.getElementById('podPhotoCapture').classList.add('has-photo');
            } catch (error) {
                console.error('Camera error:', error);
                showToast('Camera access denied', 'error');
            }
        }

        function retakePODPhoto() {
            DeliveryState.podPhoto = null;
            document.getElementById('podPhotoPreview').style.display = 'none';
            document.getElementById('podPlaceholder').style.display = 'flex';
            document.getElementById('podRetake').style.display = 'none';
            document.getElementById('podPhotoCapture').classList.remove('has-photo');
            capturePODPhoto();
        }

        let signatureCanvas, signatureCtx, isDrawing = false;

        function initSignaturePad() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');

            // Set canvas size
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCanvas.width = rect.width;
            signatureCanvas.height = rect.height;

            signatureCtx.fillStyle = 'white';
            signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            signatureCtx.strokeStyle = '#000';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';

            // Touch events
            signatureCanvas.addEventListener('touchstart', startDrawing);
            signatureCanvas.addEventListener('touchmove', draw);
            signatureCanvas.addEventListener('touchend', stopDrawing);

            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            signatureCtx.beginPath();
            const pos = getPosition(e);
            signatureCtx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPosition(e);
            signatureCtx.lineTo(pos.x, pos.y);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            DeliveryState.signatureData = signatureCanvas.toDataURL('image/png');
        }

        function getPosition(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
        }

        function clearSignature() {
            signatureCtx.fillStyle = 'white';
            signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            DeliveryState.signatureData = null;
        }

        async function completeDelivery() {
            const idx = DeliveryState.currentStop;
            if (idx === null) return;

            if (!DeliveryState.podPhoto) {
                showToast('Please take a photo', 'warning');
                return;
            }

            try {
                const gps = await captureGPS();
                const response = await fetch(`${CONFIG.API_URL}?action=completeDelivery`, {
                    method: 'POST',
                    body: JSON.stringify({
                        stopId: DeliveryState.stops[idx].id,
                        employeeId: AppState.employee.Employee_ID,
                        photo: DeliveryState.podPhoto,
                        signature: DeliveryState.signatureData,
                        lat: gps.lat,
                        lng: gps.lng,
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();
                if (data.success) {
                    DeliveryState.stops[idx].completed = true;
                    renderDeliveryStops();
                    updateDeliverySummary();
                    closeDeliveryStop();
                    showToast('Delivery completed!', 'success');
                } else {
                    // Mark complete locally anyway for offline support
                    DeliveryState.stops[idx].completed = true;
                    renderDeliveryStops();
                    updateDeliverySummary();
                    closeDeliveryStop();
                    showToast('Saved offline - will sync', 'warning');
                }
            } catch (error) {
                console.error('Complete delivery error:', error);
                // Offline - mark complete locally
                DeliveryState.stops[idx].completed = true;
                renderDeliveryStops();
                updateDeliverySummary();
                closeDeliveryStop();
                showToast('Saved offline - will sync', 'warning');
            }
        }

        function reportDeliveryIssue() {
            const issues = ['Customer not home', 'Wrong address', 'Refused delivery', 'Damaged item', 'Other'];
            const issue = prompt('Select issue:\n' + issues.map((i, idx) => `${idx + 1}. ${i}`).join('\n'));
            if (issue) {
                showToast('Issue reported', 'success');
                closeDeliveryStop();
            }
        }

        // ============================================
        // TIMESHEET & ANOMALY DETECTION
        // ============================================
        let TimesheetState = {
            entries: [],
            payPeriod: null,
            anomalies: [],
            hourlyRate: 15.00 // Default, would come from employee record
        };

        async function openTimesheet() {
            document.getElementById('timesheetPanel').classList.add('active');
            await loadTimesheet();
        }

        function closeTimesheet() {
            document.getElementById('timesheetPanel').classList.remove('active');
        }

        async function loadTimesheet() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getTimesheet&employeeId=${AppState.employee.Employee_ID}`);
                const data = await response.json();

                if (data.success) {
                    TimesheetState.entries = data.entries || [];
                    TimesheetState.payPeriod = data.payPeriod;
                    TimesheetState.hourlyRate = data.hourlyRate || 15.00;
                } else {
                    // Demo data
                    generateDemoTimesheet();
                }

                detectAnomalies();
                renderTimesheet();
                renderAnomalyWarnings();
                updatePayPeriodSummary();
                updateQBSyncStatus();
            } catch (error) {
                console.error('Load timesheet error:', error);
                generateDemoTimesheet();
                detectAnomalies();
                renderTimesheet();
                renderAnomalyWarnings();
                updatePayPeriodSummary();
            }
        }

        function generateDemoTimesheet() {
            const today = new Date();
            const entries = [];

            // Generate last 7 days of entries
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);

                if (date.getDay() !== 0 && date.getDay() !== 6) { // Skip weekends
                    const clockIn = new Date(date);
                    clockIn.setHours(7, Math.floor(Math.random() * 30), 0);

                    const clockOut = new Date(date);
                    clockOut.setHours(15 + Math.floor(Math.random() * 3), Math.floor(Math.random() * 60), 0);

                    entries.push({
                        date: date.toISOString().split('T')[0],
                        clockIn: clockIn.toISOString(),
                        clockOut: i === 0 && AppState.isClockedIn ? null : clockOut.toISOString(),
                        hours: i === 0 && AppState.isClockedIn ? null : ((clockOut - clockIn) / 1000 / 60 / 60).toFixed(2)
                    });
                }
            }

            // Add anomaly for demo - one day with 10+ hours
            if (entries.length > 2) {
                entries[2].hours = '10.5';
            }

            TimesheetState.entries = entries;
            TimesheetState.payPeriod = {
                start: new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0],
                end: new Date(today.getFullYear(), today.getMonth(), 15).toISOString().split('T')[0]
            };
        }

        function detectAnomalies() {
            const anomalies = [];
            let weeklyTotal = 0;
            const weekStart = getWeekStart(new Date());

            TimesheetState.entries.forEach(entry => {
                const entryDate = new Date(entry.date);
                const hours = parseFloat(entry.hours) || 0;

                // Check for long shifts (over 10 hours)
                if (hours > 10) {
                    anomalies.push({
                        type: 'long_shift',
                        severity: 'warning',
                        message: `Long shift on ${formatDate(entryDate)}: ${hours.toFixed(1)} hours`,
                        date: entry.date
                    });
                }

                // Check for missing clock out
                if (entry.clockIn && !entry.clockOut && !isToday(entryDate)) {
                    anomalies.push({
                        type: 'missing_clockout',
                        severity: 'error',
                        message: `Missing clock-out on ${formatDate(entryDate)}`,
                        date: entry.date
                    });
                }

                // Accumulate weekly hours
                if (entryDate >= weekStart) {
                    weeklyTotal += hours;
                }
            });

            // Check approaching overtime (over 35 hours, warning at 40)
            if (weeklyTotal >= 35 && weeklyTotal < 40) {
                anomalies.push({
                    type: 'overtime_approaching',
                    severity: 'warning',
                    message: `Approaching overtime: ${weeklyTotal.toFixed(1)} hours this week`,
                    date: null
                });
            }

            // Check overtime (over 40 hours)
            if (weeklyTotal >= 40) {
                anomalies.push({
                    type: 'overtime',
                    severity: 'overtime',
                    message: `Overtime: ${(weeklyTotal - 40).toFixed(1)} OT hours this week`,
                    date: null
                });
            }

            TimesheetState.anomalies = anomalies;
        }

        function renderAnomalyWarnings() {
            const container = document.getElementById('anomalyWarnings');
            const list = document.getElementById('warningList');

            if (TimesheetState.anomalies.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = TimesheetState.anomalies.map(a => `
                <div class="warning-item ${a.type === 'overtime' || a.type === 'overtime_approaching' ? 'overtime' : ''}">
                    <i class="fas ${getAnomalyIcon(a.type)} warning-icon"></i>
                    <span>${a.message}</span>
                </div>
            `).join('');
        }

        function getAnomalyIcon(type) {
            switch (type) {
                case 'missing_clockout': return 'fa-clock';
                case 'long_shift': return 'fa-hourglass-half';
                case 'overtime':
                case 'overtime_approaching': return 'fa-dollar-sign';
                default: return 'fa-exclamation-triangle';
            }
        }

        function renderTimesheet() {
            const container = document.getElementById('timesheetDays');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            container.innerHTML = TimesheetState.entries.slice(-7).map(entry => {
                const date = new Date(entry.date);
                const hours = parseFloat(entry.hours) || 0;
                const clockIn = entry.clockIn ? new Date(entry.clockIn) : null;
                const clockOut = entry.clockOut ? new Date(entry.clockOut) : null;

                return `
                    <div class="timesheet-day">
                        <div class="day-info">
                            <span class="day-name">${days[date.getDay()]}</span>
                            <span class="day-date">${formatDateShort(date)}</span>
                        </div>
                        <div style="text-align: right;">
                            <div class="day-hours ${hours > 8 ? 'overtime' : ''}">${entry.hours ? hours.toFixed(1) + 'h' : '--'}</div>
                            <div class="day-times">${clockIn ? formatTime(clockIn) : '--'} - ${clockOut ? formatTime(clockOut) : 'Now'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePayPeriodSummary() {
            const totalHours = TimesheetState.entries.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
            const regularHours = Math.min(totalHours, 80); // Bi-weekly standard
            const overtimeHours = Math.max(0, totalHours - 80);
            const grossPay = (regularHours * TimesheetState.hourlyRate) + (overtimeHours * TimesheetState.hourlyRate * 1.5);

            document.getElementById('periodHours').textContent = totalHours.toFixed(1);
            document.getElementById('periodOT').textContent = overtimeHours.toFixed(1);
            document.getElementById('periodGross').textContent = '$' + grossPay.toFixed(0);

            if (TimesheetState.payPeriod) {
                const start = new Date(TimesheetState.payPeriod.start);
                const end = new Date(TimesheetState.payPeriod.end);
                document.getElementById('payPeriodDates').textContent =
                    `${formatDateShort(start)} - ${formatDateShort(end)}`;
            }
        }

        function updateQBSyncStatus() {
            // Check QuickBooks sync status
            const badge = document.getElementById('syncBadge');
            const timeEl = document.getElementById('lastSyncTime');

            // This would check actual QB sync status
            const lastSync = localStorage.getItem('qb_last_sync');
            if (lastSync) {
                const syncDate = new Date(lastSync);
                timeEl.textContent = `Last synced: ${formatDate(syncDate)}`;
                badge.textContent = 'Synced';
                badge.className = 'sync-badge synced';
            } else {
                timeEl.textContent = 'Last synced: --';
                badge.textContent = 'Pending';
                badge.className = 'sync-badge pending';
            }
        }

        async function exportTimesheet() {
            try {
                // Export to QuickBooks
                const response = await fetch(`${CONFIG.API_URL}?action=syncToQuickBooks`, {
                    method: 'POST',
                    body: JSON.stringify({
                        employeeId: AppState.employee.Employee_ID,
                        entries: TimesheetState.entries,
                        payPeriod: TimesheetState.payPeriod
                    })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('qb_last_sync', new Date().toISOString());
                    updateQBSyncStatus();
                    showToast('Synced to QuickBooks!', 'success');
                } else {
                    showToast('Sync failed - try again', 'error');
                }
            } catch (error) {
                console.error('QB sync error:', error);
                showToast('Sync failed - offline', 'error');
            }
        }

        // Helper functions
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateShort(date) {
            return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        // ============================================
        // TUTORIAL MODE
        // ============================================
        const TutorialMode = {
            active: false,
            currentStep: 0,
            steps: [
                {
                    target: '.welcome-banner',
                    title: 'Welcome Banner',
                    text: 'See the weather, date, and an encouraging message to start your day.',
                    icon: 'fa-sun',
                    position: 'bottom'
                },
                {
                    target: '.mode-selector',
                    title: 'Work Modes',
                    text: 'Select your work mode: Field for outdoor work, Packhouse for processing, or specialized modes if you have access.',
                    icon: 'fa-th-large',
                    position: 'bottom'
                },
                {
                    target: '.clock-card',
                    title: 'Time Clock',
                    text: 'Clock in when you start work, clock out when you finish. Your hours are tracked automatically.',
                    icon: 'fa-clock',
                    position: 'bottom'
                },
                {
                    target: '[data-tutorial="tasks-tab"]',
                    title: 'Tasks Tab',
                    text: 'View your assigned tasks here. Check off items as you complete them. Some tasks have subtasks you can track individually.',
                    icon: 'fa-clipboard-list',
                    position: 'top'
                },
                {
                    target: '[data-tutorial="harvest-tab"]',
                    title: 'Harvest Tab',
                    text: 'Log your harvests with crop, quantity, and quality. This data helps track yields and plan sales.',
                    icon: 'fa-basket-shopping',
                    position: 'top'
                },
                {
                    target: '[data-tutorial="more-tab"]',
                    title: 'More Options',
                    text: 'Access additional features like Wildlife tracking, Farm photos, Treatment logs, Timesheets, and Settings.',
                    icon: 'fa-ellipsis-h',
                    position: 'top'
                },
                {
                    target: '.header-btn.lang-toggle',
                    title: 'Language Toggle',
                    text: 'Switch between English and Spanish with one tap.',
                    icon: 'fa-language',
                    position: 'bottom'
                },
                {
                    target: '.sync-btn-wrapper',
                    title: 'Sync Button',
                    text: 'Manually sync your data when online. A badge shows pending items if you worked offline.',
                    icon: 'fa-sync-alt',
                    position: 'bottom'
                }
            ],

            init() {
                // Create tutorial elements if they don't exist
                if (!document.getElementById('tutorialOverlay')) {
                    const overlay = document.createElement('div');
                    overlay.id = 'tutorialOverlay';
                    overlay.className = 'tutorial-overlay';
                    overlay.onclick = () => this.skip();
                    document.body.appendChild(overlay);

                    const bubble = document.createElement('div');
                    bubble.id = 'tutorialBubble';
                    bubble.className = 'tutorial-bubble';
                    bubble.innerHTML = `
                        <div class="tutorial-bubble-icon"><i class="fas fa-info"></i></div>
                        <div class="tutorial-bubble-title"></div>
                        <div class="tutorial-bubble-text"></div>
                        <div class="tutorial-bubble-actions">
                            <button class="tutorial-btn tutorial-btn-skip" onclick="TutorialMode.skip()">Skip</button>
                            <button class="tutorial-btn tutorial-btn-next" onclick="TutorialMode.next()">Next</button>
                        </div>
                        <div class="tutorial-progress"></div>
                    `;
                    document.body.appendChild(bubble);

                    const toggle = document.createElement('button');
                    toggle.id = 'tutorialToggle';
                    toggle.className = 'tutorial-toggle';
                    toggle.innerHTML = '<i class="fas fa-question"></i>';
                    toggle.onclick = () => this.start();
                    document.body.appendChild(toggle);
                }

                // Check if first time user
                if (!localStorage.getItem('tsf_tutorial_completed')) {
                    setTimeout(() => this.start(), 2000);
                }
            },

            start() {
                this.active = true;
                this.currentStep = 0;
                document.getElementById('tutorialOverlay').classList.add('active');
                document.getElementById('tutorialToggle').classList.add('hidden');
                this.showStep();
            },

            showStep() {
                const step = this.steps[this.currentStep];
                if (!step) {
                    this.complete();
                    return;
                }

                // Remove previous highlight
                document.querySelectorAll('.tutorial-highlight').forEach(el => {
                    el.classList.remove('tutorial-highlight');
                });

                // Find target element
                const target = document.querySelector(step.target);
                if (!target) {
                    // Skip to next if target not found
                    this.currentStep++;
                    this.showStep();
                    return;
                }

                // Highlight target
                target.classList.add('tutorial-highlight');

                // Position bubble
                const bubble = document.getElementById('tutorialBubble');
                const rect = target.getBoundingClientRect();

                bubble.querySelector('.tutorial-bubble-icon i').className = `fas ${step.icon}`;
                bubble.querySelector('.tutorial-bubble-title').textContent = step.title;
                bubble.querySelector('.tutorial-bubble-text').textContent = step.text;

                // Update button text
                const nextBtn = bubble.querySelector('.tutorial-btn-next');
                nextBtn.textContent = this.currentStep === this.steps.length - 1 ? 'Done' : 'Next';

                // Update progress dots
                const progress = bubble.querySelector('.tutorial-progress');
                progress.innerHTML = this.steps.map((_, i) => `
                    <div class="tutorial-dot ${i < this.currentStep ? 'completed' : ''} ${i === this.currentStep ? 'active' : ''}"></div>
                `).join('');

                // Remove position classes
                bubble.classList.remove('arrow-top', 'arrow-bottom', 'arrow-left', 'arrow-right');

                // Position bubble based on target location
                const bubbleWidth = 280;
                const bubbleHeight = 200;
                let left, top;

                if (step.position === 'top') {
                    // Bubble above target (for bottom nav items)
                    left = rect.left + (rect.width / 2) - (bubbleWidth / 2);
                    top = rect.top - bubbleHeight - 20;
                    bubble.classList.add('arrow-bottom');
                } else {
                    // Bubble below target
                    left = rect.left + (rect.width / 2) - (bubbleWidth / 2);
                    top = rect.bottom + 20;
                    bubble.classList.add('arrow-top');
                }

                // Keep bubble on screen
                left = Math.max(16, Math.min(left, window.innerWidth - bubbleWidth - 16));
                top = Math.max(16, Math.min(top, window.innerHeight - bubbleHeight - 16));

                bubble.style.left = left + 'px';
                bubble.style.top = top + 'px';

                // Animate in
                setTimeout(() => bubble.classList.add('active'), 50);
            },

            next() {
                const bubble = document.getElementById('tutorialBubble');
                bubble.classList.remove('active');

                setTimeout(() => {
                    this.currentStep++;
                    if (this.currentStep >= this.steps.length) {
                        this.complete();
                    } else {
                        this.showStep();
                    }
                }, 200);
            },

            skip() {
                this.complete();
            },

            complete() {
                this.active = false;
                localStorage.setItem('tsf_tutorial_completed', 'true');

                document.getElementById('tutorialOverlay').classList.remove('active');
                document.getElementById('tutorialBubble').classList.remove('active');
                document.getElementById('tutorialToggle').classList.remove('hidden');

                document.querySelectorAll('.tutorial-highlight').forEach(el => {
                    el.classList.remove('tutorial-highlight');
                });

                showToast('Tutorial complete! Tap ? anytime to see it again.', 'success');
            },

            reset() {
                localStorage.removeItem('tsf_tutorial_completed');
                this.start();
            }
        };

        // Initialize tutorial after app loads
        const originalShowMainApp = showMainApp;
        showMainApp = function() {
            originalShowMainApp.apply(this, arguments);
            setTimeout(() => TutorialMode.init(), 500);
        };
    </script>
</body>
</html>
