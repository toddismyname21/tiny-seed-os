<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Seed OS - Farm Management Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="web_app/auth-guard.js" data-required-role="Employee"></script>
    <style>
        :root {
            --primary: #2d5a27;
            --primary-light: #4a7c43;
            --primary-dark: #1e3d1a;
            --secondary: #f4a261;
            --accent: #e76f51;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #e63946;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-light: #0f3460;
            --text-primary: #edf2f4;
            --text-secondary: #8d99ae;
            --border: rgba(255,255,255,0.1);
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f1a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
        }

        /* Left Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0.85rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(45, 90, 39, 0.2);
            color: var(--primary-light);
            border-left-color: var(--primary-light);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        .nav-item span {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .nav-item .badge.success {
            background: var(--success);
        }

        /* Primary Add Button in Sidebar */
        .nav-item.nav-item-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white !important;
            border-radius: 10px;
            margin: 0 1rem 0.5rem;
            padding: 0.9rem 1.25rem;
            border-left: none;
            font-weight: 600;
            justify-content: center;
        }

        .nav-item.nav-item-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(45, 90, 39, 0.4);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--success) 100%);
        }

        .nav-item.nav-item-primary i {
            color: white;
        }

        /* Command Palette Trigger */
        .nav-item.nav-item-command {
            border: 1px dashed var(--border);
            border-radius: 8px;
            margin: 0 1rem;
            border-left: 1px dashed var(--border);
        }

        .nav-item.nav-item-command:hover {
            border-color: var(--primary);
            background: rgba(45, 90, 39, 0.1);
        }

        .kbd-hint {
            margin-left: auto;
            background: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-family: monospace;
            color: var(--text-secondary);
        }

        /* Filter Chips */
        .filter-chip {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.error { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Sidebar Tooltips */
        .nav-item[title] {
            position: relative;
        }

        .nav-item .tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-dark);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-left: 10px;
            z-index: 1000;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .nav-item:hover .tooltip {
            opacity: 1;
        }

        /* Welcome & Weather Banner */
        .welcome-banner {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-light) 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
        }

        .welcome-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .welcome-text h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .welcome-text .date-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .weather-current {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weather-icon {
            font-size: 2rem;
            color: var(--warning);
        }

        .weather-temp {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .weather-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .weather-details {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .weather-details span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .weather-info {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 12px;
            transition: background 0.2s;
        }

        .weather-info:hover {
            background: rgba(255,255,255,0.05);
        }

        .weather-info .click-hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.2s;
            margin-top: 4px;
            text-align: right;
        }

        .weather-info:hover .click-hint {
            opacity: 1;
        }

        /* Forecast Popup */
        .forecast-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            min-width: 380px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .forecast-popup.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .forecast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .forecast-header h4 {
            font-size: 1rem;
            font-weight: 600;
        }

        .forecast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px 8px;
        }

        .forecast-close:hover {
            color: var(--text-primary);
        }

        .forecast-days {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .forecast-day {
            display: grid;
            grid-template-columns: 80px 40px 1fr 70px;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border);
        }

        .forecast-day:last-child {
            border-bottom: none;
        }

        .forecast-day .day-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .forecast-day .day-name .date {
            font-weight: 400;
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
        }

        .forecast-day .day-icon {
            font-size: 1.25rem;
            text-align: center;
        }

        .forecast-day .day-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .forecast-day .day-temps {
            text-align: right;
            font-size: 0.9rem;
        }

        .forecast-day .day-temps .high {
            font-weight: 600;
            color: var(--secondary);
        }

        .forecast-day .day-temps .low {
            color: var(--text-secondary);
        }

        .forecast-day.today {
            background: rgba(45, 90, 39, 0.15);
            margin: 0 -0.75rem;
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
        }

        .forecast-alerts {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .forecast-alert {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(230, 57, 70, 0.15);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--danger);
            margin-bottom: 0.5rem;
        }

        .forecast-alert.frost {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }

        .forecast-alert.heat {
            background: rgba(244, 162, 97, 0.15);
            color: var(--secondary);
        }

        /* Warnings Bar */
        .warnings-bar {
            background: rgba(230, 57, 70, 0.15);
            border-bottom: 1px solid rgba(230, 57, 70, 0.3);
            padding: 0.75rem 2rem;
            display: none;
        }

        .warnings-bar.visible {
            display: block;
        }

        .warnings-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .warning-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(230, 57, 70, 0.2);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--danger);
            cursor: pointer;
            transition: all 0.2s;
        }

        .warning-item:hover {
            background: rgba(230, 57, 70, 0.3);
        }

        .warning-item.weather {
            background: rgba(233, 196, 106, 0.2);
            color: var(--warning);
        }

        .warning-item i {
            font-size: 0.9rem;
        }

        /* Modal Base Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form Styles in Modal */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row.three {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-light);
        }

        .form-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 1.25rem 0;
        }

        .form-summary {
            background: var(--bg-light);
            border-radius: 10px;
            padding: 1rem;
            font-size: 0.9rem;
        }

        .form-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .form-summary-row .label {
            color: var(--text-secondary);
        }

        .succession-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .succession-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-light);
        }

        .succession-options {
            display: none;
            gap: 1rem;
            align-items: center;
            background: var(--bg-light);
            padding: 1rem;
            border-radius: 10px;
        }

        .succession-options.visible {
            display: flex;
        }

        .succession-options input {
            width: 60px;
        }

        /* Quick Select Buttons for Bed Feet */
        .quick-select-group {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .quick-select-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-select-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .quick-select-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        /* Improved Modal Footer */
        .modal-footer .btn {
            padding: 12px 20px;
            font-size: 0.95rem;
            font-weight: 600;
            min-width: 120px;
        }

        .modal-footer .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            box-shadow: 0 4px 12px rgba(74, 124, 67, 0.3);
        }

        .modal-footer .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(74, 124, 67, 0.4);
        }

        /* Advanced Options Toggle */
        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            user-select: none;
        }

        .advanced-toggle:hover {
            color: var(--text-primary);
        }

        .advanced-toggle i {
            transition: transform 0.2s;
        }

        .advanced-toggle.expanded i {
            transform: rotate(180deg);
        }

        .advanced-options {
            display: none;
            margin-bottom: 1rem;
        }

        .advanced-options.visible {
            display: block;
        }

        /* ========================================
           COMMAND PALETTE (âŒ˜K)
           ======================================== */
        .command-palette-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
        }

        .command-palette-overlay.visible {
            display: flex;
        }

        .command-palette {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 560px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .command-search {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }

        .command-search i {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .command-search input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.1rem;
            outline: none;
        }

        .command-search input::placeholder {
            color: var(--text-secondary);
        }

        .command-search .close-btn {
            background: var(--bg-light);
            border: none;
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .command-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .command-section {
            padding: 0.5rem 0;
        }

        .command-section-title {
            padding: 0.5rem 1.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .command-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .command-item:hover,
        .command-item.selected {
            background: rgba(45, 90, 39, 0.2);
        }

        .command-item i {
            width: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .command-item span {
            flex: 1;
        }

        .command-item .shortcut {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
            background: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .command-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-secondary);
        }

        /* ========================================
           SMART ADD MODAL
           ======================================== */
        .smart-add-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1500;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 8vh;
        }

        .smart-add-overlay.visible {
            display: flex;
        }

        .smart-add-modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 95%;
            max-width: 640px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        .smart-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .smart-add-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .smart-add-header h2 i {
            color: var(--primary-light);
        }

        .smart-add-close {
            background: var(--bg-light);
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .smart-add-close:hover {
            background: var(--danger);
            color: white;
        }

        .smart-add-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Crop Search */
        .crop-search-container {
            margin-bottom: 1.5rem;
        }

        .crop-search-container label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .crop-search-input {
            position: relative;
        }

        .crop-search-input input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            background: var(--bg-light);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.05rem;
            transition: all 0.2s;
        }

        .crop-search-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 90, 39, 0.2);
        }

        .crop-search-input i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .crop-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .crop-search-results.visible {
            display: block;
        }

        .crop-result-item {
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .crop-result-item:hover {
            background: rgba(45, 90, 39, 0.2);
        }

        .crop-result-item .crop-name {
            font-weight: 600;
        }

        .crop-result-item .crop-method {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Recent Crops */
        .recent-crops {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .recent-crop-btn {
            padding: 6px 14px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recent-crop-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
            background: rgba(45, 90, 39, 0.1);
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 1.5rem;
            background: var(--bg-light);
            padding: 4px;
            border-radius: 10px;
        }

        .mode-tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-tab:hover {
            color: var(--text-primary);
        }

        .mode-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Planting Form */
        .smart-form-section {
            margin-bottom: 1.5rem;
        }

        .smart-form-section h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .smart-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .smart-form-grid.three {
            grid-template-columns: repeat(3, 1fr);
        }

        .smart-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .smart-input-group.full {
            grid-column: 1 / -1;
        }

        .smart-input-group label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .smart-input-group input,
        .smart-input-group select {
            padding: 10px 12px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .smart-input-group input:focus,
        .smart-input-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Quantity Quick Select */
        .quantity-quick {
            display: flex;
            gap: 6px;
        }

        .quantity-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .quantity-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .quantity-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Succession Options */
        .succession-panel {
            background: rgba(45, 90, 39, 0.1);
            border: 1px solid rgba(45, 90, 39, 0.3);
            border-radius: 12px;
            padding: 1rem;
            display: none;
        }

        .succession-panel.visible {
            display: block;
        }

        .succession-panel h5 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-light);
        }

        /* Summary Preview */
        .smart-summary {
            background: linear-gradient(135deg, rgba(45, 90, 39, 0.15) 0%, rgba(42, 157, 143, 0.1) 100%);
            border: 1px solid rgba(45, 90, 39, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .smart-summary h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--success);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .summary-item {
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .summary-item .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-item .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .summary-dates {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            font-size: 0.85rem;
        }

        .summary-dates span {
            color: var(--text-secondary);
        }

        .summary-dates strong {
            color: var(--text-primary);
        }

        /* Smart Add Footer */
        .smart-add-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .smart-add-footer .btn-group {
            display: flex;
            gap: 10px;
        }

        .smart-add-footer .btn {
            padding: 12px 24px;
            font-weight: 600;
            border-radius: 10px;
        }

        .smart-add-footer .btn-save-another {
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .smart-add-footer .btn-save-another:hover {
            border-color: var(--primary);
        }

        .smart-add-footer .btn-save {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
        }

        .smart-add-footer .btn-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(45, 90, 39, 0.4);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        .top-bar {
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .page-title .subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .top-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(45, 90, 39, 0.4);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* Content Area */
        .content-area {
            padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.green { background: rgba(42, 157, 143, 0.2); color: var(--success); }
        .stat-icon.orange { background: rgba(244, 162, 97, 0.2); color: var(--secondary); }
        .stat-icon.blue { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .stat-icon.purple { background: rgba(155, 89, 182, 0.2); color: #9b59b6; }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .stat-trend {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .stat-trend.up { background: rgba(42, 157, 143, 0.2); color: var(--success); }
        .stat-trend.down { background: rgba(230, 57, 70, 0.2); color: var(--danger); }

        /* ========================================
           OVERDUE TASKS - Warning Section
           ======================================== */
        .overdue-tasks {
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.1), rgba(230, 57, 70, 0.05));
            border-radius: 16px;
            border: 2px solid rgba(230, 57, 70, 0.3);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .overdue-tasks.visible {
            display: block;
        }

        .overdue-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .overdue-tasks-header h3 {
            font-size: 1.15rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            color: var(--danger);
        }

        .overdue-tasks-header h3 i {
            font-size: 1.1rem;
        }

        .overdue-count-badge {
            background: var(--danger);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .overdue-action-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: rgba(230, 57, 70, 0.1);
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .overdue-select-all {
            padding: 8px 14px;
            border-radius: 8px;
            border: 2px solid rgba(230, 57, 70, 0.3);
            background: transparent;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .overdue-select-all:hover {
            border-color: var(--danger);
        }

        .overdue-select-all.selected {
            border-color: var(--danger);
            background: var(--danger);
            color: white;
        }

        .overdue-selected-count {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .overdue-complete-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            background: var(--danger);
            color: white;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .overdue-complete-btn:hover:not(:disabled) {
            background: #c92a36;
        }

        .overdue-complete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .overdue-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .overdue-item {
            display: grid;
            grid-template-columns: 44px 1fr auto auto auto;
            gap: 12px;
            align-items: center;
            padding: 12px 14px;
            background: rgba(26, 26, 46, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(230, 57, 70, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        .overdue-item:hover {
            border-color: rgba(230, 57, 70, 0.4);
        }

        .overdue-item.selected {
            border-color: var(--danger);
            background: rgba(230, 57, 70, 0.15);
        }

        .overdue-checkbox {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: 2px solid rgba(230, 57, 70, 0.4);
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .overdue-checkbox i {
            font-size: 1.2rem;
            color: white;
            opacity: 0;
        }

        .overdue-item.selected .overdue-checkbox {
            border-color: var(--danger);
            background: var(--danger);
        }

        .overdue-item.selected .overdue-checkbox i {
            opacity: 1;
        }

        .overdue-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .overdue-crop {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .overdue-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .overdue-days-badge {
            background: rgba(230, 57, 70, 0.2);
            color: var(--danger);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .overdue-quantity {
            font-weight: 600;
            font-size: 0.9rem;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }

        .overdue-complete-single {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: none;
            background: var(--danger);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .overdue-complete-single:hover {
            background: #c92a36;
            transform: scale(1.05);
        }

        /* Today's Tasks Section */
        /* ========================================
           TODAY'S WORK - Frictionless Task Completion
           ======================================== */
        .todays-tasks {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .todays-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .todays-tasks-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        .todays-tasks-header h3 i {
            color: var(--secondary);
            font-size: 1.1rem;
        }

        .todays-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Bulk Action Bar */
        .task-action-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-light);
            border-radius: 12px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .select-all-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .select-all-btn:hover {
            border-color: var(--primary);
            background: rgba(74, 124, 67, 0.1);
        }

        .select-all-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .task-action-bar .divider {
            width: 1px;
            height: 32px;
            background: var(--border);
        }

        .selected-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
            flex: 1;
        }

        .selected-count strong {
            color: var(--primary);
        }

        .bulk-complete-btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(74, 124, 67, 0.3);
        }

        .bulk-complete-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 124, 67, 0.4);
        }

        .bulk-complete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .bulk-complete-btn i {
            font-size: 1.1rem;
        }

        /* Task Groups */
        .task-group {
            margin-bottom: 1rem;
        }

        .task-group:last-child {
            margin-bottom: 0;
        }

        .task-group-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .task-group-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .task-group-icon.gh-sow { background: rgba(74, 124, 67, 0.2); color: #4a7c43; }
        .task-group-icon.transplant { background: rgba(42, 157, 143, 0.2); color: #2a9d8f; }
        .task-group-icon.direct-seed { background: rgba(233, 196, 106, 0.2); color: #b89b3e; }

        .task-group-title {
            font-weight: 700;
            font-size: 0.95rem;
            flex: 1;
        }

        .task-group-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: rgba(255,255,255,0.05);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .task-group-select-all {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-group-select-all:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        /* Task Items - Bigger, Touch-Friendly */
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            display: grid;
            grid-template-columns: 48px 1fr auto auto;
            gap: 12px;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-light);
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .task-item:hover {
            border-color: rgba(74, 124, 67, 0.3);
            background: rgba(74, 124, 67, 0.05);
        }

        .task-item.selected {
            border-color: var(--primary);
            background: rgba(74, 124, 67, 0.1);
        }

        .task-item.completed {
            opacity: 0.5;
            background: rgba(42, 157, 143, 0.1);
            border-color: transparent;
        }

        .task-item.completing {
            animation: taskComplete 0.5s ease-out;
        }

        @keyframes taskComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); background: rgba(42, 157, 143, 0.2); }
            100% { transform: scale(1); }
        }

        /* Big Checkbox */
        .task-checkbox {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 3px solid var(--border);
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .task-checkbox:hover {
            border-color: var(--primary);
            background: rgba(74, 124, 67, 0.1);
        }

        .task-checkbox.checked {
            border-color: var(--primary);
            background: var(--primary);
        }

        .task-checkbox i {
            font-size: 1.4rem;
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-checkbox.checked i {
            opacity: 1;
        }

        .task-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .task-crop {
            font-weight: 700;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-details i {
            font-size: 0.75rem;
        }

        .task-quantity {
            font-weight: 700;
            font-size: 1rem;
            padding: 8px 14px;
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            white-space: nowrap;
        }

        /* Individual Complete Button - Big & Touch-Friendly */
        .task-complete-btn {
            min-width: 52px;
            height: 52px;
            border-radius: 12px;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .task-complete-btn:hover:not(:disabled) {
            background: var(--primary-light);
            transform: scale(1.05);
        }

        .task-complete-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .task-complete-btn.done {
            background: var(--success);
        }

        .task-complete-btn:disabled {
            cursor: not-allowed;
        }

        .no-tasks-message {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .no-tasks-message i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--success);
        }

        .no-tasks-message p {
            font-size: 1.1rem;
            margin: 0;
        }

        .no-tasks-message .subtext {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            opacity: 0.7;
        }

        /* Undo Toast */
        .undo-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .undo-toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .undo-toast .undo-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .undo-toast .undo-btn:hover {
            background: var(--primary-light);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .task-action-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .task-action-bar .divider {
                display: none;
            }

            .selected-count {
                text-align: center;
                order: -1;
            }

            .bulk-complete-btn {
                width: 100%;
                justify-content: center;
                padding: 16px 24px;
                font-size: 1.1rem;
            }

            .task-item {
                grid-template-columns: 44px 1fr auto;
                padding: 12px;
            }

            .task-quantity {
                display: none;
            }

            .task-complete-btn {
                min-width: 48px;
                height: 48px;
            }
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 12px;
            border: 1px solid var(--border);
            width: fit-content;
        }

        .view-tab {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-tab:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }

        .view-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Filters Bar */
        .filters-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .filter-group select {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            min-width: 150px;
        }

        .search-box {
            flex: 1;
            max-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .search-box i {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* View Content */
        .view-content {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .view-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-header h2 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .view-header h2 i {
            color: var(--secondary);
        }

        .view-header .count {
            background: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        /* Nursery List */
        .nursery-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .nursery-item {
            display: grid;
            grid-template-columns: 80px 1fr 120px 100px 100px 80px;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            transition: background 0.2s;
        }

        .nursery-item:hover {
            background: rgba(255,255,255,0.02);
        }

        .nursery-date {
            text-align: center;
        }

        .nursery-date .day {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-light);
        }

        .nursery-date .month {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .nursery-crop {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nursery-crop .icon {
            font-size: 1.5rem;
        }

        .nursery-crop .info {
            display: flex;
            flex-direction: column;
        }

        .nursery-crop .name {
            font-weight: 600;
        }

        .nursery-crop .variety {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .nursery-bed {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .nursery-bed i {
            color: var(--primary-light);
        }

        .nursery-trays {
            text-align: center;
        }

        .nursery-trays .count {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .nursery-trays .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .nursery-status {
            text-align: center;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.planned { background: rgba(45, 90, 39, 0.2); color: var(--primary-light); }
        .status-badge.sown { background: rgba(142, 68, 173, 0.2); color: #9b59b6; }
        .status-badge.ready { background: rgba(244, 162, 97, 0.2); color: var(--secondary); }
        .status-badge.transplanted { background: rgba(52, 152, 219, 0.2); color: #3498db; }

        .nursery-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-light);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
        }

        .action-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .nursery-item:hover .action-hint {
            opacity: 1;
            color: var(--primary-light);
        }

        /* Crop Summary Cards */
        .crop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
        }

        .crop-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .crop-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
        }

        .crop-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1rem;
        }

        .crop-card-icon {
            font-size: 2rem;
        }

        .crop-card-title {
            flex: 1;
        }

        .crop-card-title h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .crop-card-title .varieties {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .crop-card-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            text-align: center;
        }

        .crop-stat {
            background: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .crop-stat .value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .crop-stat .label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 4rem;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            color: var(--primary-light);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: -100px;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transition: bottom 0.3s;
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show { bottom: 2rem; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 70px; }
            .sidebar .nav-item span,
            .sidebar .nav-section-title,
            .sidebar .logo-text,
            .sidebar-footer { display: none; }
            .sidebar .nav-item { justify-content: center; padding: 1rem; }
            .main-content { margin-left: 70px; }
            .nursery-item { grid-template-columns: 60px 1fr 80px 80px; }
            .nursery-bed, .nursery-actions { display: none; }
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .nursery-item { grid-template-columns: 1fr; gap: 0.5rem; }
        }
    </style>
</head>
<body>
    <!-- Authentication Check - Redirect to login if no valid session -->
    <script>
        (function() {
            const SESSION_KEY = 'tinyseed_session';
            const session = localStorage.getItem(SESSION_KEY);

            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const data = JSON.parse(session);
                // Check if session is less than 24 hours old
                if (!data.timestamp || (Date.now() - data.timestamp) > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem(SESSION_KEY);
                    window.location.href = 'login.html';
                    return;
                }

                // Store user info globally for use in page
                window.currentUser = {
                    userId: data.userId,
                    username: data.username,
                    fullName: data.fullName,
                    role: data.role
                };
            } catch (e) {
                localStorage.removeItem(SESSION_KEY);
                window.location.href = 'login.html';
            }
        })();
    </script>

    <!-- Left Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-seedling"></i></div>
                <span class="logo-text">Tiny Seed OS</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <!-- Primary Add Action -->
            <div class="nav-section">
                <a class="nav-item nav-item-primary" onclick="openSmartAdd()">
                    <i class="fas fa-plus"></i>
                    <span>Add Planting</span>
                </a>
            </div>

            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-section-title">Today</div>
                <a class="nav-item active" href="index.html">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                    <span class="badge" id="tasksBadge" style="display: none;">0</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Plan</div>
                <a class="nav-item" href="calendar.html">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
                <a class="nav-item" href="planning.html">
                    <i class="fas fa-table"></i>
                    <span>Planning Grid</span>
                </a>
                <a class="nav-item" href="succession.html">
                    <i class="fas fa-layer-group"></i>
                    <span>Succession Wizard</span>
                </a>
                <a class="nav-item" href="bed_assignment_COMPLETE.html">
                    <i class="fas fa-th-large"></i>
                    <span>Bed Assignment</span>
                </a>
                <a class="nav-item" href="web_app/field-planner.html">
                    <i class="fas fa-map"></i>
                    <span>Field Planner</span>
                </a>
                <a class="nav-item" href="gantt_FINAL.html">
                    <i class="fas fa-project-diagram"></i>
                    <span>Gantt - Fields</span>
                </a>
                <a class="nav-item" href="gantt_CROP_VIEW_FINAL.html">
                    <i class="fas fa-chart-bar"></i>
                    <span>Gantt - Crops</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Grow</div>
                <a class="nav-item" href="greenhouse.html">
                    <i class="fas fa-seedling"></i>
                    <span>Greenhouse</span>
                </a>
                <a class="nav-item" href="seed_inventory_PRODUCTION.html">
                    <i class="fas fa-boxes"></i>
                    <span>Seed Inventory</span>
                </a>
                <a class="nav-item" href="flowers.html">
                    <i class="fas fa-spa"></i>
                    <span>Flower Operations</span>
                </a>
                <a class="nav-item" href="labels.html">
                    <i class="fas fa-tag"></i>
                    <span>Labels</span>
                </a>
                <a class="nav-item" href="greenhouse_labels_PRODUCTION (1).html">
                    <i class="fas fa-tags"></i>
                    <span>GH Labels</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Operations</div>
                <a class="nav-item" href="farm-operations.html">
                    <i class="fas fa-tractor"></i>
                    <span>Farm Operations</span>
                </a>
                <a class="nav-item" href="track.html">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Tracking</span>
                </a>
                <a class="nav-item" href="field_app_mobile.html">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Field Kiosk</span>
                </a>
                <a class="nav-item" href="smart_learning_DTM.html">
                    <i class="fas fa-brain"></i>
                    <span>DTM Learning</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Sales & Marketing</div>
                <a class="nav-item" href="web_app/sales.html">
                    <i class="fas fa-chart-line"></i>
                    <span>Sales Dashboard</span>
                </a>
                <a class="nav-item" href="web_app/marketing-command-center.html">
                    <i class="fas fa-bullhorn"></i>
                    <span>Marketing Center</span>
                </a>
                <a class="nav-item" href="web_app/driver.html">
                    <i class="fas fa-truck"></i>
                    <span>Driver App</span>
                </a>
                <a class="nav-item" href="web_app/customer.html">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Customer Portal</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Team</div>
                <a class="nav-item" href="employee.html">
                    <i class="fas fa-user-clock"></i>
                    <span>Employee App</span>
                </a>
            </div>

            <div class="nav-section" data-role="Admin">
                <div class="nav-section-title">Finance</div>
                <a class="nav-item" href="web_app/wealth-builder.html">
                    <i class="fas fa-chart-pie"></i>
                    <span>Wealth Builder</span>
                    <span class="badge success">NEW</span>
                </a>
                <a class="nav-item" href="web_app/financial-dashboard.html">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Financial Dashboard</span>
                </a>
            </div>

            <div class="nav-section" data-role="Admin">
                <div class="nav-section-title">Admin</div>
                <a class="nav-item" href="web_app/admin.html">
                    <i class="fas fa-user-shield"></i>
                    <span>Admin Panel</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">More</div>
                <a class="nav-item" href="sowing-sheets.html">
                    <i class="fas fa-print"></i>
                    <span>Task Sheets</span>
                </a>
                <a class="nav-item" href="soil-tests.html">
                    <i class="fas fa-flask"></i>
                    <span>Soil & Compliance</span>
                </a>
                <a class="nav-item" href="web_app/index.html">
                    <i class="fas fa-th"></i>
                    <span>All Apps</span>
                </a>
                <a class="nav-item" onclick="openSettings()">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>

            <!-- Command Palette Trigger -->
            <div class="nav-section" style="margin-top: auto;">
                <a class="nav-item nav-item-command" onclick="openCommandPalette()">
                    <i class="fas fa-search"></i>
                    <span>Search</span>
                    <span class="kbd-hint">âŒ˜K</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info" style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 36px; height: 36px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;" id="userAvatar">A</div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="userName">User</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);" id="userRole">Role</div>
                    </div>
                    <button onclick="logout()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 6px;" title="Sign Out">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <div class="page-title">
                <div>
                    <h1 id="pageTitle">Dashboard</h1>
                    <div class="subtitle" id="pageSubtitle">Your farm at a glance</div>
                </div>
            </div>
            <div class="top-actions">
                <!-- Filter chips for viewing plantings -->
                <div class="filter-chips" style="display: flex; gap: 6px; margin-right: 1rem;">
                    <button class="filter-chip active" onclick="setFilter('all')" data-filter="all">All</button>
                    <button class="filter-chip" onclick="setFilter('upcoming')" data-filter="upcoming">Upcoming</button>
                    <button class="filter-chip" onclick="setFilter('greenhouse')" data-filter="greenhouse">In GH</button>
                    <button class="filter-chip" onclick="setFilter('field')" data-filter="field">In Field</button>
                </div>
                <button class="btn btn-secondary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Welcome & Weather Banner -->
        <div class="welcome-banner">
            <div class="welcome-content">
                <div class="welcome-text">
                    <h2 id="welcomeGreeting">Good morning!</h2>
                    <div class="date-time" id="currentDateTime">Monday, January 13, 2026</div>
                </div>
                <div class="weather-info" onclick="toggleForecast(event)" style="position: relative;">
                    <div class="weather-current">
                        <i class="fas fa-sun weather-icon" id="weatherIcon"></i>
                        <div>
                            <div class="weather-temp" id="weatherTemp">--Â°F</div>
                            <div class="weather-desc" id="weatherDesc">Loading...</div>
                        </div>
                    </div>
                    <div class="weather-details">
                        <span><i class="fas fa-tint"></i> <span id="weatherHumidity">--%</span></span>
                        <span><i class="fas fa-wind"></i> <span id="weatherWind">-- mph</span></span>
                    </div>
                    <div class="click-hint">Click for 5-day forecast</div>

                    <!-- Forecast Popup -->
                    <div class="forecast-popup" id="forecastPopup">
                        <div class="forecast-header">
                            <h4><i class="fas fa-calendar-week"></i> 5-Day Forecast</h4>
                            <button class="forecast-close" onclick="closeForecast(event)">&times;</button>
                        </div>
                        <div class="forecast-days" id="forecastDays">
                            <div class="loading" style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                                <i class="fas fa-spinner fa-spin"></i> Loading forecast...
                            </div>
                        </div>
                        <div class="forecast-alerts" id="forecastAlerts"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Warnings Bar -->
        <div class="warnings-bar" id="warningsBar">
            <div class="warnings-list" id="warningsList">
                <!-- Warnings populated dynamically -->
            </div>
        </div>

        <div class="content-area">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="statActive">--</div>
                        <div class="stat-label">Active Plantings</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="statTasks">--</div>
                        <div class="stat-label">Tasks This Week</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-basket-shopping"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="statHarvest">--</div>
                        <div class="stat-label">Harvest Ready</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="statUtilization">--%</div>
                        <div class="stat-label">Bed Utilization</div>
                    </div>
                </div>
            </div>

            <!-- Overdue Tasks - Warning Section -->
            <div class="overdue-tasks" id="overdueTasks">
                <div class="overdue-tasks-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Overdue Tasks</h3>
                    <span class="overdue-count-badge" id="overdueCountBadge">0 tasks</span>
                </div>
                <div class="overdue-action-bar">
                    <button class="overdue-select-all" id="overdueSelectAll" onclick="toggleOverdueSelectAll()">
                        <i class="far fa-square"></i> Select All
                    </button>
                    <span class="overdue-selected-count" id="overdueSelectedCount"><strong>0</strong> selected</span>
                    <button class="overdue-complete-btn" id="overdueCompleteBtn" onclick="completeSelectedOverdue()" disabled>
                        <i class="fas fa-check-double"></i> Complete Selected
                    </button>
                </div>
                <div class="overdue-list" id="overdueList"></div>
            </div>

            <!-- Today's Work - Frictionless Task Completion -->
            <div class="todays-tasks" id="todaysTasks">
                <div class="todays-tasks-header">
                    <h3><i class="fas fa-clipboard-check"></i> Today's Work</h3>
                    <span class="todays-date" id="todaysDate"></span>
                </div>
                <div class="task-action-bar" id="taskActionBar" style="display: none;">
                    <button class="select-all-btn" id="selectAllBtn" onclick="toggleSelectAll()">
                        <i class="far fa-square"></i> Select All
                    </button>
                    <div class="divider"></div>
                    <span class="selected-count" id="selectedCount"><strong>0</strong> tasks selected</span>
                    <button class="bulk-complete-btn" id="bulkCompleteBtn" onclick="completeSelectedTasks()" disabled>
                        <i class="fas fa-check-double"></i> Complete Selected
                    </button>
                </div>
                <div class="tasks-list" id="todaysTasksList">
                    <div class="no-tasks-message">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading tasks...</p>
                    </div>
                </div>
            </div>

            <!-- Undo Toast -->
            <div class="undo-toast" id="undoToast">
                <span id="undoMessage">Task completed</span>
                <button class="undo-btn" onclick="undoLastCompletion()">Undo</button>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search crops, batches..." oninput="filterData()">
                    <i class="fas fa-search"></i>
                </div>
                <div class="filter-group">
                    <label>Crop:</label>
                    <select id="cropFilter" onchange="filterData()">
                        <option value="">All Crops</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Variety:</label>
                    <select id="varietyFilter" onchange="filterData()">
                        <option value="">All Varieties</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status:</label>
                    <select id="statusFilter" onchange="filterData()">
                        <option value="">All</option>
                        <option value="Planned">Planned</option>
                        <option value="Sown">Sown</option>
                        <option value="PLANTED">Transplanted</option>
                        <option value="HARVESTING">Harvesting</option>
                    </select>
                </div>
            </div>

            <!-- View Content -->
            <div class="view-content">
                <div class="view-header">
                    <h2>
                        <i class="fas fa-seedling"></i>
                        <span id="viewTitle">Upcoming Sowings & Transplants</span>
                    </h2>
                    <span class="count" id="viewCount">0 plantings</span>
                </div>
                <div id="viewContainer">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading data...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Success!</span>
    </div>

    <!-- Command Palette (âŒ˜K) -->
    <div class="command-palette-overlay" id="commandPalette" onclick="closeCommandPaletteOnOverlay(event)">
        <div class="command-palette" onclick="event.stopPropagation()">
            <div class="command-search">
                <i class="fas fa-search"></i>
                <input type="text" id="commandInput" placeholder="Search or type a command..." autocomplete="off" oninput="filterCommands()">
                <button class="close-btn" onclick="closeCommandPalette()">ESC</button>
            </div>
            <div class="command-results" id="commandResults">
                <div class="command-section">
                    <div class="command-section-title">Actions</div>
                    <div class="command-item" onclick="commandAction('add-planting')">
                        <i class="fas fa-plus"></i>
                        <span>Add new planting</span>
                        <span class="shortcut">âŒ˜N</span>
                    </div>
                    <div class="command-item" onclick="commandAction('log-harvest')">
                        <i class="fas fa-basket-shopping"></i>
                        <span>Log harvest</span>
                    </div>
                    <div class="command-item" onclick="commandAction('complete-task')">
                        <i class="fas fa-check"></i>
                        <span>Complete task</span>
                    </div>
                </div>
                <div class="command-section">
                    <div class="command-section-title">Navigate</div>
                    <div class="command-item" onclick="commandAction('goto-dashboard')">
                        <i class="fas fa-home"></i>
                        <span>Go to Dashboard</span>
                    </div>
                    <div class="command-item" onclick="commandAction('goto-calendar')">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Go to Calendar</span>
                    </div>
                    <div class="command-item" onclick="commandAction('goto-greenhouse')">
                        <i class="fas fa-seedling"></i>
                        <span>Go to Greenhouse</span>
                    </div>
                    <div class="command-item" onclick="commandAction('goto-planning')">
                        <i class="fas fa-table"></i>
                        <span>Go to Planning Grid</span>
                    </div>
                    <div class="command-item" onclick="commandAction('goto-labels')">
                        <i class="fas fa-tag"></i>
                        <span>Go to Labels</span>
                    </div>
                    <div class="command-item" onclick="commandAction('goto-task-sheets')">
                        <i class="fas fa-print"></i>
                        <span>Go to Task Sheets</span>
                    </div>
                </div>
                <div class="command-section">
                    <div class="command-section-title">Search</div>
                    <div class="command-item" onclick="commandAction('search-crop')">
                        <i class="fas fa-leaf"></i>
                        <span>Search by crop...</span>
                    </div>
                    <div class="command-item" onclick="commandAction('search-location')">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Search by location...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Add Planting Modal -->
    <div class="smart-add-overlay" id="smartAddModal" onclick="closeSmartAddOnOverlay(event)">
        <div class="smart-add-modal" onclick="event.stopPropagation()">
            <div class="smart-add-header">
                <h2><i class="fas fa-seedling"></i> Add Planting</h2>
                <button class="smart-add-close" onclick="closeSmartAdd()">&times;</button>
            </div>

            <div class="smart-add-body">
                <!-- Crop Search (Search First UX) -->
                <div class="crop-search-container">
                    <label>What are you planting?</label>
                    <div class="crop-search-input">
                        <i class="fas fa-search"></i>
                        <input type="text" id="smartCropSearch" placeholder="Start typing a crop name..." autocomplete="off" oninput="smartCropSearchHandler()">
                        <div class="crop-search-results" id="smartCropResults"></div>
                    </div>
                    <div class="recent-crops" id="recentCrops">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Selected Crop Display (hidden until crop selected) -->
                <div id="smartFormContent" style="display: none;">
                    <!-- Mode Tabs -->
                    <div class="mode-tabs">
                        <button class="mode-tab active" onclick="setSmartMode('simple')">Simple</button>
                        <button class="mode-tab" onclick="setSmartMode('succession')">+ Successions</button>
                    </div>

                    <!-- Variety Selection -->
                    <div class="smart-form-section">
                        <h4>Variety</h4>
                        <div class="smart-form-grid">
                            <div class="smart-input-group full">
                                <select id="smartVariety" onchange="smartVarietyChange()">
                                    <option value="">Select variety...</option>
                                </select>
                                <input type="text" id="smartNewVariety" placeholder="Enter new variety name..." style="display: none; margin-top: 8px; padding: 10px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- Planting Details -->
                    <div class="smart-form-section">
                        <h4>Details</h4>
                        <div class="smart-form-grid">
                            <div class="smart-input-group">
                                <label>Method</label>
                                <select id="smartMethod" onchange="smartMethodChange()">
                                    <option value="Transplant">Transplant</option>
                                    <option value="Direct Seed">Direct Seed</option>
                                    <option value="Paperpot">Paperpot</option>
                                </select>
                            </div>
                            <div class="smart-input-group" id="smartTrayGroup">
                                <label>Tray Size</label>
                                <select id="smartTray">
                                    <option value="72">72-cell</option>
                                    <option value="128" selected>128-cell</option>
                                    <option value="50">50-cell</option>
                                    <option value="200">200-cell</option>
                                    <option value="264">264-cell (PP)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div class="smart-form-section">
                        <h4>Quantity (Bed Feet)</h4>
                        <div class="quantity-quick">
                            <button type="button" class="quantity-btn" onclick="setSmartQuantity(50)">50</button>
                            <button type="button" class="quantity-btn active" onclick="setSmartQuantity(100)">100</button>
                            <button type="button" class="quantity-btn" onclick="setSmartQuantity(200)">200</button>
                            <button type="button" class="quantity-btn" onclick="setSmartQuantity(300)">300</button>
                        </div>
                        <div class="smart-form-grid" style="margin-top: 10px;">
                            <div class="smart-input-group">
                                <label>Custom Amount</label>
                                <input type="number" id="smartFeet" value="100" min="1" onchange="smartRecalculate()">
                            </div>
                        </div>
                    </div>

                    <!-- Date -->
                    <div class="smart-form-section">
                        <h4>When</h4>
                        <div class="smart-form-grid">
                            <div class="smart-input-group">
                                <label>Date Type</label>
                                <select id="smartDateType">
                                    <option value="transplant">Transplant Date</option>
                                    <option value="harvest">Target Harvest</option>
                                    <option value="ghsow">GH Sow Date</option>
                                    <option value="directsow">Direct Sow Date</option>
                                </select>
                            </div>
                            <div class="smart-input-group">
                                <label>Date</label>
                                <input type="date" id="smartDate" onchange="smartRecalculate()">
                            </div>
                        </div>
                    </div>

                    <!-- Succession Options (hidden by default) -->
                    <div class="succession-panel" id="smartSuccessionPanel">
                        <h5>Succession Settings</h5>
                        <div class="smart-form-grid three">
                            <div class="smart-input-group">
                                <label>Number</label>
                                <input type="number" id="smartSuccessionCount" value="4" min="1" max="52" onchange="smartRecalculate()">
                            </div>
                            <div class="smart-input-group">
                                <label>Every</label>
                                <input type="number" id="smartSuccessionInterval" value="7" min="1" onchange="smartRecalculate()">
                            </div>
                            <div class="smart-input-group">
                                <label>Unit</label>
                                <select id="smartSuccessionUnit" onchange="smartRecalculate()">
                                    <option value="days">Days</option>
                                    <option value="weeks">Weeks</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Preview -->
                    <div class="smart-summary" id="smartSummary">
                        <h4>Summary</h4>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="value" id="summaryPlantings">1</div>
                                <div class="label">Plantings</div>
                            </div>
                            <div class="summary-item">
                                <div class="value" id="summaryFeet">100</div>
                                <div class="label">Total Feet</div>
                            </div>
                            <div class="summary-item">
                                <div class="value" id="summaryTrays">--</div>
                                <div class="label">Trays</div>
                            </div>
                        </div>
                        <div class="summary-dates" id="summaryDates">
                            <span>GH Sow: <strong id="summaryGHSow">--</strong></span>
                            <span>Transplant: <strong id="summaryTransplant">--</strong></span>
                            <span>Harvest: <strong id="summaryHarvest">--</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="smart-add-footer">
                <button class="btn btn-save-another" onclick="smartSaveAndAdd()" style="display: none;" id="btnSaveAnother">
                    <i class="fas fa-plus"></i> Save & Add Another
                </button>
                <div class="btn-group">
                    <button class="btn btn-save-another" onclick="closeSmartAdd()">Cancel</button>
                    <button class="btn btn-save" onclick="smartSave()" id="btnSmartSave" disabled>
                        <i class="fas fa-check"></i> Save Planting
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Plant Modal (Legacy - keeping for reference) -->
    <div class="modal-overlay" id="quickPlantModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-bolt"></i> Quick Plant</h3>
                <button class="modal-close" onclick="closeQuickPlant()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Crop</label>
                        <select id="qpCrop" onchange="qpCropChange()">
                            <option value="">Select crop...</option>
                        </select>
                        <input type="text" id="qpNewCrop" placeholder="Enter new crop name..." style="display: none; margin-top: 6px;">
                    </div>
                    <div class="form-group">
                        <label>Variety</label>
                        <select id="qpVariety" onchange="qpVarietyChange()">
                            <option value="">Select variety...</option>
                        </select>
                        <input type="text" id="qpNewVariety" placeholder="Enter new variety name..." style="display: none; margin-top: 6px;">
                    </div>
                </div>
                <div class="form-row three">
                    <div class="form-group">
                        <label>Method</label>
                        <select id="qpMethod" onchange="qpRecalculate()">
                            <option value="Transplant">Transplant</option>
                            <option value="Direct Seed">Direct Seed</option>
                            <option value="Paperpot">Paperpot</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tray Size</label>
                        <select id="qpTraySize" onchange="qpRecalculate()">
                            <option value="50">50-cell</option>
                            <option value="72">72-cell</option>
                            <option value="98">98-cell</option>
                            <option value="128" selected>128-cell</option>
                            <option value="200">200-cell</option>
                            <option value="264">264-cell (Paperpot)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bed Feet</label>
                        <input type="number" id="qpFeet" value="100" onchange="qpRecalculate(); updateQuickFeetButtons();">
                        <div class="quick-select-group">
                            <button type="button" class="quick-select-btn" onclick="setQuickFeet(50)">50</button>
                            <button type="button" class="quick-select-btn active" onclick="setQuickFeet(100)">100</button>
                            <button type="button" class="quick-select-btn" onclick="setQuickFeet(200)">200</button>
                            <button type="button" class="quick-select-btn" onclick="setQuickFeet(300)">300</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Target Bed</label>
                        <select id="qpBed">
                            <option value="Unassigned">Unassigned</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Type</label>
                        <select id="qpDateType" onchange="qpRecalculate()">
                            <option value="transplant">Sow/Transplant Date</option>
                            <option value="harvest">Target Harvest Date</option>
                            <option value="ghsow">Greenhouse Start Date</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="qpDate" onchange="qpRecalculate()">
                    </div>
                </div>
                <hr class="form-divider">
                <div class="succession-toggle">
                    <input type="checkbox" id="qpSuccessionCheck" onchange="toggleQpSuccession()">
                    <label for="qpSuccessionCheck">Add Successions</label>
                </div>
                <div class="succession-options" id="qpSuccessionOptions">
                    <input type="number" id="qpSuccessionCount" value="4" min="1" max="20" onchange="qpRecalculate()">
                    <span>plantings every</span>
                    <input type="number" id="qpInterval" value="7" min="1" onchange="qpRecalculate()">
                    <select id="qpIntervalUnit" onchange="qpRecalculate()">
                        <option value="days">days</option>
                        <option value="weeks">weeks</option>
                    </select>
                </div>
                <hr class="form-divider">
                <div class="form-summary" id="qpSummary">
                    <div class="form-summary-row">
                        <span class="label">GH Sow:</span>
                        <span id="qpGhSow">--</span>
                    </div>
                    <div class="form-summary-row">
                        <span class="label">Transplant:</span>
                        <span id="qpTransplant">--</span>
                    </div>
                    <div class="form-summary-row">
                        <span class="label">First Harvest:</span>
                        <span id="qpHarvest">--</span>
                    </div>
                    <div class="form-summary-row">
                        <span class="label">Trays Needed:</span>
                        <span id="qpTrays">--</span>
                    </div>
                    <div class="form-summary-row">
                        <span class="label">Seeds Needed:</span>
                        <span id="qpSeeds">--</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQuickPlant()">Cancel</button>
                <button class="btn btn-primary" onclick="saveQuickPlant()">
                    <i class="fas fa-save"></i> Save
                </button>
                <button class="btn btn-primary" onclick="saveQuickPlant(true)">
                    <i class="fas fa-plus"></i> Save & Add Another
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Planting Modal -->
    <div class="modal-overlay" id="editPlantingModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Planting</h3>
                <button class="modal-close" onclick="closeEditPlanting()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editBatchId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Batch ID</label>
                        <input type="text" id="editBatchIdDisplay" readonly style="opacity: 0.7;">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editStatus">
                            <option value="Planned">Planned</option>
                            <option value="Sown">Sown</option>
                            <option value="In GH">In Greenhouse</option>
                            <option value="PLANTED">Transplanted</option>
                            <option value="Growing">Growing</option>
                            <option value="HARVESTING">Harvesting</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Crop</label>
                        <input type="text" id="editCrop" readonly style="opacity: 0.7;">
                    </div>
                    <div class="form-group">
                        <label>Variety</label>
                        <input type="text" id="editVariety" readonly style="opacity: 0.7;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Target Bed</label>
                        <select id="editBed">
                            <option value="Unassigned">Unassigned</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bed Feet</label>
                        <input type="number" id="editFeet" min="1">
                    </div>
                </div>
                <hr class="form-divider">
                <div class="form-row">
                    <div class="form-group">
                        <label>Planned GH Sow</label>
                        <input type="date" id="editPlanGhSow">
                    </div>
                    <div class="form-group">
                        <label>Actual GH Sow</label>
                        <input type="date" id="editActGhSow">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Planned Transplant</label>
                        <input type="date" id="editPlanTransplant">
                    </div>
                    <div class="form-group">
                        <label>Actual Transplant</label>
                        <input type="date" id="editActTransplant">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Trays Needed</label>
                        <input type="number" id="editTrays" min="0">
                    </div>
                    <div class="form-group">
                        <label>Plants Needed</label>
                        <input type="number" id="editPlants" min="0">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditPlanting()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditPlanting()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Settings</h3>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Farm Name</label>
                    <input type="text" id="settingsFarmName" value="Tiny Seed Farm" style="width: 100%; padding: 0.75rem; background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Farm Location</label>
                    <input type="text" id="settingsLocation" value="257 Zeigler Rd, Rochester PA 15074" style="width: 100%; padding: 0.75rem; background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Default Bed Length (ft)</label>
                    <input type="number" id="settingsBedLength" value="100" min="1" style="width: 100%; padding: 0.75rem; background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Weather Location (ZIP)</label>
                    <input type="text" id="settingsWeatherZip" value="15074" style="width: 100%; padding: 0.75rem; background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Notifications</label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="settingsNotifyTasks" checked style="width: 18px; height: 18px; accent-color: var(--primary);">
                        <span>Daily task reminders</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; margin-top: 0.5rem;">
                        <input type="checkbox" id="settingsNotifyWeather" checked style="width: 18px; height: 18px; accent-color: var(--primary);">
                        <span>Weather alerts</span>
                    </label>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">System Info</label>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                            <span>Version</span>
                            <span>1.0.0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                            <span>API Status</span>
                            <span id="settingsApiStatus" style="color: var(--success);">Connected</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbx8syGK5Bm60fypNO0yE60BYtTFJXxviaEtgrqENmF5GStB58UCEA4Shu_IF9r6kjf5/exec';

        // State
        let allPlantings = [];
        let filteredPlantings = [];
        let beds = [];
        let cropProfiles = [];
        let currentView = 'nursery';
        let currentEditPlanting = null;

        // Quick Plant state
        let qpNurseryDays = 28;
        let qpDTM = 45;
        let qpRows = 4;
        let qpSpacing = 8;

        // Today's Work state
        let todaysTasks = [];
        let selectedTasks = new Set();
        let lastCompletedTasks = []; // For undo functionality
        let undoTimeout = null;

        // Overdue Tasks state
        let overdueTasks = [];
        let selectedOverdueTasks = new Set();

        // Smart Add state
        let smartSelectedCrop = null;
        let smartSelectedVariety = null;
        let smartMode = 'simple';
        let recentCrops = ['Lettuce', 'Kale', 'Spinach', 'Tomatoes']; // Will be stored in localStorage

        // Filter state
        let currentFilter = 'all';

        // Crop icons
        const cropIcons = {
            'Lettuce': 'ðŸ¥¬', 'Tomatoes': 'ðŸ…', 'Peppers': 'ðŸ«‘', 'Basil': 'ðŸŒ¿',
            'Kale': 'ðŸ¥—', 'Spinach': 'ðŸƒ', 'Carrots': 'ðŸ¥•', 'Cucumbers': 'ðŸ¥’',
            'Beans': 'ðŸ«˜', 'Squash': 'ðŸŽƒ', 'Onions': 'ðŸ§…', 'Broccoli': 'ðŸ¥¦',
            'Cabbage': 'ðŸ¥¬', 'Beets': 'ðŸŸ£', 'Eggplant': 'ðŸ†', 'Corn': 'ðŸŒ½',
            'Zucchini': 'ðŸ¥’', 'Arugula': 'ðŸ¥¬', 'Chard': 'ðŸ¥¬', 'Fennel': 'ðŸŒ¿',
            'Zinnia': 'ðŸŒ¸', 'Sunflower': 'ðŸŒ»', 'Dahlia': 'ðŸŒº', 'Cosmos': 'ðŸŒ¼',
            'Radishes': 'ðŸ”´', 'Turnips': 'ðŸŸ£', 'Scallions': 'ðŸ§…', 'Parsley': 'ðŸŒ¿'
        };

        // ========================================
        // USER SESSION & LOGOUT
        // ========================================
        function populateUserInfo() {
            if (window.currentUser) {
                const avatar = document.getElementById('userAvatar');
                const name = document.getElementById('userName');
                const role = document.getElementById('userRole');

                if (avatar) avatar.textContent = (window.currentUser.fullName || 'U').charAt(0).toUpperCase();
                if (name) name.textContent = window.currentUser.fullName || window.currentUser.username || 'User';
                if (role) role.textContent = window.currentUser.role || 'User';
            }
        }

        function logout() {
            localStorage.removeItem('tinyseed_session');
            window.location.href = 'login.html';
        }

        // ========================================
        // SETTINGS
        // ========================================
        function openSettings() {
            // Load saved settings from localStorage
            const settings = JSON.parse(localStorage.getItem('tinyseed_settings') || '{}');

            if (settings.farmName) document.getElementById('settingsFarmName').value = settings.farmName;
            if (settings.location) document.getElementById('settingsLocation').value = settings.location;
            if (settings.bedLength) document.getElementById('settingsBedLength').value = settings.bedLength;
            if (settings.weatherZip) document.getElementById('settingsWeatherZip').value = settings.weatherZip;
            if (settings.notifyTasks !== undefined) document.getElementById('settingsNotifyTasks').checked = settings.notifyTasks;
            if (settings.notifyWeather !== undefined) document.getElementById('settingsNotifyWeather').checked = settings.notifyWeather;

            // Update API status
            const statusEl = document.getElementById('settingsApiStatus');
            const isConnected = !document.getElementById('statusDot').classList.contains('error');
            statusEl.textContent = isConnected ? 'Connected' : 'Offline';
            statusEl.style.color = isConnected ? 'var(--success)' : 'var(--danger)';

            document.getElementById('settingsModal').classList.add('visible');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('visible');
        }

        function saveSettings() {
            const settings = {
                farmName: document.getElementById('settingsFarmName').value,
                location: document.getElementById('settingsLocation').value,
                bedLength: document.getElementById('settingsBedLength').value,
                weatherZip: document.getElementById('settingsWeatherZip').value,
                notifyTasks: document.getElementById('settingsNotifyTasks').checked,
                notifyWeather: document.getElementById('settingsNotifyWeather').checked
            };

            localStorage.setItem('tinyseed_settings', JSON.stringify(settings));
            closeSettings();
            showToast('Settings saved successfully', 'success');
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            populateUserInfo();
            updateWelcomeBanner();
            checkConnection();
            loadAllData();
            loadCropProfiles();
            loadWeather();
            initKeyboardShortcuts();
            loadRecentCrops();
        });

        async function checkConnection() {
            try {
                const response = await fetch(`${API_URL}?action=testConnection`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('statusDot').classList.remove('error');
                    document.getElementById('statusText').textContent = 'Connected';
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                document.getElementById('statusDot').classList.add('error');
                document.getElementById('statusText').textContent = 'Offline';
            }
        }

        async function loadAllData() {
            try {
                const [plantingsRes, bedsRes] = await Promise.all([
                    fetch(`${API_URL}?action=getPlanningData`),
                    fetch(`${API_URL}?action=getBeds`)
                ]);

                const plantingsData = await plantingsRes.json();
                const bedsData = await bedsRes.json();

                if (plantingsData.success) {
                    allPlantings = plantingsData.data;
                    populateFilters();
                    updateStats();
                    loadTodaysTasks();
                    filterData();
                    checkTaskWarnings();
                    showToast(`Loaded ${allPlantings.length} plantings`, 'success');
                }

                if (bedsData.success) {
                    beds = bedsData.beds || bedsData.data || [];
                }

            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data', 'error');
            }
        }

        async function refreshData() {
            showToast('Refreshing...', 'info');
            await loadAllData();
        }

        // ========================================
        // STATS
        // ========================================
        function updateStats() {
            const today = new Date();
            const weekFromNow = new Date(today);
            weekFromNow.setDate(today.getDate() + 7);

            // Active plantings (Sown or PLANTED status)
            const active = allPlantings.filter(p =>
                ['Sown', 'PLANTED', 'HARVESTING', 'Growing'].includes(p.STATUS)
            ).length;

            // Tasks this week (sowings + transplants in next 7 days)
            let tasksThisWeek = 0;
            allPlantings.forEach(p => {
                const ghSow = parseDate(p.Plan_GH_Sow);
                const fieldSow = parseDate(p.Plan_Field_Sow);
                const transplant = parseDate(p.Plan_Transplant);

                if (ghSow && ghSow >= today && ghSow <= weekFromNow && !p.Act_GH_Sow) tasksThisWeek++;
                if (fieldSow && fieldSow >= today && fieldSow <= weekFromNow && !p.Act_Field_Sow) tasksThisWeek++;
                if (transplant && transplant >= today && transplant <= weekFromNow && !p.Act_Transplant) tasksThisWeek++;
            });

            // Harvest ready
            const harvestReady = allPlantings.filter(p => p.STATUS === 'HARVESTING').length;

            // Bed utilization
            const totalBeds = beds.length || 190;
            const usedBeds = new Set(allPlantings.filter(p =>
                ['Sown', 'PLANTED', 'HARVESTING'].includes(p.STATUS) && p.Target_Bed_ID
            ).map(p => p.Target_Bed_ID)).size;
            const utilization = Math.round((usedBeds / totalBeds) * 100);

            document.getElementById('statActive').textContent = active;
            document.getElementById('statTasks').textContent = tasksThisWeek;
            document.getElementById('statHarvest').textContent = harvestReady;
            document.getElementById('statUtilization').textContent = utilization + '%';
        }

        // ========================================
        // TODAY'S WORK - Frictionless Task Completion
        // ========================================
        function loadTodaysTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Set today's date display
            const dateEl = document.getElementById('todaysDate');
            if (dateEl) {
                dateEl.textContent = today.toLocaleDateString('en-US', {
                    weekday: 'long', month: 'short', day: 'numeric'
                });
            }

            todaysTasks = [];
            overdueTasks = [];
            selectedTasks.clear();
            selectedOverdueTasks.clear();

            allPlantings.forEach(p => {
                // GH Sowing tasks
                const ghSow = parseDate(p.Plan_GH_Sow);
                if (ghSow && !p.Act_GH_Sow) {
                    const taskData = {
                        id: `${p.Batch_ID}-ghSow`,
                        batchId: p.Batch_ID,
                        type: 'ghSow',
                        crop: p.Crop,
                        variety: p.Variety,
                        quantity: p.Trays_Needed ? `${p.Trays_Needed} trays` : `${p.Plants_Needed || 0} plants`,
                        location: p.GH_Location || 'Greenhouse',
                        completed: false,
                        date: ghSow,
                        daysOverdue: Math.floor((today - ghSow) / (1000 * 60 * 60 * 24))
                    };

                    if (ghSow >= today && ghSow < tomorrow) {
                        todaysTasks.push(taskData);
                    } else if (ghSow < today) {
                        overdueTasks.push(taskData);
                    }
                }

                // Field/Direct Sowing tasks
                const fieldSow = parseDate(p.Plan_Field_Sow);
                if (fieldSow && !p.Act_Field_Sow) {
                    const taskData = {
                        id: `${p.Batch_ID}-directSeed`,
                        batchId: p.Batch_ID,
                        type: 'directSeed',
                        crop: p.Crop,
                        variety: p.Variety,
                        quantity: p.Feet_Used ? `${p.Feet_Used} ft` : `${p.Plants_Needed || 0} plants`,
                        location: p.Target_Bed_ID || 'Field',
                        completed: false,
                        date: fieldSow,
                        daysOverdue: Math.floor((today - fieldSow) / (1000 * 60 * 60 * 24))
                    };

                    if (fieldSow >= today && fieldSow < tomorrow) {
                        todaysTasks.push(taskData);
                    } else if (fieldSow < today) {
                        overdueTasks.push(taskData);
                    }
                }

                // Transplant tasks
                const transplant = parseDate(p.Plan_Transplant);
                if (transplant && !p.Act_Transplant) {
                    const taskData = {
                        id: `${p.Batch_ID}-transplant`,
                        batchId: p.Batch_ID,
                        type: 'transplant',
                        crop: p.Crop,
                        variety: p.Variety,
                        quantity: `${p.Plants_Needed || p.Trays_Needed * 72 || 0} plants`,
                        location: p.Target_Bed_ID || 'Field',
                        completed: false,
                        date: transplant,
                        daysOverdue: Math.floor((today - transplant) / (1000 * 60 * 60 * 24))
                    };

                    if (transplant >= today && transplant < tomorrow) {
                        todaysTasks.push(taskData);
                    } else if (transplant < today) {
                        overdueTasks.push(taskData);
                    }
                }
            });

            // Sort today's tasks by type
            todaysTasks.sort((a, b) => {
                const typeOrder = { ghSow: 0, transplant: 1, directSeed: 2 };
                return typeOrder[a.type] - typeOrder[b.type];
            });

            // Sort overdue by days overdue (most overdue first)
            overdueTasks.sort((a, b) => b.daysOverdue - a.daysOverdue);

            // Render both sections
            renderOverdueTasks();
            renderTodaysTasks();
        }

        // ========================================
        // OVERDUE TASKS
        // ========================================
        function renderOverdueTasks() {
            const container = document.getElementById('overdueTasks');
            const listContainer = document.getElementById('overdueList');
            const countBadge = document.getElementById('overdueCountBadge');

            if (overdueTasks.length === 0) {
                container.classList.remove('visible');
                return;
            }

            container.classList.add('visible');
            countBadge.textContent = `${overdueTasks.length} task${overdueTasks.length !== 1 ? 's' : ''}`;

            listContainer.innerHTML = overdueTasks.map(task => {
                const isSelected = selectedOverdueTasks.has(task.id);
                const typeLabel = task.type === 'ghSow' ? 'GH Sow' :
                                  task.type === 'transplant' ? 'Transplant' : 'Direct Seed';
                const daysText = task.daysOverdue === 1 ? '1 day' : `${task.daysOverdue} days`;

                return `
                    <div class="overdue-item ${isSelected ? 'selected' : ''}"
                         data-task-id="${task.id}"
                         onclick="toggleOverdueSelection('${task.id}')">
                        <div class="overdue-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="overdue-info">
                            <div class="overdue-crop">${task.crop} - ${task.variety}</div>
                            <div class="overdue-details">${typeLabel} â€¢ ${task.location}</div>
                        </div>
                        <div class="overdue-days-badge">${daysText} overdue</div>
                        <div class="overdue-quantity">${task.quantity}</div>
                        <button class="overdue-complete-single" onclick="completeOverdueTask('${task.batchId}', '${task.type}', event)">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                `;
            }).join('');

            updateOverdueSelectionUI();
        }

        function toggleOverdueSelection(taskId) {
            if (selectedOverdueTasks.has(taskId)) {
                selectedOverdueTasks.delete(taskId);
            } else {
                selectedOverdueTasks.add(taskId);
            }

            const taskEl = document.querySelector(`.overdue-item[data-task-id="${taskId}"]`);
            if (taskEl) {
                taskEl.classList.toggle('selected', selectedOverdueTasks.has(taskId));
            }

            updateOverdueSelectionUI();
        }

        function toggleOverdueSelectAll() {
            const allSelected = overdueTasks.every(t => selectedOverdueTasks.has(t.id));

            if (allSelected) {
                selectedOverdueTasks.clear();
            } else {
                overdueTasks.forEach(t => selectedOverdueTasks.add(t.id));
            }

            renderOverdueTasks();
        }

        function updateOverdueSelectionUI() {
            const selectAllBtn = document.getElementById('overdueSelectAll');
            const selectedCountEl = document.getElementById('overdueSelectedCount');
            const completeBtn = document.getElementById('overdueCompleteBtn');

            const selectedCount = selectedOverdueTasks.size;
            const allSelected = overdueTasks.length > 0 && overdueTasks.every(t => selectedOverdueTasks.has(t.id));

            if (selectAllBtn) {
                if (allSelected) {
                    selectAllBtn.classList.add('selected');
                    selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Deselect All';
                } else {
                    selectAllBtn.classList.remove('selected');
                    selectAllBtn.innerHTML = '<i class="far fa-square"></i> Select All';
                }
            }

            if (selectedCountEl) {
                selectedCountEl.innerHTML = `<strong>${selectedCount}</strong> selected`;
            }

            if (completeBtn) {
                completeBtn.disabled = selectedCount === 0;
                completeBtn.innerHTML = selectedCount > 0
                    ? `<i class="fas fa-check-double"></i> Complete ${selectedCount}`
                    : `<i class="fas fa-check-double"></i> Complete Selected`;
            }
        }

        async function completeSelectedOverdue() {
            if (selectedOverdueTasks.size === 0) return;

            const completeBtn = document.getElementById('overdueCompleteBtn');
            completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Completing...';
            completeBtn.disabled = true;

            const tasksToComplete = Array.from(selectedOverdueTasks).map(id =>
                overdueTasks.find(t => t.id === id)
            ).filter(Boolean);

            lastCompletedTasks = tasksToComplete.map(t => ({...t, wasOverdue: true}));

            let successCount = 0;
            const today = new Date().toISOString().split('T')[0];

            for (const task of tasksToComplete) {
                try {
                    let updateField = '';
                    if (task.type === 'ghSow') updateField = 'Act_GH_Sow';
                    else if (task.type === 'directSeed') updateField = 'Act_Field_Sow';
                    else if (task.type === 'transplant') updateField = 'Act_Transplant';

                    const params = new URLSearchParams({
                        action: 'updatePlanting',
                        batchId: task.batchId,
                        [updateField]: today
                    });

                    const response = await fetch(`${API_URL}?${params}`);
                    const result = await response.json();

                    if (result.success) {
                        successCount++;
                        const planting = allPlantings.find(p => p.Batch_ID === task.batchId);
                        if (planting) {
                            planting[updateField] = today;
                        }
                    }
                } catch (error) {
                    console.error('Error completing overdue task:', error);
                }
            }

            selectedOverdueTasks.clear();
            loadTodaysTasks();
            updateStats();

            if (successCount > 0) {
                showUndoToast(`${successCount} overdue task${successCount !== 1 ? 's' : ''} completed`);
            }
        }

        async function completeOverdueTask(batchId, taskType, event) {
            if (event) event.stopPropagation();

            const taskItem = document.querySelector(`.overdue-item[data-task-id="${batchId}-${taskType}"]`);
            const btn = taskItem?.querySelector('.overdue-complete-single');

            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            try {
                let updateField = '';
                if (taskType === 'ghSow') updateField = 'Act_GH_Sow';
                else if (taskType === 'directSeed') updateField = 'Act_Field_Sow';
                else if (taskType === 'transplant') updateField = 'Act_Transplant';

                const today = new Date().toISOString().split('T')[0];

                const params = new URLSearchParams({
                    action: 'updatePlanting',
                    batchId: batchId,
                    [updateField]: today
                });

                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();

                if (result.success) {
                    const task = overdueTasks.find(t => t.batchId === batchId && t.type === taskType);
                    if (task) {
                        lastCompletedTasks = [{...task, wasOverdue: true}];
                    }

                    const planting = allPlantings.find(p => p.Batch_ID === batchId);
                    if (planting) {
                        planting[updateField] = today;
                    }

                    selectedOverdueTasks.delete(`${batchId}-${taskType}`);
                    loadTodaysTasks();
                    updateStats();
                    showUndoToast('Overdue task completed');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error completing overdue task:', error);
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                }
                showToast('Error completing task', 'error');
            }
        }

        function renderTodaysTasks() {
            const container = document.getElementById('todaysTasksList');
            const actionBar = document.getElementById('taskActionBar');
            const incompleteTasks = todaysTasks.filter(t => !t.completed);

            // Show/hide action bar based on tasks
            if (actionBar) {
                actionBar.style.display = incompleteTasks.length > 0 ? 'flex' : 'none';
            }

            if (todaysTasks.length === 0) {
                container.innerHTML = `
                    <div class="no-tasks-message">
                        <i class="fas fa-check-circle"></i>
                        <p>No tasks scheduled for today!</p>
                        <p class="subtext">Enjoy your day or plan ahead</p>
                    </div>
                `;
                return;
            }

            // Check if all tasks are completed
            if (incompleteTasks.length === 0) {
                container.innerHTML = `
                    <div class="no-tasks-message">
                        <i class="fas fa-trophy"></i>
                        <p>All tasks completed!</p>
                        <p class="subtext">Great work today</p>
                    </div>
                `;
                return;
            }

            // Group tasks by type
            const groups = {
                ghSow: { title: 'Greenhouse Sowing', icon: 'fa-seedling', class: 'gh-sow', tasks: [] },
                transplant: { title: 'Transplanting', icon: 'fa-exchange-alt', class: 'transplant', tasks: [] },
                directSeed: { title: 'Direct Seeding', icon: 'fa-tractor', class: 'direct-seed', tasks: [] }
            };

            incompleteTasks.forEach(task => {
                if (groups[task.type]) {
                    groups[task.type].tasks.push(task);
                }
            });

            let html = '';

            for (const [type, group] of Object.entries(groups)) {
                if (group.tasks.length === 0) continue;

                html += `
                    <div class="task-group" data-type="${type}">
                        <div class="task-group-header">
                            <div class="task-group-icon ${group.class}">
                                <i class="fas ${group.icon}"></i>
                            </div>
                            <span class="task-group-title">${group.title}</span>
                            <span class="task-group-count">${group.tasks.length}</span>
                            <button class="task-group-select-all" onclick="selectGroupTasks('${type}')">
                                Select All
                            </button>
                        </div>
                        <div class="tasks-list">
                            ${group.tasks.map(task => renderTaskItem(task)).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            updateSelectionUI();
        }

        function renderTaskItem(task) {
            const isSelected = selectedTasks.has(task.id);
            return `
                <div class="task-item ${isSelected ? 'selected' : ''} ${task.completed ? 'completed' : ''}"
                     data-task-id="${task.id}"
                     data-batch-id="${task.batchId}"
                     data-type="${task.type}"
                     onclick="toggleTaskSelection('${task.id}', event)">
                    <div class="task-checkbox ${isSelected ? 'checked' : ''}" onclick="toggleTaskSelection('${task.id}', event)">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="task-info">
                        <div class="task-crop">${task.crop} - ${task.variety}</div>
                        <div class="task-details">
                            <i class="fas fa-map-marker-alt"></i> ${task.location}
                        </div>
                    </div>
                    <div class="task-quantity">${task.quantity}</div>
                    <button class="task-complete-btn ${task.completed ? 'done' : ''}"
                            onclick="completeTask('${task.batchId}', '${task.type}', event)"
                            ${task.completed ? 'disabled' : ''}>
                        <i class="fas ${task.completed ? 'fa-check' : 'fa-check'}"></i>
                    </button>
                </div>
            `;
        }

        function toggleTaskSelection(taskId, event) {
            if (event) {
                event.stopPropagation();
            }

            // Don't select completed tasks
            const task = todaysTasks.find(t => t.id === taskId);
            if (task && task.completed) return;

            if (selectedTasks.has(taskId)) {
                selectedTasks.delete(taskId);
            } else {
                selectedTasks.add(taskId);
            }

            updateSelectionUI();

            // Update visual state of the specific task
            const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskEl) {
                const checkbox = taskEl.querySelector('.task-checkbox');
                if (selectedTasks.has(taskId)) {
                    taskEl.classList.add('selected');
                    checkbox.classList.add('checked');
                } else {
                    taskEl.classList.remove('selected');
                    checkbox.classList.remove('checked');
                }
            }
        }

        function toggleSelectAll() {
            const incompleteTasks = todaysTasks.filter(t => !t.completed);
            const allSelected = incompleteTasks.every(t => selectedTasks.has(t.id));

            if (allSelected) {
                selectedTasks.clear();
            } else {
                incompleteTasks.forEach(t => selectedTasks.add(t.id));
            }

            renderTodaysTasks();
        }

        function selectGroupTasks(type) {
            const groupTasks = todaysTasks.filter(t => t.type === type && !t.completed);
            const allSelected = groupTasks.every(t => selectedTasks.has(t.id));

            groupTasks.forEach(t => {
                if (allSelected) {
                    selectedTasks.delete(t.id);
                } else {
                    selectedTasks.add(t.id);
                }
            });

            renderTodaysTasks();
        }

        function updateSelectionUI() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const selectedCountEl = document.getElementById('selectedCount');
            const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');

            const incompleteTasks = todaysTasks.filter(t => !t.completed);
            const selectedCount = selectedTasks.size;
            const allSelected = incompleteTasks.length > 0 && incompleteTasks.every(t => selectedTasks.has(t.id));

            if (selectAllBtn) {
                if (allSelected) {
                    selectAllBtn.classList.add('selected');
                    selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Deselect All';
                } else {
                    selectAllBtn.classList.remove('selected');
                    selectAllBtn.innerHTML = '<i class="far fa-square"></i> Select All';
                }
            }

            if (selectedCountEl) {
                selectedCountEl.innerHTML = `<strong>${selectedCount}</strong> task${selectedCount !== 1 ? 's' : ''} selected`;
            }

            if (bulkCompleteBtn) {
                bulkCompleteBtn.disabled = selectedCount === 0;
                bulkCompleteBtn.innerHTML = selectedCount > 0
                    ? `<i class="fas fa-check-double"></i> Complete ${selectedCount} Task${selectedCount !== 1 ? 's' : ''}`
                    : `<i class="fas fa-check-double"></i> Complete Selected`;
            }
        }

        async function completeSelectedTasks() {
            if (selectedTasks.size === 0) return;

            const bulkBtn = document.getElementById('bulkCompleteBtn');
            const originalText = bulkBtn.innerHTML;
            bulkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Completing...';
            bulkBtn.disabled = true;

            const tasksToComplete = Array.from(selectedTasks).map(id =>
                todaysTasks.find(t => t.id === id)
            ).filter(Boolean);

            // Store for undo
            lastCompletedTasks = tasksToComplete.map(t => ({...t}));

            let successCount = 0;
            const today = new Date().toISOString().split('T')[0];

            for (const task of tasksToComplete) {
                try {
                    let updateField = '';
                    if (task.type === 'ghSow') updateField = 'Act_GH_Sow';
                    else if (task.type === 'directSeed') updateField = 'Act_Field_Sow';
                    else if (task.type === 'transplant') updateField = 'Act_Transplant';

                    const params = new URLSearchParams({
                        action: 'updatePlanting',
                        batchId: task.batchId,
                        [updateField]: today
                    });

                    const response = await fetch(`${API_URL}?${params}`);
                    const result = await response.json();

                    if (result.success) {
                        task.completed = true;
                        successCount++;

                        // Update local planting data
                        const planting = allPlantings.find(p => p.Batch_ID === task.batchId);
                        if (planting) {
                            planting[updateField] = today;
                            if (task.type === 'transplant') planting.STATUS = 'PLANTED';
                            else if (task.type === 'ghSow') planting.STATUS = 'Sown';
                        }
                    }
                } catch (error) {
                    console.error('Error completing task:', task.id, error);
                }
            }

            selectedTasks.clear();
            renderTodaysTasks();
            updateStats();

            if (successCount > 0) {
                showUndoToast(`${successCount} task${successCount !== 1 ? 's' : ''} completed`);
            }

            bulkBtn.innerHTML = originalText;
        }

        async function completeTask(batchId, taskType, event) {
            if (event) {
                event.stopPropagation();
            }

            const taskItem = document.querySelector(`[data-batch-id="${batchId}"][data-type="${taskType}"]`);
            const btn = taskItem?.querySelector('.task-complete-btn');

            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            }

            if (taskItem) {
                taskItem.classList.add('completing');
            }

            try {
                let updateField = '';
                if (taskType === 'ghSow') updateField = 'Act_GH_Sow';
                else if (taskType === 'directSeed') updateField = 'Act_Field_Sow';
                else if (taskType === 'transplant') updateField = 'Act_Transplant';

                const today = new Date().toISOString().split('T')[0];

                const params = new URLSearchParams({
                    action: 'updatePlanting',
                    batchId: batchId,
                    [updateField]: today
                });

                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();

                if (result.success) {
                    // Store for undo
                    const task = todaysTasks.find(t => t.batchId === batchId && t.type === taskType);
                    if (task) {
                        lastCompletedTasks = [{...task}];
                        task.completed = true;
                    }

                    // Update local planting data
                    const planting = allPlantings.find(p => p.Batch_ID === batchId);
                    if (planting) {
                        planting[updateField] = today;
                        if (taskType === 'transplant') planting.STATUS = 'PLANTED';
                        else if (taskType === 'ghSow') planting.STATUS = 'Sown';
                    }

                    // Remove from selection if selected
                    const taskId = `${batchId}-${taskType}`;
                    selectedTasks.delete(taskId);

                    renderTodaysTasks();
                    updateStats();

                    const taskName = taskType === 'ghSow' ? 'Sowing' :
                                    taskType === 'transplant' ? 'Transplant' : 'Direct seed';
                    showUndoToast(`${taskName} completed`);
                } else {
                    throw new Error(result.error || 'Failed to update');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    btn.disabled = false;
                }
                if (taskItem) {
                    taskItem.classList.remove('completing');
                }
                showToast('Error completing task', 'error');
            }
        }

        function showUndoToast(message) {
            const toast = document.getElementById('undoToast');
            const messageEl = document.getElementById('undoMessage');

            if (toast && messageEl) {
                messageEl.textContent = message;
                toast.classList.add('visible');

                // Clear existing timeout
                if (undoTimeout) {
                    clearTimeout(undoTimeout);
                }

                // Auto-hide after 5 seconds
                undoTimeout = setTimeout(() => {
                    toast.classList.remove('visible');
                    lastCompletedTasks = [];
                }, 5000);
            }
        }

        async function undoLastCompletion() {
            const toast = document.getElementById('undoToast');
            toast.classList.remove('visible');

            if (lastCompletedTasks.length === 0) return;

            for (const task of lastCompletedTasks) {
                try {
                    let updateField = '';
                    if (task.type === 'ghSow') updateField = 'Act_GH_Sow';
                    else if (task.type === 'directSeed') updateField = 'Act_Field_Sow';
                    else if (task.type === 'transplant') updateField = 'Act_Transplant';

                    const params = new URLSearchParams({
                        action: 'updatePlanting',
                        batchId: task.batchId,
                        [updateField]: '' // Clear the date
                    });

                    const response = await fetch(`${API_URL}?${params}`);
                    const result = await response.json();

                    if (result.success) {
                        // Restore task state
                        const originalTask = todaysTasks.find(t => t.id === task.id);
                        if (originalTask) {
                            originalTask.completed = false;
                        }

                        // Restore planting data
                        const planting = allPlantings.find(p => p.Batch_ID === task.batchId);
                        if (planting) {
                            planting[updateField] = '';
                            if (task.type === 'transplant') planting.STATUS = 'Sown';
                            else if (task.type === 'ghSow') planting.STATUS = 'Planned';
                        }
                    }
                } catch (error) {
                    console.error('Error undoing task:', error);
                }
            }

            lastCompletedTasks = [];
            renderTodaysTasks();
            updateStats();
            showToast('Task completion undone', 'info');
        }

        // ========================================
        // FILTERS
        // ========================================
        function populateFilters() {
            // Crops
            const crops = [...new Set(allPlantings.map(p => p.Crop))].filter(c => c).sort();
            const cropSelect = document.getElementById('cropFilter');
            cropSelect.innerHTML = '<option value="">All Crops</option>' +
                crops.map(c => `<option value="${c}">${c}</option>`).join('');

            // Varieties
            const varieties = [...new Set(allPlantings.map(p => p.Variety))].filter(v => v).sort();
            const varietySelect = document.getElementById('varietyFilter');
            varietySelect.innerHTML = '<option value="">All Varieties</option>' +
                varieties.map(v => `<option value="${v}">${v}</option>`).join('');
        }

        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const crop = document.getElementById('cropFilter').value;
            const variety = document.getElementById('varietyFilter').value;
            const status = document.getElementById('statusFilter').value;

            filteredPlantings = allPlantings.filter(p => {
                if (search) {
                    const searchStr = `${p.Batch_ID} ${p.Crop} ${p.Variety} ${p.Target_Bed_ID}`.toLowerCase();
                    if (!searchStr.includes(search)) return false;
                }
                if (crop && p.Crop !== crop) return false;
                if (variety && p.Variety !== variety) return false;
                if (status && p.STATUS !== status) return false;
                return true;
            });

            renderView();
        }

        // ========================================
        // VIEW MANAGEMENT
        // ========================================
        function setView(view) {
            currentView = view;

            // Update nav items
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                item.classList.toggle('active', item.dataset.view === view);
            });

            // Update titles
            const titles = {
                'nursery': { title: 'Nursery View', subtitle: 'Chronological planting schedule', icon: 'fa-seedling' },
                'crop': { title: 'Crop View', subtitle: 'Plantings organized by crop', icon: 'fa-leaf' },
                'location': { title: 'Location View', subtitle: 'Plantings by field location', icon: 'fa-map-marker-alt' }
            };

            const config = titles[view];
            document.getElementById('pageTitle').textContent = config.title;
            document.getElementById('pageSubtitle').textContent = config.subtitle;

            renderView();
        }

        function renderView() {
            const container = document.getElementById('viewContainer');

            switch (currentView) {
                case 'nursery':
                    renderNurseryView(container);
                    break;
                case 'crop':
                    renderCropView(container);
                    break;
                case 'location':
                    renderLocationView(container);
                    break;
            }
        }

        // ========================================
        // NURSERY VIEW
        // ========================================
        function renderNurseryView(container) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Get plantings with upcoming dates
            const nurseryPlantings = filteredPlantings.filter(p => {
                const method = (p.Planting_Method || '').toLowerCase();
                return method.includes('transplant') || method.includes('paperpot');
            }).map(p => {
                const ghSow = parseDate(p.Plan_GH_Sow);
                const transplant = parseDate(p.Plan_Transplant);
                const actGhSow = parseDate(p.Act_GH_Sow);
                const actTransplant = parseDate(p.Act_Transplant);

                // Determine the relevant date and action
                let actionDate = null;
                let action = '';

                if (!actGhSow && ghSow) {
                    actionDate = ghSow;
                    action = 'Sow';
                } else if (actGhSow && !actTransplant && transplant) {
                    actionDate = transplant;
                    action = 'Transplant';
                }

                return { ...p, actionDate, action };
            }).filter(p => p.actionDate);

            // Sort by date
            nurseryPlantings.sort((a, b) => a.actionDate - b.actionDate);

            document.getElementById('viewTitle').innerHTML = '<i class="fas fa-seedling"></i> Upcoming Sowings & Transplants';
            document.getElementById('viewCount').textContent = `${nurseryPlantings.length} plantings`;

            if (nurseryPlantings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No upcoming plantings</h3>
                        <p>Add a new planting to get started</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="nursery-list">';
            nurseryPlantings.forEach(p => {
                const icon = cropIcons[p.Crop] || 'ðŸŒ±';
                const date = p.actionDate;
                const daysUntil = Math.floor((date - today) / (1000 * 60 * 60 * 24));

                let statusClass = 'planned';
                if (p.Act_GH_Sow) statusClass = 'sown';
                if (p.Act_Transplant) statusClass = 'transplanted';
                if (daysUntil < 0) statusClass = 'ready';

                html += `
                    <div class="nursery-item" onclick="openEditPlanting('${p.Batch_ID}')" style="cursor: pointer;">
                        <div class="nursery-date">
                            <div class="day">${date.getDate()}</div>
                            <div class="month">${date.toLocaleDateString('en-US', { month: 'short' })}</div>
                        </div>
                        <div class="nursery-crop">
                            <span class="icon">${icon}</span>
                            <div class="info">
                                <span class="name">${p.Crop}</span>
                                <span class="variety">${p.Variety || 'Standard'}</span>
                            </div>
                        </div>
                        <div class="nursery-bed">
                            <i class="fas fa-map-marker-alt"></i>
                            ${p.Target_Bed_ID || 'Unassigned'}
                        </div>
                        <div class="nursery-trays">
                            <div class="count">${p.Trays_Needed || '--'}</div>
                            <div class="label">trays</div>
                        </div>
                        <div class="nursery-status">
                            <span class="status-badge ${statusClass}">${p.action}</span>
                        </div>
                        <div class="nursery-actions">
                            <span class="action-hint"><i class="fas fa-chevron-right"></i></span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // ========================================
        // CROP VIEW
        // ========================================
        function renderCropView(container) {
            // Group by crop
            const cropGroups = {};
            filteredPlantings.forEach(p => {
                const crop = p.Crop || 'Unknown';
                if (!cropGroups[crop]) {
                    cropGroups[crop] = {
                        name: crop,
                        plantings: [],
                        varieties: new Set(),
                        totalFeet: 0
                    };
                }
                cropGroups[crop].plantings.push(p);
                if (p.Variety) cropGroups[crop].varieties.add(p.Variety);
                cropGroups[crop].totalFeet += Number(p.Feet_Used) || 0;
            });

            const crops = Object.values(cropGroups).sort((a, b) => b.plantings.length - a.plantings.length);

            document.getElementById('viewTitle').innerHTML = '<i class="fas fa-leaf"></i> Crops Overview';
            document.getElementById('viewCount').textContent = `${crops.length} crops`;

            if (crops.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-leaf"></i>
                        <h3>No crops found</h3>
                    </div>
                `;
                return;
            }

            let html = '<div class="crop-grid">';
            crops.forEach(crop => {
                const icon = cropIcons[crop.name] || 'ðŸŒ±';
                const active = crop.plantings.filter(p => ['Sown', 'PLANTED', 'HARVESTING'].includes(p.STATUS)).length;

                html += `
                    <div class="crop-card" onclick="window.location.href='calendar.html?crop=${encodeURIComponent(crop.name)}'">
                        <div class="crop-card-header">
                            <span class="crop-card-icon">${icon}</span>
                            <div class="crop-card-title">
                                <h3>${crop.name}</h3>
                                <div class="varieties">${crop.varieties.size} varieties</div>
                            </div>
                        </div>
                        <div class="crop-card-stats">
                            <div class="crop-stat">
                                <div class="value">${crop.plantings.length}</div>
                                <div class="label">Plantings</div>
                            </div>
                            <div class="crop-stat">
                                <div class="value">${active}</div>
                                <div class="label">Active</div>
                            </div>
                            <div class="crop-stat">
                                <div class="value">${crop.totalFeet.toLocaleString()}</div>
                                <div class="label">Feet</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // ========================================
        // LOCATION VIEW
        // ========================================
        function renderLocationView(container) {
            // Group by field
            const fieldGroups = {};
            filteredPlantings.forEach(p => {
                const bed = p.Target_Bed_ID || 'Unassigned';
                const field = bed.split('-')[0] || 'Unassigned';
                if (!fieldGroups[field]) {
                    fieldGroups[field] = {
                        name: field,
                        plantings: [],
                        beds: new Set(),
                        totalFeet: 0
                    };
                }
                fieldGroups[field].plantings.push(p);
                if (bed !== 'Unassigned') fieldGroups[field].beds.add(bed);
                fieldGroups[field].totalFeet += Number(p.Feet_Used) || 0;
            });

            const fields = Object.values(fieldGroups).sort((a, b) => b.plantings.length - a.plantings.length);

            document.getElementById('viewTitle').innerHTML = '<i class="fas fa-map-marker-alt"></i> Fields Overview';
            document.getElementById('viewCount').textContent = `${fields.length} fields`;

            if (fields.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map"></i>
                        <h3>No locations found</h3>
                    </div>
                `;
                return;
            }

            let html = '<div class="crop-grid">';
            fields.forEach(field => {
                const active = field.plantings.filter(p => ['Sown', 'PLANTED', 'HARVESTING'].includes(p.STATUS)).length;

                html += `
                    <div class="crop-card" onclick="window.location.href='calendar.html?field=${encodeURIComponent(field.name)}'">
                        <div class="crop-card-header">
                            <span class="crop-card-icon"><i class="fas fa-map-marker-alt" style="color: var(--primary-light);"></i></span>
                            <div class="crop-card-title">
                                <h3>${field.name}</h3>
                                <div class="varieties">${field.beds.size} beds in use</div>
                            </div>
                        </div>
                        <div class="crop-card-stats">
                            <div class="crop-stat">
                                <div class="value">${field.plantings.length}</div>
                                <div class="label">Plantings</div>
                            </div>
                            <div class="crop-stat">
                                <div class="value">${active}</div>
                                <div class="label">Active</div>
                            </div>
                            <div class="crop-stat">
                                <div class="value">${field.totalFeet.toLocaleString()}</div>
                                <div class="label">Feet</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // ========================================
        // WELCOME BANNER & WEATHER
        // ========================================
        function updateWelcomeBanner() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = 'Good morning';
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
            else if (hour >= 17) greeting = 'Good evening';

            document.getElementById('welcomeGreeting').textContent = greeting + '!';
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Store forecast data globally
        let forecastData = null;

        async function loadWeather() {
            try {
                // Using Open-Meteo free API - coordinates for typical farm location
                // You can update these coordinates for your actual farm location
                const lat = 38.9;  // Example: Virginia area
                const lon = -77.0;
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto&forecast_days=5`
                );
                const data = await response.json();

                if (data.current) {
                    const temp = Math.round(data.current.temperature_2m);
                    const humidity = data.current.relative_humidity_2m;
                    const wind = Math.round(data.current.wind_speed_10m);
                    const weatherCode = data.current.weather_code;

                    document.getElementById('weatherTemp').textContent = `${temp}Â°F`;
                    document.getElementById('weatherHumidity').textContent = `${humidity}%`;
                    document.getElementById('weatherWind').textContent = `${wind} mph`;

                    // Set weather icon and description based on WMO weather code
                    const { icon, desc } = getWeatherInfo(weatherCode);
                    document.getElementById('weatherIcon').className = `fas ${icon} weather-icon`;
                    document.getElementById('weatherDesc').textContent = desc;

                    // Check for weather warnings
                    checkWeatherWarnings(temp, wind, weatherCode);
                }

                // Store forecast data for popup
                if (data.daily) {
                    forecastData = data.daily;
                    renderForecast();
                }
            } catch (error) {
                console.error('Error loading weather:', error);
                document.getElementById('weatherDesc').textContent = 'Unable to load';
            }
        }

        function toggleForecast(event) {
            event.stopPropagation();
            const popup = document.getElementById('forecastPopup');
            popup.classList.toggle('visible');
        }

        function closeForecast(event) {
            event.stopPropagation();
            document.getElementById('forecastPopup').classList.remove('visible');
        }

        // Close forecast when clicking outside
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('forecastPopup');
            const weatherInfo = document.querySelector('.weather-info');
            if (popup && popup.classList.contains('visible') && !weatherInfo.contains(e.target)) {
                popup.classList.remove('visible');
            }
        });

        function renderForecast() {
            if (!forecastData) return;

            const container = document.getElementById('forecastDays');
            const alertsContainer = document.getElementById('forecastAlerts');
            const today = new Date().toISOString().split('T')[0];
            const alerts = [];

            let html = '';
            for (let i = 0; i < forecastData.time.length; i++) {
                const date = new Date(forecastData.time[i] + 'T12:00:00');
                const isToday = forecastData.time[i] === today;
                const dayName = isToday ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const weatherCode = forecastData.weather_code[i];
                const { icon, desc } = getWeatherInfo(weatherCode);
                const high = Math.round(forecastData.temperature_2m_max[i]);
                const low = Math.round(forecastData.temperature_2m_min[i]);
                const precip = forecastData.precipitation_probability_max[i];

                html += `
                    <div class="forecast-day ${isToday ? 'today' : ''}">
                        <div class="day-name">
                            ${dayName}
                            <span class="date">${dateStr}</span>
                        </div>
                        <div class="day-icon">
                            <i class="fas ${icon}" style="color: ${getWeatherColor(weatherCode)};"></i>
                        </div>
                        <div class="day-desc">${desc}${precip > 30 ? ` (${precip}%)` : ''}</div>
                        <div class="day-temps">
                            <span class="high">${high}Â°</span>
                            <span class="low">${low}Â°</span>
                        </div>
                    </div>
                `;

                // Check for alerts
                if (low <= 32) {
                    alerts.push({ type: 'frost', icon: 'fa-snowflake', text: `${dayName}: Frost risk (Low: ${low}Â°F)` });
                }
                if (high >= 95) {
                    alerts.push({ type: 'heat', icon: 'fa-temperature-high', text: `${dayName}: Heat advisory (High: ${high}Â°F)` });
                }
                if ([95, 96].includes(weatherCode)) {
                    alerts.push({ type: 'storm', icon: 'fa-bolt', text: `${dayName}: Thunderstorms expected` });
                }
            }

            container.innerHTML = html;

            // Render alerts
            if (alerts.length > 0) {
                alertsContainer.innerHTML = alerts.map(a => `
                    <div class="forecast-alert ${a.type}">
                        <i class="fas ${a.icon}"></i>
                        <span>${a.text}</span>
                    </div>
                `).join('');
                alertsContainer.style.display = 'block';
            } else {
                alertsContainer.style.display = 'none';
            }
        }

        function getWeatherColor(code) {
            if ([0, 1].includes(code)) return '#e9c46a'; // Sun - yellow
            if ([2, 3].includes(code)) return '#8d99ae'; // Cloudy - gray
            if ([45, 48].includes(code)) return '#8d99ae'; // Fog - gray
            if ([51, 53, 55, 61, 63, 65, 80].includes(code)) return '#3498db'; // Rain - blue
            if ([71, 73, 75].includes(code)) return '#a8dadc'; // Snow - light blue
            if ([95, 96].includes(code)) return '#e63946'; // Storm - red
            return '#8d99ae';
        }

        function getWeatherInfo(code) {
            // WMO Weather interpretation codes
            const weatherCodes = {
                0: { icon: 'fa-sun', desc: 'Clear sky' },
                1: { icon: 'fa-sun', desc: 'Mainly clear' },
                2: { icon: 'fa-cloud-sun', desc: 'Partly cloudy' },
                3: { icon: 'fa-cloud', desc: 'Overcast' },
                45: { icon: 'fa-smog', desc: 'Foggy' },
                48: { icon: 'fa-smog', desc: 'Depositing rime fog' },
                51: { icon: 'fa-cloud-rain', desc: 'Light drizzle' },
                53: { icon: 'fa-cloud-rain', desc: 'Moderate drizzle' },
                55: { icon: 'fa-cloud-rain', desc: 'Dense drizzle' },
                61: { icon: 'fa-cloud-showers-heavy', desc: 'Slight rain' },
                63: { icon: 'fa-cloud-showers-heavy', desc: 'Moderate rain' },
                65: { icon: 'fa-cloud-showers-heavy', desc: 'Heavy rain' },
                71: { icon: 'fa-snowflake', desc: 'Slight snow' },
                73: { icon: 'fa-snowflake', desc: 'Moderate snow' },
                75: { icon: 'fa-snowflake', desc: 'Heavy snow' },
                80: { icon: 'fa-cloud-showers-heavy', desc: 'Rain showers' },
                95: { icon: 'fa-bolt', desc: 'Thunderstorm' },
                96: { icon: 'fa-bolt', desc: 'Thunderstorm with hail' }
            };
            return weatherCodes[code] || { icon: 'fa-cloud', desc: 'Unknown' };
        }

        function checkWeatherWarnings(temp, wind, code) {
            const warnings = [];

            if (temp <= 32) {
                warnings.push({ type: 'weather', icon: 'fa-snowflake', text: `Frost Warning: ${temp}Â°F - Protect tender plants!` });
            }
            if (temp >= 95) {
                warnings.push({ type: 'weather', icon: 'fa-temperature-high', text: `Heat Warning: ${temp}Â°F - Water plants early!` });
            }
            if (wind >= 25) {
                warnings.push({ type: 'weather', icon: 'fa-wind', text: `High Wind: ${wind} mph - Secure row covers!` });
            }
            if ([95, 96].includes(code)) {
                warnings.push({ type: 'weather', icon: 'fa-bolt', text: 'Thunderstorm expected - Consider harvesting!' });
            }

            // Store weather warnings for later combination with task warnings
            window.weatherWarnings = warnings;
            updateWarningsBar();
        }

        function checkTaskWarnings() {
            const warnings = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            allPlantings.forEach(p => {
                // Check for overdue GH sowings
                const ghSow = parseDate(p.Plan_GH_Sow);
                if (ghSow && ghSow < today && !p.Act_GH_Sow && p.STATUS === 'Planned') {
                    const daysLate = Math.floor((today - ghSow) / (1000 * 60 * 60 * 24));
                    if (daysLate > 0) {
                        warnings.push({
                            type: 'task',
                            icon: 'fa-exclamation-triangle',
                            text: `${p.Crop} (${p.Batch_ID}) - GH sow ${daysLate} days overdue`,
                            batchId: p.Batch_ID
                        });
                    }
                }

                // Check for overdue transplants
                const transplant = parseDate(p.Plan_Transplant);
                if (transplant && transplant < today && !p.Act_Transplant && p.STATUS === 'Sown') {
                    const daysLate = Math.floor((today - transplant) / (1000 * 60 * 60 * 24));
                    if (daysLate > 0) {
                        warnings.push({
                            type: 'task',
                            icon: 'fa-exclamation-triangle',
                            text: `${p.Crop} (${p.Batch_ID}) - Transplant ${daysLate} days overdue`,
                            batchId: p.Batch_ID
                        });
                    }
                }
            });

            window.taskWarnings = warnings;
            updateWarningsBar();
        }

        function updateWarningsBar() {
            const allWarnings = [...(window.weatherWarnings || []), ...(window.taskWarnings || [])];
            const warningsBar = document.getElementById('warningsBar');
            const warningsList = document.getElementById('warningsList');

            if (allWarnings.length === 0) {
                warningsBar.classList.remove('visible');
                return;
            }

            warningsBar.classList.add('visible');
            warningsList.innerHTML = allWarnings.map(w => `
                <div class="warning-item ${w.type}" ${w.batchId ? `onclick="openEditPlanting('${w.batchId}')"` : ''}>
                    <i class="fas ${w.icon}"></i>
                    <span>${w.text}</span>
                </div>
            `).join('');
        }

        // ========================================
        // CROP PROFILES
        // ========================================
        async function loadCropProfiles() {
            try {
                const response = await fetch(`${API_URL}?action=getCropProfiles`);
                const data = await response.json();
                if (data.success && data.data) {
                    cropProfiles = data.data.map(p => ({
                        Crop: p.Crop || p.Crop_Name || '',
                        Variety: p.Variety || p.Variety_Default || '',
                        DTM: parseInt(p.DTM || p.Days_To_Maturity) || 45,
                        Spacing: parseInt(p.Spacing || p.In_Row_Spacing_In) || 8,
                        Rows_Per_Bed: parseInt(p.Rows_Per_Bed || p.Rows) || 4,
                        Tray_Cell_Count: parseInt(p.Tray_Cell_Count || p.Cell_Count) || 128,
                        Nursery_Days: parseInt(p.Nursery_Days || p.GH_Days) || 28,
                        Planting_Method: p.Planting_Method || p.Method || 'Transplant'
                    }));
                    populateQuickPlantCrops();
                }
            } catch (error) {
                console.error('Error loading crop profiles:', error);
            }
        }

        function populateQuickPlantCrops() {
            const cropSelect = document.getElementById('qpCrop');
            const crops = [...new Set(cropProfiles.map(p => p.Crop))].sort();
            cropSelect.innerHTML = '<option value="">Select crop...</option>' +
                crops.map(c => `<option value="${c}">${c}</option>`).join('') +
                '<option value="__add_new__">+ Add New Crop...</option>';
        }

        // ========================================
        // QUICK PLANT MODAL
        // ========================================
        function openQuickPlant() {
            document.getElementById('quickPlantModal').classList.add('visible');
            document.getElementById('qpDate').value = new Date().toISOString().split('T')[0];
            // Reset new crop/variety inputs
            document.getElementById('qpNewCrop').style.display = 'none';
            document.getElementById('qpNewCrop').value = '';
            document.getElementById('qpNewVariety').style.display = 'none';
            document.getElementById('qpNewVariety').value = '';
            // Populate bed dropdown
            const bedSelect = document.getElementById('qpBed');
            bedSelect.innerHTML = '<option value="Unassigned">Unassigned</option>';
            beds.forEach(bed => {
                const bedId = bed['Bed ID'] || bed.Bed_ID || bed.id;
                if (bedId) {
                    bedSelect.innerHTML += `<option value="${bedId}">${bedId}</option>`;
                }
            });
            qpRecalculate();
        }

        function closeQuickPlant() {
            document.getElementById('quickPlantModal').classList.remove('visible');
            // Reset form fields
            document.getElementById('qpCrop').value = '';
            document.getElementById('qpVariety').innerHTML = '<option value="">Select variety...</option>';
            document.getElementById('qpNewCrop').style.display = 'none';
            document.getElementById('qpNewCrop').value = '';
            document.getElementById('qpNewVariety').style.display = 'none';
            document.getElementById('qpNewVariety').value = '';
            document.getElementById('qpMethod').value = 'Transplant';
            document.getElementById('qpTraySize').value = '128';
            document.getElementById('qpFeet').value = '100';
            document.getElementById('qpBed').value = 'Unassigned';
            document.getElementById('qpDateType').value = 'transplant';
            document.getElementById('qpSuccessionCheck').checked = false;
            document.getElementById('qpSuccessionOptions').classList.remove('visible');
            document.getElementById('qpSuccessionCount').value = '4';
            document.getElementById('qpInterval').value = '7';
            document.getElementById('qpIntervalUnit').value = 'days';
        }

        function qpCropChange() {
            const cropSelect = document.getElementById('qpCrop');
            const crop = cropSelect.value;
            const varietySelect = document.getElementById('qpVariety');
            const newCropInput = document.getElementById('qpNewCrop');
            const newVarietyInput = document.getElementById('qpNewVariety');

            // Handle "Add New Crop" selection
            if (crop === '__add_new__') {
                newCropInput.style.display = 'block';
                newCropInput.focus();
                varietySelect.innerHTML = '<option value="">Select variety...</option>' +
                    '<option value="__add_new__">+ Add New Variety...</option>';
                newVarietyInput.style.display = 'none';
                return;
            } else {
                newCropInput.style.display = 'none';
                newCropInput.value = '';
            }

            const varieties = cropProfiles
                .filter(p => p.Crop === crop)
                .map(p => p.Variety)
                .filter(v => v);
            const uniqueVarieties = [...new Set(varieties)];

            varietySelect.innerHTML = '<option value="">Select variety...</option>' +
                uniqueVarieties.map(v => `<option value="${v}">${v}</option>`).join('') +
                '<option value="__add_new__">+ Add New Variety...</option>';

            // Auto-select first variety
            if (uniqueVarieties.length > 0) {
                varietySelect.value = uniqueVarieties[0];
                qpVarietyChange();
            } else {
                newVarietyInput.style.display = 'none';
            }
        }

        function qpVarietyChange() {
            const crop = document.getElementById('qpCrop').value;
            const variety = document.getElementById('qpVariety').value;
            const newVarietyInput = document.getElementById('qpNewVariety');

            // Handle "Add New Variety" selection
            if (variety === '__add_new__') {
                newVarietyInput.style.display = 'block';
                newVarietyInput.focus();
                // Set default values for new variety
                document.getElementById('qpMethod').value = 'Transplant';
                document.getElementById('qpTraySize').value = '128';
                qpNurseryDays = 21;
                qpDTM = 60;
                qpRows = 3;
                qpSpacing = 6;
                qpRecalculate();
                return;
            } else {
                newVarietyInput.style.display = 'none';
                newVarietyInput.value = '';
            }

            const profile = cropProfiles.find(p => p.Crop === crop && p.Variety === variety) ||
                           cropProfiles.find(p => p.Crop === crop);

            if (profile) {
                document.getElementById('qpMethod').value = profile.Planting_Method;
                document.getElementById('qpTraySize').value = profile.Tray_Cell_Count;
                qpNurseryDays = profile.Nursery_Days;
                qpDTM = profile.DTM;
                qpRows = profile.Rows_Per_Bed;
                qpSpacing = profile.Spacing;
            }

            qpRecalculate();
        }

        function toggleQpSuccession() {
            const checked = document.getElementById('qpSuccessionCheck').checked;
            document.getElementById('qpSuccessionOptions').classList.toggle('visible', checked);
            qpRecalculate();
        }

        function setQuickFeet(feet) {
            document.getElementById('qpFeet').value = feet;
            updateQuickFeetButtons();
            qpRecalculate();
        }

        function updateQuickFeetButtons() {
            const feet = parseInt(document.getElementById('qpFeet').value) || 0;
            document.querySelectorAll('.quick-select-btn').forEach(btn => {
                const btnFeet = parseInt(btn.textContent);
                btn.classList.toggle('active', btnFeet === feet);
            });
        }

        function qpRecalculate() {
            const dateType = document.getElementById('qpDateType').value;
            const targetDate = document.getElementById('qpDate').value;
            const method = document.getElementById('qpMethod').value;
            const traySize = parseInt(document.getElementById('qpTraySize').value) || 128;
            const feet = parseInt(document.getElementById('qpFeet').value) || 100;

            if (!targetDate) return;

            const inputDate = new Date(targetDate);
            let ghSowDate, transplantDate, harvestDate;

            if (method === 'Direct Seed') {
                if (dateType === 'transplant') {
                    transplantDate = inputDate;
                    harvestDate = addDays(inputDate, qpDTM);
                } else if (dateType === 'harvest') {
                    harvestDate = inputDate;
                    transplantDate = addDays(inputDate, -qpDTM);
                }
                ghSowDate = null;
            } else {
                if (dateType === 'transplant') {
                    transplantDate = inputDate;
                    ghSowDate = addDays(inputDate, -qpNurseryDays);
                    harvestDate = addDays(inputDate, qpDTM);
                } else if (dateType === 'harvest') {
                    harvestDate = inputDate;
                    transplantDate = addDays(inputDate, -qpDTM);
                    ghSowDate = addDays(transplantDate, -qpNurseryDays);
                } else if (dateType === 'ghsow') {
                    ghSowDate = inputDate;
                    transplantDate = addDays(inputDate, qpNurseryDays);
                    harvestDate = addDays(transplantDate, qpDTM);
                }
            }

            // Update summary
            document.getElementById('qpGhSow').textContent = ghSowDate ? formatDateShort(ghSowDate) : '--';
            document.getElementById('qpTransplant').textContent = transplantDate ? formatDateShort(transplantDate) : '--';
            document.getElementById('qpHarvest').textContent = harvestDate ? formatDateShort(harvestDate) : '--';

            // Calculate quantities
            const spacingFeet = qpSpacing / 12;
            const plantsPerFoot = qpRows / spacingFeet;
            const plantsNeeded = Math.ceil(feet * plantsPerFoot);
            const traysNeeded = Math.ceil(plantsNeeded / traySize);
            const seedsNeeded = Math.ceil(plantsNeeded * 1.05);

            document.getElementById('qpTrays').textContent = traysNeeded;
            document.getElementById('qpSeeds').textContent = seedsNeeded;
        }

        async function saveQuickPlant(addAnother = false) {
            let crop = document.getElementById('qpCrop').value;
            let variety = document.getElementById('qpVariety').value;
            const method = document.getElementById('qpMethod').value;
            const traySize = document.getElementById('qpTraySize').value;
            const feet = document.getElementById('qpFeet').value;
            const bed = document.getElementById('qpBed').value;
            const dateType = document.getElementById('qpDateType').value;
            const targetDate = document.getElementById('qpDate').value;

            // Handle new crop/variety
            const isNewCrop = crop === '__add_new__';
            const isNewVariety = variety === '__add_new__';

            if (isNewCrop) {
                crop = document.getElementById('qpNewCrop').value.trim();
                if (!crop) {
                    showToast('Please enter a crop name', 'error');
                    return;
                }
            }

            if (isNewVariety) {
                variety = document.getElementById('qpNewVariety').value.trim();
                if (!variety) {
                    showToast('Please enter a variety name', 'error');
                    return;
                }
            }

            if (!crop || !targetDate) {
                showToast('Please select crop and date', 'error');
                return;
            }

            const successionEnabled = document.getElementById('qpSuccessionCheck').checked;
            const successionCount = successionEnabled ? parseInt(document.getElementById('qpSuccessionCount').value) : 1;
            const interval = parseInt(document.getElementById('qpInterval').value) || 7;
            const intervalUnit = document.getElementById('qpIntervalUnit').value;
            const intervalDays = intervalUnit === 'weeks' ? interval * 7 : interval;

            try {
                // Create new crop profile if adding new crop or variety
                if (isNewCrop || isNewVariety) {
                    const profileParams = new URLSearchParams({
                        action: 'createCropProfile',
                        crop: crop,
                        variety: variety || 'Standard',
                        plantingMethod: method,
                        trayCellCount: traySize,
                        nurseryDays: qpNurseryDays,
                        dtm: qpDTM,
                        rowsPerBed: qpRows,
                        spacing: qpSpacing
                    });

                    const profileResponse = await fetch(`${API_URL}?${profileParams}`);
                    const profileResult = await profileResponse.json();

                    if (!profileResult.success) {
                        showToast('Error creating crop profile: ' + profileResult.error, 'error');
                        return;
                    }

                    showToast(`New ${isNewCrop ? 'crop' : 'variety'} "${isNewCrop ? crop : variety}" added to profiles!`, 'success');

                    // Reload crop profiles to include the new one
                    await loadCropProfiles();
                }

                // Save plantings
                for (let i = 0; i < successionCount; i++) {
                    const offsetDays = i * intervalDays;
                    const plantingDate = addDays(new Date(targetDate), offsetDays);

                    const params = new URLSearchParams({
                        action: 'savePlanting',
                        crop: crop,
                        variety: variety || 'Standard',
                        method: method,
                        traySize: traySize,
                        feet: feet,
                        Target_Bed_ID: bed,
                        dateType: dateType,
                        targetDate: plantingDate.toISOString().split('T')[0],
                        nurseryDays: qpNurseryDays,
                        dtm: qpDTM,
                        rows: qpRows,
                        spacing: qpSpacing
                    });

                    await fetch(`${API_URL}?${params}`);
                }

                showToast(`${successionCount} planting(s) saved!`, 'success');

                if (addAnother) {
                    document.getElementById('qpCrop').value = '';
                    document.getElementById('qpVariety').innerHTML = '<option value="">Select variety...</option>';
                    document.getElementById('qpNewCrop').style.display = 'none';
                    document.getElementById('qpNewCrop').value = '';
                    document.getElementById('qpNewVariety').style.display = 'none';
                    document.getElementById('qpNewVariety').value = '';
                    // Refresh crop dropdown with new crop if added
                    populateQuickPlantCrops();
                } else {
                    closeQuickPlant();
                }

                // Refresh data
                await loadAllData();

            } catch (error) {
                console.error('Error saving planting:', error);
                showToast('Error saving planting', 'error');
            }
        }

        // ========================================
        // EDIT PLANTING MODAL
        // ========================================
        function openEditPlanting(batchId) {
            const planting = allPlantings.find(p => p.Batch_ID === batchId);
            if (!planting) {
                showToast('Planting not found', 'error');
                return;
            }

            currentEditPlanting = planting;

            // Populate form
            document.getElementById('editBatchId').value = batchId;
            document.getElementById('editBatchIdDisplay').value = batchId;
            document.getElementById('editStatus').value = planting.STATUS || 'Planned';
            document.getElementById('editCrop').value = planting.Crop || '';
            document.getElementById('editVariety').value = planting.Variety || '';
            document.getElementById('editFeet').value = planting.Feet_Used || 100;
            document.getElementById('editTrays').value = planting.Trays_Needed || 0;
            document.getElementById('editPlants').value = planting.Plants_Needed || 0;

            // Dates
            document.getElementById('editPlanGhSow').value = formatDateISO(planting.Plan_GH_Sow);
            document.getElementById('editActGhSow').value = formatDateISO(planting.Act_GH_Sow);
            document.getElementById('editPlanTransplant').value = formatDateISO(planting.Plan_Transplant);
            document.getElementById('editActTransplant').value = formatDateISO(planting.Act_Transplant);

            // Populate bed dropdown
            const bedSelect = document.getElementById('editBed');
            bedSelect.innerHTML = '<option value="Unassigned">Unassigned</option>';
            beds.forEach(bed => {
                const bedId = bed['Bed ID'] || bed.Bed_ID || bed.id;
                bedSelect.innerHTML += `<option value="${bedId}">${bedId}</option>`;
            });
            bedSelect.value = planting.Target_Bed_ID || 'Unassigned';

            document.getElementById('editPlantingModal').classList.add('visible');
        }

        function closeEditPlanting() {
            document.getElementById('editPlantingModal').classList.remove('visible');
            currentEditPlanting = null;
        }

        async function saveEditPlanting() {
            const batchId = document.getElementById('editBatchId').value;

            const updates = {
                action: 'updatePlanting',
                batchId: batchId,
                status: document.getElementById('editStatus').value,
                targetBed: document.getElementById('editBed').value,
                feetUsed: document.getElementById('editFeet').value,
                traysNeeded: document.getElementById('editTrays').value,
                plantsNeeded: document.getElementById('editPlants').value,
                planGhSow: document.getElementById('editPlanGhSow').value,
                actGhSow: document.getElementById('editActGhSow').value,
                planTransplant: document.getElementById('editPlanTransplant').value,
                actTransplant: document.getElementById('editActTransplant').value
            };

            try {
                const params = new URLSearchParams(updates);
                const response = await fetch(`${API_URL}?${params}`);
                const data = await response.json();

                if (data.success) {
                    showToast('Planting updated!', 'success');
                    closeEditPlanting();
                    await loadAllData();
                } else {
                    showToast(data.error || 'Update failed', 'error');
                }
            } catch (error) {
                console.error('Error updating planting:', error);
                showToast('Error updating planting', 'error');
            }
        }

        // ========================================
        // UTILITIES
        // ========================================
        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDateShort(date) {
            if (!date) return '--';
            return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateISO(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return '';
            return d.toISOString().split('T')[0];
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            document.getElementById('toastMessage').textContent = message;

            toast.className = `toast ${type}`;
            icon.className = type === 'error' ? 'fas fa-times-circle' :
                            type === 'info' ? 'fas fa-info-circle' : 'fas fa-check-circle';

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ========================================
        // FILTER CHIPS
        // ========================================
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });

            // Filter the plantings display based on selection
            if (allPlantings.length > 0) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                switch(filter) {
                    case 'upcoming':
                        filteredPlantings = allPlantings.filter(p => {
                            const transplant = parseDate(p.Plan_Transplant);
                            const ghSow = parseDate(p.Plan_GH_Sow);
                            const fieldSow = parseDate(p.Plan_Field_Sow);
                            return (transplant && transplant >= today) ||
                                   (ghSow && ghSow >= today) ||
                                   (fieldSow && fieldSow >= today);
                        });
                        break;
                    case 'greenhouse':
                        filteredPlantings = allPlantings.filter(p => {
                            // Has been sown but not transplanted
                            return p.Act_GH_Sow && !p.Act_Transplant;
                        });
                        break;
                    case 'field':
                        filteredPlantings = allPlantings.filter(p => {
                            // Has been transplanted or direct sown
                            return p.Act_Transplant || p.Act_Field_Sow;
                        });
                        break;
                    default:
                        filteredPlantings = [...allPlantings];
                }

                renderPlantings();
            }
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // âŒ˜K or Ctrl+K - Open Command Palette
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    openCommandPalette();
                }
                // âŒ˜N or Ctrl+N - New Planting
                if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                    e.preventDefault();
                    openSmartAdd();
                }
                // Escape - Close modals
                if (e.key === 'Escape') {
                    closeCommandPalette();
                    closeSmartAdd();
                }
            });
        }

        // ========================================
        // COMMAND PALETTE
        // ========================================
        function openCommandPalette() {
            document.getElementById('commandPalette').classList.add('visible');
            document.getElementById('commandInput').value = '';
            document.getElementById('commandInput').focus();
            filterCommands();
        }

        function closeCommandPalette() {
            document.getElementById('commandPalette').classList.remove('visible');
        }

        function closeCommandPaletteOnOverlay(e) {
            if (e.target.id === 'commandPalette') {
                closeCommandPalette();
            }
        }

        function filterCommands() {
            const query = document.getElementById('commandInput').value.toLowerCase();
            const items = document.querySelectorAll('.command-item');

            items.forEach(item => {
                const text = item.querySelector('span').textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'flex' : 'none';
            });

            // Show/hide sections based on visible items
            document.querySelectorAll('.command-section').forEach(section => {
                const visibleItems = section.querySelectorAll('.command-item[style="display: flex;"], .command-item:not([style])');
                const hasVisible = Array.from(section.querySelectorAll('.command-item')).some(item =>
                    item.style.display !== 'none'
                );
                section.style.display = hasVisible ? 'block' : 'none';
            });
        }

        function commandAction(action) {
            closeCommandPalette();
            switch(action) {
                case 'add-planting':
                    openSmartAdd();
                    break;
                case 'goto-dashboard':
                    window.location.href = 'index.html';
                    break;
                case 'goto-calendar':
                    window.location.href = 'calendar.html';
                    break;
                case 'goto-greenhouse':
                    window.location.href = 'greenhouse.html';
                    break;
                case 'goto-planning':
                    window.location.href = 'planning.html';
                    break;
                case 'goto-labels':
                    window.location.href = 'labels.html';
                    break;
                case 'goto-task-sheets':
                    window.location.href = 'sowing-sheets.html';
                    break;
                default:
                    console.log('Command:', action);
            }
        }

        // ========================================
        // SMART ADD MODAL
        // ========================================
        function openSmartAdd() {
            document.getElementById('smartAddModal').classList.add('visible');
            document.getElementById('smartCropSearch').value = '';
            document.getElementById('smartCropSearch').focus();
            document.getElementById('smartFormContent').style.display = 'none';
            document.getElementById('btnSmartSave').disabled = true;
            smartSelectedCrop = null;
            smartSelectedVariety = null;
            smartMode = 'simple';
            renderRecentCrops();

            // Set default date to today + 14 days
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 14);
            document.getElementById('smartDate').value = defaultDate.toISOString().split('T')[0];
        }

        function closeSmartAdd() {
            document.getElementById('smartAddModal').classList.remove('visible');
            // Reset form state
            document.getElementById('smartCropSearch').value = '';
            document.getElementById('smartFormContent').style.display = 'none';
            document.getElementById('smartNewVariety').style.display = 'none';
            document.getElementById('smartNewVariety').value = '';
            smartSelectedCrop = null;
            smartSelectedVariety = null;
            smartIsNewCrop = false;
            smartIsNewVariety = false;
        }

        function closeSmartAddOnOverlay(e) {
            if (e.target.id === 'smartAddModal') {
                closeSmartAdd();
            }
        }

        function loadRecentCrops() {
            const stored = localStorage.getItem('recentCrops');
            if (stored) {
                try {
                    recentCrops = JSON.parse(stored);
                } catch(e) {}
            }
        }

        function saveRecentCrop(cropName) {
            // Add to front, remove duplicates, limit to 6
            recentCrops = [cropName, ...recentCrops.filter(c => c !== cropName)].slice(0, 6);
            localStorage.setItem('recentCrops', JSON.stringify(recentCrops));
        }

        function renderRecentCrops() {
            const container = document.getElementById('recentCrops');
            container.innerHTML = recentCrops.map(crop =>
                `<button class="recent-crop-btn" onclick="selectSmartCrop('${crop}')">${crop}</button>`
            ).join('');
        }

        function smartCropSearchHandler() {
            const query = document.getElementById('smartCropSearch').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('smartCropResults');

            if (query.length < 1) {
                resultsContainer.classList.remove('visible');
                return;
            }

            // Filter crop profiles
            const matches = cropProfiles.filter(c =>
                c.Crop.toLowerCase().includes(query)
            ).slice(0, 8);

            if (matches.length === 0) {
                resultsContainer.innerHTML = `<div class="crop-result-item" onclick="selectSmartCrop('${query}', true)">
                    <span class="crop-name">Add "${query}" as new crop</span>
                </div>`;
            } else {
                resultsContainer.innerHTML = matches.map(c => `
                    <div class="crop-result-item" onclick="selectSmartCrop('${c.Crop}')">
                        <span class="crop-name">${c.Crop}</span>
                        <span class="crop-method">${c.Planting_Method || 'Transplant'}</span>
                    </div>
                `).join('');
            }

            resultsContainer.classList.add('visible');
        }

        let smartIsNewCrop = false;
        let smartIsNewVariety = false;

        function selectSmartCrop(cropName, isNew = false) {
            smartSelectedCrop = cropName;
            smartIsNewCrop = isNew;
            smartIsNewVariety = false;
            document.getElementById('smartCropSearch').value = cropName;
            document.getElementById('smartCropResults').classList.remove('visible');
            document.getElementById('smartFormContent').style.display = 'block';
            document.getElementById('btnSmartSave').disabled = false;
            document.getElementById('btnSaveAnother').style.display = 'block';

            saveRecentCrop(cropName);

            // Populate varieties for this crop
            const varietySelect = document.getElementById('smartVariety');
            const newVarietyInput = document.getElementById('smartNewVariety');
            const cropVarieties = cropProfiles.filter(c => c.Crop === cropName);

            varietySelect.innerHTML = '<option value="">Select variety...</option>';
            cropVarieties.forEach(v => {
                varietySelect.innerHTML += `<option value="${v.Variety}">${v.Variety}</option>`;
            });
            // Always add "Add New Variety" option
            varietySelect.innerHTML += '<option value="__add_new__" style="font-style: italic;">+ Add New Variety...</option>';

            // Reset new variety input
            newVarietyInput.style.display = 'none';
            newVarietyInput.value = '';

            // Auto-select first variety if exists (for existing crops)
            if (cropVarieties.length > 0 && !isNew) {
                varietySelect.value = cropVarieties[0].Variety;
                smartVarietyChange();
            } else if (isNew) {
                // For new crop, show the new variety input
                varietySelect.value = '__add_new__';
                newVarietyInput.style.display = 'block';
                newVarietyInput.focus();
                smartIsNewVariety = true;
            }

            smartRecalculate();
        }

        function smartVarietyChange() {
            const variety = document.getElementById('smartVariety').value;
            const newVarietyInput = document.getElementById('smartNewVariety');

            // Handle "Add New Variety" selection
            if (variety === '__add_new__') {
                newVarietyInput.style.display = 'block';
                newVarietyInput.focus();
                smartIsNewVariety = true;
                smartSelectedVariety = null;
                smartRecalculate();
                return;
            }

            // Hide new variety input for existing varieties
            newVarietyInput.style.display = 'none';
            newVarietyInput.value = '';
            smartIsNewVariety = false;

            if (!variety || !smartSelectedCrop) return;

            const profile = cropProfiles.find(c => c.Crop === smartSelectedCrop && c.Variety === variety);
            if (!profile) return;

            smartSelectedVariety = profile;

            // Auto-fill from profile
            if (profile.Planting_Method) {
                document.getElementById('smartMethod').value = profile.Planting_Method;
                smartMethodChange();
            }
            if (profile.Tray_Cell_Count) {
                document.getElementById('smartTray').value = profile.Tray_Cell_Count;
            }

            smartRecalculate();
        }

        function smartMethodChange() {
            const method = document.getElementById('smartMethod').value;
            const trayGroup = document.getElementById('smartTrayGroup');
            const dateType = document.getElementById('smartDateType');

            if (method === 'Direct Seed') {
                trayGroup.style.display = 'none';
                dateType.value = 'directsow';
            } else {
                trayGroup.style.display = 'block';
                dateType.value = 'transplant';
                if (method === 'Paperpot') {
                    document.getElementById('smartTray').value = '264';
                }
            }
            smartRecalculate();
        }

        function setSmartMode(mode) {
            smartMode = mode;
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.toLowerCase().includes(mode));
            });
            document.getElementById('smartSuccessionPanel').classList.toggle('visible', mode === 'succession');
            smartRecalculate();
        }

        function setSmartQuantity(feet) {
            document.getElementById('smartFeet').value = feet;
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.textContent) === feet);
            });
            smartRecalculate();
        }

        function smartRecalculate() {
            const feet = parseInt(document.getElementById('smartFeet').value) || 100;
            const successionsCount = smartMode === 'succession' ?
                parseInt(document.getElementById('smartSuccessionCount').value) || 1 : 1;

            const totalFeet = feet * successionsCount;
            document.getElementById('summaryPlantings').textContent = successionsCount;
            document.getElementById('summaryFeet').textContent = totalFeet;

            // Calculate trays if we have profile data
            if (smartSelectedVariety) {
                const profile = smartSelectedVariety;
                const rows = parseInt(profile.Rows_Per_Bed) || 4;
                const spacing = parseInt(profile.In_Row_Spacing) || 8;
                const cellsPerTray = parseInt(document.getElementById('smartTray').value) || 128;

                const plantsPerFoot = (rows * 12) / spacing;
                const totalPlants = Math.ceil(feet * plantsPerFoot);
                const trays = Math.ceil(totalPlants / cellsPerTray);

                document.getElementById('summaryTrays').textContent = trays * successionsCount;

                // Calculate dates
                const dateType = document.getElementById('smartDateType').value;
                const dateValue = document.getElementById('smartDate').value;
                if (dateValue) {
                    const baseDate = new Date(dateValue);
                    const nurseryDays = parseInt(profile.Nursery_Days) || 28;
                    const dtm = parseInt(profile.DTM) || 45;

                    let ghSowDate, transplantDate, harvestDate;

                    if (dateType === 'transplant') {
                        transplantDate = baseDate;
                        ghSowDate = new Date(baseDate);
                        ghSowDate.setDate(ghSowDate.getDate() - nurseryDays);
                        harvestDate = new Date(baseDate);
                        harvestDate.setDate(harvestDate.getDate() + dtm);
                    } else if (dateType === 'ghsow') {
                        ghSowDate = baseDate;
                        transplantDate = new Date(baseDate);
                        transplantDate.setDate(transplantDate.getDate() + nurseryDays);
                        harvestDate = new Date(transplantDate);
                        harvestDate.setDate(harvestDate.getDate() + dtm);
                    } else if (dateType === 'harvest') {
                        harvestDate = baseDate;
                        transplantDate = new Date(baseDate);
                        transplantDate.setDate(transplantDate.getDate() - dtm);
                        ghSowDate = new Date(transplantDate);
                        ghSowDate.setDate(ghSowDate.getDate() - nurseryDays);
                    } else {
                        // Direct sow
                        ghSowDate = null;
                        transplantDate = null;
                        harvestDate = new Date(baseDate);
                        harvestDate.setDate(harvestDate.getDate() + dtm);
                    }

                    const fmt = d => d ? d.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : '--';
                    document.getElementById('summaryGHSow').textContent = fmt(ghSowDate);
                    document.getElementById('summaryTransplant').textContent = fmt(transplantDate);
                    document.getElementById('summaryHarvest').textContent = fmt(harvestDate);
                }
            } else {
                document.getElementById('summaryTrays').textContent = '--';
            }
        }

        async function smartSave() {
            if (!smartSelectedCrop) {
                showToast('Please select a crop', 'error');
                return;
            }

            // Get variety - from input if new, from select otherwise
            let variety = document.getElementById('smartVariety').value;
            if (smartIsNewVariety || variety === '__add_new__') {
                variety = document.getElementById('smartNewVariety').value.trim();
                if (!variety) {
                    showToast('Please enter a variety name', 'error');
                    return;
                }
            }
            if (!variety) variety = 'Standard';

            const btn = document.getElementById('btnSmartSave');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                // If new crop or new variety, create the profile first
                if (smartIsNewCrop || smartIsNewVariety) {
                    const profileData = {
                        action: 'createCropProfile',
                        Crop: smartSelectedCrop,
                        Variety: variety,
                        Planting_Method: document.getElementById('smartMethod').value,
                        Tray_Cell_Count: document.getElementById('smartTray').value,
                        Primary_Category: 'Veg'
                    };

                    const profileParams = new URLSearchParams(profileData);
                    const profileResponse = await fetch(`${API_URL}?${profileParams.toString()}`);
                    const profileResult = await profileResponse.json();

                    if (profileResult.success) {
                        showToast(`New ${smartIsNewCrop ? 'crop' : 'variety'} "${smartIsNewCrop ? smartSelectedCrop : variety}" added!`, 'success');
                        // Refresh crop profiles
                        loadCropProfiles();
                    }
                }

                const successionsCount = smartMode === 'succession' ?
                    parseInt(document.getElementById('smartSuccessionCount').value) || 1 : 1;
                const interval = parseInt(document.getElementById('smartSuccessionInterval').value) || 7;
                const unit = document.getElementById('smartSuccessionUnit').value;
                const intervalDays = unit === 'weeks' ? interval * 7 : interval;

                const baseDate = new Date(document.getElementById('smartDate').value);

                for (let i = 0; i < successionsCount; i++) {
                    const plantingDate = new Date(baseDate);
                    plantingDate.setDate(plantingDate.getDate() + (i * intervalDays));

                    const data = {
                        action: 'savePlanting',
                        Crop: smartSelectedCrop,
                        Variety: variety,
                        Planting_Method: document.getElementById('smartMethod').value,
                        Bed_Feet: document.getElementById('smartFeet').value,
                        Tray_Cell_Count: document.getElementById('smartTray').value
                    };

                    const dateType = document.getElementById('smartDateType').value;
                    if (dateType === 'transplant') {
                        data.Plan_Transplant = plantingDate.toISOString().split('T')[0];
                    } else if (dateType === 'ghsow') {
                        data.Plan_GH_Sow = plantingDate.toISOString().split('T')[0];
                    } else if (dateType === 'directsow') {
                        data.Plan_Field_Sow = plantingDate.toISOString().split('T')[0];
                    }

                    const params = new URLSearchParams(data);
                    await fetch(`${API_URL}?${params.toString()}`);
                }

                showToast(`${successionsCount > 1 ? successionsCount + ' plantings' : 'Planting'} saved successfully!`);
                closeSmartAdd();
                refreshData();

                // Reset new crop/variety flags
                smartIsNewCrop = false;
                smartIsNewVariety = false;

            } catch (error) {
                console.error('Error saving:', error);
                showToast('Error saving planting', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Save Planting';
            }
        }

        function smartSaveAndAdd() {
            smartSave().then(() => {
                setTimeout(() => openSmartAdd(), 300);
            });
        }
    </script>
</body>
</html>
