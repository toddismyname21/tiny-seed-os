<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Seed Financial Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="auth-guard.js" data-required-role="Admin"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <style>
        :root {
            --primary: #2d5a27;
            --primary-light: #4a7c43;
            --primary-dark: #1e3d1a;
            --secondary: #f4a261;
            --accent: #e76f51;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #e63946;
            --info: #4361ee;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-light: #0f3460;
            --text-primary: #edf2f4;
            --text-secondary: #8d99ae;
            --border: rgba(255,255,255,0.1);
            --gold: #ffd700;
            --purple: #9b59b6;
            --teal: #1abc9c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f1a 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ============================================= */
        /* NAVIGATION */
        /* ============================================= */
        .top-nav {
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-logo {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .nav-title {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected { background: var(--success); }
        .status-dot.warning { background: var(--warning); }
        .status-dot.danger { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ============================================= */
        /* TAB NAVIGATION */
        /* ============================================= */
        .tab-nav {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0;
            padding: 0 2rem;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.03);
        }

        .tab-btn.active {
            color: var(--primary-light);
            border-bottom-color: var(--primary-light);
        }

        .tab-btn .badge {
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .tab-btn .badge.danger { background: var(--danger); color: white; }
        .tab-btn .badge.warning { background: var(--warning); color: #000; }
        .tab-btn .badge.success { background: var(--success); color: white; }

        /* ============================================= */
        /* MAIN CONTENT */
        /* ============================================= */
        .main-content {
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============================================= */
        /* CARDS */
        /* ============================================= */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header h3 i {
            color: var(--primary-light);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* ============================================= */
        /* STATS GRID */
        /* ============================================= */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.green { background: rgba(42, 157, 143, 0.2); color: var(--success); }
        .stat-icon.blue { background: rgba(67, 97, 238, 0.2); color: var(--info); }
        .stat-icon.gold { background: rgba(255, 215, 0, 0.2); color: var(--gold); }
        .stat-icon.orange { background: rgba(244, 162, 97, 0.2); color: var(--secondary); }
        .stat-icon.red { background: rgba(230, 57, 70, 0.2); color: var(--danger); }
        .stat-icon.purple { background: rgba(155, 89, 182, 0.2); color: var(--purple); }
        .stat-icon.teal { background: rgba(26, 188, 156, 0.2); color: var(--teal); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }
        .stat-change.neutral { color: var(--text-secondary); }

        /* ============================================= */
        /* BUTTONS */
        /* ============================================= */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(45, 90, 39, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* ============================================= */
        /* TABLES */
        /* ============================================= */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table tr:hover {
            background: rgba(255,255,255,0.03);
        }

        /* ============================================= */
        /* FORMS */
        /* ============================================= */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        select.form-input {
            cursor: pointer;
        }

        /* ============================================= */
        /* PROGRESS BARS */
        /* ============================================= */
        .progress-container {
            margin-top: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-fill.success { background: linear-gradient(90deg, var(--success), var(--teal)); }
        .progress-fill.warning { background: linear-gradient(90deg, var(--warning), var(--secondary)); }
        .progress-fill.danger { background: linear-gradient(90deg, var(--danger), var(--accent)); }
        .progress-fill.info { background: linear-gradient(90deg, var(--info), var(--purple)); }

        /* ============================================= */
        /* MODALS */
        /* ============================================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* ============================================= */
        /* TWO COLUMN LAYOUT */
        /* ============================================= */
        .two-col {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        .three-col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1000px) {
            .three-col {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================= */
        /* DEBT DESTROYER SPECIFIC */
        /* ============================================= */
        .debt-card {
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.1) 0%, rgba(22, 33, 62, 1) 100%);
            border-left: 4px solid var(--danger);
        }

        .debt-strategy-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .strategy-option {
            padding: 1.5rem;
            background: rgba(255,255,255,0.03);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .strategy-option:hover {
            border-color: var(--primary-light);
        }

        .strategy-option.active {
            border-color: var(--primary-light);
            background: rgba(45, 90, 39, 0.1);
        }

        .strategy-option h4 {
            margin-bottom: 0.5rem;
        }

        .strategy-option p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .payoff-timeline {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.5rem;
            top: 100%;
            width: 2px;
            height: 1rem;
            background: var(--border);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ============================================= */
        /* GAMIFICATION */
        /* ============================================= */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .achievement {
            padding: 1.5rem;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .achievement.unlocked {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .achievement-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .achievement-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--secondary) 100%);
            color: #000;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .xp-bar {
            margin-top: 1rem;
        }

        .xp-bar .progress-bar {
            height: 8px;
            background: rgba(255, 215, 0, 0.2);
        }

        .xp-bar .progress-fill {
            background: linear-gradient(90deg, var(--gold), var(--secondary));
        }

        /* ============================================= */
        /* ROUND-UPS */
        /* ============================================= */
        .roundup-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, var(--bg-card) 100%);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .coin {
            font-size: 3rem;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .roundup-total {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--success);
        }

        /* ============================================= */
        /* UPLOAD AREA */
        /* ============================================= */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: var(--primary-light);
            background: rgba(45, 90, 39, 0.05);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .upload-area p {
            color: var(--text-secondary);
        }

        /* ============================================= */
        /* BANK ACCOUNT CARDS */
        /* ============================================= */
        .account-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--info);
        }

        .account-card.checking { border-left-color: var(--info); }
        .account-card.savings { border-left-color: var(--success); }
        .account-card.credit { border-left-color: var(--danger); }
        .account-card.investment { border-left-color: var(--gold); }

        .account-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: rgba(255,255,255,0.05);
        }

        .account-info {
            flex: 1;
        }

        .account-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .account-type {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .account-balance {
            text-align: right;
        }

        .account-balance .amount {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .account-balance .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ============================================= */
        /* ALERTS */
        /* ============================================= */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .alert-success {
            background: rgba(42, 157, 143, 0.1);
            border: 1px solid var(--success);
        }

        .alert-warning {
            background: rgba(233, 196, 106, 0.1);
            border: 1px solid var(--warning);
        }

        .alert-danger {
            background: rgba(230, 57, 70, 0.1);
            border: 1px solid var(--danger);
        }

        .alert-info {
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid var(--info);
        }

        /* ============================================= */
        /* LOADING SPINNER */
        /* ============================================= */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================= */
        /* NET WORTH BREAKDOWN */
        /* ============================================= */
        .net-worth-display {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, var(--bg-card) 100%);
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .net-worth-amount {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .net-worth-amount.positive { color: var(--success); }
        .net-worth-amount.negative { color: var(--danger); }

        .net-worth-label {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .net-worth-breakdown {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (max-width: 800px) {
            .net-worth-breakdown {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .breakdown-item {
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }

        .breakdown-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .breakdown-item .value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .breakdown-item .value.positive { color: var(--success); }
        .breakdown-item .value.negative { color: var(--danger); }
    </style>
</head>
<body>
    <!-- TOP NAVIGATION -->
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="nav-logo">
                <i class="fas fa-seedling"></i>
            </div>
            <div>
                <div class="nav-title">Tiny Seed Financial Command Center</div>
                <div class="nav-subtitle">Wealth Builder & Debt Destroyer</div>
            </div>
        </div>
        <div class="nav-status">
            <div class="status-item">
                <div class="status-dot connected"></div>
                <span>Google Sheets Connected</span>
            </div>
            <div class="status-item">
                <div class="status-dot connected"></div>
                <span>Last Sync: Just now</span>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="syncData()">
                <i class="fas fa-sync-alt"></i> Sync
            </button>
        </div>
    </nav>

    <!-- TAB NAVIGATION -->
    <nav class="tab-nav">
        <button class="tab-btn active" onclick="showTab('overview')">
            <i class="fas fa-chart-pie"></i> Overview
        </button>
        <button class="tab-btn" onclick="showTab('debt')">
            <i class="fas fa-fire"></i> Debt Destroyer
            <span class="badge danger" id="debt-count">0</span>
        </button>
        <button class="tab-btn" onclick="showTab('banking')">
            <i class="fas fa-university"></i> Banking & Bills
        </button>
        <button class="tab-btn" onclick="showTab('investments')">
            <i class="fas fa-chart-line"></i> Investments
        </button>
        <button class="tab-btn" onclick="showTab('roundups')">
            <i class="fas fa-coins"></i> Change Investing
        </button>
        <button class="tab-btn" onclick="showTab('employees')">
            <i class="fas fa-users"></i> Team & Retirement
        </button>
        <button class="tab-btn" onclick="showTab('settings')">
            <i class="fas fa-cog"></i> Settings
        </button>
        <button class="tab-btn" onclick="showTab('marketing')">
            <i class="fas fa-bullhorn"></i> Marketing
        </button>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- ============================================= -->
        <!-- OVERVIEW TAB -->
        <!-- ============================================= -->
        <div id="tab-overview" class="tab-content active">
            <!-- Net Worth Display -->
            <div class="net-worth-display">
                <div class="net-worth-amount positive" id="total-net-worth">Loading...</div>
                <div class="net-worth-label">Total Net Worth</div>
                <div class="net-worth-breakdown">
                    <div class="breakdown-item">
                        <div class="label">Total Assets</div>
                        <div class="value positive" id="total-assets">--</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="label">Total Debt</div>
                        <div class="value negative" id="total-debt">--</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="label">Monthly Income</div>
                        <div class="value positive" id="monthly-income">--</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="label">Monthly Expenses</div>
                        <div class="value negative" id="monthly-expenses">--</div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-success" onclick="connectBankWithPlaid()" id="overviewPlaidBtn">
                        <i class="fas fa-link"></i> Connect Bank Account
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Emergency Fund</div>
                            <div class="stat-value" id="emergency-fund">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-header">
                            <span id="emergency-months">-- months covered</span>
                            <span>Goal: 6 months</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="emergency-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Investment Portfolio</div>
                            <div class="stat-value" id="investment-total">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="investment-change">
                        <span>Connect investment accounts</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Total Debt Remaining</div>
                            <div class="stat-value" id="debt-remaining">--</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-fire"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="debt-change">
                        <span>Connect accounts to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Round-Up Savings</div>
                            <div class="stat-value" id="roundup-total">--</div>
                        </div>
                        <div class="stat-icon teal">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Feature coming soon</span>
                    </div>
                </div>
            </div>

            <!-- Action Items -->
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-tasks"></i> Priority Actions</h3>
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">This Month</span>
                    </div>
                    <div class="card-body" id="priority-actions">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle" style="color: var(--info);"></i>
                            <div>
                                <strong>Getting Started:</strong> Connect your bank accounts to see priority actions
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-link" style="color: var(--info);"></i>
                            <div>
                                <strong>Tip:</strong> Go to Banking & Bills to connect via Plaid
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-chart-line" style="color: var(--info);"></i>
                            <div>
                                <strong>Track Progress:</strong> Your actions will appear here based on real data
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-area"></i> Financial Health Score</h3>
                    </div>
                    <div class="card-body" style="text-align: center;">
                        <div style="font-size: 4rem; font-weight: 800; color: var(--text-secondary);" id="health-score">--</div>
                        <div style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 1.5rem;" id="health-status">Connect accounts to calculate</div>
                        <canvas id="healthChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- DEBT DESTROYER TAB -->
        <!-- ============================================= -->
        <div id="tab-debt" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card debt-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Total Debt</div>
                            <div class="stat-value" id="debt-total-display" style="color: var(--danger);">Loading...</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-fire"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="debt-change-display">
                        <span>Connect accounts to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Monthly Minimum</div>
                            <div class="stat-value" id="debt-monthly-min">--</div>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Based on connected accounts</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Credit Utilization</div>
                            <div class="stat-value" id="credit-utilization" style="color: var(--warning);">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="utilization-status">
                        <span>Connect credit cards</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Accounts Tracked</div>
                            <div class="stat-value" id="debt-accounts-count" style="color: var(--success);">0</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-credit-card"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="debt-accounts-status">
                        <span>Add debts to track</span>
                    </div>
                </div>
            </div>

            <!-- Payoff Strategy Selector -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-chess"></i> Payoff Strategy</h3>
                    <button class="btn btn-secondary btn-sm" onclick="recalculatePayoff()">
                        <i class="fas fa-calculator"></i> Recalculate
                    </button>
                </div>
                <div class="card-body">
                    <div class="debt-strategy-selector">
                        <div class="strategy-option active" onclick="selectStrategy('avalanche')">
                            <i class="fas fa-mountain" style="font-size: 2rem; color: var(--info); margin-bottom: 0.5rem;"></i>
                            <h4>Avalanche Method</h4>
                            <p>Pay highest interest first. Saves the most money.</p>
                            <div style="margin-top: 0.5rem; font-weight: 600; color: var(--success);" id="avalanche-savings">Saves the most interest</div>
                        </div>
                        <div class="strategy-option" onclick="selectStrategy('snowball')">
                            <i class="fas fa-snowflake" style="font-size: 2rem; color: var(--teal); margin-bottom: 0.5rem;"></i>
                            <h4>Snowball Method</h4>
                            <p>Pay smallest balance first. Quick wins for motivation.</p>
                            <div style="margin-top: 0.5rem; font-weight: 600; color: var(--success);" id="snowball-estimate">Quick psychological wins</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <!-- Debt List -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Your Debts</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addDebtModal')">
                            <i class="fas fa-plus"></i> Add Debt
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Balance</th>
                                    <th>APR</th>
                                    <th>Min Payment</th>
                                    <th>Payoff</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="debt-table-body">
                                <tr id="debt-loading-row">
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                                        Loading connected accounts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payoff Timeline -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-flag-checkered"></i> Payoff Timeline</h3>
                    </div>
                    <div class="card-body">
                        <div class="payoff-timeline" id="payoff-timeline">
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>Add debts to see your payoff timeline</p>
                                <p style="font-size: 0.85rem;">Connect accounts or add debts manually above</p>
                            </div>
                        </div>

                        <div id="debt-free-summary" style="display: none; margin-top: 2rem; padding: 1.5rem; background: rgba(42, 157, 143, 0.1); border-radius: 12px; text-align: center;">
                            <i class="fas fa-trophy" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
                            <div style="font-weight: 700; font-size: 1.25rem;">DEBT FREE!</div>
                            <div id="debt-free-date" style="color: var(--text-secondary);">Target Date: --</div>
                            <div id="interest-saved" style="margin-top: 0.5rem; color: var(--success); font-weight: 600;">Total Interest Saved: --</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- BANKING TAB -->
        <!-- ============================================= -->
        <div id="tab-banking" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Total Cash</div>
                            <div class="stat-value" id="total-cash-display" style="color: var(--success);">Loading...</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="cash-accounts-count">
                        <span>Connect accounts to view</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Monthly Expenses</div>
                            <div class="stat-value" id="monthly-expenses">--</div>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>From transactions</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Income This Month</div>
                            <div class="stat-value" id="monthly-income" style="color: var(--success);">--</div>
                        </div>
                        <div class="stat-icon teal">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>From transactions</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Cash Flow</div>
                            <div class="stat-value" id="cash-flow-display" style="color: var(--success);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="cash-flow-status">
                        <span>Income - Expenses</span>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <!-- Bank Accounts -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-university"></i> Bank Accounts</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success btn-sm" onclick="connectBankWithPlaid()" id="plaidConnectBtn">
                                <i class="fas fa-link"></i> Connect Bank
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="openModal('addAccountModal')">
                                <i class="fas fa-plus"></i> Add Manual
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="bank-accounts-container">
                        <div id="no-accounts-message" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-university" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No accounts connected yet</p>
                            <p style="font-size: 0.85rem;">Click "Connect Bank" to link your accounts via Plaid</p>
                        </div>

                        <div class="upload-area" onclick="document.getElementById('bankStatementUpload').click()">
                            <input type="file" id="bankStatementUpload" style="display: none;" accept=".csv,.pdf,.ofx,.qfx" onchange="handleBankUpload(this)">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drop bank statement here or click to upload</p>
                            <p style="font-size: 0.75rem; margin-top: 0.5rem;">Supports CSV, PDF, OFX, QFX</p>
                        </div>
                    </div>
                </div>

                <!-- Bills -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-file-invoice"></i> Upcoming Bills</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addBillModal')">
                            <i class="fas fa-plus"></i> Add Bill
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bill</th>
                                    <th>Due</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="bills-table-body">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-file-invoice" style="margin-right: 0.5rem;"></i>
                                        No bills added yet. Click "Add Bill" to track recurring expenses.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> Recent Transactions</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="form-input" id="transaction-account-filter" style="width: auto; padding: 0.5rem 1rem;">
                            <option value="all">All Accounts</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="refreshTransactions()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Account</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                                    Loading transactions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- INVESTMENTS TAB -->
        <!-- ============================================= -->
        <div id="tab-investments" class="tab-content">
            <div class="alert alert-info">
                <i class="fas fa-info-circle" style="color: var(--info);"></i>
                <div>
                    <strong>Investment Dashboard:</strong> For detailed portfolio management,
                    <a href="wealth-builder.html" style="color: var(--primary-light);">open the full Wealth Builder dashboard</a>.
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Portfolio Value</div>
                            <div class="stat-value" id="investment-total" style="color: var(--success);">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="investment-change">
                        <span>Connect investment accounts</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">This Month's Contribution</div>
                            <div class="stat-value" id="monthly-contribution">--</div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Set up auto-invest</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Growth Mode</div>
                            <div class="stat-value" id="growth-mode" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-rocket"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Configure strategy</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Current Drawdown</div>
                            <div class="stat-value" id="current-drawdown" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Market data unavailable</span>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i> Current Allocation</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <canvas id="allocationPieChart"></canvas>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem;">HOLDINGS</h4>
                                <div id="holdings-list">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar-alt"></i> Seasonal Schedule</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; margin-bottom: 1.5rem;">
                            <div style="padding: 1rem; text-align: center; background: rgba(230, 57, 70, 0.1); border: 1px solid var(--danger); border-right: none;">
                                <div style="font-weight: 600; font-size: 0.85rem;">Winter</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Nov-Feb</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">0.25x</div>
                            </div>
                            <div style="padding: 1rem; text-align: center; background: rgba(233, 196, 106, 0.1); border: 1px solid var(--warning);">
                                <div style="font-weight: 600; font-size: 0.85rem;">Planting</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Mar-May</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">0.75x</div>
                            </div>
                            <div style="padding: 1rem; text-align: center; background: rgba(42, 157, 143, 0.1); border: 1px solid var(--success); border-left: none;">
                                <div style="font-weight: 600; font-size: 0.85rem;">Harvest</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Jun-Oct</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">1.5x</div>
                            </div>
                        </div>
                        <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Current Season</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="current-season">--</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                Configure seasonal contributions
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; padding: 2rem;">
                <a href="wealth-builder.html" class="btn btn-primary" style="font-size: 1rem; padding: 1rem 2rem;">
                    <i class="fas fa-external-link-alt"></i> Open Full Investment Dashboard
                </a>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- ROUND-UPS TAB -->
        <!-- ============================================= -->
        <div id="tab-roundups" class="tab-content">
            <div class="roundup-animation">
                <div class="coin">
                    <i class="fas fa-coins" style="color: var(--gold);"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Round-Up Savings</div>
                    <div class="roundup-total" id="roundup-total-display">--</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Feature coming soon</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">This Month's Round-Ups</div>
                            <div class="stat-value" id="monthly-roundups" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon teal">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Enable round-ups to start</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Average Per Order</div>
                            <div class="stat-value" id="avg-roundup">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Round up to nearest $1</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Invested So Far</div>
                            <div class="stat-value" id="roundup-invested" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Connect investment account</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Pending Transfer</div>
                            <div class="stat-value" id="pending-transfer">--</div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Transfers at $100</span>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-receipt"></i> Recent Round-Ups</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order</th>
                                    <th>Amount</th>
                                    <th>Round-Up</th>
                                </tr>
                            </thead>
                            <tbody id="roundups-table-body">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-coins" style="margin-right: 0.5rem;"></i>
                                        No round-ups yet. Enable the feature to start saving automatically.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-cog"></i> Round-Up Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Round-Up Amount</label>
                            <select class="form-input">
                                <option value="1" selected>Round to nearest $1.00</option>
                                <option value="2">Round to nearest $2.00</option>
                                <option value="5">Round to nearest $5.00</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Auto-Transfer Threshold</label>
                            <select class="form-input">
                                <option value="50">Transfer at $50</option>
                                <option value="100" selected>Transfer at $100</option>
                                <option value="250">Transfer at $250</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Transfer Destination</label>
                            <select class="form-input">
                                <option value="investment" selected>Investment Portfolio</option>
                                <option value="emergency">Emergency Fund</option>
                                <option value="debt">Extra Debt Payment</option>
                            </select>
                        </div>

                        <div style="padding: 1rem; background: rgba(42, 157, 143, 0.1); border-radius: 8px; margin-top: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <input type="checkbox" id="enableRoundups" checked style="width: 20px; height: 20px;">
                                <label for="enableRoundups" style="font-weight: 600;">Enable Round-Ups</label>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem; margin-left: 2rem;">
                                Automatically round up every farm sale and invest the difference.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- TEAM & RETIREMENT TAB -->
        <!-- ============================================= -->
        <div id="tab-employees" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">SEP-IRA Contributions (YTD)</div>
                            <div class="stat-value" id="sep-ira-ytd" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Set up SEP-IRA to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Team Members</div>
                            <div class="stat-value" id="team-count">--</div>
                        </div>
                        <div class="stat-icon purple">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Add employees to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Incentive Pool</div>
                            <div class="stat-value" id="incentive-pool" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-gift"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Configure incentive program</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Milestones Reached</div>
                            <div class="stat-value" id="milestones-count" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>No data yet</span>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <!-- Employee IRA Contributions -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-piggy-bank"></i> SEP-IRA Contributions</h3>
                        <button class="btn btn-success btn-sm" onclick="openModal('addIRAContributionModal')">
                            <i class="fas fa-plus"></i> Add Contribution
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="padding: 1rem; background: rgba(42, 157, 143, 0.1); border-bottom: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-secondary);">Annual Contribution Limit (25% of comp)</span>
                                <span style="font-weight: 600;">$66,000 max</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Farm Contribution Rate</span>
                                <span style="font-weight: 600; color: var(--success);">3% of wages</span>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>YTD Wages</th>
                                    <th>IRA Contribution</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="iraContributionsTable">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-piggy-bank" style="margin-right: 0.5rem;"></i>
                                        No SEP-IRA contributions recorded. Click "Add Contribution" to get started.
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot style="background: rgba(255,255,255,0.03);">
                                <tr>
                                    <td style="font-weight: 700;">Total</td>
                                    <td style="font-weight: 700;" id="ira-total-wages">--</td>
                                    <td style="font-weight: 700; color: var(--success);" id="ira-total-contributions">--</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Milestone Incentives (Non-Competitive) -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-gift"></i> Milestone Incentives</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Earn bonuses by reaching personal milestones - not a competition, just recognition for your hard work!
                        </p>

                        <h4 style="margin: 1rem 0 0.75rem; color: var(--text-secondary); font-size: 0.85rem;">WORK MILESTONES</h4>
                        <div class="achievement-grid">
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-calendar-check" style="color: var(--success);"></i>
                                </div>
                                <div class="achievement-name">30-Day Mark</div>
                                <div class="achievement-desc">$50 bonus</div>
                            </div>
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-calendar-alt" style="color: var(--info);"></i>
                                </div>
                                <div class="achievement-name">90-Day Mark</div>
                                <div class="achievement-desc">$100 bonus</div>
                            </div>
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-award" style="color: var(--secondary);"></i>
                                </div>
                                <div class="achievement-name">1 Year</div>
                                <div class="achievement-desc">$250 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="achievement-name">2 Years</div>
                                <div class="achievement-desc">$500 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-gem"></i>
                                </div>
                                <div class="achievement-name">5 Years</div>
                                <div class="achievement-desc">$1,000 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-crown"></i>
                                </div>
                                <div class="achievement-name">500 Hours/Season</div>
                                <div class="achievement-desc">$200 bonus</div>
                            </div>
                        </div>

                        <h4 style="margin: 1.5rem 0 0.75rem; color: var(--text-secondary); font-size: 0.85rem;">SKILL MILESTONES</h4>
                        <div class="achievement-grid">
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-seedling" style="color: var(--success);"></i>
                                </div>
                                <div class="achievement-name">Greenhouse Certified</div>
                                <div class="achievement-desc">$75 bonus</div>
                            </div>
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-truck" style="color: var(--info);"></i>
                                </div>
                                <div class="achievement-name">Delivery Trained</div>
                                <div class="achievement-desc">$75 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-tractor"></i>
                                </div>
                                <div class="achievement-name">Equipment Operator</div>
                                <div class="achievement-desc">$100 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                                <div class="achievement-name">Trained a New Hire</div>
                                <div class="achievement-desc">$50 bonus</div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(233, 196, 106, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                <i class="fas fa-lightbulb" style="color: var(--warning);"></i> How It Works
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5;">
                                Milestones are personal achievements - reach them at your own pace.
                                Bonuses are paid within 2 pay periods of reaching each milestone.
                                Everyone can earn every bonus!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- SETTINGS TAB -->
        <!-- ============================================= -->
        <div id="tab-settings" class="tab-content">
            <div class="three-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-link"></i> Connections</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Google Sheets ID</label>
                            <input type="text" class="form-input" value="128O56X_FN9_U-s0ENHBBRyLpae_yvWHPYbBheVlR3Vc">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apps Script URL</label>
                            <input type="text" class="form-input" placeholder="Your deployed Apps Script URL">
                        </div>
                        <button class="btn btn-primary">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-bell"></i> Notifications</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>Bill Due Reminders</span>
                                <input type="checkbox" checked>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>Debt Milestone Alerts</span>
                                <input type="checkbox" checked>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>Investment Rebalance Alerts</span>
                                <input type="checkbox" checked>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0;">
                                <span>Employee Achievement Notifications</span>
                                <input type="checkbox" checked>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-dollar-sign"></i> Financial Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Monthly Expenses (for emergency fund calc)</label>
                            <input type="number" class="form-input" value="8000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Base Monthly Investment</label>
                            <input type="number" class="form-input" value="1000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Emergency Fund Goal (months)</label>
                            <input type="number" class="form-input" value="6">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-download"></i> Import / Export</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div class="upload-area">
                            <i class="fas fa-file-csv"></i>
                            <p>Import Bank Statement</p>
                        </div>
                        <div class="upload-area">
                            <i class="fas fa-file-invoice"></i>
                            <p>Import Bills</p>
                        </div>
                        <div class="upload-area">
                            <i class="fas fa-file-export"></i>
                            <p>Export All Data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- MARKETING TAB -->
        <!-- ============================================= -->
        <div id="tab-marketing" class="tab-content">
            <!-- Marketing Budget Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Marketing Budget</div>
                            <div class="stat-value" id="marketing-budget">--</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #E1306C, #9b59b6);">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Set budget to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Spent This Month</div>
                            <div class="stat-value" id="marketing-spent">--</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-header">
                            <span id="marketing-spent-percent">--</span>
                            <span id="marketing-remaining">Log expenses to track</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill success" id="marketing-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">ROI This Month</div>
                            <div class="stat-value" id="marketing-roi">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Track spend to calculate ROI</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Posts This Month</div>
                            <div class="stat-value" id="marketing-posts">--</div>
                        </div>
                        <div class="stat-icon teal">
                            <i class="fas fa-share-alt"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Connect social accounts</span>
                    </div>
                </div>
            </div>

            <!-- Marketing Spend Breakdown -->
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i> Spend by Category</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addMarketingSpendModal')">
                            <i class="fas fa-plus"></i> Log Expense
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="marketing-spend-categories">
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <i class="fas fa-chart-pie" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No marketing spend logged yet</p>
                                <p style="font-size: 0.85rem;">Click "Log Expense" to start tracking</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-history"></i> Recent Marketing Spend</h3>
                        <a href="marketing-command-center.html" class="btn btn-secondary btn-sm">
                            <i class="fas fa-external-link-alt"></i> Marketing Hub
                        </a>
                    </div>
                    <div class="card-body">
                        <div id="marketing-spend-history" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No expenses logged yet</p>
                                <p style="font-size: 0.85rem;">Marketing expenses will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marketing Fund Allocation -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-piggy-bank"></i> Marketing Fund</h3>
                    <button class="btn btn-success btn-sm" onclick="openModal('allocateMarketingModal')">
                        <i class="fas fa-plus"></i> Add Funds
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Marketing Fund Balance:</strong> <span id="marketing-balance">--</span>
                            <br><small>Configure marketing fund to track spend vs budget</small>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: var(--surface-secondary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Monthly Auto-Allocation</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="marketing-auto-percent">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Configure in settings</div>
                        </div>
                        <div style="padding: 1rem; background: var(--surface-secondary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Last Deposit</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="marketing-last-deposit">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">No deposits yet</div>
                        </div>
                        <div style="padding: 1rem; background: var(--surface-secondary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">YTD Spend</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="marketing-ytd-spend">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Log expenses to track</div>
                        </div>
                        <div style="padding: 1rem; background: var(--surface-secondary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Avg. Cost Per Post</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="marketing-cost-per-post">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Connect social accounts</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                        <a href="marketing-command-center.html" class="btn btn-primary">
                            <i class="fas fa-bullhorn"></i> Open Marketing Hub
                        </a>
                        <button class="btn btn-secondary" onclick="openModal('addMarketingSpendModal')">
                            <i class="fas fa-receipt"></i> Log Marketing Expense
                        </button>
                        <button class="btn btn-secondary" onclick="openModal('allocateMarketingModal')">
                            <i class="fas fa-hand-holding-usd"></i> Add to Marketing Fund
                        </button>
                        <button class="btn btn-secondary" onclick="loadMarketingData()">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ============================================= -->
    <!-- MODALS -->
    <!-- ============================================= -->

    <!-- Add Debt Modal -->
    <div class="modal-overlay" id="addDebtModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Add Debt Account</h2>
                <button class="modal-close" onclick="closeModal('addDebtModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Connect via Plaid - Primary Option -->
                <div style="background: linear-gradient(135deg, rgba(42, 157, 143, 0.1), rgba(38, 70, 83, 0.1)); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                    <i class="fas fa-link" style="font-size: 2rem; color: var(--success); margin-bottom: 0.75rem;"></i>
                    <h3 style="margin: 0 0 0.5rem; color: var(--text-primary);">Connect Credit Card via Plaid</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Auto-sync balances, payments, and transactions</p>
                    <button class="btn btn-success" onclick="closeModal('addDebtModal'); connectBankWithPlaid();">
                        <i class="fas fa-credit-card"></i> Connect Credit Card
                    </button>
                </div>

                <div style="text-align: center; color: var(--text-secondary); margin: 1rem 0; font-size: 0.85rem;">
                     or add manually (not recommended) 
                </div>

                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" placeholder="e.g., Chase Visa">
                </div>
                <div class="form-group">
                    <label class="form-label">Debt Type</label>
                    <select class="form-input">
                        <option>Credit Card</option>
                        <option>Personal Loan</option>
                        <option>Auto Loan</option>
                        <option>Mortgage</option>
                        <option>Student Loan</option>
                        <option>Medical Debt</option>
                        <option>PayPal Credit (Synchrony)</option>
                        <option>Other</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Current Balance</label>
                        <input type="number" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Interest Rate (APR %)</label>
                        <input type="number" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Minimum Payment</label>
                        <input type="number" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="number" class="form-input" placeholder="Day of month (1-31)" min="1" max="31">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addDebtModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveDebt()">
                    <i class="fas fa-save"></i> Save Debt
                </button>
            </div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal-overlay" id="addAccountModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-university"></i> Add Bank Account</h2>
                <button class="modal-close" onclick="closeModal('addAccountModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" placeholder="e.g., Farm Operations Checking">
                </div>
                <div class="form-group">
                    <label class="form-label">Account Type</label>
                    <select class="form-input">
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                        <option value="investment">Investment</option>
                        <option value="credit">Credit Card</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Institution</label>
                    <input type="text" class="form-input" placeholder="e.g., First National Bank">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Current Balance</label>
                        <input type="number" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last 4 Digits</label>
                        <input type="text" class="form-input" placeholder="1234" maxlength="4">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addAccountModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAccount()">
                    <i class="fas fa-save"></i> Save Account
                </button>
            </div>
        </div>
    </div>

    <!-- Add Bill Modal -->
    <div class="modal-overlay" id="addBillModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice"></i> Add Bill</h2>
                <button class="modal-close" onclick="closeModal('addBillModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Bill Name</label>
                    <input type="text" class="form-input" placeholder="e.g., Electric - PG&E">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input">
                        <option>Utility</option>
                        <option>Insurance</option>
                        <option>Subscription</option>
                        <option>Loan Payment</option>
                        <option>Rent/Mortgage</option>
                        <option>Farm Expense</option>
                        <option>Other</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Day (monthly)</label>
                        <input type="number" class="form-input" placeholder="1-31" min="1" max="31">
                    </div>
                </div>
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="autoPay">
                        <label for="autoPay">Auto-Pay Enabled</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addBillModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveBill()">
                    <i class="fas fa-save"></i> Save Bill
                </button>
            </div>
        </div>
    </div>

    <!-- Add Marketing Spend Modal -->
    <div class="modal-overlay" id="addMarketingSpendModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-receipt"></i> Log Marketing Expense</h2>
                <button class="modal-close" onclick="closeModal('addMarketingSpendModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="marketingSpendDesc" placeholder="e.g., Instagram Boost - CSA Promo">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="marketingSpendCategory">
                        <option value="social_ads">Social Media Ads</option>
                        <option value="sms">SMS/Twilio</option>
                        <option value="subscription">Subscriptions (Ayrshare, etc)</option>
                        <option value="print">Print Materials</option>
                        <option value="photography">Photography/Content</option>
                        <option value="events">Events & Sponsorships</option>
                        <option value="direct_mail">Direct Mail</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" id="marketingSpendAmount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="marketingSpendDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Campaign (Optional)</label>
                    <select class="form-input" id="marketingSpendCampaign">
                        <option value="">-- No Campaign --</option>
                        <option value="csa_spring_2026">CSA Spring 2026</option>
                        <option value="farmers_market">Farmer's Market Promotion</option>
                        <option value="restaurant_outreach">Restaurant Outreach</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="marketingSpendNotes" rows="2" placeholder="Optional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addMarketingSpendModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveMarketingSpend()">
                    <i class="fas fa-save"></i> Log Expense
                </button>
            </div>
        </div>
    </div>

    <!-- Allocate Marketing Funds Modal -->
    <div class="modal-overlay" id="allocateMarketingModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-hand-holding-usd"></i> Add to Marketing Fund</h2>
                <button class="modal-close" onclick="closeModal('allocateMarketingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Current Balance:</strong> <span id="modal-marketing-balance">--</span>
                        <br><small>Add funds manually or adjust auto-allocation settings</small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Add One-Time Amount</label>
                    <input type="number" class="form-input" id="marketingFundAmount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Source</label>
                    <select class="form-input" id="marketingFundSource">
                        <option value="cash">Cash Transfer</option>
                        <option value="sales">Sales Revenue</option>
                        <option value="grant">Grant/Award</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <hr style="margin: 1.5rem 0; border-color: var(--border);">
                <h4 style="margin-bottom: 1rem;">Auto-Allocation Settings</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Percentage of Sales</label>
                        <input type="number" class="form-input" id="marketingAutoPercent" value="2" min="0" max="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Cap</label>
                        <input type="number" class="form-input" id="marketingMonthlyCap" placeholder="500" step="50">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('allocateMarketingModal')">Cancel</button>
                <button class="btn btn-primary" onclick="allocateMarketingFunds()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- JAVASCRIPT -->
    <!-- ============================================= -->
    <script>
        // =============================================
        // TAB NAVIGATION
        // =============================================
        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabId).classList.add('active');

            // Activate button
            event.target.closest('.tab-btn').classList.add('active');
        }

        // =============================================
        // MODAL FUNCTIONS
        // =============================================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // =============================================
        // DEBT DESTROYER FUNCTIONS
        // =============================================
        let currentStrategy = 'avalanche';

        function selectStrategy(strategy) {
            currentStrategy = strategy;
            document.querySelectorAll('.strategy-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.closest('.strategy-option').classList.add('active');
            recalculatePayoff();
        }

        function recalculatePayoff() {
            // This would recalculate the payoff timeline based on strategy
            console.log('Recalculating payoff with strategy:', currentStrategy);
            // In production, this would call the Google Sheets API
        }

        function saveDebt() {
            // Save debt to Google Sheets
            console.log('Saving debt...');
            closeModal('addDebtModal');
            // In production: call Apps Script API
        }

        function editDebt(debtId) {
            console.log('Editing debt:', debtId);
            // Open modal with debt data
        }

        // =============================================
        // BANKING FUNCTIONS
        // =============================================
        function saveAccount() {
            console.log('Saving account...');
            closeModal('addAccountModal');
        }

        function saveBill() {
            console.log('Saving bill...');
            closeModal('addBillModal');
        }

        function handleBankUpload(input) {
            const file = input.files[0];
            if (file) {
                console.log('Uploading bank statement:', file.name);
                // Parse and import transactions
            }
        }

        // =============================================
        // SYNC FUNCTION
        // =============================================
        function syncData() {
            console.log('Syncing with Google Sheets...');
            // In production: call Apps Script API to refresh all data
        }

        // =============================================
        // CHARTS
        // =============================================

        // Financial Health Chart
        const healthCtx = document.getElementById('healthChart');
        if (healthCtx) {
            new Chart(healthCtx.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['Emergency Fund', 'Debt-to-Income', 'Savings Rate', 'Investment Growth', 'Cash Flow'],
                    datasets: [{
                        label: 'Your Score',
                        data: [50, 65, 80, 75, 85],
                        backgroundColor: 'rgba(42, 157, 143, 0.2)',
                        borderColor: 'rgba(42, 157, 143, 1)',
                        pointBackgroundColor: 'rgba(42, 157, 143, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(42, 157, 143, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: '#8d99ae' },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Allocation Pie Chart
        const allocationCtx = document.getElementById('allocationPieChart');
        if (allocationCtx) {
            const allocationData = [
                { ticker: 'VTI', percent: 15.0, color: '#2a9d8f' },
                { ticker: 'VXUS', percent: 7.5, color: '#264653' },
                { ticker: 'BND', percent: 15.0, color: '#4361ee' },
                { ticker: 'TIP', percent: 11.25, color: '#3a86ff' },
                { ticker: 'GOVT', percent: 7.5, color: '#8338ec' },
                { ticker: 'GLD', percent: 5.625, color: '#ffd700' },
                { ticker: 'DBC', percent: 3.75, color: '#fb8500' },
                { ticker: 'SHY', percent: 7.5, color: '#90be6d' },
                { ticker: 'QQQ', percent: 12.5, color: '#f4a261' },
                { ticker: 'MTUM', percent: 12.5, color: '#e76f51' }
            ];

            new Chart(allocationCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: allocationData.map(d => d.ticker),
                    datasets: [{
                        data: allocationData.map(d => d.percent),
                        backgroundColor: allocationData.map(d => d.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Populate holdings list
            const holdingsList = document.getElementById('holdings-list');
            allocationData.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);';
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; border-radius: 3px; background: ${item.color};"></div>
                        <span style="font-weight: 500;">${item.ticker}</span>
                    </div>
                    <span style="color: var(--text-secondary);">${item.percent}%</span>
                `;
                holdingsList.appendChild(div);
            });
        }

        // =============================================
        // GOOGLE SHEETS API INTEGRATION
        // =============================================
        const API_CONFIG = {
            sheetId: '128O56X_FN9_U-s0ENHBBRyLpae_yvWHPYbBheVlR3Vc',
            apiUrl: 'https://script.google.com/macros/s/AKfycbxwlNBHBKBS1sSDHXFbnmuZvhNpHlKi9qJ8crPzB2Iy39zeh0FjTcu9bCxhsz9ugBdc/exec'
        };

        // =============================================
        // UNIFIED FINANCIAL STATE MANAGER
        // =============================================
        // Central state that all tabs read from and write to
        const FinancialState = {
            // Raw data from sources
            plaidAccounts: [],
            plaidTransactions: [],
            shopifyPayments: { pending: 0 },
            shopifyCapital: { balance: 0, originalAmount: 0, repaymentRate: 0 },
            paypalBalance: { available: 0, pending: 0 },
            paypalTransactions: [],

            // Calculated totals
            totals: {
                assets: 0,
                debt: 0,
                netWorth: 0,
                cash: 0,
                investments: 0,
                emergencyFund: 0,
                creditLimit: 0,
                creditUsed: 0,
                monthlyIncome: 0,
                monthlyExpenses: 0
            },

            // Update state and trigger UI refresh
            update(source, data) {
                console.log(`[FinancialState] Updating ${source}:`, data);

                switch(source) {
                    case 'plaidAccounts':
                        this.plaidAccounts = data || [];
                        break;
                    case 'plaidTransactions':
                        this.plaidTransactions = data || [];
                        break;
                    case 'shopifyPayments':
                        this.shopifyPayments = data || { pending: 0 };
                        break;
                    case 'shopifyCapital':
                        this.shopifyCapital = data || { balance: 0 };
                        break;
                    case 'paypalBalance':
                        this.paypalBalance = data || { available: 0, pending: 0 };
                        break;
                    case 'paypalTransactions':
                        this.paypalTransactions = data || [];
                        break;
                }

                this.recalculateTotals();
                this.refreshAllUI();
            },

            recalculateTotals() {
                let assets = 0, debt = 0, cash = 0, investments = 0, emergencyFund = 0;
                let creditLimit = 0, creditUsed = 0;

                // Process Plaid accounts
                this.plaidAccounts.forEach(account => {
                    const balance = account.balance_current || 0;
                    const limit = account.balance_limit || 0;
                    const subtype = (account.subtype || '').toLowerCase();
                    const type = (account.type || '').toLowerCase();

                    // Assets
                    if (subtype === 'checking' || subtype === 'savings' ||
                        subtype === 'money market' || subtype === 'cd' || type === 'depository') {
                        assets += balance;
                        cash += balance;
                        if (subtype === 'savings' || subtype === 'money market') {
                            emergencyFund += balance;
                        }
                    }

                    // Investments
                    if (type === 'investment' || subtype === 'brokerage' ||
                        subtype === '401k' || subtype === 'ira') {
                        assets += balance;
                        investments += balance;
                    }

                    // Debt (credit cards, loans)
                    if (subtype === 'credit card' || type === 'credit') {
                        debt += Math.abs(balance);
                        creditUsed += Math.abs(balance);
                        creditLimit += limit;
                    } else if (type === 'loan' || subtype === 'loan' ||
                               subtype === 'mortgage' || subtype === 'student') {
                        debt += Math.abs(balance);
                    }
                });

                // Add Shopify Capital to debt
                if (this.shopifyCapital.balance > 0) {
                    debt += this.shopifyCapital.balance;
                }

                // Add PayPal balance to cash
                if (this.paypalBalance.available > 0) {
                    cash += this.paypalBalance.available;
                    assets += this.paypalBalance.available;
                }

                // Add Shopify pending to assets (it's money owed to you)
                if (this.shopifyPayments.pending > 0) {
                    // Don't add to assets - it's pending, not available
                }

                // Calculate monthly income/expenses from transactions
                let monthlyIncome = 0, monthlyExpenses = 0;
                this.plaidTransactions.forEach(txn => {
                    if (txn.pending) return;
                    const amount = txn.amount || 0;
                    if (amount < 0) {
                        monthlyIncome += Math.abs(amount);
                    } else {
                        monthlyExpenses += amount;
                    }
                });

                // Store calculated totals
                this.totals = {
                    assets,
                    debt,
                    netWorth: assets - debt,
                    cash,
                    investments,
                    emergencyFund,
                    creditLimit,
                    creditUsed,
                    creditUtilization: creditLimit > 0 ? Math.round((creditUsed / creditLimit) * 100) : 0,
                    monthlyIncome,
                    monthlyExpenses
                };

                console.log('[FinancialState] Totals recalculated:', this.totals);
            },

            refreshAllUI() {
                // Overview tab
                this.updateElement('total-net-worth', this.formatCurrency(this.totals.netWorth),
                    this.totals.netWorth >= 0 ? 'positive' : 'negative');
                this.updateElement('total-assets', this.formatCurrency(this.totals.assets));
                this.updateElement('total-debt', this.totals.debt > 0 ? '-' + this.formatCurrency(this.totals.debt) : '$0');
                this.updateElement('monthly-income', this.formatCurrency(this.totals.monthlyIncome));
                this.updateElement('monthly-expenses', this.formatCurrency(this.totals.monthlyExpenses));
                this.updateElement('emergency-fund', this.formatCurrency(this.totals.emergencyFund));
                this.updateElement('investment-total', this.formatCurrency(this.totals.investments));
                this.updateElement('debt-remaining', this.formatCurrency(this.totals.debt));

                // Emergency fund coverage (assuming $3000/month expenses)
                const monthlyExpenseEstimate = this.totals.monthlyExpenses || 3000;
                const monthsCovered = monthlyExpenseEstimate > 0 ?
                    (this.totals.emergencyFund / monthlyExpenseEstimate).toFixed(1) : 0;
                this.updateElement('emergency-months', monthsCovered + ' months covered');
                const emergencyProgress = document.getElementById('emergency-progress');
                if (emergencyProgress) {
                    const percent = Math.min((monthsCovered / 6) * 100, 100);
                    emergencyProgress.style.width = percent + '%';
                    emergencyProgress.className = 'progress-fill ' +
                        (percent >= 100 ? 'success' : percent >= 50 ? 'warning' : 'danger');
                }

                // Banking tab
                this.updateElement('total-cash-display', this.formatCurrency(this.totals.cash));
                const cashCount = this.plaidAccounts.filter(a =>
                    ['checking', 'savings', 'money market'].includes((a.subtype || '').toLowerCase())
                ).length;
                this.updateElement('cash-accounts-count', cashCount + ' account' + (cashCount !== 1 ? 's' : '') + ' connected', null, true);

                // Debt destroyer tab
                const debtAccounts = this.plaidAccounts.filter(a => {
                    const subtype = (a.subtype || '').toLowerCase();
                    const type = (a.type || '').toLowerCase();
                    return subtype === 'credit card' || type === 'credit' || type === 'loan';
                });
                let debtCount = debtAccounts.length;
                if (this.shopifyCapital.balance > 0) debtCount++;

                this.updateElement('debt-total-display', this.formatCurrency(this.totals.debt));
                this.updateElement('debt-accounts-count', debtCount.toString());
                this.updateElement('debt-count', debtCount.toString()); // Tab badge

                // Credit utilization
                if (this.totals.creditLimit > 0) {
                    this.updateElement('credit-utilization', this.totals.creditUtilization + '%');
                    const utilizationStatus = document.getElementById('utilization-status');
                    if (utilizationStatus) {
                        const util = this.totals.creditUtilization;
                        utilizationStatus.innerHTML = '<span>' +
                            (util < 30 ? 'Excellent' : util < 50 ? 'Good' : util < 75 ? 'Fair' : 'High') +
                            '</span>';
                    }
                }

                // Financial Health Score
                this.calculateHealthScore();
            },

            calculateHealthScore() {
                // Weighted scoring algorithm
                let score = 50; // Base score

                // Emergency fund (+/- 15 points)
                const monthsExpenses = this.totals.monthlyExpenses || 3000;
                const monthsCovered = this.totals.emergencyFund / monthsExpenses;
                if (monthsCovered >= 6) score += 15;
                else if (monthsCovered >= 3) score += 10;
                else if (monthsCovered >= 1) score += 5;
                else score -= 10;

                // Credit utilization (+/- 15 points)
                const util = this.totals.creditUtilization;
                if (util === 0) score += 10;
                else if (util < 10) score += 15;
                else if (util < 30) score += 10;
                else if (util < 50) score += 0;
                else if (util < 75) score -= 10;
                else score -= 15;

                // Net worth (+/- 10 points)
                if (this.totals.netWorth > 50000) score += 10;
                else if (this.totals.netWorth > 10000) score += 5;
                else if (this.totals.netWorth > 0) score += 0;
                else score -= 10;

                // Cash flow (+/- 10 points)
                const cashFlow = this.totals.monthlyIncome - this.totals.monthlyExpenses;
                if (cashFlow > 1000) score += 10;
                else if (cashFlow > 0) score += 5;
                else score -= 10;

                score = Math.max(0, Math.min(100, score));

                const healthEl = document.getElementById('health-score');
                const statusEl = document.getElementById('health-status');
                if (healthEl) {
                    healthEl.textContent = score;
                    healthEl.style.color = score >= 70 ? 'var(--success)' :
                                          score >= 50 ? 'var(--warning)' : 'var(--danger)';
                }
                if (statusEl) {
                    statusEl.textContent = score >= 80 ? 'Excellent' :
                                          score >= 70 ? 'Good' :
                                          score >= 50 ? 'Fair' : 'Needs Work';
                }
            },

            formatCurrency(amount) {
                return '$' + Math.abs(amount || 0).toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            },

            updateElement(id, value, className, isHtml) {
                const el = document.getElementById(id);
                if (el) {
                    if (isHtml) {
                        el.innerHTML = '<span>' + value + '</span>';
                    } else {
                        el.textContent = value;
                    }
                    if (className) {
                        el.classList.remove('positive', 'negative');
                        el.classList.add(className);
                    }
                }
            }
        };

        async function fetchFromSheet(endpoint, params = {}) {
            if (!API_CONFIG.apiUrl) {
                console.warn('API URL not configured - using demo data');
                return null;
            }

            try {
                const url = new URL(API_CONFIG.apiUrl);
                url.searchParams.append('action', endpoint);
                Object.entries(params).forEach(([key, value]) => {
                    url.searchParams.append(key, value);
                });

                const response = await fetch(url.toString());
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }

        async function saveToSheet(endpoint, data) {
            if (!API_CONFIG.apiUrl) {
                console.warn('API URL not configured');
                return false;
            }

            try {
                // Use text/plain to avoid CORS preflight
                const response = await fetch(API_CONFIG.apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: endpoint, data })
                });
                return await response.json();
            } catch (error) {
                console.error('Save Error:', error);
                return false;
            }
        }

        // =============================================
        // DEBT PAYOFF CALCULATOR
        // =============================================
        class DebtPayoffCalculator {
            constructor(debts, extraPayment = 0) {
                this.debts = debts.map(d => ({ ...d })); // Clone
                this.extraPayment = extraPayment;
            }

            avalanche() {
                // Sort by interest rate (highest first)
                return this.debts.sort((a, b) => b.apr - a.apr);
            }

            snowball() {
                // Sort by balance (lowest first)
                return this.debts.sort((a, b) => a.balance - b.balance);
            }

            calculatePayoff(strategy = 'avalanche') {
                const sortedDebts = strategy === 'avalanche' ? this.avalanche() : this.snowball();
                const timeline = [];
                let currentMonth = new Date();
                let totalInterestPaid = 0;

                // Clone debts for calculation
                let remaining = sortedDebts.map(d => ({ ...d }));

                while (remaining.length > 0) {
                    // Apply minimum payments to all debts
                    remaining.forEach(debt => {
                        const monthlyInterest = debt.balance * (debt.apr / 100 / 12);
                        totalInterestPaid += monthlyInterest;
                        debt.balance += monthlyInterest - debt.minPayment;
                    });

                    // Apply extra payment to first debt
                    if (remaining.length > 0) {
                        remaining[0].balance -= this.extraPayment;
                    }

                    // Check for paid off debts
                    remaining = remaining.filter(debt => {
                        if (debt.balance <= 0) {
                            timeline.push({
                                name: debt.name,
                                paidOffDate: new Date(currentMonth),
                                originalBalance: debt.originalBalance
                            });
                            // Roll over freed-up payment
                            this.extraPayment += debt.minPayment;
                            return false;
                        }
                        return true;
                    });

                    currentMonth.setMonth(currentMonth.getMonth() + 1);

                    // Safety: prevent infinite loop
                    if (currentMonth.getFullYear() > 2040) break;
                }

                return {
                    timeline,
                    totalInterestPaid: Math.round(totalInterestPaid * 100) / 100,
                    debtFreeDate: timeline[timeline.length - 1]?.paidOffDate
                };
            }
        }

        // =============================================
        // PLAID BANK CONNECTION
        // =============================================
        let plaidHandler = null;

        async function connectBankWithPlaid() {
            const btn = document.getElementById('plaidConnectBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            btn.disabled = true;

            try {
                // Get link token from our Apps Script backend
                const response = await fetchFromSheet('createPlaidLinkToken');

                if (!response || !response.success) {
                    throw new Error(response?.error || 'Failed to create link token');
                }

                // Initialize Plaid Link
                plaidHandler = Plaid.create({
                    token: response.linkToken,
                    onSuccess: async (publicToken, metadata) => {
                        console.log('Plaid Link Success!', metadata);
                        await handlePlaidSuccess(publicToken, metadata);
                    },
                    onExit: (err, metadata) => {
                        console.log('Plaid Link Exit', err, metadata);
                        btn.innerHTML = '<i class="fas fa-link"></i> Connect Bank';
                        btn.disabled = false;
                        if (err) {
                            showNotification('Bank connection cancelled', 'warning');
                        }
                    },
                    onEvent: (eventName, metadata) => {
                        console.log('Plaid Event:', eventName, metadata);
                        if (eventName === 'ERROR') {
                            console.error('PLAID ERROR DETAILS:', JSON.stringify(metadata, null, 2));
                            showNotification('Plaid Error: ' + (metadata.error_message || metadata.error_code || 'Unknown error'), 'error');
                        }
                    }
                });

                // Open Plaid Link
                plaidHandler.open();

            } catch (error) {
                console.error('Plaid Error:', error);
                showNotification('Failed to connect: ' + error.message, 'error');
                btn.innerHTML = '<i class="fas fa-link"></i> Connect Bank';
                btn.disabled = false;
            }
        }

        async function handlePlaidSuccess(publicToken, metadata) {
            const btn = document.getElementById('plaidConnectBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing accounts...';

            try {
                // Exchange public token via GET to avoid CORS preflight
                const params = new URLSearchParams({
                    action: 'exchangePlaidPublicToken',
                    publicToken: publicToken,
                    institutionId: metadata.institution.institution_id,
                    institutionName: metadata.institution.name,
                    accounts: JSON.stringify(metadata.accounts)
                });

                const response = await fetch(`${API_CONFIG.apiUrl}?${params.toString()}`);
                const exchangeResult = await response.json();

                if (!exchangeResult || !exchangeResult.success) {
                    throw new Error(exchangeResult?.error || 'Failed to exchange token');
                }

                showNotification(`Connected to ${metadata.institution.name}!`, 'success');

                // Refresh the accounts and transactions display
                await loadConnectedAccounts();
                await loadTransactionsAndAnalyze();

                btn.innerHTML = '<i class="fas fa-link"></i> Connect Bank';
                btn.disabled = false;

            } catch (error) {
                console.error('Token Exchange Error:', error);
                showNotification('Failed to save connection: ' + error.message, 'error');
                btn.innerHTML = '<i class="fas fa-link"></i> Connect Bank';
                btn.disabled = false;
            }
        }

        async function loadConnectedAccounts() {
            try {
                const accounts = await fetchFromSheet('getPlaidAccounts');

                if (accounts && accounts.success && accounts.accounts && accounts.accounts.length > 0) {
                    // Feed data to unified state manager
                    FinancialState.update('plaidAccounts', accounts.accounts);
                    displayPlaidAccounts(accounts.accounts);
                } else {
                    FinancialState.update('plaidAccounts', []);
                    showNoAccountsMessage();
                }
            } catch (error) {
                console.error('Failed to load accounts:', error);
                showNoAccountsMessage();
            }
        }

        function showNoAccountsMessage() {
            const netWorthEl = document.getElementById('total-net-worth');
            const assetsEl = document.getElementById('total-assets');
            const debtEl = document.getElementById('total-debt');

            if (netWorthEl) {
                netWorthEl.innerHTML = '<a href="#" onclick="showTab(\'banking\'); return false;" style="color: var(--primary); text-decoration: underline; cursor: pointer;">Connect bank accounts</a>';
            }
            if (assetsEl) assetsEl.textContent = '--';
            if (debtEl) debtEl.textContent = '--';
        }

        function displayPlaidAccounts(accounts) {
            const cardBody = document.querySelector('.card:has(.fa-university) .card-body');
            if (!cardBody) return;

            // Find or create the connected accounts section
            let connectedSection = document.getElementById('plaidAccountsSection');
            if (!connectedSection) {
                connectedSection = document.createElement('div');
                connectedSection.id = 'plaidAccountsSection';
                connectedSection.innerHTML = '<h4 style="margin: 1rem 0 0.5rem; font-size: 0.85rem; color: var(--text-secondary);"><i class="fas fa-check-circle" style="color: var(--success);"></i> Connected via Plaid</h4>';
                cardBody.insertBefore(connectedSection, cardBody.firstChild);
            }

            // Clear existing accounts (except header)
            const header = connectedSection.querySelector('h4');
            connectedSection.innerHTML = '';
            connectedSection.appendChild(header);

            // Add each account
            accounts.forEach(account => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'account-card ' + (account.subtype || 'checking');

                const iconMap = {
                    'checking': 'fa-money-check-alt',
                    'savings': 'fa-piggy-bank',
                    'credit card': 'fa-credit-card',
                    'loan': 'fa-file-invoice-dollar',
                    'investment': 'fa-chart-line'
                };
                const icon = iconMap[account.subtype] || 'fa-university';
                const iconColor = account.subtype === 'credit card' ? 'var(--danger)' :
                                  account.subtype === 'savings' ? 'var(--success)' : 'var(--info)';

                accountDiv.innerHTML = `
                    <div class="account-icon" style="color: ${iconColor};">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="account-info">
                        <div class="account-name">${account.name}</div>
                        <div class="account-type">${account.institution} - ****${account.mask || '----'}</div>
                    </div>
                    <div class="account-balance">
                        <div class="amount" style="color: ${account.subtype === 'credit card' ? 'var(--danger)' : 'var(--success)'};">
                            $${Math.abs(account.balance_current || 0).toLocaleString()}
                        </div>
                        <div class="label">${account.subtype === 'credit card' ? 'Owed' : 'Available'}</div>
                    </div>
                `;
                connectedSection.appendChild(accountDiv);
            });

            // Calculate and update financial totals
            updateFinancialTotals(accounts);

            // Populate debt destroyer with credit card data
            updateDebtDestroyer(accounts);
        }

        function updateFinancialTotals(accounts) {
            if (!accounts || accounts.length === 0) {
                return;
            }

            // Categorize accounts and calculate totals
            let totalAssets = 0;
            let totalDebt = 0;
            let emergencyFund = 0;
            let investmentTotal = 0;

            accounts.forEach(account => {
                const balance = account.balance_current || 0;
                const subtype = (account.subtype || '').toLowerCase();
                const type = (account.type || '').toLowerCase();

                // Assets: checking, savings, investment, money market, CD
                if (subtype === 'checking' || subtype === 'savings' ||
                    subtype === 'money market' || subtype === 'cd' ||
                    type === 'depository') {
                    totalAssets += balance;

                    // Emergency fund = savings accounts
                    if (subtype === 'savings' || subtype === 'money market') {
                        emergencyFund += balance;
                    }
                }

                // Investments
                if (type === 'investment' || subtype === 'investment' ||
                    subtype === 'brokerage' || subtype === '401k' || subtype === 'ira') {
                    totalAssets += balance;
                    investmentTotal += balance;
                }

                // Debt: credit cards, loans, mortgages
                if (subtype === 'credit card' || type === 'credit' ||
                    type === 'loan' || subtype === 'loan' ||
                    subtype === 'mortgage' || subtype === 'student') {
                    totalDebt += Math.abs(balance);
                }
            });

            const netWorth = totalAssets - totalDebt;

            // Update the UI
            const netWorthEl = document.getElementById('total-net-worth');
            const assetsEl = document.getElementById('total-assets');
            const debtEl = document.getElementById('total-debt');
            const emergencyEl = document.getElementById('emergency-fund');
            const investmentEl = document.getElementById('investment-total');
            const debtRemainingEl = document.getElementById('debt-remaining');

            if (netWorthEl) {
                netWorthEl.textContent = '$' + netWorth.toLocaleString();
                netWorthEl.classList.remove('positive', 'negative');
                netWorthEl.classList.add(netWorth >= 0 ? 'positive' : 'negative');
            }

            if (assetsEl) {
                assetsEl.textContent = '$' + totalAssets.toLocaleString();
            }

            if (debtEl) {
                debtEl.textContent = totalDebt > 0 ? '-$' + totalDebt.toLocaleString() : '$0';
            }

            if (emergencyEl) {
                emergencyEl.textContent = '$' + emergencyFund.toLocaleString();
            }

            if (investmentEl) {
                investmentEl.textContent = '$' + investmentTotal.toLocaleString();
            }

            if (debtRemainingEl) {
                debtRemainingEl.textContent = '$' + totalDebt.toLocaleString();
            }

            console.log('Financial totals updated:', {
                totalAssets,
                totalDebt,
                netWorth,
                emergencyFund,
                investmentTotal
            });

            // Also update cash display in Banking tab
            const totalCashEl = document.getElementById('total-cash-display');
            if (totalCashEl) {
                totalCashEl.textContent = '$' + totalAssets.toLocaleString();
            }
        }

        // =============================================
        // DEBT DESTROYER - Real Credit Card Data
        // =============================================
        function updateDebtDestroyer(accounts) {
            if (!accounts || accounts.length === 0) {
                showNoDebtMessage();
                return;
            }

            // Filter for credit/debt accounts
            const debtAccounts = accounts.filter(account => {
                const subtype = (account.subtype || '').toLowerCase();
                const type = (account.type || '').toLowerCase();
                return subtype === 'credit card' || type === 'credit' ||
                       type === 'loan' || subtype === 'loan' ||
                       subtype === 'mortgage' || subtype === 'student';
            });

            if (debtAccounts.length === 0) {
                showNoDebtMessage();
                return;
            }

            // Calculate totals
            const totalDebt = debtAccounts.reduce((sum, acc) => sum + Math.abs(acc.balance_current || 0), 0);

            // Update stats
            const debtTotalEl = document.getElementById('debt-total-display');
            const debtCountEl = document.getElementById('debt-accounts-count');
            const debtStatusEl = document.getElementById('debt-accounts-status');

            if (debtTotalEl) {
                debtTotalEl.textContent = '$' + totalDebt.toLocaleString();
            }

            if (debtCountEl) {
                debtCountEl.textContent = debtAccounts.length;
            }

            if (debtStatusEl) {
                debtStatusEl.innerHTML = '<span>' + debtAccounts.length + ' account' + (debtAccounts.length > 1 ? 's' : '') + ' tracked</span>';
            }

            // Populate debt table
            const debtTableBody = document.getElementById('debt-table-body');
            if (debtTableBody) {
                debtTableBody.innerHTML = debtAccounts.map(account => {
                    const balance = Math.abs(account.balance_current || 0);
                    const subtype = account.subtype || 'Credit';
                    const name = account.name || 'Unknown Account';
                    const institution = account.institution || '';
                    const mask = account.mask ? '****' + account.mask : '';

                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${institution} ${mask}</div>
                            </td>
                            <td style="color: var(--danger); font-weight: 600;">$${balance.toLocaleString()}</td>
                            <td style="color: var(--text-secondary);">--</td>
                            <td>--</td>
                            <td>--</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="editDebt('${account.account_id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            console.log('Debt Destroyer updated with', debtAccounts.length, 'accounts, total:', totalDebt);
        }

        function showNoDebtMessage() {
            const debtTotalEl = document.getElementById('debt-total-display');
            const debtCountEl = document.getElementById('debt-accounts-count');
            const debtStatusEl = document.getElementById('debt-accounts-status');
            const debtTableBody = document.getElementById('debt-table-body');

            if (debtTotalEl) debtTotalEl.textContent = '$0';
            if (debtCountEl) debtCountEl.textContent = '0';
            if (debtStatusEl) debtStatusEl.innerHTML = '<span>No debt accounts connected</span>';

            if (debtTableBody) {
                debtTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-check-circle" style="color: var(--success); margin-right: 0.5rem;"></i>
                            No debt accounts found. Add debts manually or connect credit cards via Plaid.
                        </td>
                    </tr>
                `;
            }
        }

        // =============================================
        // TRANSACTION ANALYSIS - Income & Expenses
        // =============================================
        async function loadTransactionsAndAnalyze() {
            try {
                const result = await fetchFromSheet('getPlaidTransactions', { days: 30 });

                if (result && result.success && result.data) {
                    // Feed data to unified state manager
                    FinancialState.update('plaidTransactions', result.data);
                    analyzeTransactions(result.data);
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        function analyzeTransactions(transactions) {
            if (!transactions || transactions.length === 0) {
                return;
            }

            let monthlyIncome = 0;
            let monthlyExpenses = 0;

            // Plaid convention: positive amount = money out (expense)
            // negative amount = money in (income)
            transactions.forEach(txn => {
                if (txn.pending) return; // Skip pending transactions

                const amount = txn.amount || 0;

                if (amount < 0) {
                    // Negative = income (deposit, refund, payment received)
                    monthlyIncome += Math.abs(amount);
                } else {
                    // Positive = expense (purchase, payment, withdrawal)
                    monthlyExpenses += amount;
                }
            });

            // Update the UI
            const incomeEl = document.getElementById('monthly-income');
            const expensesEl = document.getElementById('monthly-expenses');

            if (incomeEl) {
                incomeEl.textContent = '$' + monthlyIncome.toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }

            if (expensesEl) {
                expensesEl.textContent = '-$' + monthlyExpenses.toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }

            // Update cash flow
            const cashFlowEl = document.getElementById('cash-flow-display');
            const cashFlowStatusEl = document.getElementById('cash-flow-status');
            const netCashFlow = monthlyIncome - monthlyExpenses;

            if (cashFlowEl) {
                cashFlowEl.textContent = (netCashFlow >= 0 ? '+$' : '-$') + Math.abs(netCashFlow).toLocaleString();
                cashFlowEl.style.color = netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
            }

            if (cashFlowStatusEl) {
                cashFlowStatusEl.innerHTML = '<span>' + (netCashFlow >= 0 ? 'Surplus' : 'Deficit') + ' this month</span>';
            }

            // Populate transactions table
            displayTransactionsTable(transactions);

            console.log('Monthly cash flow:', {
                income: monthlyIncome,
                expenses: monthlyExpenses,
                net: netCashFlow,
                transactionCount: transactions.length
            });
        }

        function displayTransactionsTable(transactions) {
            const tableBody = document.getElementById('transactions-table-body');
            if (!tableBody) return;

            if (!transactions || transactions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-receipt" style="margin-right: 0.5rem;"></i>
                            No transactions found. Connect accounts to view recent activity.
                        </td>
                    </tr>
                `;
                return;
            }

            // Show most recent 10 transactions
            const recentTxns = transactions.slice(0, 10);

            tableBody.innerHTML = recentTxns.map(txn => {
                const amount = txn.amount || 0;
                const isIncome = amount < 0;
                const displayAmount = Math.abs(amount);
                const date = new Date(txn.date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                const categoryColors = {
                    'Food and Drink': 'rgba(244, 162, 97, 0.2)',
                    'Shops': 'rgba(67, 97, 238, 0.2)',
                    'Travel': 'rgba(155, 89, 182, 0.2)',
                    'Transfer': 'rgba(67, 97, 238, 0.2)',
                    'Payment': 'rgba(42, 157, 143, 0.2)'
                };
                const category = txn.category ? txn.category[0] : 'Other';
                const catColor = categoryColors[category] || 'rgba(100, 116, 139, 0.2)';

                return `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${txn.name || txn.merchant_name || 'Transaction'}</td>
                        <td><span style="padding: 0.25rem 0.5rem; background: ${catColor}; border-radius: 4px; font-size: 0.8rem;">${category}</span></td>
                        <td style="font-size: 0.85rem; color: var(--text-secondary);">${txn.account_name || '--'}</td>
                        <td style="color: ${isIncome ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${isIncome ? '+' : '-'}$${displayAmount.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        async function refreshPlaidBalances() {
            showNotification('Refreshing balances...', 'info');

            try {
                const result = await fetchFromSheet('refreshPlaidBalances');
                if (result && result.success) {
                    await loadConnectedAccounts();
                    await loadTransactionsAndAnalyze();
                    showNotification('Balances updated!', 'success');
                }
            } catch (error) {
                showNotification('Failed to refresh: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    font-weight: 500;
                    z-index: 1000;
                    transform: translateX(150%);
                    transition: transform 0.3s ease;
                    max-width: 350px;
                `;
                document.body.appendChild(notification);
            }

            const colors = {
                success: { bg: 'var(--success)', icon: 'fa-check-circle' },
                error: { bg: 'var(--danger)', icon: 'fa-exclamation-circle' },
                warning: { bg: 'var(--warning)', icon: 'fa-exclamation-triangle' },
                info: { bg: 'var(--info)', icon: 'fa-info-circle' }
            };

            const config = colors[type] || colors.info;
            notification.style.background = config.bg;
            notification.innerHTML = `<i class="fas ${config.icon}"></i> ${message}`;
            notification.style.transform = 'translateX(0)';

            setTimeout(() => {
                notification.style.transform = 'translateX(150%)';
            }, 4000);
        }

        // =============================================
        // MARKETING FUNCTIONS
        // =============================================
        const MARKETING_API_URL = 'https://script.google.com/macros/s/AKfycbxwlNBHBKBS1sSDHXFbnmuZvhNpHlKi9qJ8crPzB2Iy39zeh0FjTcu9bCxhsz9ugBdc/exec';

        async function loadMarketingData() {
            try {
                // Load budget data
                const budgetResponse = await fetch(`${MARKETING_API_URL}?action=getMarketingBudget`);
                const budgetData = await budgetResponse.json();

                // Load spend data
                const spendResponse = await fetch(`${MARKETING_API_URL}?action=getMarketingSpend&month=${new Date().getMonth() + 1}&year=${new Date().getFullYear()}`);
                const spendData = await spendResponse.json();

                // Load analytics
                const analyticsResponse = await fetch(`${MARKETING_API_URL}?action=getMarketingAnalytics`);
                const analyticsData = await analyticsResponse.json();

                if (budgetData.success) {
                    updateMarketingBudgetDisplay(budgetData.data);
                }

                if (spendData.success) {
                    updateMarketingSpendDisplay(spendData.data);
                }

                if (analyticsData.success) {
                    updateMarketingAnalyticsDisplay(analyticsData.data);
                }

                showNotification('Marketing data refreshed', 'success');
            } catch (error) {
                console.error('Error loading marketing data:', error);
                showNotification('Error loading marketing data', 'error');
            }
        }

        function updateMarketingBudgetDisplay(data) {
            if (!data) return;

            const budget = data.monthly_budget || 500;
            const spent = data.spent_this_month || 0;
            const remaining = budget - spent;
            const percentUsed = Math.round((spent / budget) * 100);

            document.getElementById('marketing-budget').textContent = `$${budget.toLocaleString()}`;
            document.getElementById('marketing-spent').textContent = `$${spent.toLocaleString()}`;
            document.getElementById('marketing-remaining').textContent = `$${remaining.toLocaleString()} remaining`;
            document.getElementById('marketing-spent-percent').textContent = `${percentUsed}% used`;

            const progressBar = document.getElementById('marketing-progress');
            progressBar.style.width = `${Math.min(percentUsed, 100)}%`;
            progressBar.classList.remove('success', 'warning', 'danger');
            progressBar.classList.add(percentUsed < 50 ? 'success' : percentUsed < 80 ? 'warning' : 'danger');
        }

        function updateMarketingSpendDisplay(data) {
            if (!data || !data.transactions) return;

            const historyContainer = document.getElementById('marketing-spend-history');
            if (historyContainer && data.transactions.length > 0) {
                historyContainer.innerHTML = data.transactions.slice(0, 10).map(t => `
                    <div class="alert" style="margin-bottom: 0.5rem;">
                        <i class="fas ${getCategoryIcon(t.category)}" style="color: ${getCategoryColor(t.category)};"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${t.description}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${formatDate(t.date)}</div>
                        </div>
                        <span style="font-weight: 600; color: var(--danger);">-$${parseFloat(t.amount).toFixed(2)}</span>
                    </div>
                `).join('');
            }

            // Update category breakdown
            if (data.by_category) {
                const catContainer = document.getElementById('marketing-spend-categories');
                const categories = [
                    { key: 'social_ads', name: 'Social Media Ads', color: '#E1306C' },
                    { key: 'subscription', name: 'Ayrshare Subscription', color: '#3b5998' },
                    { key: 'print', name: 'Print Materials', color: '#2ecc71' },
                    { key: 'photography', name: 'Photography/Content', color: '#9b59b6' }
                ];

                catContainer.innerHTML = categories.map(cat => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 12px; height: 12px; background: ${cat.color}; border-radius: 50%;"></div>
                            <span>${cat.name}</span>
                        </div>
                        <span style="font-weight: 600;">$${(data.by_category[cat.key] || 0).toFixed(2)}</span>
                    </div>
                `).join('');
            }
        }

        function updateMarketingAnalyticsDisplay(data) {
            if (!data) return;

            if (data.roi !== undefined) {
                const roiEl = document.getElementById('marketing-roi');
                roiEl.textContent = (data.roi >= 0 ? '+' : '') + data.roi + '%';
                roiEl.classList.toggle('positive', data.roi >= 0);
                roiEl.classList.toggle('negative', data.roi < 0);
            }

            if (data.posts_this_month !== undefined) {
                document.getElementById('marketing-posts').textContent = data.posts_this_month;
            }
        }

        function getCategoryIcon(category) {
            const icons = {
                'social_ads': 'fa-ad',
                'subscription': 'fa-sync-alt',
                'print': 'fa-print',
                'photography': 'fa-camera',
                'events': 'fa-calendar-alt',
                'direct_mail': 'fa-envelope',
                'sms': 'fa-sms'
            };
            return icons[category] || 'fa-receipt';
        }

        function getCategoryColor(category) {
            const colors = {
                'social_ads': '#E1306C',
                'subscription': '#3b5998',
                'print': '#2ecc71',
                'photography': '#9b59b6',
                'events': '#e67e22',
                'direct_mail': '#3498db',
                'sms': '#2a9d8f'
            };
            return colors[category] || '#95a5a6';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        async function saveMarketingSpend() {
            const description = document.getElementById('marketingSpendDesc').value;
            const category = document.getElementById('marketingSpendCategory').value;
            const amount = parseFloat(document.getElementById('marketingSpendAmount').value);
            const date = document.getElementById('marketingSpendDate').value || new Date().toISOString().split('T')[0];
            const campaign = document.getElementById('marketingSpendCampaign').value;
            const notes = document.getElementById('marketingSpendNotes').value;

            if (!description || !amount) {
                showNotification('Please enter description and amount', 'warning');
                return;
            }

            try {
                const response = await fetch(MARKETING_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'logMarketingSpend',
                        description,
                        category,
                        amount,
                        date,
                        campaign,
                        notes
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Marketing expense logged', 'success');
                    closeModal('addMarketingSpendModal');
                    loadMarketingData();

                    // Clear form
                    document.getElementById('marketingSpendDesc').value = '';
                    document.getElementById('marketingSpendAmount').value = '';
                    document.getElementById('marketingSpendNotes').value = '';
                } else {
                    showNotification(result.error || 'Error logging expense', 'error');
                }
            } catch (error) {
                console.error('Error saving marketing spend:', error);
                showNotification('Error logging expense', 'error');
            }
        }

        async function allocateMarketingFunds() {
            const amount = parseFloat(document.getElementById('marketingFundAmount').value) || 0;
            const source = document.getElementById('marketingFundSource').value;
            const autoPercent = parseFloat(document.getElementById('marketingAutoPercent').value);
            const monthlyCap = parseFloat(document.getElementById('marketingMonthlyCap').value);

            try {
                // Log the fund allocation
                if (amount > 0) {
                    const response = await fetch(MARKETING_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'logMarketingActivity',
                            type: 'fund_allocation',
                            data: { amount, source, autoPercent, monthlyCap }
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification(`$${amount.toFixed(2)} added to marketing fund`, 'success');
                    }
                }

                closeModal('allocateMarketingModal');
                loadMarketingData();
            } catch (error) {
                console.error('Error allocating marketing funds:', error);
                showNotification('Settings saved locally', 'success');
                closeModal('allocateMarketingModal');
            }
        }

        // =============================================
        // SHOPIFY FINANCIAL DATA
        // =============================================
        async function loadShopifyFinancialData() {
            try {
                // Load Shopify Payments balance
                const balanceResult = await fetchFromSheet('getShopifyPaymentsBalance');
                if (balanceResult && balanceResult.success) {
                    console.log('Shopify Payments Balance:', balanceResult);
                    // Feed to state manager
                    FinancialState.update('shopifyPayments', { pending: balanceResult.totalPending || 0 });
                    updateShopifyPendingBalance({ amount: balanceResult.totalPending });
                }

                // Load Shopify Capital loan data from stored CSV data
                const capitalResult = await fetchFromSheet('getShopifyCapitalLoan');
                if (capitalResult && capitalResult.success) {
                    console.log('Shopify Capital Loan:', capitalResult);
                    // Feed to state manager
                    FinancialState.update('shopifyCapital', {
                        balance: capitalResult.currentBalance || 0,
                        originalAmount: capitalResult.loan?.originalAmount || 0,
                        repaymentRate: capitalResult.loan?.repaymentRate || 0
                    });
                    addShopifyCapitalLoan({
                        currentBalance: capitalResult.currentBalance,
                        originalAmount: capitalResult.loan.originalAmount,
                        totalPaymentAmount: capitalResult.loan.totalPaymentAmount,
                        repaymentRate: capitalResult.loan.repaymentRate,
                        monthlyFee: capitalResult.loan.monthlyFee,
                        lastUpdated: capitalResult.lastUpdated,
                        percentagePaid: capitalResult.progress.percentComplete
                    });
                }

            } catch (error) {
                console.error('Failed to load Shopify financial data:', error);
            }
        }

        function updateShopifyPendingBalance(pending) {
            if (!pending || pending.amount === 0) return;

            // Find or create Shopify section in the Banking card
            const bankingCard = document.querySelector('.card:has(.fa-university) .card-body');
            if (!bankingCard) return;

            let shopifySection = document.getElementById('shopifyBalanceSection');
            if (!shopifySection) {
                shopifySection = document.createElement('div');
                shopifySection.id = 'shopifyBalanceSection';
                shopifySection.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);';
                bankingCard.appendChild(shopifySection);
            }

            shopifySection.innerHTML = `
                <h4 style="margin: 0 0 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <i class="fab fa-shopify" style="color: #96bf48;"></i> Shopify Payments
                </h4>
                <div class="account-card shopify-pending">
                    <div class="account-icon" style="color: #96bf48;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="account-info">
                        <div class="account-name">Pending Payout</div>
                        <div class="account-type">Will deposit to PNC when processed</div>
                    </div>
                    <div class="account-balance">
                        <div class="amount" style="color: var(--warning);">
                            $${pending.amount.toLocaleString()}
                        </div>
                        <div class="label">Pending</div>
                    </div>
                </div>
            `;
        }

        function addShopifyCapitalLoan(loan) {
            if (!loan || loan.currentBalance === 0) return;

            const debtTableBody = document.getElementById('debt-table-body');
            if (!debtTableBody) return;

            // Check if Capital row already exists
            const existingRow = document.querySelector('.shopify-capital-row');
            if (existingRow) existingRow.remove();

            // Calculate progress
            const progress = ((loan.originalAmount - loan.currentBalance) / loan.originalAmount * 100).toFixed(1);

            const row = document.createElement('tr');
            row.className = 'shopify-capital-row';
            row.innerHTML = `
                <td>
                    <div style="font-weight: 600;"><i class="fab fa-shopify" style="color: #96bf48; margin-right: 0.5rem;"></i>Shopify Capital Loan</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                        Original: $${loan.originalAmount.toLocaleString()} | 17% of daily sales
                    </div>
                </td>
                <td style="color: var(--danger); font-weight: 600;">$${loan.currentBalance.toLocaleString()}</td>
                <td style="color: var(--text-secondary);">17%</td>
                <td>
                    <div style="font-size: 0.85rem;">${progress}% paid</div>
                    <div style="width: 60px; height: 4px; background: var(--border-color); border-radius: 2px; margin-top: 4px;">
                        <div style="width: ${progress}%; height: 100%; background: var(--success); border-radius: 2px;"></div>
                    </div>
                </td>
                <td>Auto-deducted from sales</td>
                <td>
                    <span class="badge badge-warning">Active</span>
                </td>
            `;

            // Insert at the beginning of the table
            if (debtTableBody.firstChild) {
                debtTableBody.insertBefore(row, debtTableBody.firstChild);
            } else {
                debtTableBody.appendChild(row);
            }

            // Update debt totals to include Shopify Capital
            const debtTotalEl = document.getElementById('debt-total-display');
            if (debtTotalEl) {
                const currentTotal = parseFloat(debtTotalEl.textContent.replace(/[$,]/g, '')) || 0;
                const newTotal = currentTotal + loan.currentBalance;
                debtTotalEl.textContent = '$' + newTotal.toLocaleString();
            }

            // Update account count
            const debtCountEl = document.getElementById('debt-accounts-count');
            if (debtCountEl) {
                const currentCount = parseInt(debtCountEl.textContent) || 0;
                debtCountEl.textContent = currentCount + 1;
            }

            console.log('Shopify Capital loan added to Debt Destroyer:', loan.currentBalance);
        }

        // Keep old function for backwards compatibility
        function addShopifyCapitalToDebt(capital) {
            if (!capital.loans || capital.loans.length === 0) return;
            capital.loans.forEach(loan => {
                addShopifyCapitalLoan({
                    currentBalance: loan.remainingBalance,
                    originalAmount: loan.originalAmount,
                    repaymentRate: loan.dailyWithholdingRate
                });
            });
        }

        function displayShopifyPayouts(payouts) {
            // Create a reference section for recent Shopify payouts
            // Note: These will also appear in PNC transactions
            console.log('Recent Shopify payouts (will appear in bank as deposits):', payouts);

            // Could add a small info tooltip showing recent payouts if desired
        }

        // =============================================
        // PAYPAL FINANCIAL DATA
        // =============================================
        async function loadPayPalData() {
            try {
                const summary = await fetchFromSheet('getPayPalFinancialSummary');
                if (summary && summary.success) {
                    console.log('PayPal Financial Summary:', summary);
                    // Feed to state manager
                    FinancialState.update('paypalBalance', {
                        available: summary.balance?.available || 0,
                        pending: summary.balance?.pending || 0
                    });
                    if (summary.transactions?.recent) {
                        FinancialState.update('paypalTransactions', summary.transactions.recent);
                    }
                    displayPayPalBalance(summary.balance);
                    displayPayPalTransactions(summary.transactions);
                }
            } catch (error) {
                console.error('Failed to load PayPal data:', error);
            }
        }

        function displayPayPalBalance(balance) {
            if (!balance) return;

            // Find or create PayPal section in the Banking card
            const bankingCard = document.querySelector('.card:has(.fa-university) .card-body');
            if (!bankingCard) return;

            let paypalSection = document.getElementById('paypalBalanceSection');
            if (!paypalSection) {
                paypalSection = document.createElement('div');
                paypalSection.id = 'paypalBalanceSection';
                paypalSection.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);';
                bankingCard.appendChild(paypalSection);
            }

            const hasBalance = balance.available > 0 || balance.pending > 0;

            paypalSection.innerHTML = `
                <h4 style="margin: 0 0 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <i class="fab fa-paypal" style="color: #003087;"></i> PayPal Business
                </h4>
                ${hasBalance ? `
                <div class="account-card paypal-balance">
                    <div class="account-icon" style="color: #003087;">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="account-info">
                        <div class="account-name">PayPal Balance</div>
                        <div class="account-type">Business Account</div>
                    </div>
                    <div class="account-balance">
                        <div class="amount" style="color: var(--success);">
                            $${balance.available.toLocaleString()}
                        </div>
                        <div class="label">Available</div>
                    </div>
                </div>
                ` : `
                <div class="account-card paypal-balance" style="opacity: 0.7;">
                    <div class="account-icon" style="color: #003087;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="account-info">
                        <div class="account-name">PayPal Connected</div>
                        <div class="account-type">$0 balance (payments go directly to linked bank)</div>
                    </div>
                </div>
                `}
            `;
        }

        function displayPayPalTransactions(transactions) {
            if (!transactions || !transactions.summary) return;

            console.log('PayPal 30-day summary:', transactions.summary);

            // If there's significant activity, add it to the cash flow or transaction history
            // For now just log - the transactions will show in bank accounts via Plaid
        }

        // =============================================
        // INITIALIZE
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Tiny Seed Financial Dashboard initialized');

            // Load all connected account data
            loadConnectedAccounts();
            loadTransactionsAndAnalyze();
            loadShopifyFinancialData();
            loadPayPalData();
        });
    </script>
</body>
</html>
