<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Seed Financial Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="auth-guard.js" data-required-role="Admin"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <style>
        :root {
            --primary: #2d5a27;
            --primary-light: #4a7c43;
            --primary-dark: #1e3d1a;
            --secondary: #f4a261;
            --accent: #e76f51;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #e63946;
            --info: #4361ee;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-light: #0f3460;
            --text-primary: #edf2f4;
            --text-secondary: #8d99ae;
            --border: rgba(255,255,255,0.1);
            --gold: #ffd700;
            --purple: #9b59b6;
            --teal: #1abc9c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f1a 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ============================================= */
        /* NAVIGATION */
        /* ============================================= */
        .top-nav {
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-logo {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .nav-title {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected { background: var(--success); }
        .status-dot.warning { background: var(--warning); }
        .status-dot.danger { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ============================================= */
        /* TAB NAVIGATION */
        /* ============================================= */
        .tab-nav {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0;
            padding: 0 2rem;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.03);
        }

        .tab-btn.active {
            color: var(--primary-light);
            border-bottom-color: var(--primary-light);
        }

        .tab-btn .badge {
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .tab-btn .badge.danger { background: var(--danger); color: white; }
        .tab-btn .badge.warning { background: var(--warning); color: #000; }
        .tab-btn .badge.success { background: var(--success); color: white; }

        /* ============================================= */
        /* MAIN CONTENT */
        /* ============================================= */
        .main-content {
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============================================= */
        /* CARDS */
        /* ============================================= */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header h3 i {
            color: var(--primary-light);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* ============================================= */
        /* STATS GRID */
        /* ============================================= */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.green { background: rgba(42, 157, 143, 0.2); color: var(--success); }
        .stat-icon.blue { background: rgba(67, 97, 238, 0.2); color: var(--info); }
        .stat-icon.gold { background: rgba(255, 215, 0, 0.2); color: var(--gold); }
        .stat-icon.orange { background: rgba(244, 162, 97, 0.2); color: var(--secondary); }
        .stat-icon.red { background: rgba(230, 57, 70, 0.2); color: var(--danger); }
        .stat-icon.purple { background: rgba(155, 89, 182, 0.2); color: var(--purple); }
        .stat-icon.teal { background: rgba(26, 188, 156, 0.2); color: var(--teal); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }
        .stat-change.neutral { color: var(--text-secondary); }

        /* ============================================= */
        /* BUTTONS */
        /* ============================================= */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(45, 90, 39, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* ============================================= */
        /* TABLES */
        /* ============================================= */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table tr:hover {
            background: rgba(255,255,255,0.03);
        }

        /* ============================================= */
        /* FORMS */
        /* ============================================= */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        select.form-input {
            cursor: pointer;
        }

        /* ============================================= */
        /* PROGRESS BARS */
        /* ============================================= */
        .progress-container {
            margin-top: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-fill.success { background: linear-gradient(90deg, var(--success), var(--teal)); }
        .progress-fill.warning { background: linear-gradient(90deg, var(--warning), var(--secondary)); }
        .progress-fill.danger { background: linear-gradient(90deg, var(--danger), var(--accent)); }
        .progress-fill.info { background: linear-gradient(90deg, var(--info), var(--purple)); }

        /* ============================================= */
        /* MODALS */
        /* ============================================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* ============================================= */
        /* TWO COLUMN LAYOUT */
        /* ============================================= */
        .two-col {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        .three-col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1000px) {
            .three-col {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================= */
        /* DEBT DESTROYER SPECIFIC */
        /* ============================================= */
        .debt-card {
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.1) 0%, rgba(22, 33, 62, 1) 100%);
            border-left: 4px solid var(--danger);
        }

        .debt-strategy-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .strategy-option {
            padding: 1.5rem;
            background: rgba(255,255,255,0.03);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .strategy-option:hover {
            border-color: var(--primary-light);
        }

        .strategy-option.active {
            border-color: var(--primary-light);
            background: rgba(45, 90, 39, 0.1);
        }

        .strategy-option h4 {
            margin-bottom: 0.5rem;
        }

        .strategy-option p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .payoff-timeline {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.5rem;
            top: 100%;
            width: 2px;
            height: 1rem;
            background: var(--border);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ============================================= */
        /* GAMIFICATION */
        /* ============================================= */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .achievement {
            padding: 1.5rem;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .achievement.unlocked {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .achievement-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .achievement-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--secondary) 100%);
            color: #000;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .xp-bar {
            margin-top: 1rem;
        }

        .xp-bar .progress-bar {
            height: 8px;
            background: rgba(255, 215, 0, 0.2);
        }

        .xp-bar .progress-fill {
            background: linear-gradient(90deg, var(--gold), var(--secondary));
        }

        /* ============================================= */
        /* ROUND-UPS */
        /* ============================================= */
        .roundup-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, var(--bg-card) 100%);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .coin {
            font-size: 3rem;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .roundup-total {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--success);
        }

        /* ============================================= */
        /* UPLOAD AREA */
        /* ============================================= */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: var(--primary-light);
            background: rgba(45, 90, 39, 0.05);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .upload-area p {
            color: var(--text-secondary);
        }

        /* ============================================= */
        /* BANK ACCOUNT CARDS */
        /* ============================================= */
        .account-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--info);
        }

        .account-card.checking { border-left-color: var(--info); }
        .account-card.savings { border-left-color: var(--success); }
        .account-card.credit { border-left-color: var(--danger); }
        .account-card.investment { border-left-color: var(--gold); }

        .account-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: rgba(255,255,255,0.05);
        }

        .account-info {
            flex: 1;
        }

        .account-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .account-type {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .account-balance {
            text-align: right;
        }

        .account-balance .amount {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .account-balance .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ============================================= */
        /* ALERTS */
        /* ============================================= */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .alert-success {
            background: rgba(42, 157, 143, 0.1);
            border: 1px solid var(--success);
        }

        .alert-warning {
            background: rgba(233, 196, 106, 0.1);
            border: 1px solid var(--warning);
        }

        .alert-danger {
            background: rgba(230, 57, 70, 0.1);
            border: 1px solid var(--danger);
        }

        .alert-info {
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid var(--info);
        }

        /* ============================================= */
        /* LOADING SPINNER */
        /* ============================================= */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================= */
        /* NET WORTH BREAKDOWN */
        /* ============================================= */
        .net-worth-display {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, var(--bg-card) 100%);
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .net-worth-amount {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .net-worth-amount.positive { color: var(--success); }
        .net-worth-amount.negative { color: var(--danger); }

        .net-worth-label {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .net-worth-breakdown {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (max-width: 800px) {
            .net-worth-breakdown {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .breakdown-item {
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }

        .breakdown-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .breakdown-item .value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .breakdown-item .value.positive { color: var(--success); }
        .breakdown-item .value.negative { color: var(--danger); }

        /* ============================================= */
        /* WISHLIST FEATURE - Equipment Purchase Planning */
        /* ============================================= */
        .wishlist-card {
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.1) 0%, var(--bg-card) 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-left: 4px solid var(--purple);
            transition: all 0.2s;
        }

        .wishlist-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.2);
        }

        .wishlist-card.safe-to-buy {
            border-left-color: var(--success);
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.15) 0%, var(--bg-card) 100%);
        }

        .wishlist-card.wait {
            border-left-color: var(--warning);
            background: linear-gradient(135deg, rgba(233, 196, 106, 0.1) 0%, var(--bg-card) 100%);
        }

        .wishlist-card.not-ready {
            border-left-color: var(--danger);
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.1) 0%, var(--bg-card) 100%);
        }

        .wishlist-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .wishlist-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .wishlist-category {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .wishlist-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .wishlist-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .wishlist-status.safe {
            background: rgba(42, 157, 143, 0.2);
            color: var(--success);
        }

        .wishlist-status.wait {
            background: rgba(233, 196, 106, 0.2);
            color: var(--warning);
        }

        .wishlist-status.not-ready {
            background: rgba(230, 57, 70, 0.2);
            color: var(--danger);
        }

        .wishlist-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .wishlist-detail {
            text-align: center;
        }

        .wishlist-detail-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .wishlist-detail-value {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .wishlist-recommendation {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .wishlist-recommendation i {
            margin-right: 0.5rem;
        }

        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.high {
            background: rgba(230, 57, 70, 0.2);
            color: var(--danger);
        }

        .priority-badge.medium {
            background: rgba(233, 196, 106, 0.2);
            color: var(--warning);
        }

        .priority-badge.low {
            background: rgba(67, 97, 238, 0.2);
            color: var(--info);
        }

        /* ============================================= */
        /* ASSET & INVENTORY TRACKING */
        /* ============================================= */
        .asset-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-left: 4px solid var(--teal);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .asset-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: rgba(26, 188, 156, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--teal);
        }

        .asset-info h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .asset-info .meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .asset-value {
            text-align: right;
        }

        .asset-value .current {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .asset-value .original {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* ============================================= */
        /* PRESCRIPTIVE RECOMMENDATIONS */
        /* ============================================= */
        .recommendation-card {
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, var(--bg-card) 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--success);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .recommendation-card.warning {
            background: linear-gradient(135deg, rgba(233, 196, 106, 0.1) 0%, var(--bg-card) 100%);
            border-left-color: var(--warning);
        }

        .recommendation-card.danger {
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.1) 0%, var(--bg-card) 100%);
            border-left-color: var(--danger);
        }

        .recommendation-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(42, 157, 143, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .recommendation-card.warning .recommendation-icon {
            background: rgba(233, 196, 106, 0.2);
            color: var(--warning);
        }

        .recommendation-card.danger .recommendation-icon {
            background: rgba(230, 57, 70, 0.2);
            color: var(--danger);
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .recommendation-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .recommendation-action {
            margin-top: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- TOP NAVIGATION -->
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="nav-logo">
                <i class="fas fa-seedling"></i>
            </div>
            <div>
                <div class="nav-title">Tiny Seed Financial Command Center</div>
                <div class="nav-subtitle">Wealth Builder & Debt Destroyer</div>
            </div>
        </div>
        <div class="nav-status">
            <div class="status-item">
                <div class="status-dot connected"></div>
                <span>Google Sheets Connected</span>
            </div>
            <div class="status-item">
                <div class="status-dot connected"></div>
                <span>Last Sync: Just now</span>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="syncData()">
                <i class="fas fa-sync-alt"></i> Sync
            </button>
        </div>
    </nav>

    <!-- TAB NAVIGATION -->
    <nav class="tab-nav">
        <button class="tab-btn active" onclick="showTab('overview')">
            <i class="fas fa-chart-pie"></i> Overview
        </button>
        <button class="tab-btn" onclick="showTab('debt')">
            <i class="fas fa-fire"></i> Debt Destroyer
            <span class="badge danger" id="debt-count">0</span>
        </button>
        <button class="tab-btn" onclick="showTab('banking')">
            <i class="fas fa-university"></i> Banking & Bills
        </button>
        <button class="tab-btn" onclick="showTab('investments')">
            <i class="fas fa-chart-line"></i> Investments
        </button>
        <button class="tab-btn" onclick="showTab('roundups')">
            <i class="fas fa-coins"></i> Change Investing
        </button>
        <button class="tab-btn" onclick="showTab('wishlist')">
            <i class="fas fa-gift"></i> Wishlist
        </button>
        <button class="tab-btn" onclick="showTab('assets')">
            <i class="fas fa-warehouse"></i> Assets
        </button>
        <button class="tab-btn" onclick="showTab('paymentplans')">
            <i class="fas fa-file-invoice-dollar"></i> Payment Plans
        </button>
        <button class="tab-btn" onclick="showTab('employees')">
            <i class="fas fa-users"></i> Team & Retirement
        </button>
        <button class="tab-btn" onclick="showTab('settings')">
            <i class="fas fa-cog"></i> Settings
        </button>
        <button class="tab-btn" onclick="showTab('marketing')">
            <i class="fas fa-bullhorn"></i> Marketing
        </button>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- ============================================= -->
        <!-- OVERVIEW TAB -->
        <!-- ============================================= -->
        <div id="tab-overview" class="tab-content active">
            <!-- Net Worth Display -->
            <div class="net-worth-display">
                <div class="net-worth-amount positive" id="total-net-worth">Loading...</div>
                <div class="net-worth-label">Total Net Worth</div>
                <div class="net-worth-breakdown">
                    <div class="breakdown-item">
                        <div class="label">Total Assets</div>
                        <div class="value positive" id="total-assets">--</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="label">Total Debt</div>
                        <div class="value negative" id="total-debt">--</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="label">Monthly Income</div>
                        <div class="value positive" id="monthly-income">--</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="label">Monthly Expenses</div>
                        <div class="value negative" id="monthly-expenses">--</div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-success" onclick="connectBankWithPlaid()" id="overviewPlaidBtn">
                        <i class="fas fa-link"></i> Connect Bank Account
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Emergency Fund</div>
                            <div class="stat-value" id="emergency-fund">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-header">
                            <span id="emergency-months">-- months covered</span>
                            <span>Goal: 6 months</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="emergency-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Investment Portfolio</div>
                            <div class="stat-value" id="investment-total">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="investment-change">
                        <span>Connect investment accounts</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Total Debt Remaining</div>
                            <div class="stat-value" id="debt-remaining">--</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-fire"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="debt-change">
                        <span>Connect accounts to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Round-Up Savings</div>
                            <div class="stat-value" id="roundup-total">--</div>
                        </div>
                        <div class="stat-icon teal">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Feature coming soon</span>
                    </div>
                </div>
            </div>

            <!-- Action Items -->
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-tasks"></i> Priority Actions</h3>
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">This Month</span>
                    </div>
                    <div class="card-body" id="priority-actions">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle" style="color: var(--info);"></i>
                            <div>
                                <strong>Getting Started:</strong> Connect your bank accounts to see priority actions
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-link" style="color: var(--info);"></i>
                            <div>
                                <strong>Tip:</strong> Go to Banking & Bills to connect via Plaid
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-chart-line" style="color: var(--info);"></i>
                            <div>
                                <strong>Track Progress:</strong> Your actions will appear here based on real data
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-area"></i> Financial Health Score</h3>
                    </div>
                    <div class="card-body" style="text-align: center;">
                        <div style="font-size: 4rem; font-weight: 800; color: var(--text-secondary);" id="health-score">--</div>
                        <div style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 1.5rem;" id="health-status">Connect accounts to calculate</div>
                        <canvas id="healthChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- DEBT DESTROYER TAB -->
        <!-- ============================================= -->
        <div id="tab-debt" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card debt-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Total Debt</div>
                            <div class="stat-value" id="debt-total-display" style="color: var(--danger);">Loading...</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-fire"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="debt-change-display">
                        <span>Connect accounts to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Monthly Minimum</div>
                            <div class="stat-value" id="debt-monthly-min">--</div>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Based on connected accounts</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Credit Utilization</div>
                            <div class="stat-value" id="credit-utilization" style="color: var(--warning);">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="utilization-status">
                        <span>Connect credit cards</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Accounts Tracked</div>
                            <div class="stat-value" id="debt-accounts-count" style="color: var(--success);">0</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-credit-card"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="debt-accounts-status">
                        <span>Add debts to track</span>
                    </div>
                </div>
            </div>

            <!-- Payoff Strategy Selector -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-chess"></i> Payoff Strategy</h3>
                    <button class="btn btn-secondary btn-sm" onclick="recalculatePayoff()">
                        <i class="fas fa-calculator"></i> Recalculate
                    </button>
                </div>
                <div class="card-body">
                    <div class="debt-strategy-selector">
                        <div class="strategy-option active" onclick="selectStrategy('avalanche')">
                            <i class="fas fa-mountain" style="font-size: 2rem; color: var(--info); margin-bottom: 0.5rem;"></i>
                            <h4>Avalanche Method</h4>
                            <p>Pay highest interest first. Saves the most money.</p>
                            <div style="margin-top: 0.5rem; font-weight: 600; color: var(--success);" id="avalanche-savings">Saves the most interest</div>
                        </div>
                        <div class="strategy-option" onclick="selectStrategy('snowball')">
                            <i class="fas fa-snowflake" style="font-size: 2rem; color: var(--teal); margin-bottom: 0.5rem;"></i>
                            <h4>Snowball Method</h4>
                            <p>Pay smallest balance first. Quick wins for motivation.</p>
                            <div style="margin-top: 0.5rem; font-weight: 600; color: var(--success);" id="snowball-estimate">Quick psychological wins</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <!-- Debt List -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Your Debts</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addDebtModal')">
                            <i class="fas fa-plus"></i> Add Debt
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Balance</th>
                                    <th>APR</th>
                                    <th>Min Payment</th>
                                    <th>Payoff</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="debt-table-body">
                                <tr id="debt-loading-row">
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                                        Loading connected accounts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payoff Timeline -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-flag-checkered"></i> Payoff Timeline</h3>
                    </div>
                    <div class="card-body">
                        <div class="payoff-timeline" id="payoff-timeline">
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>Add debts to see your payoff timeline</p>
                                <p style="font-size: 0.85rem;">Connect accounts or add debts manually above</p>
                            </div>
                        </div>

                        <div id="debt-free-summary" style="display: none; margin-top: 2rem; padding: 1.5rem; background: rgba(42, 157, 143, 0.1); border-radius: 12px; text-align: center;">
                            <i class="fas fa-trophy" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
                            <div style="font-weight: 700; font-size: 1.25rem;">DEBT FREE!</div>
                            <div id="debt-free-date" style="color: var(--text-secondary);">Target Date: --</div>
                            <div id="interest-saved" style="margin-top: 0.5rem; color: var(--success); font-weight: 600;">Total Interest Saved: --</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================= -->
            <!-- EQUIPMENT WISHLIST - Smart Purchase Planning -->
            <!-- ============================================= -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3><i class="fas fa-gift" style="color: var(--purple);"></i> Equipment Wishlist</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span style="font-size: 0.8rem; color: var(--text-secondary);" id="wishlist-count">0 items</span>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addWishlistModal')">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <i class="fas fa-brain" style="color: var(--info);"></i>
                        <div>
                            <strong>Smart Purchase Planning:</strong> The system analyzes your cash flow, emergency fund, debt situation, and seasonal patterns to tell you exactly when it's safe to make purchases.
                        </div>
                    </div>

                    <!-- Wishlist Summary Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="padding: 1rem; background: rgba(42, 157, 143, 0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Ready to Buy</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="wishlist-ready">0</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(233, 196, 106, 0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Wait Listed</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="wishlist-waiting">0</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(230, 57, 70, 0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Not Yet</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);" id="wishlist-not-ready">0</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(155, 89, 182, 0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Wishlist</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--purple);" id="wishlist-total-value">$0</div>
                        </div>
                    </div>

                    <!-- Wishlist Items Container -->
                    <div id="wishlist-items-container">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-gift" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p style="font-size: 1rem;">No wishlist items yet</p>
                            <p style="font-size: 0.85rem; margin-bottom: 1rem;">Track equipment, supplies, or big purchases you're planning</p>
                            <button class="btn btn-primary" onclick="openModal('addWishlistModal')">
                                <i class="fas fa-plus"></i> Add Your First Item
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================= -->
            <!-- SMART RECOMMENDATIONS - Prescriptive Guidance -->
            <!-- ============================================= -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3><i class="fas fa-lightbulb" style="color: var(--gold);"></i> Today's Action Items</h3>
                    <button class="btn btn-secondary btn-sm" onclick="refreshRecommendations()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body" id="recommendations-container">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Analyzing your financial situation...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- BANKING TAB -->
        <!-- ============================================= -->
        <div id="tab-banking" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Total Cash</div>
                            <div class="stat-value" id="total-cash-display" style="color: var(--success);">Loading...</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="cash-accounts-count">
                        <span>Connect accounts to view</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Monthly Expenses</div>
                            <div class="stat-value" id="monthly-expenses">--</div>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>From transactions</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Income This Month</div>
                            <div class="stat-value" id="monthly-income" style="color: var(--success);">--</div>
                        </div>
                        <div class="stat-icon teal">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>From transactions</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Cash Flow</div>
                            <div class="stat-value" id="cash-flow-display" style="color: var(--success);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="cash-flow-status">
                        <span>Income - Expenses</span>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <!-- Bank Accounts -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-university"></i> Bank Accounts</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success btn-sm" onclick="connectBankWithPlaid()" id="plaidConnectBtn">
                                <i class="fas fa-link"></i> Connect Bank
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="openModal('addAccountModal')">
                                <i class="fas fa-plus"></i> Add Manual
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="bank-accounts-container">
                        <div id="no-accounts-message" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-university" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No accounts connected yet</p>
                            <p style="font-size: 0.85rem;">Click "Connect Bank" to link your accounts via Plaid</p>
                        </div>

                        <div class="upload-area" onclick="document.getElementById('bankStatementUpload').click()">
                            <input type="file" id="bankStatementUpload" style="display: none;" accept=".csv,.pdf,.ofx,.qfx" onchange="handleBankUpload(this)">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drop bank statement here or click to upload</p>
                            <p style="font-size: 0.75rem; margin-top: 0.5rem;">Supports CSV, PDF, OFX, QFX</p>
                        </div>
                    </div>
                </div>

                <!-- Bills with Smart OCR Upload -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-file-invoice"></i> Upcoming Bills</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success btn-sm" onclick="openModal('uploadBillModal')">
                                <i class="fas fa-camera"></i> Scan Bill
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="openModal('addBillModal')">
                                <i class="fas fa-plus"></i> Add Manual
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bill</th>
                                    <th>Due</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="bills-table-body">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-file-invoice" style="margin-right: 0.5rem;"></i>
                                        No bills added yet. Click "Scan Bill" to upload and auto-parse.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Receipt Upload Section -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3><i class="fas fa-receipt" style="color: var(--secondary);"></i> Quick Receipt Capture</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">AI-powered OCR extracts expense details</span>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <!-- Snap Receipt -->
                        <div class="upload-area" style="padding: 2rem;" onclick="openReceiptCapture('camera')">
                            <i class="fas fa-camera" style="font-size: 2rem; color: var(--success);"></i>
                            <p style="font-weight: 600; margin-top: 0.75rem;">Take Photo</p>
                            <p style="font-size: 0.8rem;">Snap a receipt with your camera</p>
                        </div>

                        <!-- Upload Receipt -->
                        <div class="upload-area" style="padding: 2rem;" onclick="document.getElementById('receiptUploadInput').click()">
                            <input type="file" id="receiptUploadInput" style="display: none;" accept="image/*,.pdf" onchange="handleReceiptUpload(this)">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--info);"></i>
                            <p style="font-weight: 600; margin-top: 0.75rem;">Upload File</p>
                            <p style="font-size: 0.8rem;">PDF, JPG, PNG supported</p>
                        </div>

                        <!-- Recent Receipts -->
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem;">
                            <div style="font-weight: 600; margin-bottom: 0.75rem;">
                                <i class="fas fa-history" style="margin-right: 0.5rem; color: var(--text-secondary);"></i>
                                Recent Receipts
                            </div>
                            <div id="recent-receipts-list" style="max-height: 150px; overflow-y: auto;">
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">No receipts captured yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> Recent Transactions</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="form-input" id="transaction-account-filter" style="width: auto; padding: 0.5rem 1rem;">
                            <option value="all">All Accounts</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="refreshTransactions()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Account</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                                    Loading transactions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Loan Application Package -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-file-contract" style="color: var(--teal);"></i> Loan Application Package</h3>
                    <button class="btn btn-success btn-sm" onclick="generateAndDownloadLoanPackage()">
                        <i class="fas fa-download"></i> Generate Package
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>One-Click Loan Documents:</strong> Generate professional Balance Sheet, Asset Schedule, and Depreciation Reports for bank loan applications.
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 12px; text-align: center;">
                            <i class="fas fa-balance-scale" style="font-size: 2rem; color: var(--success); margin-bottom: 0.75rem;"></i>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Balance Sheet</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Assets, Liabilities, Equity</div>
                        </div>
                        <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 12px; text-align: center;">
                            <i class="fas fa-tractor" style="font-size: 2rem; color: var(--teal); margin-bottom: 0.75rem;"></i>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Asset Schedule</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Equipment, Vehicles, Inventory</div>
                        </div>
                        <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 12px; text-align: center;">
                            <i class="fas fa-calculator" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.75rem;"></i>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Depreciation</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">MACRS 5/7-Year Schedules</div>
                        </div>
                        <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 12px; text-align: center;">
                            <i class="fas fa-credit-card" style="font-size: 2rem; color: var(--danger); margin-bottom: 0.75rem;"></i>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Debt Schedule</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Outstanding Obligations</div>
                        </div>
                    </div>

                    <div id="loan-package-status" style="margin-top: 1rem; display: none;">
                        <!-- Status will appear here after generation -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- INVESTMENTS TAB -->
        <!-- ============================================= -->
        <div id="tab-investments" class="tab-content">
            <!-- Alpaca Connection Card -->
            <div class="card" style="margin-bottom: 1.5rem;" id="alpaca-setup-card">
                <div class="card-header">
                    <h3><i class="fas fa-plug" style="color: var(--success);"></i> Connect Investment Account</h3>
                    <span id="alpaca-status" class="badge" style="background: var(--text-secondary);">Not Connected</span>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: center;">
                        <div>
                            <h4 style="margin-bottom: 0.5rem;">Alpaca - Commission-Free Investing</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                                Research-backed choice: $1 minimum, fractional shares, full API automation. Perfect for automated wealth building.
                            </p>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <span style="padding: 0.25rem 0.5rem; background: rgba(42, 157, 143, 0.2); border-radius: 4px; font-size: 0.75rem; color: var(--success);">$0 Commission</span>
                                <span style="padding: 0.25rem 0.5rem; background: rgba(67, 97, 238, 0.2); border-radius: 4px; font-size: 0.75rem; color: var(--info);">$1 Minimum</span>
                                <span style="padding: 0.25rem 0.5rem; background: rgba(155, 89, 182, 0.2); border-radius: 4px; font-size: 0.75rem; color: var(--purple);">Fractional Shares</span>
                                <span style="padding: 0.25rem 0.5rem; background: rgba(255, 215, 0, 0.2); border-radius: 4px; font-size: 0.75rem; color: var(--gold);">Auto-Invest API</span>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-success" onclick="openModal('alpacaSetupModal')" id="connectAlpacaBtn">
                                <i class="fas fa-link"></i> Connect Alpaca Account
                            </button>
                            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                Don't have an account? <a href="https://alpaca.markets" target="_blank" style="color: var(--primary-light);">Sign up free</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 75/25 Strategy Display -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h3><i class="fas fa-balance-scale" style="color: var(--gold);"></i> 75/25 Investment Strategy</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Research-optimized allocation</span>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- 75% Safe -->
                        <div style="background: rgba(42, 157, 143, 0.1); border-radius: 12px; padding: 1.5rem; border: 2px solid var(--success);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: var(--success);">75% Safe Foundation</h4>
                                <span style="font-size: 1.5rem; font-weight: 700; color: var(--success);">$0</span>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                                Modified All-Weather Portfolio. Target: 5-7% annual return, max 15% drawdown.
                            </p>
                            <div style="font-size: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                                    <span>VTI (US Stock)</span><span>20%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                                    <span>VXUS (International)</span><span>10%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                                    <span>BND (Bonds)</span><span>20%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                                    <span>VTIP (TIPS)</span><span>15%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                    <span>SHY/GLDM/PDBC</span><span>10%</span>
                                </div>
                            </div>
                        </div>

                        <!-- 25% Growth -->
                        <div style="background: rgba(244, 162, 97, 0.1); border-radius: 12px; padding: 1.5rem; border: 2px solid var(--secondary);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: var(--secondary);">25% Growth Engine</h4>
                                <span style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">$0</span>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                                Dual Momentum Strategy. Target: 10-15% annual return, accepts higher volatility.
                            </p>
                            <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Current Signal</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-secondary);" id="momentum-signal">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    Checks monthly: VTI vs VXUS vs Bonds
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Portfolio Value</div>
                            <div class="stat-value" id="investment-total" style="color: var(--success);">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral" id="investment-change">
                        <span>Connect investment accounts</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">This Month's Contribution</div>
                            <div class="stat-value" id="monthly-contribution">--</div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Set up auto-invest</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Growth Mode</div>
                            <div class="stat-value" id="growth-mode" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-rocket"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Configure strategy</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Current Drawdown</div>
                            <div class="stat-value" id="current-drawdown" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Market data unavailable</span>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i> Current Allocation</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <canvas id="allocationPieChart"></canvas>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem;">HOLDINGS</h4>
                                <div id="holdings-list">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar-alt"></i> Seasonal Schedule</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; margin-bottom: 1.5rem;">
                            <div style="padding: 1rem; text-align: center; background: rgba(230, 57, 70, 0.1); border: 1px solid var(--danger); border-right: none;">
                                <div style="font-weight: 600; font-size: 0.85rem;">Winter</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Nov-Feb</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">0.25x</div>
                            </div>
                            <div style="padding: 1rem; text-align: center; background: rgba(233, 196, 106, 0.1); border: 1px solid var(--warning);">
                                <div style="font-weight: 600; font-size: 0.85rem;">Planting</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Mar-May</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">0.75x</div>
                            </div>
                            <div style="padding: 1rem; text-align: center; background: rgba(42, 157, 143, 0.1); border: 1px solid var(--success); border-left: none;">
                                <div style="font-weight: 600; font-size: 0.85rem;">Harvest</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Jun-Oct</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">1.5x</div>
                            </div>
                        </div>
                        <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Current Season</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="current-season">--</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                Configure seasonal contributions
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; padding: 2rem;">
                <a href="wealth-builder.html" class="btn btn-primary" style="font-size: 1rem; padding: 1rem 2rem;">
                    <i class="fas fa-external-link-alt"></i> Open Full Investment Dashboard
                </a>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- ROUND-UPS TAB -->
        <!-- ============================================= -->
        <div id="tab-roundups" class="tab-content">
            <div class="roundup-animation">
                <div class="coin">
                    <i class="fas fa-coins" style="color: var(--gold);"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Round-Up Savings</div>
                    <div class="roundup-total" id="roundup-total-display">--</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Feature coming soon</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">This Month's Round-Ups</div>
                            <div class="stat-value" id="monthly-roundups" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon teal">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Enable round-ups to start</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Average Per Order</div>
                            <div class="stat-value" id="avg-roundup">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Round up to nearest $1</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Invested So Far</div>
                            <div class="stat-value" id="roundup-invested" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Connect investment account</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Pending Transfer</div>
                            <div class="stat-value" id="pending-transfer">--</div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Transfers at $100</span>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-receipt"></i> Recent Round-Ups</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order</th>
                                    <th>Amount</th>
                                    <th>Round-Up</th>
                                </tr>
                            </thead>
                            <tbody id="roundups-table-body">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-coins" style="margin-right: 0.5rem;"></i>
                                        No round-ups yet. Enable the feature to start saving automatically.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-cog"></i> Round-Up Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Round-Up Amount</label>
                            <select class="form-input">
                                <option value="1" selected>Round to nearest $1.00</option>
                                <option value="2">Round to nearest $2.00</option>
                                <option value="5">Round to nearest $5.00</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Auto-Transfer Threshold</label>
                            <select class="form-input">
                                <option value="50">Transfer at $50</option>
                                <option value="100" selected>Transfer at $100</option>
                                <option value="250">Transfer at $250</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Transfer Destination</label>
                            <select class="form-input">
                                <option value="investment" selected>Investment Portfolio</option>
                                <option value="emergency">Emergency Fund</option>
                                <option value="debt">Extra Debt Payment</option>
                            </select>
                        </div>

                        <div style="padding: 1rem; background: rgba(42, 157, 143, 0.1); border-radius: 8px; margin-top: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <input type="checkbox" id="enableRoundups" checked style="width: 20px; height: 20px;">
                                <label for="enableRoundups" style="font-weight: 600;">Enable Round-Ups</label>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem; margin-left: 2rem;">
                                Automatically round up every farm sale and invest the difference.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- WISHLIST TAB -->
        <!-- ============================================= -->
        <div id="tab-wishlist" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Wishlist Items</div>
                            <div class="stat-value" id="wishlist-count">0</div>
                        </div>
                        <div class="stat-icon purple">
                            <i class="fas fa-gift"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Total Wishlist Value</div>
                            <div class="stat-value" id="wishlist-total">$0</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Safe to Buy</div>
                            <div class="stat-value" style="color: var(--success);" id="wishlist-safe">0</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Cash Available</div>
                            <div class="stat-value" id="wishlist-cash">$0</div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-gift"></i> Equipment Wishlist</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addWishlistModal')">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Cost</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Recommendation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="wishlist-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-gift" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No wishlist items yet. Click "Add Item" to get started.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-robot"></i> Smart Purchase Advisor</h3>
                    </div>
                    <div class="card-body" id="purchase-advisor">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle" style="color: var(--info);"></i>
                            <div>
                                <strong>How it works:</strong> The system analyzes your cash flow, debt, and emergency fund to tell you when it's safe to make purchases over $1,000.
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem;">Purchase Decision Factors:</h4>
                            <ul style="font-size: 0.85rem; color: var(--text-secondary); padding-left: 1.25rem;">
                                <li>Cash reserves vs 2-month expenses</li>
                                <li>Emergency fund (3-month protection)</li>
                                <li>Debt-to-income ratio (under 40%)</li>
                                <li>Recent cash flow trend</li>
                                <li>Seasonal farm patterns</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- ASSETS & INVENTORY TAB -->
        <!-- ============================================= -->
        <div id="tab-assets" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Total Asset Value</div>
                            <div class="stat-value" style="color: var(--success);" id="assets-total">$0</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-warehouse"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Equipment Value</div>
                            <div class="stat-value" id="equipment-total">$0</div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-tractor"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Vehicle Value</div>
                            <div class="stat-value" id="vehicle-total">$0</div>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-truck"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Inventory Value</div>
                            <div class="stat-value" id="inventory-total">$0</div>
                        </div>
                        <div class="stat-icon purple">
                            <i class="fas fa-boxes"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loan Application Export -->
            <div class="card" style="background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, var(--bg-card) 100%); border: 2px solid var(--success);">
                <div class="card-header">
                    <h3><i class="fas fa-file-pdf" style="color: var(--success);"></i> Loan Application Package</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="generateLoanPackage()">
                            <i class="fas fa-download"></i> Export Balance Sheet
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="generateAssetReport()">
                            <i class="fas fa-file-alt"></i> Asset Schedule
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-secondary);">Generate professional, loan-ready financial documents with one click. Includes Balance Sheet, Asset Schedule with MACRS depreciation, and Net Worth calculation.</p>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-tractor"></i> Farm Assets</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addAssetModal')">
                            <i class="fas fa-plus"></i> Add Asset
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0; max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Asset</th>
                                    <th>Category</th>
                                    <th>Purchase Price</th>
                                    <th>Current Value</th>
                                    <th>Condition</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assets-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-warehouse" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No assets tracked yet. Add your farm equipment and vehicles.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-balance-scale"></i> Balance Sheet Summary</h3>
                    </div>
                    <div class="card-body" id="balance-sheet-summary">
                        <div style="padding: 1rem; background: rgba(42, 157, 143, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">TOTAL ASSETS</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: var(--success);" id="bs-assets">$0</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(230, 57, 70, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">TOTAL LIABILITIES</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: var(--danger);" id="bs-liabilities">$0</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(67, 97, 238, 0.1); border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">OWNER'S EQUITY (Net Worth)</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: var(--info);" id="bs-equity">$0</div>
                        </div>

                        <div style="margin-top: 1.5rem;">
                            <h4 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">Asset Breakdown</h4>
                            <div id="asset-breakdown">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                    <span>Cash & Bank</span><span id="bs-cash">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                    <span>Investments</span><span id="bs-investments">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                    <span>Equipment</span><span id="bs-equipment">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                    <span>Vehicles</span><span id="bs-vehicles">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                    <span>Inventory</span><span id="bs-inventory">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- PAYMENT PLANS TAB -->
        <!-- ============================================= -->
        <div id="tab-paymentplans" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Active Plans</div>
                            <div class="stat-value" id="plans-active">0</div>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Outstanding Balance</div>
                            <div class="stat-value" id="plans-outstanding">$0</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Collected This Month</div>
                            <div class="stat-value" style="color: var(--success);" id="plans-collected">$0</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Overdue Payments</div>
                            <div class="stat-value" style="color: var(--danger);" id="plans-overdue">0</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Customer Payment Plans</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addPaymentPlanModal')">
                            <i class="fas fa-plus"></i> New Plan
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Total Amount</th>
                                    <th>Paid</th>
                                    <th>Remaining</th>
                                    <th>Next Due</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payment-plans-table-body">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-file-invoice-dollar" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                        No payment plans yet. Create a plan for customers who want to pay in installments.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-info-circle"></i> Payment Plan Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" style="margin-bottom: 1rem;">
                            <i class="fas fa-info-circle" style="color: var(--info);"></i>
                            <div>
                                <strong>How it works:</strong> Customers can pay for CSA shares or large orders in installments with a small interest charge.
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Down Payment</label>
                            <select class="form-input" id="default-down-payment">
                                <option value="10">10%</option>
                                <option value="20" selected>20%</option>
                                <option value="25">25%</option>
                                <option value="50">50%</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Interest Rate</label>
                            <select class="form-input" id="default-interest-rate">
                                <option value="0">0% (No Interest)</option>
                                <option value="3">3%</option>
                                <option value="5" selected>5%</option>
                                <option value="7">7%</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Installments</label>
                            <select class="form-input" id="default-installments">
                                <option value="2">2 payments</option>
                                <option value="3">3 payments</option>
                                <option value="4" selected>4 payments</option>
                                <option value="6">6 payments</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overdue Payments Alert -->
            <div class="card" id="overdue-section" style="display: none; border: 2px solid var(--danger);">
                <div class="card-header" style="background: rgba(230, 57, 70, 0.1);">
                    <h3><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Overdue Payments</h3>
                </div>
                <div class="card-body" id="overdue-payments-list">
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- TEAM & RETIREMENT TAB -->
        <!-- ============================================= -->
        <div id="tab-employees" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">SEP-IRA Contributions (YTD)</div>
                            <div class="stat-value" id="sep-ira-ytd" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Set up SEP-IRA to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Team Members</div>
                            <div class="stat-value" id="team-count">--</div>
                        </div>
                        <div class="stat-icon purple">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Add employees to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Incentive Pool</div>
                            <div class="stat-value" id="incentive-pool" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-gift"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Configure incentive program</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Milestones Reached</div>
                            <div class="stat-value" id="milestones-count" style="color: var(--text-secondary);">--</div>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>No data yet</span>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <!-- Employee IRA Contributions -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-piggy-bank"></i> SEP-IRA Contributions</h3>
                        <button class="btn btn-success btn-sm" onclick="openModal('addIRAContributionModal')">
                            <i class="fas fa-plus"></i> Add Contribution
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="padding: 1rem; background: rgba(42, 157, 143, 0.1); border-bottom: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-secondary);">Annual Contribution Limit (25% of comp)</span>
                                <span style="font-weight: 600;">$66,000 max</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Farm Contribution Rate</span>
                                <span style="font-weight: 600; color: var(--success);">3% of wages</span>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>YTD Wages</th>
                                    <th>IRA Contribution</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="iraContributionsTable">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <i class="fas fa-piggy-bank" style="margin-right: 0.5rem;"></i>
                                        No SEP-IRA contributions recorded. Click "Add Contribution" to get started.
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot style="background: rgba(255,255,255,0.03);">
                                <tr>
                                    <td style="font-weight: 700;">Total</td>
                                    <td style="font-weight: 700;" id="ira-total-wages">--</td>
                                    <td style="font-weight: 700; color: var(--success);" id="ira-total-contributions">--</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Milestone Incentives (Non-Competitive) -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-gift"></i> Milestone Incentives</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Earn bonuses by reaching personal milestones - not a competition, just recognition for your hard work!
                        </p>

                        <h4 style="margin: 1rem 0 0.75rem; color: var(--text-secondary); font-size: 0.85rem;">WORK MILESTONES</h4>
                        <div class="achievement-grid">
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-calendar-check" style="color: var(--success);"></i>
                                </div>
                                <div class="achievement-name">30-Day Mark</div>
                                <div class="achievement-desc">$50 bonus</div>
                            </div>
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-calendar-alt" style="color: var(--info);"></i>
                                </div>
                                <div class="achievement-name">90-Day Mark</div>
                                <div class="achievement-desc">$100 bonus</div>
                            </div>
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-award" style="color: var(--secondary);"></i>
                                </div>
                                <div class="achievement-name">1 Year</div>
                                <div class="achievement-desc">$250 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="achievement-name">2 Years</div>
                                <div class="achievement-desc">$500 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-gem"></i>
                                </div>
                                <div class="achievement-name">5 Years</div>
                                <div class="achievement-desc">$1,000 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-crown"></i>
                                </div>
                                <div class="achievement-name">500 Hours/Season</div>
                                <div class="achievement-desc">$200 bonus</div>
                            </div>
                        </div>

                        <h4 style="margin: 1.5rem 0 0.75rem; color: var(--text-secondary); font-size: 0.85rem;">SKILL MILESTONES</h4>
                        <div class="achievement-grid">
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-seedling" style="color: var(--success);"></i>
                                </div>
                                <div class="achievement-name">Greenhouse Certified</div>
                                <div class="achievement-desc">$75 bonus</div>
                            </div>
                            <div class="achievement unlocked">
                                <div class="achievement-icon">
                                    <i class="fas fa-truck" style="color: var(--info);"></i>
                                </div>
                                <div class="achievement-name">Delivery Trained</div>
                                <div class="achievement-desc">$75 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-tractor"></i>
                                </div>
                                <div class="achievement-name">Equipment Operator</div>
                                <div class="achievement-desc">$100 bonus</div>
                            </div>
                            <div class="achievement locked">
                                <div class="achievement-icon">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                                <div class="achievement-name">Trained a New Hire</div>
                                <div class="achievement-desc">$50 bonus</div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(233, 196, 106, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                <i class="fas fa-lightbulb" style="color: var(--warning);"></i> How It Works
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5;">
                                Milestones are personal achievements - reach them at your own pace.
                                Bonuses are paid within 2 pay periods of reaching each milestone.
                                Everyone can earn every bonus!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- SETTINGS TAB -->
        <!-- ============================================= -->
        <div id="tab-settings" class="tab-content">
            <div class="three-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-link"></i> Connections</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Google Sheets ID</label>
                            <input type="text" class="form-input" value="128O56X_FN9_U-s0ENHBBRyLpae_yvWHPYbBheVlR3Vc">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apps Script URL</label>
                            <input type="text" class="form-input" placeholder="Your deployed Apps Script URL">
                        </div>
                        <button class="btn btn-primary">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-bell"></i> Notifications</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>Bill Due Reminders</span>
                                <input type="checkbox" checked>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>Debt Milestone Alerts</span>
                                <input type="checkbox" checked>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>Investment Rebalance Alerts</span>
                                <input type="checkbox" checked>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0;">
                                <span>Employee Achievement Notifications</span>
                                <input type="checkbox" checked>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-dollar-sign"></i> Financial Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Monthly Expenses (for emergency fund calc)</label>
                            <input type="number" class="form-input" value="8000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Base Monthly Investment</label>
                            <input type="number" class="form-input" value="1000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Emergency Fund Goal (months)</label>
                            <input type="number" class="form-input" value="6">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-download"></i> Import / Export</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div class="upload-area">
                            <i class="fas fa-file-csv"></i>
                            <p>Import Bank Statement</p>
                        </div>
                        <div class="upload-area">
                            <i class="fas fa-file-invoice"></i>
                            <p>Import Bills</p>
                        </div>
                        <div class="upload-area">
                            <i class="fas fa-file-export"></i>
                            <p>Export All Data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- MARKETING TAB -->
        <!-- ============================================= -->
        <div id="tab-marketing" class="tab-content">
            <!-- Marketing Budget Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Marketing Budget</div>
                            <div class="stat-value" id="marketing-budget">--</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #E1306C, #9b59b6);">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Set budget to track</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Spent This Month</div>
                            <div class="stat-value" id="marketing-spent">--</div>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-header">
                            <span id="marketing-spent-percent">--</span>
                            <span id="marketing-remaining">Log expenses to track</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill success" id="marketing-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">ROI This Month</div>
                            <div class="stat-value" id="marketing-roi">--</div>
                        </div>
                        <div class="stat-icon green">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Track spend to calculate ROI</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-label">Posts This Month</div>
                            <div class="stat-value" id="marketing-posts">--</div>
                        </div>
                        <div class="stat-icon teal">
                            <i class="fas fa-share-alt"></i>
                        </div>
                    </div>
                    <div class="stat-change neutral">
                        <span>Connect social accounts</span>
                    </div>
                </div>
            </div>

            <!-- Marketing Spend Breakdown -->
            <div class="two-col">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i> Spend by Category</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addMarketingSpendModal')">
                            <i class="fas fa-plus"></i> Log Expense
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="marketing-spend-categories">
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <i class="fas fa-chart-pie" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No marketing spend logged yet</p>
                                <p style="font-size: 0.85rem;">Click "Log Expense" to start tracking</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-history"></i> Recent Marketing Spend</h3>
                        <a href="marketing-command-center.html" class="btn btn-secondary btn-sm">
                            <i class="fas fa-external-link-alt"></i> Marketing Hub
                        </a>
                    </div>
                    <div class="card-body">
                        <div id="marketing-spend-history" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No expenses logged yet</p>
                                <p style="font-size: 0.85rem;">Marketing expenses will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marketing Fund Allocation -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-piggy-bank"></i> Marketing Fund</h3>
                    <button class="btn btn-success btn-sm" onclick="openModal('allocateMarketingModal')">
                        <i class="fas fa-plus"></i> Add Funds
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Marketing Fund Balance:</strong> <span id="marketing-balance">--</span>
                            <br><small>Configure marketing fund to track spend vs budget</small>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: var(--surface-secondary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Monthly Auto-Allocation</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="marketing-auto-percent">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Configure in settings</div>
                        </div>
                        <div style="padding: 1rem; background: var(--surface-secondary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Last Deposit</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="marketing-last-deposit">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">No deposits yet</div>
                        </div>
                        <div style="padding: 1rem; background: var(--surface-secondary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">YTD Spend</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="marketing-ytd-spend">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Log expenses to track</div>
                        </div>
                        <div style="padding: 1rem; background: var(--surface-secondary); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Avg. Cost Per Post</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="marketing-cost-per-post">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Connect social accounts</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                        <a href="marketing-command-center.html" class="btn btn-primary">
                            <i class="fas fa-bullhorn"></i> Open Marketing Hub
                        </a>
                        <button class="btn btn-secondary" onclick="openModal('addMarketingSpendModal')">
                            <i class="fas fa-receipt"></i> Log Marketing Expense
                        </button>
                        <button class="btn btn-secondary" onclick="openModal('allocateMarketingModal')">
                            <i class="fas fa-hand-holding-usd"></i> Add to Marketing Fund
                        </button>
                        <button class="btn btn-secondary" onclick="loadMarketingData()">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ============================================= -->
    <!-- MODALS -->
    <!-- ============================================= -->

    <!-- Add Debt Modal -->
    <div class="modal-overlay" id="addDebtModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Add Debt Account</h2>
                <button class="modal-close" onclick="closeModal('addDebtModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Connect via Plaid - Primary Option -->
                <div style="background: linear-gradient(135deg, rgba(42, 157, 143, 0.1), rgba(38, 70, 83, 0.1)); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                    <i class="fas fa-link" style="font-size: 2rem; color: var(--success); margin-bottom: 0.75rem;"></i>
                    <h3 style="margin: 0 0 0.5rem; color: var(--text-primary);">Connect Credit Card via Plaid</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Auto-sync balances, payments, and transactions</p>
                    <button class="btn btn-success" onclick="closeModal('addDebtModal'); connectBankWithPlaid();">
                        <i class="fas fa-credit-card"></i> Connect Credit Card
                    </button>
                </div>

                <div style="text-align: center; color: var(--text-secondary); margin: 1rem 0; font-size: 0.85rem;">
                     or add manually (not recommended) 
                </div>

                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" placeholder="e.g., Chase Visa">
                </div>
                <div class="form-group">
                    <label class="form-label">Debt Type</label>
                    <select class="form-input">
                        <option>Credit Card</option>
                        <option>Personal Loan</option>
                        <option>Auto Loan</option>
                        <option>Mortgage</option>
                        <option>Student Loan</option>
                        <option>Medical Debt</option>
                        <option>PayPal Credit (Synchrony)</option>
                        <option>Other</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Current Balance</label>
                        <input type="number" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Interest Rate (APR %)</label>
                        <input type="number" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Minimum Payment</label>
                        <input type="number" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="number" class="form-input" placeholder="Day of month (1-31)" min="1" max="31">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addDebtModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveDebt()">
                    <i class="fas fa-save"></i> Save Debt
                </button>
            </div>
        </div>
    </div>

    <!-- Add Wishlist Item Modal -->
    <div class="modal-overlay" id="addWishlistModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-gift" style="color: var(--purple);"></i> Add to Equipment Wishlist</h2>
                <button class="modal-close" onclick="closeModal('addWishlistModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-brain"></i>
                    <div>
                        <strong>Smart Purchase Planning:</strong> Add equipment, vehicles, or big purchases. The system will analyze your finances and tell you when it's safe to buy.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input type="text" class="form-input" id="wishlist-item-name" placeholder="e.g., New delivery van, Greenhouse heater">
                </div>

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="wishlist-category">
                        <option value="equipment">Farm Equipment</option>
                        <option value="vehicle">Vehicle</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="tools">Tools</option>
                        <option value="technology">Technology</option>
                        <option value="supplies">Supplies (Bulk)</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Estimated Cost</label>
                        <input type="number" class="form-input" id="wishlist-cost" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-input" id="wishlist-priority">
                            <option value="high">High - Need ASAP</option>
                            <option value="medium" selected>Medium - Within 3 months</option>
                            <option value="low">Low - Nice to have</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Purchase Method Preference</label>
                    <select class="form-input" id="wishlist-method">
                        <option value="auto">Let System Decide (Recommended)</option>
                        <option value="cash">Cash Only</option>
                        <option value="finance">Open to Financing</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-input" id="wishlist-notes" rows="2" placeholder="e.g., Saw one at dealer for $22k, need before spring planting"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Target Date (optional)</label>
                    <input type="date" class="form-input" id="wishlist-target-date">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addWishlistModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveWishlistItem()">
                    <i class="fas fa-save"></i> Add to Wishlist
                </button>
            </div>
        </div>
    </div>

    <!-- Add Asset Modal -->
    <div class="modal-overlay" id="addAssetModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-tractor" style="color: var(--teal);"></i> Add Asset for Loan Readiness</h2>
                <button class="modal-close" onclick="closeModal('addAssetModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-file-contract"></i>
                    <div>
                        <strong>Loan-Ready Assets:</strong> Track equipment, vehicles, and inventory. Generate professional asset schedules and balance sheets for loan applications with one click.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Asset Name</label>
                    <input type="text" class="form-input" id="asset-name" placeholder="e.g., John Deere 5045E Tractor">
                </div>

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="asset-category">
                        <option value="equipment">Farm Equipment</option>
                        <option value="vehicle">Vehicle</option>
                        <option value="infrastructure">Infrastructure/Buildings</option>
                        <option value="tools">Tools</option>
                        <option value="inventory">Inventory</option>
                        <option value="land">Land</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Purchase Price</label>
                        <input type="number" class="form-input" id="asset-purchase-price" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Purchase Date</label>
                        <input type="date" class="form-input" id="asset-purchase-date">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Current Value (Est.)</label>
                        <input type="number" class="form-input" id="asset-current-value" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Condition</label>
                        <select class="form-input" id="asset-condition">
                            <option value="excellent">Excellent</option>
                            <option value="good" selected>Good</option>
                            <option value="fair">Fair</option>
                            <option value="poor">Poor</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Serial Number (optional)</label>
                        <input type="text" class="form-input" id="asset-serial" placeholder="For insurance/loans">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="asset-location" placeholder="e.g., Main barn">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Depreciation Method</label>
                    <select class="form-input" id="asset-depreciation">
                        <option value="none">No Depreciation</option>
                        <option value="5year" selected>5-Year MACRS</option>
                        <option value="7year">7-Year MACRS</option>
                        <option value="straight">Straight Line (10 years)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Photo (optional)</label>
                    <div class="upload-area" style="padding: 1.5rem;" onclick="document.getElementById('asset-photo-upload').click()">
                        <input type="file" id="asset-photo-upload" style="display: none;" accept="image/*">
                        <i class="fas fa-camera" style="font-size: 1.5rem;"></i>
                        <p style="margin: 0.5rem 0 0;">Click to add photo</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addAssetModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAsset()">
                    <i class="fas fa-save"></i> Save Asset
                </button>
            </div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal-overlay" id="addAccountModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-university"></i> Add Bank Account</h2>
                <button class="modal-close" onclick="closeModal('addAccountModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" placeholder="e.g., Farm Operations Checking">
                </div>
                <div class="form-group">
                    <label class="form-label">Account Type</label>
                    <select class="form-input">
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                        <option value="investment">Investment</option>
                        <option value="credit">Credit Card</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Institution</label>
                    <input type="text" class="form-input" placeholder="e.g., First National Bank">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Current Balance</label>
                        <input type="number" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last 4 Digits</label>
                        <input type="text" class="form-input" placeholder="1234" maxlength="4">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addAccountModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAccount()">
                    <i class="fas fa-save"></i> Save Account
                </button>
            </div>
        </div>
    </div>

    <!-- Add Bill Modal -->
    <div class="modal-overlay" id="addBillModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice"></i> Add Bill</h2>
                <button class="modal-close" onclick="closeModal('addBillModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Bill Name</label>
                    <input type="text" class="form-input" placeholder="e.g., Electric - PG&E">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input">
                        <option>Utility</option>
                        <option>Insurance</option>
                        <option>Subscription</option>
                        <option>Loan Payment</option>
                        <option>Rent/Mortgage</option>
                        <option>Farm Expense</option>
                        <option>Other</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Day (monthly)</label>
                        <input type="number" class="form-input" placeholder="1-31" min="1" max="31">
                    </div>
                </div>
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="autoPay">
                        <label for="autoPay">Auto-Pay Enabled</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addBillModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveBill()">
                    <i class="fas fa-save"></i> Save Bill
                </button>
            </div>
        </div>
    </div>

    <!-- Add Marketing Spend Modal -->
    <div class="modal-overlay" id="addMarketingSpendModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-receipt"></i> Log Marketing Expense</h2>
                <button class="modal-close" onclick="closeModal('addMarketingSpendModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="marketingSpendDesc" placeholder="e.g., Instagram Boost - CSA Promo">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="marketingSpendCategory">
                        <option value="social_ads">Social Media Ads</option>
                        <option value="sms">SMS/Twilio</option>
                        <option value="subscription">Subscriptions (Ayrshare, etc)</option>
                        <option value="print">Print Materials</option>
                        <option value="photography">Photography/Content</option>
                        <option value="events">Events & Sponsorships</option>
                        <option value="direct_mail">Direct Mail</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" id="marketingSpendAmount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="marketingSpendDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Campaign (Optional)</label>
                    <select class="form-input" id="marketingSpendCampaign">
                        <option value="">-- No Campaign --</option>
                        <option value="csa_spring_2026">CSA Spring 2026</option>
                        <option value="farmers_market">Farmer's Market Promotion</option>
                        <option value="restaurant_outreach">Restaurant Outreach</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="marketingSpendNotes" rows="2" placeholder="Optional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addMarketingSpendModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveMarketingSpend()">
                    <i class="fas fa-save"></i> Log Expense
                </button>
            </div>
        </div>
    </div>

    <!-- Allocate Marketing Funds Modal -->
    <div class="modal-overlay" id="allocateMarketingModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-hand-holding-usd"></i> Add to Marketing Fund</h2>
                <button class="modal-close" onclick="closeModal('allocateMarketingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Current Balance:</strong> <span id="modal-marketing-balance">--</span>
                        <br><small>Add funds manually or adjust auto-allocation settings</small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Add One-Time Amount</label>
                    <input type="number" class="form-input" id="marketingFundAmount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Source</label>
                    <select class="form-input" id="marketingFundSource">
                        <option value="cash">Cash Transfer</option>
                        <option value="sales">Sales Revenue</option>
                        <option value="grant">Grant/Award</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <hr style="margin: 1.5rem 0; border-color: var(--border);">
                <h4 style="margin-bottom: 1rem;">Auto-Allocation Settings</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Percentage of Sales</label>
                        <input type="number" class="form-input" id="marketingAutoPercent" value="2" min="0" max="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Cap</label>
                        <input type="number" class="form-input" id="marketingMonthlyCap" placeholder="500" step="50">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('allocateMarketingModal')">Cancel</button>
                <button class="btn btn-primary" onclick="allocateMarketingFunds()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Upload Bill Modal with OCR -->
    <div class="modal-overlay" id="uploadBillModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-camera" style="color: var(--success);"></i> Scan Bill with AI</h2>
                <button class="modal-close" onclick="closeModal('uploadBillModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-magic"></i>
                    <div>
                        <strong>AI-Powered Scanning:</strong> Upload a bill image or PDF. Our system will automatically extract vendor, amount, due date, and account details.
                    </div>
                </div>

                <!-- Upload Area -->
                <div id="bill-upload-area">
                    <div class="upload-area" style="margin-bottom: 1rem;" onclick="document.getElementById('billImageUpload').click()">
                        <input type="file" id="billImageUpload" style="display: none;" accept="image/*,.pdf" onchange="handleBillImageUpload(this)">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary-light);"></i>
                        <p style="font-weight: 600; font-size: 1.1rem;">Drop bill here or click to upload</p>
                        <p style="font-size: 0.85rem; color: var(--text-secondary);">Supports JPG, PNG, PDF</p>
                    </div>

                    <div style="text-align: center; margin: 1rem 0; color: var(--text-secondary);">
                         or 
                    </div>

                    <button class="btn btn-success" style="width: 100%;" onclick="openCameraCapture('bill')">
                        <i class="fas fa-camera"></i> Take Photo with Camera
                    </button>
                </div>

                <!-- Processing State -->
                <div id="bill-processing" style="display: none; text-align: center; padding: 2rem;">
                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                    <p style="font-weight: 600;">Analyzing bill with AI...</p>
                    <p style="color: var(--text-secondary); font-size: 0.85rem;">Extracting vendor, amount, due date...</p>
                </div>

                <!-- Extracted Data Form -->
                <div id="bill-extracted-data" style="display: none;">
                    <div style="background: rgba(42, 157, 143, 0.1); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        <strong>Bill Extracted Successfully!</strong>
                        <span style="font-size: 0.85rem; color: var(--text-secondary);"> - Review and save below</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Vendor / Payee</label>
                        <input type="text" class="form-input" id="extracted-vendor" placeholder="Extracted vendor name">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Amount Due</label>
                            <input type="number" class="form-input" id="extracted-amount" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-input" id="extracted-due-date">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Account Number (if found)</label>
                            <input type="text" class="form-input" id="extracted-account-number" placeholder="Account #">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-input" id="extracted-category">
                                <option value="utility">Utility</option>
                                <option value="insurance">Insurance</option>
                                <option value="subscription">Subscription</option>
                                <option value="loan">Loan Payment</option>
                                <option value="rent">Rent/Lease</option>
                                <option value="farm">Farm Expense</option>
                                <option value="supplies">Supplies</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="extracted-recurring" style="margin-right: 0.5rem;">
                            This is a recurring monthly bill
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('uploadBillModal'); resetBillUpload();">Cancel</button>
                <button class="btn btn-primary" id="saveBillBtn" onclick="saveExtractedBill()" style="display: none;">
                    <i class="fas fa-save"></i> Save Bill
                </button>
            </div>
        </div>
    </div>

    <!-- Alpaca Setup Modal -->
    <div class="modal-overlay" id="alpacaSetupModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-chart-line" style="color: var(--success);"></i> Connect Alpaca Investment Account</h2>
                <button class="modal-close" onclick="closeModal('alpacaSetupModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Secure API Connection:</strong> Your API keys are encrypted and stored securely. Alpaca uses OAuth 2.0 for authentication.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Alpaca API Key ID</label>
                    <input type="text" class="form-input" id="alpaca-api-key" placeholder="PKXXXXXXXXXXXXXXXX">
                    <small style="color: var(--text-secondary);">Found in your Alpaca dashboard under API Keys</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Alpaca Secret Key</label>
                    <input type="password" class="form-input" id="alpaca-secret-key" placeholder="Your secret key">
                    <small style="color: var(--text-secondary);">Keep this secure - never share it</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Account Type</label>
                    <select class="form-input" id="alpaca-account-type">
                        <option value="paper">Paper Trading (Test)</option>
                        <option value="live">Live Trading</option>
                    </select>
                    <small style="color: var(--text-secondary);">Start with Paper to test automation</small>
                </div>

                <hr style="margin: 1.5rem 0; border-color: var(--border);">

                <h4 style="margin-bottom: 1rem;">Auto-Invest Settings</h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Monthly Investment</label>
                        <input type="number" class="form-input" id="alpaca-monthly-amount" placeholder="200" min="1">
                        <small style="color: var(--text-secondary);">Auto-invest on the 1st of each month</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Round-Up Threshold</label>
                        <select class="form-input" id="alpaca-roundup-threshold">
                            <option value="5">Invest at $5</option>
                            <option value="10">Invest at $10</option>
                            <option value="25">Invest at $25</option>
                            <option value="50">Invest at $50</option>
                            <option value="100" selected>Invest at $100</option>
                        </select>
                        <small style="color: var(--text-secondary);">Pool round-ups until this amount</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Investment Strategy</label>
                    <select class="form-input" id="alpaca-strategy">
                        <option value="75-25" selected>75/25 Safe/Growth (Recommended)</option>
                        <option value="all-weather">100% All-Weather (Conservative)</option>
                        <option value="dual-momentum">100% Dual Momentum (Aggressive)</option>
                        <option value="custom">Custom Allocation</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="alpaca-seasonal" style="margin-right: 0.5rem;" checked>
                        Apply seasonal multipliers (reduce in winter, increase in harvest)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('alpacaSetupModal')">Cancel</button>
                <button class="btn btn-success" onclick="connectAlpaca()">
                    <i class="fas fa-link"></i> Connect & Activate
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Payment Plan Modal -->
    <div class="modal-overlay" id="paymentPlanModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-alt" style="color: var(--info);"></i> Create Customer Payment Plan</h2>
                <button class="modal-close" onclick="closeModal('paymentPlanModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>In-House Financing:</strong> Offer payment plans to customers for CSA shares or large orders. Auto-calculate interest and send payment reminders.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Customer Name</label>
                    <input type="text" class="form-input" id="plan-customer-name" placeholder="Customer name">
                </div>

                <div class="form-group">
                    <label class="form-label">Customer Email</label>
                    <input type="email" class="form-input" id="plan-customer-email" placeholder="customer@email.com">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Total Amount</label>
                        <input type="number" class="form-input" id="plan-total-amount" placeholder="500.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Down Payment (%)</label>
                        <select class="form-input" id="plan-down-payment">
                            <option value="0">No Down Payment</option>
                            <option value="10">10%</option>
                            <option value="20" selected>20%</option>
                            <option value="25">25%</option>
                            <option value="50">50%</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Number of Installments</label>
                        <select class="form-input" id="plan-installments">
                            <option value="2">2 payments</option>
                            <option value="3">3 payments</option>
                            <option value="4" selected>4 payments</option>
                            <option value="6">6 payments</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Interest Rate (Simple)</label>
                        <select class="form-input" id="plan-interest">
                            <option value="0">0% (No Interest)</option>
                            <option value="3">3%</option>
                            <option value="5" selected>5%</option>
                            <option value="10">10%</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Plan Type</label>
                    <select class="form-input" id="plan-type">
                        <option value="csa">CSA Share</option>
                        <option value="wholesale">Wholesale Order</option>
                        <option value="custom">Custom Order</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Final Payment Due</label>
                    <input type="date" class="form-input" id="plan-due-date">
                    <small style="color: var(--text-secondary);">All payments must complete before this date</small>
                </div>

                <!-- Payment Calculation Preview -->
                <div style="background: rgba(67, 97, 238, 0.1); border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem;"><i class="fas fa-calculator" style="margin-right: 0.5rem;"></i>Payment Preview</h4>
                    <div id="payment-preview" style="font-size: 0.9rem; color: var(--text-secondary);">
                        Enter amount to see payment breakdown
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('paymentPlanModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createPaymentPlan()">
                    <i class="fas fa-save"></i> Create Payment Plan
                </button>
            </div>
        </div>
    </div>

    <!-- Add Wishlist Item Modal -->
    <div class="modal-overlay" id="addWishlistModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-gift"></i> Add Wishlist Item</h2>
                <button class="modal-close" onclick="closeModal('addWishlistModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input type="text" class="form-input" id="wishlist-name" placeholder="e.g., Delivery Van, Greenhouse">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="wishlist-category">
                        <option value="equipment">Equipment</option>
                        <option value="vehicle">Vehicle</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="technology">Technology</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Estimated Cost</label>
                        <input type="number" class="form-input" id="wishlist-cost" placeholder="0.00" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-input" id="wishlist-priority">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-input" id="wishlist-notes" rows="2" placeholder="Why do you need this?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addWishlistModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveWishlistItem()">
                    <i class="fas fa-save"></i> Add to Wishlist
                </button>
            </div>
        </div>
    </div>

    <!-- Add Asset Modal -->
    <div class="modal-overlay" id="addAssetModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-warehouse"></i> Add Farm Asset</h2>
                <button class="modal-close" onclick="closeModal('addAssetModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Asset Name</label>
                    <input type="text" class="form-input" id="asset-name" placeholder="e.g., John Deere Tractor">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="asset-category">
                        <option value="equipment">Equipment</option>
                        <option value="vehicle">Vehicle</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="inventory">Inventory</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Purchase Price</label>
                        <input type="number" class="form-input" id="asset-purchase-price" placeholder="0.00" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Purchase Date</label>
                        <input type="date" class="form-input" id="asset-purchase-date">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Current Value</label>
                        <input type="number" class="form-input" id="asset-current-value" placeholder="0.00" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Condition</label>
                        <select class="form-input" id="asset-condition">
                            <option value="excellent">Excellent</option>
                            <option value="good" selected>Good</option>
                            <option value="fair">Fair</option>
                            <option value="poor">Poor</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Serial Number (optional)</label>
                    <input type="text" class="form-input" id="asset-serial" placeholder="For insurance/loans">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addAssetModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAsset()">
                    <i class="fas fa-save"></i> Add Asset
                </button>
            </div>
        </div>
    </div>

    <!-- Add Payment Plan Modal -->
    <div class="modal-overlay" id="addPaymentPlanModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> Create Payment Plan</h2>
                <button class="modal-close" onclick="closeModal('addPaymentPlanModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-input" id="plan-customer-name" placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Email</label>
                        <input type="email" class="form-input" id="plan-customer-email" placeholder="email@example.com">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Total Amount</label>
                        <input type="number" class="form-input" id="plan-total" placeholder="0.00" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Down Payment %</label>
                        <select class="form-input" id="plan-down-payment">
                            <option value="10">10%</option>
                            <option value="20" selected>20%</option>
                            <option value="25">25%</option>
                            <option value="50">50%</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Installments</label>
                        <select class="form-input" id="plan-installments">
                            <option value="2">2 payments</option>
                            <option value="3">3 payments</option>
                            <option value="4" selected>4 payments</option>
                            <option value="6">6 payments</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Interest Rate</label>
                        <select class="form-input" id="plan-interest">
                            <option value="0">0% (No Interest)</option>
                            <option value="3">3%</option>
                            <option value="5" selected>5%</option>
                            <option value="7">7%</option>
                        </select>
                    </div>
                </div>
                <div style="padding: 1rem; background: rgba(67, 97, 238, 0.1); border-radius: 8px; margin-top: 1rem;" id="plan-preview-box">
                    <h4 style="margin-bottom: 0.5rem;">Payment Preview</h4>
                    <div id="plan-preview-content" style="font-size: 0.9rem; color: var(--text-secondary);">
                        Enter amount to see payment schedule...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addPaymentPlanModal')">Cancel</button>
                <button class="btn btn-primary" onclick="savePaymentPlan()">
                    <i class="fas fa-save"></i> Create Plan
                </button>
            </div>
        </div>
    </div>

    <!-- Loan Package Preview Modal -->
    <div class="modal-overlay" id="loanPackageModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-file-pdf"></i> Loan Application Package Preview</h2>
                <button class="modal-close" onclick="closeModal('loanPackageModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="loan-package-content">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('loanPackageModal')">Close</button>
                <button class="btn btn-primary" onclick="printLoanPackage()">
                    <i class="fas fa-print"></i> Print / Save PDF
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- JAVASCRIPT -->
    <!-- ============================================= -->
    <script>
        // =============================================
        // TAB NAVIGATION
        // =============================================
        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabId).classList.add('active');

            // Activate button
            event.target.closest('.tab-btn').classList.add('active');
        }

        // =============================================
        // MODAL FUNCTIONS
        // =============================================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // =============================================
        // DEBT DESTROYER FUNCTIONS
        // =============================================
        let currentStrategy = 'avalanche';

        function selectStrategy(strategy) {
            currentStrategy = strategy;
            document.querySelectorAll('.strategy-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.closest('.strategy-option').classList.add('active');
            recalculatePayoff();
        }

        function recalculatePayoff() {
            // This would recalculate the payoff timeline based on strategy
            console.log('Recalculating payoff with strategy:', currentStrategy);
            // In production, this would call the Google Sheets API
        }

        function saveDebt() {
            // Save debt to Google Sheets
            console.log('Saving debt...');
            closeModal('addDebtModal');
            // In production: call Apps Script API
        }

        function editDebt(debtId) {
            console.log('Editing debt:', debtId);
            // Open modal with debt data
        }

        // =============================================
        // BANKING FUNCTIONS
        // =============================================
        function saveAccount() {
            console.log('Saving account...');
            closeModal('addAccountModal');
        }

        function saveBill() {
            // Get form values from the Add Bill modal
            const modal = document.getElementById('addBillModal');
            const nameInput = modal.querySelector('input[placeholder*="Electric"]');
            const categorySelect = modal.querySelector('select');
            const amountInput = modal.querySelector('input[placeholder="0.00"]');
            const dueDayInput = modal.querySelector('input[placeholder="1-31"]');
            const autoPayCheckbox = document.getElementById('autoPay');

            const vendor = nameInput ? nameInput.value.trim() : '';
            const category = categorySelect ? categorySelect.value.toLowerCase() : 'other';
            const amount = amountInput ? parseFloat(amountInput.value) : 0;
            const dueDay = dueDayInput ? parseInt(dueDayInput.value) : 1;
            const isRecurring = autoPayCheckbox ? autoPayCheckbox.checked : false;

            if (!vendor || !amount) {
                showNotification('Please enter bill name and amount', 'error');
                return;
            }

            // Calculate next due date based on due day
            const today = new Date();
            let dueDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
            if (dueDate < today) {
                dueDate.setMonth(dueDate.getMonth() + 1);
            }

            // Add via BillOCR manager
            BillOCR.add({
                vendor,
                amount,
                dueDate: dueDate.toISOString().split('T')[0],
                category,
                isRecurring,
                paid: false
            });

            // Clear form and close
            if (nameInput) nameInput.value = '';
            if (amountInput) amountInput.value = '';
            if (dueDayInput) dueDayInput.value = '';
            if (autoPayCheckbox) autoPayCheckbox.checked = false;

            closeModal('addBillModal');
        }

        function handleBankUpload(input) {
            const file = input.files[0];
            if (file) {
                console.log('Uploading bank statement:', file.name);
                // Parse and import transactions
            }
        }

        // =============================================
        // SYNC FUNCTION
        // =============================================
        function syncData() {
            console.log('Syncing with Google Sheets...');
            // In production: call Apps Script API to refresh all data
        }

        // =============================================
        // CHARTS
        // =============================================

        // Financial Health Chart
        const healthCtx = document.getElementById('healthChart');
        if (healthCtx) {
            new Chart(healthCtx.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['Emergency Fund', 'Debt-to-Income', 'Savings Rate', 'Investment Growth', 'Cash Flow'],
                    datasets: [{
                        label: 'Your Score',
                        data: [50, 65, 80, 75, 85],
                        backgroundColor: 'rgba(42, 157, 143, 0.2)',
                        borderColor: 'rgba(42, 157, 143, 1)',
                        pointBackgroundColor: 'rgba(42, 157, 143, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(42, 157, 143, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: '#8d99ae' },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Allocation Pie Chart
        const allocationCtx = document.getElementById('allocationPieChart');
        if (allocationCtx) {
            const allocationData = [
                { ticker: 'VTI', percent: 15.0, color: '#2a9d8f' },
                { ticker: 'VXUS', percent: 7.5, color: '#264653' },
                { ticker: 'BND', percent: 15.0, color: '#4361ee' },
                { ticker: 'TIP', percent: 11.25, color: '#3a86ff' },
                { ticker: 'GOVT', percent: 7.5, color: '#8338ec' },
                { ticker: 'GLD', percent: 5.625, color: '#ffd700' },
                { ticker: 'DBC', percent: 3.75, color: '#fb8500' },
                { ticker: 'SHY', percent: 7.5, color: '#90be6d' },
                { ticker: 'QQQ', percent: 12.5, color: '#f4a261' },
                { ticker: 'MTUM', percent: 12.5, color: '#e76f51' }
            ];

            new Chart(allocationCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: allocationData.map(d => d.ticker),
                    datasets: [{
                        data: allocationData.map(d => d.percent),
                        backgroundColor: allocationData.map(d => d.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Populate holdings list
            const holdingsList = document.getElementById('holdings-list');
            allocationData.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);';
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; border-radius: 3px; background: ${item.color};"></div>
                        <span style="font-weight: 500;">${item.ticker}</span>
                    </div>
                    <span style="color: var(--text-secondary);">${item.percent}%</span>
                `;
                holdingsList.appendChild(div);
            });
        }

        // =============================================
        // GOOGLE SHEETS API INTEGRATION
        // =============================================
        const API_CONFIG = {
            sheetId: '128O56X_FN9_U-s0ENHBBRyLpae_yvWHPYbBheVlR3Vc',
            apiUrl: 'https://script.google.com/macros/s/AKfycbyMDydZxlRWRNw3BTSU_tXMgw3R6tYK0zN6CdlG8RjFlFCk9_NKMuHrOACTVlmUvMdE/exec'
        };

        // =============================================
        // UNIFIED FINANCIAL STATE MANAGER
        // =============================================
        // Central state that all tabs read from and write to
        const FinancialState = {
            // Raw data from sources
            plaidAccounts: [],
            plaidTransactions: [],
            shopifyPayments: { pending: 0 },
            shopifyCapital: { balance: 0, originalAmount: 0, repaymentRate: 0 },
            paypalBalance: { available: 0, pending: 0 },
            paypalTransactions: [],

            // Calculated totals
            totals: {
                assets: 0,
                debt: 0,
                netWorth: 0,
                cash: 0,
                investments: 0,
                emergencyFund: 0,
                creditLimit: 0,
                creditUsed: 0,
                monthlyIncome: 0,
                monthlyExpenses: 0
            },

            // Update state and trigger UI refresh
            update(source, data) {
                console.log(`[FinancialState] Updating ${source}:`, data);

                switch(source) {
                    case 'plaidAccounts':
                        this.plaidAccounts = data || [];
                        break;
                    case 'plaidTransactions':
                        this.plaidTransactions = data || [];
                        break;
                    case 'shopifyPayments':
                        this.shopifyPayments = data || { pending: 0 };
                        break;
                    case 'shopifyCapital':
                        this.shopifyCapital = data || { balance: 0 };
                        break;
                    case 'paypalBalance':
                        this.paypalBalance = data || { available: 0, pending: 0 };
                        break;
                    case 'paypalTransactions':
                        this.paypalTransactions = data || [];
                        break;
                }

                this.recalculateTotals();
                this.refreshAllUI();
            },

            recalculateTotals() {
                let assets = 0, debt = 0, cash = 0, investments = 0, emergencyFund = 0;
                let creditLimit = 0, creditUsed = 0;

                // Process Plaid accounts
                this.plaidAccounts.forEach(account => {
                    const balance = account.balance_current || 0;
                    const limit = account.balance_limit || 0;
                    const subtype = (account.subtype || '').toLowerCase();
                    const type = (account.type || '').toLowerCase();

                    // Assets
                    if (subtype === 'checking' || subtype === 'savings' ||
                        subtype === 'money market' || subtype === 'cd' || type === 'depository') {
                        assets += balance;
                        cash += balance;
                        if (subtype === 'savings' || subtype === 'money market') {
                            emergencyFund += balance;
                        }
                    }

                    // Investments
                    if (type === 'investment' || subtype === 'brokerage' ||
                        subtype === '401k' || subtype === 'ira') {
                        assets += balance;
                        investments += balance;
                    }

                    // Debt (credit cards, loans)
                    if (subtype === 'credit card' || type === 'credit') {
                        debt += Math.abs(balance);
                        creditUsed += Math.abs(balance);
                        creditLimit += limit;
                    } else if (type === 'loan' || subtype === 'loan' ||
                               subtype === 'mortgage' || subtype === 'student') {
                        debt += Math.abs(balance);
                    }
                });

                // Add Shopify Capital to debt
                if (this.shopifyCapital.balance > 0) {
                    debt += this.shopifyCapital.balance;
                }

                // Add PayPal balance to cash
                if (this.paypalBalance.available > 0) {
                    cash += this.paypalBalance.available;
                    assets += this.paypalBalance.available;
                }

                // Add Shopify pending to assets (it's money owed to you)
                if (this.shopifyPayments.pending > 0) {
                    // Don't add to assets - it's pending, not available
                }

                // Calculate monthly income/expenses from transactions
                let monthlyIncome = 0, monthlyExpenses = 0;
                this.plaidTransactions.forEach(txn => {
                    if (txn.pending) return;
                    const amount = txn.amount || 0;
                    if (amount < 0) {
                        monthlyIncome += Math.abs(amount);
                    } else {
                        monthlyExpenses += amount;
                    }
                });

                // Store calculated totals
                this.totals = {
                    assets,
                    debt,
                    netWorth: assets - debt,
                    cash,
                    investments,
                    emergencyFund,
                    creditLimit,
                    creditUsed,
                    creditUtilization: creditLimit > 0 ? Math.round((creditUsed / creditLimit) * 100) : 0,
                    monthlyIncome,
                    monthlyExpenses
                };

                console.log('[FinancialState] Totals recalculated:', this.totals);
            },

            refreshAllUI() {
                // Overview tab
                this.updateElement('total-net-worth', this.formatCurrency(this.totals.netWorth),
                    this.totals.netWorth >= 0 ? 'positive' : 'negative');
                this.updateElement('total-assets', this.formatCurrency(this.totals.assets));
                this.updateElement('total-debt', this.totals.debt > 0 ? '-' + this.formatCurrency(this.totals.debt) : '$0');
                this.updateElement('monthly-income', this.formatCurrency(this.totals.monthlyIncome));
                this.updateElement('monthly-expenses', this.formatCurrency(this.totals.monthlyExpenses));
                this.updateElement('emergency-fund', this.formatCurrency(this.totals.emergencyFund));
                this.updateElement('investment-total', this.formatCurrency(this.totals.investments));
                this.updateElement('debt-remaining', this.formatCurrency(this.totals.debt));

                // Emergency fund coverage (assuming $3000/month expenses)
                const monthlyExpenseEstimate = this.totals.monthlyExpenses || 3000;
                const monthsCovered = monthlyExpenseEstimate > 0 ?
                    (this.totals.emergencyFund / monthlyExpenseEstimate).toFixed(1) : 0;
                this.updateElement('emergency-months', monthsCovered + ' months covered');
                const emergencyProgress = document.getElementById('emergency-progress');
                if (emergencyProgress) {
                    const percent = Math.min((monthsCovered / 6) * 100, 100);
                    emergencyProgress.style.width = percent + '%';
                    emergencyProgress.className = 'progress-fill ' +
                        (percent >= 100 ? 'success' : percent >= 50 ? 'warning' : 'danger');
                }

                // Banking tab
                this.updateElement('total-cash-display', this.formatCurrency(this.totals.cash));
                const cashCount = this.plaidAccounts.filter(a =>
                    ['checking', 'savings', 'money market'].includes((a.subtype || '').toLowerCase())
                ).length;
                this.updateElement('cash-accounts-count', cashCount + ' account' + (cashCount !== 1 ? 's' : '') + ' connected', null, true);

                // Debt destroyer tab
                const debtAccounts = this.plaidAccounts.filter(a => {
                    const subtype = (a.subtype || '').toLowerCase();
                    const type = (a.type || '').toLowerCase();
                    return subtype === 'credit card' || type === 'credit' || type === 'loan';
                });
                let debtCount = debtAccounts.length;
                if (this.shopifyCapital.balance > 0) debtCount++;

                this.updateElement('debt-total-display', this.formatCurrency(this.totals.debt));
                this.updateElement('debt-accounts-count', debtCount.toString());
                this.updateElement('debt-count', debtCount.toString()); // Tab badge

                // Credit utilization
                if (this.totals.creditLimit > 0) {
                    this.updateElement('credit-utilization', this.totals.creditUtilization + '%');
                    const utilizationStatus = document.getElementById('utilization-status');
                    if (utilizationStatus) {
                        const util = this.totals.creditUtilization;
                        utilizationStatus.innerHTML = '<span>' +
                            (util < 30 ? 'Excellent' : util < 50 ? 'Good' : util < 75 ? 'Fair' : 'High') +
                            '</span>';
                    }
                }

                // Financial Health Score
                this.calculateHealthScore();
            },

            calculateHealthScore() {
                // Weighted scoring algorithm
                let score = 50; // Base score

                // Emergency fund (+/- 15 points)
                const monthsExpenses = this.totals.monthlyExpenses || 3000;
                const monthsCovered = this.totals.emergencyFund / monthsExpenses;
                if (monthsCovered >= 6) score += 15;
                else if (monthsCovered >= 3) score += 10;
                else if (monthsCovered >= 1) score += 5;
                else score -= 10;

                // Credit utilization (+/- 15 points)
                const util = this.totals.creditUtilization;
                if (util === 0) score += 10;
                else if (util < 10) score += 15;
                else if (util < 30) score += 10;
                else if (util < 50) score += 0;
                else if (util < 75) score -= 10;
                else score -= 15;

                // Net worth (+/- 10 points)
                if (this.totals.netWorth > 50000) score += 10;
                else if (this.totals.netWorth > 10000) score += 5;
                else if (this.totals.netWorth > 0) score += 0;
                else score -= 10;

                // Cash flow (+/- 10 points)
                const cashFlow = this.totals.monthlyIncome - this.totals.monthlyExpenses;
                if (cashFlow > 1000) score += 10;
                else if (cashFlow > 0) score += 5;
                else score -= 10;

                score = Math.max(0, Math.min(100, score));

                const healthEl = document.getElementById('health-score');
                const statusEl = document.getElementById('health-status');
                if (healthEl) {
                    healthEl.textContent = score;
                    healthEl.style.color = score >= 70 ? 'var(--success)' :
                                          score >= 50 ? 'var(--warning)' : 'var(--danger)';
                }
                if (statusEl) {
                    statusEl.textContent = score >= 80 ? 'Excellent' :
                                          score >= 70 ? 'Good' :
                                          score >= 50 ? 'Fair' : 'Needs Work';
                }
            },

            formatCurrency(amount) {
                return '$' + Math.abs(amount || 0).toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            },

            updateElement(id, value, className, isHtml) {
                const el = document.getElementById(id);
                if (el) {
                    if (isHtml) {
                        el.innerHTML = '<span>' + value + '</span>';
                    } else {
                        el.textContent = value;
                    }
                    if (className) {
                        el.classList.remove('positive', 'negative');
                        el.classList.add(className);
                    }
                }
            }
        };

        async function fetchFromSheet(endpoint, params = {}) {
            if (!API_CONFIG.apiUrl) {
                console.warn('API URL not configured - using demo data');
                return null;
            }

            try {
                const url = new URL(API_CONFIG.apiUrl);
                url.searchParams.append('action', endpoint);
                Object.entries(params).forEach(([key, value]) => {
                    url.searchParams.append(key, value);
                });

                const response = await fetch(url.toString());
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }

        async function saveToSheet(endpoint, data) {
            if (!API_CONFIG.apiUrl) {
                console.warn('API URL not configured');
                return false;
            }

            try {
                // Use text/plain to avoid CORS preflight
                const response = await fetch(API_CONFIG.apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: endpoint, data })
                });
                return await response.json();
            } catch (error) {
                console.error('Save Error:', error);
                return false;
            }
        }

        // =============================================
        // SMART WISHLIST SYSTEM
        // State-of-the-art purchase planning algorithm
        // =============================================
        const WishlistManager = {
            items: [],

            // Load wishlist from storage
            async load() {
                try {
                    const stored = localStorage.getItem('tsf_wishlist');
                    if (stored) {
                        this.items = JSON.parse(stored);
                    }
                    // Also try to load from API
                    const apiResult = await fetchFromSheet('getWishlist');
                    if (apiResult && apiResult.success && apiResult.items) {
                        this.items = apiResult.items;
                        localStorage.setItem('tsf_wishlist', JSON.stringify(this.items));
                    }
                    this.analyzeAndDisplay();
                } catch (e) {
                    console.error('Wishlist load error:', e);
                }
            },

            // Save wishlist to storage
            async save() {
                localStorage.setItem('tsf_wishlist', JSON.stringify(this.items));
                try {
                    await saveToSheet('saveWishlist', { items: this.items });
                } catch (e) {
                    console.warn('Could not save wishlist to API:', e);
                }
            },

            // Add new item
            add(item) {
                item.id = Date.now();
                item.createdAt = new Date().toISOString();
                item.status = 'analyzing';
                this.items.push(item);
                this.save();
                this.analyzeAndDisplay();
                showNotification('Item added to wishlist!', 'success');
            },

            // Remove item
            remove(id) {
                this.items = this.items.filter(item => item.id !== id);
                this.save();
                this.analyzeAndDisplay();
                showNotification('Item removed from wishlist', 'info');
            },

            // Mark as purchased
            markPurchased(id) {
                const item = this.items.find(i => i.id === id);
                if (item) {
                    item.purchasedAt = new Date().toISOString();
                    item.status = 'purchased';
                    this.save();
                    this.analyzeAndDisplay();
                    showNotification('Congrats on your purchase!', 'success');
                }
            },

            // ==========================================
            // SMART AFFORDABILITY ALGORITHM
            // Based on research: cash flow, emergency fund,
            // debt situation, seasonal patterns
            // ==========================================
            analyzeAffordability(item) {
                const cost = parseFloat(item.cost) || 0;
                const totals = FinancialState.totals;

                // Key financial metrics
                const availableCash = totals.cash || 0;
                const emergencyFund = totals.emergencyFund || 0;
                const monthlyExpenses = totals.monthlyExpenses || 3000;
                const monthlyIncome = totals.monthlyIncome || 0;
                const totalDebt = totals.debt || 0;
                const monthlyCashFlow = monthlyIncome - monthlyExpenses;

                // Calculate key ratios
                const emergencyMonths = monthlyExpenses > 0 ? emergencyFund / monthlyExpenses : 0;
                const debtToIncome = monthlyIncome > 0 ? (totalDebt / (monthlyIncome * 12)) * 100 : 100;
                const cashAfterPurchase = availableCash - cost;
                const emergencyAfterPurchase = Math.max(0, cashAfterPurchase - (monthlyExpenses * 3));

                // Score components (0-100 each)
                let scores = {
                    cashAvailable: 0,
                    emergencyProtected: 0,
                    debtSituation: 0,
                    cashFlowHealth: 0,
                    priority: 0
                };

                // 1. Cash Available Score (can we afford it without emergency fund?)
                if (cost <= availableCash - (monthlyExpenses * 6)) {
                    scores.cashAvailable = 100; // Have 6+ months buffer after purchase
                } else if (cost <= availableCash - (monthlyExpenses * 3)) {
                    scores.cashAvailable = 75; // Have 3-6 months buffer
                } else if (cost <= availableCash - monthlyExpenses) {
                    scores.cashAvailable = 50; // Have 1-3 months buffer
                } else if (cost <= availableCash) {
                    scores.cashAvailable = 25; // Can afford but depletes reserves
                } else {
                    scores.cashAvailable = 0; // Can't afford outright
                }

                // 2. Emergency Fund Protection Score
                if (emergencyMonths >= 6 && cashAfterPurchase >= monthlyExpenses * 3) {
                    scores.emergencyProtected = 100;
                } else if (emergencyMonths >= 3 && cashAfterPurchase >= monthlyExpenses * 2) {
                    scores.emergencyProtected = 75;
                } else if (emergencyMonths >= 1) {
                    scores.emergencyProtected = 50;
                } else {
                    scores.emergencyProtected = 25;
                }

                // 3. Debt Situation Score (lower debt = higher score)
                if (totalDebt === 0) {
                    scores.debtSituation = 100;
                } else if (debtToIncome < 20) {
                    scores.debtSituation = 85;
                } else if (debtToIncome < 35) {
                    scores.debtSituation = 60;
                } else if (debtToIncome < 50) {
                    scores.debtSituation = 35;
                } else {
                    scores.debtSituation = 15;
                }

                // 4. Cash Flow Health Score
                if (monthlyCashFlow >= cost * 0.2) {
                    scores.cashFlowHealth = 100; // Could save for it in 5 months
                } else if (monthlyCashFlow >= cost * 0.1) {
                    scores.cashFlowHealth = 75; // Could save in 10 months
                } else if (monthlyCashFlow > 0) {
                    scores.cashFlowHealth = 50;
                } else {
                    scores.cashFlowHealth = 20;
                }

                // 5. Priority adjustment
                scores.priority = item.priority === 'high' ? 20 : item.priority === 'medium' ? 10 : 0;

                // Weighted total (weights based on financial research)
                const weights = {
                    cashAvailable: 0.30,
                    emergencyProtected: 0.25,
                    debtSituation: 0.20,
                    cashFlowHealth: 0.15,
                    priority: 0.10
                };

                const totalScore = Object.keys(scores).reduce((sum, key) => {
                    return sum + (scores[key] * weights[key]);
                }, 0);

                // Determine status and recommendation
                let status, statusClass, recommendation, safeDate;

                if (totalScore >= 75) {
                    status = 'Safe to Buy';
                    statusClass = 'safe';
                    recommendation = this.getRecommendation(item, 'safe', { scores, totals, cost });
                } else if (totalScore >= 50) {
                    status = 'Wait - Almost Ready';
                    statusClass = 'wait';
                    const monthsToSave = monthlyCashFlow > 0 ?
                        Math.ceil((cost - (availableCash - monthlyExpenses * 3)) / monthlyCashFlow) : 12;
                    safeDate = new Date();
                    safeDate.setMonth(safeDate.getMonth() + Math.max(1, monthsToSave));
                    recommendation = this.getRecommendation(item, 'wait', { scores, totals, cost, monthsToSave });
                } else {
                    status = 'Not Yet - Focus on Fundamentals';
                    statusClass = 'not-ready';
                    recommendation = this.getRecommendation(item, 'not-ready', { scores, totals, cost });
                }

                // Financing analysis
                let financeOption = null;
                if (item.method === 'finance' || (item.method === 'auto' && cost > 5000 && totalScore < 60)) {
                    financeOption = this.analyzeFinancing(cost, totals);
                }

                return {
                    score: Math.round(totalScore),
                    status,
                    statusClass,
                    recommendation,
                    safeDate,
                    scores,
                    financeOption,
                    canAffordCash: cost <= availableCash,
                    cashAfterPurchase,
                    monthsToSave: monthlyCashFlow > 0 ?
                        Math.ceil(cost / monthlyCashFlow) : null
                };
            },

            // Generate smart recommendations
            getRecommendation(item, status, context) {
                const { scores, totals, cost, monthsToSave } = context;

                if (status === 'safe') {
                    if (scores.debtSituation < 50 && totals.debt > 0) {
                        return `You can afford this, but consider: paying $${Math.round(cost * 0.3)} toward debt first would save you interest. Then buy in ~2 months.`;
                    }
                    if (item.method === 'auto' && cost > 2000) {
                        return `Safe to buy with cash. For items over $2K, check if the vendor offers 0% financing - keeps cash reserves higher.`;
                    }
                    return `Your finances support this purchase. Cash reserves and emergency fund remain healthy after buying.`;
                }

                if (status === 'wait') {
                    if (scores.emergencyProtected < 50) {
                        return `Build emergency fund to 3 months ($${Math.round(totals.monthlyExpenses * 3).toLocaleString()}) first. Then this purchase becomes safe. Est. ${monthsToSave || 3}+ months.`;
                    }
                    if (scores.debtSituation < 50) {
                        return `Pay down $${Math.round(totals.debt * 0.25).toLocaleString()} in debt first (25% reduction). This improves your financial health score significantly.`;
                    }
                    return `Almost there! Save for ${monthsToSave || 2} more months to maintain safe cash reserves. Target: $${Math.round(cost + totals.monthlyExpenses * 3).toLocaleString()} total cash.`;
                }

                // Not ready
                if (scores.cashAvailable < 25) {
                    return `Current cash ($${totals.cash.toLocaleString()}) isn't enough. Focus on building savings and paying down debt before big purchases.`;
                }
                if (scores.emergencyProtected < 25) {
                    return `Priority: Build emergency fund to at least 1 month ($${totals.monthlyExpenses.toLocaleString()}) before discretionary purchases.`;
                }
                return `Focus on financial fundamentals: emergency fund, debt payoff, positive cash flow. This purchase can wait.`;
            },

            // Analyze financing options
            analyzeFinancing(cost, totals) {
                const monthlyPayment = cost / 24; // 24-month estimate
                const canAffordPayment = monthlyPayment < (totals.monthlyIncome - totals.monthlyExpenses) * 0.3;

                return {
                    recommended: canAffordPayment && totals.debt < totals.monthlyIncome * 6,
                    monthlyPayment: Math.round(monthlyPayment),
                    advice: canAffordPayment ?
                        `Financing option: ~$${Math.round(monthlyPayment)}/month for 24 months. Only if 0% or very low interest.` :
                        `Financing not recommended - monthly payment would strain cash flow.`
                };
            },

            // Analyze all items and update display
            analyzeAndDisplay() {
                const container = document.getElementById('wishlist-items-container');
                if (!container) return;

                const activeItems = this.items.filter(i => i.status !== 'purchased');

                if (activeItems.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-gift" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p style="font-size: 1rem;">No wishlist items yet</p>
                            <p style="font-size: 0.85rem; margin-bottom: 1rem;">Track equipment, supplies, or big purchases you're planning</p>
                            <button class="btn btn-primary" onclick="openModal('addWishlistModal')">
                                <i class="fas fa-plus"></i> Add Your First Item
                            </button>
                        </div>
                    `;
                    this.updateSummary([], [], []);
                    return;
                }

                // Analyze each item
                const analyzed = activeItems.map(item => ({
                    ...item,
                    analysis: this.analyzeAffordability(item)
                }));

                // Sort by status (safe first) then priority
                analyzed.sort((a, b) => {
                    const statusOrder = { 'safe': 0, 'wait': 1, 'not-ready': 2 };
                    const statusDiff = statusOrder[a.analysis.statusClass] - statusOrder[b.analysis.statusClass];
                    if (statusDiff !== 0) return statusDiff;

                    const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });

                // Group by status
                const safe = analyzed.filter(i => i.analysis.statusClass === 'safe');
                const waiting = analyzed.filter(i => i.analysis.statusClass === 'wait');
                const notReady = analyzed.filter(i => i.analysis.statusClass === 'not-ready');

                this.updateSummary(safe, waiting, notReady);

                // Render items
                container.innerHTML = analyzed.map(item => this.renderItem(item)).join('');
            },

            updateSummary(safe, waiting, notReady) {
                const readyEl = document.getElementById('wishlist-ready');
                const waitingEl = document.getElementById('wishlist-waiting');
                const notReadyEl = document.getElementById('wishlist-not-ready');
                const totalEl = document.getElementById('wishlist-total-value');
                const countEl = document.getElementById('wishlist-count');

                if (readyEl) readyEl.textContent = safe.length;
                if (waitingEl) waitingEl.textContent = waiting.length;
                if (notReadyEl) notReadyEl.textContent = notReady.length;

                const totalValue = [...safe, ...waiting, ...notReady].reduce((sum, i) => sum + (parseFloat(i.cost) || 0), 0);
                if (totalEl) totalEl.textContent = '$' + totalValue.toLocaleString();
                if (countEl) countEl.textContent = (safe.length + waiting.length + notReady.length) + ' items';
            },

            renderItem(item) {
                const a = item.analysis;
                const categoryIcons = {
                    'equipment': 'fa-tractor',
                    'vehicle': 'fa-truck',
                    'infrastructure': 'fa-warehouse',
                    'tools': 'fa-tools',
                    'technology': 'fa-laptop',
                    'supplies': 'fa-box',
                    'other': 'fa-cube'
                };

                const safeDateStr = a.safeDate ?
                    a.safeDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : null;

                return `
                    <div class="wishlist-card ${a.statusClass}">
                        <div class="wishlist-header">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <i class="fas ${categoryIcons[item.category] || 'fa-cube'}" style="color: var(--purple);"></i>
                                    <span class="wishlist-name">${item.name}</span>
                                    <span class="priority-badge ${item.priority}">${item.priority}</span>
                                </div>
                                <div class="wishlist-category">${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</div>
                            </div>
                            <div class="wishlist-price">$${parseFloat(item.cost).toLocaleString()}</div>
                        </div>

                        <div class="wishlist-status ${a.statusClass}">
                            <i class="fas ${a.statusClass === 'safe' ? 'fa-check-circle' : a.statusClass === 'wait' ? 'fa-clock' : 'fa-exclamation-triangle'}"></i>
                            ${a.status}
                            ${safeDateStr ? `<span style="font-weight: 400; margin-left: 0.5rem;">(Est. ${safeDateStr})</span>` : ''}
                        </div>

                        <div class="wishlist-recommendation">
                            <i class="fas fa-lightbulb" style="color: var(--gold);"></i>
                            ${a.recommendation}
                        </div>

                        <div class="wishlist-details">
                            <div class="wishlist-detail">
                                <div class="wishlist-detail-label">Affordability Score</div>
                                <div class="wishlist-detail-value" style="color: ${a.score >= 75 ? 'var(--success)' : a.score >= 50 ? 'var(--warning)' : 'var(--danger)'};">
                                    ${a.score}/100
                                </div>
                            </div>
                            <div class="wishlist-detail">
                                <div class="wishlist-detail-label">Cash After Purchase</div>
                                <div class="wishlist-detail-value" style="color: ${a.cashAfterPurchase > 0 ? 'var(--success)' : 'var(--danger)'};">
                                    $${Math.max(0, a.cashAfterPurchase).toLocaleString()}
                                </div>
                            </div>
                            <div class="wishlist-detail">
                                <div class="wishlist-detail-label">Months to Save</div>
                                <div class="wishlist-detail-value">
                                    ${a.monthsToSave !== null ? a.monthsToSave + ' mo' : '--'}
                                </div>
                            </div>
                            <div class="wishlist-detail">
                                <div class="wishlist-detail-label">Actions</div>
                                <div style="display: flex; gap: 0.5rem;">
                                    ${a.statusClass === 'safe' ? `
                                        <button class="btn btn-success btn-sm" onclick="WishlistManager.markPurchased(${item.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                            <i class="fas fa-check"></i> Bought
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-secondary btn-sm" onclick="WishlistManager.remove(${item.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        ${a.financeOption ? `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(67, 97, 238, 0.1); border-radius: 8px; font-size: 0.85rem;">
                                <i class="fas fa-credit-card" style="color: var(--info); margin-right: 0.5rem;"></i>
                                ${a.financeOption.advice}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        };

        // Save wishlist item from modal
        function saveWishlistItem() {
            const name = document.getElementById('wishlist-item-name').value.trim();
            const category = document.getElementById('wishlist-category').value;
            const cost = document.getElementById('wishlist-cost').value;
            const priority = document.getElementById('wishlist-priority').value;
            const method = document.getElementById('wishlist-method').value;
            const notes = document.getElementById('wishlist-notes').value.trim();
            const targetDate = document.getElementById('wishlist-target-date').value;

            if (!name || !cost) {
                showNotification('Please enter item name and cost', 'error');
                return;
            }

            WishlistManager.add({
                name,
                category,
                cost: parseFloat(cost),
                priority,
                method,
                notes,
                targetDate
            });

            closeModal('addWishlistModal');

            // Clear form
            document.getElementById('wishlist-item-name').value = '';
            document.getElementById('wishlist-cost').value = '';
            document.getElementById('wishlist-notes').value = '';
            document.getElementById('wishlist-target-date').value = '';
        }

        // =============================================
        // PRESCRIPTIVE RECOMMENDATIONS ENGINE
        // Tells the owner exactly what to do today
        // =============================================
        const RecommendationsEngine = {
            generate() {
                const recommendations = [];
                const totals = FinancialState.totals;
                const monthlyExpenses = totals.monthlyExpenses || 3000;
                const emergencyMonths = totals.emergencyFund / monthlyExpenses;
                const cashFlow = totals.monthlyIncome - totals.monthlyExpenses;

                // 1. Emergency Fund Recommendations
                if (emergencyMonths < 1) {
                    recommendations.push({
                        type: 'danger',
                        icon: 'fa-exclamation-triangle',
                        title: 'Emergency Fund Critical',
                        desc: `You have less than 1 month of expenses saved. Transfer $${Math.round(monthlyExpenses * 0.1)} to savings today.`,
                        action: 'Transfer to Savings'
                    });
                } else if (emergencyMonths < 3) {
                    recommendations.push({
                        type: 'warning',
                        icon: 'fa-piggy-bank',
                        title: 'Build Emergency Fund',
                        desc: `Target: 3 months ($${(monthlyExpenses * 3).toLocaleString()}). You have ${emergencyMonths.toFixed(1)} months. Add $${Math.round((monthlyExpenses * 3 - totals.emergencyFund) / 3)} this month.`,
                        action: 'Set Up Auto-Transfer'
                    });
                }

                // 2. Debt Attack Recommendations
                if (totals.debt > 0) {
                    // Find highest APR debt from Plaid accounts
                    const creditCards = FinancialState.plaidAccounts.filter(a =>
                        (a.subtype || '').toLowerCase() === 'credit card'
                    );

                    if (creditCards.length > 0) {
                        const highestBalance = creditCards.reduce((max, card) =>
                            (card.balance_current || 0) > (max.balance_current || 0) ? card : max
                        );

                        if (highestBalance.balance_current > 0) {
                            recommendations.push({
                                type: 'warning',
                                icon: 'fa-fire',
                                title: 'Debt Destroyer: Extra Payment',
                                desc: `Pay extra $${Math.min(200, Math.round(cashFlow * 0.3))} to ${highestBalance.name || 'your highest-rate card'} today. Bi-weekly payments reduce interest.`,
                                action: 'Make Payment'
                            });
                        }
                    }

                    // 15/3 Rule reminder
                    const today = new Date().getDate();
                    if (today >= 10 && today <= 17) {
                        recommendations.push({
                            type: 'info',
                            icon: 'fa-calendar-check',
                            title: '15/3 Rule: First Payment Window',
                            desc: `Pay 15 days before your statement closes to reduce average daily balance and reported utilization.`,
                            action: 'Check Statement Dates'
                        });
                    }
                }

                // 3. Positive Cash Flow Recommendations
                if (cashFlow > 500) {
                    recommendations.push({
                        type: 'success',
                        icon: 'fa-chart-line',
                        title: 'Invest Your Surplus',
                        desc: `You have $${cashFlow.toLocaleString()} monthly surplus. Invest $${Math.round(cashFlow * 0.3)} in your wealth builder portfolio.`,
                        action: 'Open Investments'
                    });
                } else if (cashFlow < 0) {
                    recommendations.push({
                        type: 'danger',
                        icon: 'fa-exclamation-circle',
                        title: 'Negative Cash Flow Alert',
                        desc: `You're spending $${Math.abs(cashFlow).toLocaleString()} more than you earn. Review expenses immediately.`,
                        action: 'Review Transactions'
                    });
                }

                // 4. Wishlist Safe Purchases
                const safeItems = WishlistManager.items.filter(item => {
                    const analysis = WishlistManager.analyzeAffordability(item);
                    return analysis.statusClass === 'safe';
                });

                if (safeItems.length > 0) {
                    const topItem = safeItems[0];
                    recommendations.push({
                        type: 'success',
                        icon: 'fa-gift',
                        title: `Safe to Purchase: ${topItem.name}`,
                        desc: `Your finances support buying ${topItem.name} ($${parseFloat(topItem.cost).toLocaleString()}) while maintaining healthy reserves.`,
                        action: 'View Wishlist'
                    });
                }

                // 5. Credit Utilization
                if (totals.creditUtilization > 30) {
                    recommendations.push({
                        type: 'warning',
                        icon: 'fa-percentage',
                        title: 'High Credit Utilization',
                        desc: `Your utilization is ${totals.creditUtilization}%. Pay down $${Math.round(totals.creditUsed - totals.creditLimit * 0.3)} to get under 30% for better credit score.`,
                        action: 'Pay Down Cards'
                    });
                }

                // 6. Seasonal Farm Advice (based on current month)
                const month = new Date().getMonth();
                if (month >= 0 && month <= 2) { // Winter
                    recommendations.push({
                        type: 'info',
                        icon: 'fa-snowflake',
                        title: 'Winter Planning Season',
                        desc: `Slower income season. Focus on building reserves, planning spring purchases, and minimizing expenses.`,
                        action: null
                    });
                } else if (month >= 3 && month <= 5) { // Spring
                    recommendations.push({
                        type: 'info',
                        icon: 'fa-seedling',
                        title: 'Spring Investment Season',
                        desc: `Income ramping up. Good time to invest in equipment while cash flow improves. Consider CSA pre-sales.`,
                        action: null
                    });
                }

                this.display(recommendations);
                return recommendations;
            },

            display(recommendations) {
                const container = document.getElementById('recommendations-container');
                if (!container) return;

                if (recommendations.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 1rem;"></i>
                            <p>You're on track! No urgent actions needed today.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-card ${rec.type}">
                        <div class="recommendation-icon" style="color: var(--${rec.type === 'success' ? 'success' : rec.type === 'danger' ? 'danger' : rec.type === 'warning' ? 'warning' : 'info'});">
                            <i class="fas ${rec.icon}"></i>
                        </div>
                        <div class="recommendation-content">
                            <div class="recommendation-title">${rec.title}</div>
                            <div class="recommendation-desc">${rec.desc}</div>
                            ${rec.action ? `
                                <div class="recommendation-action">
                                    <button class="btn btn-sm ${rec.type === 'success' ? 'btn-success' : rec.type === 'danger' ? 'btn-danger' : 'btn-secondary'}">
                                        ${rec.action}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
        };

        function refreshRecommendations() {
            RecommendationsEngine.generate();
            showNotification('Recommendations updated', 'success');
        }

        // =============================================
        // ASSET TRACKING FOR LOAN APPLICATIONS
        // =============================================
        const AssetManager = {
            assets: [],

            async load() {
                try {
                    const stored = localStorage.getItem('tsf_assets');
                    if (stored) {
                        this.assets = JSON.parse(stored);
                    }
                    const apiResult = await fetchFromSheet('getAssets');
                    if (apiResult && apiResult.success && apiResult.assets) {
                        this.assets = apiResult.assets;
                        localStorage.setItem('tsf_assets', JSON.stringify(this.assets));
                    }
                } catch (e) {
                    console.error('Asset load error:', e);
                }
            },

            async save() {
                localStorage.setItem('tsf_assets', JSON.stringify(this.assets));
                try {
                    await saveToSheet('saveAssets', { assets: this.assets });
                } catch (e) {
                    console.warn('Could not save assets to API:', e);
                }
            },

            add(asset) {
                asset.id = Date.now();
                asset.createdAt = new Date().toISOString();
                this.assets.push(asset);
                this.save();
                showNotification('Asset added successfully!', 'success');
            },

            calculateDepreciation(asset) {
                if (!asset.purchaseDate || !asset.purchasePrice) return asset.currentValue || 0;

                const purchaseDate = new Date(asset.purchaseDate);
                const yearsOwned = (Date.now() - purchaseDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000);

                switch (asset.depreciation) {
                    case '5year':
                        // 5-year MACRS rates
                        const rates5 = [0.20, 0.32, 0.192, 0.1152, 0.1152, 0.0576];
                        return this.calculateMACRS(asset.purchasePrice, yearsOwned, rates5);
                    case '7year':
                        // 7-year MACRS rates
                        const rates7 = [0.1429, 0.2449, 0.1749, 0.1249, 0.0893, 0.0892, 0.0893, 0.0446];
                        return this.calculateMACRS(asset.purchasePrice, yearsOwned, rates7);
                    case 'straight':
                        // 10-year straight line
                        const depreciationPerYear = asset.purchasePrice / 10;
                        return Math.max(0, asset.purchasePrice - (depreciationPerYear * yearsOwned));
                    default:
                        return asset.currentValue || asset.purchasePrice;
                }
            },

            calculateMACRS(purchasePrice, yearsOwned, rates) {
                let totalDepreciation = 0;
                for (let i = 0; i < Math.floor(yearsOwned) && i < rates.length; i++) {
                    totalDepreciation += purchasePrice * rates[i];
                }
                return Math.max(0, purchasePrice - totalDepreciation);
            },

            generateAssetSchedule() {
                const schedule = {
                    equipment: { items: [], total: 0 },
                    vehicles: { items: [], total: 0 },
                    infrastructure: { items: [], total: 0 },
                    inventory: { items: [], total: 0 },
                    other: { items: [], total: 0 }
                };

                this.assets.forEach(asset => {
                    const depreciatedValue = this.calculateDepreciation(asset);
                    const category = asset.category === 'vehicle' ? 'vehicles' :
                                    asset.category === 'equipment' ? 'equipment' :
                                    asset.category === 'infrastructure' ? 'infrastructure' :
                                    asset.category === 'inventory' ? 'inventory' : 'other';

                    schedule[category].items.push({
                        name: asset.name,
                        purchasePrice: asset.purchasePrice,
                        currentValue: depreciatedValue,
                        purchaseDate: asset.purchaseDate,
                        serial: asset.serial,
                        condition: asset.condition
                    });
                    schedule[category].total += depreciatedValue;
                });

                const grandTotal = Object.values(schedule).reduce((sum, cat) => sum + cat.total, 0);

                return {
                    schedule,
                    grandTotal,
                    generatedAt: new Date().toISOString()
                };
            },

            generateBalanceSheet() {
                const assetSchedule = this.generateAssetSchedule();
                const totals = FinancialState.totals;

                return {
                    assets: {
                        cash: totals.cash,
                        investments: totals.investments,
                        equipment: assetSchedule.schedule.equipment.total,
                        vehicles: assetSchedule.schedule.vehicles.total,
                        infrastructure: assetSchedule.schedule.infrastructure.total,
                        inventory: assetSchedule.schedule.inventory.total,
                        other: assetSchedule.schedule.other.total,
                        total: totals.cash + totals.investments + assetSchedule.grandTotal
                    },
                    liabilities: {
                        creditCards: totals.creditUsed,
                        loans: totals.debt - totals.creditUsed,
                        total: totals.debt
                    },
                    equity: (totals.cash + totals.investments + assetSchedule.grandTotal) - totals.debt,
                    generatedAt: new Date().toISOString()
                };
            }
        };

        function saveAsset() {
            const name = document.getElementById('asset-name').value.trim();
            const category = document.getElementById('asset-category').value;
            const purchasePrice = document.getElementById('asset-purchase-price').value;
            const purchaseDate = document.getElementById('asset-purchase-date').value;
            const currentValue = document.getElementById('asset-current-value').value;
            const condition = document.getElementById('asset-condition').value;
            const serial = document.getElementById('asset-serial').value.trim();
            const location = document.getElementById('asset-location').value.trim();
            const depreciation = document.getElementById('asset-depreciation').value;

            if (!name || !purchasePrice) {
                showNotification('Please enter asset name and purchase price', 'error');
                return;
            }

            AssetManager.add({
                name,
                category,
                purchasePrice: parseFloat(purchasePrice),
                purchaseDate,
                currentValue: parseFloat(currentValue) || parseFloat(purchasePrice),
                condition,
                serial,
                location,
                depreciation
            });

            closeModal('addAssetModal');

            // Clear form
            document.getElementById('asset-name').value = '';
            document.getElementById('asset-purchase-price').value = '';
            document.getElementById('asset-current-value').value = '';
            document.getElementById('asset-serial').value = '';
            document.getElementById('asset-location').value = '';
        }

        // =============================================
        // BILL/RECEIPT OCR PROCESSING
        // AI-powered document parsing using Tesseract.js
        // =============================================
        const BillOCR = {
            bills: [],

            async load() {
                try {
                    const stored = localStorage.getItem('tsf_bills');
                    if (stored) {
                        this.bills = JSON.parse(stored);
                    }
                    const apiResult = await fetchFromSheet('getBills');
                    if (apiResult && apiResult.success && apiResult.bills) {
                        this.bills = apiResult.bills;
                        localStorage.setItem('tsf_bills', JSON.stringify(this.bills));
                    }
                    this.displayBills();
                } catch (e) {
                    console.error('Bills load error:', e);
                }
            },

            async save() {
                localStorage.setItem('tsf_bills', JSON.stringify(this.bills));
                try {
                    await saveToSheet('saveBills', { bills: this.bills });
                } catch (e) {
                    console.warn('Could not save bills to API:', e);
                }
            },

            add(bill) {
                bill.id = Date.now();
                bill.createdAt = new Date().toISOString();
                this.bills.push(bill);
                this.save();
                this.displayBills();
            },

            displayBills() {
                const tbody = document.getElementById('bills-table-body');
                if (!tbody) return;

                const upcomingBills = this.bills
                    .filter(b => !b.paid)
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                if (upcomingBills.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <i class="fas fa-file-invoice" style="margin-right: 0.5rem;"></i>
                                No bills added yet. Click "Scan Bill" to upload and auto-parse.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = upcomingBills.map(bill => {
                    const dueDate = new Date(bill.dueDate);
                    const today = new Date();
                    const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    let statusClass = 'success';
                    let statusText = 'Upcoming';

                    if (daysUntilDue < 0) {
                        statusClass = 'danger';
                        statusText = 'Overdue!';
                    } else if (daysUntilDue <= 3) {
                        statusClass = 'warning';
                        statusText = 'Due Soon';
                    }

                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 500;">${bill.vendor}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${bill.category}</div>
                            </td>
                            <td>
                                <div>${dueDate.toLocaleDateString()}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${daysUntilDue >= 0 ? daysUntilDue + ' days' : Math.abs(daysUntilDue) + ' days ago'}</div>
                            </td>
                            <td style="font-weight: 600;">$${parseFloat(bill.amount).toLocaleString()}</td>
                            <td>
                                <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; background: var(--${statusClass}); color: white;">
                                    ${statusText}
                                </span>
                                <button onclick="BillOCR.markPaid(${bill.id})" style="margin-left: 0.5rem; background: none; border: none; color: var(--success); cursor: pointer;" title="Mark as Paid">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            markPaid(id) {
                const bill = this.bills.find(b => b.id === id);
                if (bill) {
                    bill.paid = true;
                    bill.paidAt = new Date().toISOString();
                    this.save();
                    this.displayBills();
                    showNotification('Bill marked as paid!', 'success');
                }
            },

            // Extract data from image using AI patterns
            async extractFromImage(imageData) {
                // For production, this would call Google Cloud Vision API or Tesseract.js
                // For now, we'll use smart pattern matching on any text we can extract

                return new Promise((resolve) => {
                    // Simulate OCR processing time
                    setTimeout(() => {
                        // In production: Use Tesseract.js or Google Cloud Vision
                        // For demo, return placeholder that user can edit
                        resolve({
                            vendor: '',
                            amount: '',
                            dueDate: '',
                            accountNumber: '',
                            confidence: 0
                        });
                    }, 1500);
                });
            },

            // Smart pattern extraction from OCR text
            parseExtractedText(text) {
                const result = {
                    vendor: '',
                    amount: '',
                    dueDate: '',
                    accountNumber: '',
                    category: 'other'
                };

                // Extract amounts (look for dollar signs and numbers)
                const amountMatches = text.match(/\$[\d,]+\.?\d{0,2}|\d+\.\d{2}(?=\s|$)/g);
                if (amountMatches && amountMatches.length > 0) {
                    // Get the largest amount (usually the total due)
                    const amounts = amountMatches.map(a => parseFloat(a.replace(/[$,]/g, '')));
                    result.amount = Math.max(...amounts).toFixed(2);
                }

                // Extract dates
                const datePatterns = [
                    /(?:due|by|before)\s*:?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i,
                    /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/,
                    /(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\w*\s+\d{1,2},?\s*\d{4}/i
                ];
                for (const pattern of datePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const parsed = new Date(match[1] || match[0]);
                        if (!isNaN(parsed)) {
                            result.dueDate = parsed.toISOString().split('T')[0];
                            break;
                        }
                    }
                }

                // Extract account number patterns
                const accountMatch = text.match(/(?:account|acct|a\/c)[\s#:]*(\d{4,})/i);
                if (accountMatch) {
                    result.accountNumber = accountMatch[1];
                }

                // Detect vendor/category from common keywords
                const lowerText = text.toLowerCase();
                if (lowerText.includes('electric') || lowerText.includes('power') || lowerText.includes('energy')) {
                    result.category = 'utility';
                    result.vendor = result.vendor || 'Electric Company';
                } else if (lowerText.includes('water') || lowerText.includes('sewer')) {
                    result.category = 'utility';
                    result.vendor = result.vendor || 'Water Utility';
                } else if (lowerText.includes('gas') && !lowerText.includes('gasoline')) {
                    result.category = 'utility';
                    result.vendor = result.vendor || 'Gas Company';
                } else if (lowerText.includes('insurance')) {
                    result.category = 'insurance';
                } else if (lowerText.includes('rent') || lowerText.includes('lease')) {
                    result.category = 'rent';
                } else if (lowerText.includes('internet') || lowerText.includes('phone') || lowerText.includes('mobile')) {
                    result.category = 'subscription';
                }

                return result;
            }
        };

        // Handle bill image upload
        async function handleBillImageUpload(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];

            // Show processing state
            document.getElementById('bill-upload-area').style.display = 'none';
            document.getElementById('bill-processing').style.display = 'block';

            try {
                // Read the file
                const reader = new FileReader();
                reader.onload = async (e) => {
                    // In production, send to Google Cloud Vision API or process with Tesseract.js
                    // For now, show the form for manual entry with helpful prompts
                    const extracted = await BillOCR.extractFromImage(e.target.result);

                    // Show extracted data form
                    document.getElementById('bill-processing').style.display = 'none';
                    document.getElementById('bill-extracted-data').style.display = 'block';
                    document.getElementById('saveBillBtn').style.display = 'inline-flex';

                    // Populate fields if we extracted data
                    if (extracted.vendor) document.getElementById('extracted-vendor').value = extracted.vendor;
                    if (extracted.amount) document.getElementById('extracted-amount').value = extracted.amount;
                    if (extracted.dueDate) document.getElementById('extracted-due-date').value = extracted.dueDate;
                    if (extracted.accountNumber) document.getElementById('extracted-account-number').value = extracted.accountNumber;
                    if (extracted.category) document.getElementById('extracted-category').value = extracted.category;
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Bill upload error:', error);
                showNotification('Error processing bill image', 'error');
                resetBillUpload();
            }
        }

        // Reset bill upload modal
        function resetBillUpload() {
            document.getElementById('bill-upload-area').style.display = 'block';
            document.getElementById('bill-processing').style.display = 'none';
            document.getElementById('bill-extracted-data').style.display = 'none';
            document.getElementById('saveBillBtn').style.display = 'none';

            // Clear form
            document.getElementById('extracted-vendor').value = '';
            document.getElementById('extracted-amount').value = '';
            document.getElementById('extracted-due-date').value = '';
            document.getElementById('extracted-account-number').value = '';
            document.getElementById('extracted-recurring').checked = false;
            document.getElementById('billImageUpload').value = '';
        }

        // Save extracted bill
        function saveExtractedBill() {
            const vendor = document.getElementById('extracted-vendor').value.trim();
            const amount = document.getElementById('extracted-amount').value;
            const dueDate = document.getElementById('extracted-due-date').value;
            const accountNumber = document.getElementById('extracted-account-number').value.trim();
            const category = document.getElementById('extracted-category').value;
            const isRecurring = document.getElementById('extracted-recurring').checked;

            if (!vendor || !amount || !dueDate) {
                showNotification('Please enter vendor, amount, and due date', 'error');
                return;
            }

            BillOCR.add({
                vendor,
                amount: parseFloat(amount),
                dueDate,
                accountNumber,
                category,
                isRecurring,
                paid: false
            });

            closeModal('uploadBillModal');
            resetBillUpload();
            showNotification('Bill added successfully!', 'success');
        }

        // Handle receipt upload
        async function handleReceiptUpload(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            showNotification('Receipt uploaded! Processing...', 'info');

            // In production, this would process the receipt via OCR
            // For now, show a success message and prompt to categorize
            setTimeout(() => {
                showNotification('Receipt captured! Add to expenses manually for now.', 'success');
            }, 1000);
        }

        // Open camera capture
        function openCameraCapture(type) {
            // On mobile, this will open the camera
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // Use rear camera

            input.onchange = (e) => {
                if (type === 'bill') {
                    handleBillImageUpload(input);
                } else {
                    handleReceiptUpload(input);
                }
            };

            input.click();
        }

        function openReceiptCapture(mode) {
            if (mode === 'camera') {
                openCameraCapture('receipt');
            } else {
                document.getElementById('receiptUploadInput').click();
            }
        }

        // =============================================
        // ALPACA INVESTMENT INTEGRATION
        // Commission-free automated investing
        // =============================================
        const AlpacaManager = {
            config: null,

            async load() {
                try {
                    const stored = localStorage.getItem('tsf_alpaca_config');
                    if (stored) {
                        this.config = JSON.parse(stored);
                        this.updateUI();
                    }
                    // Also try API
                    const apiResult = await fetchFromSheet('getAlpacaConfig');
                    if (apiResult && apiResult.success && apiResult.config) {
                        this.config = apiResult.config;
                        localStorage.setItem('tsf_alpaca_config', JSON.stringify(this.config));
                        this.updateUI();
                    }
                } catch (e) {
                    console.error('Alpaca config load error:', e);
                }
            },

            async save() {
                localStorage.setItem('tsf_alpaca_config', JSON.stringify(this.config));
                try {
                    await saveToSheet('saveAlpacaConfig', { config: this.config });
                } catch (e) {
                    console.warn('Could not save Alpaca config to API:', e);
                }
            },

            updateUI() {
                const statusEl = document.getElementById('alpaca-status');
                const setupCard = document.getElementById('alpaca-setup-card');
                const connectBtn = document.getElementById('connectAlpacaBtn');

                if (this.config && this.config.connected) {
                    if (statusEl) {
                        statusEl.textContent = 'Connected';
                        statusEl.style.background = 'var(--success)';
                    }
                    if (connectBtn) {
                        connectBtn.innerHTML = '<i class="fas fa-cog"></i> Configure';
                    }
                } else {
                    if (statusEl) {
                        statusEl.textContent = 'Not Connected';
                        statusEl.style.background = 'var(--text-secondary)';
                    }
                }
            },

            // Calculate 75/25 allocation for a given amount
            calculateAllocation(amount) {
                const safeAmount = amount * 0.75;
                const growthAmount = amount * 0.25;

                // Safe allocation breakdown
                const safe = {
                    VTI: safeAmount * 0.267,   // 20% of total
                    VXUS: safeAmount * 0.133,  // 10% of total
                    BND: safeAmount * 0.267,   // 20% of total
                    VTIP: safeAmount * 0.200,  // 15% of total
                    SHY: safeAmount * 0.133    // 10% of total
                };

                // Growth allocation (Dual Momentum - current signal)
                const growth = {
                    signal: this.calculateMomentumSignal(),
                    amount: growthAmount
                };

                return { safe, growth, total: amount };
            },

            // Dual Momentum signal calculation
            calculateMomentumSignal() {
                // In production, this would fetch real market data
                // For now, return a reasonable default
                const signals = ['VTI', 'VXUS', 'BND'];
                const signalEl = document.getElementById('momentum-signal');

                // Default to VTI (US stocks) as it's been strong
                const currentSignal = 'VTI (US Stocks)';
                if (signalEl) {
                    signalEl.textContent = currentSignal;
                    signalEl.style.color = 'var(--success)';
                }

                return 'VTI';
            }
        };

        // Connect Alpaca account
        async function connectAlpaca() {
            const apiKey = document.getElementById('alpaca-api-key').value.trim();
            const secretKey = document.getElementById('alpaca-secret-key').value.trim();
            const accountType = document.getElementById('alpaca-account-type').value;
            const monthlyAmount = document.getElementById('alpaca-monthly-amount').value;
            const roundupThreshold = document.getElementById('alpaca-roundup-threshold').value;
            const strategy = document.getElementById('alpaca-strategy').value;
            const seasonal = document.getElementById('alpaca-seasonal').checked;

            if (!apiKey || !secretKey) {
                showNotification('Please enter API Key and Secret Key', 'error');
                return;
            }

            // Save configuration
            AlpacaManager.config = {
                apiKey: apiKey.substring(0, 4) + '****', // Don't store full key
                hasSecret: true,
                accountType,
                monthlyAmount: parseFloat(monthlyAmount) || 200,
                roundupThreshold: parseInt(roundupThreshold),
                strategy,
                seasonal,
                connected: true,
                connectedAt: new Date().toISOString()
            };

            // In production, send to server to store encrypted keys
            await AlpacaManager.save();
            AlpacaManager.updateUI();

            closeModal('alpacaSetupModal');
            showNotification('Alpaca account connected! Auto-invest is now active.', 'success');
        }

        // =============================================
        // CUSTOMER PAYMENT PLANS
        // In-house financing for CSA and large orders
        // =============================================
        const PaymentPlanManager = {
            plans: [],

            async load() {
                try {
                    const stored = localStorage.getItem('tsf_payment_plans');
                    if (stored) {
                        this.plans = JSON.parse(stored);
                    }
                    const apiResult = await fetchFromSheet('getPaymentPlans');
                    if (apiResult && apiResult.success && apiResult.plans) {
                        this.plans = apiResult.plans;
                        localStorage.setItem('tsf_payment_plans', JSON.stringify(this.plans));
                    }
                } catch (e) {
                    console.error('Payment plans load error:', e);
                }
            },

            async save() {
                localStorage.setItem('tsf_payment_plans', JSON.stringify(this.plans));
                try {
                    await saveToSheet('savePaymentPlans', { plans: this.plans });
                } catch (e) {
                    console.warn('Could not save payment plans to API:', e);
                }
            },

            add(plan) {
                plan.id = Date.now();
                plan.createdAt = new Date().toISOString();
                plan.status = 'active';
                plan.payments = this.generatePaymentSchedule(plan);
                this.plans.push(plan);
                this.save();
                return plan;
            },

            generatePaymentSchedule(plan) {
                const payments = [];
                const downPayment = plan.totalAmount * (plan.downPaymentPercent / 100);
                const remaining = plan.totalAmount - downPayment;
                const interest = remaining * (plan.interestRate / 100);
                const totalWithInterest = remaining + interest;
                const installmentAmount = totalWithInterest / plan.installments;

                // Down payment (due now)
                if (downPayment > 0) {
                    payments.push({
                        number: 0,
                        type: 'down_payment',
                        amount: Math.round(downPayment * 100) / 100,
                        dueDate: new Date().toISOString().split('T')[0],
                        paid: false
                    });
                }

                // Installments
                const startDate = new Date();
                for (let i = 1; i <= plan.installments; i++) {
                    startDate.setMonth(startDate.getMonth() + 1);
                    payments.push({
                        number: i,
                        type: 'installment',
                        amount: Math.round(installmentAmount * 100) / 100,
                        dueDate: startDate.toISOString().split('T')[0],
                        paid: false
                    });
                }

                return payments;
            },

            getOverduePayments() {
                const today = new Date();
                const overdue = [];

                this.plans.forEach(plan => {
                    if (plan.status !== 'active') return;
                    plan.payments.forEach(payment => {
                        if (!payment.paid && new Date(payment.dueDate) < today) {
                            overdue.push({
                                planId: plan.id,
                                customer: plan.customerName,
                                email: plan.customerEmail,
                                payment
                            });
                        }
                    });
                });

                return overdue;
            },

            recordPayment(planId, paymentNumber) {
                const plan = this.plans.find(p => p.id === planId);
                if (!plan) return;

                const payment = plan.payments.find(p => p.number === paymentNumber);
                if (payment) {
                    payment.paid = true;
                    payment.paidAt = new Date().toISOString();

                    // Check if plan is complete
                    if (plan.payments.every(p => p.paid)) {
                        plan.status = 'completed';
                        plan.completedAt = new Date().toISOString();
                    }

                    this.save();
                    showNotification('Payment recorded!', 'success');
                }
            }
        };

        // Create payment plan from modal
        function createPaymentPlan() {
            const customerName = document.getElementById('plan-customer-name').value.trim();
            const customerEmail = document.getElementById('plan-customer-email').value.trim();
            const totalAmount = parseFloat(document.getElementById('plan-total-amount').value);
            const downPaymentPercent = parseInt(document.getElementById('plan-down-payment').value);
            const installments = parseInt(document.getElementById('plan-installments').value);
            const interestRate = parseInt(document.getElementById('plan-interest').value);
            const planType = document.getElementById('plan-type').value;
            const finalDueDate = document.getElementById('plan-due-date').value;

            if (!customerName || !customerEmail || !totalAmount) {
                showNotification('Please enter customer name, email, and amount', 'error');
                return;
            }

            const plan = PaymentPlanManager.add({
                customerName,
                customerEmail,
                totalAmount,
                downPaymentPercent,
                installments,
                interestRate,
                planType,
                finalDueDate
            });

            closeModal('paymentPlanModal');
            showNotification(`Payment plan created for ${customerName}!`, 'success');

            // Clear form
            document.getElementById('plan-customer-name').value = '';
            document.getElementById('plan-customer-email').value = '';
            document.getElementById('plan-total-amount').value = '';
        }

        // Update payment preview when amount changes
        function updatePaymentPreview() {
            const totalAmount = parseFloat(document.getElementById('plan-total-amount').value) || 0;
            const downPaymentPercent = parseInt(document.getElementById('plan-down-payment').value) || 0;
            const installments = parseInt(document.getElementById('plan-installments').value) || 4;
            const interestRate = parseInt(document.getElementById('plan-interest').value) || 0;

            const preview = document.getElementById('payment-preview');
            if (!preview) return;

            if (totalAmount === 0) {
                preview.innerHTML = 'Enter amount to see payment breakdown';
                return;
            }

            const downPayment = totalAmount * (downPaymentPercent / 100);
            const remaining = totalAmount - downPayment;
            const interest = remaining * (interestRate / 100);
            const totalWithInterest = remaining + interest;
            const installmentAmount = totalWithInterest / installments;

            preview.innerHTML = `
                <div style="margin-bottom: 0.5rem;">
                    <strong>Down Payment:</strong> $${downPayment.toFixed(2)} (due now)
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>${installments} Installments:</strong> $${installmentAmount.toFixed(2)} each
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Interest:</strong> $${interest.toFixed(2)} (${interestRate}%)
                </div>
                <div style="font-weight: 700; color: var(--text-primary);">
                    <strong>Customer Total:</strong> $${(totalAmount + interest).toFixed(2)}
                </div>
            `;
        }

        // Add event listeners for payment preview
        document.addEventListener('DOMContentLoaded', () => {
            ['plan-total-amount', 'plan-down-payment', 'plan-installments', 'plan-interest'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', updatePaymentPreview);
                    el.addEventListener('input', updatePaymentPreview);
                }
            });
        });

        // =============================================
        // DEBT PAYOFF CALCULATOR
        // =============================================
        class DebtPayoffCalculator {
            constructor(debts, extraPayment = 0) {
                this.debts = debts.map(d => ({ ...d })); // Clone
                this.extraPayment = extraPayment;
            }

            avalanche() {
                // Sort by interest rate (highest first)
                return this.debts.sort((a, b) => b.apr - a.apr);
            }

            snowball() {
                // Sort by balance (lowest first)
                return this.debts.sort((a, b) => a.balance - b.balance);
            }

            calculatePayoff(strategy = 'avalanche') {
                const sortedDebts = strategy === 'avalanche' ? this.avalanche() : this.snowball();
                const timeline = [];
                let currentMonth = new Date();
                let totalInterestPaid = 0;

                // Clone debts for calculation
                let remaining = sortedDebts.map(d => ({ ...d }));

                while (remaining.length > 0) {
                    // Apply minimum payments to all debts
                    remaining.forEach(debt => {
                        const monthlyInterest = debt.balance * (debt.apr / 100 / 12);
                        totalInterestPaid += monthlyInterest;
                        debt.balance += monthlyInterest - debt.minPayment;
                    });

                    // Apply extra payment to first debt
                    if (remaining.length > 0) {
                        remaining[0].balance -= this.extraPayment;
                    }

                    // Check for paid off debts
                    remaining = remaining.filter(debt => {
                        if (debt.balance <= 0) {
                            timeline.push({
                                name: debt.name,
                                paidOffDate: new Date(currentMonth),
                                originalBalance: debt.originalBalance
                            });
                            // Roll over freed-up payment
                            this.extraPayment += debt.minPayment;
                            return false;
                        }
                        return true;
                    });

                    currentMonth.setMonth(currentMonth.getMonth() + 1);

                    // Safety: prevent infinite loop
                    if (currentMonth.getFullYear() > 2040) break;
                }

                return {
                    timeline,
                    totalInterestPaid: Math.round(totalInterestPaid * 100) / 100,
                    debtFreeDate: timeline[timeline.length - 1]?.paidOffDate
                };
            }
        }

        // =============================================
        // PLAID BANK CONNECTION
        // =============================================
        let plaidHandler = null;

        async function connectBankWithPlaid() {
            const btn = document.getElementById('plaidConnectBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            btn.disabled = true;

            try {
                // Get link token from our Apps Script backend
                const response = await fetchFromSheet('createPlaidLinkToken');

                if (!response || !response.success) {
                    throw new Error(response?.error || 'Failed to create link token');
                }

                // Initialize Plaid Link
                plaidHandler = Plaid.create({
                    token: response.linkToken,
                    onSuccess: async (publicToken, metadata) => {
                        console.log('Plaid Link Success!', metadata);
                        await handlePlaidSuccess(publicToken, metadata);
                    },
                    onExit: (err, metadata) => {
                        console.log('Plaid Link Exit', err, metadata);
                        btn.innerHTML = '<i class="fas fa-link"></i> Connect Bank';
                        btn.disabled = false;
                        if (err) {
                            showNotification('Bank connection cancelled', 'warning');
                        }
                    },
                    onEvent: (eventName, metadata) => {
                        console.log('Plaid Event:', eventName, metadata);
                        if (eventName === 'ERROR') {
                            console.error('PLAID ERROR DETAILS:', JSON.stringify(metadata, null, 2));
                            showNotification('Plaid Error: ' + (metadata.error_message || metadata.error_code || 'Unknown error'), 'error');
                        }
                    }
                });

                // Open Plaid Link
                plaidHandler.open();

            } catch (error) {
                console.error('Plaid Error:', error);
                showNotification('Failed to connect: ' + error.message, 'error');
                btn.innerHTML = '<i class="fas fa-link"></i> Connect Bank';
                btn.disabled = false;
            }
        }

        async function handlePlaidSuccess(publicToken, metadata) {
            const btn = document.getElementById('plaidConnectBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing accounts...';

            try {
                // Exchange public token via GET to avoid CORS preflight
                const params = new URLSearchParams({
                    action: 'exchangePlaidPublicToken',
                    publicToken: publicToken,
                    institutionId: metadata.institution.institution_id,
                    institutionName: metadata.institution.name,
                    accounts: JSON.stringify(metadata.accounts)
                });

                const response = await fetch(`${API_CONFIG.apiUrl}?${params.toString()}`);
                const exchangeResult = await response.json();

                if (!exchangeResult || !exchangeResult.success) {
                    throw new Error(exchangeResult?.error || 'Failed to exchange token');
                }

                showNotification(`Connected to ${metadata.institution.name}!`, 'success');

                // Refresh the accounts and transactions display
                await loadConnectedAccounts();
                await loadTransactionsAndAnalyze();

                btn.innerHTML = '<i class="fas fa-link"></i> Connect Bank';
                btn.disabled = false;

            } catch (error) {
                console.error('Token Exchange Error:', error);
                showNotification('Failed to save connection: ' + error.message, 'error');
                btn.innerHTML = '<i class="fas fa-link"></i> Connect Bank';
                btn.disabled = false;
            }
        }

        async function loadConnectedAccounts() {
            try {
                const accounts = await fetchFromSheet('getPlaidAccounts');

                if (accounts && accounts.success && accounts.accounts && accounts.accounts.length > 0) {
                    // Feed data to unified state manager
                    FinancialState.update('plaidAccounts', accounts.accounts);
                    displayPlaidAccounts(accounts.accounts);
                } else {
                    FinancialState.update('plaidAccounts', []);
                    showNoAccountsMessage();
                }
            } catch (error) {
                console.error('Failed to load accounts:', error);
                showNoAccountsMessage();
            }
        }

        function showNoAccountsMessage() {
            const netWorthEl = document.getElementById('total-net-worth');
            const assetsEl = document.getElementById('total-assets');
            const debtEl = document.getElementById('total-debt');

            if (netWorthEl) {
                netWorthEl.innerHTML = '<a href="#" onclick="showTab(\'banking\'); return false;" style="color: var(--primary); text-decoration: underline; cursor: pointer;">Connect bank accounts</a>';
            }
            if (assetsEl) assetsEl.textContent = '--';
            if (debtEl) debtEl.textContent = '--';
        }

        function displayPlaidAccounts(accounts) {
            const cardBody = document.querySelector('.card:has(.fa-university) .card-body');
            if (!cardBody) return;

            // Find or create the connected accounts section
            let connectedSection = document.getElementById('plaidAccountsSection');
            if (!connectedSection) {
                connectedSection = document.createElement('div');
                connectedSection.id = 'plaidAccountsSection';
                connectedSection.innerHTML = '<h4 style="margin: 1rem 0 0.5rem; font-size: 0.85rem; color: var(--text-secondary);"><i class="fas fa-check-circle" style="color: var(--success);"></i> Connected via Plaid</h4>';
                cardBody.insertBefore(connectedSection, cardBody.firstChild);
            }

            // Clear existing accounts (except header)
            const header = connectedSection.querySelector('h4');
            connectedSection.innerHTML = '';
            connectedSection.appendChild(header);

            // Add each account
            accounts.forEach(account => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'account-card ' + (account.subtype || 'checking');

                const iconMap = {
                    'checking': 'fa-money-check-alt',
                    'savings': 'fa-piggy-bank',
                    'credit card': 'fa-credit-card',
                    'loan': 'fa-file-invoice-dollar',
                    'investment': 'fa-chart-line'
                };
                const icon = iconMap[account.subtype] || 'fa-university';
                const iconColor = account.subtype === 'credit card' ? 'var(--danger)' :
                                  account.subtype === 'savings' ? 'var(--success)' : 'var(--info)';

                accountDiv.innerHTML = `
                    <div class="account-icon" style="color: ${iconColor};">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="account-info">
                        <div class="account-name">${account.name}</div>
                        <div class="account-type">${account.institution} - ****${account.mask || '----'}</div>
                    </div>
                    <div class="account-balance">
                        <div class="amount" style="color: ${account.subtype === 'credit card' ? 'var(--danger)' : 'var(--success)'};">
                            $${Math.abs(account.balance_current || 0).toLocaleString()}
                        </div>
                        <div class="label">${account.subtype === 'credit card' ? 'Owed' : 'Available'}</div>
                    </div>
                `;
                connectedSection.appendChild(accountDiv);
            });

            // Calculate and update financial totals
            updateFinancialTotals(accounts);

            // Populate debt destroyer with credit card data
            updateDebtDestroyer(accounts);
        }

        function updateFinancialTotals(accounts) {
            if (!accounts || accounts.length === 0) {
                return;
            }

            // Categorize accounts and calculate totals
            let totalAssets = 0;
            let totalDebt = 0;
            let emergencyFund = 0;
            let investmentTotal = 0;

            accounts.forEach(account => {
                const balance = account.balance_current || 0;
                const subtype = (account.subtype || '').toLowerCase();
                const type = (account.type || '').toLowerCase();

                // Assets: checking, savings, investment, money market, CD
                if (subtype === 'checking' || subtype === 'savings' ||
                    subtype === 'money market' || subtype === 'cd' ||
                    type === 'depository') {
                    totalAssets += balance;

                    // Emergency fund = savings accounts
                    if (subtype === 'savings' || subtype === 'money market') {
                        emergencyFund += balance;
                    }
                }

                // Investments
                if (type === 'investment' || subtype === 'investment' ||
                    subtype === 'brokerage' || subtype === '401k' || subtype === 'ira') {
                    totalAssets += balance;
                    investmentTotal += balance;
                }

                // Debt: credit cards, loans, mortgages
                if (subtype === 'credit card' || type === 'credit' ||
                    type === 'loan' || subtype === 'loan' ||
                    subtype === 'mortgage' || subtype === 'student') {
                    totalDebt += Math.abs(balance);
                }
            });

            const netWorth = totalAssets - totalDebt;

            // Update the UI
            const netWorthEl = document.getElementById('total-net-worth');
            const assetsEl = document.getElementById('total-assets');
            const debtEl = document.getElementById('total-debt');
            const emergencyEl = document.getElementById('emergency-fund');
            const investmentEl = document.getElementById('investment-total');
            const debtRemainingEl = document.getElementById('debt-remaining');

            if (netWorthEl) {
                netWorthEl.textContent = '$' + netWorth.toLocaleString();
                netWorthEl.classList.remove('positive', 'negative');
                netWorthEl.classList.add(netWorth >= 0 ? 'positive' : 'negative');
            }

            if (assetsEl) {
                assetsEl.textContent = '$' + totalAssets.toLocaleString();
            }

            if (debtEl) {
                debtEl.textContent = totalDebt > 0 ? '-$' + totalDebt.toLocaleString() : '$0';
            }

            if (emergencyEl) {
                emergencyEl.textContent = '$' + emergencyFund.toLocaleString();
            }

            if (investmentEl) {
                investmentEl.textContent = '$' + investmentTotal.toLocaleString();
            }

            if (debtRemainingEl) {
                debtRemainingEl.textContent = '$' + totalDebt.toLocaleString();
            }

            console.log('Financial totals updated:', {
                totalAssets,
                totalDebt,
                netWorth,
                emergencyFund,
                investmentTotal
            });

            // Also update cash display in Banking tab
            const totalCashEl = document.getElementById('total-cash-display');
            if (totalCashEl) {
                totalCashEl.textContent = '$' + totalAssets.toLocaleString();
            }
        }

        // =============================================
        // DEBT DESTROYER - Real Credit Card Data
        // =============================================
        function updateDebtDestroyer(accounts) {
            if (!accounts || accounts.length === 0) {
                showNoDebtMessage();
                return;
            }

            // Filter for credit/debt accounts
            const debtAccounts = accounts.filter(account => {
                const subtype = (account.subtype || '').toLowerCase();
                const type = (account.type || '').toLowerCase();
                return subtype === 'credit card' || type === 'credit' ||
                       type === 'loan' || subtype === 'loan' ||
                       subtype === 'mortgage' || subtype === 'student';
            });

            if (debtAccounts.length === 0) {
                showNoDebtMessage();
                return;
            }

            // Calculate totals
            const totalDebt = debtAccounts.reduce((sum, acc) => sum + Math.abs(acc.balance_current || 0), 0);

            // Update stats
            const debtTotalEl = document.getElementById('debt-total-display');
            const debtCountEl = document.getElementById('debt-accounts-count');
            const debtStatusEl = document.getElementById('debt-accounts-status');

            if (debtTotalEl) {
                debtTotalEl.textContent = '$' + totalDebt.toLocaleString();
            }

            if (debtCountEl) {
                debtCountEl.textContent = debtAccounts.length;
            }

            if (debtStatusEl) {
                debtStatusEl.innerHTML = '<span>' + debtAccounts.length + ' account' + (debtAccounts.length > 1 ? 's' : '') + ' tracked</span>';
            }

            // Populate debt table
            const debtTableBody = document.getElementById('debt-table-body');
            if (debtTableBody) {
                debtTableBody.innerHTML = debtAccounts.map(account => {
                    const balance = Math.abs(account.balance_current || 0);
                    const subtype = account.subtype || 'Credit';
                    const name = account.name || 'Unknown Account';
                    const institution = account.institution || '';
                    const mask = account.mask ? '****' + account.mask : '';

                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${institution} ${mask}</div>
                            </td>
                            <td style="color: var(--danger); font-weight: 600;">$${balance.toLocaleString()}</td>
                            <td style="color: var(--text-secondary);">--</td>
                            <td>--</td>
                            <td>--</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="editDebt('${account.account_id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            console.log('Debt Destroyer updated with', debtAccounts.length, 'accounts, total:', totalDebt);
        }

        function showNoDebtMessage() {
            const debtTotalEl = document.getElementById('debt-total-display');
            const debtCountEl = document.getElementById('debt-accounts-count');
            const debtStatusEl = document.getElementById('debt-accounts-status');
            const debtTableBody = document.getElementById('debt-table-body');

            if (debtTotalEl) debtTotalEl.textContent = '$0';
            if (debtCountEl) debtCountEl.textContent = '0';
            if (debtStatusEl) debtStatusEl.innerHTML = '<span>No debt accounts connected</span>';

            if (debtTableBody) {
                debtTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-check-circle" style="color: var(--success); margin-right: 0.5rem;"></i>
                            No debt accounts found. Add debts manually or connect credit cards via Plaid.
                        </td>
                    </tr>
                `;
            }
        }

        // =============================================
        // TRANSACTION ANALYSIS - Income & Expenses
        // =============================================
        async function loadTransactionsAndAnalyze() {
            try {
                const result = await fetchFromSheet('getPlaidTransactions', { days: 30 });

                if (result && result.success && result.data) {
                    // Feed data to unified state manager
                    FinancialState.update('plaidTransactions', result.data);
                    analyzeTransactions(result.data);
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        function analyzeTransactions(transactions) {
            if (!transactions || transactions.length === 0) {
                return;
            }

            let monthlyIncome = 0;
            let monthlyExpenses = 0;

            // Plaid convention: positive amount = money out (expense)
            // negative amount = money in (income)
            transactions.forEach(txn => {
                if (txn.pending) return; // Skip pending transactions

                const amount = txn.amount || 0;

                if (amount < 0) {
                    // Negative = income (deposit, refund, payment received)
                    monthlyIncome += Math.abs(amount);
                } else {
                    // Positive = expense (purchase, payment, withdrawal)
                    monthlyExpenses += amount;
                }
            });

            // Update the UI
            const incomeEl = document.getElementById('monthly-income');
            const expensesEl = document.getElementById('monthly-expenses');

            if (incomeEl) {
                incomeEl.textContent = '$' + monthlyIncome.toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }

            if (expensesEl) {
                expensesEl.textContent = '-$' + monthlyExpenses.toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }

            // Update cash flow
            const cashFlowEl = document.getElementById('cash-flow-display');
            const cashFlowStatusEl = document.getElementById('cash-flow-status');
            const netCashFlow = monthlyIncome - monthlyExpenses;

            if (cashFlowEl) {
                cashFlowEl.textContent = (netCashFlow >= 0 ? '+$' : '-$') + Math.abs(netCashFlow).toLocaleString();
                cashFlowEl.style.color = netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
            }

            if (cashFlowStatusEl) {
                cashFlowStatusEl.innerHTML = '<span>' + (netCashFlow >= 0 ? 'Surplus' : 'Deficit') + ' this month</span>';
            }

            // Populate transactions table
            displayTransactionsTable(transactions);

            console.log('Monthly cash flow:', {
                income: monthlyIncome,
                expenses: monthlyExpenses,
                net: netCashFlow,
                transactionCount: transactions.length
            });
        }

        function displayTransactionsTable(transactions) {
            const tableBody = document.getElementById('transactions-table-body');
            if (!tableBody) return;

            if (!transactions || transactions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-receipt" style="margin-right: 0.5rem;"></i>
                            No transactions found. Connect accounts to view recent activity.
                        </td>
                    </tr>
                `;
                return;
            }

            // Show most recent 10 transactions
            const recentTxns = transactions.slice(0, 10);

            tableBody.innerHTML = recentTxns.map(txn => {
                const amount = txn.amount || 0;
                const isIncome = amount < 0;
                const displayAmount = Math.abs(amount);
                const date = new Date(txn.date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                const categoryColors = {
                    'Food and Drink': 'rgba(244, 162, 97, 0.2)',
                    'Shops': 'rgba(67, 97, 238, 0.2)',
                    'Travel': 'rgba(155, 89, 182, 0.2)',
                    'Transfer': 'rgba(67, 97, 238, 0.2)',
                    'Payment': 'rgba(42, 157, 143, 0.2)'
                };
                const category = txn.category ? txn.category[0] : 'Other';
                const catColor = categoryColors[category] || 'rgba(100, 116, 139, 0.2)';

                return `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${txn.name || txn.merchant_name || 'Transaction'}</td>
                        <td><span style="padding: 0.25rem 0.5rem; background: ${catColor}; border-radius: 4px; font-size: 0.8rem;">${category}</span></td>
                        <td style="font-size: 0.85rem; color: var(--text-secondary);">${txn.account_name || '--'}</td>
                        <td style="color: ${isIncome ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${isIncome ? '+' : '-'}$${displayAmount.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        async function refreshPlaidBalances() {
            showNotification('Refreshing balances...', 'info');

            try {
                const result = await fetchFromSheet('refreshPlaidBalances');
                if (result && result.success) {
                    await loadConnectedAccounts();
                    await loadTransactionsAndAnalyze();
                    showNotification('Balances updated!', 'success');
                }
            } catch (error) {
                showNotification('Failed to refresh: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    font-weight: 500;
                    z-index: 1000;
                    transform: translateX(150%);
                    transition: transform 0.3s ease;
                    max-width: 350px;
                `;
                document.body.appendChild(notification);
            }

            const colors = {
                success: { bg: 'var(--success)', icon: 'fa-check-circle' },
                error: { bg: 'var(--danger)', icon: 'fa-exclamation-circle' },
                warning: { bg: 'var(--warning)', icon: 'fa-exclamation-triangle' },
                info: { bg: 'var(--info)', icon: 'fa-info-circle' }
            };

            const config = colors[type] || colors.info;
            notification.style.background = config.bg;
            notification.innerHTML = `<i class="fas ${config.icon}"></i> ${message}`;
            notification.style.transform = 'translateX(0)';

            setTimeout(() => {
                notification.style.transform = 'translateX(150%)';
            }, 4000);
        }

        // =============================================
        // MARKETING FUNCTIONS
        // =============================================
        const MARKETING_API_URL = 'https://script.google.com/macros/s/AKfycbyMDydZxlRWRNw3BTSU_tXMgw3R6tYK0zN6CdlG8RjFlFCk9_NKMuHrOACTVlmUvMdE/exec';

        async function loadMarketingData() {
            try {
                // Load budget data
                const budgetResponse = await fetch(`${MARKETING_API_URL}?action=getMarketingBudget`);
                const budgetData = await budgetResponse.json();

                // Load spend data
                const spendResponse = await fetch(`${MARKETING_API_URL}?action=getMarketingSpend&month=${new Date().getMonth() + 1}&year=${new Date().getFullYear()}`);
                const spendData = await spendResponse.json();

                // Load analytics
                const analyticsResponse = await fetch(`${MARKETING_API_URL}?action=getMarketingAnalytics`);
                const analyticsData = await analyticsResponse.json();

                if (budgetData.success) {
                    updateMarketingBudgetDisplay(budgetData.data);
                }

                if (spendData.success) {
                    updateMarketingSpendDisplay(spendData.data);
                }

                if (analyticsData.success) {
                    updateMarketingAnalyticsDisplay(analyticsData.data);
                }

                showNotification('Marketing data refreshed', 'success');
            } catch (error) {
                console.error('Error loading marketing data:', error);
                showNotification('Error loading marketing data', 'error');
            }
        }

        function updateMarketingBudgetDisplay(data) {
            if (!data) return;

            const budget = data.monthly_budget || 500;
            const spent = data.spent_this_month || 0;
            const remaining = budget - spent;
            const percentUsed = Math.round((spent / budget) * 100);

            document.getElementById('marketing-budget').textContent = `$${budget.toLocaleString()}`;
            document.getElementById('marketing-spent').textContent = `$${spent.toLocaleString()}`;
            document.getElementById('marketing-remaining').textContent = `$${remaining.toLocaleString()} remaining`;
            document.getElementById('marketing-spent-percent').textContent = `${percentUsed}% used`;

            const progressBar = document.getElementById('marketing-progress');
            progressBar.style.width = `${Math.min(percentUsed, 100)}%`;
            progressBar.classList.remove('success', 'warning', 'danger');
            progressBar.classList.add(percentUsed < 50 ? 'success' : percentUsed < 80 ? 'warning' : 'danger');
        }

        function updateMarketingSpendDisplay(data) {
            if (!data || !data.transactions) return;

            const historyContainer = document.getElementById('marketing-spend-history');
            if (historyContainer && data.transactions.length > 0) {
                historyContainer.innerHTML = data.transactions.slice(0, 10).map(t => `
                    <div class="alert" style="margin-bottom: 0.5rem;">
                        <i class="fas ${getCategoryIcon(t.category)}" style="color: ${getCategoryColor(t.category)};"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${t.description}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${formatDate(t.date)}</div>
                        </div>
                        <span style="font-weight: 600; color: var(--danger);">-$${parseFloat(t.amount).toFixed(2)}</span>
                    </div>
                `).join('');
            }

            // Update category breakdown
            if (data.by_category) {
                const catContainer = document.getElementById('marketing-spend-categories');
                const categories = [
                    { key: 'social_ads', name: 'Social Media Ads', color: '#E1306C' },
                    { key: 'subscription', name: 'Ayrshare Subscription', color: '#3b5998' },
                    { key: 'print', name: 'Print Materials', color: '#2ecc71' },
                    { key: 'photography', name: 'Photography/Content', color: '#9b59b6' }
                ];

                catContainer.innerHTML = categories.map(cat => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 12px; height: 12px; background: ${cat.color}; border-radius: 50%;"></div>
                            <span>${cat.name}</span>
                        </div>
                        <span style="font-weight: 600;">$${(data.by_category[cat.key] || 0).toFixed(2)}</span>
                    </div>
                `).join('');
            }
        }

        function updateMarketingAnalyticsDisplay(data) {
            if (!data) return;

            if (data.roi !== undefined) {
                const roiEl = document.getElementById('marketing-roi');
                roiEl.textContent = (data.roi >= 0 ? '+' : '') + data.roi + '%';
                roiEl.classList.toggle('positive', data.roi >= 0);
                roiEl.classList.toggle('negative', data.roi < 0);
            }

            if (data.posts_this_month !== undefined) {
                document.getElementById('marketing-posts').textContent = data.posts_this_month;
            }
        }

        function getCategoryIcon(category) {
            const icons = {
                'social_ads': 'fa-ad',
                'subscription': 'fa-sync-alt',
                'print': 'fa-print',
                'photography': 'fa-camera',
                'events': 'fa-calendar-alt',
                'direct_mail': 'fa-envelope',
                'sms': 'fa-sms'
            };
            return icons[category] || 'fa-receipt';
        }

        function getCategoryColor(category) {
            const colors = {
                'social_ads': '#E1306C',
                'subscription': '#3b5998',
                'print': '#2ecc71',
                'photography': '#9b59b6',
                'events': '#e67e22',
                'direct_mail': '#3498db',
                'sms': '#2a9d8f'
            };
            return colors[category] || '#95a5a6';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        async function saveMarketingSpend() {
            const description = document.getElementById('marketingSpendDesc').value;
            const category = document.getElementById('marketingSpendCategory').value;
            const amount = parseFloat(document.getElementById('marketingSpendAmount').value);
            const date = document.getElementById('marketingSpendDate').value || new Date().toISOString().split('T')[0];
            const campaign = document.getElementById('marketingSpendCampaign').value;
            const notes = document.getElementById('marketingSpendNotes').value;

            if (!description || !amount) {
                showNotification('Please enter description and amount', 'warning');
                return;
            }

            try {
                const response = await fetch(MARKETING_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'logMarketingSpend',
                        description,
                        category,
                        amount,
                        date,
                        campaign,
                        notes
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Marketing expense logged', 'success');
                    closeModal('addMarketingSpendModal');
                    loadMarketingData();

                    // Clear form
                    document.getElementById('marketingSpendDesc').value = '';
                    document.getElementById('marketingSpendAmount').value = '';
                    document.getElementById('marketingSpendNotes').value = '';
                } else {
                    showNotification(result.error || 'Error logging expense', 'error');
                }
            } catch (error) {
                console.error('Error saving marketing spend:', error);
                showNotification('Error logging expense', 'error');
            }
        }

        async function allocateMarketingFunds() {
            const amount = parseFloat(document.getElementById('marketingFundAmount').value) || 0;
            const source = document.getElementById('marketingFundSource').value;
            const autoPercent = parseFloat(document.getElementById('marketingAutoPercent').value);
            const monthlyCap = parseFloat(document.getElementById('marketingMonthlyCap').value);

            try {
                // Log the fund allocation
                if (amount > 0) {
                    const response = await fetch(MARKETING_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'logMarketingActivity',
                            type: 'fund_allocation',
                            data: { amount, source, autoPercent, monthlyCap }
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification(`$${amount.toFixed(2)} added to marketing fund`, 'success');
                    }
                }

                closeModal('allocateMarketingModal');
                loadMarketingData();
            } catch (error) {
                console.error('Error allocating marketing funds:', error);
                showNotification('Settings saved locally', 'success');
                closeModal('allocateMarketingModal');
            }
        }

        // =============================================
        // SHOPIFY FINANCIAL DATA
        // =============================================
        async function loadShopifyFinancialData() {
            try {
                // Load Shopify Payments balance
                const balanceResult = await fetchFromSheet('getShopifyPaymentsBalance');
                if (balanceResult && balanceResult.success) {
                    console.log('Shopify Payments Balance:', balanceResult);
                    // Feed to state manager
                    FinancialState.update('shopifyPayments', { pending: balanceResult.totalPending || 0 });
                    updateShopifyPendingBalance({ amount: balanceResult.totalPending });
                }

                // Load Shopify Capital loan data from stored CSV data
                const capitalResult = await fetchFromSheet('getShopifyCapitalLoan');
                if (capitalResult && capitalResult.success) {
                    console.log('Shopify Capital Loan:', capitalResult);
                    // Feed to state manager
                    FinancialState.update('shopifyCapital', {
                        balance: capitalResult.currentBalance || 0,
                        originalAmount: capitalResult.loan?.originalAmount || 0,
                        repaymentRate: capitalResult.loan?.repaymentRate || 0
                    });
                    addShopifyCapitalLoan({
                        currentBalance: capitalResult.currentBalance,
                        originalAmount: capitalResult.loan.originalAmount,
                        totalPaymentAmount: capitalResult.loan.totalPaymentAmount,
                        repaymentRate: capitalResult.loan.repaymentRate,
                        monthlyFee: capitalResult.loan.monthlyFee,
                        lastUpdated: capitalResult.lastUpdated,
                        percentagePaid: capitalResult.progress.percentComplete
                    });
                }

            } catch (error) {
                console.error('Failed to load Shopify financial data:', error);
            }
        }

        function updateShopifyPendingBalance(pending) {
            if (!pending || pending.amount === 0) return;

            // Find or create Shopify section in the Banking card
            const bankingCard = document.querySelector('.card:has(.fa-university) .card-body');
            if (!bankingCard) return;

            let shopifySection = document.getElementById('shopifyBalanceSection');
            if (!shopifySection) {
                shopifySection = document.createElement('div');
                shopifySection.id = 'shopifyBalanceSection';
                shopifySection.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);';
                bankingCard.appendChild(shopifySection);
            }

            shopifySection.innerHTML = `
                <h4 style="margin: 0 0 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <i class="fab fa-shopify" style="color: #96bf48;"></i> Shopify Payments
                </h4>
                <div class="account-card shopify-pending">
                    <div class="account-icon" style="color: #96bf48;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="account-info">
                        <div class="account-name">Pending Payout</div>
                        <div class="account-type">Will deposit to PNC when processed</div>
                    </div>
                    <div class="account-balance">
                        <div class="amount" style="color: var(--warning);">
                            $${pending.amount.toLocaleString()}
                        </div>
                        <div class="label">Pending</div>
                    </div>
                </div>
            `;
        }

        function addShopifyCapitalLoan(loan) {
            if (!loan || loan.currentBalance === 0) return;

            const debtTableBody = document.getElementById('debt-table-body');
            if (!debtTableBody) return;

            // Check if Capital row already exists
            const existingRow = document.querySelector('.shopify-capital-row');
            if (existingRow) existingRow.remove();

            // Calculate progress
            const progress = ((loan.originalAmount - loan.currentBalance) / loan.originalAmount * 100).toFixed(1);

            const row = document.createElement('tr');
            row.className = 'shopify-capital-row';
            row.innerHTML = `
                <td>
                    <div style="font-weight: 600;"><i class="fab fa-shopify" style="color: #96bf48; margin-right: 0.5rem;"></i>Shopify Capital Loan</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                        Original: $${loan.originalAmount.toLocaleString()} | 17% of daily sales
                    </div>
                </td>
                <td style="color: var(--danger); font-weight: 600;">$${loan.currentBalance.toLocaleString()}</td>
                <td style="color: var(--text-secondary);">17%</td>
                <td>
                    <div style="font-size: 0.85rem;">${progress}% paid</div>
                    <div style="width: 60px; height: 4px; background: var(--border-color); border-radius: 2px; margin-top: 4px;">
                        <div style="width: ${progress}%; height: 100%; background: var(--success); border-radius: 2px;"></div>
                    </div>
                </td>
                <td>Auto-deducted from sales</td>
                <td>
                    <span class="badge badge-warning">Active</span>
                </td>
            `;

            // Insert at the beginning of the table
            if (debtTableBody.firstChild) {
                debtTableBody.insertBefore(row, debtTableBody.firstChild);
            } else {
                debtTableBody.appendChild(row);
            }

            // Update debt totals to include Shopify Capital
            const debtTotalEl = document.getElementById('debt-total-display');
            if (debtTotalEl) {
                const currentTotal = parseFloat(debtTotalEl.textContent.replace(/[$,]/g, '')) || 0;
                const newTotal = currentTotal + loan.currentBalance;
                debtTotalEl.textContent = '$' + newTotal.toLocaleString();
            }

            // Update account count
            const debtCountEl = document.getElementById('debt-accounts-count');
            if (debtCountEl) {
                const currentCount = parseInt(debtCountEl.textContent) || 0;
                debtCountEl.textContent = currentCount + 1;
            }

            console.log('Shopify Capital loan added to Debt Destroyer:', loan.currentBalance);
        }

        // Keep old function for backwards compatibility
        function addShopifyCapitalToDebt(capital) {
            if (!capital.loans || capital.loans.length === 0) return;
            capital.loans.forEach(loan => {
                addShopifyCapitalLoan({
                    currentBalance: loan.remainingBalance,
                    originalAmount: loan.originalAmount,
                    repaymentRate: loan.dailyWithholdingRate
                });
            });
        }

        function displayShopifyPayouts(payouts) {
            // Create a reference section for recent Shopify payouts
            // Note: These will also appear in PNC transactions
            console.log('Recent Shopify payouts (will appear in bank as deposits):', payouts);

            // Could add a small info tooltip showing recent payouts if desired
        }

        // =============================================
        // PAYPAL FINANCIAL DATA
        // =============================================
        async function loadPayPalData() {
            try {
                const summary = await fetchFromSheet('getPayPalFinancialSummary');
                if (summary && summary.success) {
                    console.log('PayPal Financial Summary:', summary);
                    // Feed to state manager
                    FinancialState.update('paypalBalance', {
                        available: summary.balance?.available || 0,
                        pending: summary.balance?.pending || 0
                    });
                    if (summary.transactions?.recent) {
                        FinancialState.update('paypalTransactions', summary.transactions.recent);
                    }
                    displayPayPalBalance(summary.balance);
                    displayPayPalTransactions(summary.transactions);
                }
            } catch (error) {
                console.error('Failed to load PayPal data:', error);
            }
        }

        function displayPayPalBalance(balance) {
            if (!balance) return;

            // Find or create PayPal section in the Banking card
            const bankingCard = document.querySelector('.card:has(.fa-university) .card-body');
            if (!bankingCard) return;

            let paypalSection = document.getElementById('paypalBalanceSection');
            if (!paypalSection) {
                paypalSection = document.createElement('div');
                paypalSection.id = 'paypalBalanceSection';
                paypalSection.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);';
                bankingCard.appendChild(paypalSection);
            }

            const hasBalance = balance.available > 0 || balance.pending > 0;

            paypalSection.innerHTML = `
                <h4 style="margin: 0 0 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <i class="fab fa-paypal" style="color: #003087;"></i> PayPal Business
                </h4>
                ${hasBalance ? `
                <div class="account-card paypal-balance">
                    <div class="account-icon" style="color: #003087;">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="account-info">
                        <div class="account-name">PayPal Balance</div>
                        <div class="account-type">Business Account</div>
                    </div>
                    <div class="account-balance">
                        <div class="amount" style="color: var(--success);">
                            $${balance.available.toLocaleString()}
                        </div>
                        <div class="label">Available</div>
                    </div>
                </div>
                ` : `
                <div class="account-card paypal-balance" style="opacity: 0.7;">
                    <div class="account-icon" style="color: #003087;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="account-info">
                        <div class="account-name">PayPal Connected</div>
                        <div class="account-type">$0 balance (payments go directly to linked bank)</div>
                    </div>
                </div>
                `}
            `;
        }

        function displayPayPalTransactions(transactions) {
            if (!transactions || !transactions.summary) return;

            console.log('PayPal 30-day summary:', transactions.summary);

            // If there's significant activity, add it to the cash flow or transaction history
            // For now just log - the transactions will show in bank accounts via Plaid
        }

        // =============================================
        // LOAN PACKAGE GENERATION
        // Generate professional loan application documents
        // =============================================
        async function generateAndDownloadLoanPackage() {
            const statusDiv = document.getElementById('loan-package-status');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: 8px; text-align: center;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--info); margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0;">Generating loan package...</p>
                    </div>
                `;
            }

            try {
                // Call the backend to generate the loan package
                const result = await fetchFromSheet('generateLoanPackage');

                if (result && result.success && result.html) {
                    // Create a downloadable HTML file
                    const blob = new Blob([result.html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);

                    // Create download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Tiny_Seed_Farm_Loan_Package_' + new Date().toISOString().split('T')[0] + '.html';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    // Show success and summary
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div style="background: rgba(42, 157, 143, 0.1); padding: 1rem; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                    <strong>Loan Package Generated!</strong>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">
                                            $${(result.summary?.totalAssets || 0).toLocaleString()}
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Total Assets</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">
                                            $${(result.summary?.totalLiabilities || 0).toLocaleString()}
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Total Liabilities</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${(result.summary?.netWorth || 0) >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                            $${(result.summary?.netWorth || 0).toLocaleString()}
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Net Worth</div>
                                    </div>
                                </div>
                                <p style="margin: 1rem 0 0; font-size: 0.9rem; color: var(--text-secondary);">
                                    <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                                    Open the downloaded file in your browser, then print to PDF for bank submission.
                                </p>
                            </div>
                        `;
                    }

                    showNotification('Loan package downloaded! Open in browser and print to PDF.', 'success');
                } else {
                    throw new Error(result?.error || 'Failed to generate loan package');
                }
            } catch (error) {
                console.error('Loan package error:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div style="background: rgba(230, 57, 70, 0.1); padding: 1rem; border-radius: 8px;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--danger); margin-right: 0.5rem;"></i>
                            <strong>Error:</strong> ${error.message}
                            <p style="margin: 0.5rem 0 0; font-size: 0.9rem;">
                                Make sure you have added assets to track. <a href="#" onclick="openModal('addAssetModal'); return false;" style="color: var(--primary-light);">Add an asset now</a>
                            </p>
                        </div>
                    `;
                }
                showNotification('Failed to generate loan package: ' + error.message, 'error');
            }
        }

        // Also support saving to Google Drive (calls backend)
        async function saveLoanPackageToDrive() {
            try {
                const result = await fetchFromSheet('saveLoanPackageToHTML');
                if (result && result.success) {
                    showNotification('Loan package saved to Google Drive!', 'success');
                    // Open the file URL in a new tab
                    if (result.url) {
                        window.open(result.url, '_blank');
                    }
                } else {
                    throw new Error(result?.error || 'Failed to save to Drive');
                }
            } catch (error) {
                console.error('Drive save error:', error);
                showNotification('Failed to save to Drive: ' + error.message, 'error');
            }
        }

        // =============================================
        // LOAN PACKAGE FUNCTIONS
        // =============================================
        async function generateLoanPackage() {
            showNotification('Generating loan package...', 'info');
            try {
                const balanceSheet = AssetManager.generateBalanceSheet();
                const html = generateBalanceSheetHTML(balanceSheet);
                document.getElementById('loan-package-content').innerHTML = html;
                openModal('loanPackageModal');
                showNotification('Loan package ready!', 'success');
            } catch (error) {
                showNotification('Failed to generate: ' + error.message, 'error');
            }
        }

        async function generateAssetReport() {
            showNotification('Generating asset schedule...', 'info');
            try {
                const schedule = AssetManager.generateAssetSchedule();
                document.getElementById('loan-package-content').innerHTML = schedule.html;
                openModal('loanPackageModal');
                showNotification('Asset schedule ready!', 'success');
            } catch (error) {
                showNotification('Failed to generate: ' + error.message, 'error');
            }
        }

        function generateBalanceSheetHTML(data) {
            const date = new Date().toLocaleDateString();
            return `
                <div style="font-family: 'Times New Roman', serif; padding: 20px;">
                    <h1 style="border-bottom: 2px solid #2a9d8f; padding-bottom: 10px;">Tiny Seed Farm - Balance Sheet</h1>
                    <p><strong>As of:</strong> ${date}</p>
                    <h2>Assets</h2>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Cash & Bank</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">$${(data?.assets?.cash || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Investments</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">$${(data?.assets?.investments || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Equipment</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">$${(data?.assets?.equipment || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Vehicles</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">$${(data?.assets?.vehicles || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Inventory</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">$${(data?.assets?.inventory || 0).toLocaleString()}</td></tr>
                        <tr style="font-weight: bold; background: #f5f5f5;"><td style="padding: 8px;">TOTAL ASSETS</td><td style="text-align: right; padding: 8px;">$${(data?.assets?.total || 0).toLocaleString()}</td></tr>
                    </table>
                    <h2>Liabilities</h2>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Credit Cards</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">$${(data?.liabilities?.creditCards || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;">Loans</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">$${(data?.liabilities?.loans || 0).toLocaleString()}</td></tr>
                        <tr style="font-weight: bold; background: #f5f5f5;"><td style="padding: 8px;">TOTAL LIABILITIES</td><td style="text-align: right; padding: 8px;">$${(data?.liabilities?.total || 0).toLocaleString()}</td></tr>
                    </table>
                    <h2>Owner's Equity</h2>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <tr style="font-weight: bold; background: #e8f5e9;"><td style="padding: 8px;">NET WORTH</td><td style="text-align: right; padding: 8px;">$${(data?.equity || 0).toLocaleString()}</td></tr>
                    </table>
                    <p style="margin-top: 40px; font-size: 0.9em; color: #666;">Generated by Tiny Seed Farm Financial System</p>
                </div>
            `;
        }

        function printLoanPackage() {
            const content = document.getElementById('loan-package-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head><title>Tiny Seed Farm Loan Package</title>
                <style>body { font-family: 'Times New Roman', serif; margin: 40px; } @media print { body { margin: 20px; } }</style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Wrapper for Payment Plan save from new modal
        function savePaymentPlan() {
            const customerName = document.getElementById('plan-customer-name')?.value;
            const customerEmail = document.getElementById('plan-customer-email')?.value;
            const total = parseFloat(document.getElementById('plan-total')?.value) || 0;
            const downPercent = parseInt(document.getElementById('plan-down-payment')?.value) || 20;
            const installments = parseInt(document.getElementById('plan-installments')?.value) || 4;
            const interest = parseInt(document.getElementById('plan-interest')?.value) || 5;

            if (!customerName || total <= 0) {
                showNotification('Please enter customer name and amount', 'warning');
                return;
            }

            PaymentPlanManager.create({
                customerName,
                customerEmail,
                totalAmount: total,
                downPaymentPercent: downPercent,
                installments,
                interestRate: interest
            });

            closeModal('addPaymentPlanModal');
            // Clear form
            document.getElementById('plan-customer-name').value = '';
            document.getElementById('plan-customer-email').value = '';
            document.getElementById('plan-total').value = '';
        }

        // =============================================
        // INITIALIZE
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Tiny Seed Financial Dashboard initialized');

            // Load all connected account data
            loadConnectedAccounts();
            loadTransactionsAndAnalyze();
            loadShopifyFinancialData();
            loadPayPalData();

            // Initialize smart systems
            await WishlistManager.load();
            await AssetManager.load();
            await BillOCR.load();
            await AlpacaManager.load();
            await PaymentPlanManager.load();

            // Calculate momentum signal for investments
            AlpacaManager.calculateMomentumSignal();

            // Generate prescriptive recommendations after data loads
            setTimeout(() => {
                RecommendationsEngine.generate();
            }, 2000); // Wait for financial data to load
        });

        // Re-generate recommendations when financial state updates
        const originalRefreshAllUI = FinancialState.refreshAllUI.bind(FinancialState);
        FinancialState.refreshAllUI = function() {
            originalRefreshAllUI();
            // Re-analyze wishlist and recommendations when finances change
            WishlistManager.analyzeAndDisplay();
            RecommendationsEngine.generate();
        };
    </script>
</body>
</html>
