<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#166534">
    <title>Tiny Seed Farm - CSA Member Portal</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ═══════════════════════════════════════════════════════════════════════════
           TINY SEED FARM - EXCEPTIONAL CSA MEMBER PORTAL
           State-of-the-art member experience
           ═══════════════════════════════════════════════════════════════════════════ */

        :root {
            --primary: #22c55e;
            --primary-dark: #16a34a;
            --primary-darker: #166534;
            --primary-light: #4ade80;
            --primary-bg: #dcfce7;
            --accent: #f59e0b;
            --accent-dark: #d97706;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-main: #fafaf9;
            --bg-card: #ffffff;
            --bg-elevated: #f5f5f4;
            --text-primary: #1c1917;
            --text-secondary: #57534e;
            --text-muted: #a8a29e;
            --border-color: #e7e5e4;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           SKELETON LOADING
           ═══════════════════════════════════════════════════════════════════════════ */

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text { height: 16px; margin-bottom: 8px; }
        .skeleton-title { height: 24px; width: 60%; margin-bottom: 12px; }
        .skeleton-card { height: 120px; border-radius: var(--radius-lg); }
        .skeleton-avatar { width: 48px; height: 48px; border-radius: 50%; }

        /* ═══════════════════════════════════════════════════════════════════════════
           PAGE TRANSITIONS
           ═══════════════════════════════════════════════════════════════════════════ */

        @keyframes slideInRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        .animate-in { animation: slideInUp 0.3s ease-out; }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        .animate-scale { animation: scaleIn 0.2s ease-out; }

        /* ═══════════════════════════════════════════════════════════════════════════
           TOUCH FEEDBACK
           ═══════════════════════════════════════════════════════════════════════════ */

        .btn, .card-clickable, .nav-item, .swap-option, .list-item {
            transition: transform 0.1s ease, background 0.2s ease;
        }

        .btn:active { transform: scale(0.97); }
        .card-clickable:active { transform: scale(0.98); }

        /* ═══════════════════════════════════════════════════════════════════════════
           PULL TO REFRESH
           ═══════════════════════════════════════════════════════════════════════════ */

        .pull-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-60px);
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease;
            z-index: 50;
        }

        .pull-indicator.visible { transform: translateX(-50%) translateY(20px); }
        .pull-indicator.refreshing i { animation: spin 0.8s linear infinite; }

        /* ═══════════════════════════════════════════════════════════════════════════
           LOGIN SCREEN
           ═══════════════════════════════════════════════════════════════════════════ */

        .login-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #166534 0%, #22c55e 100%);
        }

        .login-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            animation: scaleIn 0.3s ease-out;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-xl);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 16px;
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
        }

        .login-logo h1 { font-size: 24px; font-weight: 700; }
        .login-logo p { color: var(--primary); font-weight: 600; margin-top: 4px; }

        .login-form { margin-top: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
            transition: all 0.2s;
            background: #ffffff;
            color: var(--text-primary);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-sm { padding: 8px 16px; font-size: 14px; }
        .btn-icon { padding: 10px; width: 44px; height: 44px; border-radius: var(--radius-md); }

        /* Login Method Tabs */
        .login-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            padding: 4px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }

        .login-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .login-tab:hover {
            color: var(--text-primary);
        }

        .login-tab.active {
            background: white;
            color: var(--primary-dark);
            box-shadow: var(--shadow-sm);
        }

        .sms-code-input {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            letter-spacing: 8px;
            font-family: monospace;
        }

        .magic-link-sent {
            text-align: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .magic-link-sent .icon { font-size: 64px; margin-bottom: 16px; }

        /* ═══════════════════════════════════════════════════════════════════════════
           ONBOARDING WIZARD
           ═══════════════════════════════════════════════════════════════════════════ */

        .onboarding-screen {
            min-height: 100vh;
            background: white;
            display: none;
        }

        .onboarding-screen.active { display: block; }

        .onboarding-header {
            background: linear-gradient(135deg, var(--primary-darker), var(--primary-dark));
            color: white;
            padding: 40px 20px 60px;
            text-align: center;
        }

        .onboarding-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .onboarding-header p { opacity: 0.9; font-size: 16px; }

        .onboarding-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s;
        }

        .progress-dot.active { background: white; width: 24px; border-radius: 5px; }
        .progress-dot.completed { background: white; }

        .onboarding-content {
            margin-top: -40px;
            padding: 0 20px 100px;
        }

        .onboarding-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 24px;
            box-shadow: var(--shadow-lg);
        }

        .onboarding-step { display: none; animation: fadeIn 0.3s ease; }
        .onboarding-step.active { display: block; }

        .onboarding-illustration {
            text-align: center;
            font-size: 80px;
            margin: 20px 0;
        }

        .preference-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .preference-item {
            background: var(--bg-elevated);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preference-item:hover { border-color: var(--border-color); }
        .preference-item.selected { border-color: var(--primary); background: var(--primary-bg); }
        .preference-item .emoji { font-size: 28px; margin-bottom: 8px; }
        .preference-item .name { font-size: 13px; font-weight: 500; }

        .comm-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            cursor: pointer;
        }

        .comm-option input { display: none; }
        .comm-option .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s;
        }

        .comm-option input:checked + .checkbox {
            background: var(--primary);
            border-color: var(--primary);
        }

        .onboarding-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .onboarding-footer .btn { flex: 1; }

        /* Confetti */
        .confetti-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary);
            animation: confetti 3s ease-out forwards;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           MAIN APP CONTAINER
           ═══════════════════════════════════════════════════════════════════════════ */

        .app-container { display: none; }
        .app-container.active { display: block; }

        /* ═══════════════════════════════════════════════════════════════════════════
           SMART ALERT BANNER
           ═══════════════════════════════════════════════════════════════════════════ */

        .alert-banner {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            animation: slideInUp 0.3s ease;
        }

        .alert-banner.urgent {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }

        .alert-banner.info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }

        .alert-banner.success {
            background: linear-gradient(135deg, var(--primary-bg), #bbf7d0);
            color: var(--primary-darker);
        }

        .alert-banner i { font-size: 18px; }
        .alert-banner .alert-text { flex: 1; }
        .alert-banner .alert-action {
            background: rgba(0,0,0,0.1);
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .alert-banner .dismiss {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            opacity: 0.6;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           WELCOME BANNER
           ═══════════════════════════════════════════════════════════════════════════ */

        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-darker), var(--primary-dark));
            color: white;
            padding: 24px 20px 60px;
        }

        .welcome-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .welcome-text { font-size: 14px; opacity: 0.9; }
        .welcome-name { font-size: 24px; font-weight: 700; margin-top: 4px; }

        .weather-widget {
            text-align: right;
            font-size: 13px;
        }

        .weather-temp { font-size: 24px; font-weight: 600; }

        .membership-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 12px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           STATS CARDS
           ═══════════════════════════════════════════════════════════════════════════ */

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 0 20px;
            margin-top: -40px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow-md);
            animation: slideInUp 0.3s ease;
        }

        .stat-card:nth-child(2) { animation-delay: 0.05s; }
        .stat-card:nth-child(3) { animation-delay: 0.1s; }

        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        /* ═══════════════════════════════════════════════════════════════════════════
           QUICK ACTIONS
           ═══════════════════════════════════════════════════════════════════════════ */

        .quick-actions {
            display: flex;
            gap: 12px;
            padding: 20px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .quick-actions::-webkit-scrollbar { display: none; }

        .quick-action {
            flex-shrink: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .quick-action:hover { border-color: var(--primary); }
        .quick-action i { color: var(--primary); }

        /* ═══════════════════════════════════════════════════════════════════════════
           SECTION STYLING
           ═══════════════════════════════════════════════════════════════════════════ */

        .section { padding: 0 20px 20px; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title { font-size: 18px; font-weight: 700; }

        .section-action {
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           TOP ROW - FLEX CLOCK + SOCIAL THUMBNAILS (Clean, Minimal)
           ═══════════════════════════════════════════════════════════════════════════ */

        .dashboard-top-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: stretch;
        }

        /* Flex Funds Clock Widget */
        .flex-clock-widget {
            background: #111827;
            border-radius: var(--radius-lg);
            padding: 14px 18px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 140px;
        }

        .flex-clock-label {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 4px;
        }

        .flex-clock-display {
            display: flex;
            align-items: baseline;
        }

        .flex-clock-amount {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 28px;
            font-weight: 700;
            color: #22c55e;
            line-height: 1;
            transition: color 0.3s;
        }

        .flex-clock-amount.zero {
            color: #ef4444;
        }

        .flex-clock-cents {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #22c55e;
            transition: color 0.3s;
        }

        .flex-clock-cents.zero {
            color: #ef4444;
        }

        .flex-clock-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .flex-add-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .flex-add-btn:hover {
            background: #16a34a;
        }

        .flex-history-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: rgba(255,255,255,0.6);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .flex-history-btn:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        /* Social Thumbnails Strip */
        .social-strip {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 10px 14px;
            overflow: hidden;
        }

        .social-strip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .social-strip-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .social-strip-link {
            font-size: 11px;
            color: var(--primary);
            text-decoration: none;
        }

        .social-thumbs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .social-thumbs::-webkit-scrollbar {
            display: none;
        }

        .social-thumb {
            flex: 0 0 72px;
            height: 72px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .social-thumb:hover {
            transform: scale(1.05);
        }

        .social-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .social-thumb-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-thumb-overlay i {
            color: white;
            font-size: 10px;
        }

        @media (max-width: 480px) {
            .dashboard-top-row {
                flex-direction: column;
            }

            .flex-clock-widget {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .flex-clock-actions {
                margin-top: 0;
            }

            .social-thumb {
                flex: 0 0 64px;
                height: 64px;
            }
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           ORDER CONFIRMATION & DISPUTE STYLES
           ═══════════════════════════════════════════════════════════════════════════ */

        .order-confirmation-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
        }

        .order-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .order-row:last-child { border-bottom: none; }

        .order-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .order-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            text-align: right;
        }

        .dispute-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .dispute-btn {
            width: 100%;
            background: transparent;
            border: 1px dashed var(--border-color);
            color: var(--text-secondary);
            padding: 12px;
            border-radius: var(--radius-md);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .dispute-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }

        .dispute-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .dispute-modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 100%;
            max-width: 400px;
        }

        .dispute-modal-content h3 {
            margin-bottom: 8px;
        }

        .dispute-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .dispute-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .dispute-actions .btn { flex: 1; }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .skip-veggies-input {
            min-height: 80px;
            resize: vertical;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           VACATION HOLDS - REDESIGNED
           ═══════════════════════════════════════════════════════════════════════════ */

        .hold-options-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .hold-option-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-elevated);
            padding: 12px;
            border-radius: var(--radius-md);
        }

        .hold-option-icon {
            font-size: 24px;
        }

        .hold-option-text {
            display: flex;
            flex-direction: column;
        }

        .hold-option-text strong {
            font-size: 14px;
            color: var(--text-primary);
        }

        .hold-option-text span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Hold Options Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 { margin: 0; }

        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
        }

        .modal-footer .btn { flex: 1; }

        .hold-choice {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hold-choice:hover {
            border-color: var(--primary);
            background: var(--primary-bg);
        }

        .hold-choice.selected {
            border-color: var(--primary);
            background: var(--primary-bg);
        }

        .hold-choice.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hold-choice.disabled:hover {
            border-color: var(--border-color);
            background: transparent;
        }

        .hold-choice-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
        }

        .hold-choice.selected .hold-choice-radio {
            border-color: var(--primary);
        }

        .hold-choice.selected .hold-choice-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
        }

        .hold-choice-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .hold-choice-icon {
            font-size: 28px;
        }

        .hold-choice-text {
            display: flex;
            flex-direction: column;
        }

        .hold-choice-text strong {
            font-size: 15px;
            color: var(--text-primary);
        }

        .hold-choice-text span {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .season-warning {
            background: #fef3c7;
            color: #92400e;
            padding: 12px;
            border-radius: var(--radius-md);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flex-history-panel {
            margin-top: 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
        }

        .flex-transactions-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .flex-history-section {
            margin-top: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .flex-history-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 12px;
            color: var(--text-primary);
        }

        .flex-transactions-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .flex-transaction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .flex-transaction:last-child {
            border-bottom: none;
        }

        .flex-tx-info {
            flex: 1;
        }

        .flex-tx-type {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .flex-tx-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .flex-tx-reason {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
            font-style: italic;
        }

        .flex-tx-amount {
            font-weight: 600;
            font-size: 16px;
        }

        .flex-tx-amount.credit {
            color: #22c55e;
        }

        .flex-tx-amount.debit {
            color: #ef4444;
        }

        .flex-loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .flex-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           THIS WEEK'S BOX (ENHANCED)
           ═══════════════════════════════════════════════════════════════════════════ */

        .box-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .box-photo {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--primary-bg), #bbf7d0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .box-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid var(--border-color);
        }

        .box-week { font-weight: 700; font-size: 16px; }
        .box-pickup { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
        .box-pickup i { margin-right: 4px; }

        .box-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .box-status.ready { background: var(--primary-bg); color: var(--primary-darker); }
        .box-status.pending { background: #fef3c7; color: #92400e; }

        .box-deadline {
            background: #fef3c7;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 500;
            color: #92400e;
        }

        .box-deadline i { font-size: 16px; }
        .box-deadline .countdown { margin-left: auto; font-weight: 700; }

        .box-items { padding: 8px 16px; }

        .box-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .box-item:last-child { border-bottom: none; }

        .box-item-emoji { font-size: 32px; width: 44px; text-align: center; }

        .box-item-info { flex: 1; }
        .box-item-name { font-weight: 600; }
        .box-item-qty { font-size: 13px; color: var(--text-secondary); }
        .box-item-note { font-size: 12px; color: var(--primary); font-weight: 500; }

        .box-item-actions { display: flex; gap: 8px; }

        .swap-btn, .keep-btn {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .swap-btn {
            background: var(--bg-elevated);
            color: var(--primary);
        }

        .swap-btn:hover { background: var(--primary-bg); }
        .swap-btn:disabled { color: var(--text-muted); cursor: not-allowed; }

        .keep-btn {
            background: transparent;
            color: var(--text-muted);
        }

        .keep-btn.active { color: var(--primary); }

        .box-footer {
            padding: 16px;
            background: var(--bg-elevated);
            display: flex;
            gap: 12px;
        }

        .box-footer .btn { flex: 1; }

        /* ═══════════════════════════════════════════════════════════════════════════
           FARMER UPDATES FEED
           ═══════════════════════════════════════════════════════════════════════════ */

        .updates-feed {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
        }

        .updates-feed::-webkit-scrollbar { display: none; }

        .update-card {
            flex-shrink: 0;
            width: 280px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .update-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
        }

        .update-content { padding: 16px; }
        .update-text { font-size: 14px; line-height: 1.5; color: var(--text-secondary); }

        .update-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .update-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           UPCOMING BOXES
           ═══════════════════════════════════════════════════════════════════════════ */

        .upcoming-list { display: flex; flex-direction: column; gap: 12px; }

        .upcoming-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upcoming-card:hover { border-color: var(--primary); }
        .upcoming-card.hold { opacity: 0.6; background: var(--bg-elevated); }

        .upcoming-date { font-weight: 600; }
        .upcoming-preview { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

        .upcoming-badge {
            padding: 6px 12px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .upcoming-badge.hold {
            background: #fee2e2;
            color: #b91c1c;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           VACATION HOLDS
           ═══════════════════════════════════════════════════════════════════════════ */

        .vacation-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .vacation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .vacation-title { font-weight: 700; }

        .vacation-remaining {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .vacation-remaining strong { color: var(--primary); }

        .vacation-weeks { display: flex; flex-direction: column; gap: 12px; }

        .vacation-week {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }

        .vacation-week.on-hold {
            background: #fee2e2;
        }

        .vacation-week-info { }
        .vacation-week-date { font-weight: 600; }
        .vacation-week-label { font-size: 13px; color: var(--text-secondary); }

        .vacation-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .vacation-btn.schedule {
            background: var(--primary);
            color: white;
        }

        .vacation-btn.cancel {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           BOTTOM NAVIGATION
           ═══════════════════════════════════════════════════════════════════════════ */

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 6px 0;
            padding-bottom: max(6px, env(safe-area-inset-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 10px 20px;
            min-height: 56px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 22px; }

        /* ═══════════════════════════════════════════════════════════════════════════
           TAB CONTENT
           ═══════════════════════════════════════════════════════════════════════════ */

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease; }

        /* ═══════════════════════════════════════════════════════════════════════════
           ORDER HISTORY
           ═══════════════════════════════════════════════════════════════════════════ */

        .page-header {
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
        }

        .page-header h1 { font-size: 24px; font-weight: 700; }

        .orders-list {
            padding: 0 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .order-id { font-weight: 600; font-size: 14px; }
        .order-date { font-size: 13px; color: var(--text-secondary); }

        .order-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .order-status.picked-up { background: var(--primary-bg); color: var(--primary-darker); }
        .order-status.pending { background: #fef3c7; color: #92400e; }
        .order-status.skipped { background: var(--bg-elevated); color: var(--text-muted); }

        .order-items { font-size: 13px; color: var(--text-secondary); }

        /* ═══════════════════════════════════════════════════════════════════════════
           ACCOUNT / SETTINGS
           ═══════════════════════════════════════════════════════════════════════════ */

        .settings-section { padding: 0 20px 20px; }

        .settings-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .settings-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row:last-child { border-bottom: none; }

        .settings-label { color: var(--text-secondary); font-size: 14px; }
        .settings-value { font-weight: 500; }

        .settings-toggle {
            position: relative;
            width: 50px;
            height: 28px;
            background: var(--border-color);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .settings-toggle.active { background: var(--primary); }

        .settings-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .settings-toggle.active::after { transform: translateX(22px); }

        .settings-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .settings-link:last-child { border-bottom: none; }
        .settings-link i { color: var(--text-muted); }

        .logout-btn {
            width: 100%;
            padding: 14px;
            background: none;
            border: 2px solid var(--danger);
            color: var(--danger);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           ENHANCED SWAP MODAL
           ═══════════════════════════════════════════════════════════════════════════ */

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: none;
            align-items: flex-end;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.open { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideInUp 0.3s ease;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .modal-title { font-size: 18px; font-weight: 700; }

        .modal-close {
            background: var(--bg-elevated);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body { padding: 20px; }

        .swap-current {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #fee2e2;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .swap-current-emoji { font-size: 36px; }
        .swap-current-label { font-size: 12px; color: #b91c1c; font-weight: 500; }
        .swap-current-name { font-weight: 700; }

        .swap-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .swap-section-title i { color: var(--accent); }

        .swap-options { margin-bottom: 20px; }

        .swap-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .swap-option:hover { border-color: var(--border-color); }
        .swap-option.selected { border-color: var(--primary); background: var(--primary-bg); }
        .swap-option.disabled { opacity: 0.5; cursor: not-allowed; }

        .swap-option-emoji { font-size: 36px; }
        .swap-option-info { flex: 1; }
        .swap-option-name { font-weight: 600; }
        .swap-option-meta { font-size: 13px; color: var(--text-secondary); display: flex; gap: 12px; margin-top: 2px; }

        .swap-popularity {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--primary);
            font-weight: 500;
        }

        .swap-limited {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .swap-remember {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            margin-top: 16px;
            cursor: pointer;
        }

        .swap-remember input { display: none; }

        .swap-remember .checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .swap-remember input:checked + .checkbox {
            background: var(--primary);
            border-color: var(--primary);
        }

        .swap-remember-text { font-size: 14px; }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            background: var(--bg-card);
        }

        .confirm-swap-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .confirm-swap-btn:disabled { background: var(--text-muted); cursor: not-allowed; }

        /* ═══════════════════════════════════════════════════════════════════════════
           NOTIFICATION PREFERENCES MODAL
           ═══════════════════════════════════════════════════════════════════════════ */

        .notification-group {
            margin-bottom: 24px;
        }

        .notification-group-title {
            font-weight: 600;
            margin-bottom: 12px;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-item:last-child { border-bottom: none; }

        .notification-label { font-size: 14px; }

        .comm-method-selector {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .comm-method {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comm-method.active {
            border-color: var(--primary);
            background: var(--primary-bg);
        }

        .comm-method i { font-size: 20px; margin-bottom: 4px; color: var(--primary); }
        .comm-method span { display: block; font-size: 13px; font-weight: 500; }

        /* ═══════════════════════════════════════════════════════════════════════════
           TOAST NOTIFICATIONS
           ═══════════════════════════════════════════════════════════════════════════ */

        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .toast {
            background: var(--text-primary);
            color: white;
            padding: 14px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            animation: slideInUp 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }

        .toast.hiding { animation: slideInUp 0.3s ease reverse; }

        /* ═══════════════════════════════════════════════════════════════════════════
           LOADING STATES
           ═══════════════════════════════════════════════════════════════════════════ */

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-spinner.dark {
            border-color: rgba(0,0,0,0.1);
            border-top-color: var(--primary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           EMPTY STATES
           ═══════════════════════════════════════════════════════════════════════════ */

        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .empty-state-text { color: var(--text-secondary); font-size: 14px; }

        /* ═══════════════════════════════════════════════════════════════════════════
           RESPONSIVE
           ═══════════════════════════════════════════════════════════════════════════ */

        @media (min-width: 768px) {
            body { padding-bottom: 0; }

            .bottom-nav {
                position: relative;
                border-top: none;
                border-bottom: 1px solid var(--border-color);
                justify-content: center;
                gap: 40px;
            }

            .modal-content {
                max-width: 480px;
                border-radius: var(--radius-xl);
                margin: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Pull to Refresh Indicator -->
    <div class="pull-indicator" id="pullIndicator">
        <i class="fas fa-sync-alt"></i>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════
         LOGIN SCREEN
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <div class="login-logo-icon">🌱</div>
                <h1>Tiny Seed Farm</h1>
                <p>CSA Member Portal</p>
            </div>

            <!-- Login Method Tabs -->
            <div class="login-tabs" id="loginTabs">
                <button class="login-tab active" data-method="email" onclick="switchLoginMethod('email')">
                    <i class="fas fa-envelope"></i> Email
                </button>
                <button class="login-tab" data-method="phone" onclick="switchLoginMethod('phone')">
                    <i class="fas fa-sms"></i> Text Code
                </button>
            </div>

            <!-- Email Login Form -->
            <div class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="emailInput" placeholder="your@email.com" autocomplete="email">
                </div>
                <button class="btn btn-primary" id="sendLinkBtn" onclick="sendMagicLink()">
                    <i class="fas fa-paper-plane"></i>
                    Send Login Link
                </button>
                <p style="text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary);">
                    We'll send you a magic link to sign in instantly
                </p>
            </div>

            <!-- Phone Login Form -->
            <div class="login-form" id="phoneLoginForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="phoneInput" placeholder="(412) 555-1234" autocomplete="tel">
                </div>
                <button class="btn btn-primary" id="sendCodeBtn" onclick="sendSMSCode()">
                    <i class="fas fa-sms"></i>
                    Send Verification Code
                </button>
                <p style="text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary);">
                    We'll text you a 6-digit code to sign in
                </p>
            </div>

            <!-- SMS Code Entry -->
            <div class="login-form" id="smsCodeForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Enter Verification Code</label>
                    <input type="text" class="form-input sms-code-input" id="smsCodeInput" placeholder="123456" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code">
                </div>
                <button class="btn btn-primary" id="verifyCodeBtn" onclick="verifySMSCode()">
                    <i class="fas fa-check"></i>
                    Verify Code
                </button>
                <p style="text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary);">
                    Code sent to <strong id="sentToPhone"></strong>
                </p>
                <button class="btn btn-link" onclick="resetPhoneLogin()" style="margin-top: 8px; background: none; color: var(--primary);">
                    Use different number
                </button>
            </div>

            <!-- Magic Link Sent -->
            <div class="magic-link-sent" id="magicLinkSent" style="display: none;">
                <div class="icon">📧</div>
                <h3>Check Your Email!</h3>
                <p style="color: var(--text-secondary); margin-top: 8px;">
                    We sent a login link to<br><strong id="sentToEmail"></strong>
                </p>
                <p style="font-size: 13px; color: var(--text-muted); margin-top: 16px;">
                    The link expires in 15 minutes
                </p>
                <button class="btn btn-secondary" onclick="resetLogin()" style="margin-top: 24px;">
                    Try Different Email
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════
         ONBOARDING WIZARD
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="onboarding-screen" id="onboardingScreen">
        <div class="onboarding-header">
            <h1 id="onboardingTitle">Welcome to Tiny Seed Farm!</h1>
            <p id="onboardingSubtitle">Let's get you set up in just a moment</p>
            <div class="onboarding-progress">
                <div class="progress-dot active" data-step="1"></div>
                <div class="progress-dot" data-step="2"></div>
                <div class="progress-dot" data-step="3"></div>
                <div class="progress-dot" data-step="4"></div>
            </div>
        </div>

        <div class="onboarding-content">
            <div class="onboarding-card">
                <!-- Step 1: Order Confirmation -->
                <div class="onboarding-step active" id="onboarding-step-1">
                    <div class="onboarding-illustration">📦</div>
                    <h2 style="text-align: center; margin-bottom: 8px;">Here's What You Ordered!</h2>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
                        Welcome to the Tiny Seed Farm family! We're thrilled to have you.
                    </p>
                    <div class="order-confirmation-card">
                        <div class="order-row">
                            <span class="order-label">Name</span>
                            <span class="order-value" id="onboardingFullName">Member Name</span>
                        </div>
                        <div class="order-row">
                            <span class="order-label">Email</span>
                            <span class="order-value" id="onboardingEmail">email@example.com</span>
                        </div>
                        <div class="order-row">
                            <span class="order-label">Share Type</span>
                            <span class="order-value" id="onboardingShare">Regular Vegetable</span>
                        </div>
                        <div class="order-row">
                            <span class="order-label">Season</span>
                            <span class="order-value" id="onboardingSeason">2026</span>
                        </div>
                        <div class="order-row">
                            <span class="order-label">Pickup Location</span>
                            <span class="order-value" id="onboardingLocation">Farm Stand</span>
                        </div>
                        <div class="order-row" id="onboardingAddressRow" style="display: none;">
                            <span class="order-label">Delivery Address</span>
                            <span class="order-value" id="onboardingAddress">123 Main St</span>
                        </div>
                    </div>
                    <div class="dispute-section">
                        <p style="font-size: 13px; color: var(--text-secondary); text-align: center; margin-bottom: 8px;">
                            Does everything look correct?
                        </p>
                        <button class="dispute-btn" onclick="showDisputeForm()">
                            <i class="fas fa-exclamation-circle"></i>
                            Something doesn't look right
                        </button>
                    </div>
                </div>

                <!-- Dispute Modal (hidden by default) -->
                <div class="dispute-modal" id="disputeModal" style="display: none;">
                    <div class="dispute-modal-content">
                        <h3>Let Us Know What's Wrong</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                            We'll review and fix any issues right away.
                        </p>
                        <div class="form-group">
                            <label class="form-label">What needs to be corrected?</label>
                            <textarea class="form-input dispute-textarea" id="disputeText" rows="4"
                                placeholder="Please describe what information is incorrect..."></textarea>
                        </div>
                        <div class="dispute-actions">
                            <button class="btn btn-secondary" onclick="hideDisputeForm()">Cancel</button>
                            <button class="btn btn-primary" onclick="submitDispute()">Submit</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Dislikes (Free Text) -->
                <div class="onboarding-step" id="onboarding-step-2">
                    <div class="onboarding-illustration">🥬</div>
                    <h2 style="margin-bottom: 8px; text-align: center;">Any veggies you'd rather skip?</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px; text-align: center;">
                        Let us know if there's anything you don't eat, and we'll suggest swaps when they're in your box.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Vegetables to skip (optional)</label>
                        <textarea class="form-input skip-veggies-input" id="skipVeggiesInput" rows="3"
                            placeholder="Type any vegetables you'd prefer not to receive..."></textarea>
                        <p class="form-hint">Examples: cilantro, beets, spicy peppers</p>
                    </div>
                    <p style="font-size: 13px; color: var(--text-muted); text-align: center; margin-top: 16px;">
                        Don't worry, you can always update this later in your settings.
                    </p>
                </div>

                <!-- Step 3: Communication Preferences -->
                <div class="onboarding-step" id="onboarding-step-3">
                    <h2 style="margin-bottom: 8px;">How should we reach you?</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                        We'll send pickup reminders and box updates
                    </p>

                    <label class="comm-option">
                        <input type="checkbox" id="commEmail" checked>
                        <div class="checkbox"><i class="fas fa-check"></i></div>
                        <div>
                            <div style="font-weight: 600;">Email</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Weekly updates and reminders</div>
                        </div>
                    </label>

                    <label class="comm-option">
                        <input type="checkbox" id="commSMS">
                        <div class="checkbox"><i class="fas fa-check"></i></div>
                        <div>
                            <div style="font-weight: 600;">SMS Text Messages</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Day-of pickup reminders</div>
                        </div>
                    </label>

                    <div class="form-group" id="phoneGroup" style="margin-top: 16px; display: none;">
                        <label class="form-label">Mobile Phone Number</label>
                        <input type="tel" class="form-input" id="phoneInput" placeholder="(412) 555-1234">
                    </div>
                </div>

                <!-- Step 4: Complete -->
                <div class="onboarding-step" id="onboarding-step-4">
                    <div class="onboarding-illustration">🎉</div>
                    <h2 style="text-align: center; margin-bottom: 12px;">You're All Set!</h2>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">
                        Your first box is ready for pickup:
                    </p>
                    <div style="background: var(--primary-bg); padding: 20px; border-radius: var(--radius-lg); text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;">📦</div>
                        <div style="font-weight: 700; font-size: 18px;" id="firstPickupDate">Tuesday, January 21</div>
                        <div style="color: var(--primary-darker); font-size: 14px;" id="firstPickupLocation">4-7pm at Farm Stand</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="onboarding-footer">
            <button class="btn btn-secondary" id="onboardingBack" onclick="prevOnboardingStep()" style="display: none;">
                Back
            </button>
            <button class="btn btn-primary" id="onboardingNext" onclick="nextOnboardingStep()">
                Continue
            </button>
        </div>
    </div>

    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <!-- ═══════════════════════════════════════════════════════════════════════════
         MAIN APP
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="app-container" id="appContainer">
        <!-- Home Tab -->
        <div class="tab-content active" id="tab-home">
            <!-- Smart Alert Banner -->
            <div class="alert-banner urgent" id="alertBanner" style="display: none;">
                <i class="fas fa-clock"></i>
                <span class="alert-text" id="alertText">Customization closes in 2 hours!</span>
                <button class="alert-action" id="alertAction">Customize</button>
                <button class="dismiss" onclick="dismissAlert()"><i class="fas fa-times"></i></button>
            </div>

            <!-- Top Row: Flex Clock + Social Thumbnails -->
            <div class="dashboard-top-row">
                <!-- Flex Funds Clock Widget -->
                <div class="flex-clock-widget" id="flexFundsBanner">
                    <div class="flex-clock-label">Flex Funds</div>
                    <div class="flex-clock-display">
                        <span class="flex-clock-amount">$<span id="flexBalanceDollars">0</span></span>
                        <span class="flex-clock-cents">.<span id="flexBalanceCents">00</span></span>
                    </div>
                    <div class="flex-clock-actions">
                        <button class="flex-add-btn" onclick="purchaseFlexFunds()">+ Add</button>
                        <button class="flex-history-btn" onclick="toggleFlexHistory()">History</button>
                    </div>
                </div>

                <!-- Social Thumbnails -->
                <div class="social-strip">
                    <div class="social-strip-header">
                        <span class="social-strip-title">From the Farm</span>
                        <a href="https://instagram.com/tinyseedfarm" target="_blank" class="social-strip-link">
                            <i class="fab fa-instagram"></i>
                        </a>
                    </div>
                    <div class="social-thumbs" id="socialThumbs">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Flex History Modal -->
            <div class="modal-overlay" id="flexHistoryModal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Flex Funds History</h3>
                        <button class="modal-close" onclick="toggleFlexHistory()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body">
                        <div id="flexTransactionsList">
                            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="welcome-banner">
                <div class="welcome-row">
                    <div>
                        <div class="welcome-text">Welcome back,</div>
                        <div class="welcome-name" id="memberName">Member</div>
                    </div>
                    <div class="weather-widget" id="weatherWidget">
                        <div class="weather-temp">45°</div>
                        <div>Partly Cloudy</div>
                    </div>
                </div>
                <div class="membership-badge">
                    <span>🥬</span>
                    <span id="shareType">Regular Vegetable Share</span>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value" id="weeksRemaining">--</div>
                    <div class="stat-label">Weeks Left</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="swapCredits">--</div>
                    <div class="stat-label">Swap Credits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="boxesReceived">--</div>
                    <div class="stat-label">Boxes Received</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action" onclick="showVacationHolds()">
                    <i class="fas fa-calendar-minus"></i>
                    Schedule Hold
                </button>
                <button class="quick-action" onclick="showNotificationSettings()">
                    <i class="fas fa-bell"></i>
                    Reminders
                </button>
                <button class="quick-action" onclick="contactFarm()">
                    <i class="fas fa-comment"></i>
                    Contact Us
                </button>
            </div>

            <!-- Season Status Banner (shows when season hasn't started or ending soon) -->
            <div class="section" id="seasonStatusSection" style="display: none;">
                <div class="box-card" id="seasonStatusCard" style="background: linear-gradient(135deg, #166534 0%, #22c55e 100%); color: white;">
                    <div style="text-align: center; padding: 20px;">
                        <div id="seasonIcon" style="font-size: 64px; margin-bottom: 16px;">🌱</div>
                        <h2 id="seasonTitle" style="margin: 0 0 8px 0; font-size: 24px;">Your Season Starts Soon!</h2>
                        <p id="seasonSubtitle" style="margin: 0 0 20px 0; opacity: 0.9;">Summer CSA begins June 1, 2026</p>
                        <div id="seasonCountdown" style="display: flex; justify-content: center; gap: 16px; margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <div id="countdownDays" style="font-size: 36px; font-weight: 700;">--</div>
                                <div style="font-size: 12px; opacity: 0.8;">DAYS</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="countdownWeeks" style="font-size: 36px; font-weight: 700;">--</div>
                                <div style="font-size: 12px; opacity: 0.8;">WEEKS</div>
                            </div>
                        </div>
                        <div id="seasonCalendarPreview" style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 8px;">📅 Your Season</div>
                            <div id="seasonDates" style="font-size: 14px; opacity: 0.9;">June 1 - October 3, 2026</div>
                            <div id="seasonWeeksTotal" style="font-size: 14px; opacity: 0.9; margin-top: 4px;">18 weeks of fresh produce</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Renewal Prompt (shows in final 5 weeks) -->
            <div class="section" id="renewalSection" style="display: none;">
                <div class="box-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                    <div style="text-align: center; padding: 20px;">
                        <div id="renewalIcon" style="font-size: 48px; margin-bottom: 12px;">🍂</div>
                        <h3 id="renewalTitle" style="margin: 0 0 8px 0;">5 Weeks Left!</h3>
                        <p id="renewalSubtitle" style="margin: 0 0 16px 0; opacity: 0.9;">Continue the harvest with our Fall & Winter CSA</p>
                        <button class="btn" style="background: white; color: #d97706;" onclick="showRenewalOptions()">
                            <i class="fas fa-leaf"></i> <span id="renewalButtonText">View Fall Options</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- This Week's Box -->
            <div class="section" id="currentBoxSection">
                <div class="section-header">
                    <h2 class="section-title">This Week's Box</h2>
                    <button class="section-action" onclick="viewBoxDetails()">View Details</button>
                </div>

                <div class="box-card" id="currentBoxCard">
                    <div class="box-photo" id="boxPhoto">📦</div>

                    <div class="box-header">
                        <div>
                            <div class="box-week" id="boxWeek">Week of Jan 21</div>
                            <div class="box-pickup" id="boxPickup">
                                <i class="fas fa-map-marker-alt"></i>
                                Pickup: Tuesday, 4-7pm
                            </div>
                        </div>
                        <span class="box-status ready" id="boxStatus">Ready</span>
                    </div>

                    <div class="box-deadline" id="boxDeadline" style="display: none;">
                        <i class="fas fa-clock"></i>
                        <span>Customize by Wednesday 5pm</span>
                        <span class="countdown" id="deadlineCountdown">2 days left</span>
                    </div>

                    <div class="box-items" id="boxItems">
                        <!-- Skeleton loading -->
                        <div class="box-item">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="box-item-info">
                                <div class="skeleton skeleton-text" style="width: 120px;"></div>
                                <div class="skeleton skeleton-text" style="width: 60px;"></div>
                            </div>
                        </div>
                        <div class="box-item">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="box-item-info">
                                <div class="skeleton skeleton-text" style="width: 100px;"></div>
                                <div class="skeleton skeleton-text" style="width: 50px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="box-footer">
                        <button class="btn btn-secondary" onclick="showVacationHolds()">
                            <i class="fas fa-calendar-minus"></i>
                            Skip Week
                        </button>
                        <button class="btn btn-primary" onclick="openCustomizeModal()">
                            <i class="fas fa-magic"></i>
                            Customize Box
                        </button>
                    </div>
                </div>
            </div>

            <!-- Farmer Updates -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">From the Field</h2>
                    <button class="section-action" onclick="viewAllUpdates()">See All</button>
                </div>

                <div class="updates-feed" id="updatesFeed">
                    <div class="update-card">
                        <div class="update-image" style="display: flex; align-items: center; justify-content: center; font-size: 48px;">🌱</div>
                        <div class="update-content">
                            <div class="update-text">Tomato seedlings are thriving in the greenhouse! Can't wait for you to taste these heirlooms this summer.</div>
                            <div class="update-meta">
                                <div class="update-avatar">T</div>
                                <span>Todd • Jan 18</span>
                            </div>
                        </div>
                    </div>
                    <div class="update-card">
                        <div class="update-image" style="display: flex; align-items: center; justify-content: center; font-size: 48px;">❄️</div>
                        <div class="update-content">
                            <div class="update-text">Winter cover crops protecting the soil for spring planting. Nature's blanket!</div>
                            <div class="update-meta">
                                <div class="update-avatar">T</div>
                                <span>Todd • Jan 15</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Boxes -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Upcoming Weeks</h2>
                </div>
                <div class="upcoming-list" id="upcomingList">
                    <!-- Skeleton loading -->
                    <div class="upcoming-card">
                        <div>
                            <div class="skeleton skeleton-text" style="width: 120px;"></div>
                            <div class="skeleton skeleton-text" style="width: 180px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vacation Tab -->
        <div class="tab-content" id="tab-vacation">
            <div class="page-header">
                <h1>Vacation Holds</h1>
                <p style="color: var(--text-secondary); margin-top: 4px;">Schedule time off from your CSA</p>
            </div>

            <div class="section">
                <div class="vacation-section">
                    <div class="vacation-header">
                        <div class="vacation-title">Available Holds</div>
                        <div class="vacation-remaining">
                            <strong id="holdsRemaining">2</strong> of <span id="holdsTotal">3</span> remaining
                        </div>
                    </div>

                    <div class="vacation-weeks" id="vacationWeeks">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="settings-card">
                    <div class="settings-title">How Holds Work</div>
                    <ul style="color: var(--text-secondary); font-size: 14px; padding-left: 20px; line-height: 1.8;">
                        <li><strong id="holdLimitText">Large shares get 3 holds, small shares get 1</strong></li>
                        <li>Schedule at least 5 days before pickup</li>
                        <li>Choose what happens to your box:</li>
                    </ul>
                    <div class="hold-options-info">
                        <div class="hold-option-card">
                            <div class="hold-option-icon">🎁</div>
                            <div class="hold-option-text">
                                <strong>Donate</strong>
                                <span>Your box goes to a local food bank (Spring & Winter CSA only)</span>
                            </div>
                        </div>
                        <div class="hold-option-card">
                            <div class="hold-option-icon">💳</div>
                            <div class="hold-option-text">
                                <strong>Flex Funds Credit</strong>
                                <span>Receive credit to use at markets or online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hold Options Modal -->
        <div class="modal-overlay" id="holdOptionsModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Schedule Hold for <span id="holdModalDate">Jan 28</span></h3>
                    <button class="modal-close" onclick="closeHoldModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        What would you like us to do with your box?
                    </p>

                    <div class="hold-choice" id="holdChoiceDonate" onclick="selectHoldChoice('donate')">
                        <div class="hold-choice-radio"></div>
                        <div class="hold-choice-content">
                            <div class="hold-choice-icon">🎁</div>
                            <div class="hold-choice-text">
                                <strong>Donate to Food Bank</strong>
                                <span>Help feed families in need</span>
                            </div>
                        </div>
                    </div>

                    <div class="hold-choice" id="holdChoiceCredit" onclick="selectHoldChoice('credit')">
                        <div class="hold-choice-radio"></div>
                        <div class="hold-choice-content">
                            <div class="hold-choice-icon">💳</div>
                            <div class="hold-choice-text">
                                <strong>Flex Funds Credit</strong>
                                <span>Add credit to your account balance</span>
                            </div>
                        </div>
                    </div>

                    <div id="donateSeasonWarning" class="season-warning" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        Donations are only available during Spring and Winter CSA seasons.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeHoldModal()">Cancel</button>
                    <button class="btn btn-primary" id="confirmHoldBtn" onclick="confirmHold()" disabled>Confirm Hold</button>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-content" id="tab-orders">
            <div class="page-header">
                <h1>Pickup History</h1>
            </div>
            <div class="orders-list" id="ordersList">
                <!-- Skeleton loading -->
                <div class="order-card">
                    <div class="skeleton skeleton-text" style="width: 100px;"></div>
                    <div class="skeleton skeleton-text" style="width: 80px; margin-top: 8px;"></div>
                    <div class="skeleton skeleton-text" style="width: 200px; margin-top: 12px;"></div>
                </div>
            </div>
        </div>

        <!-- Account Tab -->
        <div class="tab-content" id="tab-account">
            <div class="page-header">
                <h1>My Account</h1>
            </div>

            <div class="settings-section">
                <div class="settings-card">
                    <div class="settings-title">Membership Details</div>
                    <div class="settings-row">
                        <span class="settings-label">Share Type</span>
                        <span class="settings-value" id="accountShareType">--</span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Season</span>
                        <span class="settings-value" id="accountSeason">--</span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Weeks Remaining</span>
                        <span class="settings-value" id="accountWeeks">--</span>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-title" style="display: flex; justify-content: space-between; align-items: center;">
                        Pickup Info
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openEditPickupModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Day</span>
                        <span class="settings-value" id="accountPickupDay">--</span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Location</span>
                        <span class="settings-value" id="accountPickupLocation">--</span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Time</span>
                        <span class="settings-value" id="accountPickupTime">--</span>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-title" style="display: flex; justify-content: space-between; align-items: center;">
                        Contact Info
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openEditContactModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Name</span>
                        <span class="settings-value" id="accountName">--</span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Email</span>
                        <span class="settings-value" id="accountEmail">--</span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Phone</span>
                        <span class="settings-value" id="accountPhone">--</span>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-title">Preferences</div>
                    <div class="settings-link" onclick="showNotificationSettings()">
                        <span>Notification Settings</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="settings-link" onclick="showDislikesSettings()">
                        <span>Item Preferences</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>

                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sign Out
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('home')">
                <i class="fas fa-home"></i>
                Home
            </button>
            <button class="nav-item" onclick="switchTab('vacation')">
                <i class="fas fa-calendar-minus"></i>
                Holds
            </button>
            <button class="nav-item" onclick="switchTab('orders')">
                <i class="fas fa-history"></i>
                History
            </button>
            <button class="nav-item" onclick="switchTab('account')">
                <i class="fas fa-user"></i>
                Account
            </button>
        </nav>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════
         ENHANCED SWAP MODAL
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="swapModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Swap Item</h2>
                <button class="modal-close" onclick="closeSwapModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="swap-current">
                    <div class="swap-current-emoji" id="swapCurrentEmoji">🥬</div>
                    <div>
                        <div class="swap-current-label">SWAPPING OUT</div>
                        <div class="swap-current-name" id="swapCurrentName">--</div>
                    </div>
                </div>

                <div class="swap-section-title">
                    <i class="fas fa-fire"></i>
                    Popular Swaps
                </div>
                <div class="swap-options" id="popularSwaps">
                    <!-- Populated dynamically -->
                </div>

                <div class="swap-section-title">Other Options</div>
                <div class="swap-options" id="otherSwaps">
                    <!-- Populated dynamically -->
                </div>

                <label class="swap-remember">
                    <input type="checkbox" id="rememberSwap">
                    <div class="checkbox"><i class="fas fa-check"></i></div>
                    <div class="swap-remember-text">Remember this swap for future boxes</div>
                </label>
            </div>
            <div class="modal-footer">
                <button class="confirm-swap-btn" id="confirmSwapBtn" onclick="confirmSwap()" disabled>
                    <i class="fas fa-exchange-alt"></i>
                    Confirm Swap (Uses 1 Credit)
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════
         NOTIFICATION SETTINGS MODAL
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="notificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Notifications</h2>
                <button class="modal-close" onclick="closeNotificationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="notification-group">
                    <div class="notification-group-title">Pickup Reminders</div>
                    <div class="notification-item">
                        <span class="notification-label">Day before pickup</span>
                        <div class="settings-toggle active" onclick="toggleNotification(this)" data-key="reminder_day_before"></div>
                    </div>
                    <div class="notification-item">
                        <span class="notification-label">Day of pickup</span>
                        <div class="settings-toggle active" onclick="toggleNotification(this)" data-key="reminder_day_of"></div>
                    </div>
                </div>

                <div class="notification-group">
                    <div class="notification-group-title">Box Updates</div>
                    <div class="notification-item">
                        <span class="notification-label">When box contents finalized</span>
                        <div class="settings-toggle active" onclick="toggleNotification(this)" data-key="box_finalized"></div>
                    </div>
                    <div class="notification-item">
                        <span class="notification-label">Customization deadline reminder</span>
                        <div class="settings-toggle active" onclick="toggleNotification(this)" data-key="customize_deadline"></div>
                    </div>
                </div>

                <div class="notification-group">
                    <div class="notification-group-title">Farm News</div>
                    <div class="notification-item">
                        <span class="notification-label">Weekly farm updates</span>
                        <div class="settings-toggle" onclick="toggleNotification(this)" data-key="farm_updates"></div>
                    </div>
                    <div class="notification-item">
                        <span class="notification-label">Special offers</span>
                        <div class="settings-toggle" onclick="toggleNotification(this)" data-key="special_offers"></div>
                    </div>
                </div>

                <div class="notification-group">
                    <div class="notification-group-title">How to Reach You</div>
                    <div class="comm-method-selector">
                        <div class="comm-method active" onclick="selectCommMethod(this)" data-method="email">
                            <i class="fas fa-envelope"></i>
                            <span>Email Only</span>
                        </div>
                        <div class="comm-method" onclick="selectCommMethod(this)" data-method="both">
                            <i class="fas fa-bell"></i>
                            <span>Email + SMS</span>
                        </div>
                        <div class="comm-method" onclick="selectCommMethod(this)" data-method="sms">
                            <i class="fas fa-sms"></i>
                            <span>SMS Only</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveNotificationSettings()" style="width: 100%;">
                    Save Preferences
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Pickup Modal -->
    <div class="modal-overlay" id="editPickupModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Pickup Details</h2>
                <button class="modal-close" onclick="closeEditPickupModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Pickup Day</label>
                    <select class="form-input" id="editPickupDay">
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Saturday">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Pickup Location</label>
                    <select class="form-input" id="editPickupLocation">
                        <option value="Farm - Zelienople">Farm - Zelienople</option>
                        <option value="Lawrenceville Farmers Market">Lawrenceville Farmers Market</option>
                        <option value="Bloomfield Saturday Market">Bloomfield Saturday Market</option>
                        <option value="East Liberty">East Liberty</option>
                        <option value="Sewickley">Sewickley</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px; display: flex; gap: 12px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditPickupModal()">Cancel</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="savePickupDetails()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Contact Modal -->
    <div class="modal-overlay" id="editContactModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Contact Info</h2>
                <button class="modal-close" onclick="closeEditContactModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="editName" placeholder="Your name">
                </div>

                <div style="background: var(--bg-subtle); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">
                        <i class="fas fa-envelope" style="margin-right: 8px; color: var(--primary);"></i>Email Addresses
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label" style="font-size: 12px; color: var(--text-secondary);">Primary Email (Login)</label>
                        <input type="email" class="form-input" id="editPrimaryEmail" readonly style="background: var(--bg-card); opacity: 0.7; cursor: not-allowed;">
                        <small style="color: var(--text-secondary); font-size: 11px;">Contact us to change your login email</small>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 12px; color: var(--text-secondary);">Secondary Email (Optional)</label>
                        <input type="email" class="form-input" id="editSecondaryEmail" placeholder="partner@email.com">
                        <small style="color: var(--text-secondary); font-size: 11px;">Household member or backup</small>
                    </div>
                </div>

                <div style="background: var(--bg-subtle); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">
                        <i class="fas fa-phone" style="margin-right: 8px; color: var(--primary);"></i>Phone Numbers
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label" style="font-size: 12px; color: var(--text-secondary);">Primary Phone</label>
                        <input type="tel" class="form-input" id="editPhone" placeholder="(412) 555-1234">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 12px; color: var(--text-secondary);">Secondary Phone (Optional)</label>
                        <input type="tel" class="form-input" id="editSecondaryPhone" placeholder="(412) 555-5678">
                        <small style="color: var(--text-secondary); font-size: 11px;">Household member or backup</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="editAddress" placeholder="Street address">
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" class="form-input" id="editCity" placeholder="City">
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px; display: flex; gap: 12px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditContactModal()">Cancel</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="saveContactDetails()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- API Configuration -->
    <script src="api-config.js"></script>

    <script>
        // ═══════════════════════════════════════════════════════════════════════════
        // APP STATE
        // ═══════════════════════════════════════════════════════════════════════════

        const AppState = {
            customer: null,
            membership: null,
            currentBox: null,
            upcomingBoxes: [],
            vacationHolds: [],
            orders: [],
            preferences: {
                dislikes: [],
                notifications: {
                    reminder_day_before: true,
                    reminder_day_of: true,
                    box_finalized: true,
                    customize_deadline: true,
                    farm_updates: false,
                    special_offers: false
                },
                commMethod: 'email'
            },
            swappingItem: null,
            selectedSwap: null,
            isOnboarded: true,
            onboardingStep: 1
        };

        const API_URL = window.TINY_SEED_API?.MAIN_API ||
            'https://script.google.com/macros/s/AKfycbwS36-nKIb1cc6l7AQmnM24Ynx_yluuN-_ZMZr5VRGK7ZpqqemMvXGArvzKS3TlHYCb/exec';

        // ═══════════════════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════════════════

        document.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            setupPullToRefresh();
            await checkAuth();
        }

        async function checkAuth() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const email = params.get('email');

            if (token && email) {
                await verifyMagicLink(token, email);
                return;
            }

            const saved = localStorage.getItem('tsf_csa_session');
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    AppState.customer = session.customer;
                    AppState.membership = session.membership;
                    AppState.preferences = session.preferences || AppState.preferences;
                    AppState.isOnboarded = session.isOnboarded !== false;

                    if (!AppState.isOnboarded) {
                        showOnboarding();
                    } else {
                        showApp();
                    }
                } catch (e) {
                    showLogin();
                }
            } else {
                showLogin();
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // AUTHENTICATION
        // ═══════════════════════════════════════════════════════════════════════════

        async function sendMagicLink() {
            console.log('sendMagicLink called');
            const email = document.getElementById('emailInput').value.trim();
            console.log('Email:', email);

            if (!email) {
                showToast('Please enter your email', 'error');
                return;
            }

            const btn = document.getElementById('sendLinkBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Sending...';

            try {
                const url = `${API_URL}?action=sendCSAMagicLink&email=${encodeURIComponent(email)}`;
                console.log('Fetching:', url);

                const response = await fetch(url);
                console.log('Response status:', response.status);

                const result = await response.json();
                console.log('Result:', result);

                if (result.success) {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('magicLinkSent').style.display = 'block';
                    document.getElementById('sentToEmail').textContent = email;
                    showToast('Magic link sent! Check your email.', 'success');
                } else {
                    showToast(result.error || 'Email not found in our system', 'error');
                }
            } catch (error) {
                console.error('Magic link error:', error);
                showToast('Connection error: ' + error.message, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Login Link';
        }

        async function verifyMagicLink(token, email) {
            try {
                const response = await fetch(`${API_URL}?action=verifyCSAMagicLink&token=${encodeURIComponent(token)}&email=${encodeURIComponent(email)}`);
                const result = await response.json();

                if (result.success) {
                    AppState.customer = result.customer;
                    AppState.membership = result.csaMembership;
                    AppState.isOnboarded = result.csaMembership?.Is_Onboarded === true;

                    saveSession();
                    window.history.replaceState({}, '', window.location.pathname);

                    if (!AppState.isOnboarded) {
                        showOnboarding();
                    } else {
                        showApp();
                        showToast('Welcome back!', 'success');
                    }
                } else {
                    showToast(result.error || 'Invalid or expired link', 'error');
                    showLogin();
                }
            } catch (error) {
                console.error('Verify error:', error);
                showToast('Connection error', 'error');
                showLogin();
            }
        }

        function saveSession() {
            localStorage.setItem('tsf_csa_session', JSON.stringify({
                customer: AppState.customer,
                membership: AppState.membership,
                preferences: AppState.preferences,
                isOnboarded: AppState.isOnboarded
            }));
        }

        function resetLogin() {
            document.getElementById('loginTabs').style.display = 'flex';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('phoneLoginForm').style.display = 'none';
            document.getElementById('smsCodeForm').style.display = 'none';
            document.getElementById('magicLinkSent').style.display = 'none';
            document.getElementById('emailInput').value = '';
            // Reset to email tab
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.login-tab[data-method="email"]').classList.add('active');
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // SMS LOGIN
        // ═══════════════════════════════════════════════════════════════════════════

        let smsLoginPhone = '';

        function switchLoginMethod(method) {
            // Update tabs
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.login-tab[data-method="${method}"]`).classList.add('active');

            // Show/hide forms
            document.getElementById('loginForm').style.display = method === 'email' ? 'block' : 'none';
            document.getElementById('phoneLoginForm').style.display = method === 'phone' ? 'block' : 'none';
            document.getElementById('smsCodeForm').style.display = 'none';
            document.getElementById('magicLinkSent').style.display = 'none';
        }

        async function sendSMSCode() {
            const phone = document.getElementById('phoneInput').value.trim();
            if (!phone) {
                showToast('Please enter your phone number', 'error');
                return;
            }

            const btn = document.getElementById('sendCodeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>';

            try {
                const response = await fetch(`${API_URL}?action=sendCSASMSCode&phone=${encodeURIComponent(phone)}`);
                const result = await response.json();

                if (result.success) {
                    smsLoginPhone = phone;
                    document.getElementById('loginTabs').style.display = 'none';
                    document.getElementById('phoneLoginForm').style.display = 'none';
                    document.getElementById('smsCodeForm').style.display = 'block';
                    document.getElementById('sentToPhone').textContent = formatPhoneDisplay(phone);
                    document.getElementById('smsCodeInput').focus();
                    showToast('Code sent!', 'success');

                    // For dev/testing - if code is returned, show it
                    if (result._devCode) {
                        console.log('DEV MODE - Code:', result._devCode);
                        showToast(`Dev mode - Code: ${result._devCode}`, 'info');
                    }
                } else {
                    showToast(result.error || 'Failed to send code', 'error');
                }
            } catch (error) {
                console.error('SMS code error:', error);
                showToast('Connection error. Please try again.', 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sms"></i> Send Verification Code';
        }

        async function verifySMSCode() {
            const code = document.getElementById('smsCodeInput').value.trim();
            if (!code || code.length !== 6) {
                showToast('Please enter the 6-digit code', 'error');
                return;
            }

            const btn = document.getElementById('verifyCodeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>';

            try {
                const response = await fetch(`${API_URL}?action=verifyCSASMSCode&phone=${encodeURIComponent(smsLoginPhone)}&code=${encodeURIComponent(code)}`);
                const result = await response.json();

                if (result.success) {
                    AppState.customer = result.customer;
                    AppState.membership = result.membership;
                    AppState.preferences = result.preferences || { dislikes: [] };
                    AppState.isOnboarded = result.membership.isOnboarded;

                    saveSession();

                    if (!AppState.isOnboarded) {
                        showOnboarding();
                    } else {
                        showDashboard();
                    }

                    showToast(`Welcome back, ${result.customer.name.split(' ')[0]}!`, 'success');
                } else {
                    showToast(result.error || 'Invalid code', 'error');
                }
            } catch (error) {
                console.error('Verify code error:', error);
                showToast('Connection error. Please try again.', 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Verify Code';
        }

        function resetPhoneLogin() {
            document.getElementById('loginTabs').style.display = 'flex';
            document.getElementById('phoneLoginForm').style.display = 'block';
            document.getElementById('smsCodeForm').style.display = 'none';
            document.getElementById('phoneInput').value = '';
            document.getElementById('smsCodeInput').value = '';
            smsLoginPhone = '';
        }

        function formatPhoneDisplay(phone) {
            const digits = phone.replace(/\D/g, '').slice(-10);
            if (digits.length === 10) {
                return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
            }
            return phone;
        }

        function logout() {
            localStorage.removeItem('tsf_csa_session');
            AppState.customer = null;
            AppState.membership = null;
            showLogin();
            showToast('Signed out', 'info');
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // ONBOARDING
        // ═══════════════════════════════════════════════════════════════════════════

        function showOnboarding() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('onboardingScreen').classList.add('active');

            // Populate with user data - Order Confirmation
            const fullName = AppState.customer?.Contact_Name || AppState.membership?.Name || 'Member';
            document.getElementById('onboardingFullName').textContent = fullName;
            document.getElementById('onboardingEmail').textContent =
                AppState.customer?.Email || AppState.membership?.Email || '';
            document.getElementById('onboardingShare').textContent =
                AppState.membership?.Share_Type || 'Vegetable Share';
            document.getElementById('onboardingSeason').textContent =
                AppState.membership?.Season || '2026';
            document.getElementById('onboardingLocation').textContent =
                AppState.membership?.Pickup_Location || 'Farm Stand';

            // Show address if delivery
            const address = AppState.membership?.Address || AppState.customer?.Address;
            if (address) {
                document.getElementById('onboardingAddressRow').style.display = 'flex';
                const fullAddress = [
                    address,
                    AppState.membership?.City,
                    AppState.membership?.State,
                    AppState.membership?.Zip
                ].filter(Boolean).join(', ');
                document.getElementById('onboardingAddress').textContent = fullAddress || address;
            }

            updateOnboardingStep();
        }

        function updateOnboardingStep() {
            // Update progress dots
            document.querySelectorAll('.progress-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i + 1 === AppState.onboardingStep) {
                    dot.classList.add('active');
                } else if (i + 1 < AppState.onboardingStep) {
                    dot.classList.add('completed');
                }
            });

            // Show/hide steps
            document.querySelectorAll('.onboarding-step').forEach((step, i) => {
                step.classList.remove('active');
                if (i + 1 === AppState.onboardingStep) {
                    step.classList.add('active');
                }
            });

            // Update buttons
            const backBtn = document.getElementById('onboardingBack');
            const nextBtn = document.getElementById('onboardingNext');

            backBtn.style.display = AppState.onboardingStep > 1 ? 'flex' : 'none';
            nextBtn.textContent = AppState.onboardingStep === 4 ? 'Get Started' : 'Continue';

            // Update header text
            const titles = [
                'Welcome to the Family!',
                'Quick Preferences',
                'Stay Connected',
                "You're All Set!"
            ];
            const subtitles = [
                "Here's what you ordered",
                'Any veggies to skip?',
                'Choose how we reach you',
                'Your CSA journey begins now'
            ];

            document.getElementById('onboardingTitle').textContent = titles[AppState.onboardingStep - 1];
            document.getElementById('onboardingSubtitle').textContent = subtitles[AppState.onboardingStep - 1];
        }

        function nextOnboardingStep() {
            if (AppState.onboardingStep === 4) {
                completeOnboarding();
                return;
            }

            AppState.onboardingStep++;
            updateOnboardingStep();

            // Handle SMS checkbox showing phone field
            if (AppState.onboardingStep === 3) {
                document.getElementById('commSMS').addEventListener('change', (e) => {
                    document.getElementById('phoneGroup').style.display = e.target.checked ? 'block' : 'none';
                });
            }
        }

        function prevOnboardingStep() {
            if (AppState.onboardingStep > 1) {
                AppState.onboardingStep--;
                updateOnboardingStep();
            }
        }

        function togglePreference(el) {
            el.classList.toggle('selected');
        }

        async function completeOnboarding() {
            // Collect preferences - now using free-text input
            const skipVeggiesText = document.getElementById('skipVeggiesInput').value.trim();
            // Parse comma-separated or newline-separated items
            const dislikes = skipVeggiesText
                ? skipVeggiesText.split(/[,\n]+/).map(s => s.trim()).filter(Boolean)
                : [];

            const emailPref = document.getElementById('commEmail').checked;
            const smsPref = document.getElementById('commSMS').checked;
            const phone = document.getElementById('phoneInput').value;

            AppState.preferences.dislikes = dislikes;
            AppState.preferences.skipVeggiesText = skipVeggiesText; // Store raw text too
            AppState.preferences.commMethod = smsPref ? (emailPref ? 'both' : 'sms') : 'email';
            AppState.isOnboarded = true;

            // Show confetti
            createConfetti();

            // Save to backend
            try {
                await fetch(`${API_URL}?action=updateCSAMemberPreferences`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        memberId: AppState.membership?.Member_ID,
                        preferences: AppState.preferences,
                        phone: phone,
                        isOnboarded: true
                    })
                });
            } catch (e) {
                console.log('Preferences save deferred');
            }

            saveSession();

            // Wait for confetti, then show app
            setTimeout(() => {
                document.getElementById('onboardingScreen').classList.remove('active');
                showApp();
                showToast('Welcome to Tiny Seed Farm! 🌱', 'success');
            }, 2000);
        }

        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#22c55e', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'];

            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '100vh';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = 2 + Math.random() * 2 + 's';
                container.appendChild(confetti);
            }

            setTimeout(() => container.innerHTML = '', 4000);
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // UI CONTROL
        // ═══════════════════════════════════════════════════════════════════════════

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('onboardingScreen').classList.remove('active');
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('onboardingScreen').classList.remove('active');
            document.getElementById('appContainer').classList.add('active');

            updateUI();
            loadSocialPosts();
            loadFlexBalance();
            loadBoxContents();
            loadOrders();
            loadVacationHolds();
            checkAlerts();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.closest('.nav-item').classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        function updateUI() {
            const c = AppState.customer || {};
            const m = AppState.membership || {};

            // Home tab
            document.getElementById('memberName').textContent = c.Contact_Name?.split(' ')[0] || 'Member';
            document.getElementById('shareType').textContent = `${m.Share_Size || 'Regular'} ${m.Share_Type || 'Vegetable'} Share`;
            document.getElementById('weeksRemaining').textContent = m.Weeks_Remaining || '--';
            document.getElementById('swapCredits').textContent = m.Swap_Credits ?? '--';
            document.getElementById('boxesReceived').textContent =
                m.Total_Weeks && m.Weeks_Remaining ? (m.Total_Weeks - m.Weeks_Remaining) : '--';

            // Account tab
            document.getElementById('accountName').textContent = c.Contact_Name || '--';
            document.getElementById('accountEmail').textContent = c.Email || '--';
            document.getElementById('accountPhone').textContent = c.Phone || '--';
            document.getElementById('accountShareType').textContent = `${m.Share_Size || ''} ${m.Share_Type || ''}`.trim() || '--';
            document.getElementById('accountSeason').textContent = m.Season || '--';
            document.getElementById('accountWeeks').textContent = m.Weeks_Remaining || '--';
            document.getElementById('accountPickupDay').textContent = m.Pickup_Day || '--';
            document.getElementById('accountPickupLocation').textContent = m.Pickup_Location || '--';
            document.getElementById('accountPickupTime').textContent = m.Pickup_Time || '4-7pm';

            // Season Status Logic
            updateSeasonStatus(m);
        }

        // Season date mappings for 2026
        const CSA_SEASON_DATES = {
            'Summer': {
                start: new Date('2026-06-01'),
                end: new Date('2026-10-15'),
                weeks: 20,
                icon: '🌻',
                nextSeason: 'Fall'
            },
            'Fall': {
                start: new Date('2026-10-15'),
                end: new Date('2026-12-15'),
                weeks: 9,
                icon: '🍂',
                nextSeason: 'Winter'
            },
            'Winter': {
                start: new Date('2026-01-01'),
                end: new Date('2026-03-31'),
                weeks: 13,
                icon: '❄️',
                nextSeason: 'Summer'
            },
            'Spring': {
                start: new Date('2026-04-01'),
                end: new Date('2026-05-31'),
                weeks: 9,
                icon: '🌸',
                nextSeason: 'Summer'
            }
        };

        function getSeasonDates(membership) {
            // First try explicit Start_Date and End_Date from membership
            if (membership.Start_Date && membership.End_Date) {
                return {
                    startDate: new Date(membership.Start_Date),
                    endDate: new Date(membership.End_Date),
                    totalWeeks: membership.Total_Weeks || membership.Weeks || '--'
                };
            }

            // Fall back to Season field mapping
            const season = membership.Season || '';
            const seasonKey = Object.keys(CSA_SEASON_DATES).find(
                s => season.toLowerCase().includes(s.toLowerCase())
            );

            if (seasonKey && CSA_SEASON_DATES[seasonKey]) {
                const seasonData = CSA_SEASON_DATES[seasonKey];
                return {
                    startDate: seasonData.start,
                    endDate: seasonData.end,
                    totalWeeks: membership.Total_Weeks || membership.Weeks || seasonData.weeks,
                    icon: seasonData.icon,
                    nextSeason: seasonData.nextSeason
                };
            }

            return null;
        }

        function updateSeasonStatus(membership) {
            const now = new Date();
            const seasonSection = document.getElementById('seasonStatusSection');
            const boxSection = document.getElementById('currentBoxSection');
            const renewalSection = document.getElementById('renewalSection');

            // Get season dates from membership or Season field
            const seasonInfo = getSeasonDates(membership);

            if (!seasonInfo) {
                // No dates set and no recognizable Season - show box section with current week
                seasonSection.style.display = 'none';
                boxSection.style.display = 'block';
                renewalSection.style.display = 'none';
                // Set box week to current week
                updateBoxWeekDisplay(now);
                return;
            }

            const { startDate, endDate, totalWeeks, icon, nextSeason } = seasonInfo;

            // Calculate days until start or weeks remaining
            const daysUntilStart = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
            const daysUntilEnd = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            const weeksRemaining = Math.ceil(daysUntilEnd / 7);

            if (daysUntilStart > 0) {
                // SEASON HASN'T STARTED YET - Show pre-season banner
                seasonSection.style.display = 'block';
                boxSection.style.display = 'none';
                renewalSection.style.display = 'none';

                const weeksUntil = Math.ceil(daysUntilStart / 7);
                document.getElementById('seasonIcon').textContent = icon || '🌱';
                document.getElementById('seasonTitle').textContent = 'Your Season Starts Soon!';

                // Build descriptive subtitle
                const seasonName = membership.Season || 'CSA';
                const shareType = membership.Share_Type || '';
                const description = shareType ? `${seasonName} ${shareType}` : seasonName;
                document.getElementById('seasonSubtitle').textContent = `${description} begins ${formatDateNice(startDate)}`;

                document.getElementById('countdownDays').textContent = daysUntilStart;
                document.getElementById('countdownWeeks').textContent = weeksUntil;
                document.getElementById('seasonDates').textContent = `${formatDateNice(startDate)} - ${formatDateNice(endDate)}`;
                document.getElementById('seasonWeeksTotal').textContent = `${totalWeeks} weeks of fresh produce`;
                document.getElementById('seasonCountdown').style.display = 'flex';

                // Update box display to show "Coming Soon" if box section were visible
                document.getElementById('boxWeek').textContent = `Starts ${formatDateNice(startDate)}`;
                document.getElementById('boxPickup').innerHTML = `<i class="fas fa-calendar"></i> ${daysUntilStart} days until first pickup`;

            } else if (weeksRemaining <= 5 && weeksRemaining > 0) {
                // FINAL 5 WEEKS - Show countdown + renewal prompt
                seasonSection.style.display = 'none';
                boxSection.style.display = 'block';

                // Check if they already have the next season's CSA
                const hasFallWinter = checkHasFallWinterCSA(membership, nextSeason);
                renewalSection.style.display = hasFallWinter ? 'none' : 'block';

                if (!hasFallWinter) {
                    document.getElementById('renewalTitle').textContent = `${weeksRemaining} Week${weeksRemaining !== 1 ? 's' : ''} Left!`;

                    // Update renewal section with next season info
                    const renewalIcons = { 'Fall': '🍂', 'Winter': '❄️', 'Summer': '🌻', 'Spring': '🌸' };
                    document.getElementById('renewalIcon').textContent = renewalIcons[nextSeason] || '🌱';
                    document.getElementById('renewalSubtitle').textContent = `Continue the harvest with our ${nextSeason} CSA`;
                    document.getElementById('renewalButtonText').textContent = `View ${nextSeason} Options`;
                }

                // Update box week to current week date
                updateBoxWeekDisplay(now);

            } else if (daysUntilEnd < 0) {
                // SEASON ENDED
                seasonSection.style.display = 'block';
                boxSection.style.display = 'none';
                renewalSection.style.display = 'none';

                document.getElementById('seasonIcon').textContent = '🍂';
                document.getElementById('seasonTitle').textContent = 'Season Complete!';
                document.getElementById('seasonSubtitle').textContent = 'Thank you for being a member this season!';
                document.getElementById('seasonCountdown').style.display = 'none';

                // Show renewal info
                document.getElementById('seasonDates').textContent = `Your ${membership.Season || 'CSA'} season has ended`;
                document.getElementById('seasonWeeksTotal').textContent = 'Check below for upcoming seasons';

            } else {
                // SEASON IS ACTIVE - Show normal box view
                seasonSection.style.display = 'none';
                boxSection.style.display = 'block';
                renewalSection.style.display = 'none';

                // Update box week to current week date
                updateBoxWeekDisplay(now);
            }
        }

        function updateBoxWeekDisplay(currentDate) {
            // Calculate the current week's pickup date (Tuesday)
            const d = new Date(currentDate);
            const dayOfWeek = d.getDay();
            // Get the Tuesday of current week (Tuesday = 2)
            const daysToTuesday = (2 - dayOfWeek + 7) % 7;
            // If today is after Tuesday, show this week's Tuesday, otherwise show upcoming Tuesday
            if (dayOfWeek > 2) {
                d.setDate(d.getDate() - (dayOfWeek - 2));
            } else {
                d.setDate(d.getDate() + daysToTuesday);
            }
            const weekDateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            document.getElementById('boxWeek').textContent = `Week of ${weekDateStr}`;
        }

        function formatDateNice(date) {
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        function checkHasFallWinterCSA(membership, nextSeason) {
            // Check if the member's Season field indicates they already have fall/winter
            const currentSeason = (membership?.Season || '').toLowerCase();

            // If they have multiple seasons listed (e.g., "Summer + Fall" or "Year-Round")
            if (currentSeason.includes('year') || currentSeason.includes('annual')) {
                return true; // Year-round members don't need renewal prompt
            }

            // Check for explicit fall/winter in their current membership
            if (currentSeason.includes('fall') && currentSeason.includes('winter')) {
                return true;
            }

            // If next season is Fall and they already have Fall
            if (nextSeason === 'Fall' && currentSeason.includes('fall')) {
                return true;
            }

            // If next season is Winter and they already have Winter
            if (nextSeason === 'Winter' && currentSeason.includes('winter')) {
                return true;
            }

            // Check membership data for additional shares (if stored)
            if (membership?.Additional_Shares) {
                const additionalShares = (membership.Additional_Shares || '').toLowerCase();
                if (nextSeason === 'Fall' && additionalShares.includes('fall')) {
                    return true;
                }
                if (nextSeason === 'Winter' && additionalShares.includes('winter')) {
                    return true;
                }
            }

            return false;
        }

        function showRenewalOptions() {
            // Determine which season to suggest based on current membership
            const membership = AppState.membership || {};
            const seasonInfo = getSeasonDates(membership);
            const nextSeason = seasonInfo?.nextSeason || 'Fall';

            const seasonMessages = {
                'Fall': 'Opening Fall CSA options...',
                'Winter': 'Opening Winter CSA options...',
                'Summer': 'Opening Summer CSA options...',
                'Spring': 'Opening Spring CSA options...'
            };

            showToast(seasonMessages[nextSeason] || 'Opening CSA options...', 'info');
            // Open Shopify CSA collection
            window.open('https://tiny-seed-farmers-market.myshopify.com/collections/csa', '_blank');
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // SMART ALERTS
        // ═══════════════════════════════════════════════════════════════════════════

        function checkAlerts() {
            // Check for customization deadline
            const deadlineHours = 48; // Demo: 48 hours until deadline

            if (deadlineHours <= 24) {
                showAlert('urgent', `Customization closes in ${deadlineHours} hours!`, 'Customize', () => openCustomizeModal());
            } else if (AppState.membership?.Swap_Credits > 2) {
                showAlert('info', `You have ${AppState.membership.Swap_Credits} unused swap credits`, 'Use Now', () => openCustomizeModal());
            }
        }

        function showAlert(type, text, actionText, actionFn) {
            const banner = document.getElementById('alertBanner');
            banner.className = `alert-banner ${type}`;
            document.getElementById('alertText').textContent = text;

            const actionBtn = document.getElementById('alertAction');
            actionBtn.textContent = actionText;
            actionBtn.onclick = actionFn;

            banner.style.display = 'flex';
        }

        function dismissAlert() {
            document.getElementById('alertBanner').style.display = 'none';
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // FLEX FUNDS BALANCE - Digital Clock Style at Top
        // ═══════════════════════════════════════════════════════════════════════════

        async function loadFlexBalance() {
            const flexBanner = document.getElementById('flexFundsBanner');

            // ALWAYS show Flex Funds banner for ALL users
            flexBanner.style.display = 'block';

            const amountEl = document.querySelector('.flex-clock-amount');
            const centsEl = document.querySelector('.flex-clock-cents');

            try {
                const email = AppState.membership?.Email;
                if (!email) {
                    // No email yet - show zero in red
                    updateFlexDisplay(0, amountEl, centsEl);
                    return;
                }

                const response = await fetch(`${API_URL}?action=getFlexBalance&email=${encodeURIComponent(email)}`);
                const result = await response.json();

                if (result.success) {
                    const balance = parseFloat(result.balance || 0);
                    updateFlexDisplay(balance, amountEl, centsEl);
                    AppState.flexBalance = balance;
                    AppState.flexGiftCards = result.giftCards || [];
                } else {
                    updateFlexDisplay(0, amountEl, centsEl);
                    AppState.flexBalance = 0;
                }
            } catch (error) {
                console.log('Error loading flex balance:', error);
                updateFlexDisplay(0, amountEl, centsEl);
            }
        }

        function updateFlexDisplay(balance, amountEl, centsEl) {
            const dollars = Math.floor(balance);
            const cents = Math.round((balance - dollars) * 100).toString().padStart(2, '0');

            document.getElementById('flexBalanceDollars').textContent = dollars;
            document.getElementById('flexBalanceCents').textContent = cents;

            // Green when money, red when zero
            if (balance <= 0) {
                amountEl.classList.add('zero');
                centsEl.classList.add('zero');
            } else {
                amountEl.classList.remove('zero');
                centsEl.classList.remove('zero');
            }
        }

        async function purchaseFlexFunds() {
            const email = AppState.membership?.Email;
            if (!email) {
                showToast('Please log in to add funds', 'error');
                return;
            }

            const btn = document.querySelector('.flex-add-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;

            try {
                // Get checkout URL from backend
                const response = await fetch(`${API_URL}?action=getFlexCheckoutUrl&email=${encodeURIComponent(email)}&amount=50`);
                const result = await response.json();

                if (result.success && result.checkoutUrl) {
                    showToast('Redirecting to checkout...', 'info');
                    // Redirect to Shopify checkout
                    window.location.href = result.checkoutUrl;
                } else {
                    showToast(result.error || 'Failed to start checkout', 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.log('Error starting checkout:', error);
                showToast('Failed to start checkout. Please try again.', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function toggleFlexHistory() {
            const modal = document.getElementById('flexHistoryModal');
            const isVisible = modal.style.display !== 'none';

            if (isVisible) {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
                loadFlexTransactions();
            }
        }

        async function loadFlexTransactions() {
            const listEl = document.getElementById('flexTransactionsList');
            const email = AppState.membership?.Email;

            if (!email) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Please log in to view history</div>';
                return;
            }

            listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading...</div>';

            try {
                const response = await fetch(`${API_URL}?action=getFlexTransactions&email=${encodeURIComponent(email)}`);
                const result = await response.json();

                if (result.success && result.transactions?.length > 0) {
                    listEl.innerHTML = result.transactions.map(tx => {
                        const date = new Date(tx.timestamp);
                        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        const typeLabel = tx.type === 'ADMIN_CREDIT' ? 'Credit Added' :
                                          tx.type === 'PURCHASE' ? 'Funds Added' :
                                          tx.type === 'SPENT' ? 'Spent' : tx.type;
                        const isCredit = tx.type !== 'SPENT';

                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border-color);">
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${typeLabel}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">${dateStr}</div>
                                    ${tx.reason ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${tx.reason}</div>` : ''}
                                </div>
                                <div style="font-weight: 600; font-size: 16px; color: ${isCredit ? '#22c55e' : '#ef4444'};">
                                    ${isCredit ? '+' : '-'}$${Math.abs(tx.amount).toFixed(2)}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    listEl.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);"><div style="font-size: 32px; margin-bottom: 8px;">💳</div>No transactions yet<br><small>Add funds or earn credits to get started</small></div>';
                }
            } catch (error) {
                console.log('Error loading transactions:', error);
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Failed to load history</div>';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // SOCIAL MEDIA CAROUSEL
        // ═══════════════════════════════════════════════════════════════════════════

        async function loadSocialPosts() {
            const container = document.getElementById('socialThumbs');

            try {
                const response = await fetch(`${API_URL}?action=getRecentSocialPosts`);
                const result = await response.json();

                if (result.success && result.posts?.length > 0) {
                    renderSocialThumbs(result.posts);
                } else {
                    // No posts available - hide the section gracefully
                    const socialStrip = document.querySelector('.social-strip');
                    if (socialStrip) {
                        socialStrip.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load social posts:', error);
                // Hide the social section on error
                const socialStrip = document.querySelector('.social-strip');
                if (socialStrip) {
                    socialStrip.style.display = 'none';
                }
            }
        }

        function renderSocialThumbs(posts) {
            const container = document.getElementById('socialThumbs');
            container.innerHTML = posts.slice(0, 5).map(post => `
                <div class="social-thumb" onclick="window.open('https://instagram.com/tinyseedfarm', '_blank')">
                    <img src="${post.image}" alt="Farm" onerror="this.src='https://images.unsplash.com/photo-1500651230702-0e2d8a49d4ad?w=200&h=200&fit=crop'">
                    <div class="social-thumb-overlay">
                        <i class="fab fa-${post.platform || 'instagram'}"></i>
                    </div>
                </div>
            `).join('');
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // DISPUTE FORM FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════

        function showDisputeForm() {
            document.getElementById('disputeModal').style.display = 'flex';
        }

        function hideDisputeForm() {
            document.getElementById('disputeModal').style.display = 'none';
            document.getElementById('disputeText').value = '';
        }

        async function submitDispute() {
            const disputeText = document.getElementById('disputeText').value.trim();

            if (!disputeText) {
                showToast('Please describe what needs to be corrected', 'error');
                return;
            }

            try {
                const email = AppState.membership?.Email;
                const name = AppState.membership?.Name || '';

                // Send dispute notification to farm
                const response = await fetch(`${API_URL}?action=submitCSADispute`, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: email,
                        name: name,
                        dispute: disputeText,
                        memberData: {
                            shareType: AppState.membership?.Share_Type,
                            season: AppState.membership?.Season,
                            pickupLocation: AppState.membership?.Pickup_Location
                        }
                    })
                });

                hideDisputeForm();
                showToast('Thanks! We\'ll review and get back to you shortly.', 'success');

            } catch (error) {
                console.log('Error submitting dispute:', error);
                hideDisputeForm();
                showToast('Received! We\'ll be in touch soon.', 'success');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // BOX CONTENTS
        // ═══════════════════════════════════════════════════════════════════════════

        async function loadBoxContents() {
            try {
                const response = await fetch(`${API_URL}?action=getBoxContents&shareType=${encodeURIComponent(AppState.membership?.Share_Type || '')}`);
                const result = await response.json();

                if (result.success && result.items) {
                    AppState.currentBox = result;
                    renderBoxItems(result.items);
                    document.getElementById('boxWeek').textContent = `Week of ${formatWeekDate(result.weekDate)}`;
                } else {
                    showEmptyBoxState();
                }
            } catch (error) {
                console.error('Failed to load box contents:', error);
                showBoxError();
            }
        }

        function showEmptyBoxState() {
            const container = document.getElementById('boxItems');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📦</div>
                    <div class="empty-state-title">No Box Contents Yet</div>
                    <div class="empty-state-text">Your box contents will be available closer to your pickup date.</div>
                </div>
            `;
        }

        function showBoxError() {
            const container = document.getElementById('boxItems');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">⚠️</div>
                    <div class="empty-state-title">Unable to Load Box Contents</div>
                    <div class="empty-state-text">Please check your connection and try again.</div>
                    <button class="btn btn-primary btn-sm" onclick="loadBoxContents()" style="margin-top: 16px;">
                        <i class="fas fa-refresh"></i> Retry
                    </button>
                </div>
            `;
        }

        function renderBoxItems(items) {
            const container = document.getElementById('boxItems');
            const credits = AppState.membership?.Swap_Credits || 0;
            const dislikes = AppState.preferences?.dislikes || [];

            container.innerHTML = items.map(item => {
                const isDisliked = dislikes.some(d => item.Product_Name.toLowerCase().includes(d.toLowerCase()));

                return `
                    <div class="box-item animate-in">
                        <div class="box-item-emoji">${item.emoji || '🥬'}</div>
                        <div class="box-item-info">
                            <div class="box-item-name">${item.Product_Name}</div>
                            <div class="box-item-qty">${item.Quantity} ${item.Unit}</div>
                            ${isDisliked ? '<div class="box-item-note">Consider swapping - you marked this as a dislike</div>' : ''}
                        </div>
                        <div class="box-item-actions">
                            ${item.Is_Swappable ? `
                                <button class="swap-btn" onclick="openSwapModal('${item.Product_Name}', '${item.emoji}')" ${credits <= 0 ? 'disabled title="No swap credits"' : ''}>
                                    Swap
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUpcomingBoxes(boxes) {
            document.getElementById('upcomingList').innerHTML = boxes.map(box => `
                <div class="upcoming-card ${box.isHold ? 'hold' : ''}" onclick="viewUpcomingBox('${box.date}')">
                    <div>
                        <div class="upcoming-date">${box.date} - ${box.week}</div>
                        <div class="upcoming-preview">${box.isHold ? 'Vacation Hold Scheduled' : box.items}</div>
                    </div>
                    <span class="upcoming-badge ${box.isHold ? 'hold' : ''}">${box.isHold ? 'On Hold' : box.status === 'upcoming' ? 'Coming Soon' : 'Planned'}</span>
                </div>
            `).join('');
        }

        function formatWeekDate(dateStr) {
            if (!dateStr) {
                const d = new Date();
                d.setDate(d.getDate() + (2 - d.getDay() + 7) % 7);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // SWAP FUNCTIONALITY (ENHANCED)
        // ═══════════════════════════════════════════════════════════════════════════

        function openSwapModal(itemName, emoji = '🥬') {
            AppState.swappingItem = itemName;
            AppState.selectedSwap = null;

            document.getElementById('swapCurrentName').textContent = itemName;
            document.getElementById('swapCurrentEmoji').textContent = emoji;
            document.getElementById('confirmSwapBtn').disabled = true;

            // Enhanced swap options with popularity
            const popularOptions = [
                { name: 'Extra Salad Mix', emoji: '🥬', popularity: 75, available: true },
                { name: 'Herb Sampler', emoji: '🌿', popularity: 15, available: true }
            ];

            const otherOptions = [
                { name: 'Spinach Bundle', emoji: '🥬', available: true },
                { name: 'Kale Bundle', emoji: '🥬', available: true },
                { name: 'Root Veggie Mix', emoji: '🥕', available: true },
                { name: 'Extra Tomatoes', emoji: '🍅', available: true, limited: true }
            ];

            document.getElementById('popularSwaps').innerHTML = popularOptions.map(opt => `
                <div class="swap-option ${!opt.available ? 'disabled' : ''}" onclick="${opt.available ? `selectSwap('${opt.name}', '${opt.emoji}')` : ''}">
                    <div class="swap-option-emoji">${opt.emoji}</div>
                    <div class="swap-option-info">
                        <div class="swap-option-name">${opt.name}</div>
                        <div class="swap-option-meta">
                            <span class="swap-popularity"><i class="fas fa-fire"></i> ${opt.popularity}% choose this</span>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('otherSwaps').innerHTML = otherOptions.map(opt => `
                <div class="swap-option ${!opt.available ? 'disabled' : ''}" onclick="${opt.available ? `selectSwap('${opt.name}', '${opt.emoji}')` : ''}">
                    <div class="swap-option-emoji">${opt.emoji}</div>
                    <div class="swap-option-info">
                        <div class="swap-option-name">${opt.name}</div>
                        <div class="swap-option-meta">
                            ${opt.limited ? '<span class="swap-limited">Limited!</span>' : '<span>Available</span>'}
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('swapModal').classList.add('open');
        }

        function closeSwapModal() {
            document.getElementById('swapModal').classList.remove('open');
        }

        function selectSwap(name, emoji) {
            AppState.selectedSwap = { name, emoji };

            document.querySelectorAll('.swap-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.swap-option').classList.add('selected');
            document.getElementById('confirmSwapBtn').disabled = false;
        }

        async function confirmSwap() {
            if (!AppState.selectedSwap) return;

            const btn = document.getElementById('confirmSwapBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Processing...';

            try {
                const response = await fetch(`${API_URL}?action=customizeCSABox`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        memberId: AppState.membership?.Member_ID,
                        weekDate: AppState.currentBox?.weekDate,
                        swaps: [{ from: AppState.swappingItem, to: AppState.selectedSwap.name }],
                        remember: document.getElementById('rememberSwap').checked
                    })
                });
                const result = await response.json();

                if (result.success) {
                    AppState.membership.Swap_Credits = result.creditsRemaining;
                    updateUI();
                    showToast('Box customized! 🎉', 'success');
                    closeSwapModal();
                    loadBoxContents();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Failed to confirm swap:', error);
                showToast('Failed to process swap. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-exchange-alt"></i> Confirm Swap (Uses 1 Credit)';
            }
        }

        function openCustomizeModal() {
            showToast('Opening full customization...', 'info');
            // Could open a more comprehensive customization view
        }

        function viewBoxDetails() {
            showToast('Box details', 'info');
        }

        function viewUpcomingBox(date) {
            showToast(`Viewing box for ${date}`, 'info');
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // VACATION HOLDS - Donate OR Flex Funds Credit
        // ═══════════════════════════════════════════════════════════════════════════

        // Hold state
        let selectedHoldDate = null;
        let selectedHoldChoice = null;

        function showVacationHolds() {
            switchTab('vacation');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[1].classList.add('active');
        }

        // Get max holds based on share size
        function getMaxHolds() {
            const shareType = (AppState.membership?.Share_Type || '').toLowerCase();
            // Large shares: Full, Family = 3 holds
            // Small shares: Single, Half, Couple = 1 hold
            if (shareType.includes('full') || shareType.includes('family')) {
                return 3;
            }
            return 1;
        }

        // Check if current season allows donations (Spring/Winter only)
        function isDonationSeasonAllowed() {
            const season = (AppState.membership?.Season || '').toLowerCase();
            const month = new Date().getMonth(); // 0-11

            // Spring: March-May (2-4), Winter: Dec-Feb (11, 0, 1)
            if (season.includes('spring') || season.includes('winter')) {
                return true;
            }
            // Also check by current month if no season info
            if (month <= 1 || month === 11 || (month >= 2 && month <= 4)) {
                return true;
            }
            return false; // Summer/Fall - no donations
        }

        async function loadVacationHolds() {
            const maxHolds = getMaxHolds();

            // Update UI to show limits
            document.getElementById('holdsTotal').textContent = maxHolds;
            document.getElementById('holdLimitText').innerHTML = maxHolds === 3
                ? '<strong>Large shares</strong> get 3 holds per season'
                : '<strong>Small shares</strong> get 1 hold per season';

            // Generate upcoming weeks for hold options
            const weeks = [];
            const today = new Date();

            for (let i = 1; i <= 6; i++) {
                const weekDate = new Date(today);
                weekDate.setDate(today.getDate() + (i * 7));
                weeks.push({
                    date: weekDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    week: `Week ${10 + i}`,
                    fullDate: weekDate.toISOString().split('T')[0],
                    isHold: i === 3, // Demo: one already scheduled
                    holdType: i === 3 ? 'credit' : null // Demo: show what type was selected
                });
            }

            AppState.vacationHolds = weeks.filter(w => w.isHold);
            const holdsUsed = AppState.vacationHolds.length;
            document.getElementById('holdsRemaining').textContent = maxHolds - holdsUsed;

            renderVacationWeeks(weeks);
        }

        function renderVacationWeeks(weeks) {
            const maxHolds = getMaxHolds();
            const holdsUsed = AppState.vacationHolds.length;
            const canScheduleMore = holdsUsed < maxHolds;

            document.getElementById('vacationWeeks').innerHTML = weeks.map(week => `
                <div class="vacation-week ${week.isHold ? 'on-hold' : ''}">
                    <div class="vacation-week-info">
                        <div class="vacation-week-date">${week.date} - ${week.week}</div>
                        <div class="vacation-week-label">${week.isHold
                            ? (week.holdType === 'donate' ? 'Donating to Food Bank' : 'Flex Funds Credit')
                            : 'Regular Pickup'}</div>
                    </div>
                    ${week.isHold
                        ? `<button class="vacation-btn cancel" onclick="cancelHold('${week.fullDate}')">Cancel</button>`
                        : `<button class="vacation-btn schedule" onclick="openHoldModal('${week.fullDate}', '${week.date}')" ${!canScheduleMore ? 'disabled' : ''}>
                            ${canScheduleMore ? 'Schedule Hold' : 'Limit Reached'}
                           </button>`
                    }
                </div>
            `).join('');
        }

        function openHoldModal(weekDate, displayDate) {
            selectedHoldDate = weekDate;
            selectedHoldChoice = null;

            document.getElementById('holdModalDate').textContent = displayDate;

            // Reset selections
            document.querySelectorAll('.hold-choice').forEach(el => el.classList.remove('selected'));
            document.getElementById('confirmHoldBtn').disabled = true;

            // Check donation availability
            const donateChoice = document.getElementById('holdChoiceDonate');
            const warning = document.getElementById('donateSeasonWarning');

            if (isDonationSeasonAllowed()) {
                donateChoice.classList.remove('disabled');
                warning.style.display = 'none';
            } else {
                donateChoice.classList.add('disabled');
                warning.style.display = 'flex';
            }

            document.getElementById('holdOptionsModal').style.display = 'flex';
        }

        function closeHoldModal() {
            document.getElementById('holdOptionsModal').style.display = 'none';
            selectedHoldDate = null;
            selectedHoldChoice = null;
        }

        function selectHoldChoice(choice) {
            // Don't allow donate if not in season
            if (choice === 'donate' && !isDonationSeasonAllowed()) {
                return;
            }

            selectedHoldChoice = choice;

            // Update UI
            document.querySelectorAll('.hold-choice').forEach(el => el.classList.remove('selected'));
            document.getElementById(choice === 'donate' ? 'holdChoiceDonate' : 'holdChoiceCredit').classList.add('selected');
            document.getElementById('confirmHoldBtn').disabled = false;
        }

        async function confirmHold() {
            if (!selectedHoldDate || !selectedHoldChoice) return;

            const btn = document.getElementById('confirmHoldBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_URL}?action=scheduleVacationHold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        memberId: AppState.membership?.Member_ID,
                        email: AppState.membership?.Email,
                        weekDate: selectedHoldDate,
                        holdType: selectedHoldChoice // 'donate' or 'credit'
                    })
                });
                const result = await response.json();

                closeHoldModal();

                if (result.success || true) { // Demo always succeeds
                    const message = selectedHoldChoice === 'donate'
                        ? 'Hold scheduled! Your box will be donated.'
                        : 'Hold scheduled! Credit added to your Flex Funds.';
                    showToast(message, 'success');

                    // If credit, refresh flex balance
                    if (selectedHoldChoice === 'credit') {
                        loadFlexBalance();
                    }

                    loadVacationHolds();
                }
            } catch (error) {
                closeHoldModal();
                // Demo mode
                const message = selectedHoldChoice === 'donate'
                    ? 'Hold scheduled! Your box will be donated.'
                    : 'Hold scheduled! Credit will be added to your account.';
                showToast(message, 'success');
                loadVacationHolds();
            }
        }

        async function cancelHold(weekDate) {
            try {
                const response = await fetch(`${API_URL}?action=cancelVacationHold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        memberId: AppState.membership?.Member_ID,
                        weekDate: weekDate
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showToast('Hold cancelled', 'success');
                    loadVacationHolds();
                }
            } catch (error) {
                showToast('Hold cancelled', 'success');
                loadVacationHolds();
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // ORDERS
        // ═══════════════════════════════════════════════════════════════════════════

        async function loadOrders() {
            const container = document.getElementById('ordersList');

            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 12px; color: var(--text-secondary);">Loading pickup history...</div>
                </div>
            `;

            try {
                const response = await fetch(`${API_URL}?action=getCSAPickupHistory&customerId=${AppState.customer?.Customer_ID}`);
                const result = await response.json();

                if (result.success) {
                    AppState.orders = result.orders || [];
                    renderOrders();
                } else {
                    showEmptyOrders();
                }
            } catch (error) {
                console.error('Failed to load pickup history:', error);
                showOrdersError();
            }
        }

        function showEmptyOrders() {
            const container = document.getElementById('ordersList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📦</div>
                    <div class="empty-state-title">No Pickup History Yet</div>
                    <div class="empty-state-text">Your pickup history will appear here once you start receiving boxes.</div>
                </div>
            `;
        }

        function showOrdersError() {
            const container = document.getElementById('ordersList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">⚠️</div>
                    <div class="empty-state-title">Unable to Load Pickup History</div>
                    <div class="empty-state-text">Please check your connection and try again.</div>
                    <button class="btn btn-primary btn-sm" onclick="loadOrders()" style="margin-top: 16px;">
                        <i class="fas fa-refresh"></i> Retry
                    </button>
                </div>
            `;
        }

        function renderOrders() {
            const container = document.getElementById('ordersList');

            if (AppState.orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📦</div>
                        <div class="empty-state-title">No pickups yet</div>
                        <div class="empty-state-text">Your pickup history will appear here</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = AppState.orders.map(order => {
                const statusClass = order.Status?.toLowerCase().replace(' ', '-') || 'pending';
                return `
                    <div class="order-card animate-in">
                        <div class="order-header">
                            <div>
                                <div class="order-id">${order.Order_ID}</div>
                                <div class="order-date">${formatDate(order.date)}</div>
                            </div>
                            <span class="order-status ${statusClass}">${order.Status}</span>
                        </div>
                        <div class="order-items">${order.items}</div>
                    </div>
                `;
            }).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '--';
            return new Date(dateStr).toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // NOTIFICATION SETTINGS
        // ═══════════════════════════════════════════════════════════════════════════

        // ═══════════════════════════════════════════════════════════════════════════
        // EDIT PROFILE MODALS
        // ═══════════════════════════════════════════════════════════════════════════

        function openEditPickupModal() {
            const m = AppState.membership || {};
            document.getElementById('editPickupDay').value = m.Pickup_Day || 'Tuesday';
            document.getElementById('editPickupLocation').value = m.Pickup_Location || 'Farm - Zelienople';
            document.getElementById('editPickupModal').style.display = 'flex';
        }

        function closeEditPickupModal() {
            document.getElementById('editPickupModal').style.display = 'none';
        }

        async function savePickupDetails() {
            const day = document.getElementById('editPickupDay').value;
            const location = document.getElementById('editPickupLocation').value;

            try {
                const response = await fetch(`${API_URL}?action=updateCSAMemberPreferences`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        memberId: AppState.membership?.Member_ID,
                        pickupDay: day,
                        pickupLocation: location
                    })
                });
                const result = await response.json();

                if (result.success) {
                    AppState.membership.Pickup_Day = day;
                    AppState.membership.Pickup_Location = location;
                    updateUI();
                    closeEditPickupModal();
                    showToast('Pickup details updated!', 'success');
                } else {
                    showToast(result.error || 'Failed to update', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        function openEditContactModal() {
            const c = AppState.customer || {};
            const m = AppState.membership || {};
            document.getElementById('editName').value = c.Contact_Name || '';
            document.getElementById('editPrimaryEmail').value = m.Email || c.Email || '';
            document.getElementById('editSecondaryEmail').value = c.Secondary_Email || '';
            document.getElementById('editPhone').value = c.Phone || '';
            document.getElementById('editSecondaryPhone').value = c.Secondary_Phone || '';
            document.getElementById('editAddress').value = c.Address || '';
            document.getElementById('editCity').value = c.City || '';
            document.getElementById('editContactModal').style.display = 'flex';
        }

        function closeEditContactModal() {
            document.getElementById('editContactModal').style.display = 'none';
        }

        async function saveContactDetails() {
            const name = document.getElementById('editName').value;
            const secondaryEmail = document.getElementById('editSecondaryEmail').value;
            const phone = document.getElementById('editPhone').value;
            const secondaryPhone = document.getElementById('editSecondaryPhone').value;
            const address = document.getElementById('editAddress').value;
            const city = document.getElementById('editCity').value;

            try {
                const response = await fetch(`${API_URL}?action=updateCSAMemberPreferences`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        memberId: AppState.membership?.Member_ID,
                        customerId: AppState.customer?.Customer_ID,
                        contactName: name,
                        secondaryEmail: secondaryEmail,
                        phone: phone,
                        secondaryPhone: secondaryPhone,
                        address: address,
                        city: city
                    })
                });
                const result = await response.json();

                if (result.success) {
                    AppState.customer.Contact_Name = name;
                    AppState.customer.Secondary_Email = secondaryEmail;
                    AppState.customer.Phone = phone;
                    AppState.customer.Secondary_Phone = secondaryPhone;
                    AppState.customer.Address = address;
                    AppState.customer.City = city;
                    updateUI();
                    closeEditContactModal();
                    showToast('Contact info updated!', 'success');
                } else {
                    showToast(result.error || 'Failed to update', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        function showNotificationSettings() {
            // Restore current settings to UI
            Object.entries(AppState.preferences.notifications).forEach(([key, value]) => {
                const toggle = document.querySelector(`[data-key="${key}"]`);
                if (toggle) {
                    toggle.classList.toggle('active', value);
                }
            });

            document.querySelectorAll('.comm-method').forEach(el => {
                el.classList.toggle('active', el.dataset.method === AppState.preferences.commMethod);
            });

            document.getElementById('notificationModal').classList.add('open');
        }

        function closeNotificationModal() {
            document.getElementById('notificationModal').classList.remove('open');
        }

        function toggleNotification(el) {
            el.classList.toggle('active');
        }

        function selectCommMethod(el) {
            document.querySelectorAll('.comm-method').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
        }

        async function saveNotificationSettings() {
            // Collect settings from UI
            document.querySelectorAll('.notification-item .settings-toggle').forEach(toggle => {
                const key = toggle.dataset.key;
                AppState.preferences.notifications[key] = toggle.classList.contains('active');
            });

            const activeMethod = document.querySelector('.comm-method.active');
            AppState.preferences.commMethod = activeMethod?.dataset.method || 'email';

            saveSession();

            try {
                await fetch(`${API_URL}?action=updateCSAMemberPreferences`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        memberId: AppState.membership?.Member_ID,
                        preferences: AppState.preferences
                    })
                });
            } catch (e) {
                console.log('Preferences saved locally');
            }

            closeNotificationModal();
            showToast('Preferences saved', 'success');
        }

        function showDislikesSettings() {
            showToast('Opening item preferences...', 'info');
        }

        function contactFarm() {
            showToast('Opening contact form...', 'info');
        }

        function viewAllUpdates() {
            showToast('Opening farm updates...', 'info');
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // PULL TO REFRESH
        // ═══════════════════════════════════════════════════════════════════════════

        function setupPullToRefresh() {
            let touchStart = 0;
            let touchY = 0;
            const pullIndicator = document.getElementById('pullIndicator');
            const threshold = 80;

            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    touchStart = e.touches[0].clientY;
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (touchStart === 0) return;

                touchY = e.touches[0].clientY - touchStart;

                if (touchY > 0 && touchY < threshold * 2) {
                    pullIndicator.classList.add('visible');
                    pullIndicator.style.transform = `translateX(-50%) translateY(${Math.min(touchY / 2, 40)}px)`;
                }
            });

            document.addEventListener('touchend', () => {
                if (touchY > threshold) {
                    pullIndicator.classList.add('refreshing');
                    refreshData();
                }

                setTimeout(() => {
                    pullIndicator.classList.remove('visible', 'refreshing');
                    pullIndicator.style.transform = '';
                }, 500);

                touchStart = 0;
                touchY = 0;
            });
        }

        async function refreshData() {
            await Promise.all([
                loadBoxContents(),
                loadOrders(),
                loadVacationHolds()
            ]);
            showToast('Updated!', 'success');
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // TOAST NOTIFICATIONS
        // ═══════════════════════════════════════════════════════════════════════════

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            toast.innerHTML = `<i class="fas ${icons[type]}"></i> ${message}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('[SW] Registered'))
                .catch(err => console.log('[SW] Registration failed:', err));
        }
    </script>
</body>
</html>
