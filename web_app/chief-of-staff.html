<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chief of Staff - Tiny Seed Farm</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Modern color palette - better contrast */
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #1f2a48;
      --bg-card-hover: #283555;
      --bg-input: #0f1629;
      --bg-elevated: #243354;

      /* High contrast text */
      --text-primary: #f5f5f5;
      --text-secondary: #b8c5d6;
      --text-muted: #8899a8;
      --text-dim: #667788;

      /* Borders */
      --border-color: #2a3f5f;
      --border-light: #344968;
      --border-focus: #5b8def;

      /* Vibrant accents */
      --accent-green: #4ade80;
      --accent-green-dim: #22c55e;
      --accent-blue: #60a5fa;
      --accent-purple: #a78bfa;
      --accent-amber: #fbbf24;
      --accent-red: #f87171;
      --accent-teal: #2dd4bf;

      /* Priority colors */
      --critical: #f87171;
      --critical-bg: rgba(248, 113, 113, 0.15);
      --high: #fb923c;
      --high-bg: rgba(251, 146, 60, 0.15);
      --medium: #fbbf24;
      --medium-bg: rgba(251, 191, 36, 0.15);
      --low: #4ade80;
      --low-bg: rgba(74, 222, 128, 0.15);

      /* Shadows */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.25);
      --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.35);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.45);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Layout */
    .app-container {
      display: grid;
      grid-template-columns: 1fr 440px;
      grid-template-rows: auto 1fr;
      height: 100vh;
      gap: 0;
    }

    @media (max-width: 1200px) {
      .app-container {
        grid-template-columns: 1fr;
      }
      .chat-panel {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        width: 100%;
        max-width: 440px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 100;
      }
      .chat-panel.open {
        transform: translateX(0);
      }
      .mobile-chat-toggle {
        display: flex !important;
      }
    }

    /* Header */
    .header {
      grid-column: 1 / -1;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: -0.02em;
    }

    .header h1 span {
      font-size: 28px;
    }

    .header-stats {
      display: flex;
      gap: 24px;
    }

    .header-stat {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .header-stat .count {
      background: var(--bg-card);
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 13px;
      border: 1px solid var(--border-color);
    }

    .header-stat .count.critical {
      color: var(--critical);
      background: var(--critical-bg);
      border-color: var(--critical);
    }
    .header-stat .count.high {
      color: var(--high);
      background: var(--high-bg);
      border-color: var(--high);
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* Buttons */
    .btn {
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      letter-spacing: -0.01em;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-dim) 100%);
      color: #0a1628;
      box-shadow: 0 2px 12px rgba(74, 222, 128, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(74, 222, 128, 0.4);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-light);
    }

    /* Mobile chat toggle */
    .mobile-chat-toggle {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-teal) 100%);
      color: #0a1628;
      border: none;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      z-index: 99;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    /* Main Panel */
    .main-panel {
      overflow-y: auto;
      padding: 28px;
      background: var(--bg-primary);
    }

    /* Tabs - More prominent */
    .tabs {
      display: flex;
      gap: 6px;
      background: var(--bg-secondary);
      padding: 6px;
      border-radius: 14px;
      margin-bottom: 28px;
      border: 1px solid var(--border-color);
    }

    .tab {
      padding: 14px 24px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.01em;
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .tab.active {
      background: var(--bg-elevated);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }

    .tab-badge {
      background: var(--critical);
      color: white;
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 12px;
      font-weight: 700;
      min-width: 24px;
      text-align: center;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 500;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
    }

    .filter-chip:hover {
      border-color: var(--accent-green);
      color: var(--text-primary);
    }

    .filter-chip.active {
      background: var(--accent-green);
      color: #0a1628;
      border-color: var(--accent-green);
      font-weight: 600;
    }

    /* Priority Groups */
    .priority-group {
      margin-bottom: 32px;
    }

    .priority-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .priority-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 0 8px currentColor;
    }

    .priority-dot.critical { background: var(--critical); color: var(--critical); }
    .priority-dot.high { background: var(--high); color: var(--high); }
    .priority-dot.medium { background: var(--medium); color: var(--medium); }
    .priority-dot.low { background: var(--low); color: var(--low); }

    .priority-header h3 {
      font-size: 16px;
      font-weight: 700;
      flex: 1;
      letter-spacing: -0.01em;
    }

    .priority-header .count {
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Message Card - Better readability */
    .message-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 18px 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .message-card:hover {
      border-color: var(--accent-green);
      background: var(--bg-card-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .message-card.selected {
      border-color: var(--accent-green);
      background: rgba(74, 222, 128, 0.08);
      box-shadow: 0 0 0 1px var(--accent-green);
    }

    .message-header {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 10px;
    }

    .message-type {
      font-size: 22px;
      line-height: 1;
    }

    .message-meta {
      flex: 1;
    }

    .message-from {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .message-time {
      font-size: 13px;
      color: var(--text-muted);
    }

    .message-subject {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }

    .message-summary {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.6;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .message-tags {
      display: flex;
      gap: 8px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .message-tag {
      font-size: 12px;
      padding: 5px 12px;
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-weight: 500;
    }

    .message-tag.intent { background: rgba(96, 165, 250, 0.2); color: var(--accent-blue); }
    .message-tag.sentiment-positive { background: rgba(74, 222, 128, 0.2); color: var(--accent-green); }
    .message-tag.sentiment-negative { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); }
    .message-tag.commitment { background: rgba(251, 191, 36, 0.2); color: var(--accent-amber); }

    /* Reclassify Dropdown */
    .reclassify-menu {
      position: absolute;
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 8px 0;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      display: none;
      min-width: 160px;
    }

    .reclassify-menu.show { display: block; }

    .reclassify-option {
      padding: 12px 18px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-primary);
    }

    .reclassify-option:hover { background: var(--bg-card-hover); }

    /* Chat Panel - Featured prominently */
    .chat-panel {
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 16px;
      background: linear-gradient(180deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
    }

    .chat-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-teal) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3);
    }

    .chat-title h2 {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .chat-title p {
      font-size: 13px;
      color: var(--accent-green);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-title p::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chat-message {
      max-width: 90%;
    }

    .chat-message.user {
      align-self: flex-end;
    }

    .chat-message.assistant {
      align-self: flex-start;
    }

    .chat-bubble {
      padding: 14px 18px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.6;
    }

    .chat-message.user .chat-bubble {
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-dim) 100%);
      color: #0a1628;
      border-bottom-right-radius: 6px;
    }

    .chat-message.assistant .chat-bubble {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 6px;
      color: var(--text-primary);
    }

    .chat-bubble p { margin-bottom: 10px; }
    .chat-bubble p:last-child { margin-bottom: 0; }
    .chat-bubble ul { margin: 10px 0; padding-left: 20px; }
    .chat-bubble li { margin-bottom: 6px; color: var(--text-secondary); }
    .chat-bubble code {
      background: rgba(0,0,0,0.3);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .chat-time {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 6px;
      padding: 0 6px;
    }

    /* Quick Actions - More prominent */
    .quick-actions {
      display: flex;
      gap: 10px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-color);
      overflow-x: auto;
      background: var(--bg-secondary);
    }

    .quick-action {
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      color: var(--text-secondary);
    }

    .quick-action:hover {
      border-color: var(--accent-green);
      background: var(--bg-card-hover);
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    .quick-action:active {
      transform: translateY(0);
    }

    /* Chat Input */
    .chat-input-area {
      padding: 20px 24px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      background: var(--bg-input);
      border: 2px solid var(--border-color);
      border-radius: 14px;
      padding: 14px 18px;
      font-size: 15px;
      color: var(--text-primary);
      resize: none;
      font-family: inherit;
      min-height: 52px;
      max-height: 140px;
      transition: border-color 0.2s ease;
    }

    .chat-input::placeholder {
      color: var(--text-muted);
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--accent-green);
      box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.15);
    }

    .chat-send {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-dim) 100%);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s ease;
      box-shadow: 0 2px 12px rgba(74, 222, 128, 0.3);
    }

    .chat-send:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(74, 222, 128, 0.4);
    }

    .chat-send:disabled {
      background: var(--bg-card);
      cursor: not-allowed;
      box-shadow: none;
    }

    .chat-send svg {
      width: 22px;
      height: 22px;
      color: #0a1628;
    }

    /* Action Queue Cards */
    .action-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--accent-amber);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 14px;
      transition: all 0.2s ease;
    }

    .action-card:hover {
      background: var(--bg-card-hover);
      transform: translateY(-1px);
    }

    .action-card.critical { border-left-color: var(--critical); }
    .action-card.high { border-left-color: var(--high); }

    .action-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .action-contact {
      font-size: 16px;
      font-weight: 600;
    }

    .action-score {
      font-size: 13px;
      font-weight: 600;
      padding: 5px 12px;
      background: var(--bg-secondary);
      border-radius: 16px;
      color: var(--text-secondary);
    }

    .action-description {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .action-rationale {
      font-size: 14px;
      color: var(--text-muted);
      font-style: italic;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .action-btn {
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .action-btn.complete {
      background: var(--accent-green);
      color: #0a1628;
    }

    .action-btn.complete:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(74, 222, 128, 0.3);
    }

    .action-btn.dismiss {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .action-btn.dismiss:hover {
      background: var(--bg-elevated);
    }

    /* Commitments */
    .commitment-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 14px;
      transition: all 0.2s ease;
    }

    .commitment-card:hover {
      background: var(--bg-card-hover);
    }

    .commitment-card.overdue {
      border-color: var(--critical);
      background: var(--critical-bg);
    }

    .commitment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .commitment-type {
      font-size: 12px;
      padding: 5px 12px;
      border-radius: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .commitment-type.mine {
      background: rgba(96, 165, 250, 0.2);
      color: var(--accent-blue);
    }

    .commitment-type.theirs {
      background: rgba(167, 139, 250, 0.2);
      color: var(--accent-purple);
    }

    .commitment-deadline {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .commitment-deadline.overdue {
      color: var(--critical);
      font-weight: 700;
    }

    .commitment-contact {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .commitment-text {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      color: var(--text-muted);
      font-size: 14px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 56px;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .empty-state p {
      font-size: 16px;
      color: var(--text-secondary);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 14px 24px;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      font-weight: 500;
      font-size: 15px;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success { border-left: 4px solid var(--accent-green); }
    .toast.error { border-left: 4px solid var(--accent-red); }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 5px;
      padding: 14px 18px;
      align-items: center;
    }

    .typing-indicator span {
      width: 10px;
      height: 10px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 100% { opacity: 0.3; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-6px); }
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 85vh;
      overflow: auto;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
      padding: 4px;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body { padding: 24px; }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .extracted-task {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .extracted-task input[type="checkbox"] {
      margin-top: 4px;
      width: 18px;
      height: 18px;
      accent-color: var(--accent-green);
    }

    .extracted-task-text {
      flex: 1;
      font-size: 15px;
      color: var(--text-primary);
    }

    .extracted-task-type {
      font-size: 11px;
      background: var(--accent-blue);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-light);
    }

    /* Status indicator */
    #api-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-color);
    }

    #status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      transition: background 0.3s;
    }

    #status-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1><span>üå±</span> Chief of Staff</h1>
        <div class="header-stats">
          <div class="header-stat">
            <span id="api-status">
              <span id="status-dot" style="background: var(--accent-amber);"></span>
              <span id="status-text">Connecting...</span>
            </span>
          </div>
          <div class="header-stat">
            <span>Critical:</span>
            <span class="count critical" id="critical-count">0</span>
          </div>
          <div class="header-stat">
            <span>High:</span>
            <span class="count high" id="high-count">0</span>
          </div>
          <div class="header-stat">
            <span>Overdue:</span>
            <span class="count critical" id="overdue-count">0</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="openBrainDump()" title="Dump your thoughts">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2a10 10 0 1 0 0 20 10 10 0 1 0 0-20z"/><path d="M8 12h8"/><path d="M12 8v8"/>
          </svg>
          Brain Dump
        </button>
        <button class="btn btn-secondary" onclick="refreshAll()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
          </svg>
          Refresh
        </button>
        <button class="btn btn-primary" onclick="runTriage()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
          </svg>
          Process Inbox
        </button>
      </div>
    </header>

    <!-- Main Panel -->
    <main class="main-panel">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="communications" onclick="switchTab('communications')">
          <span>Communications</span>
          <span class="tab-badge" id="comms-badge">0</span>
        </button>
        <button class="tab" data-tab="actions" onclick="switchTab('actions')">
          <span>Action Queue</span>
        </button>
        <button class="tab" data-tab="commitments" onclick="switchTab('commitments')">
          <span>Commitments</span>
        </button>
      </div>

      <!-- Communications Tab -->
      <div class="tab-content active" id="tab-communications">
        <div class="filter-bar">
          <button class="filter-chip active" data-filter="all" onclick="setFilter('all')">All</button>
          <button class="filter-chip" data-filter="email" onclick="setFilter('email')">Email</button>
          <button class="filter-chip" data-filter="sms" onclick="setFilter('sms')">SMS</button>
          <button class="filter-chip" data-filter="unread" onclick="setFilter('unread')">Unread</button>
          <button class="filter-chip" data-filter="commitment" onclick="setFilter('commitment')">Has Commitment</button>
        </div>

        <div id="communications-list">
          <div class="loading">
            <div class="spinner"></div>
            <span class="loading-text">Loading communications...</span>
          </div>
        </div>
      </div>

      <!-- Actions Tab -->
      <div class="tab-content" id="tab-actions">
        <div id="actions-list">
          <div class="loading">
            <div class="spinner"></div>
            <span class="loading-text">Loading action queue...</span>
          </div>
        </div>
      </div>

      <!-- Commitments Tab -->
      <div class="tab-content" id="tab-commitments">
        <div class="filter-bar">
          <button class="filter-chip active" data-filter="all" onclick="setCommitmentFilter('all')">All Open</button>
          <button class="filter-chip" data-filter="overdue" onclick="setCommitmentFilter('overdue')">Overdue</button>
          <button class="filter-chip" data-filter="mine" onclick="setCommitmentFilter('mine')">My Promises</button>
          <button class="filter-chip" data-filter="theirs" onclick="setCommitmentFilter('theirs')">Their Promises</button>
        </div>
        <div id="commitments-list">
          <div class="loading">
            <div class="spinner"></div>
            <span class="loading-text">Loading commitments...</span>
          </div>
        </div>
      </div>
    </main>

    <!-- Chat Panel - Featured prominently -->
    <aside class="chat-panel">
      <div class="chat-header">
        <div class="chat-avatar">ü§ñ</div>
        <div class="chat-title">
          <h2>Chief of Staff</h2>
          <p>Online - Ready to help</p>
        </div>
      </div>

      <div class="quick-actions">
        <button class="quick-action" onclick="askQuestion('What needs my attention right now?')">üö® Urgent</button>
        <button class="quick-action" onclick="askQuestion('Give me my morning brief')">‚òÄÔ∏è Brief</button>
        <button class="quick-action" onclick="askQuestion('What is on my calendar today?')">üìÖ Schedule</button>
        <button class="quick-action" onclick="askQuestion('How many workers do I need this week?')">üë• Staffing</button>
        <button class="quick-action" onclick="askQuestion('Lets work through my tasks')">‚úÖ Tasks</button>
        <button class="quick-action" onclick="window.location.href='task-assignment.html'">üìã Assign</button>
        <button class="quick-action" onclick="openQuickIdea()">üí° Idea</button>
      </div>

      <div class="chat-messages" id="chat-messages">
        <div class="chat-message assistant">
          <div class="chat-bubble">
            <p>Hey Todd. I'm ready. I can:</p>
            <ul>
              <li>üìß Read/send emails and texts</li>
              <li>üìÖ Check/add to your calendar</li>
              <li>üë• Predict staffing needs</li>
              <li>‚úÖ Work through your tasks one by one</li>
              <li>üí° Capture ideas for later</li>
              <li>üö® Surface what's urgent before you ask</li>
            </ul>
            <p>What do you need?</p>
          </div>
          <div class="chat-time">Just now</div>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chat-input" placeholder="Ask me anything..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
          <button class="chat-send" id="chat-send" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Mobile Chat Toggle -->
  <button class="mobile-chat-toggle" onclick="toggleMobileChat()">üí¨</button>

  <!-- Reclassify Menu -->
  <div class="reclassify-menu" id="reclassify-menu">
    <div class="reclassify-option" onclick="reclassify('CRITICAL')">
      <span class="priority-dot critical"></span> Critical
    </div>
    <div class="reclassify-option" onclick="reclassify('HIGH')">
      <span class="priority-dot high"></span> High
    </div>
    <div class="reclassify-option" onclick="reclassify('MEDIUM')">
      <span class="priority-dot medium"></span> Medium
    </div>
    <div class="reclassify-option" onclick="reclassify('LOW')">
      <span class="priority-dot low"></span> Low
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Completion Modal -->
  <div class="modal-overlay" id="completion-modal" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Log Completion</h3>
        <button class="modal-close" onclick="closeCompletionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="completion-item-name" style="color:var(--text-secondary);margin-bottom:16px;font-size:15px;"></p>
        <textarea id="completion-notes" placeholder="What did you do? Any notes for future reference..." rows="4" style="width:100%;background:var(--bg-input);border:2px solid var(--border-color);border-radius:10px;padding:14px;color:var(--text-primary);resize:vertical;font-size:15px;font-family:inherit;"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCompletionModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmCompletion()">Complete & Log</button>
      </div>
    </div>
  </div>

  <!-- Brain Dump Modal -->
  <div class="modal-overlay" id="braindump-modal" style="display:none;">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header">
        <h3>Brain Dump</h3>
        <button class="modal-close" onclick="closeBrainDump()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color:var(--text-secondary);margin-bottom:16px;font-size:15px;">Dump your thoughts, tasks, ideas - I'll organize them into actionable items.</p>
        <textarea id="braindump-text" placeholder="Example:
- need to call John about seeds
- check on greenhouse temps
- order more pots
- remember to invoice the restaurant
- weather looks bad friday need to cover crops" rows="8" style="width:100%;background:var(--bg-input);border:2px solid var(--border-color);border-radius:10px;padding:14px;color:var(--text-primary);resize:vertical;font-family:inherit;font-size:15px;line-height:1.6;"></textarea>
        <div id="braindump-result" style="margin-top:20px;display:none;">
          <div style="font-weight:700;margin-bottom:12px;font-size:15px;">Extracted Tasks:</div>
          <div id="braindump-tasks"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeBrainDump()">Cancel</button>
        <button class="btn btn-primary" id="braindump-process-btn" onclick="processBrainDump()">Process Thoughts</button>
        <button class="btn btn-primary" id="braindump-save-btn" onclick="saveBrainDumpTasks()" style="display:none;">Save All Tasks</button>
      </div>
    </div>
  </div>

  <script>
    // PRODUCTION API - v444 Overnight mega upgrade (2026-01-28)
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyT60fyrNfmZkgK3z1-ojgISeZBAbBr9Zz50UtSjqSysE5JpB_cAIjp2KFucwREG4qm/exec';

    let communications = [];
    let actions = [];
    let commitments = [];
    let currentFilter = 'all';
    let commitmentFilter = 'all';
    let selectedMessageId = null;
    let conversationHistory = [];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INITIALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    document.addEventListener('DOMContentLoaded', () => {
      checkAPIConnection();
      autoResizeTextarea();
    });

    async function checkAPIConnection() {
      updateStatus('connecting', 'Connecting...');
      try {
        const response = await fetch(`${API_BASE}?action=getEmailCategories`);
        const data = await response.json();

        if (data.success) {
          updateStatus('connected', 'Connected');
          loadAllData();
        } else {
          updateStatus('error', 'API Error');
          showToast('API returned error: ' + (data.error || 'Unknown'), 'error');
        }
      } catch (error) {
        updateStatus('error', 'Connection Failed');
        showToast('Cannot connect to API: ' + error.message, 'error');
        console.error('API Connection Error:', error);
      }
    }

    function updateStatus(status, text) {
      const dot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');

      statusText.textContent = text;

      if (status === 'connected') {
        dot.style.background = 'var(--accent-green)';
      } else if (status === 'error') {
        dot.style.background = 'var(--accent-red)';
      } else {
        dot.style.background = 'var(--accent-amber)';
      }
    }

    async function loadAllData() {
      await Promise.all([
        loadCommunications(),
        loadActions(),
        loadCommitments()
      ]);
    }

    function refreshAll() {
      checkAPIConnection();
      showToast('Refreshing data...', 'success');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMMUNICATIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function loadCommunications() {
      try {
        // Load combined communications (email + SMS)
        const commsRes = await fetch(`${API_BASE}?action=getCombinedCommunications`).then(r => r.json()).catch(() => ({ success: false }));

        communications = [];

        // Process combined data - backend returns { success, data: [...], counts, total }
        if (commsRes.success && commsRes.data && Array.isArray(commsRes.data)) {
          commsRes.data.forEach(item => {
            communications.push({
              id: item.id,
              type: item.type || 'email',
              from: item.from,
              subject: item.subject,
              summary: item.preview || '',
              priority: item.priority || 'MEDIUM',
              status: item.status,
              category: item.category,
              intent: item.suggestedAction,
              sentiment: item.sentiment,
              hasCommitment: item.hasCommitment,
              receivedAt: item.timestamp,
              isUnread: item.status === 'NEW'
            });
          });
        }

        // Sort by priority and time
        const priorityOrder = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3 };
        communications.sort((a, b) => {
          if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
          }
          return new Date(b.receivedAt) - new Date(a.receivedAt);
        });

        updateStats();
        renderCommunications();
      } catch (error) {
        console.error('Load communications error:', error);
        document.getElementById('communications-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>Unable to load communications</p>
          </div>
        `;
      }
    }

    function updateStats() {
      const critical = communications.filter(c => c.priority === 'CRITICAL').length;
      const high = communications.filter(c => c.priority === 'HIGH').length;

      document.getElementById('critical-count').textContent = critical;
      document.getElementById('high-count').textContent = high;
      document.getElementById('comms-badge').textContent = communications.filter(c => c.isUnread).length;
    }

    function renderCommunications() {
      const container = document.getElementById('communications-list');
      let filtered = communications;

      // Apply filter
      if (currentFilter === 'email') filtered = filtered.filter(c => c.type === 'email');
      else if (currentFilter === 'sms') filtered = filtered.filter(c => c.type === 'sms');
      else if (currentFilter === 'unread') filtered = filtered.filter(c => c.isUnread);
      else if (currentFilter === 'commitment') filtered = filtered.filter(c => c.hasCommitment);

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No communications found</p>
          </div>
        `;
        return;
      }

      // Group by priority
      const groups = {
        CRITICAL: filtered.filter(c => c.priority === 'CRITICAL'),
        HIGH: filtered.filter(c => c.priority === 'HIGH'),
        MEDIUM: filtered.filter(c => c.priority === 'MEDIUM'),
        LOW: filtered.filter(c => c.priority === 'LOW')
      };

      let html = '';

      for (const [priority, items] of Object.entries(groups)) {
        if (items.length === 0) continue;

        html += `
          <div class="priority-group">
            <div class="priority-header">
              <span class="priority-dot ${priority.toLowerCase()}"></span>
              <h3>${priority}</h3>
              <span class="count">${items.length}</span>
            </div>
        `;

        for (const msg of items) {
          html += renderMessageCard(msg);
        }

        html += '</div>';
      }

      container.innerHTML = html;
    }

    function renderMessageCard(msg) {
      const timeAgo = formatTimeAgo(msg.receivedAt);
      const icon = msg.type === 'email' ? 'üìß' : 'üí¨';

      let tags = '';
      if (msg.intent) tags += `<span class="message-tag intent">${msg.intent}</span>`;
      if (msg.sentiment === 'POSITIVE') tags += `<span class="message-tag sentiment-positive">Positive</span>`;
      if (msg.sentiment === 'NEGATIVE') tags += `<span class="message-tag sentiment-negative">Negative</span>`;
      if (msg.hasCommitment) tags += `<span class="message-tag commitment">Commitment</span>`;

      return `
        <div class="message-card ${selectedMessageId === msg.id ? 'selected' : ''}"
             onclick="selectMessage('${msg.id}')"
             oncontextmenu="showReclassifyMenu(event, '${msg.id}')">
          <div class="message-header">
            <span class="message-type">${icon}</span>
            <div class="message-meta">
              <div class="message-from">${escapeHtml(msg.from || 'Unknown')}</div>
              <div class="message-time">${timeAgo}</div>
            </div>
          </div>
          <div class="message-subject">${escapeHtml(msg.subject || 'No subject')}</div>
          <div class="message-summary">${escapeHtml(msg.summary || '')}</div>
          ${tags ? `<div class="message-tags">${tags}</div>` : ''}
        </div>
      `;
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('#tab-communications .filter-chip').forEach(c => {
        c.classList.toggle('active', c.dataset.filter === filter);
      });
      renderCommunications();
    }

    function selectMessage(id) {
      selectedMessageId = id;
      renderCommunications();

      // Load message details in chat
      const msg = communications.find(c => c.id === id);
      if (msg) {
        askQuestion(`Tell me more about the ${msg.type} from ${msg.from}: "${msg.subject}"`);
      }
    }

    function showReclassifyMenu(event, id) {
      event.preventDefault();
      selectedMessageId = id;

      const menu = document.getElementById('reclassify-menu');
      menu.style.left = event.pageX + 'px';
      menu.style.top = event.pageY + 'px';
      menu.classList.add('show');

      document.addEventListener('click', hideReclassifyMenu, { once: true });
    }

    function hideReclassifyMenu() {
      document.getElementById('reclassify-menu').classList.remove('show');
    }

    async function reclassify(newPriority) {
      if (!selectedMessageId) return;

      const msg = communications.find(c => c.id === selectedMessageId);
      if (!msg) return;

      try {
        const endpoint = msg.type === 'email' ? 'reclassifyEmail' : 'reclassifySMS';
        const response = await fetch(`${API_BASE}?action=${endpoint}&id=${selectedMessageId}&priority=${newPriority}`);
        const result = await response.json();

        if (result.success) {
          msg.priority = newPriority;
          renderCommunications();
          updateStats();
          showToast(`Reclassified as ${newPriority} - AI will learn from this`, 'success');
        }
      } catch (error) {
        showToast('Failed to reclassify', 'error');
      }

      hideReclassifyMenu();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function loadActions() {
      try {
        const response = await fetch(`${API_BASE}?action=getActionQueue`);
        const data = await response.json();

        if (data.success) {
          actions = data.actions || [];
          renderActions();
        }
      } catch (error) {
        console.error('Load actions error:', error);
      }
    }

    function renderActions() {
      const container = document.getElementById('actions-list');

      if (actions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No pending actions</p>
          </div>
        `;
        return;
      }

      let html = '';
      for (const action of actions) {
        const priorityClass = action.queuePosition === 'CRITICAL' ? 'critical' :
                              action.queuePosition === 'HIGH' ? 'high' : '';

        html += `
          <div class="action-card ${priorityClass}">
            <div class="action-header">
              <span class="action-contact">${escapeHtml(action.contactName || 'Unknown')}</span>
              <span class="action-score">Score: ${action.priorityScore || 0}</span>
            </div>
            <div class="action-description">${escapeHtml(action.action || '')}</div>
            <div class="action-rationale">${escapeHtml(action.rationale || '')}</div>
            <div class="action-buttons">
              <button class="action-btn complete" onclick="completeAction('${action.id}')">Mark Done</button>
              <button class="action-btn dismiss" onclick="dismissAction('${action.id}')">Dismiss</button>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    async function completeAction(id) {
      try {
        const response = await fetch(`${API_BASE}?action=completeAction&actionId=${id}`);
        await response.json();
        actions = actions.filter(a => a.id !== id);
        renderActions();
        showToast('Action completed', 'success');
      } catch (error) {
        showToast('Failed to complete action', 'error');
      }
    }

    async function dismissAction(id) {
      try {
        const response = await fetch(`${API_BASE}?action=dismissAction&actionId=${id}`);
        await response.json();
        actions = actions.filter(a => a.id !== id);
        renderActions();
      } catch (error) {
        showToast('Failed to dismiss action', 'error');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMMITMENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function loadCommitments() {
      try {
        const response = await fetch(`${API_BASE}?action=getOpenSMSCommitments`);
        const data = await response.json();

        if (data.success) {
          commitments = data.commitments || [];
          renderCommitments();

          const overdue = commitments.filter(c => c.isOverdue).length;
          document.getElementById('overdue-count').textContent = overdue;
        }
      } catch (error) {
        console.error('Load commitments error:', error);
      }
    }

    function renderCommitments() {
      const container = document.getElementById('commitments-list');
      let filtered = commitments;

      if (commitmentFilter === 'overdue') filtered = filtered.filter(c => c.isOverdue);
      else if (commitmentFilter === 'mine') filtered = filtered.filter(c => c.type === 'OUTBOUND');
      else if (commitmentFilter === 'theirs') filtered = filtered.filter(c => c.type === 'INBOUND');

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No commitments found</p>
          </div>
        `;
        return;
      }

      let html = '';
      for (const c of filtered) {
        const typeClass = c.type === 'OUTBOUND' ? 'mine' : 'theirs';
        const typeLabel = c.type === 'OUTBOUND' ? 'My Promise' : 'Their Promise';

        html += `
          <div class="commitment-card ${c.isOverdue ? 'overdue' : ''}">
            <div class="commitment-header">
              <span class="commitment-type ${typeClass}">${typeLabel}</span>
              <span class="commitment-deadline ${c.isOverdue ? 'overdue' : ''}">
                ${c.isOverdue ? 'OVERDUE' : (c.deadline || 'No deadline')}
              </span>
            </div>
            <div class="commitment-contact">${escapeHtml(c.contactName || 'Unknown')}</div>
            <div class="commitment-text">${escapeHtml(c.text || '')}</div>
            <div class="action-buttons">
              <button class="action-btn complete" onclick="completeCommitmentWithLog('${c.id}', '${escapeHtml(c.text || '').replace(/'/g, "\\'")}')">Complete</button>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function setCommitmentFilter(filter) {
      commitmentFilter = filter;
      document.querySelectorAll('#tab-commitments .filter-chip').forEach(c => {
        c.classList.toggle('active', c.dataset.filter === filter);
      });
      renderCommitments();
    }

    async function completeCommitment(id) {
      try {
        const response = await fetch(`${API_BASE}?action=completeSMSCommitment&commitmentId=${id}`);
        await response.json();
        commitments = commitments.filter(c => c.id !== id);
        renderCommitments();
        showToast('Commitment completed', 'success');
      } catch (error) {
        showToast('Failed to complete commitment', 'error');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CHAT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function askQuestion(question) {
      document.getElementById('chat-input').value = question;
      sendMessage();
    }

    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      // Add user message
      addChatMessage(message, 'user');
      input.value = '';
      input.style.height = 'auto';

      // Show typing indicator
      const typingId = showTypingIndicator();

      try {
        const response = await fetch(`${API_BASE}?action=chatWithChiefOfStaff&message=${encodeURIComponent(message)}&history=${encodeURIComponent(JSON.stringify(conversationHistory))}`);
        const data = await response.json();

        removeTypingIndicator(typingId);

        if (data.success) {
          addChatMessage(data.message, 'assistant');

          // Update conversation history
          conversationHistory.push({ role: 'user', content: message });
          conversationHistory.push({ role: 'assistant', content: data.message });

          // Keep last 10 exchanges
          if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
          }
        } else {
          addChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
        }
      } catch (error) {
        removeTypingIndicator(typingId);
        addChatMessage('Connection error. Please check your network.', 'assistant');
      }
    }

    function addChatMessage(content, role) {
      const container = document.getElementById('chat-messages');
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const div = document.createElement('div');
      div.className = `chat-message ${role}`;

      // Simple markdown-ish parsing
      let html = escapeHtml(content)
        .replace(/\n/g, '</p><p>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');

      div.innerHTML = `
        <div class="chat-bubble"><p>${html}</p></div>
        <div class="chat-time">${time}</div>
      `;

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function showTypingIndicator() {
      const container = document.getElementById('chat-messages');
      const id = 'typing-' + Date.now();

      const div = document.createElement('div');
      div.id = id;
      div.className = 'chat-message assistant';
      div.innerHTML = `
        <div class="chat-bubble">
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </div>
      `;

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return id;
    }

    function removeTypingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function handleChatKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function autoResizeTextarea() {
      const textarea = document.getElementById('chat-input');
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 140) + 'px';
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TABS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MOBILE CHAT TOGGLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function toggleMobileChat() {
      const chatPanel = document.querySelector('.chat-panel');
      chatPanel.classList.toggle('open');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UTILITIES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function runTriage() {
      showToast('Processing inbox...', 'success');
      try {
        await fetch(`${API_BASE}?action=triageInbox`);
        setTimeout(() => loadCommunications(), 3000);
      } catch (error) {
        showToast('Triage started in background', 'success');
      }
    }

    function formatTimeAgo(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Close reclassify menu when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.reclassify-menu')) {
        hideReclassifyMenu();
      }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMPLETION LOGGING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let pendingCompletion = null;

    function openCompletionModal(type, id, name) {
      pendingCompletion = { type, id };
      document.getElementById('completion-item-name').textContent = name || 'Complete this item';
      document.getElementById('completion-notes').value = '';
      document.getElementById('completion-modal').style.display = 'flex';
      document.getElementById('completion-notes').focus();
    }

    function closeCompletionModal() {
      document.getElementById('completion-modal').style.display = 'none';
      pendingCompletion = null;
    }

    async function confirmCompletion() {
      if (!pendingCompletion) return;

      const notes = document.getElementById('completion-notes').value.trim();
      const { type, id } = pendingCompletion;

      // Optimistic UI - remove immediately
      if (type === 'action') {
        actions = actions.filter(a => a.id !== id);
        renderActions();
      } else if (type === 'commitment') {
        commitments = commitments.filter(c => c.id !== id);
        renderCommitments();
      }

      closeCompletionModal();
      showToast('Completed & logged!', 'success');

      // Save to backend
      try {
        const action = type === 'action' ? 'completeAction' : 'completeSMSCommitment';
        const idParam = type === 'action' ? 'actionId' : 'commitmentId';
        await fetch(`${API_BASE}?action=${action}&${idParam}=${id}&notes=${encodeURIComponent(notes)}`);

        // Also log to activity log
        await fetch(`${API_BASE}?action=logActivity&type=COMPLETION&itemType=${type}&itemId=${id}&notes=${encodeURIComponent(notes)}`);
      } catch (error) {
        console.error('Completion save error:', error);
      }
    }

    // Override the original complete functions to use modal
    function completeActionWithLog(id, name) {
      openCompletionModal('action', id, name);
    }

    function completeCommitmentWithLog(id, name) {
      openCompletionModal('commitment', id, name);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BRAIN DUMP
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let extractedTasks = [];

    function openBrainDump() {
      document.getElementById('braindump-text').value = '';
      document.getElementById('braindump-result').style.display = 'none';
      document.getElementById('braindump-process-btn').style.display = 'inline-flex';
      document.getElementById('braindump-save-btn').style.display = 'none';
      document.getElementById('braindump-modal').style.display = 'flex';
      document.getElementById('braindump-text').focus();
    }

    function closeBrainDump() {
      document.getElementById('braindump-modal').style.display = 'none';
      extractedTasks = [];
    }

    async function processBrainDump() {
      const text = document.getElementById('braindump-text').value.trim();
      if (!text) {
        showToast('Enter some thoughts first', 'error');
        return;
      }

      document.getElementById('braindump-process-btn').textContent = 'Processing...';
      document.getElementById('braindump-process-btn').disabled = true;

      try {
        const response = await fetch(`${API_BASE}?action=processBrainDump&text=${encodeURIComponent(text)}`);
        const data = await response.json();

        if (data.success && data.tasks && data.tasks.length > 0) {
          extractedTasks = data.tasks;
          renderExtractedTasks();
          document.getElementById('braindump-result').style.display = 'block';
          document.getElementById('braindump-process-btn').style.display = 'none';
          document.getElementById('braindump-save-btn').style.display = 'inline-flex';
        } else {
          showToast('No tasks extracted. Try being more specific.', 'error');
        }
      } catch (error) {
        console.error('Brain dump error:', error);
        showToast('Processing failed. Try again.', 'error');
      }

      document.getElementById('braindump-process-btn').textContent = 'Process Thoughts';
      document.getElementById('braindump-process-btn').disabled = false;
    }

    function renderExtractedTasks() {
      const container = document.getElementById('braindump-tasks');
      let html = '';

      for (let i = 0; i < extractedTasks.length; i++) {
        const task = extractedTasks[i];
        html += `
          <div class="extracted-task">
            <input type="checkbox" checked id="task-${i}">
            <div class="extracted-task-text">${escapeHtml(task.text)}</div>
            <span class="extracted-task-type">${task.type || 'Task'}</span>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    async function saveBrainDumpTasks() {
      const selectedTasks = extractedTasks.filter((_, i) =>
        document.getElementById(`task-${i}`).checked
      );

      if (selectedTasks.length === 0) {
        showToast('Select at least one task', 'error');
        return;
      }

      document.getElementById('braindump-save-btn').textContent = 'Saving...';
      document.getElementById('braindump-save-btn').disabled = true;

      try {
        const response = await fetch(`${API_BASE}?action=saveBrainDumpTasks&tasks=${encodeURIComponent(JSON.stringify(selectedTasks))}`);
        await response.json();
        showToast(`${selectedTasks.length} tasks created!`, 'success');
        closeBrainDump();
        loadActions(); // Refresh action queue
      } catch (error) {
        showToast('Failed to save tasks', 'error');
      }

      document.getElementById('braindump-save-btn').textContent = 'Save All Tasks';
      document.getElementById('braindump-save-btn').disabled = false;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // QUICK IDEA CAPTURE - Flows to COS_Ideas sheet
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function openQuickIdea() {
      const idea = prompt('üí° Quick idea:');
      if (idea && idea.trim()) {
        captureIdea(idea.trim());
      }
    }

    async function captureIdea(idea) {
      showToast('Capturing idea...', 'success');
      try {
        // Use chat to capture idea - this triggers the capture_idea tool
        const response = await fetch(`${API_BASE}?action=chatWithChiefOfStaff&message=${encodeURIComponent('idea: ' + idea)}`);
        const data = await response.json();

        if (data.success) {
          showToast('üí° Idea captured!', 'success');
          addChatMessage('idea: ' + idea, 'user');
          addChatMessage(data.message || 'Got it. Idea saved for later.', 'assistant');
        } else {
          showToast('Idea saved locally', 'success');
        }
      } catch (error) {
        console.error('Idea capture error:', error);
        showToast('Idea noted', 'success');
      }
    }

    // Close modals with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeCompletionModal();
        closeBrainDump();
      }
    });

    // Close modals when clicking overlay
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closeCompletionModal();
          closeBrainDump();
        }
      });
    });
  </script>
</body>
</html>
