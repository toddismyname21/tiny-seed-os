<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Predictions - Tiny Seed OS</title>
    <script src="auth-guard.js" data-allow-roles="Admin,Manager,Field_Lead"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #22c55e;
            --primary-dark: #16a34a;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #273548;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --success: #22c55e;
            /* Mobile-first touch targets */
            --touch-min: 48px;
            --touch-comfortable: 56px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: calc(16px + var(--safe-top)) 16px calc(16px + var(--safe-bottom));
            -webkit-font-smoothing: antialiased;
        }

        /* Skeleton Loading Animation */
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.7; }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-elevated, #334155) 25%, var(--bg-card) 50%, var(--bg-elevated, #334155) 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 12px;
        }

        .skeleton-card {
            height: 120px;
            margin-bottom: 12px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 48px;
        }

        .title-section h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .last-update {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: var(--touch-min);
            min-width: var(--touch-min);
            touch-action: manipulation;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--primary-dark);
        }

        .refresh-btn:active {
            transform: scale(0.98);
        }

        .refresh-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            min-height: var(--touch-min);
            display: flex;
            align-items: center;
            padding: 0 8px;
        }

        .back-link:hover {
            color: var(--primary);
        }

        /* Mobile header adjustments */
        @media (max-width: 600px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            .title-section h1 {
                font-size: 22px;
            }
        }

        /* Weather Banner */
        .weather-banner {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }

        .weather-current {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .weather-icon {
            font-size: 56px;
        }

        .weather-temp {
            font-size: 42px;
            font-weight: 700;
        }

        .weather-details {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .weather-stat {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .weather-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .weather-stat-value {
            font-size: 20px;
            font-weight: 600;
        }

        .weather-forecast {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .forecast-day {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px 16px;
            text-align: center;
            min-width: 80px;
        }

        .forecast-day-name {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .forecast-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .forecast-temps {
            font-size: 13px;
        }

        .forecast-high {
            color: var(--text-primary);
        }

        .forecast-low {
            color: var(--text-secondary);
        }

        /* Dashboard Grid - Mobile First */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (min-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
                gap: 24px;
            }
        }

        /* Weather banner mobile improvements */
        @media (max-width: 768px) {
            .weather-banner {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px;
            }
            .weather-current {
                padding-bottom: 16px;
                border-bottom: 1px solid var(--border);
            }
            .weather-temp {
                font-size: 36px;
            }
            .weather-icon {
                font-size: 48px;
            }
            .weather-forecast {
                padding-bottom: 4px;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            min-height: var(--touch-comfortable);
            touch-action: manipulation;
            transition: background 0.2s;
        }

        .card-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .card-header:active {
            background: rgba(255, 255, 255, 0.05);
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .card-badge {
            order: 1;
            background: var(--primary);
            color: white;
            font-size: 12px;
            padding: 5px 12px;
            border-radius: 14px;
            font-weight: 600;
        }

        /* Collapsible sections - Progressive Disclosure */
        .card-toggle {
            width: var(--touch-min);
            height: var(--touch-min);
            min-width: var(--touch-min);
            min-height: var(--touch-min);
            border-radius: 12px;
            order: 2;
            margin-left: 12px;
            background: var(--bg-dark);
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.2s;
        }

        .card-toggle:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .card-body.collapsed {
            display: none;
        }

        .card-toggle .icon {
            transition: transform 0.3s;
        }

        .card-toggle.expanded .icon {
            transform: rotate(180deg);
        }

        .card-badge.warning {
            background: var(--warning);
        }

        .card-badge.danger {
            background: var(--danger);
        }

        .card-body {
            padding: 16px 20px;
            max-height: 500px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        @media (max-width: 600px) {
            .card-body {
                padding: 14px 16px;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .empty-state p {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 40px 20px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 12px;
            margin: 16px;
        }

        .error-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-state p {
            color: var(--danger);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .retry-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-height: var(--touch-min);
        }

        .retry-btn:active {
            opacity: 0.9;
            transform: scale(0.98);
        }

        /* Morning Brief */
        .morning-summary {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .morning-summary h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .labor-estimate {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .labor-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Task List */
        .task-section {
            margin-bottom: 20px;
        }

        .task-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .task-section-title.critical {
            color: var(--danger);
        }

        .task-section-title.high {
            color: var(--warning);
        }

        .task-item {
            background: var(--bg-dark);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 5px solid var(--border);
            transition: all 0.2s;
            cursor: pointer;
            min-height: var(--touch-comfortable);
            touch-action: manipulation;
        }

        .task-item:hover, .task-item:active {
            background: var(--bg-card-hover);
            transform: translateX(2px);
        }

        .task-item.priority-critical {
            border-left-color: var(--danger);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-dark) 20%);
        }

        .task-item.priority-high {
            border-left-color: var(--warning);
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.08) 0%, var(--bg-dark) 20%);
        }

        .task-item.priority-medium {
            border-left-color: var(--info);
        }

        /* Task completion checkbox */
        .task-checkbox {
            width: var(--touch-min);
            height: var(--touch-min);
            border-radius: 12px;
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-checkbox:active {
            transform: scale(0.95);
        }

        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .task-type {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }

        .task-type.harvest {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .task-type.scout {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .task-type.spray {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .task-type.transplant {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .task-priority {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .task-crop {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .task-reason {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .task-meta {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Disease Risk */
        .disease-card {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .disease-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .disease-name {
            font-size: 15px;
            font-weight: 600;
        }

        .disease-risk-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .disease-risk-badge.low {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .disease-risk-badge.moderate {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .disease-risk-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .disease-meter {
            height: 12px;
            background: var(--bg-card);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .disease-meter-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            position: relative;
        }

        .disease-meter-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
        }

        .disease-meter-fill.low {
            background: linear-gradient(90deg, var(--success) 0%, #4ade80 100%);
        }

        .disease-meter-fill.moderate {
            background: linear-gradient(90deg, var(--warning) 0%, #fbbf24 100%);
        }

        .disease-meter-fill.high {
            background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%);
        }

        .disease-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Harvest Predictions */
        .harvest-item {
            background: var(--bg-dark);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .harvest-item:active {
            transform: scale(0.99);
            background: var(--bg-card-hover);
        }

        .harvest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .harvest-crop {
            font-size: 16px;
            font-weight: 600;
        }

        .harvest-date {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }

        .harvest-progress {
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 12px;
            background: var(--bg-card);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, #4ade80 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .harvest-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            font-size: 13px;
        }

        .harvest-detail {
            text-align: center;
        }

        .harvest-detail-value {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .harvest-detail-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* GDD Card */
        .gdd-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .gdd-stat {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .gdd-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .gdd-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Alerts Section */
        .alert {
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .alert.danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Full Width Section */
        .full-width {
            grid-column: 1 / -1;
        }

        /* Loading State */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 24px;
            color: var(--text-secondary);
            font-size: 13px;
            border-top: 1px solid var(--border);
            margin-top: 24px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
            }

            .weather-banner {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .gdd-summary {
                grid-template-columns: 1fr;
            }

            .harvest-details {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================= */
        /* KEYBOARD SHORTCUTS HELP */
        /* ============================================= */
        .keyboard-help {
            position: fixed; bottom: 20px; right: 20px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 1rem; font-size: 0.75rem; color: var(--text-secondary); z-index: 2000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .keyboard-help.visible { display: block; }
        .keyboard-help h4 { color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.85rem; }
        .keyboard-help kbd { background: var(--bg-card-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace; margin-right: 0.5rem; }
        .keyboard-help div { margin-bottom: 0.25rem; }

        /* ============================================= */
        /* PRINT STYLES */
        /* ============================================= */
        @media print {
            body { background: white !important; color: black !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            header, .keyboard-help, .refresh-btn, .back-link { display: none !important; }
            .container { max-width: 100%; padding: 0; }
            .prediction-card, .weather-banner, .task-card { background: white !important; border: 1px solid #ddd !important; box-shadow: none !important; page-break-inside: avoid; }
            .prediction-card h3, .task-title { color: black !important; }
            .weather-stat-value, .task-card .value { color: black !important; }
            .risk-indicator.low { color: #2a9d8f !important; }
            .risk-indicator.medium { color: #f59e0b !important; }
            .risk-indicator.high { color: #ef4444 !important; }
            @page { margin: 0.5in; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <div class="logo">üß†</div>
                <div class="title-section">
                    <h1>Smart Predictions</h1>
                    <div class="subtitle">AI-Powered Farm Intelligence ‚Ä¢ GDD Models ‚Ä¢ Disease Risk ‚Ä¢ Weather Integration</div>
                </div>
            </div>
            <div class="header-right">
                <a href="index.html" class="back-link">‚Üê Back to Hub</a>
                <span class="last-update" id="lastUpdate">Loading...</span>
                <button class="refresh-btn" id="refreshBtn" onclick="loadAllData()">
                    <span>‚Üª</span> Refresh
                </button>
            </div>
        </header>

        <!-- Weather Banner -->
        <div class="weather-banner" id="weatherBanner">
            <div class="weather-current">
                <div class="weather-icon" id="weatherIcon">‚è≥</div>
                <div>
                    <div class="weather-temp" id="weatherTemp">--¬∞F</div>
                    <div class="weather-details" id="weatherDetails">Loading forecast...</div>
                </div>
            </div>
            <div class="weather-stat">
                <div class="weather-stat-label">Precipitation</div>
                <div class="weather-stat-value" id="precipChance">--%</div>
            </div>
            <div class="weather-stat">
                <div class="weather-stat-label">Humidity</div>
                <div class="weather-stat-value" id="humidity">--%</div>
            </div>
            <div class="weather-stat">
                <div class="weather-stat-label">GDD Today</div>
                <div class="weather-stat-value" id="gddToday">--</div>
            </div>
            <div class="weather-forecast" id="weatherForecast">
                <div class="forecast-day">
                    <div class="forecast-day-name">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Morning Brief Card -->
            <div class="card" id="morningBriefCard">
                <div class="card-header" onclick="toggleCard('morningBriefCard')">
                    <div class="card-title">
                        <span>‚òÄÔ∏è</span> Morning Brief
                    </div>
                    <button class="card-toggle expanded" aria-label="Toggle section">
                        <span class="icon">‚ñº</span>
                    </button>
                    <div class="card-badge" id="taskCount">0 tasks</div>
                </div>
                <div class="card-body" id="morningBriefContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Disease Risk Card -->
            <div class="card" id="diseaseRiskCard">
                <div class="card-header" onclick="toggleCard('diseaseRiskCard')">
                    <div class="card-title">
                        <span>ü¶†</span> Disease Risk Monitor
                    </div>
                    <button class="card-toggle expanded" aria-label="Toggle section">
                        <span class="icon">‚ñº</span>
                    </button>
                    <div class="card-badge" id="overallRisk">Calculating...</div>
                </div>
                <div class="card-body" id="diseaseRiskContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Harvest Predictions Card -->
            <div class="card" id="harvestCard">
                <div class="card-header" onclick="toggleCard('harvestCard')">
                    <div class="card-title">
                        <span>üìä</span> Harvest Predictions
                    </div>
                    <button class="card-toggle expanded" aria-label="Toggle section">
                        <span class="icon">‚ñº</span>
                    </button>
                    <div class="card-badge" id="harvestCount">0 crops</div>
                </div>
                <div class="card-body" id="harvestContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- GDD Progress Card -->
            <div class="card" id="gddCard">
                <div class="card-header" onclick="toggleCard('gddCard')">
                    <div class="card-title">
                        <span>üå°Ô∏è</span> Growing Degree Days
                    </div>
                    <button class="card-toggle expanded" aria-label="Toggle section">
                        <span class="icon">‚ñº</span>
                    </button>
                    <div class="card-badge" id="seasonGDD">Season GDD</div>
                </div>
                <div class="card-body" id="gddContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Alerts Card (Full Width) -->
            <div class="card full-width" id="alertsCard" style="display: none;">
                <div class="card-header" onclick="toggleCard('alertsCard')">
                    <div class="card-title">
                        <span>‚ö†Ô∏è</span> Active Alerts
                    </div>
                    <button class="card-toggle expanded" aria-label="Toggle section">
                        <span class="icon">‚ñº</span>
                    </button>
                </div>
                <div class="card-body" id="alertsContent">
                </div>
            </div>
        </div>

        <footer>
            <p>Tiny Seed OS - Predictive Intelligence System</p>
            <p style="margin-top: 8px; font-size: 11px;">
                Powered by GDD Models (OSU Extension) ‚Ä¢ Open-Meteo Weather API ‚Ä¢ Late Blight DSV Algorithm
            </p>
        </footer>
    </div>

    <!-- API Configuration - Single Source of Truth -->
    <script src="api-config.js"></script>
    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_URL = (typeof TINY_SEED_API !== 'undefined') ? TINY_SEED_API.MAIN_API : 'https://script.google.com/macros/s/AKfycbxy5DlsDXGwulhRNIHiD7q7sHQbN9kResVkR5YPXF2Z2IzgahVE9i38v063s4scAWMp/exec';

        // Farm coordinates (Tiny Seed Farm, PA)
        const FARM_LAT = 40.0;
        const FARM_LON = -76.5;

        // ========================================
        // STATE
        // ========================================
        let dashboardData = null;
        let isLoading = false;

        // ========================================
        // PROGRESSIVE DISCLOSURE - CARD TOGGLE
        // ========================================
        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const body = card.querySelector('.card-body');
            const toggle = card.querySelector('.card-toggle');

            if (body && toggle) {
                body.classList.toggle('collapsed');
                toggle.classList.toggle('expanded');

                // Save preference
                localStorage.setItem(`card_${cardId}_collapsed`, body.classList.contains('collapsed'));
            }
        }

        // Restore card collapse states from localStorage
        function restoreCardStates() {
            document.querySelectorAll('.card[id]').forEach(card => {
                const collapsed = localStorage.getItem(`card_${card.id}_collapsed`) === 'true';
                if (collapsed) {
                    const body = card.querySelector('.card-body');
                    const toggle = card.querySelector('.card-toggle');
                    if (body) body.classList.add('collapsed');
                    if (toggle) toggle.classList.remove('expanded');
                }
            });
        }

        // ========================================
        // SKELETON LOADING
        // ========================================
        function showSkeletonLoading() {
            // Show skeleton in each card body
            document.querySelectorAll('.card-body').forEach(body => {
                body.innerHTML = `
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                `;
            });
        }

        // ========================================
        // MAIN LOAD FUNCTION
        // ========================================
        async function loadAllData() {
            if (isLoading) return;
            isLoading = true;

            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            refreshBtn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span> Loading...';

            // Show skeleton loading state
            showSkeletonLoading();

            try {
                // Try to load from API first
                const response = await fetch(`${API_URL}?action=getSmartDashboard&lat=${FARM_LAT}&lon=${FARM_LON}`);
                const result = await response.json();

                if (result.success) {
                    dashboardData = result.data;
                    renderAllSections();
                } else {
                    // Fallback to demo data if API fails
                    console.warn('API returned error, using demo data:', result.error);
                    loadDemoData();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                loadDemoData();
            }

            refreshBtn.classList.remove('loading');
            refreshBtn.innerHTML = '<span>‚Üª</span> Refresh';
            document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            isLoading = false;

            // Restore user's card collapse preferences
            restoreCardStates();
        }

        // ========================================
        // DEMO DATA (Fallback)
        // ========================================
        function loadDemoData() {
            const today = new Date();
            dashboardData = {
                weather: {
                    current: {
                        temp: 45,
                        temp_max: 52,
                        temp_min: 38,
                        humidity: 65,
                        precip_prob: 20,
                        conditions: 'Partly Cloudy'
                    },
                    gdd_today: 7.5,
                    forecast: [
                        { day: 'Tue', high: 54, low: 40, icon: '‚òÄÔ∏è', precip: 10 },
                        { day: 'Wed', high: 58, low: 42, icon: '‚õÖ', precip: 30 },
                        { day: 'Thu', high: 52, low: 38, icon: 'üåßÔ∏è', precip: 70 },
                        { day: 'Fri', high: 48, low: 35, icon: '‚õÖ', precip: 20 },
                        { day: 'Sat', high: 55, low: 40, icon: '‚òÄÔ∏è', precip: 5 }
                    ]
                },
                morning_brief: {
                    date: today.toISOString(),
                    labor_hours_estimated: 8.5,
                    must_do_today: [
                        {
                            type: 'HARVEST',
                            crop: 'Lettuce - Salanova Mix',
                            location: 'Tunnel 2, Bed 3-4',
                            priority: 95,
                            reason: 'GDD 92% complete, optimal harvest window today',
                            est_time: 45
                        },
                        {
                            type: 'SCOUT_SPRAY',
                            crop: 'Tomatoes',
                            location: 'Field A, Rows 1-8',
                            priority: 88,
                            reason: 'Late Blight DSV 15 - Moderate risk after recent rain',
                            est_time: 30
                        }
                    ],
                    should_do_today: [
                        {
                            type: 'TRANSPLANT',
                            crop: 'Pepper - Carmen',
                            location: 'Field B, Rows 1-4',
                            priority: 72,
                            reason: 'Weather window open, soil temp 58¬∞F',
                            est_time: 120
                        },
                        {
                            type: 'HARVEST',
                            crop: 'Snap Beans',
                            location: 'Field C, Rows 5-8',
                            priority: 65,
                            reason: 'GDD 85% complete, good for 2-3 more days',
                            est_time: 60
                        }
                    ],
                    can_wait: [
                        {
                            type: 'CULTIVATION',
                            crop: 'Carrots',
                            location: 'Field D',
                            priority: 45,
                            reason: 'Weeds emerging, cultivate within 5 days',
                            est_time: 90
                        }
                    ]
                },
                disease_risk: {
                    late_blight: {
                        dsv: 12,
                        risk_level: 'MODERATE',
                        recommendation: 'Scout susceptible crops today. Spray if symptoms found.',
                        conditions: '6 hrs high humidity, temp 58-72¬∞F'
                    },
                    early_blight: {
                        score: 35,
                        risk_level: 'LOW',
                        recommendation: 'Monitor lower leaves on tomatoes.',
                        conditions: 'Conditions not yet favorable'
                    },
                    downy_mildew: {
                        score: 22,
                        risk_level: 'LOW',
                        recommendation: 'No action needed.',
                        conditions: 'Humidity below threshold'
                    }
                },
                harvest_predictions: [
                    {
                        crop: 'Tomato - Cherokee Purple',
                        batch_id: 'TOM-2024-003',
                        plant_date: '2024-05-15',
                        gdd_accumulated: 1650,
                        gdd_target: 1927,
                        percent_complete: 86,
                        predicted_harvest: '2024-08-12',
                        confidence: 'HIGH',
                        days_remaining: 8
                    },
                    {
                        crop: 'Pepper - Carmen',
                        batch_id: 'PEP-2024-002',
                        plant_date: '2024-05-20',
                        gdd_accumulated: 980,
                        gdd_target: 1329,
                        percent_complete: 74,
                        predicted_harvest: '2024-08-18',
                        confidence: 'MEDIUM',
                        days_remaining: 14
                    },
                    {
                        crop: 'Cucumber - Marketmore',
                        batch_id: 'CUC-2024-004',
                        plant_date: '2024-06-01',
                        gdd_accumulated: 720,
                        gdd_target: 805,
                        percent_complete: 89,
                        predicted_harvest: '2024-08-06',
                        confidence: 'HIGH',
                        days_remaining: 2
                    }
                ],
                gdd_summary: {
                    season_total: 2450,
                    today: 7.5,
                    last_7_days: 85,
                    last_30_days: 380,
                    season_start: '2024-04-01'
                },
                alerts: [
                    {
                        type: 'warning',
                        title: 'Rain Expected Thursday',
                        message: '70% chance of rain. Plan spray applications for Wed or delay until Fri.'
                    },
                    {
                        type: 'info',
                        title: 'Cucumber Harvest Window',
                        message: 'Marketmore batch reaching optimal maturity. Harvest within 3 days for best quality.'
                    }
                ]
            };

            renderAllSections();
        }

        // ========================================
        // RENDER FUNCTIONS
        // ========================================
        function renderAllSections() {
            renderWeather();
            renderMorningBrief();
            renderDiseaseRisk();
            renderHarvestPredictions();
            renderGDDProgress();
            renderAlerts();
        }

        function renderWeather() {
            const weather = dashboardData.weather;
            if (!weather) return;

            // Current conditions
            document.getElementById('weatherIcon').textContent = getWeatherIcon(weather.current.conditions);
            document.getElementById('weatherTemp').textContent = `${Math.round(weather.current.temp)}¬∞F`;
            document.getElementById('weatherDetails').textContent = `High ${weather.current.temp_max}¬∞ / Low ${weather.current.temp_min}¬∞ ‚Ä¢ ${weather.current.conditions}`;
            document.getElementById('precipChance').textContent = `${weather.current.precip_prob}%`;
            document.getElementById('humidity').textContent = `${weather.current.humidity}%`;
            document.getElementById('gddToday').textContent = weather.gdd_today.toFixed(1);

            // Forecast
            const forecastHtml = weather.forecast.map(day => `
                <div class="forecast-day">
                    <div class="forecast-day-name">${day.day}</div>
                    <div class="forecast-icon">${day.icon}</div>
                    <div class="forecast-temps">
                        <span class="forecast-high">${day.high}¬∞</span>
                        <span class="forecast-low">${day.low}¬∞</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('weatherForecast').innerHTML = forecastHtml;
        }

        function renderMorningBrief() {
            const brief = dashboardData.morning_brief;
            if (!brief) {
                document.getElementById('morningBriefContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No morning brief available</p></div>';
                return;
            }

            const totalTasks = (brief.must_do_today?.length || 0) + (brief.should_do_today?.length || 0) + (brief.can_wait?.length || 0);
            document.getElementById('taskCount').textContent = `${totalTasks} tasks`;

            let html = `
                <div class="morning-summary">
                    <h3>Today's Workload</h3>
                    <div class="labor-estimate">${brief.labor_hours_estimated.toFixed(1)} hours</div>
                    <div class="labor-label">Estimated labor for priority tasks</div>
                </div>
            `;

            // Must Do Today
            if (brief.must_do_today?.length > 0) {
                html += `
                    <div class="task-section">
                        <div class="task-section-title critical">üî¥ Must Do Today (${brief.must_do_today.length})</div>
                        ${brief.must_do_today.map(task => renderTaskItem(task, 'critical')).join('')}
                    </div>
                `;
            }

            // Should Do Today
            if (brief.should_do_today?.length > 0) {
                html += `
                    <div class="task-section">
                        <div class="task-section-title high">üü° Should Do Today (${brief.should_do_today.length})</div>
                        ${brief.should_do_today.map(task => renderTaskItem(task, 'high')).join('')}
                    </div>
                `;
            }

            // Can Wait
            if (brief.can_wait?.length > 0) {
                html += `
                    <div class="task-section">
                        <div class="task-section-title">üü¢ Can Wait (${brief.can_wait.length})</div>
                        ${brief.can_wait.map(task => renderTaskItem(task, 'medium')).join('')}
                    </div>
                `;
            }

            document.getElementById('morningBriefContent').innerHTML = html;
        }

        function renderTaskItem(task, priority) {
            const typeClass = task.type.toLowerCase().replace('_', '');
            return `
                <div class="task-item priority-${priority}">
                    <div class="task-header">
                        <span class="task-type ${typeClass}">${task.type.replace('_', ' ')}</span>
                        <span class="task-priority">Priority: ${task.priority}</span>
                    </div>
                    <div class="task-crop">${task.crop}</div>
                    <div class="task-reason">${task.reason}</div>
                    <div class="task-meta">
                        <span>üìç ${task.location}</span>
                        <span>‚è±Ô∏è ${task.est_time} min</span>
                    </div>
                </div>
            `;
        }

        function renderDiseaseRisk() {
            const risk = dashboardData.disease_risk;
            if (!risk) {
                document.getElementById('diseaseRiskContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ü¶†</div><p>No disease data available</p></div>';
                return;
            }

            // Update overall risk badge
            const maxRisk = getMaxRiskLevel(risk);
            const riskBadge = document.getElementById('overallRisk');
            riskBadge.textContent = maxRisk.toUpperCase();
            riskBadge.className = 'card-badge ' + (maxRisk === 'HIGH' ? 'danger' : maxRisk === 'MODERATE' ? 'warning' : '');

            let html = '';

            // Late Blight
            if (risk.late_blight) {
                const lb = risk.late_blight;
                const pct = Math.min(100, (lb.dsv / 25) * 100);
                html += `
                    <div class="disease-card">
                        <div class="disease-header">
                            <span class="disease-name">Late Blight (Phytophthora)</span>
                            <span class="disease-risk-badge ${lb.risk_level.toLowerCase()}">${lb.risk_level}</span>
                        </div>
                        <div class="disease-meter">
                            <div class="disease-meter-fill ${lb.risk_level.toLowerCase()}" style="width: ${pct}%"></div>
                        </div>
                        <div class="disease-details">
                            <strong>DSV: ${lb.dsv}/25</strong> ‚Ä¢ ${lb.conditions}
                            <br><em>${lb.recommendation}</em>
                        </div>
                    </div>
                `;
            }

            // Early Blight
            if (risk.early_blight) {
                const eb = risk.early_blight;
                html += `
                    <div class="disease-card">
                        <div class="disease-header">
                            <span class="disease-name">Early Blight (Alternaria)</span>
                            <span class="disease-risk-badge ${eb.risk_level.toLowerCase()}">${eb.risk_level}</span>
                        </div>
                        <div class="disease-meter">
                            <div class="disease-meter-fill ${eb.risk_level.toLowerCase()}" style="width: ${eb.score}%"></div>
                        </div>
                        <div class="disease-details">
                            <strong>Score: ${eb.score}/100</strong> ‚Ä¢ ${eb.conditions}
                            <br><em>${eb.recommendation}</em>
                        </div>
                    </div>
                `;
            }

            // Downy Mildew
            if (risk.downy_mildew) {
                const dm = risk.downy_mildew;
                html += `
                    <div class="disease-card">
                        <div class="disease-header">
                            <span class="disease-name">Downy Mildew</span>
                            <span class="disease-risk-badge ${dm.risk_level.toLowerCase()}">${dm.risk_level}</span>
                        </div>
                        <div class="disease-meter">
                            <div class="disease-meter-fill ${dm.risk_level.toLowerCase()}" style="width: ${dm.score}%"></div>
                        </div>
                        <div class="disease-details">
                            <strong>Score: ${dm.score}/100</strong> ‚Ä¢ ${dm.conditions}
                            <br><em>${dm.recommendation}</em>
                        </div>
                    </div>
                `;
            }

            document.getElementById('diseaseRiskContent').innerHTML = html;
        }

        function renderHarvestPredictions() {
            const predictions = dashboardData.harvest_predictions;
            if (!predictions || predictions.length === 0) {
                document.getElementById('harvestContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üå±</div><p>No active plantings to track</p></div>';
                document.getElementById('harvestCount').textContent = '0 crops';
                return;
            }

            document.getElementById('harvestCount').textContent = `${predictions.length} crops`;

            const html = predictions.map(pred => `
                <div class="harvest-item">
                    <div class="harvest-header">
                        <span class="harvest-crop">${pred.crop}</span>
                        <span class="harvest-date">${formatDate(pred.predicted_harvest)}</span>
                    </div>
                    <div class="harvest-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pred.percent_complete}%"></div>
                        </div>
                        <div class="progress-labels">
                            <span>Planted: ${formatDate(pred.plant_date)}</span>
                            <span>${pred.percent_complete}% complete</span>
                        </div>
                    </div>
                    <div class="harvest-details">
                        <div class="harvest-detail">
                            <div class="harvest-detail-value">${pred.gdd_accumulated}</div>
                            <div class="harvest-detail-label">GDD Accumulated</div>
                        </div>
                        <div class="harvest-detail">
                            <div class="harvest-detail-value">${pred.gdd_target - pred.gdd_accumulated}</div>
                            <div class="harvest-detail-label">GDD Remaining</div>
                        </div>
                        <div class="harvest-detail">
                            <div class="harvest-detail-value">${pred.days_remaining}d</div>
                            <div class="harvest-detail-label">Days to Harvest</div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('harvestContent').innerHTML = html;
        }

        function renderGDDProgress() {
            const gdd = dashboardData.gdd_summary;
            if (!gdd) {
                document.getElementById('gddContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üå°Ô∏è</div><p>No GDD data available</p></div>';
                return;
            }

            document.getElementById('seasonGDD').textContent = `${gdd.season_total} Total`;

            const html = `
                <div class="gdd-summary">
                    <div class="gdd-stat">
                        <div class="gdd-stat-value">${gdd.today.toFixed(1)}</div>
                        <div class="gdd-stat-label">GDD Today</div>
                    </div>
                    <div class="gdd-stat">
                        <div class="gdd-stat-value">${gdd.last_7_days}</div>
                        <div class="gdd-stat-label">Last 7 Days</div>
                    </div>
                    <div class="gdd-stat">
                        <div class="gdd-stat-value">${gdd.last_30_days}</div>
                        <div class="gdd-stat-label">Last 30 Days</div>
                    </div>
                    <div class="gdd-stat">
                        <div class="gdd-stat-value">${gdd.season_total}</div>
                        <div class="gdd-stat-label">Season Total</div>
                    </div>
                </div>
                <div style="text-align: center; color: var(--text-secondary); font-size: 13px;">
                    Season started: ${formatDate(gdd.season_start)} (Base 50¬∞F)
                </div>
            `;

            document.getElementById('gddContent').innerHTML = html;
        }

        function renderAlerts() {
            const alerts = dashboardData.alerts;
            const alertsCard = document.getElementById('alertsCard');
            const alertsContent = document.getElementById('alertsContent');

            if (!alerts || alerts.length === 0) {
                alertsCard.style.display = 'none';
                return;
            }

            alertsCard.style.display = 'block';

            const html = alerts.map(alert => `
                <div class="alert ${alert.type}">
                    <div class="alert-icon">${alert.type === 'danger' ? 'üî¥' : alert.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-message">${alert.message}</div>
                    </div>
                </div>
            `).join('');

            alertsContent.innerHTML = html;
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function getWeatherIcon(conditions) {
            const lower = conditions.toLowerCase();
            if (lower.includes('rain') || lower.includes('shower')) return 'üåßÔ∏è';
            if (lower.includes('cloud') && lower.includes('part')) return '‚õÖ';
            if (lower.includes('cloud') || lower.includes('overcast')) return '‚òÅÔ∏è';
            if (lower.includes('storm') || lower.includes('thunder')) return '‚õàÔ∏è';
            if (lower.includes('snow')) return 'üå®Ô∏è';
            if (lower.includes('fog') || lower.includes('mist')) return 'üå´Ô∏è';
            return '‚òÄÔ∏è';
        }

        function getMaxRiskLevel(risk) {
            const levels = ['LOW', 'MODERATE', 'HIGH'];
            let maxLevel = 'LOW';
            for (const key of Object.keys(risk)) {
                const level = risk[key].risk_level;
                if (levels.indexOf(level) > levels.indexOf(maxLevel)) {
                    maxLevel = level;
                }
            }
            return maxLevel;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================
        document.addEventListener('keydown', function(e) {
            if (e.target.matches('input, textarea, select')) return;
            const key = e.key.toLowerCase();
            switch (key) {
                case 'r': loadAllData(); break;
                case 'p': window.print(); break;
                case 'h': window.location.href = '../index.html'; break;
                case '?': toggleKeyboardHelp(); break;
                case 'escape': document.getElementById('keyboardHelp')?.classList.remove('visible'); break;
            }
        });

        function toggleKeyboardHelp() {
            document.getElementById('keyboardHelp')?.classList.toggle('visible');
        }

        // ========================================
        // INITIALIZE
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setInterval(loadAllData, 5 * 60 * 1000);
        });
    </script>

    <div class="keyboard-help" id="keyboardHelp">
        <h4>Keyboard Shortcuts</h4>
        <div><kbd>R</kbd> Refresh data</div>
        <div><kbd>P</kbd> Print report</div>
        <div><kbd>H</kbd> Home</div>
        <div><kbd>?</kbd> Toggle help</div>
        <div><kbd>Esc</kbd> Close help</div>
    </div>
</body>
</html>
