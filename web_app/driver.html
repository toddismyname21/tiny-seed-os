<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Tiny Seed Delivery</title>
    <link rel="manifest" href="manifest-driver.json">
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #22c55e;
            --primary-dark: #16a34a;
            --primary-light: #4ade80;
            --secondary: #3b82f6;
            --warning: #f59e0b;
            --danger: #ef4444;
            --success: #22c55e;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-elevated: #334155;
            --bg-input: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --touch-min: 48px;
            --header-height: 56px;
            --bottom-nav-height: 64px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* App Container */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* Header */
        .app-header {
            height: var(--header-height);
            padding-top: var(--safe-top);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 16px;
            padding-right: 16px;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--bg-elevated);
            border: none;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .header-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.online {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .status-badge.offline {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            padding: 24px;
            text-align: center;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .pin-display {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            transition: all 0.2s;
        }

        .pin-dot.filled {
            background: var(--primary);
            border-color: var(--primary);
        }

        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 280px;
        }

        .pin-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-appearance: none;
            appearance: none;
            pointer-events: auto;
        }

        .pin-btn:active {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(0.95);
        }

        .pin-btn.action {
            font-size: 20px;
            background: transparent;
            border: none;
        }

        .login-error {
            color: var(--danger);
            margin-top: 16px;
            font-size: 14px;
        }

        /* Route Summary */
        .route-summary {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            padding: 20px;
            color: white;
        }

        .route-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            text-align: center;
        }

        .route-stat {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 12px 8px;
        }

        .route-stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .route-stat-label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .route-progress {
            margin-top: 16px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            opacity: 0.9;
        }

        /* Start Route Button */
        .start-route-btn {
            width: 100%;
            padding: 16px;
            background: white;
            color: var(--primary-dark);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .start-route-btn:active {
            transform: scale(0.98);
        }

        .start-route-btn.in-progress {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Stop List */
        .stop-list {
            padding: 16px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .section-badge {
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Stop Card */
        .stop-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stop-card.current {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }

        .stop-card.completed {
            opacity: 0.6;
        }

        .stop-card.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 40%, rgba(34, 197, 94, 0.1) 100%);
        }

        .stop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stop-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .stop-card.current .stop-number {
            background: var(--primary);
            color: white;
        }

        .stop-card.completed .stop-number {
            background: var(--success);
            color: white;
        }

        .stop-info {
            flex: 1;
            margin-left: 12px;
        }

        .stop-customer {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .stop-address {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }

        .stop-eta {
            text-align: right;
        }

        .stop-time {
            font-weight: 600;
            font-size: 14px;
        }

        .stop-window {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stop-items {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .stop-items-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stop-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 14px;
        }

        .stop-item-name {
            color: var(--text-primary);
        }

        .stop-item-qty {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stop-notes {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--warning);
            padding: 8px 12px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 12px;
            font-size: 13px;
            color: var(--warning);
        }

        /* Delivery Count Badges */
        .delivery-count-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .delivery-count-badge.csa {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }

        .delivery-count-badge.csa.flower {
            background: rgba(236, 72, 153, 0.15);
            border: 1px solid rgba(236, 72, 153, 0.3);
            color: #f472b6;
        }

        .delivery-count-badge.wholesale {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .delivery-count-badge .count-icon {
            font-size: 24px;
        }

        .delivery-count-badge .count-number {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
        }

        .delivery-count-badge .count-label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }

        .stop-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .stop-action-btn {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stop-action-btn:active {
            background: var(--bg-dark);
        }

        .stop-action-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            grid-column: span 3;
            flex-direction: row;
            justify-content: center;
            padding: 14px;
            font-size: 14px;
        }

        .stop-action-btn.primary:active {
            background: var(--primary-dark);
        }

        .stop-action-icon {
            font-size: 18px;
        }

        /* Completed Badge */
        .completed-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            height: var(--bottom-nav-height);
            padding-bottom: var(--safe-bottom);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 11px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 22px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-height: 90vh;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Proof of Delivery */
        .pod-section {
            margin-bottom: 24px;
        }

        .pod-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .photo-capture {
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--bg-dark);
            border-radius: 12px;
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .photo-capture.has-photo {
            border-style: solid;
            border-color: var(--primary);
        }

        .photo-capture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .photo-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .retake-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Signature Pad */
        .signature-pad {
            width: 100%;
            height: 150px;
            background: white;
            border-radius: 12px;
            position: relative;
        }

        .signature-canvas {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        .signature-clear {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 6px 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .signature-line {
            position: absolute;
            bottom: 40px;
            left: 20px;
            right: 20px;
            height: 1px;
            background: #ccc;
        }

        .signature-label {
            position: absolute;
            bottom: 16px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 11px;
            color: #999;
        }

        /* GPS Status */
        .gps-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 8px;
            font-size: 14px;
        }

        .gps-status.valid {
            color: var(--success);
        }

        .gps-status.invalid {
            color: var(--danger);
        }

        /* Issue Report */
        .issue-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .issue-option {
            padding: 16px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .issue-option:active,
        .issue-option.selected {
            border-color: var(--primary);
            background: rgba(34, 197, 94, 0.1);
        }

        .issue-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .issue-label {
            font-size: 13px;
            font-weight: 500;
        }

        .issue-textarea {
            width: 100%;
            height: 100px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            margin-top: 16px;
        }

        .issue-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }

        .submit-btn:active {
            background: var(--primary-dark);
        }

        .submit-btn:disabled {
            background: var(--bg-elevated);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* History Tab */
        .history-list {
            padding: 16px;
        }

        .history-date {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .history-status {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .history-status.delivered {
            background: rgba(34, 197, 94, 0.2);
        }

        .history-status.issue {
            background: rgba(245, 158, 11, 0.2);
        }

        .history-details {
            flex: 1;
        }

        .history-customer {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .history-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Settings Tab */
        .settings-section {
            padding: 16px;
        }

        .settings-group {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 15px;
        }

        .settings-value {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Toggle Switch */
        .toggle {
            width: 52px;
            height: 28px;
            background: var(--bg-elevated);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--primary);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle.active::after {
            transform: translateX(24px);
        }

        /* Driver Info Card */
        .driver-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin: 16px;
            text-align: center;
        }

        .driver-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            margin: 0 auto 12px;
        }

        .driver-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .driver-role {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .driver-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .driver-stat {
            text-align: center;
        }

        .driver-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .driver-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Logout Button */
        .logout-btn {
            width: calc(100% - 32px);
            margin: 16px;
            padding: 16px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Map Container */
        .map-container {
            height: 200px;
            background: var(--bg-dark);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        .map-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .map-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .open-maps-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            padding: 10px 16px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* No Route */
        .no-route {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            text-align: center;
        }

        .no-route-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .no-route-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .no-route-text {
            color: var(--text-secondary);
            max-width: 280px;
        }

        /* Offline Indicator */
        .offline-bar {
            background: var(--danger);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            display: none;
        }

        .offline-bar.visible {
            display: block;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
        }

        .quick-action {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
        }

        .quick-action:active {
            background: var(--bg-elevated);
        }

        .quick-action-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-size: 13px;
            font-weight: 500;
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-elevated);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 24px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Delivery complete celebration */
        .celebration {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .celebration.active {
            opacity: 1;
            visibility: visible;
        }

        .celebration-icon {
            font-size: 80px;
            animation: bounce 0.6s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .celebration-title {
            font-size: 28px;
            font-weight: 700;
            margin: 16px 0 8px;
        }

        .celebration-text {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .celebration-btn {
            margin-top: 32px;
            padding: 14px 32px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Call/Text buttons */
        .contact-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .contact-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .contact-btn.call {
            background: var(--secondary);
            color: white;
        }

        .contact-btn.text {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        /* Hidden file input */
        input[type="file"] {
            display: none;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .app-container {
                max-width: 480px;
                margin: 0 auto;
                box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
            }
        }

        /* Map View Styles */
        #mapTab {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #deliveryMap {
            flex: 1;
            min-height: 300px;
            background: var(--bg-card);
        }

        .map-controls {
            padding: 12px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
        }

        .optimize-btn {
            width: 100%;
            padding: 14px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .optimize-btn:active {
            transform: scale(0.98);
        }

        /* Navigation Picker Modal */
        .nav-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }

        .nav-picker-overlay.active {
            display: flex;
        }

        .nav-picker {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .nav-picker-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 16px;
        }

        .nav-picker-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
        }

        .nav-option:active {
            background: var(--primary);
        }

        .nav-option-icon {
            font-size: 28px;
        }

        .nav-picker-cancel {
            width: 100%;
            padding: 16px;
            margin-top: 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
        }

        /* Navigate Button on Stop Cards */
        .navigate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .navigate-btn:active {
            transform: scale(0.98);
        }

        /* Welcome Message */
        .welcome-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            z-index: 1000;
            animation: fadeInOut 3s ease forwards;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* Map Markers */
        .custom-marker {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .custom-marker.completed {
            background: var(--text-muted);
        }

        .custom-marker.current {
            background: var(--secondary);
            animation: pulse-marker 2s infinite;
        }

        @keyframes pulse-marker {
            0%, 100% { box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 2px 20px rgba(59, 130, 246, 0.8); }
        }

        /* Farm Depot Marker */
        .depot-marker {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.5);
            animation: depot-pulse 3s infinite;
        }

        @keyframes depot-pulse {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(34, 197, 94, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 20px rgba(34, 197, 94, 0.8);
                transform: scale(1.05);
            }
        }

        /* Route summary card */
        .route-summary {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-around;
            gap: 12px;
        }

        .route-stat {
            text-align: center;
        }

        .route-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .route-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Auto-Advance Modal */
        .auto-advance-modal {
            text-align: center;
            padding: 32px 24px;
        }

        .auto-advance-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .auto-advance-title {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .auto-advance-destination {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .auto-advance-address {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .auto-advance-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .auto-advance-actions .btn-lg {
            padding: 16px 24px;
            font-size: 16px;
        }

        /* Professional Map Styling */
        #deliveryMap {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .leaflet-container {
            background: #1a1a2e;
            font-family: inherit;
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .leaflet-popup-content {
            margin: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .leaflet-popup-tip {
            background: var(--bg-card);
        }

        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
        }

        .leaflet-control-zoom a {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border: none !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 36px !important;
            font-size: 18px !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--bg-elevated) !important;
        }

        .leaflet-control-attribution {
            background: rgba(15, 23, 42, 0.8) !important;
            color: var(--text-muted) !important;
            font-size: 10px;
        }

        .leaflet-control-attribution a {
            color: var(--text-secondary) !important;
        }

        /* Map route info bar */
        .map-info-bar {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-info-item {
            text-align: center;
        }

        .map-info-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .map-info-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Offline Bar -->
        <div class="offline-bar" id="offlineBar">
            You're offline - deliveries will sync when connected
        </div>

        <!-- Header -->
        <header class="app-header" id="appHeader" style="display: none;">
            <div class="header-left">
                <div>
                    <div class="header-title">Tiny Seed Delivery</div>
                    <div class="header-subtitle" id="routeDate">Today's Route</div>
                </div>
            </div>
            <div class="header-actions">
                <span class="status-badge online" id="statusBadge">
                    <span class="status-dot"></span>
                    Online
                </span>
                <button class="header-btn" onclick="refreshRoute()">
                    <span>&#x21bb;</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Login Screen -->
            <div class="login-screen" id="loginScreen">
                <div class="login-logo">&#x1F331;</div>
                <h1 class="login-title">Tiny Seed Delivery</h1>
                <p class="login-subtitle">Enter your 4-digit PIN</p>

                <div class="pin-display">
                    <div class="pin-dot" id="pin1"></div>
                    <div class="pin-dot" id="pin2"></div>
                    <div class="pin-dot" id="pin3"></div>
                    <div class="pin-dot" id="pin4"></div>
                </div>

                <div class="pin-pad">
                    <button type="button" class="pin-btn" onclick="enterPinDigit('1')">1</button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('2')">2</button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('3')">3</button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('4')">4</button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('5')">5</button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('6')">6</button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('7')">7</button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('8')">8</button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('9')">9</button>
                    <button type="button" class="pin-btn action"></button>
                    <button type="button" class="pin-btn" onclick="enterPinDigit('0')">0</button>
                    <button type="button" class="pin-btn action" onclick="clearPinDigit()">&#x232B;</button>
                </div>

                <div class="login-error" id="loginError"></div>
            </div>

            <!-- Welcome Toast (hidden by default) -->
            <div id="welcomeToast" class="welcome-toast" style="display:none;"></div>

            <!-- Navigation Picker Modal -->
            <div class="nav-picker-overlay" id="navPickerOverlay" onclick="closeNavPicker(event)">
                <div class="nav-picker" onclick="event.stopPropagation()">
                    <div class="nav-picker-title">Open in Maps</div>
                    <div class="nav-picker-options" id="navPickerOptions">
                        <!-- Options populated dynamically -->
                    </div>
                    <button class="nav-picker-cancel" onclick="closeNavPicker()">Cancel</button>
                </div>
            </div>

            <!-- Route Tab -->
            <div class="tab-content" id="routeTab">
                <!-- Route Summary -->
                <div class="route-summary" id="routeSummary">
                    <div class="route-stats">
                        <div class="route-stat">
                            <div class="route-stat-value" id="totalStops">0</div>
                            <div class="route-stat-label">Stops</div>
                        </div>
                        <div class="route-stat">
                            <div class="route-stat-value" id="completedStops">0</div>
                            <div class="route-stat-label">Done</div>
                        </div>
                        <div class="route-stat">
                            <div class="route-stat-value" id="totalMiles">0</div>
                            <div class="route-stat-label">Miles</div>
                        </div>
                        <div class="route-stat">
                            <div class="route-stat-value" id="estTime">0h</div>
                            <div class="route-stat-label">ETA</div>
                        </div>
                    </div>
                    <div class="route-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressText">0 of 0 deliveries</span>
                            <span id="progressPercent">0%</span>
                        </div>
                    </div>
                    <button class="start-route-btn" id="startRouteBtn" onclick="startRoute()">
                        <span>&#x25B6;</span> Start Route
                    </button>
                </div>

                <!-- Stop List -->
                <div class="stop-list" id="stopList">
                    <!-- Stops rendered here -->
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-content" id="historyTab">
                <div class="history-list" id="historyList">
                    <!-- History rendered here -->
                </div>
            </div>

            <!-- Map Tab -->
            <div class="tab-content" id="mapTab">
                <div id="deliveryMap"></div>
                <div class="map-controls">
                    <button class="optimize-btn" onclick="optimizeRoute()">
                        <span>&#x1F504;</span> Optimize Route
                    </button>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settingsTab">
                <div class="driver-card">
                    <div class="driver-avatar" id="driverAvatar">JD</div>
                    <div class="driver-name" id="driverName">John Doe</div>
                    <div class="driver-role">Delivery Driver</div>
                    <div class="driver-stats">
                        <div class="driver-stat">
                            <div class="driver-stat-value" id="todayDeliveries">0</div>
                            <div class="driver-stat-label">Today</div>
                        </div>
                        <div class="driver-stat">
                            <div class="driver-stat-value" id="weekDeliveries">0</div>
                            <div class="driver-stat-label">This Week</div>
                        </div>
                        <div class="driver-stat">
                            <div class="driver-stat-value" id="totalDeliveries">0</div>
                            <div class="driver-stat-label">All Time</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-group">
                        <div class="settings-item">
                            <span class="settings-label">Navigation App</span>
                            <span class="settings-value">Google Maps</span>
                        </div>
                        <div class="settings-item">
                            <span class="settings-label">Auto-open navigation</span>
                            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
                        </div>
                        <div class="settings-item">
                            <span class="settings-label">Sound alerts</span>
                            <div class="toggle active" onclick="this.classList.toggle('active')"></div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-item">
                            <span class="settings-label">Photo quality</span>
                            <span class="settings-value">High</span>
                        </div>
                        <div class="settings-item">
                            <span class="settings-label">Require signature</span>
                            <div class="toggle" onclick="this.classList.toggle('active')"></div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-item">
                            <span class="settings-label">App version</span>
                            <span class="settings-value">1.0.0</span>
                        </div>
                    </div>
                </div>

                <button class="logout-btn" onclick="logout()">Log Out</button>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="switchTab('route')">
                <span class="nav-icon">&#x1F4CD;</span>
                <span>Route</span>
            </div>
            <div class="nav-item" onclick="switchTab('map')">
                <span class="nav-icon">&#x1F5FA;</span>
                <span>Map</span>
            </div>
            <div class="nav-item" onclick="switchTab('history')">
                <span class="nav-icon">&#x1F4CB;</span>
                <span>History</span>
            </div>
            <div class="nav-item" onclick="switchTab('settings')">
                <span class="nav-icon">&#x2699;</span>
                <span>Settings</span>
            </div>
        </nav>
    </div>

    <!-- Proof of Delivery Modal -->
    <div class="modal-overlay" id="podModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Complete Delivery</h2>
                <button class="modal-close" onclick="closeModal('podModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="pod-section">
                    <div class="pod-label">Delivery Photo</div>
                    <div class="photo-capture" id="deliveryPhoto" onclick="capturePhoto()">
                        <div class="photo-placeholder">
                            <div class="photo-icon">&#x1F4F7;</div>
                            <div>Tap to take photo</div>
                        </div>
                    </div>
                </div>

                <div class="pod-section">
                    <div class="pod-label">GPS Location</div>
                    <div class="gps-status" id="gpsStatus">
                        <span>&#x1F4CD;</span>
                        <span>Acquiring location...</span>
                    </div>
                </div>

                <div class="pod-section">
                    <div class="pod-label">Customer Signature (Optional)</div>
                    <div class="signature-pad">
                        <canvas class="signature-canvas" id="signatureCanvas"></canvas>
                        <button class="signature-clear" onclick="clearSignature()">Clear</button>
                        <div class="signature-line"></div>
                        <div class="signature-label">Sign above the line</div>
                    </div>
                </div>

                <button class="submit-btn" id="completeDeliveryBtn" onclick="completeDelivery()">
                    Complete Delivery
                </button>
            </div>
        </div>
    </div>

    <!-- Issue Report Modal -->
    <div class="modal-overlay" id="issueModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Report Issue</h2>
                <button class="modal-close" onclick="closeModal('issueModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="issue-options">
                    <div class="issue-option" onclick="selectIssue(this, 'not_home')">
                        <div class="issue-icon">&#x1F3E0;</div>
                        <div class="issue-label">Not Home</div>
                    </div>
                    <div class="issue-option" onclick="selectIssue(this, 'refused')">
                        <div class="issue-icon">&#x1F6AB;</div>
                        <div class="issue-label">Refused</div>
                    </div>
                    <div class="issue-option" onclick="selectIssue(this, 'wrong_address')">
                        <div class="issue-icon">&#x2753;</div>
                        <div class="issue-label">Wrong Address</div>
                    </div>
                    <div class="issue-option" onclick="selectIssue(this, 'damaged')">
                        <div class="issue-icon">&#x1F4E6;</div>
                        <div class="issue-label">Damaged</div>
                    </div>
                </div>

                <textarea class="issue-textarea" id="issueNotes" placeholder="Add details about the issue..."></textarea>

                <div class="pod-section" style="margin-top: 16px;">
                    <div class="pod-label">Photo (Optional)</div>
                    <div class="photo-capture" id="issuePhoto" onclick="captureIssuePhoto()">
                        <div class="photo-placeholder">
                            <div class="photo-icon">&#x1F4F7;</div>
                            <div>Tap to take photo</div>
                        </div>
                    </div>
                </div>

                <button class="submit-btn" id="submitIssueBtn" onclick="submitIssue()" disabled>
                    Submit Issue Report
                </button>
            </div>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div class="celebration" id="celebration">
        <div class="celebration-icon">&#x1F389;</div>
        <div class="celebration-title">Route Complete!</div>
        <div class="celebration-text">Great job! All deliveries finished.</div>
        <button class="celebration-btn" onclick="closeCelebration()">View Summary</button>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhoto(event)">
    <input type="file" id="issuePhotoInput" accept="image/*" capture="environment" onchange="handleIssuePhoto(event)">

    <!-- API configuration removed - using self-contained version -->

    <script>
        // ============================================
        // SELF-CONTAINED DRIVER API (no dependencies)
        // ============================================
        var api = {
            authenticateDriver: function(pin) { return Promise.resolve({ success: false }); },
            getDriverRoute: function(driverId, date) { return Promise.resolve({ success: false }); },
            getDeliveryHistory: function(driverId, days) { return Promise.resolve({ success: false, deliveries: [] }); },
            updateDeliveryStatus: function(data) { console.log('Delivery:', data); return Promise.resolve({ success: true }); },
            updateDriverLocation: function(data) { return Promise.resolve({ success: true }); }
        };

        // ============================================
        // APPLICATION STATE
        // ============================================
        let AppState = {
            isLoggedIn: false,
            driver: null,
            pin: '',
            currentTab: 'route',
            route: {
                stops: [],
                isStarted: false,
                currentStopIndex: -1,
                routeId: null
            },
            currentStop: null,
            deliveryPhoto: null,
            issuePhoto: null,
            selectedIssue: null,
            gpsLocation: null,
            signature: null,
            history: [],
            isOnline: navigator.onLine,
            // Real-time tracking
            tracking: {
                active: false,
                id: null,
                watchId: null,
                lastUpdate: null,
                updateInterval: null
            }
        };

        // ============================================
        // SAMPLE DATA
        // ============================================
        const SAMPLE_DRIVERS = [
            { id: 'DRV-001', name: 'Todd Pollack', pin: '7714', initials: 'TP' },
            { id: 'DRV-002', name: 'Samantha Pollack', pin: '1234', initials: 'SP' },
            { id: 'DRV-003', name: 'Sarah Chen', pin: '5678', initials: 'SC' }
        ];

        const SAMPLE_ROUTE = [
            {
                id: 'STOP-001',
                customer: 'Cafe Aroma',
                address: '1234 Main St, Pittsburgh PA 15213',
                phone: '412-555-0101',
                deliveryWindow: '8:00 AM - 10:00 AM',
                eta: '8:30 AM',
                items: [
                    { name: 'Mixed Salad Greens', qty: '5 lbs' },
                    { name: 'Cherry Tomatoes', qty: '3 pints' },
                    { name: 'Fresh Basil', qty: '2 bunches' }
                ],
                notes: 'Use side entrance. Ring bell twice.',
                lat: 40.4406,
                lng: -79.9959,
                status: 'pending'
            },
            {
                id: 'STOP-002',
                customer: 'Green Plate Kitchen',
                address: '567 Oak Ave, Pittsburgh PA 15232',
                phone: '412-555-0102',
                deliveryWindow: '9:00 AM - 11:00 AM',
                eta: '9:15 AM',
                items: [
                    { name: 'Rainbow Chard', qty: '4 bunches' },
                    { name: 'Baby Kale', qty: '3 lbs' },
                    { name: 'Microgreens Mix', qty: '1 lb' }
                ],
                notes: '',
                lat: 40.4528,
                lng: -79.9351,
                status: 'pending'
            },
            {
                id: 'STOP-003',
                customer: 'Farm Fresh Bistro',
                address: '890 Walnut St, Pittsburgh PA 15206',
                phone: '412-555-0103',
                deliveryWindow: '10:00 AM - 12:00 PM',
                eta: '10:00 AM',
                items: [
                    { name: 'Heirloom Tomatoes', qty: '8 lbs' },
                    { name: 'Sweet Peppers', qty: '5 lbs' },
                    { name: 'Summer Squash', qty: '6 lbs' }
                ],
                notes: 'Ask for Chef Maria',
                lat: 40.4621,
                lng: -79.9241,
                status: 'pending'
            },
            {
                id: 'STOP-004',
                customer: 'The Healthy Table',
                address: '321 Pine Rd, Pittsburgh PA 15217',
                phone: '412-555-0104',
                deliveryWindow: '11:00 AM - 1:00 PM',
                eta: '11:15 AM',
                items: [
                    { name: 'Spinach', qty: '4 lbs' },
                    { name: 'Arugula', qty: '2 lbs' },
                    { name: 'Fresh Herbs Mix', qty: '3 bunches' }
                ],
                notes: '',
                lat: 40.4312,
                lng: -79.9223,
                status: 'pending'
            },
            {
                id: 'STOP-005',
                customer: 'Sunrise Market',
                address: '555 Elm Blvd, Pittsburgh PA 15201',
                phone: '412-555-0105',
                deliveryWindow: '12:00 PM - 2:00 PM',
                eta: '12:30 PM',
                items: [
                    { name: 'CSA Box - Large', qty: '10 boxes' },
                    { name: 'Seasonal Flowers', qty: '5 bouquets' }
                ],
                notes: 'Loading dock in back',
                lat: 40.4789,
                lng: -79.9512,
                status: 'pending'
            },
            {
                id: 'STOP-HOME',
                customer: 'Todd Pollack (Home)',
                address: '102 N Pittsburgh St, Zelienople PA 16063',
                phone: '7177255177',
                deliveryWindow: '1:00 PM - 3:00 PM',
                eta: '1:30 PM',
                items: [
                    { name: 'Test Veg CSA Box', qty: '1 box' },
                    { name: 'Test Flower Bouquet', qty: '1 bouquet' }
                ],
                notes: 'SMS test delivery - send to both numbers',
                lat: 40.7945,
                lng: -80.1393,
                status: 'pending',
                sendSmsOnComplete: true,
                smsRecipients: ['7177255177', '5612364638']
            }
        ];

        const SAMPLE_HISTORY = [
            { customer: 'Cafe Aroma', time: '8:32 AM', status: 'delivered' },
            { customer: 'Green Plate Kitchen', time: '9:18 AM', status: 'delivered' },
            { customer: 'Quick Stop Deli', time: '10:05 AM', status: 'issue', issueType: 'not_home' }
        ];

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            checkOnlineStatus();
            initSignatureCanvas();
            checkSession();
        });

        function checkSession() {
            const session = localStorage.getItem('driverSession');
            if (session) {
                const data = JSON.parse(session);
                AppState.isLoggedIn = true;
                AppState.driver = data.driver;
                showApp();
                loadRoute();
            }
        }

        function checkOnlineStatus() {
            window.addEventListener('online', () => {
                AppState.isOnline = true;
                updateOnlineStatus();
                syncOfflineData();
            });

            window.addEventListener('offline', () => {
                AppState.isOnline = false;
                updateOnlineStatus();
            });

            updateOnlineStatus();
        }

        function updateOnlineStatus() {
            const bar = document.getElementById('offlineBar');
            const badge = document.getElementById('statusBadge');

            if (AppState.isOnline) {
                bar.classList.remove('visible');
                badge.className = 'status-badge online';
                badge.innerHTML = '<span class="status-dot"></span> Online';
            } else {
                bar.classList.add('visible');
                badge.className = 'status-badge offline';
                badge.innerHTML = '<span class="status-dot"></span> Offline';
            }
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        function enterPin(digit) {
            try {
                if (AppState.pin.length < 4) {
                    AppState.pin = AppState.pin + String(digit);
                    updatePinDisplay();

                    if (AppState.pin.length === 4) {
                        setTimeout(validatePin, 200);
                    }
                }
            } catch (e) {
                alert('enterPin error: ' + e.message);
            }
        }

        function clearPin() {
            try {
                if (AppState.pin.length > 0) {
                    AppState.pin = AppState.pin.slice(0, -1);
                }
                updatePinDisplay();
            } catch (e) {
                alert('clearPin error: ' + e.message);
            }
        }

        function updatePinDisplay() {
            try {
                var pin1 = document.getElementById('pin1');
                var pin2 = document.getElementById('pin2');
                var pin3 = document.getElementById('pin3');
                var pin4 = document.getElementById('pin4');
                var len = AppState.pin.length;

                if (pin1) {
                    if (len >= 1) { pin1.classList.add('filled'); } else { pin1.classList.remove('filled'); }
                }
                if (pin2) {
                    if (len >= 2) { pin2.classList.add('filled'); } else { pin2.classList.remove('filled'); }
                }
                if (pin3) {
                    if (len >= 3) { pin3.classList.add('filled'); } else { pin3.classList.remove('filled'); }
                }
                if (pin4) {
                    if (len >= 4) { pin4.classList.add('filled'); } else { pin4.classList.remove('filled'); }
                }

                var errorEl = document.getElementById('loginError');
                if (errorEl) {
                    errorEl.textContent = '';
                }
            } catch (e) {
                alert('updatePinDisplay error: ' + e.message);
            }
        }

        function validatePin() {
            var pin = window.pinValue || AppState.pin || '';

            // Try sample drivers first for demo mode
            var driver = SAMPLE_DRIVERS.find(function(d) { return d.pin === pin; });
            if (driver) {
                AppState.driver = driver;
                AppState.isLoggedIn = true;
                localStorage.setItem('driverSession', JSON.stringify({
                    driver: driver,
                    loginTime: new Date().toISOString()
                }));
                showApp();
                loadRoute();
                return;
            }

            // If no sample driver matched, show error
            showLoginError('Invalid PIN. Please try again.');
        }

        function showLoginError(message) {
            document.getElementById('loginError').textContent = message;
            window.pinValue = '';
            AppState.pin = '';
            document.getElementById('pinDebug').textContent = '____';
            document.getElementById('pin1').style.background = '#334155';
            document.getElementById('pin2').style.background = '#334155';
            document.getElementById('pin3').style.background = '#334155';
            document.getElementById('pin4').style.background = '#334155';
        }

        function logout() {
            localStorage.removeItem('driverSession');
            AppState.isLoggedIn = false;
            AppState.driver = null;
            AppState.pin = '';
            window.pinValue = '';
            AppState.route = { stops: [], isStarted: false, currentStopIndex: -1 };

            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appHeader').style.display = 'none';
            document.getElementById('bottomNav').style.display = 'none';
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById('pinDebug').textContent = '____';
            document.getElementById('pin1').style.background = '#334155';
            document.getElementById('pin2').style.background = '#334155';
            document.getElementById('pin3').style.background = '#334155';
            document.getElementById('pin4').style.background = '#334155';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appHeader').style.display = 'flex';
            document.getElementById('bottomNav').style.display = 'flex';

            // Update driver info
            if (AppState.driver) {
                document.getElementById('driverAvatar').textContent = AppState.driver.initials;
                document.getElementById('driverName').textContent = AppState.driver.name;
            }

            switchTab('route');
        }

        // ============================================
        // ROUTE MANAGEMENT
        // ============================================
        async function loadRoute() {
            try {
                // Fetch today's route from API
                const today = new Date().toISOString().split('T')[0];
                const result = await api.getDriverRoute(AppState.driver?.id, today);

                if (result.success && result.stops) {
                    // Transform API response to app format
                    AppState.route.stops = result.stops.map(stop => ({
                        id: stop.Delivery_ID || stop.Stop_ID,
                        orderId: stop.Order_ID,
                        customer: stop.Customer_Name,
                        address: stop.Delivery_Address || stop.Address,
                        phone: stop.Customer_Phone || stop.Phone || '',
                        email: stop.Customer_Email || '',
                        customerType: stop.Customer_Type || 'Retail',
                        company: stop.Customer_Company || '',
                        deliveryWindow: stop.Delivery_Window || 'Flexible',
                        eta: stop.ETA || '--:--',
                        items: stop.items || [],
                        notes: stop.Delivery_Notes || '',
                        lat: stop.GPS_Lat,
                        lng: stop.GPS_Lng,
                        status: (stop.Status || 'pending').toLowerCase(),
                        // CSA specific
                        boxCount: stop.Box_Count || 1,
                        shareType: stop.Share_Type || 'Veggie',
                        // Wholesale specific
                        itemCount: stop.Item_Count || 0,
                        totalUnits: stop.Total_Units || 0
                    }));

                    // Load delivery history
                    const historyResult = await api.getDeliveryHistory(AppState.driver?.id, 7);
                    if (historyResult.success) {
                        AppState.history = historyResult.deliveries || [];
                    }
                } else {
                    // Fallback to sample data for demo
                    console.log('Using sample route data');
                    AppState.route.stops = [...SAMPLE_ROUTE];
                    AppState.history = [...SAMPLE_HISTORY];
                }
            } catch (error) {
                console.error('Error loading route:', error);
                // Fallback to sample data for offline/demo mode
                AppState.route.stops = [...SAMPLE_ROUTE];
                AppState.history = [...SAMPLE_HISTORY];
            }

            updateRouteStats();
            renderStops();
            renderHistory();
        }

        function refreshRoute() {
            const btn = document.querySelector('.header-btn');
            btn.style.animation = 'spin 0.5s linear';

            setTimeout(() => {
                btn.style.animation = '';
                loadRoute();
            }, 500);
        }

        function updateRouteStats() {
            const stops = AppState.route.stops;
            const completed = stops.filter(s => s.status === 'delivered' || s.status === 'issue').length;
            const total = stops.length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalStops').textContent = total;
            document.getElementById('completedStops').textContent = completed;
            document.getElementById('totalMiles').textContent = '24'; // Would calculate actual
            document.getElementById('estTime').textContent = '3h'; // Would calculate actual

            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${completed} of ${total} deliveries`;
            document.getElementById('progressPercent').textContent = `${percent}%`;

            // Update button state
            const startBtn = document.getElementById('startRouteBtn');
            if (AppState.route.isStarted) {
                startBtn.classList.add('in-progress');
                startBtn.innerHTML = '<span>&#x23F8;</span> Route In Progress';
            }

            // Check if route complete
            if (completed === total && total > 0) {
                document.getElementById('celebration').classList.add('active');
                // Stop tracking when route is complete
                stopDeliveryTracking();
            }

            // Update settings stats
            document.getElementById('todayDeliveries').textContent = completed;
            document.getElementById('weekDeliveries').textContent = completed + 12; // Sample
            document.getElementById('totalDeliveries').textContent = completed + 156; // Sample
        }

        function renderStops() {
            const container = document.getElementById('stopList');
            const stops = AppState.route.stops;

            if (stops.length === 0) {
                container.innerHTML = `
                    <div class="no-route">
                        <div class="no-route-icon">&#x1F4E6;</div>
                        <div class="no-route-title">No Deliveries Today</div>
                        <div class="no-route-text">Check back later or contact dispatch if you expected a route.</div>
                    </div>
                `;
                return;
            }

            // Find current stop
            const currentIndex = stops.findIndex(s => s.status === 'pending');
            AppState.route.currentStopIndex = currentIndex;

            let html = `
                <div class="section-header">
                    <span class="section-title">Delivery Stops</span>
                    <span class="section-badge">${stops.filter(s => s.status === 'pending').length} remaining</span>
                </div>
            `;

            stops.forEach((stop, index) => {
                const isCurrent = index === currentIndex && AppState.route.isStarted;
                const isCompleted = stop.status === 'delivered' || stop.status === 'issue';

                // Determine customer type badge and count display
                const typeColor = stop.customerType === 'CSA' ? '#8b5cf6' :
                                  stop.customerType === 'Wholesale' ? '#3b82f6' : '#22c55e';
                const typeBadge = stop.customerType && stop.customerType !== 'Retail' ?
                    `<span style="background: ${typeColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${stop.customerType}</span>` : '';

                // CSA box count or Wholesale item count
                let countDisplay = '';
                if (stop.customerType === 'CSA' && stop.boxCount) {
                    const isFlower = stop.shareType && stop.shareType.toLowerCase().includes('flower');
                    const icon = isFlower ? '&#x1F490;' : '&#x1F4E6;'; //  for flower,  for veggie
                    const label = isFlower ? 'bouquet' : 'box';
                    const badgeClass = isFlower ? 'csa flower' : 'csa';
                    countDisplay = `
                        <div class="delivery-count-badge ${badgeClass}">
                            <span class="count-icon">${icon}</span>
                            <span class="count-number">${stop.boxCount}</span>
                            <span class="count-label">${label}${stop.boxCount > 1 ? 's' : ''}</span>
                        </div>
                    `;
                } else if (stop.customerType === 'Wholesale' && stop.itemCount > 0) {
                    countDisplay = `
                        <div class="delivery-count-badge wholesale">
                            <span class="count-icon">&#x1F4CB;</span>
                            <span class="count-number">${stop.itemCount}</span>
                            <span class="count-label">items (${stop.totalUnits} units)</span>
                        </div>
                    `;
                }

                html += `
                    <div class="stop-card ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}" data-stop-id="${stop.id}">
                        ${isCompleted ? `<div class="completed-badge">${stop.status === 'delivered' ? 'Delivered' : 'Issue'}</div>` : ''}

                        <div class="stop-header">
                            <div class="stop-number">${isCompleted ? '&#x2713;' : index + 1}</div>
                            <div class="stop-info">
                                <div class="stop-customer">${stop.customer} ${typeBadge}</div>
                                <div class="stop-address">${stop.address}</div>
                            </div>
                            <div class="stop-eta">
                                <div class="stop-time">${stop.eta}</div>
                                <div class="stop-window">${stop.deliveryWindow}</div>
                            </div>
                        </div>

                        ${countDisplay}

                        <div class="stop-items">
                            <div class="stop-items-title">Order Items</div>
                            ${stop.items.map(item => `
                                <div class="stop-item">
                                    <span class="stop-item-name">${item.name || item.Product_Name || 'Item'}</span>
                                    <span class="stop-item-qty">${item.qty || item.Quantity || ''} ${item.Unit || ''}</span>
                                </div>
                            `).join('')}
                        </div>

                        ${stop.notes ? `<div class="stop-notes">&#x1F4DD; ${stop.notes}</div>` : ''}

                        ${!isCompleted ? `
                            <div class="contact-actions">
                                <button class="contact-btn call" onclick="callCustomer('${stop.phone}')">
                                    <span>&#x1F4DE;</span> Call
                                </button>
                                <button class="contact-btn text" onclick="textCustomer('${stop.phone}')">
                                    <span>&#x1F4AC;</span> Text
                                </button>
                            </div>

                            <div class="stop-actions" style="margin-top: 12px;">
                                <button class="stop-action-btn" onclick="openNavigation(${stop.lat}, ${stop.lng}, '${encodeURIComponent(stop.address)}')">
                                    <span class="stop-action-icon">&#x1F5FA;</span>
                                    <span>Navigate</span>
                                </button>
                                <button class="stop-action-btn" onclick="openIssueModal('${stop.id}')">
                                    <span class="stop-action-icon">&#x26A0;</span>
                                    <span>Issue</span>
                                </button>
                                <button class="stop-action-btn" onclick="openPODModal('${stop.id}')">
                                    <span class="stop-action-icon">&#x2713;</span>
                                    <span>Delivered</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            const today = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });

            let html = `<div class="history-date">${today}</div>`;

            if (AppState.history.length === 0) {
                html += `
                    <div class="no-route">
                        <div class="no-route-icon">&#x1F4CB;</div>
                        <div class="no-route-title">No History Yet</div>
                        <div class="no-route-text">Completed deliveries will appear here.</div>
                    </div>
                `;
            } else {
                AppState.history.forEach(item => {
                    html += `
                        <div class="history-item">
                            <div class="history-status ${item.status}">
                                ${item.status === 'delivered' ? '&#x2713;' : '&#x26A0;'}
                            </div>
                            <div class="history-details">
                                <div class="history-customer">${item.customer}</div>
                                <div class="history-time">${item.time}${item.issueType ? ' - ' + formatIssueType(item.issueType) : ''}</div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function formatIssueType(type) {
            const types = {
                'not_home': 'Customer Not Home',
                'refused': 'Delivery Refused',
                'wrong_address': 'Wrong Address',
                'damaged': 'Item Damaged'
            };
            return types[type] || type;
        }

        // ============================================
        // ROUTE ACTIONS
        // ============================================
        function startRoute() {
            if (!AppState.route.isStarted) {
                AppState.route.isStarted = true;
                updateRouteStats();
                renderStops();

                // Start real-time tracking
                startDeliveryTracking();

                // Auto-open navigation to first stop if enabled
                const firstPending = AppState.route.stops.find(s => s.status === 'pending');
                if (firstPending) {
                    // Could auto-open maps here
                }
            }
        }

        // ============================================
        // REAL-TIME DELIVERY TRACKING
        // ============================================
        const TRACKING_API_URL = 'https://script.google.com/macros/s/AKfycbx8syGK5Bm60fypNO0yE60BYtTFJXxviaEtgrqENmF5GStB58UCEA4Shu_IF9r6kjf5/exec';

        async function startDeliveryTracking() {
            if (AppState.tracking.active) return;

            try {
                // Start tracking session on server
                const routeId = AppState.route.routeId || 'RTE-' + Date.now();
                AppState.route.routeId = routeId;

                const params = new URLSearchParams({
                    action: 'startDeliveryTracking',
                    routeId: routeId,
                    driverId: AppState.driver?.id || '',
                    driverName: AppState.driver?.name || 'Driver'
                });

                const response = await fetch(`${TRACKING_API_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    AppState.tracking.active = true;
                    AppState.tracking.id = result.trackingId;

                    // Start GPS watching
                    if (navigator.geolocation) {
                        AppState.tracking.watchId = navigator.geolocation.watchPosition(
                            handlePositionUpdate,
                            handlePositionError,
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
                        );
                    }

                    // Also send updates every 30 seconds as backup
                    AppState.tracking.updateInterval = setInterval(sendLocationUpdate, 30000);

                    console.log('Tracking started:', result.trackingId);
                    showTrackingIndicator(true);

                    // Send tracking notifications to all customers on the route
                    sendRouteStartNotifications(routeId, result.trackingId);
                } else {
                    console.error('Failed to start tracking:', result.error);
                }
            } catch (error) {
                console.error('Error starting tracking:', error);
            }
        }

        function handlePositionUpdate(position) {
            const { latitude, longitude, heading, speed } = position.coords;

            // Update local state
            AppState.gpsLocation = { lat: latitude, lng: longitude };

            // Throttle updates to server (max once per 15 seconds)
            const now = Date.now();
            if (!AppState.tracking.lastUpdate || now - AppState.tracking.lastUpdate > 15000) {
                sendLocationToServer(latitude, longitude, heading, speed);
                AppState.tracking.lastUpdate = now;
            }
        }

        function handlePositionError(error) {
            console.warn('GPS error:', error.message);
        }

        async function sendLocationUpdate() {
            if (!AppState.tracking.active || !AppState.gpsLocation) return;

            const { lat, lng } = AppState.gpsLocation;
            await sendLocationToServer(lat, lng);
        }

        async function sendLocationToServer(lat, lng, heading, speed) {
            if (!AppState.tracking.active) return;

            try {
                // Calculate current stop index
                const currentStopIndex = AppState.route.stops.findIndex(s => s.status === 'pending');

                const params = new URLSearchParams({
                    action: 'updateDriverLocation',
                    trackingId: AppState.tracking.id,
                    routeId: AppState.route.routeId,
                    lat: lat.toFixed(6),
                    lng: lng.toFixed(6),
                    currentStopIndex: currentStopIndex >= 0 ? currentStopIndex : AppState.route.stops.length,
                    heading: heading || '',
                    speed: speed || ''
                });

                await fetch(`${TRACKING_API_URL}?${params.toString()}`);
            } catch (error) {
                console.error('Error sending location:', error);
            }
        }

        async function stopDeliveryTracking() {
            if (!AppState.tracking.active) return;

            try {
                // Stop GPS watching
                if (AppState.tracking.watchId) {
                    navigator.geolocation.clearWatch(AppState.tracking.watchId);
                    AppState.tracking.watchId = null;
                }

                // Stop interval
                if (AppState.tracking.updateInterval) {
                    clearInterval(AppState.tracking.updateInterval);
                    AppState.tracking.updateInterval = null;
                }

                // Notify server
                const params = new URLSearchParams({
                    action: 'stopDeliveryTracking',
                    trackingId: AppState.tracking.id
                });

                await fetch(`${TRACKING_API_URL}?${params.toString()}`);

                AppState.tracking.active = false;
                AppState.tracking.id = null;

                showTrackingIndicator(false);
                console.log('Tracking stopped');
            } catch (error) {
                console.error('Error stopping tracking:', error);
            }
        }

        function showTrackingIndicator(active) {
            // Add or update tracking indicator in header
            let indicator = document.getElementById('tracking-indicator');

            if (active) {
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'tracking-indicator';
                    indicator.innerHTML = '<span style="animation: blink 1.5s infinite;"></span> LIVE';
                    indicator.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: #22c55e;
                        color: white;
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 11px;
                        font-weight: 600;
                        z-index: 9999;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    `;
                    document.body.appendChild(indicator);
                }
                indicator.style.display = 'flex';
            } else if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function getTrackingLink(stopId) {
            // Find the stop's tracking code
            const stop = AppState.route.stops.find(s => s.id === stopId);
            if (stop && stop.trackingCode) {
                return `${window.location.origin}/track.html?code=${stop.trackingCode}`;
            }
            return null;
        }

        async function shareTrackingLink(stopId) {
            const link = getTrackingLink(stopId);
            if (!link) {
                alert('Tracking link not available for this stop');
                return;
            }

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Track Your Delivery',
                        text: 'Track your Tiny Seed Farm delivery in real-time!',
                        url: link
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        copyToClipboard(link);
                    }
                }
            } else {
                copyToClipboard(link);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Tracking link copied to clipboard!');
            }).catch(() => {
                prompt('Copy this tracking link:', text);
            });
        }

        // ============================================
        // DELIVERY NOTIFICATIONS
        // ============================================

        // Send SMS via Google Apps Script backend (credentials stored securely server-side)
        async function sendTwilioSMS(toNumber, message) {
            try {
                // Format phone number
                let formattedTo = toNumber.replace(/\D/g, '');
                if (!formattedTo.startsWith('1')) {
                    formattedTo = '1' + formattedTo;
                }
                formattedTo = '+' + formattedTo;

                // Route through backend - credentials are stored securely in Apps Script
                const params = new URLSearchParams({
                    action: 'sendSMS',
                    to: formattedTo,
                    message: message
                });

                console.log(`Sending SMS to ${formattedTo} via backend...`);

                const response = await fetch(`${TRACKING_API_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    console.log(`SMS sent to ${formattedTo}: ${result.sid || 'OK'}`);
                    return { success: true, sid: result.sid };
                } else {
                    console.error(`SMS failed to ${formattedTo}:`, result.error);
                    return { success: false, error: result.error };
                }
            } catch (error) {
                console.error('SMS error:', error);
                return { success: false, error: error.message };
            }
        }

        // Send delivery completion SMS to multiple recipients
        async function sendDeliveryCompletionSMS(stop) {
            if (!stop.sendSmsOnComplete || !stop.smsRecipients) return;

            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            const message = `Tiny Seed Farm Delivery Complete! Your order was delivered to ${stop.address} at ${timestamp}. Thank you for supporting local agriculture!`;

            console.log(`Sending delivery SMS to ${stop.smsRecipients.length} recipients...`);
            showNotificationToast(`Sending SMS notifications...`);

            const results = [];
            for (const phone of stop.smsRecipients) {
                const result = await sendTwilioSMS(phone, message);
                results.push({ phone, ...result });
            }

            const successCount = results.filter(r => r.success).length;
            if (successCount > 0) {
                showNotificationToast(`SMS sent to ${successCount} of ${stop.smsRecipients.length} recipients`);
            } else {
                showNotificationToast(`SMS sending failed. Check console for details.`);
            }

            return results;
        }

        async function sendRouteStartNotifications(routeId, trackingId) {
            try {
                const params = new URLSearchParams({
                    action: 'sendRouteStartNotifications',
                    routeId: routeId,
                    trackingId: trackingId
                });

                const response = await fetch(`${TRACKING_API_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    console.log('Route start notifications sent:', result.message);
                    showNotificationToast(`Tracking SMS sent to ${result.results?.length || 0} customers`);
                } else {
                    console.error('Failed to send notifications:', result.error);
                }
            } catch (error) {
                console.error('Error sending route notifications:', error);
            }
        }

        async function sendDeliveredNotification(stop) {
            try {
                const params = new URLSearchParams({
                    action: 'sendDeliveredNotification',
                    stopId: stop.id || '',
                    orderId: stop.orderId || '',
                    customerName: stop.customer || '',
                    phone: stop.phone || '',
                    email: stop.email || '',
                    customerType: stop.customerType || '',
                    boxCount: stop.boxCount || 1,
                    shareType: stop.shareType || '',
                    itemCount: stop.itemCount || stop.items?.length || 0
                });

                const response = await fetch(`${TRACKING_API_URL}?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    console.log('Delivered notification sent:', result.message);
                } else {
                    console.error('Failed to send delivered notification:', result.error);
                }
            } catch (error) {
                console.error('Error sending delivered notification:', error);
            }
        }

        function showNotificationToast(message) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `<span>&#x2709;</span> ${message}`;
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: #22c55e;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease-out;
            `;
            document.body.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function openNavigation(address) {
            const encoded = encodeURIComponent(address);
            // Try Google Maps first, fallback to Apple Maps
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (isIOS) {
                window.open(`maps://?daddr=${encoded}`);
            } else {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${encoded}`);
            }
        }

        function callCustomer(phone) {
            window.open(`tel:${phone}`);
        }

        // Text customer via Twilio (sends from business number, not personal phone)
        async function textCustomer(phone, customMessage) {
            if (!phone) {
                alert('No phone number available for this customer');
                return;
            }

            // Find the current stop for context
            var stop = AppState.currentStop || AppState.route.stops.find(s => s.phone === phone);
            var customerName = stop ? stop.customer : 'Customer';

            var message = customMessage || `Hi! This is your Tiny Seed Farm driver. I'm on my way with your delivery and should arrive soon. Reply to this message if you have any special instructions.`;

            showNotificationToast('Sending text message...');

            try {
                var result = await sendTwilioSMS(phone, message);
                if (result.success) {
                    showNotificationToast('Text sent to ' + customerName);
                } else {
                    showNotificationToast('Failed to send: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Text error:', error);
                showNotificationToast('Failed to send text');
            }
        }

        // ============================================
        // PROOF OF DELIVERY
        // ============================================
        function openPODModal(stopId) {
            AppState.currentStop = AppState.route.stops.find(s => s.id === stopId);
            AppState.deliveryPhoto = null;
            AppState.signature = null;
            AppState.gpsLocation = null;

            // Reset photo
            document.getElementById('deliveryPhoto').innerHTML = `
                <div class="photo-placeholder">
                    <div class="photo-icon">&#x1F4F7;</div>
                    <div>Tap to take photo</div>
                </div>
            `;
            document.getElementById('deliveryPhoto').classList.remove('has-photo');

            // Clear signature
            clearSignature();

            // Get GPS
            captureGPS();

            document.getElementById('podModal').classList.add('active');
        }

        function capturePhoto() {
            document.getElementById('photoInput').click();
        }

        function handlePhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    compressImage(e.target.result, (compressed) => {
                        AppState.deliveryPhoto = compressed;

                        const container = document.getElementById('deliveryPhoto');
                        container.innerHTML = `
                            <img src="${compressed}" alt="Delivery photo">
                            <button class="retake-btn" onclick="event.stopPropagation(); capturePhoto();">Retake</button>
                        `;
                        container.classList.add('has-photo');
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        function compressImage(dataUrl, callback, maxWidth = 1200) {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ratio = Math.min(maxWidth / img.width, 1);
                canvas.width = img.width * ratio;
                canvas.height = img.height * ratio;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                callback(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = dataUrl;
        }

        function captureGPS() {
            const statusEl = document.getElementById('gpsStatus');
            statusEl.className = 'gps-status';
            statusEl.innerHTML = '<span>&#x1F504;</span> <span>Acquiring location...</span>';

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    AppState.gpsLocation = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        accuracy: pos.coords.accuracy
                    };

                    statusEl.className = 'gps-status valid';
                    statusEl.innerHTML = `<span>&#x2713;</span> <span>Location captured (${Math.round(pos.coords.accuracy)}m)</span>`;
                },
                (err) => {
                    statusEl.className = 'gps-status invalid';
                    statusEl.innerHTML = `<span>&#x2717;</span> <span>Could not get location</span>`;
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // Signature Canvas
        let signatureCtx;
        let isDrawing = false;

        function initSignatureCanvas() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;

            signatureCtx = canvas.getContext('2d');

            // Set canvas size
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 150;

            // Touch events
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            signatureCtx.beginPath();
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.strokeStyle = '#000';

            const pos = getEventPos(e);
            signatureCtx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const pos = getEventPos(e);
            signatureCtx.lineTo(pos.x, pos.y);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                AppState.signature = document.getElementById('signatureCanvas').toDataURL();
            }
        }

        function getEventPos(e) {
            const canvas = document.getElementById('signatureCanvas');
            const rect = canvas.getBoundingClientRect();

            if (e.touches) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function clearSignature() {
            const canvas = document.getElementById('signatureCanvas');
            if (canvas && signatureCtx) {
                signatureCtx.clearRect(0, 0, canvas.width, canvas.height);
                AppState.signature = null;
            }
        }

        async function completeDelivery() {
            if (!AppState.currentStop) return;

            const btn = document.getElementById('completeDeliveryBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            const deliveryData = {
                deliveryId: AppState.currentStop.id,
                customer: AppState.currentStop.customer,
                timestamp: new Date().toISOString(),
                photo: AppState.deliveryPhoto,
                gps: AppState.gpsLocation,
                signature: AppState.signature,
                driverId: AppState.driver?.id
            };

            try {
                // Try to submit to API
                const result = await api.completeDelivery(deliveryData);

                if (!result.success) {
                    // If API fails, queue for later sync
                    saveToQueue('delivery', deliveryData);
                }
            } catch (error) {
                console.error('API error, saving offline:', error);
                // Save to queue for offline support
                saveToQueue('delivery', deliveryData);
            }

            // Update local state
            const stop = AppState.route.stops.find(s => s.id === AppState.currentStop.id);
            if (stop) {
                stop.status = 'delivered';

                // Send delivered notification to customer
                sendDeliveredNotification(stop);

                // Send SMS to multiple recipients if configured
                if (stop.sendSmsOnComplete && stop.smsRecipients) {
                    sendDeliveryCompletionSMS(stop);
                }
            }

            // Add to history
            AppState.history.unshift({
                customer: AppState.currentStop.customer,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                status: 'delivered'
            });

            // Update UI
            updateRouteStats();
            renderStops();
            renderHistory();

            // Auto re-optimize remaining stops if route was optimized
            if (AppState.route.optimized) {
                autoReoptimizeRoute();
            }

            closeModal('podModal');
            btn.disabled = false;
            btn.textContent = 'Complete Delivery';

            // Auto-advance: Offer to navigate to next stop
            setTimeout(function() {
                autoAdvanceToNextStop();
            }, 500);
        }

        // Auto-advance to next stop after completing delivery
        function autoAdvanceToNextStop() {
            var nextStop = AppState.route.stops.find(function(s) {
                return s.status === 'pending' && s.lat && s.lng;
            });

            if (!nextStop) {
                // All deliveries complete - offer to navigate back to farm
                showAutoAdvanceModal({
                    title: 'Route Complete!',
                    message: 'All deliveries finished. Navigate back to farm?',
                    destination: FARM_DEPOT.name,
                    lat: FARM_DEPOT.lat,
                    lng: FARM_DEPOT.lng,
                    address: FARM_DEPOT.address,
                    isFarm: true
                });
                return;
            }

            showAutoAdvanceModal({
                title: 'Next Stop',
                message: nextStop.customer,
                destination: nextStop.address,
                lat: nextStop.lat,
                lng: nextStop.lng,
                address: nextStop.address,
                isFarm: false
            });
        }

        // Show auto-advance modal
        function showAutoAdvanceModal(options) {
            // Create modal if it doesn't exist
            var modal = document.getElementById('autoAdvanceModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'autoAdvanceModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal auto-advance-modal">
                        <div class="auto-advance-icon" id="autoAdvanceIcon"></div>
                        <div class="auto-advance-title" id="autoAdvanceTitle"></div>
                        <div class="auto-advance-destination" id="autoAdvanceDestination"></div>
                        <div class="auto-advance-address" id="autoAdvanceAddress"></div>
                        <div class="auto-advance-actions">
                            <button class="btn btn-primary btn-lg" id="autoAdvanceNavBtn" onclick="confirmAutoAdvance()">
                                Navigate Now
                            </button>
                            <button class="btn btn-outline" onclick="closeModal('autoAdvanceModal')">
                                Skip
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Store navigation data
            modal.dataset.lat = options.lat;
            modal.dataset.lng = options.lng;
            modal.dataset.address = options.address;

            // Update content
            document.getElementById('autoAdvanceIcon').textContent = options.isFarm ? '' : '';
            document.getElementById('autoAdvanceTitle').textContent = options.title;
            document.getElementById('autoAdvanceDestination').textContent = options.message;
            document.getElementById('autoAdvanceAddress').textContent = options.destination;

            modal.classList.add('active');
        }

        // Confirm auto-advance and open navigation
        function confirmAutoAdvance() {
            var modal = document.getElementById('autoAdvanceModal');
            var lat = modal.dataset.lat;
            var lng = modal.dataset.lng;
            var address = modal.dataset.address;

            closeModal('autoAdvanceModal');
            openNavigation(lat, lng, encodeURIComponent(address));
        }

        // Auto re-optimize remaining route after delivery/skip
        async function autoReoptimizeRoute() {
            var remainingStops = AppState.route.stops.filter(function(s) {
                return s.status === 'pending' && s.lat && s.lng;
            });

            if (remainingStops.length < 2) {
                console.log('Not enough remaining stops to re-optimize');
                return;
            }

            console.log('Auto re-optimizing ' + remainingStops.length + ' remaining stops...');

            try {
                var result = await RouteOptimizer.reoptimizeRemaining(remainingStops);

                if (result.success) {
                    // Update stops order
                    var completedStops = AppState.route.stops.filter(function(s) {
                        return s.status !== 'pending';
                    });

                    AppState.route.stops = completedStops.concat(result.stops);
                    AppState.route.totalDistance = result.totalDistance;
                    AppState.route.totalTime = result.totalTime;

                    // Re-render
                    renderStops();
                    renderMapMarkers();

                    console.log('Route re-optimized: ' + result.totalDistance.toFixed(1) + ' miles remaining');
                    showNotificationToast('Route re-optimized for remaining stops');
                }
            } catch (error) {
                console.error('Re-optimization error:', error);
            }
        }

        // ============================================
        // ISSUE REPORTING
        // ============================================
        function openIssueModal(stopId) {
            AppState.currentStop = AppState.route.stops.find(s => s.id === stopId);
            AppState.selectedIssue = null;
            AppState.issuePhoto = null;

            // Reset selections
            document.querySelectorAll('.issue-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('issueNotes').value = '';
            document.getElementById('submitIssueBtn').disabled = true;

            // Reset photo
            document.getElementById('issuePhoto').innerHTML = `
                <div class="photo-placeholder">
                    <div class="photo-icon">&#x1F4F7;</div>
                    <div>Tap to take photo</div>
                </div>
            `;

            document.getElementById('issueModal').classList.add('active');
        }

        function selectIssue(element, type) {
            document.querySelectorAll('.issue-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            AppState.selectedIssue = type;
            document.getElementById('submitIssueBtn').disabled = false;
        }

        function captureIssuePhoto() {
            document.getElementById('issuePhotoInput').click();
        }

        function handleIssuePhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    compressImage(e.target.result, (compressed) => {
                        AppState.issuePhoto = compressed;

                        const container = document.getElementById('issuePhoto');
                        container.innerHTML = `
                            <img src="${compressed}" alt="Issue photo">
                            <button class="retake-btn" onclick="event.stopPropagation(); captureIssuePhoto();">Retake</button>
                        `;
                        container.classList.add('has-photo');
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        async function submitIssue() {
            if (!AppState.currentStop || !AppState.selectedIssue) return;

            const btn = document.getElementById('submitIssueBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            const issueData = {
                deliveryId: AppState.currentStop.id,
                customer: AppState.currentStop.customer,
                timestamp: new Date().toISOString(),
                issueType: AppState.selectedIssue,
                notes: document.getElementById('issueNotes').value,
                photo: AppState.issuePhoto,
                driverId: AppState.driver?.id
            };

            try {
                // Try to submit to API
                const result = await api.reportDeliveryIssue(issueData);

                if (!result.success) {
                    // If API fails, queue for later sync
                    saveToQueue('issue', issueData);
                }
            } catch (error) {
                console.error('API error, saving offline:', error);
                // Save to queue for offline support
                saveToQueue('issue', issueData);
            }

            // Update local state
            const stop = AppState.route.stops.find(s => s.id === AppState.currentStop.id);
            if (stop) {
                stop.status = 'issue';
            }

            // Add to history
            AppState.history.unshift({
                customer: AppState.currentStop.customer,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                status: 'issue',
                issueType: AppState.selectedIssue
            });

            // Update UI
            updateRouteStats();
            renderStops();
            renderHistory();

            // Auto re-optimize remaining stops if route was optimized
            if (AppState.route.optimized) {
                autoReoptimizeRoute();
            }

            closeModal('issueModal');
            btn.disabled = false;
            btn.textContent = 'Submit Issue Report';
        }

        // ============================================
        // OFFLINE SYNC
        // ============================================
        function saveToQueue(type, data) {
            const queue = JSON.parse(localStorage.getItem('deliveryQueue') || '[]');
            queue.push({
                id: Date.now(),
                type,
                data,
                timestamp: new Date().toISOString(),
                synced: false
            });
            localStorage.setItem('deliveryQueue', JSON.stringify(queue));

            if (AppState.isOnline) {
                syncOfflineData();
            }
        }

        async function syncOfflineData() {
            const queue = JSON.parse(localStorage.getItem('deliveryQueue') || '[]');
            const unsynced = queue.filter(item => !item.synced);

            if (unsynced.length === 0) return;

            console.log(`Syncing ${unsynced.length} items...`);

            for (const item of unsynced) {
                try {
                    let result;
                    if (item.type === 'delivery') {
                        result = await api.completeDelivery(item.data);
                    } else if (item.type === 'issue') {
                        result = await api.reportDeliveryIssue(item.data);
                    }

                    if (result && result.success) {
                        item.synced = true;
                        console.log(`Synced: ${item.type} for ${item.data.customer}`);
                    }
                } catch (err) {
                    console.error('Sync failed:', err);
                }
            }

            localStorage.setItem('deliveryQueue', JSON.stringify(queue));
        }

        // ============================================
        // MODAL MANAGEMENT
        // ============================================
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function closeCelebration() {
            document.getElementById('celebration').classList.remove('active');
            switchTab('history');
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ============================================
        // NAVIGATION
        // ============================================
        function switchTab(tabName) {
            AppState.currentTab = tabName;

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[onclick="switchTab('${tabName}')"]`).classList.add('active');

            // Show/hide tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');

            // Re-init signature canvas when settings tab is shown
            if (tabName === 'settings') {
                // Could refresh driver stats here
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // ============================================
        // PIN ENTRY FUNCTIONS
        // ============================================
        var pinValue = '';

        function enterPinDigit(digit) {
            if (pinValue.length < 4) {
                pinValue += digit;
                updatePinDots();
                if (pinValue.length === 4) {
                    setTimeout(doLogin, 300);
                }
            }
        }

        function clearPinDigit() {
            if (pinValue.length > 0) {
                pinValue = pinValue.slice(0, -1);
                updatePinDots();
            }
        }

        function updatePinDots() {
            for (var i = 1; i <= 4; i++) {
                var dot = document.getElementById('pin' + i);
                if (dot) {
                    if (i <= pinValue.length) {
                        dot.classList.add('filled');
                    } else {
                        dot.classList.remove('filled');
                    }
                }
            }
        }

        function doLogin() {
            var drivers = [
                { id: 'DRV-001', name: 'Todd Pollack', pin: '7714', initials: 'TP' },
                { id: 'DRV-002', name: 'Samantha Pollack', pin: '1234', initials: 'SP' },
                { id: 'DRV-003', name: 'Sarah Chen', pin: '5678', initials: 'SC' }
            ];

            var driver = null;
            for (var i = 0; i < drivers.length; i++) {
                if (drivers[i].pin === pinValue) {
                    driver = drivers[i];
                    break;
                }
            }

            if (driver) {
                AppState.driver = driver;
                AppState.isLoggedIn = true;

                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appHeader').style.display = 'flex';
                document.getElementById('bottomNav').style.display = 'flex';
                document.getElementById('routeTab').classList.add('active');
                document.getElementById('driverAvatar').textContent = driver.initials;
                document.getElementById('driverName').textContent = driver.name;

                // Show welcome message with first name
                var firstName = driver.name.split(' ')[0];
                showWelcome('Welcome, ' + firstName + '!');

                loadRoute();
                pinValue = '';
                updatePinDots();
            } else {
                document.getElementById('loginError').textContent = 'Invalid PIN. Please try again.';
                pinValue = '';
                updatePinDots();
                // Shake animation
                var pinDisplay = document.querySelector('.pin-display');
                if (pinDisplay) {
                    pinDisplay.style.animation = 'shake 0.3s';
                    setTimeout(function() { pinDisplay.style.animation = ''; }, 300);
                }
            }
        }

        function showWelcome(message) {
            var toast = document.getElementById('welcomeToast');
            if (toast) {
                toast.textContent = message;
                toast.style.display = 'block';
                setTimeout(function() {
                    toast.style.display = 'none';
                }, 3000);
            }
        }

        // ============================================
        // MAP FUNCTIONALITY
        // ============================================
        var deliveryMap = null;
        var mapMarkers = [];
        var routeLine = null;

        function initMap() {
            if (deliveryMap) return; // Already initialized

            var mapContainer = document.getElementById('deliveryMap');
            if (!mapContainer) return;

            // Center on farm depot
            var defaultCenter = [FARM_DEPOT.lat, FARM_DEPOT.lng];

            deliveryMap = L.map('deliveryMap').setView(defaultCenter, 11);

            // Add OpenStreetMap tiles
            // Use CartoDB Dark Matter for professional dark theme
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: ' OpenStreetMap contributors,  CARTO',
                maxZoom: 19,
                subdomains: 'abcd'
            }).addTo(deliveryMap);

            // Render markers if we have stops
            if (AppState.route.stops.length > 0) {
                renderMapMarkers();
            }
        }

        var depotMarker = null; // Track depot marker separately

        function renderMapMarkers() {
            if (!deliveryMap) return;

            // Clear existing markers
            mapMarkers.forEach(function(marker) {
                deliveryMap.removeLayer(marker);
            });
            mapMarkers = [];

            if (depotMarker) {
                deliveryMap.removeLayer(depotMarker);
                depotMarker = null;
            }

            if (routeLine) {
                deliveryMap.removeLayer(routeLine);
                routeLine = null;
            }

            var stops = AppState.route.stops;
            var bounds = [];
            var routeCoords = [];

            // Add farm depot marker (start/end point)
            var depotIcon = L.divIcon({
                className: '',
                html: '<div class="depot-marker">&#x1F331;</div>',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            depotMarker = L.marker([FARM_DEPOT.lat, FARM_DEPOT.lng], { icon: depotIcon })
                .bindPopup(
                    '<strong>' + FARM_DEPOT.name + '</strong><br>' +
                    '<em>Route Start & End Point</em><br>' +
                    FARM_DEPOT.address
                )
                .addTo(deliveryMap);

            bounds.push([FARM_DEPOT.lat, FARM_DEPOT.lng]);
            routeCoords.push([FARM_DEPOT.lat, FARM_DEPOT.lng]); // Start at depot

            if (stops.length === 0) {
                // Just show depot if no stops
                deliveryMap.setView([FARM_DEPOT.lat, FARM_DEPOT.lng], 12);
                return;
            }

            stops.forEach(function(stop, index) {
                if (!stop.lat || !stop.lng) return;

                var isCompleted = stop.status === 'delivered' || stop.status === 'issue';
                var isCurrent = index === AppState.route.currentStopIndex && AppState.route.isStarted;

                // Create custom icon
                var markerClass = 'custom-marker';
                if (isCompleted) markerClass += ' completed';
                if (isCurrent) markerClass += ' current';

                var icon = L.divIcon({
                    className: '',
                    html: '<div class="' + markerClass + '">' + (index + 1) + '</div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                var marker = L.marker([stop.lat, stop.lng], { icon: icon })
                    .bindPopup(
                        '<strong>' + stop.customer + '</strong><br>' +
                        stop.address + '<br>' +
                        '<button onclick="openNavigation(' + stop.lat + ', ' + stop.lng + ', \'' + encodeURIComponent(stop.address) + '\')" ' +
                        'style="margin-top:8px;padding:8px 16px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;">Navigate</button>'
                    )
                    .addTo(deliveryMap);

                mapMarkers.push(marker);
                bounds.push([stop.lat, stop.lng]);
                routeCoords.push([stop.lat, stop.lng]);
            });

            // Add return to depot
            routeCoords.push([FARM_DEPOT.lat, FARM_DEPOT.lng]);

            // Draw route line (depot -> stops -> depot)
            if (routeCoords.length > 1) {
                routeLine = L.polyline(routeCoords, {
                    color: '#22c55e',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 5'
                }).addTo(deliveryMap);
            }

            // Fit map to show all markers
            if (bounds.length > 0) {
                deliveryMap.fitBounds(bounds, { padding: [30, 30] });
            }
        }

        // ============================================
        // NAVIGATION INTEGRATION
        // ============================================
        var pendingNavigation = null;

        function openNavigation(lat, lng, address) {
            pendingNavigation = { lat: lat, lng: lng, address: decodeURIComponent(address) };
            showNavPicker();
        }

        function showNavPicker() {
            var overlay = document.getElementById('navPickerOverlay');
            var options = document.getElementById('navPickerOptions');

            if (!overlay || !options || !pendingNavigation) return;

            var lat = pendingNavigation.lat;
            var lng = pendingNavigation.lng;
            var addr = pendingNavigation.address;

            // Detect platform
            var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            var isAndroid = /Android/.test(navigator.userAgent);

            var html = '';

            // Google Maps (works on all platforms)
            html += '<a class="nav-option" href="https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lng + '" target="_blank">';
            html += '<span class="nav-option-icon">&#x1F5FA;</span>';
            html += '<span>Google Maps</span>';
            html += '</a>';

            // Apple Maps (iOS only)
            if (isIOS) {
                html += '<a class="nav-option" href="maps://?daddr=' + lat + ',' + lng + '">';
                html += '<span class="nav-option-icon">&#x1F34E;</span>';
                html += '<span>Apple Maps</span>';
                html += '</a>';
            }

            // Waze
            html += '<a class="nav-option" href="https://waze.com/ul?ll=' + lat + ',' + lng + '&navigate=yes" target="_blank">';
            html += '<span class="nav-option-icon">&#x1F697;</span>';
            html += '<span>Waze</span>';
            html += '</a>';

            options.innerHTML = html;
            overlay.classList.add('active');
        }

        function closeNavPicker(event) {
            if (event && event.target !== document.getElementById('navPickerOverlay')) {
                return;
            }
            var overlay = document.getElementById('navPickerOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
            pendingNavigation = null;
        }

        // ============================================
        // PRODUCTION-GRADE ROUTE OPTIMIZATION ENGINE
        // Based on OR-Tools patterns and VRP best practices
        // ============================================

        // Farm Depot Configuration - MUST start and end here
        const FARM_DEPOT = {
            id: 'DEPOT',
            name: 'Tiny Seed Farm',
            lat: 40.7248232,   // 257 Zeigler Rd
            lng: -80.1540297,
            address: '257 Zeigler Rd, Rochester PA 15074'
        };

        // Route Optimizer - Production Grade
        const RouteOptimizer = {
            // Configuration
            config: {
                useRealDistances: true,  // Use OSRM API for real driving distances
                osrmServer: 'https://router.project-osrm.org',  // Public OSRM server
                maxIterations: 1000,     // Max improvement iterations
                saInitialTemp: 100,      // Simulated annealing initial temperature
                saCoolingRate: 0.995,    // Cooling rate for SA
                timeWindowPenalty: 1000, // Penalty for time window violations (minutes)
                returnToDepot: true      // Must return to farm at end
            },

            // Distance/Time matrix cache
            distanceMatrix: null,
            timeMatrix: null,

            // Haversine distance (fallback when OSRM unavailable)
            haversineDistance: function(lat1, lng1, lat2, lng2) {
                var R = 3959; // Earth radius in miles
                var dLat = (lat2 - lat1) * Math.PI / 180;
                var dLng = (lng2 - lng1) * Math.PI / 180;
                var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },

            // Estimate driving time from distance (fallback)
            estimateDrivingTime: function(distanceMiles) {
                // Assume average 30 mph for delivery routes (rural/suburban mix)
                return (distanceMiles / 30) * 60; // Return minutes
            },

            // Fetch real driving distances from OSRM
            fetchDistanceMatrix: async function(locations) {
                try {
                    // Build coordinates string for OSRM
                    var coords = locations.map(function(loc) {
                        return loc.lng + ',' + loc.lat;
                    }).join(';');

                    var url = this.config.osrmServer + '/table/v1/driving/' + coords +
                              '?annotations=distance,duration';

                    console.log('Fetching distance matrix from OSRM...');
                    var response = await fetch(url);
                    var data = await response.json();

                    if (data.code === 'Ok') {
                        console.log('OSRM matrix fetched successfully');
                        return {
                            distances: data.distances, // meters
                            durations: data.durations  // seconds
                        };
                    } else {
                        console.warn('OSRM returned error:', data.code);
                        return null;
                    }
                } catch (error) {
                    console.warn('OSRM fetch failed, using haversine fallback:', error.message);
                    return null;
                }
            },

            // Build distance matrix (real or estimated)
            buildDistanceMatrix: async function(stops) {
                var n = stops.length;
                var distances = [];
                var times = [];

                // Try to get real driving distances
                if (this.config.useRealDistances) {
                    var osrmResult = await this.fetchDistanceMatrix(stops);
                    if (osrmResult) {
                        // Convert OSRM results (meters to miles, seconds to minutes)
                        for (var i = 0; i < n; i++) {
                            distances[i] = [];
                            times[i] = [];
                            for (var j = 0; j < n; j++) {
                                distances[i][j] = osrmResult.distances[i][j] / 1609.34; // meters to miles
                                times[i][j] = osrmResult.durations[i][j] / 60; // seconds to minutes
                            }
                        }
                        this.distanceMatrix = distances;
                        this.timeMatrix = times;
                        return { distances: distances, times: times, source: 'OSRM' };
                    }
                }

                // Fallback to haversine
                console.log('Using haversine distance estimation');
                for (var i = 0; i < n; i++) {
                    distances[i] = [];
                    times[i] = [];
                    for (var j = 0; j < n; j++) {
                        if (i === j) {
                            distances[i][j] = 0;
                            times[i][j] = 0;
                        } else {
                            var dist = this.haversineDistance(
                                stops[i].lat, stops[i].lng,
                                stops[j].lat, stops[j].lng
                            );
                            distances[i][j] = dist;
                            times[i][j] = this.estimateDrivingTime(dist);
                        }
                    }
                }

                this.distanceMatrix = distances;
                this.timeMatrix = times;
                return { distances: distances, times: times, source: 'Haversine' };
            },

            // Calculate total route distance
            calculateRouteDistance: function(route, matrix) {
                if (route.length < 2) return 0;
                var total = 0;
                for (var i = 0; i < route.length - 1; i++) {
                    total += matrix[route[i]][route[i + 1]];
                }
                return total;
            },

            // Calculate total route time including service time
            calculateRouteTime: function(route, timeMatrix, serviceTime) {
                serviceTime = serviceTime || 5; // 5 minutes per stop default
                if (route.length < 2) return 0;
                var total = 0;
                for (var i = 0; i < route.length - 1; i++) {
                    total += timeMatrix[route[i]][route[i + 1]];
                    if (i > 0 && i < route.length - 1) { // Don't add service time for depot
                        total += serviceTime;
                    }
                }
                return total;
            },

            // ============================================
            // CONSTRUCTION HEURISTICS
            // ============================================

            // Nearest Neighbor Construction
            nearestNeighborConstruction: function(n, startIndex) {
                var route = [startIndex];
                var visited = new Set([startIndex]);
                var current = startIndex;

                while (visited.size < n) {
                    var nearest = -1;
                    var nearestDist = Infinity;

                    for (var i = 0; i < n; i++) {
                        if (!visited.has(i)) {
                            var dist = this.distanceMatrix[current][i];
                            if (dist < nearestDist) {
                                nearestDist = dist;
                                nearest = i;
                            }
                        }
                    }

                    if (nearest !== -1) {
                        route.push(nearest);
                        visited.add(nearest);
                        current = nearest;
                    }
                }

                return route;
            },

            // Nearest Insertion Construction
            nearestInsertionConstruction: function(n, depotIndex) {
                if (n <= 2) return [depotIndex, depotIndex === 0 ? 1 : 0];

                // Start with depot and farthest node
                var route = [depotIndex];
                var inRoute = new Set([depotIndex]);

                // Find farthest node from depot
                var farthest = -1;
                var farthestDist = 0;
                for (var i = 0; i < n; i++) {
                    if (i !== depotIndex && this.distanceMatrix[depotIndex][i] > farthestDist) {
                        farthestDist = this.distanceMatrix[depotIndex][i];
                        farthest = i;
                    }
                }
                route.push(farthest);
                inRoute.add(farthest);

                // Insert remaining nodes
                while (inRoute.size < n) {
                    // Find nearest unvisited node to any node in route
                    var nearestNode = -1;
                    var nearestDist = Infinity;

                    for (var i = 0; i < n; i++) {
                        if (!inRoute.has(i)) {
                            for (var j = 0; j < route.length; j++) {
                                var dist = this.distanceMatrix[route[j]][i];
                                if (dist < nearestDist) {
                                    nearestDist = dist;
                                    nearestNode = i;
                                }
                            }
                        }
                    }

                    if (nearestNode === -1) break;

                    // Find best position to insert
                    var bestPos = 1;
                    var bestCost = Infinity;

                    for (var pos = 1; pos <= route.length; pos++) {
                        var prev = route[pos - 1];
                        var next = pos < route.length ? route[pos] : route[0];
                        var insertionCost = this.distanceMatrix[prev][nearestNode] +
                                           this.distanceMatrix[nearestNode][next] -
                                           this.distanceMatrix[prev][next];
                        if (insertionCost < bestCost) {
                            bestCost = insertionCost;
                            bestPos = pos;
                        }
                    }

                    route.splice(bestPos, 0, nearestNode);
                    inRoute.add(nearestNode);
                }

                return route;
            },

            // Clarke-Wright Savings Algorithm
            savingsConstruction: function(n, depotIndex) {
                // Calculate savings for each pair
                var savings = [];
                for (var i = 0; i < n; i++) {
                    if (i === depotIndex) continue;
                    for (var j = i + 1; j < n; j++) {
                        if (j === depotIndex) continue;
                        var saving = this.distanceMatrix[depotIndex][i] +
                                    this.distanceMatrix[depotIndex][j] -
                                    this.distanceMatrix[i][j];
                        savings.push({ i: i, j: j, saving: saving });
                    }
                }

                // Sort by saving (descending)
                savings.sort(function(a, b) { return b.saving - a.saving; });

                // Build route
                var route = [depotIndex];
                var inRoute = new Set([depotIndex]);

                // Start with highest saving pair
                if (savings.length > 0) {
                    route.push(savings[0].i);
                    route.push(savings[0].j);
                    inRoute.add(savings[0].i);
                    inRoute.add(savings[0].j);
                }

                // Add remaining nodes using savings
                for (var s = 1; s < savings.length && inRoute.size < n; s++) {
                    var pair = savings[s];
                    var iIn = inRoute.has(pair.i);
                    var jIn = inRoute.has(pair.j);

                    if (iIn && !jIn) {
                        // Find position of i and insert j next to it
                        var posI = route.indexOf(pair.i);
                        if (posI === route.length - 1) {
                            route.push(pair.j);
                        } else if (posI === 1) {
                            route.splice(1, 0, pair.j);
                        }
                        inRoute.add(pair.j);
                    } else if (!iIn && jIn) {
                        var posJ = route.indexOf(pair.j);
                        if (posJ === route.length - 1) {
                            route.push(pair.i);
                        } else if (posJ === 1) {
                            route.splice(1, 0, pair.i);
                        }
                        inRoute.add(pair.i);
                    }
                }

                // Add any remaining nodes
                for (var i = 0; i < n; i++) {
                    if (!inRoute.has(i)) {
                        route.push(i);
                        inRoute.add(i);
                    }
                }

                return route;
            },

            // ============================================
            // LOCAL SEARCH IMPROVEMENTS
            // ============================================

            // 2-opt improvement (reverse segments)
            twoOptImprove: function(route, matrix) {
                var improved = true;
                var bestRoute = route.slice();
                var bestDistance = this.calculateRouteDistance(bestRoute, matrix);
                var iterations = 0;

                while (improved && iterations < this.config.maxIterations) {
                    improved = false;
                    iterations++;

                    for (var i = 1; i < bestRoute.length - 2; i++) {
                        for (var j = i + 1; j < bestRoute.length - 1; j++) {
                            // Calculate improvement from reversing segment [i, j]
                            var delta =
                                -matrix[bestRoute[i-1]][bestRoute[i]]
                                -matrix[bestRoute[j]][bestRoute[j+1]]
                                +matrix[bestRoute[i-1]][bestRoute[j]]
                                +matrix[bestRoute[i]][bestRoute[j+1]];

                            if (delta < -0.0001) { // Small tolerance for floating point
                                // Reverse the segment
                                var newRoute = bestRoute.slice(0, i);
                                var reversed = bestRoute.slice(i, j + 1).reverse();
                                newRoute = newRoute.concat(reversed);
                                newRoute = newRoute.concat(bestRoute.slice(j + 1));

                                bestRoute = newRoute;
                                bestDistance += delta;
                                improved = true;
                            }
                        }
                    }
                }

                console.log('2-opt completed in ' + iterations + ' iterations');
                return bestRoute;
            },

            // Or-opt improvement (relocate sequences of 1-3 nodes)
            orOptImprove: function(route, matrix) {
                var improved = true;
                var bestRoute = route.slice();
                var bestDistance = this.calculateRouteDistance(bestRoute, matrix);
                var iterations = 0;

                while (improved && iterations < this.config.maxIterations) {
                    improved = false;
                    iterations++;

                    // Try relocating sequences of length 1, 2, and 3
                    for (var seqLen = 1; seqLen <= 3; seqLen++) {
                        for (var i = 1; i < bestRoute.length - seqLen; i++) {
                            // Don't move depot
                            if (i === 0 || i + seqLen >= bestRoute.length) continue;

                            for (var j = 1; j < bestRoute.length; j++) {
                                // Skip if j is within or adjacent to the sequence
                                if (j >= i - 1 && j <= i + seqLen) continue;

                                // Calculate cost of removing sequence from position i
                                var removeCost =
                                    -matrix[bestRoute[i-1]][bestRoute[i]]
                                    -matrix[bestRoute[i+seqLen-1]][bestRoute[i+seqLen]]
                                    +matrix[bestRoute[i-1]][bestRoute[i+seqLen]];

                                // Calculate cost of inserting sequence at position j
                                var insertCost =
                                    -matrix[bestRoute[j-1]][bestRoute[j]]
                                    +matrix[bestRoute[j-1]][bestRoute[i]]
                                    +matrix[bestRoute[i+seqLen-1]][bestRoute[j]];

                                var delta = removeCost + insertCost;

                                if (delta < -0.0001) {
                                    // Perform the move
                                    var sequence = bestRoute.slice(i, i + seqLen);
                                    var newRoute = bestRoute.slice();
                                    newRoute.splice(i, seqLen);

                                    var insertPos = j > i ? j - seqLen : j;
                                    for (var k = 0; k < sequence.length; k++) {
                                        newRoute.splice(insertPos + k, 0, sequence[k]);
                                    }

                                    bestRoute = newRoute;
                                    bestDistance += delta;
                                    improved = true;
                                    break;
                                }
                            }
                            if (improved) break;
                        }
                        if (improved) break;
                    }
                }

                console.log('Or-opt completed in ' + iterations + ' iterations');
                return bestRoute;
            },

            // 3-opt improvement (more complex rearrangements)
            threeOptImprove: function(route, matrix) {
                var improved = true;
                var bestRoute = route.slice();
                var bestDistance = this.calculateRouteDistance(bestRoute, matrix);
                var iterations = 0;
                var maxIter = Math.min(this.config.maxIterations, 100); // Limit 3-opt iterations

                while (improved && iterations < maxIter) {
                    improved = false;
                    iterations++;

                    for (var i = 1; i < bestRoute.length - 4; i++) {
                        for (var j = i + 2; j < bestRoute.length - 2; j++) {
                            for (var k = j + 2; k < bestRoute.length; k++) {
                                // Try all 3-opt reconnection variants
                                var variants = this.get3OptVariants(bestRoute, i, j, k);

                                for (var v = 0; v < variants.length; v++) {
                                    var newDistance = this.calculateRouteDistance(variants[v], matrix);
                                    if (newDistance < bestDistance - 0.0001) {
                                        bestRoute = variants[v];
                                        bestDistance = newDistance;
                                        improved = true;
                                        break;
                                    }
                                }
                                if (improved) break;
                            }
                            if (improved) break;
                        }
                        if (improved) break;
                    }
                }

                console.log('3-opt completed in ' + iterations + ' iterations');
                return bestRoute;
            },

            // Generate 3-opt reconnection variants
            get3OptVariants: function(route, i, j, k) {
                var variants = [];
                var seg1 = route.slice(0, i);
                var seg2 = route.slice(i, j);
                var seg3 = route.slice(j, k);
                var seg4 = route.slice(k);

                // Variant 1: seg1 + reversed(seg2) + seg3 + seg4
                variants.push(seg1.concat(seg2.slice().reverse()).concat(seg3).concat(seg4));

                // Variant 2: seg1 + seg2 + reversed(seg3) + seg4
                variants.push(seg1.concat(seg2).concat(seg3.slice().reverse()).concat(seg4));

                // Variant 3: seg1 + reversed(seg2) + reversed(seg3) + seg4
                variants.push(seg1.concat(seg2.slice().reverse()).concat(seg3.slice().reverse()).concat(seg4));

                // Variant 4: seg1 + seg3 + seg2 + seg4
                variants.push(seg1.concat(seg3).concat(seg2).concat(seg4));

                // Variant 5: seg1 + seg3 + reversed(seg2) + seg4
                variants.push(seg1.concat(seg3).concat(seg2.slice().reverse()).concat(seg4));

                // Variant 6: seg1 + reversed(seg3) + seg2 + seg4
                variants.push(seg1.concat(seg3.slice().reverse()).concat(seg2).concat(seg4));

                // Variant 7: seg1 + reversed(seg3) + reversed(seg2) + seg4
                variants.push(seg1.concat(seg3.slice().reverse()).concat(seg2.slice().reverse()).concat(seg4));

                return variants;
            },

            // ============================================
            // METAHEURISTICS
            // ============================================

            // Simulated Annealing to escape local optima
            simulatedAnnealing: function(route, matrix) {
                var currentRoute = route.slice();
                var currentDistance = this.calculateRouteDistance(currentRoute, matrix);
                var bestRoute = currentRoute.slice();
                var bestDistance = currentDistance;

                var temperature = this.config.saInitialTemp;
                var coolingRate = this.config.saCoolingRate;
                var iterations = 0;

                while (temperature > 0.1 && iterations < this.config.maxIterations * 2) {
                    iterations++;

                    // Generate neighbor (random 2-opt move)
                    var i = 1 + Math.floor(Math.random() * (currentRoute.length - 3));
                    var j = i + 1 + Math.floor(Math.random() * (currentRoute.length - i - 2));

                    // Create neighbor by reversing segment
                    var neighbor = currentRoute.slice(0, i);
                    neighbor = neighbor.concat(currentRoute.slice(i, j + 1).reverse());
                    neighbor = neighbor.concat(currentRoute.slice(j + 1));

                    var neighborDistance = this.calculateRouteDistance(neighbor, matrix);
                    var delta = neighborDistance - currentDistance;

                    // Accept if better, or probabilistically if worse
                    if (delta < 0 || Math.random() < Math.exp(-delta / temperature)) {
                        currentRoute = neighbor;
                        currentDistance = neighborDistance;

                        if (currentDistance < bestDistance) {
                            bestRoute = currentRoute.slice();
                            bestDistance = currentDistance;
                        }
                    }

                    temperature *= coolingRate;
                }

                console.log('Simulated Annealing completed in ' + iterations + ' iterations');
                return bestRoute;
            },

            // ============================================
            // MAIN OPTIMIZATION FUNCTION
            // ============================================

            optimize: async function(stops, options) {
                options = options || {};
                var returnToDepot = options.returnToDepot !== undefined ? options.returnToDepot : this.config.returnToDepot;

                console.log('=== PRODUCTION ROUTE OPTIMIZATION ===');
                console.log('Stops to optimize:', stops.length);

                if (stops.length < 2) {
                    console.log('Not enough stops to optimize');
                    return { success: false, message: 'Need at least 2 stops' };
                }

                // Build location array with depot at index 0
                var locations = [FARM_DEPOT].concat(stops);
                var n = locations.length;

                console.log('Total locations (with depot):', n);

                // Build distance matrix
                console.log('Building distance matrix...');
                var matrixResult = await this.buildDistanceMatrix(locations);
                console.log('Distance source:', matrixResult.source);

                // Try multiple construction heuristics and keep the best
                console.log('Running construction heuristics...');

                var constructionResults = [];

                // Nearest Neighbor from depot
                var nnRoute = this.nearestNeighborConstruction(n, 0);
                constructionResults.push({
                    name: 'Nearest Neighbor',
                    route: nnRoute,
                    distance: this.calculateRouteDistance(nnRoute.concat([0]), matrixResult.distances)
                });

                // Nearest Insertion
                var niRoute = this.nearestInsertionConstruction(n, 0);
                constructionResults.push({
                    name: 'Nearest Insertion',
                    route: niRoute,
                    distance: this.calculateRouteDistance(niRoute.concat([0]), matrixResult.distances)
                });

                // Savings Algorithm
                var savingsRoute = this.savingsConstruction(n, 0);
                constructionResults.push({
                    name: 'Savings',
                    route: savingsRoute,
                    distance: this.calculateRouteDistance(savingsRoute.concat([0]), matrixResult.distances)
                });

                // Select best construction
                constructionResults.sort(function(a, b) { return a.distance - b.distance; });
                console.log('Construction results:');
                constructionResults.forEach(function(r) {
                    console.log('  ' + r.name + ': ' + r.distance.toFixed(2) + ' miles');
                });

                var bestConstruction = constructionResults[0];
                console.log('Best construction: ' + bestConstruction.name);

                // Add return to depot
                var route = bestConstruction.route.slice();
                if (returnToDepot && route[route.length - 1] !== 0) {
                    route.push(0);
                }

                var initialDistance = this.calculateRouteDistance(route, matrixResult.distances);
                console.log('Initial distance: ' + initialDistance.toFixed(2) + ' miles');

                // Apply local search improvements
                console.log('Applying 2-opt improvement...');
                route = this.twoOptImprove(route, matrixResult.distances);
                var after2opt = this.calculateRouteDistance(route, matrixResult.distances);
                console.log('After 2-opt: ' + after2opt.toFixed(2) + ' miles');

                console.log('Applying Or-opt improvement...');
                route = this.orOptImprove(route, matrixResult.distances);
                var afterOrOpt = this.calculateRouteDistance(route, matrixResult.distances);
                console.log('After Or-opt: ' + afterOrOpt.toFixed(2) + ' miles');

                console.log('Applying 3-opt improvement...');
                route = this.threeOptImprove(route, matrixResult.distances);
                var after3opt = this.calculateRouteDistance(route, matrixResult.distances);
                console.log('After 3-opt: ' + after3opt.toFixed(2) + ' miles');

                console.log('Applying Simulated Annealing...');
                route = this.simulatedAnnealing(route, matrixResult.distances);
                var afterSA = this.calculateRouteDistance(route, matrixResult.distances);
                console.log('After Simulated Annealing: ' + afterSA.toFixed(2) + ' miles');

                // Final 2-opt pass to clean up
                route = this.twoOptImprove(route, matrixResult.distances);
                var finalDistance = this.calculateRouteDistance(route, matrixResult.distances);

                // Calculate time
                var totalTime = this.calculateRouteTime(route, matrixResult.times, 5);

                console.log('=== OPTIMIZATION COMPLETE ===');
                console.log('Final distance: ' + finalDistance.toFixed(2) + ' miles');
                console.log('Improvement: ' + ((1 - finalDistance/initialDistance) * 100).toFixed(1) + '%');
                console.log('Estimated time: ' + Math.round(totalTime) + ' minutes');

                // Convert route indices back to stop objects (excluding depot)
                var optimizedStops = [];
                for (var i = 0; i < route.length; i++) {
                    if (route[i] !== 0) { // Skip depot
                        optimizedStops.push(stops[route[i] - 1]); // -1 because depot was at index 0
                    }
                }

                return {
                    success: true,
                    stops: optimizedStops,
                    totalDistance: finalDistance,
                    totalTime: totalTime,
                    improvement: ((1 - finalDistance/initialDistance) * 100),
                    distanceSource: matrixResult.source,
                    depot: FARM_DEPOT
                };
            },

            // Re-optimize when a stop is skipped or completed
            reoptimizeRemaining: async function(remainingStops) {
                console.log('Re-optimizing remaining ' + remainingStops.length + ' stops...');
                return await this.optimize(remainingStops, { returnToDepot: true });
            },

            // ============================================
            // TIME WINDOW SUPPORT
            // ============================================

            // Parse time window string to minutes since midnight
            parseTimeWindow: function(windowStr) {
                if (!windowStr || windowStr === 'Flexible') {
                    return { start: 0, end: 24 * 60 }; // All day
                }

                // Parse formats like "8:00 AM - 10:00 AM" or "9:00 - 11:00"
                var parts = windowStr.split('-').map(function(s) { return s.trim(); });
                if (parts.length !== 2) {
                    return { start: 0, end: 24 * 60 };
                }

                function parseTime(timeStr) {
                    var match = timeStr.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)?/i);
                    if (!match) return 0;

                    var hours = parseInt(match[1]);
                    var minutes = match[2] ? parseInt(match[2]) : 0;
                    var period = match[3];

                    if (period) {
                        if (period.toUpperCase() === 'PM' && hours !== 12) hours += 12;
                        if (period.toUpperCase() === 'AM' && hours === 12) hours = 0;
                    }

                    return hours * 60 + minutes;
                }

                return {
                    start: parseTime(parts[0]),
                    end: parseTime(parts[1])
                };
            },

            // Calculate arrival time at each stop given a route
            calculateArrivalTimes: function(route, locations, timeMatrix, startTime, serviceTime) {
                startTime = startTime || 8 * 60; // Default 8:00 AM
                serviceTime = serviceTime || 5;  // 5 min per stop

                var arrivals = [];
                var currentTime = startTime;

                for (var i = 0; i < route.length; i++) {
                    arrivals.push(currentTime);

                    if (i < route.length - 1) {
                        // Add travel time to next stop
                        currentTime += timeMatrix[route[i]][route[i + 1]];
                        // Add service time (except at depot)
                        if (route[i] !== 0) {
                            currentTime += serviceTime;
                        }
                    }
                }

                return arrivals;
            },

            // Calculate total time window violation penalty
            calculateTimeWindowPenalty: function(route, locations, timeMatrix, startTime, serviceTime) {
                var arrivals = this.calculateArrivalTimes(route, locations, timeMatrix, startTime, serviceTime);
                var totalPenalty = 0;

                for (var i = 0; i < route.length; i++) {
                    var idx = route[i];
                    if (idx === 0) continue; // Skip depot

                    var location = locations[idx];
                    var window = this.parseTimeWindow(location.deliveryWindow);
                    var arrival = arrivals[i];

                    // Penalty for arriving too early
                    if (arrival < window.start) {
                        totalPenalty += (window.start - arrival) * 0.5; // Wait time penalty
                    }

                    // Larger penalty for arriving too late
                    if (arrival > window.end) {
                        totalPenalty += (arrival - window.end) * 2; // Late penalty (bigger)
                    }
                }

                return totalPenalty;
            },

            // Optimize with time window awareness
            optimizeWithTimeWindows: async function(stops, options) {
                options = options || {};
                var startTime = options.startTime || 8 * 60; // 8:00 AM default

                // First do standard optimization
                var result = await this.optimize(stops, options);

                if (!result.success) return result;

                // Check time window violations
                var locations = [FARM_DEPOT].concat(stops);
                var route = [0]; // Start with depot
                for (var i = 0; i < result.stops.length; i++) {
                    route.push(stops.indexOf(result.stops[i]) + 1);
                }
                route.push(0); // End at depot

                var penalty = this.calculateTimeWindowPenalty(route, locations, this.timeMatrix, startTime, 5);
                var arrivals = this.calculateArrivalTimes(route, locations, this.timeMatrix, startTime, 5);

                // Format arrival times for display
                result.arrivalTimes = arrivals.map(function(mins) {
                    var hours = Math.floor(mins / 60);
                    var minutes = Math.round(mins % 60);
                    var period = hours >= 12 ? 'PM' : 'AM';
                    if (hours > 12) hours -= 12;
                    if (hours === 0) hours = 12;
                    return hours + ':' + (minutes < 10 ? '0' : '') + minutes + ' ' + period;
                });

                result.timeWindowPenalty = penalty;
                result.hasTimeWindowViolations = penalty > 0;

                if (penalty > 0) {
                    console.log('Warning: Route has time window violations (penalty: ' + penalty.toFixed(1) + ' min)');
                }

                return result;
            }
        };

        // ============================================
        // MAIN OPTIMIZE ROUTE FUNCTION (UI Integration)
        // ============================================
        async function optimizeRoute() {
            var stops = AppState.route.stops.filter(function(s) {
                return s.status === 'pending' && s.lat && s.lng;
            });

            if (stops.length < 2) {
                alert('Need at least 2 pending stops to optimize');
                return;
            }

            // Show loading state
            var btn = document.querySelector('[onclick="optimizeRoute()"]');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Optimizing...';
            }

            try {
                var result = await RouteOptimizer.optimize(stops);

                if (result.success) {
                    // Reorder stops in AppState
                    var completedStops = AppState.route.stops.filter(function(s) {
                        return s.status !== 'pending';
                    });

                    AppState.route.stops = completedStops.concat(result.stops);
                    AppState.route.optimized = true;
                    AppState.route.totalDistance = result.totalDistance;
                    AppState.route.totalTime = result.totalTime;

                    // Re-render
                    renderStops();
                    renderMapMarkers();

                    // Show success message with details
                    var msg = 'Route Optimized!\n\n' +
                              'Total Distance: ' + result.totalDistance.toFixed(1) + ' miles\n' +
                              'Est. Time: ' + Math.round(result.totalTime) + ' minutes\n' +
                              'Improvement: ' + result.improvement.toFixed(1) + '%\n' +
                              'Distance Source: ' + result.distanceSource + '\n\n' +
                              'Route starts and ends at: ' + FARM_DEPOT.name;
                    alert(msg);
                } else {
                    alert('Optimization failed: ' + result.message);
                }
            } catch (error) {
                console.error('Optimization error:', error);
                alert('Error during optimization: ' + error.message);
            }

            // Reset button
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Optimize';
            }
        }

        // Haversine distance (legacy support)
        function haversineDistance(lat1, lng1, lat2, lng2) {
            return RouteOptimizer.haversineDistance(lat1, lng1, lat2, lng2);
        }

        // ============================================
        // UPDATE SWITCH TAB FOR MAP
        // ============================================
        var originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            // Call original function
            var navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(function(item) { item.classList.remove('active'); });

            var tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(function(tab) { tab.classList.remove('active'); });

            var clickedItem = document.querySelector('.nav-item[onclick*="' + tabName + '"]');
            if (clickedItem) clickedItem.classList.add('active');

            var targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) targetTab.classList.add('active');

            AppState.currentTab = tabName;

            // Initialize map when switching to map tab
            if (tabName === 'map') {
                setTimeout(function() {
                    initMap();
                    if (deliveryMap) {
                        deliveryMap.invalidateSize();
                        renderMapMarkers();
                    }
                }, 100);
            }
        };

    </script>

    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</body>
</html>
